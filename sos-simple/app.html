<!DOCTYPE html>
<!-- VERSION SIMPLE 2025-12-17 - Onboarding 3 √©tapes + Dashboard √©pur√© -->
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>SOS Storytelling - Version Simple</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #f093fb 100%);
        }

        /* ==================== HEADER SIMPLIFI√â ==================== */
        .header {
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-logo { font-size: 2em; }
        .header-title {
            font-size: 1.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-buttons { display: flex; gap: 10px; align-items: center; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        .btn-profile { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-profile:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        .btn-secondary { background: #f0f4ff; color: #667eea; border: 2px solid #e0e5ff; }
        .btn-secondary:hover { background: #667eea; color: white; }

        /* ==================== ONBOARDING SIMPLE ==================== */
        .onboarding-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .onboarding-overlay.active { opacity: 1; }

        .onboarding-modal {
            background: white;
            border-radius: 25px;
            width: 95%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }

        .onboarding-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 35px 30px;
            border-radius: 25px 25px 0 0;
            text-align: center;
        }
        .onboarding-header h2 { font-size: 1.8em; margin-bottom: 8px; }
        .onboarding-header p { opacity: 0.9; font-size: 1.05em; }

        .onboarding-progress {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: all 0.3s;
        }
        .progress-dot.active { background: white; transform: scale(1.2); }
        .progress-dot.completed { background: #38ef7d; }

        .onboarding-body { padding: 35px 30px; }

        .onboarding-step { display: none; }
        .onboarding-step.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Checkboxes styl√©es */
        .choice-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin: 20px 0;
        }
        .choice-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 20px;
            background: #f8f9ff;
            border: 2px solid #e0e5ff;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .choice-card:hover { border-color: #667eea; background: #f0f4ff; }
        .choice-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea15, #764ba215);
            box-shadow: 0 5px 15px rgba(102,126,234,0.15);
        }
        .choice-card input { display: none; }
        .choice-icon { font-size: 1.5em; }
        .choice-label { font-weight: 600; color: #333; }

        /* Textarea */
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.05em;
        }
        .form-group textarea,
        .form-group input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e5ff;
            border-radius: 12px;
            font-family: inherit;
            font-size: 0.95em;
            resize: vertical;
            min-height: 150px;
            transition: border-color 0.2s;
        }
        .form-group textarea:focus,
        .form-group input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-group input[type="text"] { min-height: auto; }
        .form-hint {
            display: block;
            color: #888;
            font-size: 0.9em;
            margin-top: 8px;
        }

        /* Actions onboarding */
        .onboarding-actions {
            display: flex;
            gap: 12px;
            justify-content: space-between;
            margin-top: 25px;
        }
        .btn-back {
            background: #f0f0f0;
            color: #666;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-back:hover { background: #e0e0e0; }
        .btn-next {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            max-width: 200px;
        }
        .btn-next:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }
        .btn-next:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-skip {
            background: transparent;
            color: #888;
            border: none;
            font-family: inherit;
            cursor: pointer;
            font-size: 0.9em;
            text-decoration: underline;
        }
        .btn-skip:hover { color: #667eea; }

        /* ==================== DASHBOARD SIMPLIFI√â ==================== */
        .dashboard { padding: 40px 20px; max-width: 900px; margin: 0 auto; }

        .welcome-section {
            text-align: center;
            margin-bottom: 40px;
        }
        .welcome-title {
            font-size: 2em;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        /* Inspiration du jour */
        .inspiration-card {
            background: white;
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }
        .inspiration-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #667eea;
            font-weight: 700;
        }
        .inspiration-text {
            font-size: 1.2em;
            color: #333;
            line-height: 1.5;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9ff, #f0f4ff);
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        .inspiration-actions { display: flex; gap: 12px; flex-wrap: wrap; }
        .btn-inspiration {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-inspiration:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.3); }
        .btn-refresh {
            background: #f0f4ff;
            color: #667eea;
            border: 2px solid #e0e5ff;
            padding: 12px 20px;
            border-radius: 10px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-refresh:hover { background: #667eea; color: white; }

        /* Actions principales */
        .main-actions-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        .main-actions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }
        @media (max-width: 700px) {
            .main-actions-grid { grid-template-columns: 1fr; }
        }
        .action-card {
            background: white;
            border-radius: 20px;
            padding: 35px 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 3px solid transparent;
        }
        .action-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(102,126,234,0.2);
            border-color: #667eea;
        }
        .action-icon { font-size: 3em; margin-bottom: 15px; }
        .action-title { font-size: 1.2em; font-weight: 700; color: #333; margin-bottom: 8px; }
        .action-desc { color: #888; font-size: 0.9em; }

        /* Contenus r√©cents */
        .recent-section {
            background: white;
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }
        .recent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .recent-title { font-weight: 700; color: #333; }
        .recent-list { }
        .recent-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .recent-item:last-child { border-bottom: none; }
        .recent-item:hover { background: #f8f9ff; margin: 0 -15px; padding: 12px 15px; border-radius: 10px; }
        .recent-icon { font-size: 1.2em; }
        .recent-info { flex: 1; }
        .recent-name { font-weight: 600; color: #333; font-size: 0.95em; }
        .recent-date { color: #888; font-size: 0.8em; }
        .recent-empty { color: #888; text-align: center; padding: 30px; }

        /* Lien options avanc√©es */
        .advanced-link {
            text-align: center;
            margin-top: 30px;
        }
        .advanced-link a {
            color: #888;
            font-size: 0.9em;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .advanced-link a:hover { color: #667eea; background: rgba(102,126,234,0.1); }

        /* ==================== √âCRAN DE G√âN√âRATION ==================== */
        .generator-page { display: none; padding: 30px 20px; max-width: 800px; margin: 0 auto; }
        .generator-page.active { display: block; }

        .generator-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        .btn-back-home {
            background: #f0f4ff;
            color: #667eea;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-back-home:hover { background: #667eea; color: white; }
        .generator-title { font-size: 1.5em; font-weight: 700; color: #333; }

        .generator-form {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }
        .platform-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }
        .platform-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e5ff;
            border-radius: 10px;
            background: #f8f9ff;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .platform-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea15, #764ba215);
        }
        .platform-btn:hover { border-color: #667eea; }

        .btn-generate {
            width: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-family: inherit;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }
        .btn-generate:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(102,126,234,0.4); }
        .btn-generate:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* R√©sultat */
        .result-section {
            margin-top: 30px;
            display: none;
        }
        .result-section.active { display: block; }
        .result-label { font-weight: 700; color: #333; margin-bottom: 15px; }
        .result-content {
            background: #f8f9ff;
            border: 2px solid #e0e5ff;
            border-radius: 15px;
            padding: 20px;
            min-height: 200px;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 0.95em;
        }
        .result-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .result-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .result-btn-copy { background: #11998e; color: white; }
        .result-btn-copy:hover { background: #0d7d73; }
        .result-btn-regen { background: #f0f4ff; color: #667eea; border: 2px solid #e0e5ff; }
        .result-btn-regen:hover { background: #667eea; color: white; }
        .result-btn-save { background: #764ba2; color: white; }
        .result-btn-save:hover { background: #5a3880; }

        .more-options-link {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .more-options-link a {
            color: #888;
            font-size: 0.9em;
            text-decoration: none;
        }
        .more-options-link a:hover { color: #667eea; }

        /* ==================== LOADING ==================== */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
            gap: 20px;
        }
        .loading-overlay.active { display: flex; }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f0f0f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: #667eea; font-weight: 600; }

        /* ==================== TOAST ==================== */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 600;
            z-index: 3000;
            transition: transform 0.3s;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* ==================== MOBILE ==================== */
        @media (max-width: 600px) {
            .header { padding: 12px 15px; }
            .header-title { font-size: 1.2em; }
            .dashboard { padding: 20px 15px; }
            .welcome-title { font-size: 1.5em; }
            .inspiration-card, .recent-section { padding: 20px; }
            .action-card { padding: 25px 20px; }
            .action-icon { font-size: 2.5em; }
            .generator-form { padding: 20px; }
            .onboarding-modal { border-radius: 15px; }
            .onboarding-header { padding: 25px 20px; border-radius: 15px 15px 0 0; }
            .onboarding-header h2 { font-size: 1.4em; }
            .onboarding-body { padding: 25px 20px; }
        }
    </style>
</head>
<body>
    <!-- Header simplifi√© -->
    <header class="header">
        <div class="header-left">
            <span class="header-logo">‚ú®</span>
            <span class="header-title">SOS Storytelling</span>
        </div>
        <div class="header-buttons">
            <button class="btn btn-secondary" onclick="showDashboard()">üè† Accueil</button>
            <button class="btn btn-profile" onclick="SimpleOnboarding.edit()">üë§ Mon profil</button>
        </div>
    </header>

    <!-- Dashboard principal -->
    <main class="dashboard" id="dashboard">
        <div class="welcome-section">
            <h1 class="welcome-title">Bonjour <span id="userName">toi</span> üëã</h1>
        </div>

        <!-- Inspiration du jour -->
        <div class="inspiration-card">
            <div class="inspiration-header">
                <span>üí°</span>
                <span>INSPIRATION DU JOUR</span>
            </div>
            <div class="inspiration-text" id="inspirationText">
                "Les 3 erreurs qui tuent ton engagement LinkedIn"
            </div>
            <div class="inspiration-actions">
                <button class="btn-inspiration" onclick="useInspiration()">‚ú® √âcrire un post sur ce sujet</button>
                <button class="btn-refresh" onclick="refreshInspiration()">üîÑ Autre id√©e</button>
            </div>
        </div>

        <!-- Actions principales -->
        <h2 class="main-actions-title">Que veux-tu cr√©er ?</h2>
        <div class="main-actions-grid">
            <div class="action-card" onclick="showGenerator('post')">
                <div class="action-icon">üì±</div>
                <div class="action-title">Post R√©seaux</div>
                <div class="action-desc">LinkedIn ou Instagram</div>
            </div>
            <div class="action-card" onclick="showGenerator('newsletter')">
                <div class="action-icon">üìß</div>
                <div class="action-title">Newsletter</div>
                <div class="action-desc">Email engageant</div>
            </div>
            <div class="action-card" onclick="showGenerator('mail')">
                <div class="action-icon">üöÄ</div>
                <div class="action-title">Mail Lancement</div>
                <div class="action-desc">Vente ou promotion</div>
            </div>
        </div>

        <!-- Contenus r√©cents -->
        <div class="recent-section">
            <div class="recent-header">
                <span class="recent-title">üìö Mes contenus r√©cents</span>
            </div>
            <div class="recent-list" id="recentList">
                <div class="recent-empty">Tu n'as pas encore cr√©√© de contenu. Lance-toi !</div>
            </div>
        </div>

        <!-- Lien options avanc√©es -->
        <div class="advanced-link">
            <a href="#" onclick="showAdvancedOptions(); return false;">‚öôÔ∏è Options avanc√©es</a>
        </div>
    </main>

    <!-- Page de g√©n√©ration -->
    <div class="generator-page" id="generatorPage">
        <div class="generator-header">
            <button class="btn-back-home" onclick="showDashboard()">‚Üê Retour</button>
            <h2 class="generator-title" id="generatorTitle">üì± Post r√©seaux</h2>
        </div>

        <div class="generator-form">
            <div class="form-group">
                <label>De quoi tu veux parler ? *</label>
                <textarea id="topicInput" placeholder="Ex: Comment j'ai surmont√© mon syndrome de l'imposteur pour enfin lancer mon offre"></textarea>
            </div>

            <div id="platformSelector" class="platform-selector">
                <button type="button" class="platform-btn active" data-platform="linkedin" onclick="selectPlatform('linkedin')">
                    üíº LinkedIn
                </button>
                <button type="button" class="platform-btn" data-platform="instagram" onclick="selectPlatform('instagram')">
                    üì∏ Instagram
                </button>
            </div>

            <button class="btn-generate" id="generateBtn" onclick="generateContent()">
                ‚ú® G√©n√©rer mon contenu
            </button>

            <!-- R√©sultat -->
            <div class="result-section" id="resultSection">
                <div class="result-label">R√âSULTAT</div>
                <div class="result-content" id="resultContent"></div>
                <div class="result-actions">
                    <button class="result-btn result-btn-copy" onclick="copyResult()">üìã Copier</button>
                    <button class="result-btn result-btn-regen" onclick="regenerateContent()">üîÑ R√©g√©n√©rer</button>
                    <button class="result-btn result-btn-save" onclick="saveContent()">üíæ Sauvegarder</button>
                </div>
            </div>

            <div class="more-options-link">
                <a href="#" onclick="showAdvancedOptions(); return false;">‚öôÔ∏è Plus d'options (frameworks, ton, format...)</a>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">G√©n√©ration en cours...</div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ==================== CONFIGURATION ====================
        const SUPABASE_URL = 'https://oybpmxhzusgqlifhvhvq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95YnBteGh6dXNncWxpZmh2aHZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI3OTMyNTUsImV4cCI6MjA0ODM2OTI1NX0.5R6lh3bFhXfU1gBDE4cDnlCGSESOFf5MFMr5rF5hkK8';
        const ANTHROPIC_PROXY_URL = 'https://oybpmxhzusgqlifhvhvq.supabase.co/functions/v1/anthropic-proxy';

        let currentUser = null;
        let currentContentType = 'post';
        let currentPlatform = 'linkedin';
        let lastGeneratedContent = '';

        // ==================== INSPIRATIONS ====================
        const INSPIRATIONS = [
            "Les 3 erreurs qui tuent ton engagement LinkedIn",
            "Ce que personne ne te dit sur le syndrome de l'imposteur",
            "Comment j'ai doubl√© mon CA en changeant une seule chose",
            "La question qu'on me pose tout le temps (et ma vraie r√©ponse)",
            "Pourquoi j'ai failli tout arr√™ter il y a 6 mois",
            "Le conseil que j'aurais aim√© recevoir au d√©but",
            "Ce qui se cache derri√®re les entrepreneurs 'qui r√©ussissent'",
            "Ma routine du matin (spoiler: pas de miracle morning)",
            "Les 5 outils qui m'ont vraiment fait gagner du temps",
            "Comment dire non sans culpabiliser",
            "Le mythe du 'travaille plus dur' enfin d√©construit",
            "Ce que j'ai appris de mon pire client",
            "Pourquoi je refuse 80% des opportunit√©s",
            "La vraie raison pour laquelle tu procrastines",
            "Comment j'ai trouv√© mes premiers clients (la m√©thode simple)"
        ];

        // ==================== INITIALISATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });

        async function checkAuth() {
            // V√©rifier si l'utilisateur est connect√©
            const token = localStorage.getItem('sb-access-token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // R√©cup√©rer l'utilisateur
            try {
                const response = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'apikey': SUPABASE_ANON_KEY
                    }
                });
                if (response.ok) {
                    currentUser = await response.json();
                    initApp();
                } else {
                    window.location.href = 'login.html';
                }
            } catch (e) {
                console.error('Auth error:', e);
                window.location.href = 'login.html';
            }
        }

        async function initApp() {
            // Charger le profil simple
            const profile = await SimpleOnboarding.load();

            if (!profile || !profile.onboarding_completed) {
                // Premier lancement : afficher l'onboarding
                SimpleOnboarding.show();
            } else {
                // Profil existant : mettre √† jour le dashboard
                document.getElementById('userName').textContent = profile.user_name || 'toi';
                loadRecentContents();
            }

            // Charger une inspiration al√©atoire
            refreshInspiration();
        }

        // ==================== ONBOARDING SIMPLE ====================
        const SimpleOnboarding = {
            currentStep: 1,
            data: {
                primary_content_type: 'posts',
                source_texts: '',
                default_audience: 'entrepreneures',
                audience_pain_point: '',
                user_name: ''
            },

            show: function() {
                const overlay = document.createElement('div');
                overlay.id = 'simpleOnboardingOverlay';
                overlay.className = 'onboarding-overlay';
                overlay.innerHTML = this.getHTML();
                document.body.appendChild(overlay);

                setTimeout(() => overlay.classList.add('active'), 10);
                this.currentStep = 1;
                this.updateStep();
            },

            edit: async function() {
                const profile = await this.load();
                if (profile) {
                    this.data = {
                        primary_content_type: profile.primary_content_type || 'posts',
                        source_texts: profile.source_texts?.join('\n\n---\n\n') || '',
                        default_audience: profile.default_audience || 'entrepreneures',
                        audience_pain_point: profile.audience_pain_point || '',
                        user_name: profile.user_name || ''
                    };
                }
                this.show();
                // Pr√©-remplir les champs avec les donn√©es existantes
                this.populateForm();
            },

            populateForm: function() {
                // Pr√©-remplir les textes sources (√©tape 2)
                if (this.data.source_texts) {
                    document.getElementById('sourceTexts').value = this.data.source_texts;
                }
                // Pr√©-remplir le pr√©nom (√©tape 3)
                if (this.data.user_name) {
                    document.getElementById('userName').value = this.data.user_name;
                }
                // Pr√©-remplir le pain point (√©tape 3)
                if (this.data.audience_pain_point) {
                    document.getElementById('painPoint').value = this.data.audience_pain_point;
                }
                // Pr√©-s√©lectionner le type de contenu (√©tape 1)
                if (this.data.primary_content_type) {
                    const objectifCards = document.querySelectorAll('#objectifChoices .choice-card');
                    objectifCards.forEach(card => {
                        card.classList.remove('selected');
                        if (card.dataset.value === this.data.primary_content_type) {
                            card.classList.add('selected');
                            card.querySelector('input').checked = true;
                        }
                    });
                }
                // Pr√©-s√©lectionner l'audience (√©tape 3)
                if (this.data.default_audience) {
                    const audienceCards = document.querySelectorAll('#audienceChoices .choice-card');
                    audienceCards.forEach(card => {
                        card.classList.remove('selected');
                        if (card.dataset.value === this.data.default_audience) {
                            card.classList.add('selected');
                            card.querySelector('input').checked = true;
                        }
                    });
                }
            },

            getHTML: function() {
                return `
                    <div class="onboarding-modal">
                        <div class="onboarding-header">
                            <h2 id="onbTitle">Bienvenue dans SOS Storytelling üëã</h2>
                            <p id="onbSubtitle">Configure ton assistant en 3 √©tapes</p>
                            <div class="onboarding-progress">
                                <div class="progress-dot active" id="dot1"></div>
                                <div class="progress-dot" id="dot2"></div>
                                <div class="progress-dot" id="dot3"></div>
                            </div>
                        </div>
                        <div class="onboarding-body">
                            <!-- √âTAPE 1 : Objectif -->
                            <div class="onboarding-step active" id="step1">
                                <div class="form-group">
                                    <label>Tu veux que je t'aide avec quoi en priorit√© ?</label>
                                </div>
                                <div class="choice-grid" id="objectifChoices">
                                    <label class="choice-card selected" data-value="posts">
                                        <input type="radio" name="objectif" value="posts" checked>
                                        <span class="choice-icon">üì±</span>
                                        <span class="choice-label">Posts r√©seaux sociaux (LinkedIn, Instagram)</span>
                                    </label>
                                    <label class="choice-card" data-value="newsletter">
                                        <input type="radio" name="objectif" value="newsletter">
                                        <span class="choice-icon">üìß</span>
                                        <span class="choice-label">Newsletters</span>
                                    </label>
                                    <label class="choice-card" data-value="mails">
                                        <input type="radio" name="objectif" value="mails">
                                        <span class="choice-icon">üöÄ</span>
                                        <span class="choice-label">Mails de lancement / vente</span>
                                    </label>
                                </div>
                                <div class="onboarding-actions">
                                    <div></div>
                                    <button class="btn-next" onclick="SimpleOnboarding.next()">Continuer ‚Üí</button>
                                </div>
                            </div>

                            <!-- √âTAPE 2 : Clonage du ton -->
                            <div class="onboarding-step" id="step2">
                                <div class="form-group">
                                    <label>Apprends-moi √† √©crire comme toi ‚úçÔ∏è</label>
                                    <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">
                                        Colle ici 3 √† 5 textes que tu as √©crits<br>
                                        (posts, mails, pages de vente... ce qui te ressemble)
                                    </p>
                                    <textarea id="sourceTexts" placeholder="Colle tes textes ici, s√©par√©s par des lignes vides..."></textarea>
                                    <span class="form-hint">üí° Plus tu me donnes d'exemples, plus je parlerai comme toi.</span>
                                </div>
                                <div class="onboarding-actions">
                                    <button class="btn-back" onclick="SimpleOnboarding.back()">‚Üê Retour</button>
                                    <button class="btn-next" onclick="SimpleOnboarding.next()">Continuer ‚Üí</button>
                                </div>
                            </div>

                            <!-- √âTAPE 3 : Audience -->
                            <div class="onboarding-step" id="step3">
                                <div class="form-group">
                                    <label>Comment tu t'appelles ?</label>
                                    <input type="text" id="userName" placeholder="Ton pr√©nom">
                                </div>
                                <div class="form-group">
                                    <label>Tu t'adresses principalement √†... üéØ</label>
                                </div>
                                <div class="choice-grid" id="audienceChoices">
                                    <label class="choice-card selected" data-value="entrepreneures">
                                        <input type="radio" name="audience" value="entrepreneures" checked>
                                        <span class="choice-icon">üíº</span>
                                        <span class="choice-label">Entrepreneures / solopreneures</span>
                                    </label>
                                    <label class="choice-card" data-value="coachs">
                                        <input type="radio" name="audience" value="coachs">
                                        <span class="choice-icon">üéØ</span>
                                        <span class="choice-label">Coachs / formatrices</span>
                                    </label>
                                    <label class="choice-card" data-value="creatrices">
                                        <input type="radio" name="audience" value="creatrices">
                                        <span class="choice-icon">‚ú®</span>
                                        <span class="choice-label">Cr√©atrices de contenu</span>
                                    </label>
                                    <label class="choice-card" data-value="prestataires">
                                        <input type="radio" name="audience" value="prestataires">
                                        <span class="choice-icon">üé®</span>
                                        <span class="choice-label">Prestataires de services (graphistes, VA...)</span>
                                    </label>
                                </div>
                                <div class="form-group" style="margin-top: 20px;">
                                    <label>En une phrase, c'est quoi leur plus gros probl√®me ? (optionnel)</label>
                                    <input type="text" id="painPoint" placeholder="Ex: Elles n'arrivent pas √† √™tre r√©guli√®res sur les r√©seaux">
                                </div>
                                <div class="onboarding-actions">
                                    <button class="btn-back" onclick="SimpleOnboarding.back()">‚Üê Retour</button>
                                    <button class="btn-next" onclick="SimpleOnboarding.finish()">C'est parti ! üöÄ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            updateStep: function() {
                // Mettre √† jour les dots
                for (let i = 1; i <= 3; i++) {
                    const dot = document.getElementById(`dot${i}`);
                    dot.classList.remove('active', 'completed');
                    if (i < this.currentStep) dot.classList.add('completed');
                    if (i === this.currentStep) dot.classList.add('active');
                }

                // Mettre √† jour les steps
                for (let i = 1; i <= 3; i++) {
                    const step = document.getElementById(`step${i}`);
                    step.classList.remove('active');
                    if (i === this.currentStep) step.classList.add('active');
                }

                // Mettre √† jour le titre
                const titles = [
                    { title: 'Bienvenue dans SOS Storytelling üëã', subtitle: 'Configure ton assistant en 3 √©tapes' },
                    { title: 'Apprends-moi ton style ‚úçÔ∏è', subtitle: 'Pour que je parle exactement comme toi' },
                    { title: 'Derni√®re √©tape ! üéØ', subtitle: 'Dis-moi √† qui tu parles' }
                ];
                document.getElementById('onbTitle').textContent = titles[this.currentStep - 1].title;
                document.getElementById('onbSubtitle').textContent = titles[this.currentStep - 1].subtitle;
            },

            next: function() {
                // Sauvegarder les donn√©es de l'√©tape actuelle
                if (this.currentStep === 1) {
                    const selected = document.querySelector('#objectifChoices .choice-card.selected');
                    if (selected) this.data.primary_content_type = selected.dataset.value;
                } else if (this.currentStep === 2) {
                    this.data.source_texts = document.getElementById('sourceTexts').value;
                }

                this.currentStep++;
                this.updateStep();
            },

            back: function() {
                this.currentStep--;
                this.updateStep();
            },

            finish: async function() {
                // R√©cup√©rer les donn√©es de l'√©tape 3
                const selectedAudience = document.querySelector('#audienceChoices .choice-card.selected');
                if (selectedAudience) this.data.default_audience = selectedAudience.dataset.value;
                this.data.audience_pain_point = document.getElementById('painPoint').value;
                this.data.user_name = document.getElementById('userName').value;

                // Afficher le loading
                showLoading('Analyse de ton style en cours...');

                try {
                    // Analyser le ton si des textes ont √©t√© fournis
                    let toneAnalysis = null;
                    if (this.data.source_texts && this.data.source_texts.trim().length > 50) {
                        toneAnalysis = await this.analyzeTone(this.data.source_texts);
                    }

                    // Sauvegarder le profil
                    await this.save({
                        ...this.data,
                        tone_analysis: toneAnalysis,
                        source_texts: this.data.source_texts ? this.data.source_texts.split(/\n{2,}|---/).filter(t => t.trim()) : [],
                        onboarding_completed: true
                    });

                    hideLoading();
                    this.close();

                    // Mettre √† jour le dashboard
                    document.getElementById('userName').textContent = this.data.user_name || 'toi';
                    showToast('üéâ Parfait ! Ton assistant est pr√™t !');

                } catch (error) {
                    console.error('Erreur onboarding:', error);
                    hideLoading();
                    showToast('‚ùå Erreur lors de la sauvegarde');
                }
            },

            analyzeTone: async function(texts) {
                const token = localStorage.getItem('sb-access-token');
                const response = await fetch(ANTHROPIC_PROXY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `Analyse ces textes et extrais le "ton" de la personne.

TEXTES :
${texts}

R√©ponds en JSON uniquement :
{
  "style": "description du style g√©n√©ral (ex: direct et chaleureux, piquant mais bienveillant...)",
  "expressions_typiques": ["liste", "d'expressions", "r√©currentes"],
  "structure_preferee": "comment elle structure ses contenus",
  "a_eviter": ["ce qu'elle", "n'utilise jamais"],
  "signature": "ce qui la rend reconnaissable"
}`
                        }]
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    try {
                        return JSON.parse(data.content[0].text);
                    } catch {
                        return null;
                    }
                }
                return null;
            },

            save: async function(profileData) {
                const token = localStorage.getItem('sb-access-token');

                // Upsert dans user_tone_clone
                const response = await fetch(`${SUPABASE_URL}/rest/v1/user_tone_clone`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'apikey': SUPABASE_ANON_KEY,
                        'Prefer': 'resolution=merge-duplicates'
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        ...profileData,
                        updated_at: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error('Erreur sauvegarde profil');
                }
            },

            load: async function() {
                const token = localStorage.getItem('sb-access-token');
                if (!currentUser) return null;

                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/user_tone_clone?user_id=eq.${currentUser.id}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'apikey': SUPABASE_ANON_KEY
                        }
                    }
                );

                if (response.ok) {
                    const data = await response.json();
                    return data[0] || null;
                }
                return null;
            },

            close: function() {
                const overlay = document.getElementById('simpleOnboardingOverlay');
                if (overlay) {
                    overlay.classList.remove('active');
                    setTimeout(() => overlay.remove(), 300);
                }
            }
        };

        // G√©rer les clics sur les choice-cards
        document.addEventListener('click', (e) => {
            const card = e.target.closest('.choice-card');
            if (card) {
                const grid = card.closest('.choice-grid');
                grid.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                card.querySelector('input').checked = true;
            }
        });

        // ==================== NAVIGATION ====================
        function showDashboard() {
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('generatorPage').classList.remove('active');
        }

        function showGenerator(type) {
            currentContentType = type;

            const titles = {
                post: 'üì± Post r√©seaux',
                newsletter: 'üìß Newsletter',
                mail: 'üöÄ Mail de lancement'
            };

            document.getElementById('generatorTitle').textContent = titles[type];
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('generatorPage').classList.add('active');
            document.getElementById('resultSection').classList.remove('active');
            document.getElementById('topicInput').value = '';

            // Afficher/masquer le s√©lecteur de plateforme
            const platformSelector = document.getElementById('platformSelector');
            platformSelector.style.display = type === 'post' ? 'flex' : 'none';
        }

        function selectPlatform(platform) {
            currentPlatform = platform;
            document.querySelectorAll('.platform-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.platform === platform);
            });
        }

        function showAdvancedOptions() {
            showToast('üîß Fonctionnalit√© bient√¥t disponible !');
        }

        // ==================== INSPIRATION ====================
        function refreshInspiration() {
            const randomIndex = Math.floor(Math.random() * INSPIRATIONS.length);
            document.getElementById('inspirationText').textContent = `"${INSPIRATIONS[randomIndex]}"`;
        }

        function useInspiration() {
            const inspiration = document.getElementById('inspirationText').textContent.replace(/"/g, '');
            showGenerator('post');
            document.getElementById('topicInput').value = inspiration;
        }

        // ==================== G√âN√âRATION ====================
        async function generateContent() {
            const topic = document.getElementById('topicInput').value.trim();
            if (!topic) {
                showToast('‚ö†Ô∏è Dis-moi de quoi tu veux parler !');
                return;
            }

            showLoading('G√©n√©ration en cours...');

            try {
                const profile = await SimpleOnboarding.load();
                const content = await callClaudeAPI(topic, profile);

                document.getElementById('resultContent').textContent = content;
                document.getElementById('resultSection').classList.add('active');
                lastGeneratedContent = content;

                hideLoading();

                // Sauvegarder automatiquement
                await saveToHistory(topic, content);

            } catch (error) {
                console.error('Erreur g√©n√©ration:', error);
                hideLoading();
                showToast('‚ùå Erreur lors de la g√©n√©ration');
            }
        }

        async function callClaudeAPI(topic, profile) {
            const token = localStorage.getItem('sb-access-token');

            // Construire le prompt avec le ton clon√©
            let toneInstructions = '';
            if (profile?.tone_analysis) {
                const tone = profile.tone_analysis;
                toneInstructions = `
SON TON (appris de ses textes) :
- Style : ${tone.style || 'naturel et authentique'}
- Expressions typiques : ${tone.expressions_typiques?.join(', ') || 'aucune sp√©cifi√©e'}
- Structure pr√©f√©r√©e : ${tone.structure_preferee || 'libre'}
- √Ä √©viter : ${tone.a_eviter?.join(', ') || 'rien de particulier'}
- Signature : ${tone.signature || 'son authenticit√©'}
`;
            }

            const audienceMap = {
                'entrepreneures': 'Entrepreneures et solopreneures',
                'coachs': 'Coachs et formatrices',
                'creatrices': 'Cr√©atrices de contenu',
                'prestataires': 'Prestataires de services (graphistes, VA, etc.)'
            };

            const contentTypeMap = {
                'post': currentPlatform === 'linkedin' ? 'Post LinkedIn optimis√© (accroche + corps + CTA)' : 'Post Instagram (caption engageante)',
                'newsletter': 'Newsletter engageante (sujet accrocheur + contenu de valeur + CTA)',
                'mail': 'Mail de vente/lancement (objet + corps persuasif + CTA)'
            };

            const prompt = `Tu es un copywriter expert qui √©crit EXACTEMENT comme cette personne.
${toneInstructions}
SON AUDIENCE :
${audienceMap[profile?.default_audience] || 'Entrepreneures'}
${profile?.audience_pain_point ? `Leur probl√®me principal : ${profile.audience_pain_point}` : ''}

TA MISSION :
G√©n√®re un ${contentTypeMap[currentContentType]} sur le sujet suivant :
"${topic}"

R√àGLES ABSOLUES :
- Utilise SON ton, ses expressions, son style
- Parle directement √† son audience
- Sois concret et actionnable : inclus toujours 1-2 pistes d'action concr√®tes (mini-checklist, exemple √† copier, phrase pr√™te √† l'emploi)
- Accroche qui stoppe le scroll
- Pas de jargon marketing g√©n√©rique
- Pas d'emojis excessifs (max 2-3)
- Pas de hashtags dans le corps du texte
- Tutoiement obligatoire

FORMAT :
${contentTypeMap[currentContentType]}`;

            const response = await fetch(ANTHROPIC_PROXY_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 2000,
                    messages: [{
                        role: 'user',
                        content: prompt
                    }]
                })
            });

            if (!response.ok) {
                throw new Error('Erreur API');
            }

            const data = await response.json();
            return data.content[0].text;
        }

        async function regenerateContent() {
            generateContent();
        }

        function copyResult() {
            navigator.clipboard.writeText(lastGeneratedContent);
            showToast('üìã Copi√© dans le presse-papier !');
        }

        async function saveContent() {
            showToast('üíæ Contenu sauvegard√© !');
        }

        // ==================== HISTORIQUE ====================
        async function saveToHistory(topic, content) {
            const token = localStorage.getItem('sb-access-token');

            await fetch(`${SUPABASE_URL}/rest/v1/generated_contents`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    'apikey': SUPABASE_ANON_KEY
                },
                body: JSON.stringify({
                    user_id: currentUser.id,
                    content_type: currentContentType,
                    platform: currentContentType === 'post' ? currentPlatform : null,
                    topic: topic,
                    content: content,
                    created_at: new Date().toISOString()
                })
            });

            loadRecentContents();
        }

        async function loadRecentContents() {
            const token = localStorage.getItem('sb-access-token');

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/generated_contents?user_id=eq.${currentUser.id}&order=created_at.desc&limit=5`,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'apikey': SUPABASE_ANON_KEY
                        }
                    }
                );

                if (response.ok) {
                    const contents = await response.json();
                    renderRecentContents(contents);
                }
            } catch (e) {
                console.error('Erreur chargement historique:', e);
            }
        }

        function renderRecentContents(contents) {
            const container = document.getElementById('recentList');

            if (!contents || contents.length === 0) {
                container.innerHTML = '<div class="recent-empty">Tu n\'as pas encore cr√©√© de contenu. Lance-toi !</div>';
                return;
            }

            const icons = {
                'post': 'üì±',
                'newsletter': 'üìß',
                'mail': 'üöÄ'
            };

            container.innerHTML = contents.map(c => {
                const date = new Date(c.created_at);
                const timeAgo = getTimeAgo(date);
                const preview = c.topic?.substring(0, 40) + (c.topic?.length > 40 ? '...' : '');

                return `
                    <div class="recent-item" onclick="viewContent('${c.id}')">
                        <span class="recent-icon">${icons[c.content_type] || 'üìù'}</span>
                        <div class="recent-info">
                            <div class="recent-name">${preview}</div>
                            <div class="recent-date">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return "√Ä l'instant";
            if (minutes < 60) return `Il y a ${minutes} min`;
            if (hours < 24) return `Il y a ${hours}h`;
            if (days === 1) return "Hier";
            return `Il y a ${days} jours`;
        }

        async function viewContent(id) {
            // TODO: Afficher le contenu dans un modal
            showToast('üìñ Fonctionnalit√© bient√¥t disponible !');
        }

        // ==================== UTILITAIRES ====================
        function showLoading(text = 'Chargement...') {
            document.querySelector('.loading-text').textContent = text;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
