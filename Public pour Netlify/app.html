<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOS Storytelling - Tithot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.5/dist/dotlottie-wc.js" type="module"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; min-height: 100vh; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #f093fb 100%); }

        .header { background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-logo { font-size: 2em; }
        .header-title { font-size: 1.5em; font-weight: 700; background: linear-gradient(135deg, #f093fb, #f5576c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header-buttons { display: flex; gap: 10px; flex-wrap: wrap; }

        .btn { padding: 10px 20px; border: none; border-radius: 10px; font-family: inherit; font-size: 0.95em; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
        .btn-home { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }
        .btn-profile { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        /* Agency Toggle Section */
        .agency-toggle-section { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #f8f9ff, #f0f4ff); border-radius: 12px; border: 2px solid #e8ecff; }
        .agency-toggle-info { display: flex; flex-direction: column; gap: 2px; }
        .agency-toggle-label { font-weight: 700; color: #1e3c72; font-size: 0.95em; }
        .agency-toggle-desc { font-size: 0.8em; color: #666; }
        .btn-agency-unlock-small { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 16px; border: none; border-radius: 8px; font-family: inherit; font-weight: 600; cursor: pointer; font-size: 0.85em; transition: all 0.3s; }
        .btn-agency-unlock-small:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(102,126,234,0.3); }
        .btn-agency-active-small { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; padding: 8px 16px; border: none; border-radius: 8px; font-family: inherit; font-weight: 600; cursor: pointer; font-size: 0.85em; }
        .btn-icon { background: #f0f4ff; border: 2px solid #e0e5ff; color: #667eea; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 1em; transition: all 0.2s; }
        .btn-icon:hover { background: #667eea; color: white; }

        /* Format Recommendation */
        .format-recommendation { margin-top: 12px; padding: 12px 15px; background: linear-gradient(135deg, #fff9e6, #fff3cd); border-radius: 10px; border-left: 4px solid #ffc107; font-size: 0.88em; color: #856404; display: none; animation: slideDown 0.3s ease; cursor: pointer; transition: all 0.2s; }
        .format-recommendation:hover { transform: translateX(5px); box-shadow: 0 4px 15px rgba(255,193,7,0.3); }
        .format-recommendation.show { display: block; }
        .format-recommendation strong { color: #664d03; }
        .format-recommendation .trend-badge { display: inline-block; background: #ffc107; color: #664d03; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 700; margin-right: 8px; }
        .format-recommendation .see-more { background: #664d03; color: white; border: none; padding: 5px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer; margin-left: 10px; font-family: inherit; font-weight: 600; }
        .format-recommendation .see-more:hover { background: #513c03; }
        
        /* Modal Tendances Format */
        .trends-format-modal { max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .trends-format-header { background: linear-gradient(135deg, #ffc107, #ff9800); color: #333; padding: 25px 30px; border-radius: 20px 20px 0 0; }
        .trends-format-header h2 { margin: 0 0 5px; font-size: 1.5em; }
        .trends-format-header p { margin: 0; opacity: 0.8; }
        .trends-format-tabs { display: flex; gap: 10px; padding: 20px 25px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; flex-wrap: wrap; }
        .trends-format-tab { padding: 10px 18px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.2s; font-family: inherit; }
        .trends-format-tab.linkedin { background: #e8f4fc; color: #0077b5; }
        .trends-format-tab.linkedin.active { background: #0077b5; color: white; }
        .trends-format-tab.tiktok { background: #f0f0f0; color: #333; }
        .trends-format-tab.tiktok.active { background: #000; color: white; }
        .trends-format-tab.instagram { background: #fce4ec; color: #e1306c; }
        .trends-format-tab.instagram.active { background: linear-gradient(135deg, #e1306c, #c13584); color: white; }
        .trends-format-tab.facebook { background: #e8f0fe; color: #1877f2; }
        .trends-format-tab.facebook.active { background: #1877f2; color: white; }
        .trends-format-content { padding: 25px; }
        .trend-tip-card { background: white; border-radius: 14px; padding: 18px; margin-bottom: 15px; border-left: 4px solid #ffc107; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .trend-tip-card h4 { margin: 0 0 8px; color: #333; font-size: 1em; display: flex; align-items: center; gap: 8px; }
        .trend-tip-card p { margin: 0; color: #555; font-size: 0.92em; line-height: 1.6; }
        .trend-tip-card .tip-tag { display: inline-block; background: #e8e8e8; color: #555; padding: 3px 10px; border-radius: 20px; font-size: 0.75em; font-weight: 600; margin-top: 10px; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-agency { background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; }

        /* Agency Dashboard */
        .client-section { margin-bottom: 15px; }
        .client-selector { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: inherit; font-size: 0.95em; background: white; cursor: pointer; }
        .client-selector:focus { outline: none; border-color: #1e3c72; }
        .agency-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .agency-total { background: linear-gradient(135deg, #1e3c72, #2a5298); padding: 20px 30px; border-radius: 15px; color: white; }
        .agency-total-number { font-size: 2.5em; font-weight: 800; display: block; }
        .agency-total-label { font-size: 0.95em; opacity: 0.9; }
        .btn-export { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; padding: 12px 20px; border: none; border-radius: 10px; font-family: inherit; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .btn-export:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(17,153,142,0.3); }
        
        /* Chart bars */
        .chart-container { display: flex; align-items: flex-end; justify-content: space-between; height: 150px; background: #f8f9fa; border-radius: 12px; padding: 15px; gap: 10px; }
        .chart-bar-container { flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%; }
        .chart-bar { width: 100%; background: linear-gradient(180deg, #667eea, #764ba2); border-radius: 6px 6px 0 0; display: flex; align-items: flex-start; justify-content: center; padding-top: 5px; min-height: 20px; transition: height 0.5s; }
        .chart-bar span { color: white; font-size: 0.75em; font-weight: 700; }
        .chart-label { margin-top: 8px; font-size: 0.75em; color: #666; text-transform: uppercase; }
        
        /* Client tags */
        .client-tag { display: inline-flex; align-items: center; gap: 5px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 500; }
        
        /* Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        .toggle-switch input:checked + .toggle-slider { background: linear-gradient(135deg, #1e3c72, #2a5298); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(26px); }
        
        /* Agency Unlock Buttons */
        .btn-agency-unlock { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 20px; border: none; border-radius: 8px; font-family: inherit; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-agency-unlock:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(102,126,234,0.3); }
        .btn-agency-active { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; padding: 10px 20px; border: none; border-radius: 8px; font-family: inherit; font-weight: 600; cursor: pointer; }
        .btn-agency-active:hover { opacity: 0.9; }
        
        /* Agency Code Modal */
        .agency-code-input { width: 100%; padding: 15px; font-size: 1.3em; text-align: center; border: 3px solid #e0e0e0; border-radius: 12px; font-family: inherit; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; transition: all 0.3s; }
        .agency-code-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102,126,234,0.15); }
        .agency-code-input.shake { animation: shake 0.5s; border-color: #ff6b6b; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-10px); } 40%, 80% { transform: translateX(10px); } }
        .agency-code-error { color: #ff6b6b; font-size: 0.9em; margin-top: 10px; }
        .btn-validate-code { width: 100%; margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; border: none; border-radius: 10px; font-family: inherit; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .btn-validate-code:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(30,60,114,0.3); }

        /* Client Profile Form */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 0.9em; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: inherit; font-size: 0.95em; transition: all 0.3s; box-sizing: border-box; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102,126,234,0.15); }
        .field-hint { display: block; margin-top: 6px; font-size: 0.82em; color: #888; line-height: 1.4; }

        /* Import Dropzone */
        .import-dropzone { position: relative; border: 3px dashed #d0d0d0; border-radius: 15px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 20px; }
        .import-dropzone:hover { border-color: #667eea; background: #f8f9ff; }
        .import-dropzone input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .import-dropzone-content p { margin: 10px 0 5px; color: #555; font-weight: 500; }
        
        /* Import Preview */
        .import-loading { text-align: center; padding: 30px; color: #667eea; font-weight: 600; }
        .import-error { background: #fff0f0; color: #e74c3c; padding: 15px; border-radius: 10px; text-align: center; }
        .import-success { background: #f0fff4; color: #27ae60; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 15px; font-weight: 600; }
        .import-clients-list { max-height: 300px; overflow-y: auto; }
        .import-client-card { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .import-client-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .import-client-header strong { font-size: 1.05em; }
        .import-client-domain { background: #667eea; color: white; padding: 3px 10px; border-radius: 20px; font-size: 0.75em; }
        .import-client-details { display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.85em; color: #666; }
        .import-client-details span { background: #e8e8e8; padding: 3px 8px; border-radius: 5px; }
        .btn-import-confirm { width: 100%; margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #11998e, #38ef7d); color: white; border: none; border-radius: 10px; font-family: inherit; font-size: 1.1em; font-weight: 700; cursor: pointer; }
        .btn-import-confirm:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(17,153,142,0.3); }
        
        /* Cartes clients enrichies */
        .clients-grid { display: flex; flex-direction: column; gap: 12px; max-height: 500px; overflow-y: auto; padding-right: 5px; }
        .client-card { background: white; padding: 18px; border-radius: 14px; border: 2px solid #e8e8e8; transition: all 0.2s; }
        .client-card:hover { border-color: #667eea; box-shadow: 0 4px 15px rgba(102,126,234,0.15); }
        .client-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .client-card-info { flex: 1; }
        .client-card-info strong { font-size: 1.1em; color: #333; display: block; margin-bottom: 3px; }
        .client-card-info .client-domain { font-size: 0.9em; color: #667eea; font-weight: 500; }
        .client-card-info .client-message { font-size: 0.85em; color: #666; font-style: italic; margin-top: 5px; }
        .client-card-actions { display: flex; gap: 5px; }
        .client-card-actions button { background: none; border: none; font-size: 1.1em; cursor: pointer; padding: 5px 8px; border-radius: 5px; transition: all 0.2s; }
        .client-card-actions button:hover { background: #e0e0e0; }
        .client-card-details { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #e0e0e0; }
        .client-tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: 500; }
        .client-tag.platform { background: #e3f2fd; color: #1565c0; }
        .client-tag.style { background: #fff3e0; color: #e65100; }
        .client-tag.pilier { background: #fce4ec; color: #c2185b; }
        .client-tag.objectif { background: #e8f5e9; color: #2e7d32; }
        .client-tag.audience { background: #f3e5f5; color: #7b1fa2; }

        .btn-stats { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
        .btn-planning { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }
        .btn-voice { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }

        /* Stats Modal */
        .stats-header { display: flex; gap: 20px; margin-bottom: 20px; }
        .stats-level { flex: 1; }
        .stats-level-number { font-size: 1.5em; font-weight: 700; color: #667eea; margin-bottom: 10px; }
        .stats-xp-bar { height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden; }
        .stats-xp-fill { height: 100%; background: linear-gradient(90deg, #667eea, #f093fb); transition: width 0.5s; }
        .stats-xp-text { font-size: 0.85em; color: #666; margin-top: 5px; }
        .stats-streak { text-align: center; padding: 15px 25px; background: linear-gradient(135deg, #ff6b6b, #ee5a24); border-radius: 15px; color: white; }
        .stats-streak-number { font-size: 2em; font-weight: 800; }
        .stats-streak-label { font-size: 0.85em; opacity: 0.9; }
        .stats-total { text-align: center; padding: 25px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 15px; color: white; margin-bottom: 20px; }
        .stats-total-number { font-size: 3em; font-weight: 800; display: block; }
        .stats-total-label { font-size: 1em; opacity: 0.9; }
        .stats-badges { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .stat-badge { display: flex; flex-direction: column; align-items: center; padding: 12px; border-radius: 12px; min-width: 90px; text-align: center; transition: all 0.2s; }
        .stat-badge.unlocked { background: linear-gradient(135deg, #ffd700, #ffb347); }
        .stat-badge.locked { background: #e0e0e0; opacity: 0.5; }
        .stat-badge-icon { font-size: 1.8em; margin-bottom: 5px; }
        .stat-badge-name { font-size: 0.7em; font-weight: 600; color: #333; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .stat-item { background: #f8f9fa; padding: 12px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; }
        .stat-item span { font-size: 0.85em; color: #666; }
        .stat-item strong { font-size: 1.3em; color: #333; }
        
        /* Badge Unlock Animation */
        .badge-unlock { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: linear-gradient(135deg, #ffd700, #ffb347); color: #333; padding: 15px 25px; border-radius: 15px; display: flex; align-items: center; gap: 15px; box-shadow: 0 10px 40px rgba(255,215,0,0.4); z-index: 2000; transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .badge-unlock.show { transform: translateX(-50%) translateY(0); }
        .badge-unlock-icon { font-size: 2.5em; }
        .badge-unlock-text { display: flex; flex-direction: column; }
        .badge-unlock-text strong { font-size: 0.9em; }
        .badge-unlock-text span { font-size: 1.1em; font-weight: 700; }

        .btn-trends { background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; position: relative; animation: trendsHalo 2s ease-in-out infinite; }
        .btn-trends::before { content: ''; position: absolute; top: -3px; left: -3px; right: -3px; bottom: -3px; background: linear-gradient(135deg, #ff6b6b, #ee5a24); border-radius: 12px; z-index: -1; opacity: 0.5; filter: blur(8px); animation: trendsGlow 2s ease-in-out infinite; }
        .btn-newsletter { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        @keyframes trendsGlow { 0%, 100% { opacity: 0.4; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.05); } }
        @keyframes trendsHalo { 0%, 100% { box-shadow: 0 0 5px rgba(255,107,107,0.5), 0 0 20px rgba(255,107,107,0.3); } 50% { box-shadow: 0 0 10px rgba(255,107,107,0.8), 0 0 30px rgba(255,107,107,0.5), 0 0 40px rgba(238,90,36,0.3); } }
        .btn-favorites { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        .main-container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
        .intro-section { text-align: center; margin-bottom: 40px; }
        .intro-title { font-size: 2.5em; font-weight: 800; color: #333; margin-bottom: 10px; }
        .intro-subtitle { font-size: 1.2em; color: #666; }

        /* Pillar badge */
        .pillar-suggestion { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 20px; border-radius: 30px; display: inline-flex; align-items: center; gap: 10px; margin-top: 15px; font-size: 0.9em; }
        .pillar-suggestion strong { font-weight: 700; }

        .content-layout { display: grid; grid-template-columns: 400px 1fr; gap: 30px; }
        @media (max-width: 900px) { .content-layout { grid-template-columns: 1fr; } }

        .panel { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .panel-title { font-size: 1.3em; font-weight: 700; color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .config-section { margin-bottom: 25px; }
        .config-label { font-weight: 600; color: #555; margin-bottom: 10px; display: block; }

        .structure-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .structure-card { padding: 12px; border: 2px solid #e0e0e0; border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .structure-card:hover { border-color: #f093fb; background: #fef6ff; }
        .structure-card.active { border-color: #f093fb; background: linear-gradient(135deg, rgba(240,147,251,0.1), rgba(245,87,108,0.1)); }
        .structure-icon { font-size: 1.5em; margin-bottom: 5px; }
        .structure-name { font-weight: 600; font-size: 0.85em; color: #333; }

        .format-grid, .platform-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .format-chip, .platform-chip { padding: 8px 16px; border: 2px solid #e0e0e0; border-radius: 20px; cursor: pointer; transition: all 0.2s; font-size: 0.9em; display: flex; align-items: center; gap: 6px; }
        .format-chip:hover, .platform-chip:hover { border-color: #f093fb; }
        .format-chip.active { background: linear-gradient(135deg, #f093fb, #f5576c); border-color: transparent; color: white; }
        .platform-chip.active { background: linear-gradient(135deg, #667eea, #764ba2); border-color: transparent; color: white; }

        .idea-input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-family: inherit; font-size: 1em; resize: vertical; min-height: 100px; transition: all 0.3s; }
        .idea-input:focus { outline: none; border-color: #f093fb; box-shadow: 0 0 0 4px rgba(240,147,251,0.15); }

        .quick-actions { display: flex; gap: 10px; margin-bottom: 15px; }
        .quick-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-family: inherit; font-size: 0.9em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .quick-btn.guide { background: linear-gradient(135deg, #ffd700, #ffb347); color: #333; }
        .quick-btn.help { background: linear-gradient(135deg, #00b894, #00cec9); color: white; }
        .quick-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        .generate-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, #f093fb, #f5576c); border: none; border-radius: 15px; font-family: inherit; font-size: 1.2em; font-weight: 700; color: white; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .generate-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(240,147,251,0.4); }
        .generate-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .output-panel { min-height: 500px; display: flex; flex-direction: column; }
        .output-content { flex: 1; background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); border-radius: 15px; padding: 25px; margin-bottom: 20px; overflow-y: auto; max-height: 500px; }
        .output-placeholder { text-align: center; color: #999; padding: 50px 20px; }
        .output-placeholder-icon { font-size: 4em; margin-bottom: 15px; opacity: 0.5; }
        .output-text { line-height: 1.8; color: #333; }
        .output-text h2 { color: #f5576c; margin: 20px 0 10px 0; font-size: 1.3em; }
        .output-text h3 { color: #667eea; margin: 15px 0 8px 0; font-size: 1.1em; }
        .output-text strong { color: #333; }
        .output-text pre { background: #1a1a2e; color: #eee; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 0.9em; margin: 10px 0; white-space: pre-wrap; }

        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .action-btn { flex: 1; min-width: 100px; padding: 12px 15px; border: 2px solid #e0e0e0; background: white; border-radius: 10px; font-family: inherit; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .action-btn:hover { border-color: #f093fb; background: #fef6ff; }
        .action-btn.primary { background: linear-gradient(135deg, #f093fb, #f5576c); border: none; color: white; }
        .action-btn.save { background: linear-gradient(135deg, #ff6b6b, #ee5a24); border: none; color: white; }

        /* Section Visuels */
        .visual-section-title { display: flex; align-items: center; gap: 10px; font-size: 0.85em; font-weight: 700; color: #667eea; text-transform: uppercase; letter-spacing: 1px; padding: 10px 0; border-top: 2px dashed #e0e0e0; margin-top: 5px; }
        .visual-title-icon { font-size: 1.3em; }
        .visual-btn { position: relative; overflow: hidden; }
        .visual-btn.sending { opacity: 0.7; pointer-events: none; }
        .visual-btn.sent::after { content: '✓ Envoyé !'; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; font-weight: 700; animation: sentPulse 0.5s ease; }
        @keyframes sentPulse { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }

        /* ==================== CASCADE STYLES ==================== */
        .btn-cascade { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; position: relative; }
        .btn-cascade::before { content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 10px; z-index: -1; opacity: 0.4; filter: blur(6px); }
        
        .btn-posts { background: linear-gradient(135deg, #10b981, #059669); color: white; position: relative; }
        .btn-posts::before { content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 10px; z-index: -1; opacity: 0.4; filter: blur(6px); animation: postsGlow 2s ease-in-out infinite; }
        @keyframes postsGlow { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.6; } }
        
        .cascade-container { display: flex; gap: 20px; padding: 20px; max-height: calc(90vh - 80px); overflow: hidden; }
        .cascade-calendar { flex: 1; overflow-y: auto; }
        .cascade-sidebar { width: 280px; background: #f8f9fa; border-radius: 16px; padding: 20px; display: flex; flex-direction: column; max-height: 100%; overflow: hidden; }
        
        .cascade-nav-btn { background: rgba(102,126,234,0.1); border: 2px solid #667eea; color: #667eea; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .cascade-nav-btn:hover { background: #667eea; color: white; }
        
        .cascade-week { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        
        .cascade-day { background: white; border: 2px solid #e8e8e8; border-radius: 12px; min-height: 180px; display: flex; flex-direction: column; transition: all 0.2s; }
        .cascade-day:hover { border-color: #667eea; box-shadow: 0 4px 15px rgba(102,126,234,0.15); }
        .cascade-day.today { border-color: #667eea; background: linear-gradient(180deg, rgba(102,126,234,0.05), white); }
        .cascade-day.weekend { background: #fafafa; }
        .cascade-day.past { opacity: 0.6; background: #f0f0f0; pointer-events: none; }
        .cascade-day.past .cascade-day-header { background: #e8e8e8; }
        .cascade-day.past .cascade-slot { pointer-events: auto; cursor: default; }
        .cascade-slot.past-slot { opacity: 0.7; filter: grayscale(30%); }
        .cascade-slot-done { position: absolute; bottom: 5px; right: 8px; font-size: 0.8em; background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 10px; }
        .cascade-day.drag-over { border-color: #10b981; border-style: dashed; background: rgba(16,185,129,0.05); }
        
        .cascade-day-header { padding: 10px; border-bottom: 1px solid #eee; text-align: center; background: linear-gradient(180deg, #f8f9fa, transparent); border-radius: 10px 10px 0 0; }
        .cascade-day-name { font-size: 0.75em; text-transform: uppercase; color: #888; letter-spacing: 1px; }
        .cascade-day-number { font-size: 1.4em; font-weight: 700; color: #333; }
        .cascade-day.today .cascade-day-number { color: white; background: #667eea; width: 35px; height: 35px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; }
        
        .cascade-day-slots { flex: 1; padding: 8px; display: flex; flex-direction: column; gap: 6px; overflow-y: auto; }
        
        .cascade-slot { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 10px; border-radius: 8px; font-size: 0.8em; cursor: pointer; transition: all 0.2s; position: relative; }
        .cascade-slot:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(102,126,234,0.3); }
        .cascade-slot.linkedin { background: linear-gradient(135deg, #0077b5, #005582); }
        .cascade-slot.instagram { background: linear-gradient(135deg, #E1306C, #C13584); }
        .cascade-slot.twitter { background: linear-gradient(135deg, #1DA1F2, #0d8bd9); }
        .cascade-slot.facebook { background: linear-gradient(135deg, #1877F2, #0d65d9); }
        .cascade-slot.tiktok { background: linear-gradient(135deg, #000000, #333333); }
        
        .cascade-slot-time { font-weight: 700; font-size: 0.9em; }
        .cascade-slot-preview { font-size: 0.85em; opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; margin-top: 3px; }
        .cascade-slot-platform { position: absolute; top: 5px; right: 8px; font-size: 0.9em; }
        
        .cascade-add-btn { width: 100%; padding: 8px; background: transparent; border: 2px dashed #ddd; border-radius: 8px; color: #999; cursor: pointer; transition: all 0.2s; font-size: 0.85em; margin-top: auto; }
        .cascade-add-btn:hover { border-color: #667eea; color: #667eea; background: rgba(102,126,234,0.05); }
        
        .cascade-sidebar-title { font-size: 1em; font-weight: 700; color: #333; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .cascade-sidebar-desc { font-size: 0.8em; color: #888; margin-bottom: 15px; }
        
        .cascade-favorites { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; max-height: 250px; padding-right: 5px; }
        
        .cascade-fav-item { background: white; border: 2px solid #e8e8e8; border-radius: 10px; padding: 10px; cursor: grab; transition: all 0.2s; font-size: 0.85em; }
        .cascade-fav-item:hover { border-color: #667eea; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
        .cascade-fav-item:active { cursor: grabbing; transform: scale(0.98); }
        .cascade-fav-item.dragging { opacity: 0.5; }
        .cascade-fav-platform { font-size: 0.75em; color: #667eea; font-weight: 600; margin-bottom: 3px; }
        .cascade-fav-preview { color: #555; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .cascade-export-section { margin-top: auto; padding-top: 15px; border-top: 1px solid #e0e0e0; }
        .cascade-export-buttons { display: flex; flex-direction: column; gap: 8px; }
        .cascade-export-btn { display: flex; align-items: center; gap: 10px; padding: 10px 15px; background: white; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-family: inherit; font-size: 0.9em; }
        .cascade-export-btn:hover { border-color: #667eea; background: rgba(102,126,234,0.05); }
        .cascade-export-btn span { font-size: 1.2em; }
        
        .cascade-empty { text-align: center; padding: 20px; color: #999; font-size: 0.9em; }
        
        .cascade-stats { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .cascade-stats-title { font-size: 0.8em; opacity: 0.9; margin-bottom: 5px; }
        .cascade-stats-value { font-size: 1.8em; font-weight: 800; }
        
        @media (max-width: 900px) {
            .cascade-container { flex-direction: column; }
            .cascade-sidebar { width: 100%; max-height: 200px; }
            .cascade-week { grid-template-columns: repeat(4, 1fr); }
        }

        .visual-section { margin-top: 25px; padding-top: 25px; border-top: 2px dashed #e0e0e0; }
        .visual-title { font-weight: 700; color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .copy-prompt-btn { padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 0.85em; cursor: pointer; font-family: inherit; }

        .toast { position: fixed; bottom: 30px; right: 30px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px 25px; border-radius: 10px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 1000; }
        .toast.show { transform: translateX(0); }

        .idea-btn { padding: 10px 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-family: inherit; margin: 5px; }
        .idea-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }

        /* Trends suggestions */
        .trend-card { background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 12px; border-left: 4px solid #ff6b6b; cursor: pointer; transition: all 0.2s; }
        .trend-card:hover { background: #fff0f0; transform: translateX(5px); }
        .trend-title { font-weight: 600; color: #333; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .trend-desc { font-size: 0.9em; color: #666; margin-bottom: 10px; }
        .trend-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
        .trend-actions { display: flex; gap: 10px; margin-top: 12px; }
        .trend-use-btn { padding: 6px 14px; background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; border: none; border-radius: 20px; font-size: 0.8em; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .trend-use-btn:hover { transform: scale(1.05); }
        .trend-save-btn { padding: 6px 14px; background: white; border: 2px solid #ffc107; color: #856404; border-radius: 20px; font-size: 0.8em; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .trend-save-btn:hover { background: #ffc107; color: white; }
        .trend-save-btn.saved { background: #ffc107; color: white; }

        /* Trends Tabs */
        .trends-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e8e8e8; padding-bottom: 15px; }
        .trends-tab { padding: 10px 20px; background: transparent; border: none; border-radius: 10px; font-family: inherit; font-weight: 600; font-size: 0.95em; cursor: pointer; color: #666; transition: all 0.3s; }
        .trends-tab:hover { background: #f0f0f0; color: #333; }
        .trends-tab.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .trends-tab .badge { display: inline-block; background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 5px; }

        /* Saved ideas section */
        .saved-ideas-section { margin-top: 20px; padding-top: 20px; border-top: 2px dashed #e8e8e8; }
        .saved-ideas-title { font-weight: 600; color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .saved-idea-card { background: linear-gradient(135deg, #fff9e6, #fff3cd); border-left: 4px solid #ffc107; }
        .saved-idea-date { font-size: 0.75em; color: #856404; margin-top: 8px; }
        .trend-delete-btn { padding: 4px 10px; background: #ffebee; border: none; color: #c62828; border-radius: 15px; font-size: 0.75em; cursor: pointer; font-family: inherit; }
        .trend-delete-btn:hover { background: #c62828; color: white; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-overlay.show, .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 20px; padding: 30px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.5em; font-weight: 700; color: #333; }
        .modal-close { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #999; }
        .favorite-item { background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .favorite-item-date { font-size: 0.8em; color: #999; margin-bottom: 8px; }
        .favorite-item-text { font-size: 0.95em; line-height: 1.6; color: #333; max-height: 150px; overflow: hidden; }
        .favorite-item-actions { display: flex; gap: 10px; margin-top: 10px; }
        .favorite-item-btn { padding: 6px 12px; border: none; border-radius: 6px; font-size: 0.8em; cursor: pointer; font-family: inherit; }
        .favorite-item-btn.use { background: #667eea; color: white; }
        .favorite-item-btn.delete { background: #ff6b6b; color: white; }
        .empty-favorites { text-align: center; color: #999; padding: 40px 20px; }

        .help-textarea { width: 100%; min-height: 150px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-family: inherit; font-size: 1em; resize: vertical; margin-bottom: 15px; }
        .help-textarea:focus { outline: none; border-color: #00b894; }
        .help-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #00b894, #00cec9); color: white; border: none; border-radius: 10px; font-family: inherit; font-size: 1em; font-weight: 600; cursor: pointer; }

        /* Planning IA Styles */
        .planning-intro { background: linear-gradient(135deg, rgba(17,153,142,0.1), rgba(56,239,125,0.1)); border-radius: 15px; padding: 20px; margin-bottom: 25px; text-align: center; }
        .planning-intro h3 { color: #11998e; margin-bottom: 10px; }
        .planning-intro p { color: #666; font-size: 0.95em; }
        .planning-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .planning-stat { background: #f8f9fa; border-radius: 12px; padding: 15px; text-align: center; }
        .planning-stat-value { font-size: 1.8em; font-weight: 700; color: #11998e; }
        .planning-stat-label { font-size: 0.8em; color: #666; margin-top: 5px; }
        .planning-generate-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, #11998e, #38ef7d); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .planning-generate-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(17,153,142,0.3); }
        .planning-generate-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .planning-results { margin-top: 25px; }
        .planning-section { background: white; border: 1px solid #e0e0e0; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .planning-section h4 { color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .heatmap-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 15px; }
        .heatmap-day { text-align: center; padding: 8px 5px; border-radius: 8px; font-size: 0.75em; }
        .heatmap-day.header { background: #f0f0f0; font-weight: 600; color: #666; }
        .heatmap-day.empty { background: #f8f9fa; color: #ccc; }
        .heatmap-day.low { background: rgba(17,153,142,0.2); color: #11998e; }
        .heatmap-day.medium { background: rgba(17,153,142,0.5); color: white; }
        .heatmap-day.high { background: #11998e; color: white; font-weight: 600; }
        .planning-suggestion { display: flex; align-items: flex-start; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; margin-bottom: 12px; transition: all 0.3s; }
        .planning-suggestion:hover { background: #f0f0f0; transform: translateX(5px); }
        .planning-suggestion-icon { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.3em; flex-shrink: 0; }
        .planning-suggestion-icon.linkedin { background: #e8f4fc; }
        .planning-suggestion-icon.instagram { background: #fce4ec; }
        .planning-suggestion-icon.tiktok { background: #f0f0f0; }
        .planning-suggestion-icon.facebook { background: #e8f0fe; }
        .planning-suggestion-content { flex: 1; }
        .planning-suggestion-title { font-weight: 600; color: #333; margin-bottom: 5px; }
        .planning-suggestion-meta { font-size: 0.85em; color: #888; }
        .planning-suggestion-reason { font-size: 0.9em; color: #666; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #e0e0e0; }
        .planning-alert { display: flex; align-items: center; gap: 12px; padding: 15px; border-radius: 12px; margin-bottom: 12px; }
        .planning-alert.warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        .planning-alert.success { background: #d4edda; border-left: 4px solid #28a745; }
        .planning-alert.info { background: #e7f3ff; border-left: 4px solid #667eea; }
        .planning-pillar-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .planning-pillar-name { width: 120px; font-size: 0.9em; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .planning-pillar-track { flex: 1; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden; }
        .planning-pillar-fill { height: 100%; background: linear-gradient(90deg, #11998e, #38ef7d); border-radius: 6px; transition: width 0.5s; }
        .planning-pillar-count { width: 40px; text-align: right; font-size: 0.85em; color: #888; }

        /* Tour guidé */
        .tour-tooltip { position: fixed; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px 30px; border-radius: 20px; width: 340px; z-index: 2000; box-shadow: 0 20px 50px rgba(102,126,234,0.5); animation: tooltipSlideIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .tour-tooltip.side-left { left: 30px; }
        .tour-tooltip.side-right { right: 30px; }
        @keyframes tooltipSlideIn { from { opacity: 0; transform: translateY(20px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .tour-tooltip-step { font-size: 0.75em; opacity: 0.7; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .tour-tooltip-title { font-weight: 800; margin-bottom: 12px; font-size: 1.3em; }
        .tour-tooltip-text { font-size: 0.95em; line-height: 1.7; margin-bottom: 20px; }
        .tour-tooltip-text strong { color: #ffd700; }
        .tour-tooltip-progress { display: flex; gap: 6px; justify-content: center; margin-bottom: 20px; }
        .tour-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.3); transition: all 0.3s; }
        .tour-dot.active { background: #ffd700; transform: scale(1.2); }
        .tour-tooltip-buttons { display: flex; gap: 12px; justify-content: space-between; }
        .tour-btn { padding: 12px 24px; border: none; border-radius: 10px; font-size: 0.95em; cursor: pointer; font-family: inherit; font-weight: 700; transition: all 0.3s; }
        .tour-btn.skip { background: rgba(255,255,255,0.15); color: white; }
        .tour-btn.skip:hover { background: rgba(255,255,255,0.25); }
        .tour-btn.next { background: white; color: #667eea; }
        .tour-btn.next:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .tour-highlight { position: relative; z-index: 1001; background: white; border-radius: 12px; box-shadow: 0 0 0 4px rgba(240,147,251,0.6), 0 0 30px rgba(240,147,251,0.4); animation: highlightPulse 2s infinite; }
        @keyframes highlightPulse { 0%, 100% { box-shadow: 0 0 0 4px rgba(240,147,251,0.6), 0 0 30px rgba(240,147,251,0.4); } 50% { box-shadow: 0 0 0 8px rgba(240,147,251,0.4), 0 0 50px rgba(240,147,251,0.3); } }
        .tour-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 999; display: none; backdrop-filter: blur(3px); }
        .tour-overlay.show { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Ma Voix Styles */
        .voice-section { background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(240,147,251,0.1)); border-radius: 15px; padding: 20px; margin-top: 20px; }
        .voice-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .voice-title { font-size: 1.1em; font-weight: 700; color: #333; display: flex; align-items: center; gap: 10px; }
        .voice-badge { display: inline-flex; align-items: center; gap: 5px; padding: 5px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; }
        .voice-badge.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .voice-badge.inactive { background: #f0f0f0; color: #888; }
        .voice-btn { padding: 10px 20px; border: none; border-radius: 10px; font-family: inherit; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .voice-btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .voice-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }
        .voice-btn-secondary { background: white; border: 2px solid #667eea; color: #667eea; }
        .voice-btn-secondary:hover { background: #667eea; color: white; }
        .voice-btn-danger { background: #ff6b6b; color: white; }
        .voice-textarea { width: 100%; min-height: 200px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-family: inherit; font-size: 0.95em; resize: vertical; transition: border-color 0.3s; }
        .voice-textarea:focus { outline: none; border-color: #667eea; }
        .voice-samples { display: flex; flex-direction: column; gap: 10px; margin: 15px 0; }
        .voice-sample { background: white; border: 1px solid #e0e0e0; border-radius: 10px; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        .voice-sample-text { flex: 1; font-size: 0.9em; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 400px; }
        .voice-sample-actions { display: flex; gap: 8px; }
        .voice-sample-btn { background: none; border: none; cursor: pointer; font-size: 1.1em; opacity: 0.6; transition: opacity 0.3s; }
        .voice-sample-btn:hover { opacity: 1; }
        .voice-analysis { background: white; border-radius: 12px; padding: 20px; margin-top: 15px; }
        .voice-analysis-title { font-weight: 700; color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .voice-trait { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .voice-trait:last-child { border-bottom: none; }
        .voice-trait-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2em; }
        .voice-trait-icon.tone { background: #e8f5e9; }
        .voice-trait-icon.length { background: #e3f2fd; }
        .voice-trait-icon.vocab { background: #fff3e0; }
        .voice-trait-icon.punctuation { background: #fce4ec; }
        .voice-trait-icon.structure { background: #f3e5f5; }
        .voice-trait-content { flex: 1; }
        .voice-trait-label { font-size: 0.85em; color: #888; margin-bottom: 3px; }
        .voice-trait-value { font-weight: 600; color: #333; }
        .voice-fidelity { display: flex; align-items: center; gap: 10px; padding: 15px; background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border-radius: 10px; margin-top: 15px; }
        .voice-fidelity-score { font-size: 1.8em; font-weight: 800; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .voice-fidelity-label { font-size: 0.9em; color: #666; }
        
        /* Badge fidélité voix sur contenu généré */
        .voice-fidelity-badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 15px; background: linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.15)); border: 1px solid rgba(102,126,234,0.3); border-radius: 20px; font-size: 0.85em; margin-bottom: 15px; }
        .voice-fidelity-badge .score { font-weight: 700; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .voice-fidelity-badge .label { color: #666; }
        .voice-feedback { display: flex; align-items: center; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; margin-top: 15px; }
        .voice-feedback-question { flex: 1; font-size: 0.95em; color: #555; }
        .voice-feedback-buttons { display: flex; gap: 8px; }
        .voice-feedback-btn { padding: 8px 16px; border: none; border-radius: 8px; font-size: 0.9em; cursor: pointer; transition: all 0.3s; }
        .voice-feedback-btn.yes { background: #d4edda; color: #155724; }
        .voice-feedback-btn.yes:hover { background: #28a745; color: white; }
        .voice-feedback-btn.no { background: #f8d7da; color: #721c24; }
        .voice-feedback-btn.no:hover { background: #dc3545; color: white; }
        .voice-feedback-thanks { color: #28a745; font-weight: 600; display: none; }

        /* Newsletter Module - MA VOIX Button */
        .ma-voix-section { margin-top: 20px; }
        .ma-voix-option { display: flex; flex-direction: column; gap: 12px; }
        .btn-ma-voix { display: flex; align-items: center; gap: 15px; padding: 15px 20px; background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(240,147,251,0.1)); border: 2px solid #667eea; border-radius: 12px; cursor: pointer; transition: all 0.3s; }
        .btn-ma-voix:hover:not(.disabled) { background: linear-gradient(135deg, #667eea, #764ba2); border-color: transparent; }
        .btn-ma-voix:hover:not(.disabled) .ma-voix-text strong { color: white; }
        .btn-ma-voix:hover:not(.disabled) .ma-voix-text small { color: rgba(255,255,255,0.8); }
        .btn-ma-voix:hover:not(.disabled) .ma-voix-icon { transform: scale(1.2); }
        .btn-ma-voix.disabled { opacity: 0.5; cursor: not-allowed; border-color: #ccc; }
        .ma-voix-icon { font-size: 2em; transition: transform 0.3s; }
        .ma-voix-text { display: flex; flex-direction: column; text-align: left; }
        .ma-voix-text strong { font-size: 1.1em; color: #333; transition: color 0.3s; }
        .ma-voix-text small { color: #666; font-size: 0.85em; transition: color 0.3s; }
        .ma-voix-hint { font-size: 0.85em; color: #888; padding: 10px; background: #f8f9fa; border-radius: 8px; }
        .ma-voix-active { display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.1)); border: 1px solid #10b981; border-radius: 8px; color: #059669; font-weight: 600; }
        .ma-voix-preview { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 1px solid #e0e0e0; }
        .ma-voix-preview h5 { font-size: 0.9em; color: #555; margin-bottom: 10px; }
        .ma-voix-preview-content { font-size: 0.9em; }
        .voice-preview-profile { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .voice-tag { display: inline-flex; align-items: center; gap: 5px; padding: 5px 10px; background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(240,147,251,0.1)); border-radius: 15px; font-size: 0.85em; color: #555; }
        .voice-preview-samples { margin-top: 10px; }
        .samples-count { font-size: 0.85em; color: #888; display: block; margin-bottom: 5px; }
        .sample-excerpt { font-style: italic; color: #666; font-size: 0.9em; padding: 10px; background: white; border-radius: 8px; border-left: 3px solid #667eea; }

        /* Newsletter Module - Tone Grid */
        .tone-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-top: 10px; }
        .tone-card { padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s; }
        .tone-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .tone-card.selected { border-color: #667eea; background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(240,147,251,0.1)); }
        .tone-icon { font-size: 1.5em; display: block; margin-bottom: 5px; }
        .tone-name { font-weight: 600; color: #333; display: block; margin-bottom: 3px; }
        .tone-desc { font-size: 0.75em; color: #888; display: block; }

        /* Newsletter Module - General Styles */
        .newsletter-container { padding: 20px; }
        .newsletter-header { margin-bottom: 20px; }
        .newsletter-main-title { font-size: 1.4em; font-weight: 700; color: #333; display: flex; align-items: center; gap: 10px; }
        .newsletter-icon { font-size: 1.2em; }
        .newsletter-progress { margin-bottom: 25px; }
        .progress-steps { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .progress-step { text-align: center; flex: 1; }
        .progress-step .step-icon { font-size: 1.3em; opacity: 0.4; transition: opacity 0.3s; }
        .progress-step .step-label { font-size: 0.75em; color: #888; margin-top: 3px; }
        .progress-step.active .step-icon { opacity: 1; }
        .progress-step.current .step-label { color: #667eea; font-weight: 600; }
        .progress-bar { height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s; }
        .step-content { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); }
        .step-title { font-size: 1.2em; font-weight: 700; color: #333; margin-bottom: 8px; }
        .step-description { color: #666; font-size: 0.95em; margin-bottom: 20px; }
        .section-label { font-size: 0.95em; font-weight: 600; color: #555; margin-bottom: 10px; }
        .newsletter-nav { display: flex; justify-content: space-between; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .btn-primary { padding: 12px 25px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { padding: 12px 25px; background: white; color: #667eea; border: 2px solid #667eea; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-secondary:hover { background: #667eea; color: white; }
        .btn-generate { padding: 15px 30px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1.1em; cursor: pointer; transition: all 0.3s; }
        .btn-generate:hover { transform: translateY(-2px); box-shadow: 0 5px 25px rgba(16,185,129,0.5); }
        .type-grid, .structure-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .type-card, .structure-card { padding: 20px; background: white; border: 2px solid #e0e0e0; border-radius: 15px; cursor: pointer; transition: all 0.3s; }
        .type-card:hover, .structure-card:hover { border-color: #667eea; transform: translateY(-3px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .type-card.selected, .structure-card.selected { border-color: #667eea; background: linear-gradient(135deg, rgba(102,126,234,0.08), rgba(240,147,251,0.08)); }
        .type-icon, .structure-icon { font-size: 2em; margin-bottom: 10px; }
        .type-name, .structure-name { font-weight: 700; color: #333; margin-bottom: 5px; }
        .type-description, .structure-description { font-size: 0.85em; color: #666; }
        .structure-steps { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e0e0e0; }
        .structure-step { font-size: 0.8em; color: #888; padding: 2px 0; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; color: #333; margin-bottom: 8px; }
        .form-group textarea, .form-group input, .form-group select { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: inherit; font-size: 0.95em; transition: border-color 0.3s; }
        .form-group textarea:focus, .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .result-section { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .section-title { font-weight: 600; color: #333; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .subject-options { display: flex; flex-direction: column; gap: 10px; }
        .subject-option { display: flex; align-items: center; gap: 12px; padding: 12px 15px; background: white; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; transition: all 0.3s; }
        .subject-option:hover, .subject-option.selected { border-color: #667eea; }
        .subject-num { width: 25px; height: 25px; background: #667eea; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: 600; }
        .subject-text { flex: 1; }
        .email-body-box { background: white; border-radius: 10px; padding: 20px; border: 1px solid #e0e0e0; }
        .email-content { line-height: 1.7; color: #333; white-space: pre-wrap; }
        .cta-button-preview { padding: 15px 30px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 1.1em; }
        .adjustment-options { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .adjust-btn { padding: 8px 15px; background: white; border: 1px solid #e0e0e0; border-radius: 20px; font-size: 0.85em; cursor: pointer; transition: all 0.3s; }
        .adjust-btn:hover { border-color: #667eea; background: rgba(102,126,234,0.1); }
        .generation-loader { text-align: center; padding: 50px; }
        .loader-animation { width: 80px; height: 80px; margin: 0 auto 20px; border: 4px solid #e0e0e0; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .newsletter-toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 15px 25px; background: #333; color: white; border-radius: 10px; font-weight: 600; z-index: 10000; animation: toastIn 0.3s; }
        .newsletter-toast.success { background: #10b981; }
        .newsletter-toast.error { background: #ef4444; }
        .newsletter-toast.fade-out { animation: toastOut 0.3s forwards; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        @keyframes toastOut { to { opacity: 0; transform: translateX(-50%) translateY(20px); } }
        .newsletter-loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .copy-btn { padding: 5px 10px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8em; }
        .copy-btn:hover { background: #2563eb; }

        /* Flèche du tour */
        .tour-arrow { position: fixed; z-index: 2001; width: 0; height: 0; }
        .tour-arrow.arrow-right { border-top: 15px solid transparent; border-bottom: 15px solid transparent; border-right: 20px solid #ffd700; animation: arrowBounceLeft 1s infinite; }
        .tour-arrow.arrow-left { border-top: 15px solid transparent; border-bottom: 15px solid transparent; border-left: 20px solid #ffd700; animation: arrowBounceRight 1s infinite; }
        @keyframes arrowBounceLeft { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(-8px); } }
        @keyframes arrowBounceRight { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(8px); } }

        .demo-badge { position: fixed; bottom: 30px; left: 30px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 20px; border-radius: 30px; font-weight: 600; cursor: pointer; box-shadow: 0 5px 20px rgba(102,126,234,0.4); z-index: 100; display: flex; align-items: center; gap: 8px; animation: demoBadgePulse 3s infinite; }
        .demo-badge:hover { transform: scale(1.05); }
        @keyframes demoBadgePulse { 0%, 100% { box-shadow: 0 5px 20px rgba(102,126,234,0.4); } 50% { box-shadow: 0 5px 30px rgba(102,126,234,0.7), 0 0 50px rgba(240,147,251,0.3); } }

        /* Memory indicator */
        .memory-indicator { background: rgba(102,126,234,0.1); border-radius: 10px; padding: 10px 15px; margin-bottom: 15px; font-size: 0.85em; color: #667eea; display: flex; align-items: center; gap: 8px; }
        .memory-indicator strong { font-weight: 600; }

        /* Export Button */
        .action-btn.export { background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white; }
        .action-btn.export:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }

        /* Format PUB special style */
        .format-chip.pub { background: #fff0f3; color: #f5576c; border-color: #f5576c; font-weight: 700; }
        .format-chip.pub:hover { transform: scale(1.05); background: #ffe0e6; box-shadow: 0 5px 15px rgba(245,87,108,0.2); }
        .format-chip.pub.active { background: linear-gradient(135deg, #f5576c, #f093fb); color: white; border-color: transparent; box-shadow: 0 5px 20px rgba(245,87,108,0.4); }

        /* PUB Options Section */
        .pub-options { background: linear-gradient(135deg, #fff5f7, #fef0f5); border-radius: 15px; padding: 20px; border: 2px solid #fcd5df; animation: slideDown 0.3s ease; }
        
        .pub-platform-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .pub-platform-chip { display: flex; flex-direction: column; align-items: center; padding: 15px 12px; background: white; border: 2px solid #e8e8e8; border-radius: 12px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .pub-platform-chip:hover { border-color: #f5576c; background: #fff8f9; transform: translateY(-2px); }
        .pub-platform-chip.active { border-color: #f5576c; background: linear-gradient(135deg, #fff0f3, #ffeef5); box-shadow: 0 5px 15px rgba(245,87,108,0.15); }
        .pub-platform-chip .pub-icon { font-size: 1.8em; margin-bottom: 8px; }
        .pub-platform-chip .pub-name { font-weight: 700; color: #333; font-size: 0.95em; }
        .pub-platform-chip .pub-desc { font-size: 0.75em; color: #888; margin-top: 3px; }

        .pub-objective-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .pub-objective-chip { padding: 10px 18px; background: white; border: 2px solid #e8e8e8; border-radius: 25px; cursor: pointer; transition: all 0.3s; font-weight: 500; font-size: 0.9em; }
        .pub-objective-chip:hover { border-color: #f5576c; background: #fff8f9; }
        .pub-objective-chip.active { border-color: #f5576c; background: linear-gradient(135deg, #f5576c, #f093fb); color: white; }

        .pub-info-banner { margin-top: 20px; padding: 12px 15px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 10px; border-left: 4px solid #4caf50; font-size: 0.88em; color: #2e7d32; display: flex; align-items: center; gap: 10px; }
        .pub-info-banner strong { color: #1b5e20; }

        /* Export Modal */
        .export-modal-body { padding: 25px; }
        .export-preview { background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px; padding: 15px; margin-bottom: 25px; max-height: 150px; overflow-y: auto; font-size: 0.9em; line-height: 1.6; color: #333; border-left: 4px solid #667eea; }
        .export-section-title { font-size: 0.85em; font-weight: 700; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .export-quick-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 25px; }
        .export-quick-btn { display: flex; align-items: center; gap: 10px; padding: 12px 18px; background: white; border: 2px solid #e0e0e0; border-radius: 12px; cursor: pointer; transition: all 0.3s; font-family: inherit; }
        .export-quick-btn:hover { border-color: #667eea; background: #f8f9ff; transform: translateY(-2px); }
        .export-quick-btn .icon { font-size: 1.3em; }
        .export-quick-btn .text { text-align: left; }
        .export-quick-btn .text .label { font-weight: 600; font-size: 0.9em; color: #333; }
        .export-quick-btn .text .desc { font-size: 0.75em; color: #888; }
        
        .export-partners-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .export-partner-card { background: white; border: 2px solid #e8e8e8; border-radius: 16px; padding: 18px; cursor: pointer; transition: all 0.3s; position: relative; }
        .export-partner-card:hover { border-color: #f093fb; transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .export-partner-card.recommended { border-color: #10b981; }
        .export-partner-card.recommended::before { content: '⭐ Recommandé'; position: absolute; top: -10px; right: 15px; font-size: 0.7em; padding: 3px 10px; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 20px; font-weight: 600; }
        .partner-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .partner-logo { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2em; color: white; font-weight: 700; }
        .partner-logo.metricool { background: linear-gradient(135deg, #00D4AA, #00A080); }
        .partner-logo.swello { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .partner-logo.agorapulse { background: linear-gradient(135deg, #f97316, #ea580c); }
        .partner-logo.buffer { background: linear-gradient(135deg, #168eea, #0d6efd); }
        .partner-name { font-weight: 700; font-size: 1em; color: #333; }
        .partner-tagline { font-size: 0.75em; color: #888; }
        .partner-features { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .partner-feature { font-size: 0.7em; padding: 3px 8px; background: #f0f4ff; color: #667eea; border-radius: 20px; }
        .partner-feature.french { background: #dbeafe; color: #2563eb; }
        .partner-feature.auto { background: #d1fae5; color: #059669; }
        .partner-price { font-size: 0.8em; color: #666; }
        .partner-price strong { color: #333; }
        
        .export-info-banner { background: linear-gradient(135deg, #dbeafe, #ede9fe); border-radius: 12px; padding: 12px 15px; margin-top: 20px; font-size: 0.85em; color: #4338ca; display: flex; align-items: flex-start; gap: 10px; }
        .export-info-banner .icon { font-size: 1.1em; }

        @media (max-width: 600px) {
            .export-partners-grid { grid-template-columns: 1fr; }
            .header { padding: 12px 15px; flex-direction: column; gap: 10px; }
            .header-buttons { justify-content: center; }
            .intro-title { font-size: 1.8em; }
            .structure-grid { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
            .quick-actions { flex-direction: column; }
        }

        /* ===== ONBOARDING STYLES ===== */
        .onboarding-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            z-index: 10000; animation: fadeIn 0.3s ease; padding: 20px; overflow-y: auto;
        }
        .onboarding-overlay.closing { animation: fadeOut 0.3s ease forwards; }
        .onboarding-modal {
            background: white; border-radius: 20px; width: 100%; max-width: 700px;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .onboarding-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; text-align: center; position: relative; border-radius: 20px 20px 0 0;
        }
        .onboarding-header h2 { font-size: 1.8em; margin-bottom: 10px; }
        .onboarding-header p { opacity: 0.9; font-size: 1.1em; }
        .onboarding-close {
            position: absolute; top: 15px; right: 15px; background: rgba(255, 255, 255, 0.2);
            border: none; color: white; font-size: 1.5em; width: 40px; height: 40px;
            border-radius: 50%; cursor: pointer; transition: background 0.3s;
        }
        .onboarding-close:hover { background: rgba(255, 255, 255, 0.3); }
        .onboarding-form { padding: 30px; }
        .onboarding-section { margin-bottom: 30px; padding-bottom: 25px; border-bottom: 1px solid #eee; }
        .onboarding-section:last-of-type { border-bottom: none; margin-bottom: 20px; }
        .onboarding-section h3 { color: #667eea; font-size: 1.3em; margin-bottom: 15px; }
        .section-hint { color: #888; font-size: 0.95em; margin-bottom: 15px; }
        .onboarding-form .form-group { margin-bottom: 20px; }
        .onboarding-form .form-group label { display: block; font-weight: 600; color: #333; margin-bottom: 8px; }
        .onboarding-form .form-group input[type="text"],
        .onboarding-form .form-group textarea {
            width: 100%; padding: 14px 18px; border: 2px solid #e0e0e0; border-radius: 12px;
            font-size: 1em; font-family: inherit; transition: border-color 0.3s, box-shadow 0.3s; box-sizing: border-box;
        }
        .onboarding-form .form-group input[type="text"]:focus,
        .onboarding-form .form-group textarea:focus {
            outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        }
        .onboarding-form .form-group small { display: block; color: #888; font-size: 0.85em; margin-top: 6px; }
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .checkbox-grid-compact { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; }
        .checkbox-card { cursor: pointer; }
        .checkbox-card input { display: none; }
        .checkbox-content {
            display: flex; align-items: center; gap: 10px; padding: 12px 16px;
            background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; transition: all 0.2s;
        }
        .checkbox-grid-compact .checkbox-content { padding: 10px 12px; gap: 8px; }
        .checkbox-grid-compact .checkbox-icon { font-size: 1.1em; }
        .checkbox-grid-compact .checkbox-label { font-size: 0.9em; }
        .checkbox-card input:checked + .checkbox-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea; color: white;
        }
        .checkbox-icon { font-size: 1.3em; }
        .checkbox-label { font-weight: 500; }
        .checkbox-content:hover { border-color: #667eea; transform: translateY(-2px); }
        .radio-cards { display: flex; flex-direction: column; gap: 12px; }
        .radio-cards-2col { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .radio-cards-3col { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        @media (max-width: 700px) { .radio-cards-3col { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .radio-cards-2col { grid-template-columns: 1fr; } }
        .radio-card { cursor: pointer; }
        .radio-card input { display: none; }
        .radio-content {
            display: flex; align-items: center; gap: 12px; padding: 16px;
            background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; transition: all 0.2s;
        }
        .radio-card-compact .radio-content { padding: 10px 14px; gap: 8px; }
        .radio-card-compact .radio-label { font-size: 0.9em; }
        .radio-card input:checked + .radio-content {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-color: #667eea;
        }
        .radio-card input:checked + .radio-content .radio-icon { transform: scale(1.2); }
        .radio-content:hover { border-color: #667eea; transform: translateY(-2px); }
        .radio-icon { font-size: 1.8em; transition: transform 0.2s; }
        .radio-label { font-weight: 600; color: #333; display: block; }
        .radio-desc { font-size: 0.85em; color: #666; display: block; margin-top: 2px; }
        .onboarding-actions { display: flex; gap: 15px; justify-content: center; padding-top: 20px; }
        .onboarding-actions .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 16px 40px; font-size: 1.1em; font-weight: 600;
            border-radius: 12px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; font-family: inherit;
        }
        .onboarding-actions .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        .onboarding-notif {
            position: fixed; bottom: 30px; right: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 16px 24px; border-radius: 12px;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4); z-index: 10001;
            font-weight: 600; font-size: 1.05em; transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .onboarding-notif.active { transform: translateX(0); }
        .required { color: #e74c3c; font-weight: bold; }
        @media (max-width: 500px) {
            .onboarding-modal { border-radius: 15px; }
            .onboarding-header { padding: 25px 20px; border-radius: 15px 15px 0 0; }
            .onboarding-header h2 { font-size: 1.4em; }
            .onboarding-form { padding: 20px; }
            .checkbox-grid { grid-template-columns: repeat(2, 1fr); }
            .onboarding-actions { flex-direction: column; }
            .onboarding-actions .btn-primary { width: 100%; }
            .onboarding-notif { left: 15px; right: 15px; bottom: 15px; text-align: center; }
        }

        /* ==================== MES FRAMEWORKS ==================== */
        .btn-frameworks { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }

        /* Framework Library Modal */
        .framework-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 15px; }
        .framework-tab { padding: 10px 20px; border: none; background: #f0f0f0; border-radius: 8px; cursor: pointer; font-family: inherit; font-weight: 600; color: #666; transition: all 0.2s; }
        .framework-tab:hover { background: #e0e0e0; }
        .framework-tab.active { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }

        .frameworks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; max-height: 450px; overflow-y: auto; padding: 5px; }
        .framework-card { background: white; border: 2px solid #e8e8e8; border-radius: 15px; padding: 20px; cursor: pointer; transition: all 0.2s; position: relative; }
        .framework-card:hover { border-color: #11998e; transform: translateY(-3px); box-shadow: 0 8px 25px rgba(17,153,142,0.15); }
        .framework-card.selected { border-color: #11998e; background: linear-gradient(135deg, rgba(17,153,142,0.05), rgba(56,239,125,0.05)); }
        .framework-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .framework-card-icon { font-size: 2em; }
        .framework-card-type { font-size: 0.7em; padding: 4px 10px; border-radius: 20px; font-weight: 600; text-transform: uppercase; }
        .framework-card-title { font-size: 1.1em; font-weight: 700; color: #333; margin-bottom: 5px; }
        .framework-card-desc { font-size: 0.85em; color: #666; line-height: 1.4; margin-bottom: 12px; }
        .framework-card-steps { display: flex; flex-wrap: wrap; gap: 5px; }
        .framework-step-badge { background: #f0f0f0; color: #555; padding: 3px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 500; }
        .framework-card-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #e0e0e0; font-size: 0.8em; color: #888; }
        .framework-card-actions { display: flex; gap: 5px; }
        .framework-card-actions button { background: none; border: none; padding: 5px 8px; cursor: pointer; border-radius: 5px; transition: all 0.2s; font-size: 1em; }
        .framework-card-actions button:hover { background: #e0e0e0; }
        .framework-default-badge { position: absolute; top: 10px; right: 10px; background: #667eea; color: white; font-size: 0.65em; padding: 3px 8px; border-radius: 10px; font-weight: 600; }

        /* Framework Editor Modal */
        .framework-editor { padding: 10px 0; }
        .framework-editor-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .framework-editor-row.full { grid-template-columns: 1fr; }
        .framework-type-select { display: flex; flex-wrap: wrap; gap: 8px; }
        .framework-type-chip { padding: 8px 16px; border: 2px solid #e0e0e0; border-radius: 20px; cursor: pointer; font-size: 0.85em; transition: all 0.2s; background: white; }
        .framework-type-chip:hover { border-color: #11998e; }
        .framework-type-chip.active { background: linear-gradient(135deg, #11998e, #38ef7d); border-color: transparent; color: white; }

        /* Steps Editor */
        .steps-editor { margin-top: 20px; }
        .steps-list { margin-bottom: 15px; }
        .step-item { background: #f8f9fa; border: 2px solid #e8e8e8; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; gap: 15px; align-items: flex-start; cursor: grab; transition: all 0.2s; }
        .step-item:hover { border-color: #11998e; }
        .step-item.dragging { opacity: 0.5; border-style: dashed; }
        .step-item-drag { color: #999; font-size: 1.2em; cursor: grab; padding: 5px; }
        .step-item-number { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9em; flex-shrink: 0; }
        .step-item-content { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .step-item-name { border: none; background: white; padding: 10px; border-radius: 8px; font-family: inherit; font-weight: 600; font-size: 0.95em; width: 100%; }
        .step-item-name:focus { outline: 2px solid #11998e; }
        .step-item-desc { border: none; background: white; padding: 10px; border-radius: 8px; font-family: inherit; font-size: 0.85em; width: 100%; resize: none; min-height: 50px; }
        .step-item-desc:focus { outline: 2px solid #11998e; }
        .step-item-delete { background: none; border: none; color: #ff6b6b; cursor: pointer; padding: 8px; border-radius: 5px; font-size: 1.1em; transition: all 0.2s; }
        .step-item-delete:hover { background: #fff0f0; }
        .btn-add-step { width: 100%; padding: 15px; border: 2px dashed #d0d0d0; background: transparent; border-radius: 12px; cursor: pointer; font-family: inherit; font-weight: 600; color: #666; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-add-step:hover { border-color: #11998e; color: #11998e; background: rgba(17,153,142,0.05); }

        /* Framework color picker */
        .color-picker-row { display: flex; align-items: center; gap: 10px; }
        .color-picker-row input[type="color"] { width: 50px; height: 40px; border: none; border-radius: 8px; cursor: pointer; }
        .icon-picker { display: flex; flex-wrap: wrap; gap: 5px; }
        .icon-option { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; font-size: 1.3em; transition: all 0.2s; }
        .icon-option:hover { border-color: #11998e; }
        .icon-option.active { border-color: #11998e; background: rgba(17,153,142,0.1); }

        /* Framework Selection in Generation */
        .framework-selector { margin-top: 15px; padding: 15px; background: linear-gradient(135deg, rgba(17,153,142,0.05), rgba(56,239,125,0.05)); border: 2px solid #e8e8e8; border-radius: 15px; }
        .framework-selector-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .framework-selector-label { font-weight: 600; color: #333; display: flex; align-items: center; gap: 8px; }
        .btn-manage-frameworks { background: none; border: none; color: #11998e; font-size: 0.85em; cursor: pointer; font-weight: 600; }
        .btn-manage-frameworks:hover { text-decoration: underline; }
        .framework-quick-select { display: flex; flex-wrap: wrap; gap: 8px; }
        .framework-quick-chip { padding: 8px 14px; border: 2px solid #e0e0e0; background: white; border-radius: 10px; cursor: pointer; font-size: 0.85em; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .framework-quick-chip:hover { border-color: #11998e; }
        .framework-quick-chip.active { background: linear-gradient(135deg, #11998e, #38ef7d); border-color: transparent; color: white; }
        .framework-quick-chip.none { background: #f5f5f5; border-style: dashed; }
        .framework-quick-chip.none.active { background: #e0e0e0; border-style: solid; color: #333; }

        /* Framework Output Display */
        .framework-output { border-left: 4px solid #11998e; margin: 15px 0; }
        .framework-output-step { padding: 15px 20px; border-bottom: 1px solid #e8e8e8; }
        .framework-output-step:last-child { border-bottom: none; }
        .framework-output-step-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .framework-output-step-number { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.8em; font-weight: 700; }
        .framework-output-step-name { font-weight: 700; color: #11998e; font-size: 1em; }
        .framework-output-step-content { color: #333; line-height: 1.6; padding-left: 5px; }

        /* Templates Section */
        .templates-section { margin-top: 20px; padding-top: 20px; border-top: 2px dashed #e0e0e0; }
        .templates-section h4 { margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 10px; }
        .template-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .template-card { background: linear-gradient(135deg, #f8f9fa, #fff); border: 2px solid #e8e8e8; border-radius: 12px; padding: 15px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .template-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .template-card-icon { font-size: 2em; margin-bottom: 8px; }
        .template-card-name { font-weight: 600; font-size: 0.9em; color: #333; }
        .template-card-steps { font-size: 0.75em; color: #888; margin-top: 5px; }

        /* Empty State */
        .frameworks-empty { text-align: center; padding: 50px 20px; color: #888; }
        .frameworks-empty-icon { font-size: 4em; margin-bottom: 15px; opacity: 0.5; }
        .frameworks-empty h3 { color: #555; margin-bottom: 10px; }
        .frameworks-empty p { font-size: 0.95em; margin-bottom: 20px; }

        /* Template Library Enhanced */
        .template-library-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .template-library-actions { display: flex; gap: 8px; }
        .btn-import-fw { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 15px; border: none; border-radius: 8px; font-family: inherit; font-weight: 600; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .btn-import-fw:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.3); }
        .category-filters { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .category-chip { padding: 8px 16px; border: 2px solid #e0e0e0; background: white; border-radius: 20px; cursor: pointer; font-size: 0.85em; font-weight: 500; transition: all 0.2s; }
        .category-chip:hover { border-color: #667eea; }
        .category-chip.active { background: linear-gradient(135deg, #667eea, #764ba2); border-color: transparent; color: white; }
        .template-count { font-size: 0.75em; opacity: 0.8; margin-left: 5px; }
        .template-library-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .template-lib-card { background: white; border: 2px solid #e8e8e8; border-radius: 15px; padding: 18px; cursor: pointer; transition: all 0.2s; position: relative; }
        .template-lib-card:hover { border-color: #667eea; transform: translateY(-3px); box-shadow: 0 8px 25px rgba(102,126,234,0.15); }
        .template-lib-card.popular::before { content: '⭐ Populaire'; position: absolute; top: -8px; right: 15px; background: linear-gradient(135deg, #ffd700, #ffb347); color: #333; font-size: 0.7em; padding: 3px 10px; border-radius: 10px; font-weight: 700; }
        .template-lib-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .template-lib-icon { font-size: 1.8em; }
        .template-lib-category { font-size: 0.7em; padding: 4px 10px; border-radius: 15px; font-weight: 600; background: #f0f0f0; color: #666; }
        .template-lib-title { font-size: 1.05em; font-weight: 700; color: #333; margin-bottom: 5px; }
        .template-lib-desc { font-size: 0.85em; color: #666; line-height: 1.4; margin-bottom: 12px; }
        .template-lib-steps { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 12px; }
        .template-lib-step { background: #f8f8f8; color: #555; padding: 3px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 500; }
        .template-lib-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px dashed #e0e0e0; }
        .template-lib-meta { font-size: 0.8em; color: #888; }
        .template-lib-actions { display: flex; gap: 5px; }
        .template-lib-actions button { background: none; border: none; padding: 5px 8px; cursor: pointer; border-radius: 5px; transition: all 0.2s; font-size: 1em; }
        .template-lib-actions button:hover { background: #e0e0e0; }
        .btn-preview-template { background: #f0f0f0 !important; }
        .btn-use-template { background: linear-gradient(135deg, #11998e, #38ef7d) !important; color: white !important; font-size: 0.8em !important; padding: 6px 12px !important; border-radius: 8px !important; font-weight: 600 !important; }

        /* Preview Modal */
        .preview-modal { max-width: 650px; max-height: 90vh; overflow-y: auto; }
        .preview-header { padding: 25px 30px; border-radius: 20px 20px 0 0; color: white; }
        .preview-header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .preview-icon { font-size: 2.5em; }
        .preview-type { font-size: 0.8em; padding: 5px 12px; border-radius: 15px; background: rgba(255,255,255,0.2); }
        .preview-title { font-size: 1.5em; font-weight: 700; margin-bottom: 5px; }
        .preview-desc { opacity: 0.9; font-size: 0.95em; }
        .preview-content { padding: 25px 30px; }
        .preview-section { margin-bottom: 25px; }
        .preview-section h4 { color: #333; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-size: 1em; }
        .preview-steps-list { display: flex; flex-direction: column; gap: 10px; }
        .preview-step { display: flex; gap: 12px; padding: 12px 15px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #667eea; }
        .preview-step-number { background: linear-gradient(135deg, #667eea, #764ba2); color: white; min-width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85em; }
        .preview-step-content { flex: 1; }
        .preview-step-name { font-weight: 700; color: #333; margin-bottom: 3px; }
        .preview-step-desc { font-size: 0.85em; color: #666; line-height: 1.4; }
        .preview-instructions { background: linear-gradient(135deg, #fff9e6, #fff3cd); padding: 15px; border-radius: 10px; border-left: 4px solid #ffc107; }
        .preview-instructions p { margin: 0; color: #856404; font-size: 0.9em; line-height: 1.5; }
        .preview-actions { display: flex; gap: 10px; padding-top: 20px; border-top: 2px solid #e0e0e0; }
        .preview-actions .btn { flex: 1; padding: 14px; font-size: 1em; justify-content: center; }

        /* Import Modal */
        .import-modal { max-width: 550px; }
        .import-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .import-tab { flex: 1; padding: 12px; border: 2px solid #e0e0e0; background: white; border-radius: 10px; cursor: pointer; font-family: inherit; font-weight: 600; text-align: center; transition: all 0.2s; }
        .import-tab:hover { border-color: #667eea; }
        .import-tab.active { background: linear-gradient(135deg, #667eea, #764ba2); border-color: transparent; color: white; }
        .import-dropzone-fw { border: 3px dashed #d0d0d0; border-radius: 15px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; }
        .import-dropzone-fw:hover { border-color: #667eea; background: #f8f9ff; }
        .import-dropzone-fw.dragover { border-color: #667eea; background: #f0f4ff; }
        .import-dropzone-fw input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .import-dropzone-icon { font-size: 3em; margin-bottom: 10px; }
        .import-dropzone-text { color: #555; font-weight: 500; margin-bottom: 5px; }
        .import-dropzone-hint { color: #888; font-size: 0.85em; }
        .import-textarea { width: 100%; min-height: 200px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-family: 'Courier New', monospace; font-size: 0.85em; resize: vertical; }
        .import-textarea:focus { outline: none; border-color: #667eea; }
        .import-example { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; }
        .import-example h5 { margin: 0 0 10px; color: #333; font-size: 0.9em; }
        .import-example pre { margin: 0; font-size: 0.75em; color: #666; overflow-x: auto; white-space: pre-wrap; }
        .import-result { margin-top: 15px; padding: 15px; border-radius: 10px; }
        .import-result.success { background: #d4edda; color: #155724; }
        .import-result.error { background: #f8d7da; color: #721c24; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ==================== AUTH GUARD ====================
        // Vérifie que l'utilisateur est connecté et a un abonnement valide
        (async function checkAuth() {
            const SUPABASE_URL = 'https://pyxidmnckpnrargygwnf.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5eGlkbW5ja3BucmFyZ3lnd25mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMzc4NzIsImV4cCI6MjA3OTgxMzg3Mn0.atm-LVna_TQyPuACZgA4ngJzzgIfJQJIdnLd9lCpOns';

            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Récupérer la session
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                // Pas connecté → rediriger vers login
                window.location.href = 'login.html';
                return;
            }

            // Vérifier le plan de l'utilisateur
            const userEmail = session.user.email;
            const { data: userData } = await supabase
                .from('users')
                .select('plan, subscription_status, trial_ends_at')
                .eq('email', userEmail.toLowerCase())
                .single();

            // Calculer les jours restants du trial
            let trialDaysLeft = 0;
            let isActive = false;

            if (userData) {
                if (userData.subscription_status === 'active') {
                    isActive = true;
                } else if (userData.subscription_status === 'on_trial' && userData.trial_ends_at) {
                    const trialEnd = new Date(userData.trial_ends_at);
                    const now = new Date();
                    trialDaysLeft = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));
                    isActive = trialDaysLeft > 0;
                }

                // BETA TEST MODE - Désactivé jusqu'au 17/12/2024
                // if (!isActive) {
                //     // Trial ou abonnement expiré → rediriger vers upgrade
                //     window.location.href = 'upgrade.html';
                //     return;
                // }
            }

            // Stocker les infos utilisateur pour l'app
            window.currentUser = {
                id: session.user.id,
                email: session.user.email,
                name: session.user.user_metadata?.full_name || session.user.email.split('@')[0],
                plan: userData?.plan || 'trial',
                subscriptionStatus: userData?.subscription_status || 'on_trial',
                trialDaysLeft: trialDaysLeft
            };

            console.log('✅ Utilisateur connecté:', window.currentUser.email, '| Trial:', trialDaysLeft, 'jours restants');
        })();
    </script>
    <link rel="stylesheet" href="newsletter-styles.css">
    <link rel="stylesheet" href="visual-styles.css">
</head>
<body>
    <!-- Logo Base64 stocké -->
    <style>.logo-img { width: 40px; height: 40px; border-radius: 8px; object-fit: contain; }</style>
    <header class="header">
        <a href="landing-sos-storytelling.html" class="header-left" style="text-decoration: none; color: inherit;">
                        <img src="data:image/webp;base64,UklGRuQtAABXRUJQVlA4WAoAAAAwAAAAKwEAKwEASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZBTFBIoRAAAAHwh23bsjfR9h3Hed/xpAlNUzdc6m64u8NgY8iDuzuM4LAUd4cqWqwCM31ahuJOSyV1iTSppMkt17nv5x/plC7T+zoyjxIREyC/+v9X//83YFXnnNMtU3XOqeq/FdQ5p/lF5Z167bhrn4FDho8aPWb0yOFDB/fvs/vO23frUFFa6ETVORURbbOpiqhKQbc++5x22QNPjXt35pxv5i5eWVPf0NBQX7t6+cK5338xe/qb41945JZLzjxur77dS1VURURdW0udFlZ0G3LCDc9N/3b+svqmiPCbBUCitfc+8h6gT21sXLN0/nezJj94/Wl779GtQ7tCJ061jaQu0b7PIVe9/O26TNaD3nsP/tOwhdxCwHvvSR9lMy01P3zw2DUn7dmne5lT1TaOirqux98zbe5677FZkgz/iiQBDxLeI1Uz75O37ztv/x5JURHVtokmOvT9w0s/1LbAAwTDtkgChPdAat2qn6c/cv6Bu3QpS6prY6hq8YAzxy0H4EGSYVtma3hPApnq9x84/5Ddy5yqaBtBNa/bHybPa/YAwJAjSQIgPDJ1P7x390k7l+Q7Ufupqxx521frIg+SIeeSpPc+1bj0w7tP6FeVULWcqut+ykurAI/AkKNJ0gNAZuGkS/etcipqNC3c4YpP6iOQDLmeBIDmpbPHHterNKFqLy3Y47ofUvAgQyyShEdm47wnT969TFXUUqq7/fnHDEAyxCZJAkDLdy+dN7RYVdVImrfDVd9sAsgQuwTg/brq968cWpXv1ELa/rTZHiAZYpmE9/B1b50/tCqporbRxJjX13uCDLFNEoDPVH94x57FTtUwyV43VWdAhrgnAe+bV0y7bHCHPGcUTRw0PQOQwYIM8IBf+epFo8vUIKodb1wEkAxGJAkAqcVTLtypyKmaQhP9xzV7ksGUJOB9U/Ujh/QudGoHLTz684gkgzlJAH7d7LsOr3JW0PKLVkZkMCoJ+PSqT67PM0LlX9cDdgmBJLKNf07YoOqZJpDBsiTWXt9OLKidnm8GGSxL+robS9UC2vGVFMhgWRJrbyoUE3Z8qRlksCzp668pFQtq+ydbQAbLkqi9vlgsqO3u2ODJYFkSay8rFgtq8QWNIINlSdRcXyImdEesBhksS2LtpYViQu33eUTbkFh7VamY0HV9NQ0Gy5JYfX6p2DB5cQY0DYm11xSoDXT0fJDBsCRWnV0iRmz/WpYMhiWx5oIiMWLy1EbPYFjS115eKEbUbtNAy5B+7Q3FYsYz0mCwK4nG20rEilo6lTQM6RtvLlUzuONqwGBWEnU3lalYUcvGZw1Dou6GQhU7DFzkGaxKYs25JWLIvLPTMAuJVZcWqSG0/SSPYFQSNecWiCmH1pNGIVl7XrHY8qosgk1JrjqrWGxZ9B6MQnLNmYViSx24wNMkJJefWqTW+GODTUisOCtfxZiFD0cwCAmsOLFQrKldp3oGc5LwPx9fqPboO98gJKKfDsxTscfBTTAHieiLMXkq9sy7AAzGJJH9cmRSxZ5a/KiHMUhkZo1IqFi03QxrkIj+sYdTMWmnuaQpSGSmDnYqJtWhdQyWJJmZtauq2NQdvwGWIJF5faeEWNVd2WwJEs1v7qRiVr0vbQgSqXFdxbCJF7M0A4mWF3qIYbV0BgyBlond1TTdvrADmX27p4plXf+53gzA3P5iWze6OrIC4Z8tU9voIau8HVK/S4pxT2qwAum/2V2t84cmBCMgdU+BGDdxadoIJOYNUusU3BrZgETqWifG1ZL7SQuQ4OQuap6yR2EBEs1T+yTEuq7iaQOQRP3Ybir2qXzZxx1JYMWZJSoGqhofdySQ/uqoArGw6/havJGEX/nswITYqNObcUbSRzVP7FWuYqTOb8cKiS333teN27fMiZVdlynxQJIAQCDTUFNTU1tXX7d6WfW3E09tp2LnmCAJIEptWrfy47Gnjh48ZMjQYcOHDezXZ+eqhFjadX4rJjYumDnugetOG1CR72RLVcVWHSfHAImllw7uVKiqKqZ3HcbHQEDLn0uciv1d+5digH7pPgmVtkD5E4gBLhyR71Ttp0V3+NwXmF3wzEk7l4paT/TsTWCuIwmkv33gqG4JVbXdYat9zgsMBLyv+fTeA6sKnBrO9ZsbA61JAumG2Tfv2yNf1Wpa/hHiIQSSAKK6j+48tIOKqMXEPZJBTLQmAZ9eOfuOA7sUqVrs7KY4CYEkPKKm2Tft1z1PzSWDa8A4CYEkQES1s+89oFRFbVU5B4iX1iThfcvKmdeP6ZLnDKUlj/oYCiGQhCca3r9waJlTK0nybDCWQmAgAN+ycMpFOxY4VRPpoZvAeGpNEt5vmP/EcTsUOxMNW+ljLAQyAMSmOfccXqkG6jnTkzHWmgB8dtXfbx5ZnqdqGim8L4O4C4EkPFJ1b587sMKpZfTQlT7+QggMAHx24YSzuoqoXdr/HbBACIEEvW/47Jo9Sp0aRfTKLGiDEEgCiBbdOapUjSK7LLBDCIGBQLTk1QOLVC2ixbdnQTuEQJI+u+blA8sTBhEZVO1JQ4QQSABrHx6RsEjhfc0wRiBJRPP+0jNpD935a8AYIQQSvmXO6RVqDZHzsqA5Aklg/ZN7JKyhvWZEpDlCCCTSX51erLaQxAlrYRQCtbd0cbaQdi+kQYOEQBKpSTsbQ/t+B9IiIZA+87dRSVskz6j1pEkCCcw9PKGGECm+cA1IkwSS0eKzC5wlpOjcJSRNEgIZrT6/VC0h+afVeNIq9I3n5asltOjWRk+aJJCMVp5dpIYQLbtvPUiThEBGq09NqCFEyy+eF4E0Cv3CQ8WW+f0mpBlokRDI7FcjE6ZQ13NKCqRRGE3dwVlCRHd4PQ2SBgkk/cMJW4h2H1sfgTRIIH3tBfm2ECk+4ysPkPYIpJ8/LGEMdf0ebvSepDkCGY2vUluIuPLj320ESHMEounihDVEtfKSeVmANAf9d33UGiJaMPD+pRmQtEUg0mNL1BwiWjT0hRUeYCAtQb9ktDOIqJYc8uQKECBphkDi8WI1iIgkKoZc//nayIOkFQKxam+jiIqr/O3kBSkPkKQRMk8VGEVE1ZUMPOeN+ggASQME+vlD1CqtNb/D8Ms/WJyyAlquLVDDiKho8agHGz0AMDDm6Gf2tE1rV/Hchkw2nYUnGWeBaD7GPqJdLnjosTsen7Pak4yzADyZZx8RFRHX+cQvPECSMfZTdwttVvNO+LYhBQ8yrgIaz1AriSR2Oe7e2Wsy8UVkn82zk6hLdD/wiVRsBeLzns5MmijvvNtJkzLxFXzN/mqlZO9jHp6+KEPGFxFdmq8m0vZXzGmABxBn9BM6OAsldn91vQdAMsQ4MX9HMbDu+G7Gkwxxj9Q+Fip7MAWSIf5wkap1tODsBpDBgMCjYl3NO2whyGACTs8zjiYP/iEigwnJuT3VNJrc+1tPM/jlY5xpEiO/zYIMVqg/zTb9ZmdJBiv6jVeoZTpP8iCDGZG6w9klucOLLSCDHelfKFSjJHuc/1maZLAEXy+zhm6u5KQZzaA5plSYwu1wy4hC5zR/l7ErATLYkpjawRJa9cSmRTccdcIRF36cBslgjg87O0Mkbm/2yG5s3pgBSQZ7fNTFEAXnr/HcwmBPYnpHtYLmH7Pck8GwxPuVZnCjq0GGbZskAZBkbuKUCisk+swCGbZpkgDTm1o8ADIXYWKJEbTHtCwYtrlNX42/+9pbJy6KAJDMNcg+nm+EqmdS4DaHFefv2i6prmLoZR9uyHqQuab5dhULavkDTSDDNo70wwWqIqIuv8MRzy7IAmRO8RsuMYGWXrMOZNjmNp7s5J9r/pixKz1A5g76ulOdAbTonHqSYVsn64brFoi4sjFPr4lA5pDlexlAkyfXgAw5YH4v2XJ1JQe81QCSuQLzd9LYU7fnzxEZcgC+rPwFIqqVv5tHT+YIft7OAIM+y4IhB8JPb/eLRDRv1OuNDMwJ4BQnca893/VgjnixVH+ZiJZfuxY5Ag9L3Luu41MgQ07AnUVbRbRqKnPFparx5qoeSJMMOZG4IE+2TrvXcwRxhMS7Ft6YARlyIpE61m2l0km5gazrH3P5F9V5MuSKlcNlK3Wa4XMC/CfdNNaSRy/xZMgV/utddKtocv8VuYF4qiLWdP8fPXPJjG5ua6jrOQXMBUT2vDyJ8eSgf0RkyJn0s3pvDVcwYHIKDLkQtQdojLmd3gcYcghW7JPQVtpaRNRp8R7n/+g9cwL9Nzu5+NKKcR7MKcS7B/eqKPhniXa997/45R9TIBlyIOHfKNbY0rJ7N3oy5FIys3rhtzPfHvfMU08++eyEqV8uWrU+8iBDbvRN1zqJ7ZJr1nuG3ErCkyQ2T9J7kAy5kX75YI2t5IUNnrkmMPAXB4acCXxQLDGtBacuBRkMTUQXJWJKk/tWgwyGJrF0oMaUG/SFJ4Ot/LPbxVXv6VlYy9efoBLPnV9tARlMDT+ne0x1fHQTyGBqovm6hMSxlv21GWQwNYn5O2scueJL14EM5rqhII40eWotyGBrEt/1dRJH+y7wtBda/lygMeQGf5EFg7EJfLGjSvzqHtMypME2ne8kfl2XCSAZjE3i7Y4aP9r+0RYwWJv0S/ZLSOxqyeVNnuYi0XxvocTwAWs8DQY/rYvGUac710YgbUVixf4Sz0Xn/AiQNBSJ9ZcUaTxpYthLTR6kmUi0PFUusZ2ovHR+BNJMiKb2lBhXt/+EDQBJC5H8ekgizkRch0uXZWEiEj8fkicxr4V7Ta7zJK1DovqkpMS+atnp3wAgTUNi2W/yxYKaHPDg0ixI2oVE9R8KxYguufeUTQBoFJJYcnpC7Oiq/uNrAiQNQgLVRxaIJbVgpwu+TnuQ5iCR/frwfLGlig58alUEkLYgkZo6xIk9tXS/Rxu9J2kHEtj4ZPeEWFRdxZHTGwDSDsiuuL5SxagqVWe9tR4AaQASPpp5aKEYVhOdfvtxUwSScUfC19y3q1PLiGiy6+Wz6gGSMUYSaJl5bImKfbXbqTNS8CDjigT8sut7q4qFNdn993+ry4JkHJH02dpnRxSpWFldxfGT6z0AMl5IAqh764hiVbG02+7wZ2o8PAJjhASwceKRlapi7cR2Q674W23kCTIeSPhU9fOHVyZUDK6iHU55eWEEAiRzGkkCSH117+h8UTG6qisfcvG0tWl4kMxdJLxP171z5s6FqmJ51fz2e/1l1rIWDwDMQSQBH635+PZRlXkqbcKq/a5+rToLAiDJ3EESAFq+fvDoLk5U2oiqyY4DTh372ZqNGXhPgDmBJKLsyjdvOHznUlFpU6q6/O1GXfz0fy5ojLwHAYAM3BZIEq09mqon7Vucp6rSFlVNdhx85FVPzVyeBUB678HW/ypsDe9Bgs1z37jjlOHlKiptV3VSUNFtj4MvvP+tLxavatiUJbz3IAmAm/1FJAkQJLz3yDTVL//+/fvP3HunjiVOVdq66pyIqrbbdZ8zb37m3dnfzV/R2BLBtwZAEltIEoD33sOnGpb8MHvKI9efMqLKiYo6lbayqog61byyrrv0H7Hf0Wded8cTb3w45/vFNeub0+lMJpNJZzKZdDq1oWbRD59Ne3nsbRccv9+Q3bqWJdQ5abOrOieieYUl7So7du7Su8/gkXsfcOiRxxx3/HFHHXbQfmOG7NGra+eqirLifCfqnMq/BdU5pyqb1S2V1qrOOfnV/7/6/3+vBQBWUDggTBsAALB/AJ0BKiwBLAE+USSPRSOiIRQqfRg4BQSxt3C4jxLkrzgBEVHf/uetHFR7LzqeQ+4P5z9/4lqwPPQHX8xn9bP9t1mvMV+yn7Ye8t6X/7l6gH9H/0vpgeyL+3vsAfsZ6cvsa/tt+5nwE/yP+8//DrAPQA7KX/Afiz7yfIL9N4s8ab9x/sAwZ/L9cnQH2/7x/e8ZrfCz6eP2nm34gHBXfYP+b7AH5v9ZL/N/+X+c9LX1T7B38u/uHptev39wfYn/V8wSnJTkpyU5KclOSnJTjslZD2pc18SEnkaE7DSJyVseG01aabs7WIAZZ6TUnOH68eak5SBVAz0Req6OWU+sVpinOM4GZU3hd6Ky+nJTjLvbISJ2rhQyHGgHevmnHycjYTxjEjp6x3IhuWaDMT87kAgc/vzAShfQyL8Sut88b/wwoDMMX4HTupM7BsAFSpR6bZGI2eAZtMVOEmU4z8nVeGcqvBDp5Db4bi5rcQWLTVjfoHW3ZHu05ZAa2SIS1MGoRVX9h5cKrIs3wNOWVFOL44aIMe2DvAKJzMotzpk+oi+CatNWPXZOFmvOjikmLZR37VFvyJNqpjDb32k8jfaQPdGv7+x4vLl+tMnLutO88Vd9PefJCoq1VPe0Ri2IkYcuYKldHmfpT6p7zFzBQEUCV3fi2PDY+adeEFzRtUeyqb3HB5xTLxX2fhd8c5IFwbOlhufSFkMCFH3ub8P78AWFcP1fc+1Jx9ejZnGv3TsnLoY2/dlQkEK9XF0fVjuMIAwlkQi/L18kJ4dVd19ia6Au9+CIHZxXae2yRRLzA5CfYeglEEXTAURB8felEsU8VhP7eTFXVrDZJMxlGAug+rHRB4z8vDCXrJdhLVdJQ+bA+kefZHC42PHdr+eBg8VaR0MgZXKUe9QsKKIzR9BHpUQFZatyBJL4h1iQZkfR4nbJftBS0tfH3lhaK4lTDdq4bQnHeSBU2T1QyEyDQR7bNm/NFSI1MRjLqj3dmpeG6D83CAtzqDOGReeMp4REHreQxLFbqPBMGsb/JIHppk0AAfGN3lWrhq9DwTbLrNniy4/+AsM05rRCigTNT0jNWt+spyNHdkl5RvSShoFOrkFq7WdZPL2KFvYuWhnvIwtRb5dCUq6XXbQ/HYBRCO29ptdJjO/dmQ3c7sXfMvJN01t2MQuni+f3APyJH93O2omc6wHZXav0Qed8ynOLz8eEMkwZD2qk9gO9qWkk0YbbJaDE90MoKYoFPg4MklnDa1qpNnKc+DvY1wsBaXT61/RyLS1f8mBKl34tjwygzSbwoNUZVyyKv94/4QrxPjXMLvZ1vBdGcWb/no1QscR26U/JRvl0oGW/FseGzMvU3lFONpq01aatNWmrTVpq0qAA/vskQAAGP/3mwZNkrOm9n6HAV1zxlyeg2PwJ7/tfs/+ozvXuzyFOttP7vZkhklSYpoc2BCkaGzucQaz1/QRBqmTefOdqZUTjv2kvdIHEnnmwdRnEKpNs9ZH608raM4vuL8mz0ZQk4b1OVMeoY2zl2SRuZabgEmxHsV9qdVlI4kMTWapjiEBPKE3UnnIe4vXghUE2P/yGhqEByRLIfh03TJktH3FB9+NMrijpr9RBrKp6NfAIgBACMbfra8gX/tSZfmKLaRT+bHw3sXRvYcQMTa3tXyc/DxjQ/3xTaE19pQIWFVgct2TY+/LoPqaBdbD5JJDW6iqS6SRO24KSOHCAYUqLEb9SZ7q4aRoiFBow2l4fpPi17/1G4MIu1fepo+XSt1clTUKQwkEz5jbMu0e8tEZxt6zxUIQU04pHNpamgX56zVZ/FSpfwjsmm9VIPycRxSf7PSAi87646MOqdfJgksnr1eObFBfyG7FuhpLtdbLC1gxOicCwBob1KGe+xkIcMRvshEH3mOuGf6bI+psYhMiqLkdd2R4Rzadexop4KgY9ZO0+1T6OYaoRPUlIZ4x3emhnWhQURcZnOW9y+r3HcZVEU7LqA2yWLRdctn+wmLsEdM65qVhDP0AkfLqvrC/FbmxYitGIRRM81eHD4KMLLezpDuj3a2rWMD9TuH/t7dMhC336R39E5iZc+efj0QeH/LrSdfCwahjCz+QM4iOd1ZGlCDvVaP5l++SG6+7WSBtrLEzSnuj3X82WXPheUd4LuAv1V/z8G8Ikw5Wf7cBp2s2jaX2fZ5yNpkKDY3sX8s9VH2lC2La0FegD6Vj6Cv5bVryQfMIBoXUw/zTF/mrxv/TbubsyRzTKiYdVOmAXNGVJU2HViT/86/n6sZzI0MaCWNGSATAOp38aaYctBhc2/tNZ1t/dbNOb4yp+h/1dfb7JTeWXZXfEPN03Xhj+EDlwa1rmki/VEcWVji9d/y5ABr4e3YXfMpEFsl8Mlbbnj8LW7B80VILWRxeiikQwXWPiD67ZYY1b8CKHuN4wuJLvDXs0CJ+PYruXJmxy2lEizg+QgjCgUUzUTQXkFZJ9nYf4OhSkTu2Nmm4nMK0tHJh10DnIvf3BOdtwaAI7PcJ2Ls8+G3Qh1o5Atiia5IVl9xERyraILLkmsZcufidwwhvDTfoTfOi2kn20RZ2rkc43SPcnjT9EHW5uYENToCkeiBzU+Ruxhp+VuVdpCnltbUVKLryj6+51Q9NBgvb9LbtHgDEn5L/ErNLxS8LHwqnW1z6p/MVP/tgo3DIt9Sj28sT7VXoH2QvKVNvl43cc7w720wtu+AHBlaKpDOic0sL0TnrEjFZI2bcGVv6TiHdQfpGICkjwy3RkdAVi0jicT3du42UV+6Wv8L+wjUKCRq0OL+hHeazspF6V1e87Whzg4lcUTpyJaB426RRDyEYrJ4qESpeSrwnQOVlIWqQ+uhRvPKexzy9Bg20D5fKxl/LHRKpRa7uQQ7SZ4+7KyRUq9JJNDvQHpRooimmNuvn/caldq3j/HdM5Hu/E0FDl7UWLp/WzFO3ENlRo+NDhky5n+pEFpfarr7xae0rPJIJ8Y1m4fbGwiXCeDYP0Cj5gYYasLyugYp4fkcQLDySXZ+1ddmJe+TgseWhdR2GsWnq3fARZi2jXQ4/t6MOeVNQrxRvNpwpZ+9HYNdeL187Jt30x8RnDsbygfwAk8ZQ6p2HGB4ukvAwqsle9eYVmpDFEfRwwYC+wO21nhcRDUUx3BctCGtJ9dRMiufl9rMRy3vjfTgBEdMUi1bVyWMQUP3m9QHVt30fq/VHATBhgiDGHKLLvv181mBPPt17P7HfR9P5RSisJU8WjP0r3SBfWqsRy8+cSFY+8n+iL700NfyG4tlhOvjQumSkn/V+sdi835/PkeP1gqqYOmsqy8rcfVDg9hIwoUvXqU3I/epxmZ6zO94LUuCUiDLiHCVVL97TpK1WpA6/rpfotn4Nha+hUqKpVe1q8Z0QJEJvTPAXTp5ywRKYzoL6FI34YDalJz9wlOKtYoRifYyBc5T58YLGGfTIh/h6mYkrCkDrhBxRqWdXZ0d7TnDqpniYcBqAa3Hop7DHc9384ygNyNc7DeX0cqJGcGOyNEngWfohDVw78Ikc6YHFyNVZHIKkUqoVPsuYU91/s2X8FWgLqiZCP3aaxUMaVpkHySfx/mBaoI/VMI1D+WdeysuZ9xaO5NVxrnGKHqhvjY4vYwg2/xL/B+rfwGQgBdROR7ZHLri9oekHMcNRUC8ewABCAV6vGy8xQZSp0KPieNFSY3W889djsLmNZm0vt50Kqy3Ixke4nK0zlzX2+8+oFpd+uwatuCqAgiBxDM8ht8meokE5tRMi780ukanKswNiDFd8X7qcpLGQTxP1k1OxUJmrK4sLK+H0pZqlT1LVcLQLXaEjL66BX+Kj6AlRmyZ0s+w2rv9BrNia95GzE/L5uXa35PPieHjL0OhhJrYA35iksOBEDCMFzQlnujpgeR6+53euIq57+umLd+iM65kxnEna05g58T2fkwbU4LL7tHpW55qyty+qfr13WkP+4++FWYZiXRgsa+U2uotm/WPnuMCGS/7xKoVroxWR18AEjrBZxDzFzkbRIF1izxuyvdrd6l37oVtbaklIy+EQQaqc0aFE8+JYn51nB5CJkD+Ewl8UOMv+4PWewt6teKPZOtEvAGi72c9yZ5d42eqdeSNrJfgBhXu33h1qruhDPAT3HJCcqaQCEMA/F1S5ZT5hk6XUTcwb9BuE5dEnW5azcEuLRgbteipMiFt3Ke/WPlxlAIcOW2y/di5aB3NObabG8JpQCBDy29OjQd+objVuq5AEX3URPJb+n7KslLuKRC7BVsC2j1NGYehON9grUD2+RHa8pnqvH3HdVCqrXDnhfmPPLNJLaDVNTu0cigSRm5JbsBk3Gt6O+4II6qsHO/B39gyxwOq7SSGgVhsWdKp6FLCcjsSR22prPinqzUr1dCgvvjOrH2TnzeI+pGjcrM4T0yfv6EnUzyuoexPIB8qQZ61WEAAGr68CJ+LumvstMvfIxedtiz462f6GfD0Eh0ffG5PJtnTMFRXTsU4Z4BkwUNIREZjR9GCy5ioqJuFdbB8Cw27Jt8mCcQ84oKsKCOGhMsz+TcehUAOVDVi6xh2Y+V6tlATab/y4ROCFV97gNmyAa6Bx0ysaa0GAebWnSqBgTSnKa+Sn77AzKNGBoQrO5JvfQquRcEpUtoRZ37DojmJl85nqY3ylnypaY5WYpOGXrETZUrWqKZKlgyo/d0kbs654i9x0RTRGJ5PtSG7KrhI2YfJ4EQCumnVJYec5SHIH4D2DZ+O4rbhcNHK3SpjyDAEyyAJKE8LK4Vizm3NBGECk9OWYbM/MwGe59gRGGbPLapjfc33QYi520HbYGNgtO2TU2rnAdRGDAEpfkwNvkoo3DXPEF64GkZo5STkyeXByXsC7R1+45WCWjdFDoc1BjObT4WBvnfc3R/kYjVTzBLS6nqj6YP/EXzsyguKpMjVedt/6ctXNYtsimZpX1/q4Oo6UqZEoRuxnqsrTguNsQBejM0vf2HUhuHN2pcj6vFn1EF+vTQDLMgbQ7tyq8fbUCIvVBKgy8LLcVJqc8FrXlS5rVwgsitHB783rmHnMn2K5xSUxqJCY8ShnLu63jip7AnnwOt3ote/gUi1UYseB5HQKoj6GnKuwNbJQtHNI3B1/cIZzkUaTKkJh1JQxGLPdRfBFWEMLk1z77S591rFRQuG0Crwsnvfgs8CVZraVh63+4AlGWmwPYKKyVArGNyooHNqle+nB9vZxYVmYiF7Tvp6sCp5HWgFebP8HA/RBLUCoj11XeY8x0LCRgMiTHkK5CdkkLp+waQAjNwr4T+4kjEq+yklQF68EbOT2hDE9cmUAAH3+nQ9Vji3Ksl4fJNWWW7HFouS3EPzITj7+/POzmDVpD9QkRt5Bt6QAS6uIaxE3ibE7wVhreae8tS+US6hayeQotWO/4BNYWlu9AsaWMvX5N/MhNtNpVOY2XvG42YfoL5YqT+30EDuDTSs7XfA9BkYm1g/1S/tg96m1k/x6nEBxzsF9aX6c97gBTRmOgVDVaqZ7kZG5iwJLAP4Kuyx2zfz/FWzUUt9fefEDXjg71Y6wX0pRzfcaQET3W6AQjP2XGxFkchMd+fg244yDhxnuT8Asx2KMGvrebIf0qVNvFBpdKgP55CJldXI/lmWDEQElV5jo3dRkMn1gC9/OmODd5JXFLjA/GYAxOPxJJGKcZrYbnfDQtna2oM0XYe36c/GiVp4UJ3jruOgIZKN6JzfsSvi4ibWW3+L+55oLh0qcR4nFYI4CKMWP/gglyirtQgbt2cCMIDuF0xSGnFC6VNAxRh7Wk2YR/Z6DU3CzjDkB1hnkgOduxihF0sjbiqHSrO6V/9c/AWiyFDDKp/wa/bfK0bOIhkW0yn02UMrSdJgqpyWcd+9bhqOi/C//HuBAUHx6CFFBY8PZFTajGeH1KiEyWNdUf/Mj+sXvTa5nF2q+x6mZSA4YNuePWbSY2TH9oNnQq74LoMM+zQVQd8Hk5bIsw8YlGr4UM/umz/fweZKYS/a02+q24pijdQybw7JDL56ReZTbONl05+RYINTWul0jqOzynK1uGXoIQBNusDcGrjFAj8E4ayY2J1BBUqWfeFptJYdobSdFekdNA+IL2qGBmJ9NJeS7oRQGEFsAP6kiBskjAuOxP7UIw/7ynlPUWBSvUUGY/hQHLTYC6GxYxk/P9edp5TSXk9AhqrdaRmXEDadUeYiXrRwQPIzuiuuUWBJhNkID7Z3t7+l81TyPkjHKLTfBHAxsB0/cATsfASnSv+P7vXI0lTebWQoVbeJTvJCEN3Tvd9WFJBDxCp9/z3+7lJQCvkWq6JJyD1mN6EokfIehlc8NfWOAAY7Pd1Vtmly62VJF65IZY1swLb8NAqYRLdVcJ0VqKonAQmEtCxZykvVdY+Q1VZJr1zPPH2va4SNyedlY/0vMfD75AA3p862b5jdoN66s298IUC5WUwUXJ8WR3bHn+3nWrVWG8MWkN/X//lVf1UzPKyTVrqZn2b+gVUp9J5GEH4+NUEYvSCChNsdZNYgiYYhCWIaMMMeaSecibLNfgg6su9hpLtJGjYT/mvCvZjz5oui/D+SpuQgAWkVT/vEpCN0UF7HZvt5JuwrWNjxRcAsqZYNmsnt2nQfnbeK/gERYNEUoZ0nRMasFimUYGtyK611OFrAnKTpjJHjnZV4Bo3XDOONw3WOcN1ttua5o3m1KALxIZhVh2NV8YKbh65y6LECiMC+49IRmNwa+uAPHHX4zWVmukSRJ8Ra1VA1+Jv6fWRtfTTBKDo3MHl4jqWrRoU/9euh2PdeRsbWFP+aQk2IcZhDkMkZbgW+KpgyxQmCoFOJGfSlWT9jkT7kjf+T3LY1Zv5KSrUYnin50eiF+jwcfwUAx/j6yoRUXbAc55q8akM5UkgGY9/anWrxR+lfxCF8B8ea6Qc9V0rjb6McCiPtKAKyA4xY20pfY6JNONNfPzJ9mM0ETssw1j0ayKVanDmGCYAXZ8JfZMuWgnNXvrUtTfbTYkpI3kJnoqhwaUfFHehmEMtvhP7sgYMpXJMIZpkyxvpchtWUgEjLd6Cmde/WKwvGmdZ8j6bLcxkgC6L224gpy9nJZUNuJfGDywmBdZW/Etr0xbYYFc2ZRN5rCcs248gUgBOKi+0usfYrb/sawUuntDXxJqY+5f5fenWuikUqAh6wIi82wsnqZU7SOdyoBNhOc9VCEweuaU66HZsQb0PI9RJat7uCUHJXV5eMdnceeGB+d7ULxMvOKcMX1YExUZsqT8F5LLhzJuXl6r6NbT3hJUjceW9/R4BTaWuWoAT0v+nX3HVMZJvzQnCwpxLbj9XEnA2B78n8xNe7zvjbpV84uKoJ73mbezauXyPgIwxHmTaQ9eTj5Xmq6kj1od14+3qw8KhErbIV0hJsmTaIul0kLMXfznGQIJDWKMsOaxHtOwDYJoCRlhJne7v1XJY0eKyB7HoqNqnNZnJJzP4PESdDwUAb0KpRHtXVGUDTUn+YzKLehIoSyhtA2LbI97507gaZcIk809WZlHrcmK5syY0orFT+Ag+T4u+/eeM4mdFaVvbA8UIPqqnTqRR4EIqoYZSqnh3MxulaaLJV7/X31RhG3lmnxKjeaCfjo+/mdPdRvsD660RIKBEqaLyRu1ckyFildnQfWHhcSfB2FXxnqECTRdJ2IKz6PTKjN7nbxVtvRJqsoWDHisK1OqsNAr/oC0+npGpU6V3wkZjefWPt4rHoh6PmKiNALriPZoqzpOWa0osOj/UupNSpI3qU0J65hWyBmM0XYwftxi4+v7VcY/kjCbDixMbM2pUjKrRejwDymZUGv8n4iWOT/QCWMj4HTQtrNEJANac3aJK8kvGVe1qSyfJ35RagsdF6RjZosw8jVV9Q0f2gMd1iXEitKSaJs1Wij/cmhmpblGeiM6L9rUz7wgfkizeDypMd2jOjaAXWw2auxew42i9HL30+l2IFZ8+7IzFPNwaVjL+pDnN6R25/4lu6Ne5IbndVnWShvTPRE865Sva16/6BF9nCGBEVBGOzCvCQ0ptRR8y8NoBg2MMKWw0wrM/+47yVHg2+Aj3qJ5YIg2EJJSj38ySP/ZodxwzkpMOntcwd73ihnA8vM8hRB4kMTb8Xa5Hi5riDPzyuFaCmMXnN1q3oXOs+PPi9FbzpG3vVPg3hIQzkE9Nuju4LYawxZnZlgPzRCUMyWXl0ti61izDouuwMyeS7toKD8Qe68DbRW+8UzbZo/Imt4pkt0gEb2wehJ9nv3WdB7qBh2RO9wE3WrNLZTxH9Ic3zG3isBm0v47TewAxGWJFuFxMZnp7niJRKQIGDPw2IzDo4cKNjHRsds1G+t5FtLnPjuSCzInxLmjf8u+d7px2kY7uRkQKA7TMO72fzPKQ2+ZqfbrK9JLdZ1jBy/INMtjyzaPc0X60Wdqe1yoiNDFkybeeEHGaQpex8j1bnQ29I1SqvHkdQYmqgQArS4XIj4BGw5thwev2n3x6LsimgXHUy74Q+K6IVP+oF36amjEhj3SthrnPufQuVaB7apzb/JQkSBn4krHHxRjB+emzWM5Ri8VcQcmctkM5KRRVmws6Rgg/cuwGmXBXyzjl4z5+/Q0aLZWnUg8IVRtNYecVqjqU4F6MpgioU7RGH8EGAhgvgOG7ToRvNk9WehVKAWSH5tKxonjHlQU7CQILYYl0WHyCDPqd7ie7DttlVUOKsHVnS4Ug6JdQ4jnG+yRo1l9ybT0nRqT+OIyvDqYGDGkvPrjluLNDP7Ja7civCytoNlSzSPZ/kQY+CUX9vTMqyIT2K4KcyuzpwWezQll6qxRFJCt35wbzbFTj8IjuIoF8t3c2Gk1RqvSs+YHKbdjZUS7yRaaA03mLLhVfAx0dmmSevdGkem3iAAEUm/Y3Ru87e2PJ/RZP4hszyLLGWOBAfK7TFIFzmYV0ANidHU+1Wdgez8muRHc2RYLmsCk9O7QJNz+0xxKFDzlKGHfwrVi0WSJVpNNSX3u6SlPRMqBJDCKqrSQP+wkr0nGaMMYVgk6oPPLu0tRtco03FJgsAsmcwkfEs4oKZrScrA+hJ5tUUFJza1Pbxk93c+obU/1T+Fd53s3ULfAjxIxT1NtfNCjluFoGpJVQrfr3JOfdujQ/wT2Ig+YE7LdJFCz21adtH7KVASLat3v4vwj9biwqLx3v0BFwBIQvHLC0doxsiCrk3EJ6woVhRdOC5e4pYhh5lHfj2jA2rE/vjt8jXVTB+2Tk6kyhkohTlXd8nz0nM+2D4iTOqvpryfRr3YoaX/QulZ7oiPG26anXt/JPFjmPaH9ELNsp7hm8W5N6DwJQpPwODi38a32F///ywD//K3P//yqiyH0AAAAAAAAAAAAAAA=" alt="Logo" class="logo-img">
            <span class="header-title">SOS Storytelling</span>
        </a>
        <div class="header-buttons">
            <button class="btn btn-trends" onclick="showTrends()">📈 TRENDS</button>
            <button class="btn btn-newsletter" onclick="showNewsletterModal()">📧 Newsletters</button>
            <button class="btn btn-posts" onclick="openMesPostsPopup()">📌 Mes Posts</button>
            <button class="btn btn-stats" onclick="showStatsModal()">🏆 Stats</button>
            <button class="btn btn-planning" onclick="showPlanningModal()">🗓️ Planning IA</button>
            <button class="btn btn-favorites" onclick="showFavorites()">❤️ Favoris</button>
            <button class="btn btn-voice" onclick="showVoiceModal()">🎤 Ma Voix</button>
            <button class="btn btn-frameworks" onclick="FrameworkSystem.showLibrary()">📐 Mes Frameworks</button>
            <button id="profileBtn" class="btn btn-profile" onclick="Onboarding.forceShow()">✏️ Mon profil</button>
        </div>
    </header>

    <div class="main-container">
        <div class="intro-section">
            <h1 class="intro-title">✨ Crée du contenu impactant en quelques clics</h1>
            <p class="intro-subtitle">Choisis ta structure narrative, ton format, et laisse Tithot faire la magie !</p>
            <div id="pillarSuggestion" class="pillar-suggestion" style="display: none;">
                💡 Suggestion du jour : <strong id="suggestedPillar"></strong>
            </div>
        </div>

        <div class="content-layout">
            <div class="panel config-panel" id="configPanel">
                <h2 class="panel-title">⚙️ Configuration</h2>

                <div id="memoryIndicator" class="memory-indicator" style="display: none;">
                    🧠 <span id="memoryText"></span>
                </div>

                <div class="config-section" id="structureSection">
                    <label class="config-label">📖 Structure narrative</label>
                    <div class="structure-grid" id="structureGrid">
                        <div class="structure-card active" data-structure="aida"><div class="structure-icon">🎯</div><div class="structure-name">AIDA</div></div>
                        <div class="structure-card" data-structure="golden-circle"><div class="structure-icon">🔵</div><div class="structure-name">Golden Circle</div></div>
                        <div class="structure-card" data-structure="hero-journey"><div class="structure-icon">🦸</div><div class="structure-name">Voyage du Héros</div></div>
                        <div class="structure-card" data-structure="avant-apres"><div class="structure-icon">🔄</div><div class="structure-name">Avant / Après</div></div>
                        <div class="structure-card" data-structure="hook-story-cta"><div class="structure-icon">🪝</div><div class="structure-name">Hook + Story + CTA</div></div>
                        <div class="structure-card" data-structure="storybrand"><div class="structure-icon">🎬</div><div class="structure-name">StoryBrand</div></div>
                        <div class="structure-card" data-structure="pattern-interrupt"><div class="structure-icon">⚡</div><div class="structure-name">Pattern Interrupt</div></div>
                        <div class="structure-card" data-structure="3-actes"><div class="structure-icon">🎭</div><div class="structure-name">3 Actes</div></div>
                    </div>
                </div>

                <div class="config-section" id="formatSection">
                    <label class="config-label">🎬 Format</label>
                    <div class="format-grid" id="formatGrid">
                        <div class="format-chip active" data-format="post">📝 Post</div>
                        <div class="format-chip" data-format="carousel">🎠 Carousel</div>
                        <div class="format-chip" data-format="reel">🎬 Reel</div>
                        <div class="format-chip" data-format="story">⏱️ Story</div>
                        <div class="format-chip" data-format="thread">🧵 Thread</div>
                        <div class="format-chip" data-format="article">📰 Article</div>
                        <div class="format-chip pub" data-format="pub">📢 PUB</div>
                    </div>
                    <div class="format-recommendation" id="formatRecommendation"></div>
                </div>

                <!-- Options PUB (affichées seulement quand format = pub) -->
                <div class="config-section pub-options" id="pubOptionsSection" style="display: none;">
                    <label class="config-label">🎯 Plateforme publicitaire</label>
                    <div class="pub-platform-grid" id="pubPlatformGrid">
                        <div class="pub-platform-chip active" data-pubplatform="meta">
                            <span class="pub-icon">📘</span>
                            <span class="pub-name">Meta Ads</span>
                            <span class="pub-desc">Facebook & Instagram</span>
                        </div>
                        <div class="pub-platform-chip" data-pubplatform="linkedin">
                            <span class="pub-icon">💼</span>
                            <span class="pub-name">LinkedIn Ads</span>
                            <span class="pub-desc">B2B & Pros</span>
                        </div>
                        <div class="pub-platform-chip" data-pubplatform="tiktok">
                            <span class="pub-icon">🎵</span>
                            <span class="pub-name">TikTok Ads</span>
                            <span class="pub-desc">Gen Z & Viral</span>
                        </div>
                        <div class="pub-platform-chip" data-pubplatform="google">
                            <span class="pub-icon">🔍</span>
                            <span class="pub-name">Google Ads</span>
                            <span class="pub-desc">Search & Display</span>
                        </div>
                    </div>

                    <label class="config-label" style="margin-top: 20px;">🎪 Objectif de la campagne</label>
                    <div class="pub-objective-grid" id="pubObjectiveGrid">
                        <div class="pub-objective-chip active" data-objective="conversion">🛒 Conversion</div>
                        <div class="pub-objective-chip" data-objective="trafic">🔗 Trafic</div>
                        <div class="pub-objective-chip" data-objective="notoriete">👁️ Notoriété</div>
                        <div class="pub-objective-chip" data-objective="engagement">💬 Engagement</div>
                        <div class="pub-objective-chip" data-objective="leads">📋 Leads</div>
                    </div>

                    <div class="pub-info-banner">
                        <span>💡</span>
                        <span>L'IA va générer ta pub avec <strong>3 variantes A/B</strong> + les <strong>prompts visuels</strong> adaptés à la plateforme !</span>
                    </div>
                </div>

                <div class="config-section" id="platformSection">
                    <label class="config-label">📱 Plateforme</label>
                    <div class="platform-grid" id="platformGrid">
                        <div class="platform-chip active" data-platform="linkedin">💼 LinkedIn</div>
                        <div class="platform-chip" data-platform="instagram">📸 Instagram</div>
                        <div class="platform-chip disabled" data-platform="scrollab" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: white; opacity: 0.5; cursor: not-allowed;" title="Bientôt disponible !">📜 Scrollab</div>
                        <div class="platform-chip" data-platform="tiktok">🎵 TikTok</div>
                        <div class="platform-chip" data-platform="twitter">𝕏 Twitter</div>
                        <div class="platform-chip" data-platform="facebook">👥 Facebook</div>
                    </div>
                </div>

                <!-- Section Mode Agence -->
                <div class="config-section" id="agencySection">
                    <div class="agency-toggle-section">
                        <div class="agency-toggle-info">
                            <span class="agency-toggle-label">🏢 Mode Agence</span>
                            <span class="agency-toggle-desc" id="agencyStatusText">Multi-clients, dashboard & exports</span>
                        </div>
                        <div id="agencyToggleBtn">
                            <button class="btn btn-agency-unlock-small" onclick="AgencySystem.showUnlockModal()">🔐 Débloquer</button>
                        </div>
                    </div>
                </div>

                <!-- Section Client (visible si mode agence activé) -->
                <div id="clientSection" class="config-section client-section" style="display: none;">
                    <label class="config-label">👤 Client actif</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="clientSelector" class="client-selector" style="flex: 1;" onchange="AgencySystem.setCurrentClient(this.value)">
                            <option value="">-- Aucun client --</option>
                        </select>
                        <button type="button" onclick="AgencySystem.showClientModal()" class="btn-icon" title="Nouveau client">➕</button>
                        <button type="button" onclick="if(AgencySystem.getCurrentClientId()) AgencySystem.showClientModal(AgencySystem.getCurrentClientId())" class="btn-icon" title="Modifier">✏️</button>
                    </div>
                </div>

                <!-- Section Framework -->
                <div class="config-section" id="frameworkSection">
                    <div class="framework-selector">
                        <div class="framework-selector-header">
                            <span class="framework-selector-label">📐 Framework</span>
                            <button class="btn-manage-frameworks" onclick="FrameworkSystem.showLibrary()">Gérer mes frameworks →</button>
                        </div>
                        <div class="framework-quick-select" id="frameworkQuickSelect">
                            <!-- Chargé dynamiquement -->
                        </div>
                    </div>
                </div>

                <div class="config-section" id="ideaSection">
                    <label class="config-label">💡 Ton idée / sujet</label>
                    <textarea class="idea-input" id="ideaInput" placeholder="Décris ton idée ou colle ici un texte que tu veux améliorer..."></textarea>
                </div>

                <button class="generate-btn" id="generateBtn" onclick="generateContent()">🚀 Générer mon contenu</button>
            </div>

            <div class="panel output-panel" id="outputPanel">
                <h2 class="panel-title">📄 Ton contenu</h2>
                <div class="output-content" id="outputContent">
                    <div class="output-placeholder">
                        <div class="output-placeholder-icon">✨</div>
                        <p>Configure tes options et clique sur "Générer" pour créer ton contenu personnalisé !</p>
                    </div>
                </div>
                <div class="action-buttons" id="actionButtons" style="display: none;">
                    <button class="action-btn" onclick="copyContent()">📋 Copier</button>
                    <button class="action-btn" onclick="regenerateContent()">🔄 Régénérer</button>
                    <button class="action-btn" onclick="generateVariantes()">🎭 3 Variantes</button>
                    <button class="action-btn save" onclick="saveToFavorites()">❤️ Sauver</button>
                    <button class="action-btn export" onclick="showExportModal()">📤 Exporter</button>
                </div>
                
                <!-- Section Visuels -->
                <div id="visualSection" style="display: none; margin-top: 20px;">
                    <!-- Bouton Sauvegarder dans Mes Posts -->
                    <div style="margin-bottom: 15px;">
                        <button class="action-btn" onclick="quickSaveToMesPosts()" style="background: linear-gradient(135deg, #10b981, #059669); border: none; color: white; width: 100%; padding: 12px;">
                            📌 Sauvegarder dans Mes Posts
                        </button>
                    </div>
                    
                    <div class="visual-section-title">
                        <span class="visual-title-icon">🎨</span>
                        <span>GÉNÉRER DES PROMPTS VISUELS</span>
                    </div>
                    <div class="action-buttons" id="visualButtons" style="margin-top: 12px;">
                        <button class="action-btn visual-btn" id="btnMidjourney" onclick="generateMidjourney(this)" style="background: linear-gradient(135deg, #5865F2, #7289DA); border: none; color: white;">🎨 Midjourney</button>
                        <button class="action-btn visual-btn" id="btnDalle" onclick="generateDalle(this)" style="background: linear-gradient(135deg, #10a37f, #1a7f64); border: none; color: white;">🤖 DALL-E</button>
                        <button class="action-btn visual-btn" id="btnCanva" onclick="generateCanva(this)" style="background: linear-gradient(135deg, #00C4CC, #7B2D8E); border: none; color: white;">🎬 Canva</button>
                    </div>

                    <!-- Génération visuelle Orshot -->
                    <div class="visual-section-title" style="margin-top: 20px;">
                        <span class="visual-title-icon">🖼️</span>
                        <span>GÉNÉRER UN VISUEL (Orshot)</span>
                    </div>
                    <p style="font-size: 0.85em; color: #666; margin: 10px 0;">Crée automatiquement une image pour ton post</p>
                    <div class="action-buttons" style="margin-top: 12px;">
                        <button class="action-btn visual-btn" id="btnOrshotQuote" onclick="generateOrshot('quote', this)" style="background: linear-gradient(135deg, #FF6B6B, #EE5A5A); border: none; color: white;">💬 Citation</button>
                        <button class="action-btn visual-btn" id="btnOrshotCarousel" onclick="generateOrshot('carousel', this)" style="background: linear-gradient(135deg, #4ECDC4, #44A08D); border: none; color: white;">📸 Carrousel</button>
                        <button class="action-btn visual-btn" id="btnOrshotPost" onclick="generateOrshot('post', this)" style="background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white;">📱 Post visuel</button>
                    </div>
                    <div id="orshotResult" style="display: none; margin-top: 15px;"></div>

                    <!-- Ouvrir mes outils -->
                    <div class="visual-section-title" style="margin-top: 20px;">
                        <span class="visual-title-icon">🚀</span>
                        <span>OUVRIR MES OUTILS</span>
                    </div>
                    <div class="action-buttons" style="margin-top: 12px;">
                        <button class="action-btn" onclick="window.open('https://discord.com/channels/@me', '_blank')" style="background: #5865F2; border: none; color: white;">🎨 Midjourney</button>
                        <button class="action-btn" onclick="window.open('https://chat.openai.com', '_blank')" style="background: #10a37f; border: none; color: white;">🤖 ChatGPT</button>
                        <button class="action-btn" onclick="window.open('https://www.canva.com', '_blank')" style="background: linear-gradient(135deg, #00C4CC, #7B2D8E); border: none; color: white;">🎬 Canva</button>
                        <button class="action-btn" onclick="window.open('https://www.capcut.com/editor', '_blank')" style="background: #000; border: none; color: white;">✂️ CapCut</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cascade (Planning) -->
    <div class="modal-overlay" id="cascadeModal">
        <div class="modal" style="max-width: 95vw; width: 1200px; max-height: 90vh;">
            <div class="modal-header" style="border-bottom: 2px solid #e8e8e8;">
                <h2 class="modal-title">📅 Ma Cascade</h2>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button class="cascade-nav-btn" onclick="CascadeSystem.previousWeek()">◀</button>
                    <span id="cascadeWeekLabel" style="font-weight: 600; min-width: 200px; text-align: center;">Semaine du 25 Nov</span>
                    <button class="cascade-nav-btn" onclick="CascadeSystem.nextWeek()">▶</button>
                    <button class="cascade-nav-btn" onclick="CascadeSystem.goToToday()" style="margin-left: 10px;">Aujourd'hui</button>
                </div>
                <button class="modal-close" onclick="closeCascade()">&times;</button>
            </div>
            
            <div class="cascade-container">
                <!-- Zone principale : Calendrier -->
                <div class="cascade-calendar">
                    <div class="cascade-week" id="cascadeWeek">
                        <!-- Généré par JS -->
                    </div>
                </div>
                
                <!-- Sidebar : Favoris à planifier -->
                <div class="cascade-sidebar">
                    <h3 class="cascade-sidebar-title">📝 À planifier</h3>
                    <p class="cascade-sidebar-desc">Glisse tes favoris vers le calendrier</p>
                    <div class="cascade-favorites" id="cascadeFavorites">
                        <!-- Liste des favoris -->
                    </div>
                    
                    <div class="cascade-export-section">
                        <h3 class="cascade-sidebar-title" style="margin-top: 20px;">📤 Export Bulk</h3>
                        <div class="cascade-export-buttons">
                            <button class="cascade-export-btn" onclick="CascadeSystem.exportCSV('metricool')">
                                <span>📊</span> Metricool
                            </button>
                            <button class="cascade-export-btn" onclick="CascadeSystem.exportCSV('swello')">
                                <span>📊</span> Swello
                            </button>
                            <button class="cascade-export-btn" onclick="CascadeSystem.exportCSV('generic')">
                                <span>📋</span> CSV Générique
                            </button>
                        </div>
                        <p style="font-size: 0.75em; color: #888; margin-top: 10px; line-height: 1.4;">
                            📸 Tu devras ajouter tes images manuellement dans Metricool/Swello après l'import.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ajout/Edit Slot Cascade -->
    <div class="modal-overlay" id="cascadeSlotModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="cascadeSlotTitle">📝 Planifier un contenu</h2>
                <button class="modal-close" onclick="closeCascadeSlot()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <input type="hidden" id="slotDate">
                <input type="hidden" id="slotEditIndex">
                
                <div class="form-group">
                    <label>⏰ Heure de publication</label>
                    <select id="slotTime" class="profile-input">
                        <option value="08:00">08:00 - Tôt le matin</option>
                        <option value="09:00" selected>09:00 - Début journée</option>
                        <option value="10:00">10:00 - Mid-morning</option>
                        <option value="12:00">12:00 - Pause déj</option>
                        <option value="14:00">14:00 - Après-midi</option>
                        <option value="17:00">17:00 - Fin de journée</option>
                        <option value="18:00">18:00 - After work</option>
                        <option value="19:00">19:00 - Soirée</option>
                        <option value="20:00">20:00 - Prime time</option>
                        <option value="21:00">21:00 - Late evening</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>📱 Plateforme</label>
                    <select id="slotPlatform" class="profile-input">
                        <option value="linkedin">💼 LinkedIn</option>
                        <option value="instagram">📸 Instagram</option>
                        <option value="twitter">𝕏 Twitter/X</option>
                        <option value="facebook">👥 Facebook</option>
                        <option value="tiktok">🎵 TikTok</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>📄 Contenu</label>
                    <select id="slotContent" class="profile-input">
                        <option value="">-- Choisir un favori --</option>
                        <!-- Rempli par JS -->
                    </select>
                    <textarea id="slotCustomContent" class="profile-input" rows="4" placeholder="Ou colle/écris ton contenu ici..." style="margin-top: 10px;"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-validate-code" onclick="CascadeSystem.saveSlot()" style="flex: 1;">
                        ✅ Planifier
                    </button>
                    <button class="btn" onclick="CascadeSystem.deleteSlot()" id="deleteSlotBtn" style="background: #ffebee; color: #c62828; display: none;">
                        🗑️ Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Trends -->
    <div class="modal-overlay" id="trendsModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">📈 Idées tendance pour toi</h2>
                <button class="modal-close" onclick="closeTrends()">&times;</button>
            </div>

            <!-- Onglets -->
            <div class="trends-tabs">
                <button class="trends-tab active" id="tabNewIdeas" onclick="switchTrendsTab('new')">
                    🔥 Nouvelles idées
                </button>
                <button class="trends-tab" id="tabSavedIdeas" onclick="switchTrendsTab('saved')">
                    ⭐ Sauvegardées <span class="badge" id="savedCount">0</span>
                </button>
                <button class="trends-tab" id="tabHistory" onclick="switchTrendsTab('history')">
                    📚 Historique <span class="badge">14j</span>
                </button>
            </div>

            <!-- Contenu des onglets -->
            <div id="trendsContent">
                <!-- Sera rempli par displayTrendsWelcome() ou displayTrends() -->
            </div>
            <div id="savedIdeasContent" style="display: none;"></div>
            <div id="historyContent" style="display: none;"></div>
        </div>
    </div>

    <!-- Modal Newsletter -->
    <div class="modal-overlay" id="newsletterModal">
        <div class="modal" style="max-width: 95vw; width: 1100px; max-height: 90vh; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 20px 20px 0 0;">
                <h2 class="modal-title" style="color: white;">📧 Newsletters qui Convertissent</h2>
                <button class="modal-close" onclick="closeNewsletterModal()" style="color: white;">&times;</button>
            </div>
            <div id="newsletter-module" style="max-height: calc(90vh - 80px); overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Modal Visuels -->
    <div class="modal-overlay" id="visualModal">
        <div class="modal" style="max-width: 95vw; width: 800px; max-height: 90vh; overflow: hidden; padding: 0; border-radius: 16px;">
            <div id="visual-module"></div>
        </div>
    </div>

    <!-- Modal Favoris -->
    <div class="modal-overlay" id="favoritesModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">❤️ Mes contenus favoris</h2>
                <button class="modal-close" onclick="closeFavorites()">&times;</button>
            </div>
            <div id="favoritesList"></div>
        </div>
    </div>

    <!-- Modal Help -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">🆘 Help! Améliore mon texte</h2>
                <button class="modal-close" onclick="closeHelpModal()">&times;</button>
            </div>
            <p style="margin-bottom: 15px; color: #666;">Colle ton brouillon, Tithot te proposera des améliorations :</p>
            <textarea class="help-textarea" id="helpTextarea" placeholder="Colle ton texte ici..."></textarea>
            <button class="help-btn" onclick="analyzeText()">✨ Analyser et améliorer</button>
        </div>
    </div>

    <!-- Modal Stats -->
    <div class="modal-overlay" id="statsModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">🏆 Ma progression</h2>
                <button class="modal-close" onclick="document.getElementById('statsModal').classList.remove('show')">&times;</button>
            </div>
            <div id="statsContent"></div>
        </div>
    </div>

    <!-- Modal Planning IA -->
    <div class="modal-overlay" id="planningModal">
        <div class="modal" style="max-width: 950px; max-height: 90vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, #11998e, #38ef7d);">
                <h2 class="modal-title">🗓️ Planning IA</h2>
                <button class="modal-close" onclick="closePlanningModal()">&times;</button>
            </div>
            <div id="planningContent" style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 80px);"></div>
        </div>
    </div>

    <!-- Modal Ma Voix -->
    <div class="modal-overlay" id="voiceModal">
        <div class="modal" style="max-width: 750px; max-height: 90vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                <h2 class="modal-title">🎤 Ma Voix</h2>
                <button class="modal-close" onclick="closeVoiceModal()">&times;</button>
            </div>
            <div id="voiceContent" style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 80px);"></div>
        </div>
    </div>

    <!-- Modal Dashboard Agence -->
    <div class="modal-overlay" id="agencyDashboardModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">🏢 Dashboard Agence</h2>
                <button class="modal-close" onclick="document.getElementById('agencyDashboardModal').classList.remove('show')">&times;</button>
            </div>
            <div id="agencyDashboardContent"></div>
        </div>
    </div>

    <!-- Modal Code Agence -->
    <div class="modal-overlay" id="agencyCodeModal">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div class="modal-header">
                <h2 class="modal-title">🔐 Débloquer Mode Agence</h2>
                <button class="modal-close" onclick="AgencySystem.closeUnlockModal()">&times;</button>
            </div>
            <div style="padding: 20px 0;">
                <p style="color: #666; margin-bottom: 20px;">Entrez votre code d'activation agence :</p>
                <input type="text" id="agencyCodeInput" class="agency-code-input" placeholder="CODE D'ACTIVATION" maxlength="20" onkeyup="if(event.key==='Enter')AgencySystem.validateCode()">
                <p id="agencyCodeError" class="agency-code-error" style="display: none;">❌ Code invalide. Vérifiez votre email de confirmation.</p>
                <button class="btn btn-validate-code" onclick="AgencySystem.validateCode()">✅ Valider</button>
                <p style="margin-top: 20px; font-size: 0.85em; color: #999;">
                    Pas encore d'abonnement Agence ?<br>
                    <a href="mailto:contact@myinnerquest.fr?subject=SOS Storytelling Agence" style="color: #667eea;">Contactez-nous</a> pour souscrire (à partir de 99€/mois)
                </p>
            </div>
        </div>
    </div>

    <!-- Modal Profil Client (enrichi type onboarding) -->
    <div class="modal-overlay" id="clientProfileModal">
        <div class="modal" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #1e3c72, #2a5298);">
                <h2 class="modal-title" id="clientModalTitle">➕ Nouveau client</h2>
                <button class="modal-close" onclick="AgencySystem.closeClientModal()">&times;</button>
            </div>
            <form id="clientProfileForm" class="onboarding-form" onsubmit="event.preventDefault(); AgencySystem.saveClientProfile();">
                <input type="hidden" id="clientProfileId">
                
                <!-- Section Identité -->
                <div class="onboarding-section">
                    <h3>🏢 Identité client</h3>
                    <div class="form-group">
                        <label>Nom du client / entreprise <span class="required">*</span></label>
                        <input type="text" id="clientName" required placeholder="Ex: Café Joyeux, Marie Dupont Coaching...">
                    </div>
                    <div class="form-group">
                        <label>Domaine / Secteur</label>
                        <input type="text" id="clientDomaine" placeholder="Ex: Optique, Coaching, SaaS, Restauration...">
                    </div>
                    <div class="form-group">
                        <label>Message unique / Positionnement</label>
                        <textarea id="clientMessageUnique" placeholder="Ce qui rend ce client unique, sa proposition de valeur..." style="min-height: 60px;"></textarea>
                    </div>
                </div>
                
                <!-- Section Audience -->
                <div class="onboarding-section">
                    <h3>🎯 Audience cible</h3>
                    <div class="form-group">
                        <label>Public cible</label>
                        <div class="checkbox-grid checkbox-grid-compact" id="clientPublicCibleGrid"></div>
                    </div>
                    <div class="form-group">
                        <label>Tranches d'âge ciblées</label>
                        <div class="checkbox-grid checkbox-grid-compact" id="clientTrancheAgeGrid"></div>
                    </div>
                    <div class="form-group">
                        <label>Description audience (optionnel)</label>
                        <input type="text" id="clientAudience" placeholder="Ex: Femmes 25-45 ans, CSP+, urbaines, sensibles à l'écologie...">
                    </div>
                </div>
                
                <!-- Section Contenu -->
                <div class="onboarding-section">
                    <h3>📝 Stratégie de contenu</h3>
                    <div class="form-group">
                        <label>Piliers de contenu (2-4 thématiques)</label>
                        <input type="text" id="clientPiliers" placeholder="Ex: conseils mode, coulisses, témoignages clients">
                        <small>Séparés par des virgules</small>
                    </div>
                    <div class="form-group">
                        <label>Tags / mots-clés récurrents</label>
                        <input type="text" id="clientTags" placeholder="Ex: #optique #lunettes #style #madeinFrance">
                    </div>
                </div>
                
                <!-- Section Plateformes -->
                <div class="onboarding-section">
                    <h3>📱 Plateformes & Formats</h3>
                    <div class="form-group">
                        <label>Plateformes</label>
                        <div class="checkbox-grid" id="clientPlateformesGrid"></div>
                    </div>
                    <div class="form-group">
                        <label>Formats préférés</label>
                        <div class="checkbox-grid checkbox-grid-compact" id="clientFormatsGrid"></div>
                    </div>
                </div>
                
                <!-- Section Style -->
                <div class="onboarding-section">
                    <h3>🎨 Ton & Style</h3>
                    <div class="form-group">
                        <label>Style de communication</label>
                        <div class="radio-cards radio-cards-2col" id="clientStyleGrid"></div>
                    </div>
                    <div class="form-group">
                        <label>Objectif principal</label>
                        <div class="radio-cards radio-cards-2col" id="clientObjectifGrid"></div>
                    </div>
                </div>
                
                <!-- Section Notes -->
                <!-- Section Voix Client -->
                <div class="onboarding-section">
                    <h3>🎤 Voix du client</h3>
                    <p style="color: #888; font-size: 0.9em; margin-bottom: 15px;">Colle des exemples de textes écrits par ce client pour capturer son style unique.</p>
                    
                    <div id="clientVoiceSamples" class="voice-samples" style="margin-bottom: 15px;"></div>
                    
                    <div class="form-group">
                        <textarea id="clientVoiceNewSample" class="voice-textarea" placeholder="Colle ici un texte écrit par le client (post LinkedIn, email, bio...) dont il est satisfait..." style="min-height: 120px;"></textarea>
                    </div>
                    <button type="button" onclick="AgencySystem.addClientVoiceSample()" class="btn-secondary" style="width: 100%; margin-bottom: 10px;">
                        ➕ Ajouter ce texte
                    </button>
                    
                    <div id="clientVoiceStatus" style="display: none; padding: 12px; border-radius: 10px; margin-top: 10px;"></div>
                    
                    <button type="button" onclick="AgencySystem.analyzeClientVoice()" id="analyzeClientVoiceBtn" class="btn-primary" style="width: 100%; display: none;">
                        🎤 Analyser la voix du client
                    </button>
                </div>
                
                <div class="onboarding-section">
                    <h3>💬 Notes & Particularités</h3>
                    <div class="form-group">
                        <textarea id="clientNotes" placeholder="Contraintes, ton à éviter, anecdotes, historique de la marque, mots interdits..." style="min-height: 100px;"></textarea>
                    </div>
                </div>
                
                <div class="onboarding-actions">
                    <button type="submit" class="btn-primary">💾 Enregistrer le client</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Import CSV/Excel -->
    <div class="modal-overlay" id="importModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">📥 Importer des clients</h2>
                <button class="modal-close" onclick="AgencySystem.closeImportModal()">&times;</button>
            </div>
            <div style="padding: 20px 0;">
                <p style="color: #666; margin-bottom: 15px;">
                    Importez vos clients depuis un fichier <strong>CSV</strong> ou <strong>Excel (.xlsx)</strong>.
                </p>
                
                <!-- Bouton télécharger modèle -->
                <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; gap: 15px;">
                    <div>
                        <strong style="color: #2e7d32;">📋 Besoin d'un modèle ?</strong>
                        <p style="font-size: 0.85em; color: #555; margin: 5px 0 0;">Téléchargez notre template pré-formaté pour un import parfait.</p>
                    </div>
                    <button onclick="AgencySystem.downloadTemplate()" style="background: #2e7d32; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap; font-family: inherit;">
                        ⬇️ Télécharger le modèle
                    </button>
                </div>
                
                <div class="import-dropzone">
                    <input type="file" id="importFile" accept=".csv,.xlsx,.xls" onchange="AgencySystem.handleFileUpload(event)">
                    <div class="import-dropzone-content">
                        <span style="font-size: 2em;">📄</span>
                        <p>Glissez un fichier ou cliquez pour sélectionner</p>
                        <span style="font-size: 0.85em; color: #999;">CSV, XLSX, XLS</span>
                    </div>
                </div>
                
                <div id="importPreview"></div>
            </div>
        </div>
    </div>

    <!-- Modal Bibliothèque Frameworks -->
    <div class="modal-overlay" id="frameworkLibraryModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">📐 Mes Frameworks</h2>
                <button class="modal-close" onclick="FrameworkSystem.closeLibrary()">&times;</button>
            </div>
            <div style="padding: 20px 0;">
                <div class="framework-tabs">
                    <button class="framework-tab active" onclick="FrameworkSystem.showTab('my')" data-tab="my">📁 Mes Frameworks</button>
                    <button class="framework-tab" onclick="FrameworkSystem.showTab('defaults')" data-tab="defaults">🌟 Par défaut</button>
                    <button class="framework-tab" onclick="FrameworkSystem.showTab('templates')" data-tab="templates">📋 Templates</button>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <input type="text" id="frameworkSearch" placeholder="🔍 Rechercher un framework..."
                           style="flex: 1; max-width: 300px; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit;"
                           oninput="FrameworkSystem.filterFrameworks(this.value)">
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-import-fw" onclick="FrameworkSystem.showImport()">
                            📥 Importer
                        </button>
                        <button class="btn btn-frameworks" onclick="FrameworkSystem.showEditor()" style="padding: 10px 20px;">
                            ➕ Créer un framework
                        </button>
                    </div>
                </div>

                <div id="frameworksContent" class="frameworks-grid">
                    <!-- Frameworks chargés dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Éditeur de Framework -->
    <div class="modal-overlay" id="frameworkEditorModal">
        <div class="modal" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" id="frameworkEditorTitle">➕ Créer un framework</h2>
                <button class="modal-close" onclick="FrameworkSystem.closeEditor()">&times;</button>
            </div>
            <div class="framework-editor">
                <form id="frameworkForm" onsubmit="event.preventDefault(); FrameworkSystem.saveFramework();">
                    <input type="hidden" id="frameworkId" value="">

                    <div class="framework-editor-row">
                        <div class="form-group">
                            <label>📝 Nom du framework <span class="required">*</span></label>
                            <input type="text" id="frameworkName" required placeholder="Ex: Script appel découverte">
                        </div>
                        <div class="form-group">
                            <label>🎨 Icône & Couleur</label>
                            <div class="color-picker-row">
                                <input type="color" id="frameworkColor" value="#11998e">
                                <div class="icon-picker" id="frameworkIconPicker">
                                    <span class="icon-option active" data-icon="📝">📝</span>
                                    <span class="icon-option" data-icon="📞">📞</span>
                                    <span class="icon-option" data-icon="💬">💬</span>
                                    <span class="icon-option" data-icon="📧">📧</span>
                                    <span class="icon-option" data-icon="📰">📰</span>
                                    <span class="icon-option" data-icon="🎯">🎯</span>
                                    <span class="icon-option" data-icon="🔥">🔥</span>
                                    <span class="icon-option" data-icon="💡">💡</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="framework-editor-row full">
                        <div class="form-group">
                            <label>📂 Type de contenu <span class="required">*</span></label>
                            <div class="framework-type-select" id="frameworkTypeSelect">
                                <span class="framework-type-chip active" data-type="script_call">📞 Script Call</span>
                                <span class="framework-type-chip" data-type="dm">💬 DM</span>
                                <span class="framework-type-chip" data-type="email">📧 Email</span>
                                <span class="framework-type-chip" data-type="post">📝 Post</span>
                                <span class="framework-type-chip" data-type="carousel">🎠 Carousel</span>
                                <span class="framework-type-chip" data-type="newsletter">📰 Newsletter</span>
                                <span class="framework-type-chip" data-type="other">📋 Autre</span>
                            </div>
                        </div>
                    </div>

                    <div class="framework-editor-row full">
                        <div class="form-group">
                            <label>📖 Description</label>
                            <textarea id="frameworkDescription" rows="2" placeholder="Ex: Pour qualifier un prospect en 15 min"></textarea>
                        </div>
                    </div>

                    <div class="steps-editor">
                        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-weight: 600; color: #333;">
                            🔢 Étapes du framework <span class="required">*</span>
                            <span style="font-size: 0.8em; font-weight: 400; color: #888;">(Glisser-déposer pour réorganiser)</span>
                        </label>
                        <div class="steps-list" id="stepsList">
                            <!-- Steps dynamically added -->
                        </div>
                        <button type="button" class="btn-add-step" onclick="FrameworkSystem.addStep()">
                            ➕ Ajouter une étape
                        </button>
                    </div>

                    <div class="framework-editor-row full" style="margin-top: 20px;">
                        <div class="form-group">
                            <label>📋 Consignes globales <span style="font-size: 0.8em; color: #888;">(optionnel)</span></label>
                            <textarea id="frameworkInstructions" rows="2" placeholder="Ex: Ton direct mais chaleureux, pas de jargon"></textarea>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                        <button type="button" class="btn" style="flex: 1; background: #e0e0e0; color: #333;" onclick="FrameworkSystem.closeEditor()">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-frameworks" style="flex: 2; padding: 15px;">
                            💾 Enregistrer le framework
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Prévisualisation Template -->
    <div class="modal-overlay" id="templatePreviewModal">
        <div class="modal preview-modal">
            <button class="modal-close" onclick="FrameworkSystem.closePreview()" style="position: absolute; right: 15px; top: 15px; z-index: 10; background: rgba(255,255,255,0.9); border-radius: 50%; width: 35px; height: 35px;">&times;</button>
            <div class="preview-header" id="previewHeader" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                <div class="preview-header-top">
                    <span class="preview-icon" id="previewIcon">📝</span>
                    <span class="preview-type" id="previewType">Post</span>
                </div>
                <div class="preview-title" id="previewTitle">Nom du template</div>
                <div class="preview-desc" id="previewDesc">Description du template</div>
            </div>
            <div class="preview-content">
                <div class="preview-section">
                    <h4>🔢 Structure en étapes</h4>
                    <div class="preview-steps-list" id="previewSteps">
                        <!-- Steps dynamically added -->
                    </div>
                </div>
                <div class="preview-section" id="previewInstructionsSection">
                    <h4>📋 Consignes globales</h4>
                    <div class="preview-instructions">
                        <p id="previewInstructions">Instructions...</p>
                    </div>
                </div>
                <div class="preview-actions">
                    <button class="btn" style="background: #e0e0e0; color: #333;" onclick="FrameworkSystem.closePreview()">
                        Fermer
                    </button>
                    <button class="btn btn-frameworks" id="previewUseBtn" onclick="FrameworkSystem.usePreviewedTemplate()">
                        ✅ Utiliser ce template
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Import Framework -->
    <div class="modal-overlay" id="frameworkImportModal">
        <div class="modal import-modal">
            <div class="modal-header">
                <h2 class="modal-title">📥 Importer un framework</h2>
                <button class="modal-close" onclick="FrameworkSystem.closeImport()">&times;</button>
            </div>
            <div style="padding: 20px 0;">
                <!-- Bouton télécharger template -->
                <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <strong style="color: #2e7d32;">📋 Besoin d'un modèle ?</strong>
                        <p style="margin: 5px 0 0; color: #388e3c; font-size: 0.9em;">Téléchargez notre template CSV prêt à remplir</p>
                    </div>
                    <a href="template-frameworks-sos-storytelling.csv" download class="btn" style="background: linear-gradient(135deg, #4caf50, #66bb6a); color: white; padding: 10px 18px; text-decoration: none;">
                        ⬇️ Télécharger le modèle CSV
                    </a>
                </div>

                <div class="import-tabs">
                    <button class="import-tab active" onclick="FrameworkSystem.switchImportTab('excel')" data-tab="excel">
                        📊 Excel/CSV
                    </button>
                    <button class="import-tab" onclick="FrameworkSystem.switchImportTab('json')" data-tab="json">
                        📄 JSON
                    </button>
                </div>

                <div id="importTabExcel">
                    <div class="import-dropzone-fw" id="importDropzoneExcel">
                        <input type="file" accept=".xlsx,.xls,.csv" onchange="FrameworkSystem.handleFileImport(event, 'excel')">
                        <div class="import-dropzone-icon">📊</div>
                        <div class="import-dropzone-text">Glissez un fichier Excel ou CSV ici</div>
                        <div class="import-dropzone-hint">Formats acceptés : .xlsx, .xls, .csv</div>
                    </div>
                    <div class="import-example" style="margin-top: 15px;">
                        <h5>📋 Format attendu (colonnes) :</h5>
                        <pre>step_name | step_description
Accroche  | Créer le lien avec le prospect
Problème  | Identifier le problème principal
Solution  | Présenter votre solution</pre>
                        <p style="margin-top: 10px; font-size: 0.85em; color: #666;">
                            💡 La première ligne doit contenir les en-têtes. Utilisez le template pour un import parfait !
                        </p>
                    </div>
                </div>

                <div id="importTabJson" style="display: none;">
                    <div class="import-dropzone-fw" id="importDropzoneJson">
                        <input type="file" accept=".json" onchange="FrameworkSystem.handleFileImport(event, 'json')">
                        <div class="import-dropzone-icon">📄</div>
                        <div class="import-dropzone-text">Glissez un fichier JSON ici</div>
                        <div class="import-dropzone-hint">ou cliquez pour sélectionner</div>
                    </div>
                    <p style="text-align: center; color: #888; margin: 15px 0;">ou collez directement le JSON :</p>
                    <textarea class="import-textarea" id="importJsonText" placeholder='{"name": "Mon framework", "type": "post", "steps": [...]}'></textarea>
                    <div class="import-example">
                        <h5>📋 Exemple de format JSON :</h5>
                        <pre>{
  "name": "Mon framework",
  "type": "post",
  "description": "Description...",
  "icon": "📝",
  "steps": [
    {"name": "Étape 1", "description": "..."},
    {"name": "Étape 2", "description": "..."}
  ],
  "global_instructions": "Consignes..."
}</pre>
                    </div>
                </div>

                <div id="importResult" class="import-result" style="display: none;"></div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn" style="flex: 1; background: #e0e0e0; color: #333;" onclick="FrameworkSystem.closeImport()">
                        Annuler
                    </button>
                    <button class="btn btn-frameworks" style="flex: 2; padding: 14px;" onclick="FrameworkSystem.processImport()">
                        📥 Importer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal RGPD -->
    <div class="modal-overlay" id="rgpdModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">🔒 Protection des données</h2>
                <button class="modal-close" onclick="AgencySystem.declineRGPD()">&times;</button>
            </div>
            <div style="padding: 20px 0;">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px; color: #333;">📋 Ce que nous faisons de vos données :</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #555; line-height: 1.8;">
                        <li>✅ <strong>Traitement 100% local</strong> dans votre navigateur</li>
                        <li>✅ <strong>Aucun envoi</strong> vers nos serveurs</li>
                        <li>✅ <strong>Données stockées</strong> uniquement sur votre appareil</li>
                        <li>✅ <strong>Suppression totale</strong> possible à tout moment</li>
                    </ul>
                </div>
                
                <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
                    En cliquant "Accepter", vous confirmez avoir le droit d'importer ces données clients 
                    et acceptez leur traitement local pour la génération de contenus.
                </p>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn" style="flex: 1; background: #e0e0e0; color: #333;" onclick="AgencySystem.declineRGPD()">Annuler</button>
                    <button class="btn btn-validate-code" style="flex: 2;" onclick="AgencySystem.acceptRGPD()">✅ Accepter et continuer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Inscription (première visite) -->
    <div class="modal-overlay" id="registerModal">
        <div class="modal" style="max-width: 450px; text-align: center;">
            <div style="font-size: 4em; margin-bottom: 15px;">🚀</div>
            <h2 style="font-size: 1.5em; margin-bottom: 10px;">Bienvenue sur SOS Storytelling !</h2>
            <p style="color: #666; margin-bottom: 25px;">Entre ton email pour sauvegarder ta progression et débloquer toutes les fonctionnalités.</p>
            
            <input type="email" id="registerEmail" class="profile-input" placeholder="ton@email.com" style="text-align: center; font-size: 1.1em; margin-bottom: 10px;">
            <input type="text" id="registerName" class="profile-input" placeholder="Ton prénom (optionnel)" style="text-align: center; margin-bottom: 20px;">
            
            <button class="btn btn-validate-code" onclick="completeRegistration()" style="width: 100%; padding: 15px; font-size: 1.1em;">
                ✨ C'est parti !
            </button>
            
            <p style="color: #999; font-size: 0.8em; margin-top: 15px;">
                🔒 Tes données restent privées. Pas de spam promis !
            </p>
            
            <button onclick="skipRegistration()" style="background: none; border: none; color: #999; margin-top: 10px; cursor: pointer; font-size: 0.85em;">
                Continuer sans compte →
            </button>
        </div>
    </div>

    <!-- Modal Code Promo -->
    <div class="modal-overlay" id="promoCodeModal">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <button class="modal-close" onclick="closePromoModal()">&times;</button>
            <div style="font-size: 3em; margin-bottom: 15px;">🎟️</div>
            <h2 style="font-size: 1.3em; margin-bottom: 20px;">Code Promo / Early Bird</h2>
            
            <input type="text" id="promoCodeInput" class="agency-code-input" placeholder="TON CODE" maxlength="20" style="text-transform: uppercase;" onkeyup="if(event.key==='Enter')validatePromoCode()">
            
            <div id="promoCodeResult" style="margin: 15px 0; min-height: 25px;"></div>
            
            <button class="btn btn-validate-code" onclick="validatePromoCode()" style="width: 100%;">
                ✅ Activer le code
            </button>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal" style="max-width: 650px;">
            <div class="modal-header">
                <h2 class="modal-title">📤 Exporter & Publier</h2>
                <button class="modal-close" onclick="closeExportModal()">&times;</button>
            </div>
            <div class="export-modal-body">
                <!-- Aperçu du contenu -->
                <div class="export-preview" id="exportPreview">
                    Ton contenu apparaîtra ici...
                </div>

                <!-- Actions rapides -->
                <div class="export-section-title">⚡ Actions rapides</div>
                <div class="export-quick-actions">
                    <button class="export-quick-btn" onclick="exportCopyContent()">
                        <span class="icon">📋</span>
                        <div class="text">
                            <div class="label">Copier le texte</div>
                            <div class="desc">Prêt à coller</div>
                        </div>
                    </button>
                    <button class="export-quick-btn" onclick="exportDownloadCSV()">
                        <span class="icon">📊</span>
                        <div class="text">
                            <div class="label">Télécharger CSV</div>
                            <div class="desc">Compatible tous outils</div>
                        </div>
                    </button>
                    <button class="export-quick-btn" onclick="exportOpenLinkedIn()">
                        <span class="icon">💼</span>
                        <div class="text">
                            <div class="label">Ouvrir LinkedIn</div>
                            <div class="desc">Copier + ouvrir</div>
                        </div>
                    </button>
                </div>

                <!-- Partenaires -->
                <div class="export-section-title">🤝 Nos outils partenaires</div>
                <div class="export-partners-grid">
                    <div class="export-partner-card recommended" onclick="exportToPartner('metricool')">
                        <div class="partner-header">
                            <div class="partner-logo metricool">📊</div>
                            <div>
                                <div class="partner-name">Metricool</div>
                                <div class="partner-tagline">Le plus complet</div>
                            </div>
                        </div>
                        <div class="partner-features">
                            <span class="partner-feature auto">✓ Publication auto</span>
                            <span class="partner-feature">Import CSV</span>
                            <span class="partner-feature">Analytics</span>
                        </div>
                        <div class="partner-price">À partir de <strong>gratuit</strong></div>
                    </div>

                    <div class="export-partner-card" onclick="exportToPartner('swello')">
                        <div class="partner-header">
                            <div class="partner-logo swello">🇫🇷</div>
                            <div>
                                <div class="partner-name">Swello</div>
                                <div class="partner-tagline">Made in France 🇫🇷</div>
                            </div>
                        </div>
                        <div class="partner-features">
                            <span class="partner-feature auto">✓ Publication auto</span>
                            <span class="partner-feature french">🇫🇷 Français</span>
                            <span class="partner-feature">Import CSV natif</span>
                        </div>
                        <div class="partner-price">À partir de <strong>9,90€/mois</strong></div>
                    </div>

                    <div class="export-partner-card" onclick="exportToPartner('agorapulse')">
                        <div class="partner-header">
                            <div class="partner-logo agorapulse">🦁</div>
                            <div>
                                <div class="partner-name">Agorapulse</div>
                                <div class="partner-tagline">Pour les pros 🇫🇷</div>
                            </div>
                        </div>
                        <div class="partner-features">
                            <span class="partner-feature auto">✓ Publication auto</span>
                            <span class="partner-feature french">🇫🇷 Français</span>
                            <span class="partner-feature">Bulk import</span>
                        </div>
                        <div class="partner-price">À partir de <strong>49€/mois</strong></div>
                    </div>

                    <div class="export-partner-card" onclick="exportToPartner('buffer')">
                        <div class="partner-header">
                            <div class="partner-logo buffer">📅</div>
                            <div>
                                <div class="partner-name">Buffer</div>
                                <div class="partner-tagline">Simple & gratuit</div>
                            </div>
                        </div>
                        <div class="partner-features">
                            <span class="partner-feature auto">✓ Publication auto</span>
                            <span class="partner-feature">3 comptes gratuits</span>
                            <span class="partner-feature">UX moderne</span>
                        </div>
                        <div class="partner-price">À partir de <strong>gratuit</strong></div>
                    </div>
                </div>

                <div class="export-info-banner">
                    <span class="icon">💡</span>
                    <div>
                        <strong>Instagram & TikTok :</strong> Ces plateformes limitent la publication auto via API. 
                        Nos partenaires proposent un mode "semi-auto" avec notification push.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tendances Format 2026 -->
    <div class="modal-overlay" id="formatTrendsModal">
        <div class="modal trends-format-modal">
            <div class="trends-format-header" style="position: relative;">
                <button class="modal-close" onclick="closeFormatTrends()">&times;</button>
                <h2>🔥 Tendances Format 2026</h2>
                <p>Ce qui performe vraiment sur chaque plateforme</p>
            </div>
            <div class="trends-format-tabs">
                <button class="trends-format-tab linkedin active" onclick="showFormatTrend('linkedin')">💼 LinkedIn</button>
                <button class="trends-format-tab tiktok" onclick="showFormatTrend('tiktok')">🎵 TikTok</button>
                <button class="trends-format-tab instagram" onclick="showFormatTrend('instagram')">📸 Instagram</button>
                <button class="trends-format-tab facebook" onclick="showFormatTrend('facebook')">👥 Facebook</button>
            </div>
            <div class="trends-format-content" id="formatTrendsContent">
                <!-- Rempli dynamiquement -->
            </div>
        </div>
    </div>

    <!-- Tour Overlay -->
    <div class="tour-overlay" id="tourOverlay"></div>
    <div class="demo-badge" id="demoBadge" onclick="startTour()">🎯 Démo guidée</div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
    <script>
        // ==================== USER PROFILE MANAGER ====================
        const USER_PROFILE_KEY = 'voyageCreatifUserProfile';
        const DEFAULT_PROFILE = {
            nom: '', domaine: '', messageUnique: '', publicCible: [], trancheAge: [],
            piliers: [], tags: '', plateformes: [], formats: [], niveau: '', style: '',
            objectif: '', problematique: '', precisions: '', dateCreation: null, dateModification: null,
            voiceProfile: null // Profil de voix analysé par l'IA
        };

        function getUserProfile() {
            const saved = localStorage.getItem(USER_PROFILE_KEY);
            if (saved) { try { return JSON.parse(saved); } catch (e) { return null; } }
            return null;
        }

        function saveUserProfile(profile) {
            const now = new Date().toISOString();
            if (!profile.dateCreation) profile.dateCreation = now;
            profile.dateModification = now;
            localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(profile));
        }

        function hasValidProfile() {
            const profile = getUserProfile();
            return profile && profile.nom && profile.nom.trim() !== '';
        }

        window.UserProfile = {
            get: getUserProfile,
            save: saveUserProfile,
            hasValid: hasValidProfile,
            delete: () => localStorage.removeItem(USER_PROFILE_KEY),
            update: (updates) => { const current = getUserProfile() || { ...DEFAULT_PROFILE }; const updated = { ...current, ...updates }; saveUserProfile(updated); return updated; },
            getSummary: () => { const p = getUserProfile(); return p ? `${p.nom} • ${p.domaine} • ${p.plateformes.join(', ')}` : 'Aucun profil'; },
            DEFAULT: DEFAULT_PROFILE
        };

        // ==================== ONBOARDING SYSTEM ====================
        const ONBOARDING_OPTIONS = {
            plateformes: [
                { value: 'linkedin', label: 'LinkedIn', icon: '💼' },
                { value: 'instagram', label: 'Instagram', icon: '📸' },
                { value: 'tiktok', label: 'TikTok', icon: '🎵' },
                { value: 'youtube', label: 'YouTube', icon: '🎬' },
                { value: 'x', label: 'X (Twitter)', icon: '𝕏' },
                { value: 'facebook', label: 'Facebook', icon: '👥' },
                { value: 'threads', label: 'Threads', icon: '🧵' },
                { value: 'pinterest', label: 'Pinterest', icon: '📌' },
                { value: 'newsletter', label: 'Newsletter', icon: '📧' }
            ],
            formats: [
                { value: 'post', label: 'Post texte', icon: '📝' },
                { value: 'carousel', label: 'Carousel', icon: '🎠' },
                { value: 'reel', label: 'Reel / Vidéo', icon: '🎬' },
                { value: 'story', label: 'Story', icon: '⏱️' },
                { value: 'thread', label: 'Thread', icon: '🧵' },
                { value: 'live', label: 'Live', icon: '🔴' },
                { value: 'article', label: 'Article', icon: '📰' },
                { value: 'visuel', label: 'Visuel', icon: '🎨' }
            ],
            publicCible: [
                { value: 'entrepreneurs', label: 'Entrepreneurs', icon: '🚀' },
                { value: 'freelances', label: 'Freelances', icon: '💻' },
                { value: 'salaries', label: 'Salariés', icon: '👔' },
                { value: 'etudiants', label: 'Étudiants', icon: '🎓' },
                { value: 'createurs', label: 'Créateurs', icon: '🎨' },
                { value: 'rh', label: 'RH / Recruteurs', icon: '🤝' },
                { value: 'b2b', label: 'Pros / B2B', icon: '🏢' },
                { value: 'b2c', label: 'Grand public', icon: '🛒' },
                { value: 'dirigeants', label: 'Dirigeants', icon: '👑' }
            ],
            trancheAge: [
                { value: '18-25', label: '18-25 ans' },
                { value: '25-35', label: '25-35 ans' },
                { value: '35-45', label: '35-45 ans' },
                { value: '45-55', label: '45-55 ans' },
                { value: '55+', label: '55+ ans' },
                { value: 'tous', label: 'Tous âges' }
            ],
            niveaux: [
                { value: 'debutant', label: 'Jeune pousse', icon: '🌱' },
                { value: 'explorateur', label: 'Explorateur', icon: '🧭' },
                { value: 'createur', label: 'Créateur', icon: '✨' },
                { value: 'influenceur', label: 'Influenceur', icon: '🚀' },
                { value: 'stratege', label: 'Stratège', icon: '💎' },
                { value: 'legende', label: 'Légende', icon: '👑' }
            ],
            styles: [
                { value: 'inspirant', label: 'Inspirant', icon: '✨' },
                { value: 'educatif', label: 'Éducatif', icon: '📚' },
                { value: 'authentique', label: 'Authentique', icon: '💎' },
                { value: 'humour', label: 'Humour', icon: '😄' },
                { value: 'provocateur', label: 'Provocateur', icon: '🔥' },
                { value: 'minimaliste', label: 'Minimaliste', icon: '🎯' },
                { value: 'storytelling', label: 'Storytelling', icon: '📖' },
                { value: 'emotionnel', label: 'Émotionnel', icon: '❤️' }
            ],
            objectifs: [
                { value: 'notoriete', label: 'Notoriété', icon: '🌟' },
                { value: 'communaute', label: 'Communauté', icon: '👥' },
                { value: 'ventes', label: 'Ventes', icon: '💰' },
                { value: 'autorite', label: 'Autorité', icon: '👑' },
                { value: 'reseau', label: 'Réseau', icon: '🤝' },
                { value: 'expression', label: 'Expression', icon: '🎨' },
                { value: 'recrutement', label: 'Recrutement', icon: '🎯' },
                { value: 'validation', label: 'Validation', icon: '🧪' }
            ]
        };

        function showOnboarding(isEdit = false) {
            const existingProfile = UserProfile.get();
            const modalHTML = `
                <div id="onboardingOverlay" class="onboarding-overlay">
                    <div class="onboarding-modal">
                        <div class="onboarding-header">
                            <h2>${isEdit ? '✏️ Modifier mon profil' : '🚀 Bienvenue !'}</h2>
                            <p>${isEdit ? 'Tes contenus seront personnalisés selon ces informations' : 'Personnalise ton expérience en quelques clics'}</p>
                            <button class="onboarding-close" onclick="closeOnboarding()">×</button>
                        </div>
                        <form id="onboardingForm" class="onboarding-form">
                            <div class="onboarding-section">
                                <h3>👤 Ton identité</h3>
                                <div class="form-group">
                                    <label for="onb-nom">Comment t'appelles-tu ? <span class="required">*</span></label>
                                    <input type="text" id="onb-nom" placeholder="Ton prénom ou pseudo" value="${existingProfile?.nom || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label for="onb-domaine">Ton domaine d'expertise</label>
                                    <input type="text" id="onb-domaine" placeholder="Ex: coaching, design, marketing digital..." value="${existingProfile?.domaine || ''}">
                                    <small class="field-hint">💡 L'IA se basera sur ce champ pour te proposer des sujets et idées de contenu pertinents.</small>
                                </div>
                                <div class="form-group">
                                    <label for="onb-messageUnique">Ce qui te rend unique</label>
                                    <textarea id="onb-messageUnique" placeholder="Ex: J'aide les introvertis à rayonner sur LinkedIn..." style="min-height: 60px;">${existingProfile?.messageUnique || ''}</textarea>
                                </div>
                            </div>
                            <div class="onboarding-section">
                                <h3>🎯 Ton audience</h3>
                                <div class="form-group">
                                    <label>Public cible</label>
                                    <div class="checkbox-grid checkbox-grid-compact">
                                        ${ONBOARDING_OPTIONS.publicCible.map(p => `
                                            <label class="checkbox-card">
                                                <input type="checkbox" name="publicCible" value="${p.value}" ${existingProfile?.publicCible?.includes(p.value) ? 'checked' : ''}>
                                                <span class="checkbox-content"><span class="checkbox-icon">${p.icon}</span><span class="checkbox-label">${p.label}</span></span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Tranches d'âge ciblées</label>
                                    <div class="checkbox-grid checkbox-grid-compact">
                                        ${ONBOARDING_OPTIONS.trancheAge.map(t => `
                                            <label class="checkbox-card">
                                                <input type="checkbox" name="trancheAge" value="${t.value}" ${existingProfile?.trancheAge?.includes(t.value) ? 'checked' : ''}>
                                                <span class="checkbox-content"><span class="checkbox-label">${t.label}</span></span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            <div class="onboarding-section">
                                <h3>📝 Ton contenu</h3>
                                <div class="form-group">
                                    <label for="onb-piliers">Tes piliers de contenu (2-4 thématiques)</label>
                                    <input type="text" id="onb-piliers" placeholder="Ex: mindset, productivité, entrepreneuriat" value="${existingProfile?.piliers?.join(', ') || ''}">
                                    <small>Séparés par des virgules</small>
                                </div>
                                <div class="form-group">
                                    <label for="onb-tags">Tags / mots-clés récurrents</label>
                                    <input type="text" id="onb-tags" placeholder="Ex: #leadership #growthmindset" value="${existingProfile?.tags || ''}">
                                </div>
                            </div>
                            <div class="onboarding-section">
                                <h3>🎨 Ton profil créateur</h3>
                                <div class="form-group">
                                    <label>Niveau</label>
                                    <div class="radio-cards radio-cards-3col">
                                        ${ONBOARDING_OPTIONS.niveaux.map(n => `
                                            <label class="radio-card radio-card-compact">
                                                <input type="radio" name="niveau" value="${n.value}" ${(existingProfile?.niveau || '') === n.value ? 'checked' : ''}>
                                                <span class="radio-content"><span class="radio-icon">${n.icon}</span><span class="radio-label">${n.label}</span></span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Style de communication</label>
                                    <div class="radio-cards radio-cards-2col">
                                        ${ONBOARDING_OPTIONS.styles.map(s => `
                                            <label class="radio-card radio-card-compact">
                                                <input type="radio" name="style" value="${s.value}" ${(existingProfile?.style || '') === s.value ? 'checked' : ''}>
                                                <span class="radio-content"><span class="radio-icon">${s.icon}</span><span class="radio-label">${s.label}</span></span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            <div class="onboarding-section">
                                <h3>🎯 Tes objectifs</h3>
                                <div class="form-group">
                                    <label>Objectif principal</label>
                                    <div class="radio-cards radio-cards-2col">
                                        ${ONBOARDING_OPTIONS.objectifs.map(o => `
                                            <label class="radio-card radio-card-compact">
                                                <input type="radio" name="objectif" value="${o.value}" ${(existingProfile?.objectif || '') === o.value ? 'checked' : ''}>
                                                <span class="radio-content"><span class="radio-icon">${o.icon}</span><span class="radio-label">${o.label}</span></span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="onb-problematique">Problématique actuelle</label>
                                    <textarea id="onb-problematique" placeholder="Ex: Je bloque sur la régularité..." style="min-height: 60px;">${existingProfile?.problematique || ''}</textarea>
                                </div>
                            </div>
                            <div class="onboarding-section">
                                <h3>💬 Autre chose ?</h3>
                                <div class="form-group">
                                    <textarea id="onb-precisions" placeholder="Tout ce qui peut aider à personnaliser tes contenus..." style="min-height: 80px;">${existingProfile?.precisions || ''}</textarea>
                                </div>
                            </div>
                            <div class="onboarding-actions">
                                <button type="submit" class="btn-primary">${isEdit ? '💾 Sauvegarder' : '🚀 C\'est parti !'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.getElementById('onboardingForm').addEventListener('submit', handleOnboardingSubmit);
            setTimeout(() => document.getElementById('onboardingOverlay').classList.add('active'), 10);
        }

        function handleOnboardingSubmit(e) {
            e.preventDefault();
            const nom = document.getElementById('onb-nom').value.trim();
            if (!nom) { alert('Merci de renseigner au moins ton prénom 😊'); return; }
            
            const profile = {
                nom,
                domaine: document.getElementById('onb-domaine').value.trim(),
                messageUnique: document.getElementById('onb-messageUnique').value.trim(),
                piliers: document.getElementById('onb-piliers').value.split(',').map(p => p.trim()).filter(p => p),
                tags: document.getElementById('onb-tags').value.trim(),
                problematique: document.getElementById('onb-problematique').value.trim(),
                precisions: document.getElementById('onb-precisions').value.trim(),
                publicCible: Array.from(document.querySelectorAll('input[name="publicCible"]:checked')).map(cb => cb.value),
                trancheAge: Array.from(document.querySelectorAll('input[name="trancheAge"]:checked')).map(cb => cb.value),
                niveau: document.querySelector('input[name="niveau"]:checked')?.value || '',
                style: document.querySelector('input[name="style"]:checked')?.value || '',
                objectif: document.querySelector('input[name="objectif"]:checked')?.value || ''
            };
            
            UserProfile.save(profile);
            closeOnboarding();
            showOnboardingNotification(`✨ Profil sauvegardé, ${nom} !`);
            
            // MISE À JOUR AUTOMATIQUE DE LA CONFIG
            if (typeof refreshConfigFromProfile === 'function') {
                refreshConfigFromProfile();
            }
        }

        function closeOnboarding() {
            const overlay = document.getElementById('onboardingOverlay');
            if (overlay) {
                overlay.classList.remove('active');
                setTimeout(() => overlay.remove(), 300);
            }
        }

        function showOnboardingNotification(message) {
            const notif = document.createElement('div');
            notif.className = 'onboarding-notif';
            notif.innerHTML = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.classList.add('active'), 10);
            setTimeout(() => { notif.classList.remove('active'); setTimeout(() => notif.remove(), 300); }, 3000);
        }

        window.Onboarding = {
            show: showOnboarding,
            close: closeOnboarding,
            edit: () => showOnboarding(true),
            check: () => { if (!UserProfile.hasValid()) showOnboarding(false); else updateProfileButton(); },
            forceShow: () => showOnboarding(true)
        };

        // ==================== SUPABASE ANALYTICS ====================
        const SUPABASE_URL = 'https://pyxidmnckpnrargygwnf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5eGlkbW5ja3BucmFyZ3lnd25mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMzc4NzIsImV4cCI6MjA3OTgxMzg3Mn0.atm-LVna_TQyPuACZgA4ngJzzgIfJQJIdnLd9lCpOns';
        
        const Analytics = {
            supabase: null,
            userId: null,
            userEmail: null,
            SESSION_KEY: 'sos_user_session',

            init() {
                try {
                    this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    this.loadSession();
                    console.log('📊 Analytics initialisé');
                } catch (e) {
                    console.warn('Analytics non disponible:', e);
                }
            },

            loadSession() {
                const session = localStorage.getItem(this.SESSION_KEY);
                if (session) {
                    const data = JSON.parse(session);
                    this.userId = data.userId;
                    this.userEmail = data.email;
                }
            },

            saveSession(userId, email) {
                this.userId = userId;
                this.userEmail = email;
                localStorage.setItem(this.SESSION_KEY, JSON.stringify({ userId, email }));
            },

            isRegistered() {
                return !!this.userId;
            },

            // Inscription / Connexion utilisateur
            async registerUser(email, name = null) {
                if (!this.supabase) return null;
                
                try {
                    // Chercher si l'utilisateur existe
                    const { data: existing } = await this.supabase
                        .from('users')
                        .select('id')
                        .eq('email', email.toLowerCase())
                        .single();

                    if (existing) {
                        // Mise à jour last_login
                        await this.supabase
                            .from('users')
                            .update({ last_login: new Date().toISOString() })
                            .eq('id', existing.id);
                        
                        this.saveSession(existing.id, email);
                        return existing.id;
                    }

                    // Créer nouvel utilisateur
                    const { data: newUser, error } = await this.supabase
                        .from('users')
                        .insert({
                            email: email.toLowerCase(),
                            name: name,
                            plan: 'free'
                        })
                        .select('id')
                        .single();

                    if (error) throw error;
                    
                    this.saveSession(newUser.id, email);
                    console.log('✅ Utilisateur créé:', newUser.id);
                    return newUser.id;

                } catch (e) {
                    console.error('Erreur inscription:', e);
                    return null;
                }
            },

            // Tracker un contenu généré
            async trackContent(structure, platform, format, pillar = null, contentType = 'organic') {
                if (!this.supabase || !this.userId) return;

                try {
                    await this.supabase.from('contents').insert({
                        user_id: this.userId,
                        structure: structure,
                        platform: platform,
                        format: format,
                        pillar: pillar,
                        content_type: contentType
                    });

                    // Mettre à jour le compteur
                    await this.supabase.rpc('increment_user_contents', { user_id_param: this.userId });
                    
                    console.log('📊 Contenu tracké');
                } catch (e) {
                    console.warn('Erreur tracking:', e);
                }
            },

            // Tracker un événement
            async trackEvent(eventType, eventData = {}) {
                if (!this.supabase || !this.userId) return;

                try {
                    await this.supabase.from('events').insert({
                        user_id: this.userId,
                        event_type: eventType,
                        event_data: eventData
                    });
                } catch (e) {
                    console.warn('Erreur event:', e);
                }
            },

            // Utiliser un code promo
            async usePromoCode(code) {
                if (!this.supabase || !this.userId) {
                    return { success: false, message: 'Non connecté' };
                }

                try {
                    const { data, error } = await this.supabase
                        .rpc('use_promo_code', {
                            p_user_id: this.userId,
                            p_code: code.toUpperCase()
                        });

                    if (error) throw error;
                    
                    if (data && data[0]) {
                        return data[0];
                    }
                    return { success: false, message: 'Erreur inconnue' };

                } catch (e) {
                    console.error('Erreur code promo:', e);
                    return { success: false, message: e.message };
                }
            },

            // Vérifier le plan de l'utilisateur
            async getUserPlan() {
                if (!this.supabase || !this.userId) return 'free';

                try {
                    const { data } = await this.supabase
                        .from('users')
                        .select('plan')
                        .eq('id', this.userId)
                        .single();

                    return data?.plan || 'free';
                } catch (e) {
                    return 'free';
                }
            }
        };

        // Initialiser Analytics au chargement
        Analytics.init();

        // ==================== SYSTÈME DE PROGRESSION ====================
        const ProgressionSystem = {
            KEY: 'tithot_progression',
            
            getDefault() {
                return {
                    xp: 0,
                    level: 1,
                    totalContents: 0,
                    byPlatform: {},
                    byFormat: {},
                    badges: [],
                    streak: 0,
                    lastContentDate: null,
                    firstContentDate: null
                };
            },
            
            get() {
                return JSON.parse(localStorage.getItem(this.KEY)) || this.getDefault();
            },
            
            save(data) {
                localStorage.setItem(this.KEY, JSON.stringify(data));
            },
            
            // Ajouter XP et vérifier level up
            addXP(amount) {
                const data = this.get();
                data.xp += amount;
                const newLevel = Math.floor(data.xp / 100) + 1;
                const leveledUp = newLevel > data.level;
                data.level = newLevel;
                this.save(data);
                if (leveledUp) this.showLevelUp(newLevel);
                return leveledUp;
            },
            
            // Enregistrer un contenu créé
            trackContent(platform, format) {
                const data = this.get();
                const today = new Date().toDateString();
                
                // Premier contenu ?
                if (!data.firstContentDate) data.firstContentDate = new Date().toISOString();
                
                // Streak
                if (data.lastContentDate) {
                    const last = new Date(data.lastContentDate).toDateString();
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    if (last === yesterday) {
                        data.streak++;
                    } else if (last !== today) {
                        data.streak = 1;
                    }
                } else {
                    data.streak = 1;
                }
                data.lastContentDate = new Date().toISOString();
                
                // Compteurs
                data.totalContents++;
                data.byPlatform[platform] = (data.byPlatform[platform] || 0) + 1;
                data.byFormat[format] = (data.byFormat[format] || 0) + 1;
                
                this.save(data);
                this.addXP(10);
                this.checkBadges();
            },
            
            // Définition des badges
            BADGES: [
                { id: 'first', icon: '🌱', name: 'Premier Pas', desc: '1er contenu créé', check: d => d.totalContents >= 1 },
                { id: 'fire5', icon: '🔥', name: 'On Fire', desc: '5 contenus créés', check: d => d.totalContents >= 5 },
                { id: 'productive', icon: '⚡', name: 'Productif', desc: '20 contenus créés', check: d => d.totalContents >= 20 },
                { id: 'machine', icon: '🚀', name: 'Machine à contenu', desc: '50 contenus créés', check: d => d.totalContents >= 50 },
                { id: 'legend', icon: '👑', name: 'Légende', desc: '100 contenus créés', check: d => d.totalContents >= 100 },
                { id: 'carousel', icon: '🎠', name: 'Roi du Carousel', desc: '10 carousels', check: d => (d.byFormat['carousel'] || 0) >= 10 },
                { id: 'reel', icon: '🎬', name: 'Star du Reel', desc: '10 reels', check: d => (d.byFormat['reel'] || 0) >= 10 },
                { id: 'linkedin', icon: '💼', name: 'LinkedIn Master', desc: '20 posts LinkedIn', check: d => (d.byPlatform['linkedin'] || 0) >= 20 },
                { id: 'insta', icon: '📸', name: 'Insta Pro', desc: '20 posts Instagram', check: d => (d.byPlatform['instagram'] || 0) >= 20 },
                { id: 'streak7', icon: '🔥', name: 'Streak 7', desc: '7 jours consécutifs', check: d => d.streak >= 7 },
                { id: 'streak30', icon: '🌟', name: 'Streak 30', desc: '30 jours consécutifs', check: d => d.streak >= 30 }
            ],
            
            checkBadges() {
                const data = this.get();
                let newBadges = [];
                
                this.BADGES.forEach(badge => {
                    if (!data.badges.includes(badge.id) && badge.check(data)) {
                        data.badges.push(badge.id);
                        newBadges.push(badge);
                        data.xp += 25; // Bonus XP
                    }
                });
                
                this.save(data);
                newBadges.forEach(b => this.showBadgeUnlock(b));
            },
            
            showBadgeUnlock(badge) {
                const div = document.createElement('div');
                div.className = 'badge-unlock';
                div.innerHTML = `
                    <div class="badge-unlock-icon">${badge.icon}</div>
                    <div class="badge-unlock-text">
                        <strong>Badge débloqué !</strong>
                        <span>${badge.name}</span>
                    </div>
                `;
                document.body.appendChild(div);
                setTimeout(() => div.classList.add('show'), 100);
                setTimeout(() => { div.classList.remove('show'); setTimeout(() => div.remove(), 500); }, 3000);
            },
            
            showLevelUp(level) {
                showToast(`🎉 Niveau ${level} atteint !`);
            },
            
            // Afficher le modal stats
            showStats() {
                const data = this.get();
                const xpForNext = (data.level * 100) - data.xp % 100;
                const xpProgress = (data.xp % 100);
                
                let badgesHTML = this.BADGES.map(b => {
                    const unlocked = data.badges.includes(b.id);
                    return `<div class="stat-badge ${unlocked ? 'unlocked' : 'locked'}" title="${b.desc}">
                        <span class="stat-badge-icon">${b.icon}</span>
                        <span class="stat-badge-name">${b.name}</span>
                    </div>`;
                }).join('');
                
                const platformStats = Object.entries(data.byPlatform).map(([k,v]) => `<div class="stat-item"><span>${PLATFORMS[k]?.name || k}</span><strong>${v}</strong></div>`).join('') || '<p style="color:#999;">Aucun contenu</p>';
                const formatStats = Object.entries(data.byFormat).map(([k,v]) => `<div class="stat-item"><span>${FORMATS[k]?.name || k}</span><strong>${v}</strong></div>`).join('') || '<p style="color:#999;">Aucun contenu</p>';
                
                // Mode Agence
                const agencyData = AgencySystem.get();
                const agencySection = agencyData.isAgency 
                    ? `<div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="AgencySystem.showDashboard()" style="background: linear-gradient(135deg, #11998e, #38ef7d); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-family: inherit; font-weight: 600;">
                            📊 Dashboard Agence
                        </button>
                        <button onclick="AgencySystem.deactivate()" style="background: none; border: 2px solid #ff6b6b; color: #ff6b6b; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-family: inherit; font-weight: 600;">
                            ❌ Désactiver
                        </button>
                    </div>`
                    : `<button onclick="AgencySystem.showUnlockModal()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-family: inherit; font-weight: 600;">
                        🔐 Débloquer le Mode Agence
                    </button>`;
                
                document.getElementById('statsContent').innerHTML = `
                    <div class="stats-header">
                        <div class="stats-level">
                            <div class="stats-level-number">Niveau ${data.level}</div>
                            <div class="stats-xp-bar">
                                <div class="stats-xp-fill" style="width: ${xpProgress}%"></div>
                            </div>
                            <div class="stats-xp-text">${data.xp} XP • ${xpForNext} XP pour niveau ${data.level + 1}</div>
                        </div>
                        <div class="stats-streak">
                            <div class="stats-streak-number">${data.streak}</div>
                            <div class="stats-streak-label">🔥 Streak jours</div>
                        </div>
                    </div>
                    
                    <div class="stats-total">
                        <span class="stats-total-number">${data.totalContents}</span>
                        <span class="stats-total-label">contenus créés</span>
                    </div>
                    
                    <h3 style="margin: 20px 0 10px; color: #333;">🏆 Badges</h3>
                    <div class="stats-badges">${badgesHTML}</div>
                    
                    <h3 style="margin: 20px 0 10px; color: #333;">📱 Par plateforme</h3>
                    <div class="stats-grid">${platformStats}</div>
                    
                    <h3 style="margin: 20px 0 10px; color: #333;">🎬 Par format</h3>
                    <div class="stats-grid">${formatStats}</div>
                    
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 2px dashed #e0e0e0;">
                        <h3 style="margin: 0 0 15px; color: #333; text-align: center;">🏢 Mode Agence</h3>
                        <p style="color: #666; font-size: 0.9em; text-align: center; margin-bottom: 15px;">
                            Gérez plusieurs clients, importez des CSV, suivez vos productions.
                        </p>
                        <div style="text-align: center;">
                            ${agencySection}
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="document.getElementById('statsModal').classList.remove('show'); restartTour();" style="background: none; border: 2px dashed #667eea; color: #667eea; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-family: inherit; font-weight: 600; transition: all 0.3s;">
                            🎯 Refaire le tour guidé
                        </button>
                    </div>
                `;
                document.getElementById('statsModal').classList.add('show');
            }
        };

        // ==================== SYSTÈME FRAMEWORKS ====================
        const FrameworkSystem = {
            KEY: 'tithot_frameworks',
            currentTab: 'my',
            selectedFramework: null,
            editingSteps: [],

            // Méthodes de copywriting classiques (onglet "Par défaut")
            defaultFrameworks: [
                {
                    id: 'default_aida',
                    name: 'AIDA',
                    type: 'copywriting',
                    description: 'Attention, Intérêt, Désir, Action - Le grand classique du copywriting',
                    icon: '🎯',
                    color: '#f093fb',
                    is_default: true,
                    steps: [
                        { order: 1, name: 'Attention', description: "Capturer l'attention avec une accroche forte, une stat choc ou une question provocante" },
                        { order: 2, name: 'Intérêt', description: "Développer l'intérêt en présentant le problème ou l'opportunité" },
                        { order: 3, name: 'Désir', description: "Créer le désir en montrant la solution et ses bénéfices concrets" },
                        { order: 4, name: 'Action', description: "Appel à l'action clair et spécifique" }
                    ],
                    global_instructions: 'Ton direct et persuasif. Chaque étape doit naturellement mener à la suivante.',
                    usage_count: 0
                },
                {
                    id: 'default_pas',
                    name: 'PAS',
                    type: 'copywriting',
                    description: 'Problem, Agitate, Solve - Idéal pour créer de l\'urgence',
                    icon: '🔥',
                    color: '#ff6b6b',
                    is_default: true,
                    steps: [
                        { order: 1, name: 'Problem', description: "Identifier clairement le problème que ressent l'audience" },
                        { order: 2, name: 'Agitate', description: "Amplifier la douleur, montrer les conséquences de ne pas agir" },
                        { order: 3, name: 'Solve', description: "Présenter la solution comme le remède évident" }
                    ],
                    global_instructions: 'Empathique mais direct. Le lecteur doit se reconnaître dans le problème.',
                    usage_count: 0
                },
                {
                    id: 'default_soap',
                    name: 'SOAP',
                    type: 'copywriting',
                    description: 'Situation, Obstacle, Action, Résultat - Storytelling structuré',
                    icon: '📖',
                    color: '#9c27b0',
                    is_default: true,
                    steps: [
                        { order: 1, name: 'Situation', description: "Décrire le contexte initial, la situation de départ" },
                        { order: 2, name: 'Obstacle', description: "Le problème rencontré, le blocage, le défi" },
                        { order: 3, name: 'Action', description: "Ce qui a été fait pour surmonter l'obstacle" },
                        { order: 4, name: 'Résultat', description: "Le résultat obtenu, la transformation" }
                    ],
                    global_instructions: 'Raconter une vraie histoire. Être authentique et concret dans les détails.',
                    usage_count: 0
                },
                {
                    id: 'default_bab',
                    name: 'BAB',
                    type: 'copywriting',
                    description: 'Before, After, Bridge - Montrer la transformation',
                    icon: '🌉',
                    color: '#11998e',
                    is_default: true,
                    steps: [
                        { order: 1, name: 'Before', description: "Décrire la situation actuelle, les frustrations, les problèmes" },
                        { order: 2, name: 'After', description: "Peindre le tableau idéal, la vie après la solution" },
                        { order: 3, name: 'Bridge', description: "Expliquer comment passer de l'avant à l'après (votre solution)" }
                    ],
                    global_instructions: 'Créer un contraste fort entre Avant et Après. Le pont doit sembler naturel et accessible.',
                    usage_count: 0
                },
                {
                    id: 'default_4p',
                    name: '4P',
                    type: 'copywriting',
                    description: 'Promise, Picture, Proof, Push - Persuasion complète',
                    icon: '💪',
                    color: '#667eea',
                    is_default: true,
                    steps: [
                        { order: 1, name: 'Promise', description: "Faire une promesse forte et attrayante dès le début" },
                        { order: 2, name: 'Picture', description: "Peindre le tableau de ce que sera la vie après" },
                        { order: 3, name: 'Proof', description: "Apporter des preuves : témoignages, chiffres, études de cas" },
                        { order: 4, name: 'Push', description: "Pousser à l'action avec urgence ou rareté" }
                    ],
                    global_instructions: 'La promesse doit être crédible. Les preuves doivent être concrètes et vérifiables.',
                    usage_count: 0
                },
                {
                    id: 'default_storybrand',
                    name: 'StoryBrand',
                    type: 'copywriting',
                    description: 'La méthode de Donald Miller - Le client est le héros',
                    icon: '🦸',
                    color: '#f5576c',
                    is_default: true,
                    steps: [
                        { order: 1, name: 'Héros', description: "Identifier le héros (votre client) et ce qu'il veut" },
                        { order: 2, name: 'Problème', description: "Définir le problème externe, interne et philosophique" },
                        { order: 3, name: 'Guide', description: "Vous présentez comme le guide avec empathie et autorité" },
                        { order: 4, name: 'Plan', description: "Donner un plan simple en 3 étapes pour réussir" },
                        { order: 5, name: 'Action', description: "Appeler à l'action de façon claire et directe" },
                        { order: 6, name: 'Échec évité', description: "Montrer ce qui se passe s'il n'agit pas" },
                        { order: 7, name: 'Succès', description: "Décrire la transformation et le succès final" }
                    ],
                    global_instructions: 'Le client est TOUJOURS le héros, vous êtes le guide. Clarté avant tout.',
                    usage_count: 0
                },
                {
                    id: 'default_quest',
                    name: 'QUEST',
                    type: 'copywriting',
                    description: 'Qualify, Understand, Educate, Stimulate, Transition',
                    icon: '🧭',
                    color: '#ff9800',
                    is_default: true,
                    steps: [
                        { order: 1, name: 'Qualify', description: "Qualifier l'audience : est-ce pour toi ?" },
                        { order: 2, name: 'Understand', description: "Montrer que vous comprenez leurs problèmes" },
                        { order: 3, name: 'Educate', description: "Éduquer sur la solution et comment ça marche" },
                        { order: 4, name: 'Stimulate', description: "Stimuler l'envie d'agir, créer l'émotion" },
                        { order: 5, name: 'Transition', description: "Faciliter la transition vers l'action" }
                    ],
                    global_instructions: 'Idéal pour les audiences froides. Qualifier d\'abord pour gagner la confiance.',
                    usage_count: 0
                }
            ],

            // Bibliothèque complète de templates
            templateLibrary: [
                // === SCRIPTS CALL ===
                {
                    id: 'tpl_call_decouverte',
                    name: 'Script appel découverte',
                    type: 'script_call',
                    category: 'Scripts Call',
                    icon: '📞',
                    color: '#ef4444',
                    description: 'Structurer un appel de qualification en 15-20 min',
                    popular: true,
                    steps: [
                        { order: 1, name: 'Accroche', description: 'Créer le lien, référence commune, briser la glace (1-2 min)' },
                        { order: 2, name: 'Contexte', description: 'Comprendre sa situation actuelle, son rôle, son entreprise (3-4 min)' },
                        { order: 3, name: 'Douleur', description: 'Identifier le problème principal, les frustrations (3-4 min)' },
                        { order: 4, name: 'Impact', description: 'Quantifier les conséquences : temps perdu, argent, stress (2-3 min)' },
                        { order: 5, name: 'Solution', description: "Présenter comment tu peux aider, sans pitcher ton offre en détail (2-3 min)" },
                        { order: 6, name: 'Next step', description: "Proposer l'action suivante : démo, devis, second call (1-2 min)" }
                    ],
                    global_instructions: 'Ton conversationnel, pas de script robotique. Poser des questions ouvertes. Écouter plus que parler (ratio 70/30).'
                },
                {
                    id: 'tpl_call_demo',
                    name: 'Script démo produit',
                    type: 'script_call',
                    category: 'Scripts Call',
                    icon: '🖥️',
                    color: '#f97316',
                    description: 'Présenter ton produit/service de façon impactante',
                    steps: [
                        { order: 1, name: 'Récap besoins', description: "Résumer ce qu'on a compris de ses besoins lors du call découverte" },
                        { order: 2, name: 'Démo ciblée', description: 'Montrer uniquement les fonctionnalités qui répondent à SES problèmes' },
                        { order: 3, name: 'Cas client similaire', description: 'Partager un exemple concret de résultat obtenu' },
                        { order: 4, name: 'Objections', description: 'Anticiper et répondre aux freins potentiels' },
                        { order: 5, name: 'Proposition', description: "Présenter l'offre adaptée et le pricing" }
                    ],
                    global_instructions: 'Garder le prospect engagé. Poser des questions pendant la démo. Ne pas faire un monologue.'
                },
                {
                    id: 'tpl_call_closing',
                    name: 'Script closing',
                    type: 'script_call',
                    category: 'Scripts Call',
                    icon: '🤝',
                    color: '#22c55e',
                    description: 'Conclure la vente avec confiance',
                    steps: [
                        { order: 1, name: 'Récap valeur', description: "Résumer les bénéfices clés qu'il va obtenir" },
                        { order: 2, name: 'Validation', description: 'Confirmer que tout est clair, répondre aux dernières questions' },
                        { order: 3, name: 'Proposition ferme', description: "Annoncer clairement l'offre et le prix" },
                        { order: 4, name: 'Silence & écoute', description: 'Laisser le silence après la proposition, attendre sa réponse' }
                    ],
                    global_instructions: 'Confiance sans arrogance. Assumer le prix. Ne pas sur-justifier.'
                },
                {
                    id: 'tpl_call_relance',
                    name: 'Script relance prospect froid',
                    type: 'script_call',
                    category: 'Scripts Call',
                    icon: '🔄',
                    color: '#06b6d4',
                    description: 'Réactiver un prospect qui a ghosté',
                    steps: [
                        { order: 1, name: 'Rappel contexte', description: "Rappeler brièvement l'échange précédent sans reproches" },
                        { order: 2, name: 'Nouvelle valeur', description: 'Apporter un élément nouveau : cas client, actualité, insight' },
                        { order: 3, name: 'Question ouverte', description: 'Comprendre où il en est, ce qui a changé' },
                        { order: 4, name: 'Nouvelle proposition', description: 'Proposer une action simple et sans engagement' }
                    ],
                    global_instructions: 'Zéro culpabilisation. Curiosité sincère. Pas de "je voulais juste savoir si...".'
                },

                // === DM & MESSAGES ===
                {
                    id: 'tpl_dm_linkedin_first',
                    name: 'DM premier contact LinkedIn',
                    type: 'dm',
                    category: 'DM & Messages',
                    icon: '💬',
                    color: '#3b82f6',
                    description: 'Premier message après connexion LinkedIn',
                    popular: true,
                    steps: [
                        { order: 1, name: 'Personnalisation', description: 'Référence à un post, un projet, ou un point commun' },
                        { order: 2, name: 'Valeur immédiate', description: 'Partager une insight, une ressource, ou une observation utile' },
                        { order: 3, name: 'Question ouverte', description: 'Engager la conversation sans pitcher' },
                        { order: 4, name: 'Signature légère', description: 'Prénom uniquement, pas de pavé de signature' }
                    ],
                    global_instructions: 'Court (3-4 lignes max). Pas de pitch. Pas de lien. Humain et curieux.'
                },
                {
                    id: 'tpl_dm_post_connexion',
                    name: 'DM après connexion acceptée',
                    type: 'dm',
                    category: 'DM & Messages',
                    icon: '🤗',
                    color: '#8b5cf6',
                    description: 'Message de bienvenue sans être pushy',
                    steps: [
                        { order: 1, name: 'Remerciement', description: 'Remercier pour la connexion de façon naturelle' },
                        { order: 2, name: 'Contexte commun', description: "Mentionner ce qui vous a fait vous connecter (groupe, post, intérêt)" },
                        { order: 3, name: 'Question légère', description: 'Poser une question simple sur son activité ou un sujet commun' }
                    ],
                    global_instructions: 'Pas de pitch. Pas de lien vers ton calendly. Juste humain.'
                },
                {
                    id: 'tpl_dm_relance_soft',
                    name: 'Message de relance soft',
                    type: 'dm',
                    category: 'DM & Messages',
                    icon: '💭',
                    color: '#ec4899',
                    description: 'Relancer sans être lourd',
                    steps: [
                        { order: 1, name: 'Hook contextuel', description: "Rebondir sur une actualité, un post, ou un événement lié à lui" },
                        { order: 2, name: 'Rappel indirect', description: 'Faire un lien subtil avec votre échange précédent' },
                        { order: 3, name: 'Ouverture', description: 'Laisser la porte ouverte sans pression' }
                    ],
                    global_instructions: 'Ne pas mentionner explicitement la relance. Apporter de la valeur avant tout.'
                },
                {
                    id: 'tpl_dm_instagram',
                    name: 'DM Instagram influenceur/partenaire',
                    type: 'dm',
                    category: 'DM & Messages',
                    icon: '📸',
                    color: '#e11d48',
                    description: 'Contacter un influenceur ou partenaire potentiel',
                    steps: [
                        { order: 1, name: 'Compliment sincère', description: 'Mentionner un contenu spécifique que tu as aimé' },
                        { order: 2, name: 'Qui tu es', description: 'Te présenter en une phrase (pas un CV)' },
                        { order: 3, name: 'Proposition claire', description: 'Expliquer ce que tu proposes (collab, interview, etc.)' },
                        { order: 4, name: 'Bénéfice pour lui', description: "Montrer ce qu'il y gagne" }
                    ],
                    global_instructions: 'Court et direct. Pas de "je sais que tu es très occupé(e)...". Assumer ta demande.'
                },

                // === EMAILS ===
                {
                    id: 'tpl_email_cold',
                    name: 'Email de prospection cold',
                    type: 'email',
                    category: 'Emails',
                    icon: '📧',
                    color: '#f43f5e',
                    description: 'Premier email à un prospect froid',
                    popular: true,
                    steps: [
                        { order: 1, name: 'Objet accrocheur', description: 'Objet court, personnalisé, qui donne envie d\'ouvrir' },
                        { order: 2, name: 'Accroche personnalisée', description: 'Première phrase qui montre que tu as fait tes recherches' },
                        { order: 3, name: 'Problème/Opportunité', description: 'Identifier un pain point ou une opportunité spécifique' },
                        { order: 4, name: 'CTA simple', description: 'Une seule action demandée, facile à faire' }
                    ],
                    global_instructions: 'Max 100 mots. Pas de pièce jointe. Pas de "je me permets de...". Direct et respectueux.'
                },
                {
                    id: 'tpl_email_relance',
                    name: 'Email de relance',
                    type: 'email',
                    category: 'Emails',
                    icon: '🔁',
                    color: '#f97316',
                    description: 'Relancer un prospect sans être insistant',
                    steps: [
                        { order: 1, name: 'Rappel contexte', description: "Rappeler brièvement l'échange précédent" },
                        { order: 2, name: 'Nouvelle valeur', description: 'Apporter un élément nouveau : article, cas client, actualité' },
                        { order: 3, name: 'CTA reformulé', description: 'Proposer une action différente ou simplifiée' }
                    ],
                    global_instructions: 'Pas de culpabilisation. Ton léger. Apporter de la valeur même dans la relance.'
                },
                {
                    id: 'tpl_email_post_demo',
                    name: 'Email post-démo',
                    type: 'email',
                    category: 'Emails',
                    icon: '✅',
                    color: '#22c55e',
                    description: 'Email de suivi après une démo ou un call',
                    steps: [
                        { order: 1, name: 'Remerciement', description: 'Remercier pour le temps accordé' },
                        { order: 2, name: 'Récap personnalisé', description: 'Résumer les points clés discutés et ses besoins spécifiques' },
                        { order: 3, name: 'Ressources', description: 'Joindre les documents promis (présentation, cas client, etc.)' },
                        { order: 4, name: 'Prochaine étape', description: 'Rappeler le next step convenu et proposer une date' }
                    ],
                    global_instructions: 'Envoyer dans les 2h suivant le call. Personnaliser avec des éléments de la conversation.'
                },
                {
                    id: 'tpl_email_sequence',
                    name: 'Séquence nurturing 3 emails',
                    type: 'email',
                    category: 'Emails',
                    icon: '📬',
                    color: '#8b5cf6',
                    description: 'Séquence de 3 emails pour réchauffer un lead',
                    steps: [
                        { order: 1, name: 'Email 1 - Valeur pure', description: 'Donner sans rien demander : guide, checklist, conseil actionnable' },
                        { order: 2, name: 'Email 2 - Cas client', description: 'Montrer un résultat concret obtenu par un client similaire' },
                        { order: 3, name: 'Email 3 - Invitation', description: 'Proposer un échange : call, démo, audit gratuit' }
                    ],
                    global_instructions: 'Espacer de 3-4 jours entre chaque email. Personnaliser avec le prénom. Pas de pression.'
                },

                // === POSTS & CONTENUS ===
                {
                    id: 'tpl_post_storytelling',
                    name: 'Post LinkedIn storytelling',
                    type: 'post',
                    category: 'Posts & Contenus',
                    icon: '📝',
                    color: '#8b5cf6',
                    description: 'Post narratif avec une leçon business',
                    popular: true,
                    steps: [
                        { order: 1, name: 'Hook', description: 'Première ligne qui arrête le scroll. Chiffre, question, ou affirmation contre-intuitive.' },
                        { order: 2, name: 'Contexte', description: 'Planter le décor : qui, quand, où. En 2-3 lignes.' },
                        { order: 3, name: 'Conflit/Problème', description: "La tension, l'obstacle, ce qui n'allait pas." },
                        { order: 4, name: 'Résolution', description: 'Ce que tu as fait, appris, ou compris.' },
                        { order: 5, name: 'Leçon + CTA', description: 'La morale applicable par le lecteur + question ou invitation à commenter.' }
                    ],
                    global_instructions: 'Phrases courtes. Sauts de ligne. Pas de hashtags en plein milieu. Max 1300 caractères.'
                },
                {
                    id: 'tpl_post_educatif',
                    name: 'Post LinkedIn éducatif',
                    type: 'post',
                    category: 'Posts & Contenus',
                    icon: '🎓',
                    color: '#06b6d4',
                    description: 'Partager une expertise de façon claire',
                    steps: [
                        { order: 1, name: 'Hook problème', description: 'Commencer par le problème que ton audience rencontre' },
                        { order: 2, name: 'Framework/Méthode', description: 'Présenter ta méthode en 3-5 étapes claires' },
                        { order: 3, name: 'Exemple concret', description: 'Illustrer avec un cas réel ou un exemple parlant' },
                        { order: 4, name: 'CTA engagement', description: 'Inviter à sauvegarder, commenter, ou partager' }
                    ],
                    global_instructions: 'Utiliser des émojis comme puces. Numéroter les étapes. Facile à scanner.'
                },
                {
                    id: 'tpl_carousel',
                    name: 'Carrousel LinkedIn',
                    type: 'carousel',
                    category: 'Posts & Contenus',
                    icon: '🎠',
                    color: '#f97316',
                    description: 'Carrousel éducatif en 6-8 slides',
                    steps: [
                        { order: 1, name: 'Slide 1 - Cover', description: 'Titre accrocheur + promesse de valeur' },
                        { order: 2, name: 'Slide 2 - Problème', description: 'Identifier le problème ou la frustration' },
                        { order: 3, name: 'Slides 3-5 - Contenu', description: 'Les points clés, un par slide, avec visuel' },
                        { order: 4, name: 'Slide 6 - Récap', description: 'Résumer les points clés en une liste' },
                        { order: 5, name: 'Slide 7 - CTA', description: 'Appel à l\'action + rappel de qui tu es' },
                        { order: 6, name: 'Texte du post', description: 'Accroche + contexte + invitation à swiper' }
                    ],
                    global_instructions: 'Max 30 mots par slide. Visuel cohérent. Chaque slide doit donner envie de voir la suivante.'
                },
                {
                    id: 'tpl_thread_twitter',
                    name: 'Thread Twitter/X',
                    type: 'post',
                    category: 'Posts & Contenus',
                    icon: '🧵',
                    color: '#1d9bf0',
                    description: 'Thread viral en 5-7 tweets',
                    steps: [
                        { order: 1, name: 'Tweet 1 - Hook', description: 'Promesse forte + "Thread 🧵"' },
                        { order: 2, name: 'Tweet 2 - Contexte', description: 'Pourquoi ce sujet est important' },
                        { order: 3, name: 'Tweets 3-5 - Contenu', description: 'Les points clés, un par tweet, numérotés' },
                        { order: 4, name: 'Tweet 6 - Récap', description: 'Résumer en une liste' },
                        { order: 5, name: 'Tweet 7 - CTA', description: 'Demander RT + follow si utile' }
                    ],
                    global_instructions: 'Chaque tweet doit avoir de la valeur seul. Utiliser des émojis comme puces.'
                },

                // === AUTRES ===
                {
                    id: 'tpl_pitch_elevator',
                    name: 'Pitch elevator 30 sec',
                    type: 'other',
                    category: 'Autres',
                    icon: '🎯',
                    color: '#ec4899',
                    description: 'Se présenter efficacement en 30 secondes',
                    steps: [
                        { order: 1, name: 'Accroche', description: 'Une phrase qui capte l\'attention (stat, question, constat)' },
                        { order: 2, name: 'Problème', description: 'Le problème que tu résous pour ta cible' },
                        { order: 3, name: 'Solution', description: 'Ce que tu fais en une phrase simple' },
                        { order: 4, name: 'Preuve', description: 'Un résultat concret ou client notable' }
                    ],
                    global_instructions: 'Max 50 mots. Pas de jargon. Doit être compris par un enfant de 10 ans.'
                },
                {
                    id: 'tpl_video_courte',
                    name: 'Script vidéo courte (Reel/TikTok)',
                    type: 'other',
                    category: 'Autres',
                    icon: '🎬',
                    color: '#ef4444',
                    description: 'Script pour vidéo de 30-60 secondes',
                    steps: [
                        { order: 1, name: 'Hook (0-3s)', description: 'Phrase choc ou question qui stoppe le scroll' },
                        { order: 2, name: 'Setup (3-10s)', description: 'Poser le contexte ou le problème' },
                        { order: 3, name: 'Contenu (10-45s)', description: 'Les 2-3 points clés avec exemples' },
                        { order: 4, name: 'CTA (45-60s)', description: 'Appel à l\'action : follow, like, commentaire' }
                    ],
                    global_instructions: 'Parler vite mais clairement. Couper les silences. Sous-titres obligatoires.'
                },
                {
                    id: 'tpl_newsletter',
                    name: 'Structure newsletter',
                    type: 'newsletter',
                    category: 'Autres',
                    icon: '📰',
                    color: '#9c27b0',
                    description: 'Newsletter hebdomadaire engageante',
                    steps: [
                        { order: 1, name: 'Objet + Preview', description: 'Objet accrocheur + texte de preview qui donne envie d\'ouvrir' },
                        { order: 2, name: 'Intro personnelle', description: 'Anecdote, actualité perso, ou clin d\'oeil à la communauté' },
                        { order: 3, name: 'Contenu principal', description: 'Le sujet de la semaine : conseil, méthode, analyse' },
                        { order: 4, name: 'Ressource bonus', description: 'Un outil, un lien, un template offert' },
                        { order: 5, name: 'CTA + PS', description: 'Action à faire + PS avec info bonus ou rappel' }
                    ],
                    global_instructions: 'Écrire comme à un ami. Utiliser "tu". Pas de formalités excessives.'
                }
            ],

            // Catégories pour les filtres
            categories: ['Scripts Call', 'DM & Messages', 'Emails', 'Posts & Contenus', 'Autres'],

            typeLabels: {
                'script_call': '📞 Script Call',
                'dm': '💬 DM',
                'email': '📧 Email',
                'post': '📝 Post',
                'carousel': '🎠 Carousel',
                'newsletter': '📰 Newsletter',
                'copywriting': '✍️ Copywriting',
                'other': '📋 Autre'
            },

            typeColors: {
                'script_call': '#11998e',
                'dm': '#667eea',
                'email': '#f5576c',
                'post': '#f093fb',
                'carousel': '#ff9800',
                'newsletter': '#9c27b0',
                'copywriting': '#e91e63',
                'other': '#607d8b'
            },

            // Récupérer les frameworks de l'utilisateur
            getUserFrameworks() {
                try {
                    return JSON.parse(localStorage.getItem(this.KEY)) || [];
                } catch (e) {
                    return [];
                }
            },

            // Sauvegarder les frameworks
            saveUserFrameworks(frameworks) {
                localStorage.setItem(this.KEY, JSON.stringify(frameworks));
            },

            // Récupérer tous les frameworks (user + defaults)
            getAllFrameworks() {
                const userFrameworks = this.getUserFrameworks();
                return [...userFrameworks, ...this.defaultFrameworks];
            },

            // Récupérer un framework par ID
            getById(id) {
                return this.getAllFrameworks().find(f => f.id === id);
            },

            // ==================== UI LIBRARY ====================

            showLibrary() {
                this.currentTab = 'my';
                this.renderLibrary();
                document.getElementById('frameworkLibraryModal').classList.add('show');
            },

            closeLibrary() {
                document.getElementById('frameworkLibraryModal').classList.remove('show');
            },

            showTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('.framework-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`.framework-tab[data-tab="${tab}"]`).classList.add('active');
                this.renderLibrary();
            },

            renderLibrary() {
                const container = document.getElementById('frameworksContent');
                let frameworks = [];

                if (this.currentTab === 'my') {
                    frameworks = this.getUserFrameworks();
                    if (frameworks.length === 0) {
                        container.innerHTML = `
                            <div class="frameworks-empty" style="grid-column: 1/-1;">
                                <div class="frameworks-empty-icon">📐</div>
                                <h3>Aucun framework personnalisé</h3>
                                <p>Créez votre premier framework ou utilisez un template !</p>
                                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                                    <button class="btn btn-frameworks" onclick="FrameworkSystem.showEditor()" style="padding: 12px 25px;">
                                        ➕ Créer un framework
                                    </button>
                                    <button class="btn" onclick="FrameworkSystem.showTab('defaults')" style="padding: 12px 25px; background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                                        🌟 Voir les méthodes
                                    </button>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    container.innerHTML = frameworks.map(f => this.renderFrameworkCard(f, false)).join('');
                } else if (this.currentTab === 'defaults') {
                    // Affichage spécial pour les méthodes de copywriting
                    this.renderDefaultMethods(container);
                    return;
                } else if (this.currentTab === 'templates') {
                    this.renderTemplates(container);
                    return;
                }
            },

            renderDefaultMethods(container) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1;">
                        <div style="background: linear-gradient(135deg, #f8f9ff, #f0f4ff); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #e8ecff;">
                            <h3 style="margin: 0 0 8px; color: #333; display: flex; align-items: center; gap: 10px;">
                                ✍️ Méthodes de copywriting classiques
                            </h3>
                            <p style="margin: 0; color: #666; font-size: 0.95em;">
                                Ces frameworks éprouvés structurent vos contenus pour maximiser l'impact. Cliquez sur "Utiliser" pour les ajouter à vos frameworks personnalisés.
                            </p>
                        </div>
                        <div class="frameworks-grid">
                            ${this.defaultFrameworks.map(f => this.renderDefaultMethodCard(f)).join('')}
                        </div>
                    </div>
                `;
            },

            renderDefaultMethodCard(framework) {
                const stepsCount = framework.steps ? framework.steps.length : 0;
                const stepsPreview = framework.steps.map(s => s.name).join(' → ');

                return `
                    <div class="framework-card default-method-card" data-id="${framework.id}" style="border-color: ${framework.color}30;">
                        <div class="framework-card-header">
                            <span class="framework-card-icon">${framework.icon || '📝'}</span>
                            <span class="framework-card-type" style="background: ${framework.color}20; color: ${framework.color};">Copywriting</span>
                        </div>
                        <div class="framework-card-title" style="color: ${framework.color};">${framework.name}</div>
                        <div class="framework-card-desc">${framework.description || 'Pas de description'}</div>
                        <div style="background: #f8f9fa; padding: 10px 12px; border-radius: 8px; margin: 12px 0; font-size: 0.85em; color: #555;">
                            <strong>Structure :</strong> ${stepsPreview}
                        </div>
                        <div class="framework-card-meta" style="border-top: none; padding-top: 0;">
                            <span>${stepsCount} étapes</span>
                            <div class="framework-card-actions">
                                <button onclick="event.stopPropagation(); FrameworkSystem.showPreviewDefault('${framework.id}')" title="Prévisualiser" style="background: #f0f0f0; padding: 6px 10px; border-radius: 6px;">👁️</button>
                                <button onclick="event.stopPropagation(); FrameworkSystem.useDefaultMethod('${framework.id}')" class="btn-use-template" style="padding: 6px 12px !important;">
                                    ✅ Utiliser
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            showPreviewDefault(id) {
                const framework = this.defaultFrameworks.find(f => f.id === id);
                if (!framework) return;

                this.previewingTemplate = framework;

                document.getElementById('previewHeader').style.background = `linear-gradient(135deg, ${framework.color || '#667eea'}, ${this.adjustColor(framework.color || '#667eea', -20)})`;
                document.getElementById('previewIcon').textContent = framework.icon;
                document.getElementById('previewType').textContent = 'Méthode de copywriting';
                document.getElementById('previewTitle').textContent = framework.name;
                document.getElementById('previewDesc').textContent = framework.description;

                document.getElementById('previewSteps').innerHTML = framework.steps.map((step, i) => `
                    <div class="preview-step">
                        <div class="preview-step-number">${i + 1}</div>
                        <div class="preview-step-content">
                            <div class="preview-step-name">${step.name}</div>
                            <div class="preview-step-desc">${step.description}</div>
                        </div>
                    </div>
                `).join('');

                if (framework.global_instructions) {
                    document.getElementById('previewInstructionsSection').style.display = 'block';
                    document.getElementById('previewInstructions').textContent = framework.global_instructions;
                } else {
                    document.getElementById('previewInstructionsSection').style.display = 'none';
                }

                document.getElementById('previewUseBtn').onclick = () => {
                    this.useDefaultMethod(framework.id);
                    this.closePreview();
                };

                document.getElementById('templatePreviewModal').classList.add('show');
            },

            useDefaultMethod(id) {
                const method = this.defaultFrameworks.find(f => f.id === id);
                if (!method) return;

                const newFramework = {
                    id: 'fw_' + Date.now(),
                    name: method.name,
                    type: method.type,
                    description: method.description,
                    icon: method.icon,
                    color: method.color,
                    steps: method.steps.map(s => ({ ...s })),
                    global_instructions: method.global_instructions,
                    is_default: false,
                    usage_count: 0,
                    created_at: new Date().toISOString()
                };

                const frameworks = this.getUserFrameworks();
                frameworks.unshift(newFramework);
                this.saveUserFrameworks(frameworks);
                this.showTab('my');
                showToast(`✅ Méthode "${method.name}" ajoutée à vos frameworks !`);
            },

            renderFrameworkCard(framework, showDefaultBadge = true) {
                const typeLabel = this.typeLabels[framework.type] || framework.type;
                const typeColor = this.typeColors[framework.type] || '#667eea';
                const stepsCount = framework.steps ? framework.steps.length : 0;
                const isDefault = framework.is_default;

                return `
                    <div class="framework-card" data-id="${framework.id}" onclick="FrameworkSystem.selectFramework('${framework.id}')">
                        ${isDefault && showDefaultBadge ? '<span class="framework-default-badge">Par défaut</span>' : ''}
                        <div class="framework-card-header">
                            <span class="framework-card-icon">${framework.icon || '📝'}</span>
                            <span class="framework-card-type" style="background: ${typeColor}20; color: ${typeColor};">${typeLabel}</span>
                        </div>
                        <div class="framework-card-title">${framework.name}</div>
                        <div class="framework-card-desc">${framework.description || 'Pas de description'}</div>
                        <div class="framework-card-steps">
                            ${framework.steps.slice(0, 4).map(s => `<span class="framework-step-badge">${s.name}</span>`).join('')}
                            ${stepsCount > 4 ? `<span class="framework-step-badge">+${stepsCount - 4}</span>` : ''}
                        </div>
                        <div class="framework-card-meta">
                            <span>${stepsCount} étapes</span>
                            <div class="framework-card-actions">
                                ${!isDefault ? `
                                    <button onclick="event.stopPropagation(); FrameworkSystem.editFramework('${framework.id}')" title="Modifier">✏️</button>
                                    <button onclick="event.stopPropagation(); FrameworkSystem.deleteFramework('${framework.id}')" title="Supprimer">🗑️</button>
                                ` : `
                                    <button onclick="event.stopPropagation(); FrameworkSystem.duplicateFramework('${framework.id}')" title="Dupliquer">📋</button>
                                `}
                                <button onclick="event.stopPropagation(); FrameworkSystem.useFramework('${framework.id}')" title="Utiliser">✅</button>
                            </div>
                        </div>
                    </div>
                `;
            },

            currentCategory: 'all',
            previewingTemplate: null,
            importTab: 'json',

            renderTemplates(container) {
                const filteredTemplates = this.currentCategory === 'all'
                    ? this.templateLibrary
                    : this.templateLibrary.filter(t => t.category === this.currentCategory);

                const categoryCounts = {};
                this.templateLibrary.forEach(t => {
                    categoryCounts[t.category] = (categoryCounts[t.category] || 0) + 1;
                });

                container.innerHTML = `
                    <div style="grid-column: 1/-1;">
                        <div style="background: linear-gradient(135deg, #fff8e1, #ffecb3); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #ffe082;">
                            <h3 style="margin: 0 0 8px; color: #333; display: flex; align-items: center; gap: 10px;">
                                📋 Templates par type de contenu
                            </h3>
                            <p style="margin: 0; color: #666; font-size: 0.95em;">
                                Des modèles prêts à l'emploi pour chaque type de communication : scripts call, DM, emails, posts... Cliquez sur "Utiliser" pour les personnaliser.
                            </p>
                        </div>

                        <div class="category-filters">
                            <span class="category-chip ${this.currentCategory === 'all' ? 'active' : ''}"
                                  onclick="FrameworkSystem.filterByCategory('all')">
                                Tous<span class="template-count">(${this.templateLibrary.length})</span>
                            </span>
                            ${this.categories.map(cat => `
                                <span class="category-chip ${this.currentCategory === cat ? 'active' : ''}"
                                      onclick="FrameworkSystem.filterByCategory('${cat}')">
                                    ${cat}<span class="template-count">(${categoryCounts[cat] || 0})</span>
                                </span>
                            `).join('')}
                        </div>

                        <div class="template-library-grid">
                            ${filteredTemplates.map(t => `
                                <div class="template-lib-card ${t.popular ? 'popular' : ''}" data-id="${t.id}">
                                    <div class="template-lib-header">
                                        <span class="template-lib-icon">${t.icon}</span>
                                        <span class="template-lib-category">${t.category}</span>
                                    </div>
                                    <div class="template-lib-title">${t.name}</div>
                                    <div class="template-lib-desc">${t.description}</div>
                                    <div class="template-lib-steps">
                                        ${t.steps.slice(0, 4).map(s => `<span class="template-lib-step">${s.name}</span>`).join('')}
                                        ${t.steps.length > 4 ? `<span class="template-lib-step">+${t.steps.length - 4}</span>` : ''}
                                    </div>
                                    <div class="template-lib-footer">
                                        <span class="template-lib-meta">${t.steps.length} étapes</span>
                                        <div class="template-lib-actions">
                                            <button class="btn-preview-template" onclick="event.stopPropagation(); FrameworkSystem.showPreview('${t.id}')" title="Prévisualiser">👁️</button>
                                            <button class="btn-use-template" onclick="event.stopPropagation(); FrameworkSystem.useTemplateFromLibrary('${t.id}')">Utiliser</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            filterByCategory(category) {
                this.currentCategory = category;
                this.renderLibrary();
            },

            filterFrameworks(query) {
                const cards = document.querySelectorAll('.framework-card, .template-lib-card');
                const q = query.toLowerCase();
                cards.forEach(card => {
                    const title = card.querySelector('.framework-card-title, .template-lib-title')?.textContent.toLowerCase() || '';
                    const desc = card.querySelector('.framework-card-desc, .template-lib-desc')?.textContent.toLowerCase() || '';
                    card.style.display = (title.includes(q) || desc.includes(q)) ? '' : 'none';
                });
            },

            // ==================== PREVIEW ====================

            showPreview(templateId) {
                const template = this.templateLibrary.find(t => t.id === templateId);
                if (!template) return;

                this.previewingTemplate = template;

                // Update header
                document.getElementById('previewHeader').style.background = `linear-gradient(135deg, ${template.color || '#667eea'}, ${this.adjustColor(template.color || '#667eea', -20)})`;
                document.getElementById('previewIcon').textContent = template.icon;
                document.getElementById('previewType').textContent = this.typeLabels[template.type] || template.type;
                document.getElementById('previewTitle').textContent = template.name;
                document.getElementById('previewDesc').textContent = template.description;

                // Update steps
                document.getElementById('previewSteps').innerHTML = template.steps.map((step, i) => `
                    <div class="preview-step">
                        <div class="preview-step-number">${i + 1}</div>
                        <div class="preview-step-content">
                            <div class="preview-step-name">${step.name}</div>
                            <div class="preview-step-desc">${step.description}</div>
                        </div>
                    </div>
                `).join('');

                // Update instructions
                if (template.global_instructions) {
                    document.getElementById('previewInstructionsSection').style.display = 'block';
                    document.getElementById('previewInstructions').textContent = template.global_instructions;
                } else {
                    document.getElementById('previewInstructionsSection').style.display = 'none';
                }

                document.getElementById('templatePreviewModal').classList.add('show');
            },

            closePreview() {
                document.getElementById('templatePreviewModal').classList.remove('show');
                this.previewingTemplate = null;
            },

            usePreviewedTemplate() {
                if (this.previewingTemplate) {
                    this.useTemplateFromLibrary(this.previewingTemplate.id);
                    this.closePreview();
                }
            },

            useTemplateFromLibrary(templateId) {
                const template = this.templateLibrary.find(t => t.id === templateId);
                if (!template) return;

                const newFramework = {
                    id: 'fw_' + Date.now(),
                    name: template.name,
                    type: template.type,
                    description: template.description,
                    icon: template.icon,
                    color: template.color,
                    steps: [...template.steps],
                    global_instructions: template.global_instructions,
                    is_default: false,
                    usage_count: 0,
                    created_at: new Date().toISOString()
                };

                const frameworks = this.getUserFrameworks();
                frameworks.unshift(newFramework);
                this.saveUserFrameworks(frameworks);
                this.showTab('my');
                this.closePreview();
                showToast('✅ Template ajouté à vos frameworks !');
            },

            adjustColor(color, amount) {
                const clamp = (val) => Math.min(255, Math.max(0, val));
                const hex = color.replace('#', '');
                const r = clamp(parseInt(hex.substr(0, 2), 16) + amount);
                const g = clamp(parseInt(hex.substr(2, 2), 16) + amount);
                const b = clamp(parseInt(hex.substr(4, 2), 16) + amount);
                return `rgb(${r}, ${g}, ${b})`;
            },

            // ==================== IMPORT ====================
            importedFileContent: null,

            showImport() {
                document.getElementById('importJsonText').value = '';
                document.getElementById('importResult').style.display = 'none';
                this.importedFileContent = null;
                this.switchImportTab('excel');
                document.getElementById('frameworkImportModal').classList.add('show');
            },

            closeImport() {
                document.getElementById('frameworkImportModal').classList.remove('show');
            },

            switchImportTab(tab) {
                this.importTab = tab;
                document.querySelectorAll('.import-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`.import-tab[data-tab="${tab}"]`)?.classList.add('active');
                document.getElementById('importTabExcel').style.display = tab === 'excel' ? 'block' : 'none';
                document.getElementById('importTabJson').style.display = tab === 'json' ? 'block' : 'none';
                document.getElementById('importResult').style.display = 'none';
            },

            handleFileImport(event, type) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();

                if (type === 'json') {
                    reader.onload = (e) => {
                        document.getElementById('importJsonText').value = e.target.result;
                    };
                    reader.readAsText(file);
                } else if (type === 'excel') {
                    // Pour Excel/CSV, on lit comme texte (CSV) ou on affiche un message
                    const fileName = file.name.toLowerCase();
                    if (fileName.endsWith('.csv')) {
                        reader.onload = (e) => {
                            this.importedFileContent = e.target.result;
                            const resultEl = document.getElementById('importResult');
                            resultEl.className = 'import-result success';
                            resultEl.innerHTML = `✅ Fichier "${file.name}" chargé. Cliquez sur Importer pour continuer.`;
                            resultEl.style.display = 'block';
                        };
                        reader.readAsText(file);
                    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        // Pour les fichiers Excel, on a besoin de SheetJS
                        // On va utiliser une approche simplifiée
                        const resultEl = document.getElementById('importResult');
                        resultEl.className = 'import-result error';
                        resultEl.innerHTML = `⚠️ Les fichiers Excel (.xlsx) nécessitent une conversion. Veuillez exporter votre fichier en CSV depuis Excel (Fichier → Enregistrer sous → CSV).`;
                        resultEl.style.display = 'block';
                    }
                }
            },

            processImport() {
                const resultEl = document.getElementById('importResult');
                resultEl.style.display = 'none';

                try {
                    let framework;
                    if (this.importTab === 'json') {
                        framework = this.parseJsonImport();
                    } else if (this.importTab === 'excel') {
                        framework = this.parseExcelCsvImport();
                    }

                    if (!framework) {
                        throw new Error('Aucune donnée à importer. Veuillez sélectionner un fichier.');
                    }

                    // Validate
                    if (!framework.name) framework.name = 'Framework importé';
                    if (!framework.type) framework.type = 'other';
                    if (!framework.steps || framework.steps.length === 0) {
                        throw new Error('Le framework doit contenir au moins une étape');
                    }

                    // Complete the framework
                    framework.id = 'fw_' + Date.now();
                    framework.is_default = false;
                    framework.usage_count = 0;
                    framework.created_at = new Date().toISOString();
                    framework.icon = framework.icon || '📝';
                    framework.color = framework.color || '#667eea';

                    // Save
                    const frameworks = this.getUserFrameworks();
                    frameworks.unshift(framework);
                    this.saveUserFrameworks(frameworks);

                    resultEl.className = 'import-result success';
                    resultEl.innerHTML = `✅ Framework "${framework.name}" importé avec succès ! (${framework.steps.length} étapes)`;
                    resultEl.style.display = 'block';

                    setTimeout(() => {
                        this.closeImport();
                        this.showTab('my');
                        this.renderLibrary();
                    }, 1500);

                } catch (error) {
                    resultEl.className = 'import-result error';
                    resultEl.innerHTML = `❌ Erreur : ${error.message}`;
                    resultEl.style.display = 'block';
                }
            },

            parseJsonImport() {
                const text = document.getElementById('importJsonText').value.trim();
                if (!text) return null;

                const data = JSON.parse(text);

                // Normalize steps
                if (data.steps) {
                    data.steps = data.steps.map((s, i) => ({
                        order: i + 1,
                        name: s.name || s.nom || `Étape ${i + 1}`,
                        description: s.description || s.desc || ''
                    }));
                }

                return data;
            },

            parseExcelCsvImport() {
                const text = this.importedFileContent;
                if (!text) return null;

                const lines = text.split('\n').filter(l => l.trim());
                if (lines.length < 2) throw new Error('Le fichier doit contenir au moins une ligne d\'en-tête et une étape');

                // Détecte le délimiteur (;, , ou tab)
                const firstLine = lines[0];
                let delimiter = ';';
                if (firstLine.includes('\t')) delimiter = '\t';
                else if (firstLine.includes(',') && !firstLine.includes(';')) delimiter = ',';

                const headers = firstLine.split(delimiter).map(h => h.trim().toLowerCase().replace(/"/g, ''));

                const nameCol = headers.findIndex(h => h.includes('name') || h.includes('nom') || h.includes('step') || h.includes('étape'));
                const descCol = headers.findIndex(h => h.includes('desc'));

                if (nameCol === -1) throw new Error('Colonne "step_name" ou "nom" non trouvée dans le fichier');

                const steps = [];
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(delimiter).map(c => c.trim().replace(/"/g, ''));
                    const name = cols[nameCol]?.trim();
                    if (name) {
                        steps.push({
                            order: steps.length + 1,
                            name: name,
                            description: descCol >= 0 ? (cols[descCol]?.trim() || '') : ''
                        });
                    }
                }

                return {
                    name: 'Framework importé',
                    type: 'other',
                    steps: steps
                };
            },

            selectFramework(id) {
                document.querySelectorAll('.framework-card').forEach(c => c.classList.remove('selected'));
                document.querySelector(`.framework-card[data-id="${id}"]`)?.classList.add('selected');
                this.selectedFramework = id;
            },

            useFramework(id) {
                this.selectedFramework = id;
                this.closeLibrary();
                this.updateQuickSelector();
                showToast('✅ Framework sélectionné !');
            },

            // ==================== EDITOR ====================

            showEditor(frameworkId = null) {
                const isEdit = !!frameworkId;
                document.getElementById('frameworkEditorTitle').textContent = isEdit ? '✏️ Modifier le framework' : '➕ Créer un framework';

                // Reset form
                document.getElementById('frameworkForm').reset();
                document.getElementById('frameworkId').value = '';
                this.editingSteps = [];

                // Reset type selection
                document.querySelectorAll('.framework-type-chip').forEach(c => c.classList.remove('active'));
                document.querySelector('.framework-type-chip[data-type="script_call"]').classList.add('active');

                // Reset icon selection
                document.querySelectorAll('.icon-option').forEach(i => i.classList.remove('active'));
                document.querySelector('.icon-option[data-icon="📝"]').classList.add('active');

                if (isEdit) {
                    const framework = this.getById(frameworkId);
                    if (framework) {
                        document.getElementById('frameworkId').value = framework.id;
                        document.getElementById('frameworkName').value = framework.name;
                        document.getElementById('frameworkDescription').value = framework.description || '';
                        document.getElementById('frameworkInstructions').value = framework.global_instructions || '';
                        document.getElementById('frameworkColor').value = framework.color || '#11998e';

                        // Set type
                        document.querySelectorAll('.framework-type-chip').forEach(c => c.classList.remove('active'));
                        document.querySelector(`.framework-type-chip[data-type="${framework.type}"]`)?.classList.add('active');

                        // Set icon
                        document.querySelectorAll('.icon-option').forEach(i => i.classList.remove('active'));
                        document.querySelector(`.icon-option[data-icon="${framework.icon}"]`)?.classList.add('active');

                        // Set steps
                        this.editingSteps = [...framework.steps];
                    }
                } else {
                    // Default 2 empty steps
                    this.editingSteps = [
                        { order: 1, name: '', description: '' },
                        { order: 2, name: '', description: '' }
                    ];
                }

                this.renderSteps();
                this.initEditorEvents();
                document.getElementById('frameworkEditorModal').classList.add('show');
            },

            closeEditor() {
                document.getElementById('frameworkEditorModal').classList.remove('show');
            },

            initEditorEvents() {
                // Type selection
                document.querySelectorAll('.framework-type-chip').forEach(chip => {
                    chip.onclick = () => {
                        document.querySelectorAll('.framework-type-chip').forEach(c => c.classList.remove('active'));
                        chip.classList.add('active');
                    };
                });

                // Icon selection
                document.querySelectorAll('.icon-option').forEach(icon => {
                    icon.onclick = () => {
                        document.querySelectorAll('.icon-option').forEach(i => i.classList.remove('active'));
                        icon.classList.add('active');
                    };
                });

                // Drag and drop for steps
                this.initDragDrop();
            },

            renderSteps() {
                const container = document.getElementById('stepsList');
                container.innerHTML = this.editingSteps.map((step, index) => `
                    <div class="step-item" draggable="true" data-index="${index}">
                        <span class="step-item-drag">⋮⋮</span>
                        <div class="step-item-number">${index + 1}</div>
                        <div class="step-item-content">
                            <input type="text" class="step-item-name" placeholder="Nom de l'étape (ex: Accroche)"
                                   value="${step.name || ''}" onchange="FrameworkSystem.updateStep(${index}, 'name', this.value)">
                            <textarea class="step-item-desc" placeholder="Description (ex: Créer le lien, référence commune)"
                                      onchange="FrameworkSystem.updateStep(${index}, 'description', this.value)">${step.description || ''}</textarea>
                        </div>
                        <button type="button" class="step-item-delete" onclick="FrameworkSystem.removeStep(${index})" ${this.editingSteps.length <= 1 ? 'disabled style="opacity:0.3"' : ''}>🗑️</button>
                    </div>
                `).join('');

                this.initDragDrop();
            },

            addStep() {
                this.editingSteps.push({
                    order: this.editingSteps.length + 1,
                    name: '',
                    description: ''
                });
                this.renderSteps();
            },

            removeStep(index) {
                if (this.editingSteps.length > 1) {
                    this.editingSteps.splice(index, 1);
                    this.editingSteps.forEach((s, i) => s.order = i + 1);
                    this.renderSteps();
                }
            },

            updateStep(index, field, value) {
                this.editingSteps[index][field] = value;
            },

            initDragDrop() {
                const container = document.getElementById('stepsList');
                const items = container.querySelectorAll('.step-item');
                let draggedItem = null;

                items.forEach(item => {
                    item.addEventListener('dragstart', () => {
                        draggedItem = item;
                        item.classList.add('dragging');
                    });

                    item.addEventListener('dragend', () => {
                        item.classList.remove('dragging');
                        draggedItem = null;
                        this.reorderSteps();
                    });

                    item.addEventListener('dragover', e => {
                        e.preventDefault();
                        if (draggedItem && draggedItem !== item) {
                            const rect = item.getBoundingClientRect();
                            const midY = rect.top + rect.height / 2;
                            if (e.clientY < midY) {
                                container.insertBefore(draggedItem, item);
                            } else {
                                container.insertBefore(draggedItem, item.nextSibling);
                            }
                        }
                    });
                });
            },

            reorderSteps() {
                const items = document.querySelectorAll('.step-item');
                const newOrder = [];
                items.forEach((item, index) => {
                    const oldIndex = parseInt(item.dataset.index);
                    newOrder.push({ ...this.editingSteps[oldIndex], order: index + 1 });
                });
                this.editingSteps = newOrder;
                this.renderSteps();
            },

            saveFramework() {
                const id = document.getElementById('frameworkId').value;
                const name = document.getElementById('frameworkName').value.trim();
                const description = document.getElementById('frameworkDescription').value.trim();
                const instructions = document.getElementById('frameworkInstructions').value.trim();
                const color = document.getElementById('frameworkColor').value;
                const type = document.querySelector('.framework-type-chip.active')?.dataset.type || 'post';
                const icon = document.querySelector('.icon-option.active')?.dataset.icon || '📝';

                // Validation
                if (!name) {
                    showToast('❌ Veuillez entrer un nom');
                    return;
                }

                const validSteps = this.editingSteps.filter(s => s.name.trim());
                if (validSteps.length === 0) {
                    showToast('❌ Ajoutez au moins une étape avec un nom');
                    return;
                }

                const framework = {
                    id: id || 'fw_' + Date.now(),
                    name,
                    type,
                    description,
                    icon,
                    color,
                    steps: validSteps.map((s, i) => ({ ...s, order: i + 1 })),
                    global_instructions: instructions,
                    is_default: false,
                    usage_count: 0,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                const frameworks = this.getUserFrameworks();
                const existingIndex = frameworks.findIndex(f => f.id === framework.id);

                if (existingIndex >= 0) {
                    framework.usage_count = frameworks[existingIndex].usage_count;
                    frameworks[existingIndex] = framework;
                } else {
                    frameworks.unshift(framework);
                }

                this.saveUserFrameworks(frameworks);
                this.closeEditor();
                this.renderLibrary();
                this.updateQuickSelector();
                showToast('✅ Framework enregistré !');
            },

            editFramework(id) {
                this.showEditor(id);
            },

            deleteFramework(id) {
                if (!confirm('Supprimer ce framework ?')) return;
                const frameworks = this.getUserFrameworks().filter(f => f.id !== id);
                this.saveUserFrameworks(frameworks);
                this.renderLibrary();
                this.updateQuickSelector();
                showToast('🗑️ Framework supprimé');
            },

            duplicateFramework(id) {
                const original = this.getById(id);
                if (!original) return;

                const copy = {
                    ...original,
                    id: 'fw_' + Date.now(),
                    name: original.name + ' (copie)',
                    is_default: false,
                    usage_count: 0,
                    created_at: new Date().toISOString()
                };

                const frameworks = this.getUserFrameworks();
                frameworks.unshift(copy);
                this.saveUserFrameworks(frameworks);
                this.renderLibrary();
                showToast('📋 Framework dupliqué !');
            },

            useTemplate(type) {
                const defaultFw = this.defaultFrameworks.find(f => f.type === type);
                if (defaultFw) {
                    this.duplicateFramework(defaultFw.id);
                    this.showTab('my');
                } else {
                    this.showEditor();
                    document.querySelectorAll('.framework-type-chip').forEach(c => c.classList.remove('active'));
                    document.querySelector(`.framework-type-chip[data-type="${type}"]`)?.classList.add('active');
                }
            },

            // ==================== QUICK SELECTOR (for generation) ====================

            updateQuickSelector() {
                const container = document.getElementById('frameworkQuickSelect');
                if (!container) return;

                const frameworks = this.getAllFrameworks().slice(0, 5);
                container.innerHTML = `
                    <div class="framework-quick-chip none ${!this.selectedFramework ? 'active' : ''}"
                         onclick="FrameworkSystem.quickSelect(null)">
                        🚫 Sans framework
                    </div>
                    ${frameworks.map(f => `
                        <div class="framework-quick-chip ${this.selectedFramework === f.id ? 'active' : ''}"
                             onclick="FrameworkSystem.quickSelect('${f.id}')"
                             style="border-color: ${f.color}20;">
                            ${f.icon} ${f.name}
                        </div>
                    `).join('')}
                `;
            },

            quickSelect(id) {
                this.selectedFramework = id;
                this.updateQuickSelector();
            },

            getSelectedFramework() {
                return this.selectedFramework ? this.getById(this.selectedFramework) : null;
            },

            // Génère le prompt pour l'IA basé sur le framework
            getPromptInstructions() {
                const framework = this.getSelectedFramework();
                if (!framework) return '';

                let prompt = `\n\n📐 FRAMEWORK À SUIVRE : "${framework.name}"\n`;
                prompt += `Génère le contenu en suivant EXACTEMENT cette structure :\n\n`;

                framework.steps.forEach((step, i) => {
                    prompt += `**Étape ${i + 1} - ${step.name}** : ${step.description}\n`;
                });

                if (framework.global_instructions) {
                    prompt += `\n📋 CONSIGNES : ${framework.global_instructions}\n`;
                }

                prompt += `\nChaque étape doit être clairement identifiable dans ta réponse avec le format :\n`;
                prompt += `📌 [NOM DE L'ÉTAPE]\n[Contenu de l'étape]\n`;

                return prompt;
            },

            // Incrémente le compteur d'usage
            incrementUsage(id) {
                const frameworks = this.getUserFrameworks();
                const fw = frameworks.find(f => f.id === id);
                if (fw) {
                    fw.usage_count = (fw.usage_count || 0) + 1;
                    this.saveUserFrameworks(frameworks);
                }
            }
        };

        // ==================== SYSTÈME AGENCE ====================
        const AgencySystem = {
            KEY: 'tithot_agency',
            SECRET_CODE: 'AGENCY2025', // ← Code à changer quand tu veux
            
            getDefault() {
                return {
                    isAgency: false,
                    clientProfiles: {}, // {clientId: {name, domaine, piliers, audience, plateformes, style, notes}}
                    currentClientId: null,
                    contents: [], // {id, date, clientId, platform, format, structure, preview}
                    rgpdConsent: false,
                    rgpdConsentDate: null
                };
            },
            
            get() {
                const stored = JSON.parse(localStorage.getItem(this.KEY));
                if (!stored) return this.getDefault();
                // Merger avec les valeurs par défaut pour éviter les undefined
                const defaults = this.getDefault();
                return {
                    isAgency: stored.isAgency ?? defaults.isAgency,
                    clientProfiles: stored.clientProfiles || defaults.clientProfiles,
                    currentClientId: stored.currentClientId ?? defaults.currentClientId,
                    contents: stored.contents || defaults.contents,
                    rgpdConsent: stored.rgpdConsent ?? defaults.rgpdConsent,
                    rgpdConsentDate: stored.rgpdConsentDate ?? defaults.rgpdConsentDate
                };
            },
            
            save(data) {
                localStorage.setItem(this.KEY, JSON.stringify(data));
            },
            
            // Générer un ID unique
            generateId() {
                return 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            },
            
            // RGPD : Obtenir consentement
            showRGPDConsent(callback) {
                document.getElementById('rgpdModal').classList.add('show');
                window.rgpdCallback = callback;
            },
            
            acceptRGPD() {
                const data = this.get();
                data.rgpdConsent = true;
                data.rgpdConsentDate = new Date().toISOString();
                this.save(data);
                document.getElementById('rgpdModal').classList.remove('show');
                if (window.rgpdCallback) window.rgpdCallback();
            },
            
            declineRGPD() {
                document.getElementById('rgpdModal').classList.remove('show');
                showToast('❌ Import annulé');
            },
            
            // Supprimer toutes les données (RGPD)
            deleteAllData() {
                if (confirm('⚠️ Supprimer TOUTES les données clients ? Cette action est irréversible.')) {
                    const data = this.get();
                    data.clientProfiles = {};
                    data.currentClientId = null;
                    data.contents = [];
                    this.save(data);
                    this.updateUI();
                    showToast('🗑️ Toutes les données clients supprimées');
                }
            },
            
            // Modal pour entrer le code
            showUnlockModal() {
                document.getElementById('agencyCodeModal').classList.add('show');
                document.getElementById('agencyCodeInput').value = '';
                document.getElementById('agencyCodeError').style.display = 'none';
                document.getElementById('agencyCodeInput').focus();
            },
            
            closeUnlockModal() {
                document.getElementById('agencyCodeModal').classList.remove('show');
            },
            
            validateCode() {
                const input = document.getElementById('agencyCodeInput').value.trim().toUpperCase();
                if (input === this.SECRET_CODE) {
                    this.toggleAgencyMode(true);
                    this.closeUnlockModal();
                    document.getElementById('statsModal').classList.remove('show');
                    showToast('🏢 Mode Agence activé !');
                } else {
                    document.getElementById('agencyCodeError').style.display = 'block';
                    document.getElementById('agencyCodeInput').classList.add('shake');
                    setTimeout(() => document.getElementById('agencyCodeInput').classList.remove('shake'), 500);
                }
            },
            
            deactivate() {
                if (confirm('Désactiver le mode Agence ? Vos données clients seront conservées.')) {
                    this.toggleAgencyMode(false);
                    document.getElementById('statsModal').classList.remove('show');
                    showToast('Mode Agence désactivé');
                }
            },
            
            toggleAgencyMode(enabled) {
                const data = this.get();
                data.isAgency = enabled;
                this.save(data);
                this.updateUI();
            },
            
            isAgencyMode() {
                return this.get().isAgency;
            },
            
            // ==================== GESTION PROFILS CLIENTS ====================
            
            // Générer les grilles dynamiques pour le formulaire client
            buildClientFormGrids() {
                // Public cible
                document.getElementById('clientPublicCibleGrid').innerHTML = ONBOARDING_OPTIONS.publicCible.map(p => `
                    <label class="checkbox-card">
                        <input type="checkbox" name="clientPublicCible" value="${p.value}">
                        <span class="checkbox-content"><span class="checkbox-icon">${p.icon}</span><span class="checkbox-label">${p.label}</span></span>
                    </label>
                `).join('');
                
                // Tranche d'âge (checkboxes pour choix multiple)
                document.getElementById('clientTrancheAgeGrid').innerHTML = ONBOARDING_OPTIONS.trancheAge.map(t => `
                    <label class="checkbox-card">
                        <input type="checkbox" name="clientTrancheAge" value="${t.value}">
                        <span class="checkbox-content"><span class="checkbox-label">${t.label}</span></span>
                    </label>
                `).join('');
                
                // Plateformes
                document.getElementById('clientPlateformesGrid').innerHTML = ONBOARDING_OPTIONS.plateformes.map(p => `
                    <label class="checkbox-card">
                        <input type="checkbox" name="clientPlateformes" value="${p.value}">
                        <span class="checkbox-content"><span class="checkbox-icon">${p.icon}</span><span class="checkbox-label">${p.label}</span></span>
                    </label>
                `).join('');
                
                // Formats
                document.getElementById('clientFormatsGrid').innerHTML = ONBOARDING_OPTIONS.formats.map(f => `
                    <label class="checkbox-card">
                        <input type="checkbox" name="clientFormats" value="${f.value}">
                        <span class="checkbox-content"><span class="checkbox-icon">${f.icon}</span><span class="checkbox-label">${f.label}</span></span>
                    </label>
                `).join('');
                
                // Style
                document.getElementById('clientStyleGrid').innerHTML = ONBOARDING_OPTIONS.styles.map(s => `
                    <label class="radio-card radio-card-compact">
                        <input type="radio" name="clientStyle" value="${s.value}">
                        <span class="radio-content"><span class="radio-icon">${s.icon}</span><span class="radio-label">${s.label}</span></span>
                    </label>
                `).join('');
                
                // Objectif
                document.getElementById('clientObjectifGrid').innerHTML = ONBOARDING_OPTIONS.objectifs.map(o => `
                    <label class="radio-card radio-card-compact">
                        <input type="radio" name="clientObjectif" value="${o.value}">
                        <span class="radio-content"><span class="radio-icon">${o.icon}</span><span class="radio-label">${o.label}</span></span>
                    </label>
                `).join('');
            },
            
            // Ouvrir modal ajout/édition client
            showClientModal(clientId = null) {
                const modal = document.getElementById('clientProfileModal');
                
                // Construire les grilles si pas déjà fait
                if (!document.getElementById('clientPublicCibleGrid').innerHTML) {
                    this.buildClientFormGrids();
                }
                
                // Reset toutes les checkboxes et radios
                modal.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                modal.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
                
                if (clientId) {
                    // Mode édition
                    const data = this.get();
                    const client = data.clientProfiles[clientId];
                    if (!client) return;
                    
                    document.getElementById('clientModalTitle').textContent = '✏️ ' + client.name;
                    document.getElementById('clientProfileId').value = clientId;
                    document.getElementById('clientName').value = client.name || '';
                    document.getElementById('clientDomaine').value = client.domaine || '';
                    document.getElementById('clientMessageUnique').value = client.messageUnique || '';
                    document.getElementById('clientPiliers').value = (client.piliers || []).join(', ');
                    document.getElementById('clientTags').value = client.tags || '';
                    document.getElementById('clientAudience').value = client.audience || '';
                    document.getElementById('clientNotes').value = client.notes || '';
                    
                    // Cocher les checkboxes
                    (client.publicCible || []).forEach(v => {
                        const cb = modal.querySelector(`input[name="clientPublicCible"][value="${v}"]`);
                        if (cb) cb.checked = true;
                    });
                    (client.plateformes || []).forEach(v => {
                        const cb = modal.querySelector(`input[name="clientPlateformes"][value="${v}"]`);
                        if (cb) cb.checked = true;
                    });
                    (client.formats || []).forEach(v => {
                        const cb = modal.querySelector(`input[name="clientFormats"][value="${v}"]`);
                        if (cb) cb.checked = true;
                    });
                    // Tranches d'âge (maintenant checkboxes)
                    (client.trancheAge || []).forEach(v => {
                        const cb = modal.querySelector(`input[name="clientTrancheAge"][value="${v}"]`);
                        if (cb) cb.checked = true;
                    });
                    
                    // Cocher les radios
                    if (client.style) {
                        const r = modal.querySelector(`input[name="clientStyle"][value="${client.style}"]`);
                        if (r) r.checked = true;
                    }
                    if (client.objectif) {
                        const r = modal.querySelector(`input[name="clientObjectif"][value="${client.objectif}"]`);
                        if (r) r.checked = true;
                    }
                    
                    // Charger les samples de voix
                    this._tempClientVoiceSamples = client.voiceSamples ? [...client.voiceSamples] : [];
                } else {
                    // Mode création
                    document.getElementById('clientModalTitle').textContent = '➕ Nouveau client';
                    document.getElementById('clientProfileId').value = '';
                    document.getElementById('clientProfileForm').reset();
                    this._tempClientVoiceSamples = [];
                }
                
                // Mettre à jour l'UI de la voix
                this.updateClientVoiceUI();
                document.getElementById('clientVoiceNewSample').value = '';
                
                modal.classList.add('show');
            },
            
            closeClientModal() {
                document.getElementById('clientProfileModal').classList.remove('show');
            },
            
            // Sauvegarder profil client enrichi
            saveClientProfile() {
                const modal = document.getElementById('clientProfileModal');
                const clientId = document.getElementById('clientProfileId').value || this.generateId();
                
                // Récupérer l'ancien profil pour garder la voix si elle existe
                const data = this.get();
                const existingProfile = data.clientProfiles[clientId] || {};
                
                const profile = {
                    name: document.getElementById('clientName').value.trim(),
                    domaine: document.getElementById('clientDomaine').value.trim(),
                    messageUnique: document.getElementById('clientMessageUnique').value.trim(),
                    piliers: document.getElementById('clientPiliers').value.split(',').map(p => p.trim()).filter(p => p),
                    tags: document.getElementById('clientTags').value.trim(),
                    audience: document.getElementById('clientAudience').value.trim(),
                    notes: document.getElementById('clientNotes').value.trim(),
                    publicCible: Array.from(modal.querySelectorAll('input[name="clientPublicCible"]:checked')).map(cb => cb.value),
                    plateformes: Array.from(modal.querySelectorAll('input[name="clientPlateformes"]:checked')).map(cb => cb.value),
                    formats: Array.from(modal.querySelectorAll('input[name="clientFormats"]:checked')).map(cb => cb.value),
                    trancheAge: Array.from(modal.querySelectorAll('input[name="clientTrancheAge"]:checked')).map(cb => cb.value),
                    style: modal.querySelector('input[name="clientStyle"]:checked')?.value || '',
                    objectif: modal.querySelector('input[name="clientObjectif"]:checked')?.value || '',
                    voiceSamples: this._tempClientVoiceSamples || existingProfile.voiceSamples || [],
                    voiceProfile: existingProfile.voiceProfile || null,
                    createdAt: existingProfile.createdAt || new Date().toISOString()
                };
                
                if (!profile.name) {
                    showToast('❌ Le nom du client est requis');
                    return;
                }
                
                data.clientProfiles[clientId] = profile;
                this.save(data);
                this._tempClientVoiceSamples = null; // Reset temp
                
                this.closeClientModal();
                this.updateClientSelector();
                this.updateUI(); // Rafraîchir le dashboard
                showToast('✅ Client "' + profile.name + '" sauvegardé !');
            },
            
            // Gestion voix client
            _tempClientVoiceSamples: null,
            
            addClientVoiceSample() {
                const textarea = document.getElementById('clientVoiceNewSample');
                const text = textarea.value.trim();
                
                if (text.length < 50) {
                    showToast('❌ Le texte doit faire au moins 50 caractères');
                    return;
                }
                
                if (!this._tempClientVoiceSamples) {
                    const clientId = document.getElementById('clientProfileId').value;
                    const data = this.get();
                    this._tempClientVoiceSamples = clientId && data.clientProfiles[clientId]?.voiceSamples 
                        ? [...data.clientProfiles[clientId].voiceSamples] 
                        : [];
                }
                
                if (this._tempClientVoiceSamples.length >= 10) {
                    showToast('❌ Maximum 10 textes');
                    return;
                }
                
                this._tempClientVoiceSamples.push(text);
                textarea.value = '';
                this.updateClientVoiceUI();
                showToast('✅ Texte ajouté !');
            },
            
            removeClientVoiceSample(index) {
                if (this._tempClientVoiceSamples) {
                    this._tempClientVoiceSamples.splice(index, 1);
                    this.updateClientVoiceUI();
                    showToast('🗑️ Texte supprimé');
                }
            },
            
            updateClientVoiceUI() {
                const container = document.getElementById('clientVoiceSamples');
                const analyzeBtn = document.getElementById('analyzeClientVoiceBtn');
                const statusDiv = document.getElementById('clientVoiceStatus');
                const samples = this._tempClientVoiceSamples || [];
                
                if (samples.length > 0) {
                    container.innerHTML = samples.map((s, i) => `
                        <div class="voice-sample">
                            <div class="voice-sample-text">${s.substring(0, 60)}...</div>
                            <button type="button" class="voice-sample-btn" onclick="AgencySystem.removeClientVoiceSample(${i})">🗑️</button>
                        </div>
                    `).join('');
                    
                    if (samples.length >= 2) {
                        analyzeBtn.style.display = 'block';
                    }
                } else {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 15px;">Aucun texte ajouté</p>';
                    analyzeBtn.style.display = 'none';
                }
                
                // Afficher le profil de voix existant
                const clientId = document.getElementById('clientProfileId').value;
                if (clientId) {
                    const data = this.get();
                    const client = data.clientProfiles[clientId];
                    if (client?.voiceProfile) {
                        statusDiv.style.display = 'block';
                        statusDiv.style.background = 'linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1))';
                        statusDiv.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5em;">✅</span>
                                <div>
                                    <strong>Profil de voix actif</strong><br>
                                    <small style="color: #666;">Ton: ${client.voiceProfile.ton || 'N/A'} • Fidélité: ${client.voiceProfile.fidelityScore || 85}%</small>
                                </div>
                            </div>
                        `;
                    }
                }
            },
            
            async analyzeClientVoice() {
                const samples = this._tempClientVoiceSamples || [];
                if (samples.length < 2) {
                    showToast('❌ Ajoute au moins 2 textes');
                    return;
                }
                
                const btn = document.getElementById('analyzeClientVoiceBtn');
                const statusDiv = document.getElementById('clientVoiceStatus');
                
                btn.disabled = true;
                btn.innerHTML = '⏳ Analyse en cours...';
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#f8f9fa';
                statusDiv.innerHTML = '<p style="text-align: center; color: #667eea;">🎤 Tithot analyse le style d\'écriture...</p>';
                
                const samplesText = samples.map((s, i) => `--- TEXTE ${i+1} ---\n${s}`).join('\n\n');
                
                const prompt = `Tu es un expert en analyse stylistique. Analyse ces textes et extrais le profil de voix.

${samplesText}

Réponds UNIQUEMENT avec ce JSON :
{
  "ton": "Description du ton en 3-5 mots",
  "longueurPhrases": "Court/Moyen/Long + description",
  "expressions": "Expressions récurrentes identifiées",
  "ponctuation": "Usage émojis, !, tirets...",
  "styleNarratif": "Structure narrative préférée",
  "vocabulaire": "Type de vocabulaire",
  "signature": "Ce qui rend cette voix unique",
  "fidelityScore": 85,
  "conseils": "Comment reproduire cette voix"
}`;

                try {
                    const response = await callAI(prompt);
                    const jsonMatch = response.match(/\{[\s\S]*\}/);
                    
                    if (!jsonMatch) throw new Error('Format invalide');
                    
                    const voiceProfile = JSON.parse(jsonMatch[0]);
                    
                    // Sauvegarder dans le client
                    const clientId = document.getElementById('clientProfileId').value;
                    if (clientId) {
                        const data = this.get();
                        if (data.clientProfiles[clientId]) {
                            data.clientProfiles[clientId].voiceProfile = voiceProfile;
                            data.clientProfiles[clientId].voiceSamples = samples;
                            this.save(data);
                        }
                    }
                    
                    statusDiv.style.background = 'linear-gradient(135deg, rgba(40,167,69,0.1), rgba(40,167,69,0.2))';
                    statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">✅</span>
                            <div>
                                <strong style="color: #28a745;">Profil de voix créé !</strong><br>
                                <small style="color: #666;">Ton: ${voiceProfile.ton} • Fidélité: ${voiceProfile.fidelityScore}%</small>
                            </div>
                        </div>
                    `;
                    showToast('✅ Voix du client analysée !');
                    
                } catch (error) {
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.innerHTML = `<p style="color: #721c24;">❌ Erreur: ${error.message}</p>`;
                }
                
                btn.disabled = false;
                btn.innerHTML = '🎤 Ré-analyser la voix';
            },
            
            // Supprimer un client
            deleteClient(clientId) {
                const data = this.get();
                const name = data.clientProfiles[clientId]?.name || 'ce client';
                
                if (confirm('Supprimer "' + name + '" et tous ses contenus associés ?')) {
                    delete data.clientProfiles[clientId];
                    data.contents = data.contents.filter(c => c.clientId !== clientId);
                    if (data.currentClientId === clientId) data.currentClientId = null;
                    this.save(data);
                    this.updateClientSelector();
                    showToast('🗑️ Client supprimé');
                }
            },
            
            // Sélectionner un client
            setCurrentClient(clientId) {
                const data = this.get();
                data.currentClientId = clientId || null;
                this.save(data);
            },
            
            getCurrentClient() {
                const data = this.get();
                if (!data.currentClientId) return null;
                return data.clientProfiles[data.currentClientId] || null;
            },
            
            getCurrentClientId() {
                return this.get().currentClientId;
            },
            
            // Obtenir le profil client enrichi pour injection dans les prompts
            getClientProfileForAI() {
                const client = this.getCurrentClient();
                if (!client) return null;
                
                // Traduire les valeurs des options
                const getStyleLabel = (val) => ONBOARDING_OPTIONS.styles.find(s => s.value === val)?.label || val;
                const getObjectifLabel = (val) => ONBOARDING_OPTIONS.objectifs.find(o => o.value === val)?.label || val;
                const getPublicLabels = (arr) => arr.map(v => ONBOARDING_OPTIONS.publicCible.find(p => p.value === v)?.label || v).join(', ');
                
                let voiceSection = '';
                if (client.voiceProfile) {
                    const vp = client.voiceProfile;
                    voiceSection = `

=== PROFIL DE VOIX DU CLIENT (TRÈS IMPORTANT) ===
Ce client a un style d'écriture unique que tu DOIS reproduire :
- Ton : ${vp.ton || 'Non défini'}
- Longueur phrases : ${vp.longueurPhrases || 'Non définie'}
- Expressions : ${vp.expressions || 'Non définies'}
- Ponctuation : ${vp.ponctuation || 'Non définie'}
- Style narratif : ${vp.styleNarratif || 'Non défini'}
- Signature : ${vp.signature || 'Non définie'}
CONSEILS : ${vp.conseils || 'Style naturel'}

⚠️ ÉCRIS EXACTEMENT comme ce client écrirait !`;
                }
                
                return `
CLIENT : ${client.name}
DOMAINE : ${client.domaine || 'Non spécifié'}
POSITIONNEMENT : ${client.messageUnique || 'Non spécifié'}
PILIERS DE CONTENU : ${(client.piliers || []).join(', ') || 'Non spécifiés'}
TAGS : ${client.tags || 'Aucun'}
AUDIENCE CIBLE : ${client.audience || ''} ${client.publicCible?.length ? '(' + getPublicLabels(client.publicCible) + ')' : ''} ${client.trancheAge?.length ? '- Tranches ' + (Array.isArray(client.trancheAge) ? client.trancheAge.join(', ') : client.trancheAge) : ''}
STYLE/TON : ${client.style ? getStyleLabel(client.style) : 'Non spécifié'}
OBJECTIF : ${client.objectif ? getObjectifLabel(client.objectif) : 'Non spécifié'}
PLATEFORMES : ${(client.plateformes || []).join(', ') || 'Non spécifiées'}
FORMATS PRÉFÉRÉS : ${(client.formats || []).join(', ') || 'Tous'}
NOTES : ${client.notes || 'Aucune'}${voiceSection}
                `.trim();
            },
            
            // Télécharger le template CSV
            downloadTemplate() {
                const headers = ['Nom', 'Domaine', 'Message unique', 'Piliers', 'Tags', 'Audience', 'Public cible', 'Tranche age', 'Style', 'Objectif', 'Plateformes', 'Formats', 'Notes'];
                const example1 = ['Café Joyeux', 'Restauration inclusive', 'Nous formons et employons des personnes en situation de handicap', 'inclusion, coulisses, témoignages', '#cafejoyeux #inclusion #emploi', 'Grand public sensible à l\'inclusion', 'b2c, entrepreneurs', '25-35, 35-45', 'authentique', 'notoriete', 'instagram, linkedin, facebook', 'post, reel, carousel', 'Ton chaleureux et positif, éviter le misérabilisme'];
                const example2 = ['Marie Dupont Coaching', 'Coaching professionnel', 'J\'aide les managers à retrouver du sens', 'leadership, bien-être au travail, témoignages', '#coaching #leadership #management', 'Cadres et dirigeants en quête de sens', 'dirigeants, salaries', '35-45', 'inspirant', 'autorite', 'linkedin', 'post, article', 'Vouvoiement, ton professionnel mais chaleureux'];
                
                const csvContent = [
                    headers.join(';'),
                    example1.join(';'),
                    example2.join(';'),
                    '' // Ligne vide pour que l'utilisateur ajoute ses clients
                ].join('\n');
                
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'modele_clients_tithot.csv';
                link.click();
                URL.revokeObjectURL(link.href);
                showToast('📥 Modèle téléchargé !');
            },
            
            // ==================== IMPORT CSV/XLSX ====================
            
            showImportModal() {
                const data = this.get();
                if (!data.rgpdConsent) {
                    this.showRGPDConsent(() => {
                        document.getElementById('importModal').classList.add('show');
                    });
                } else {
                    document.getElementById('importModal').classList.add('show');
                }
            },
            
            closeImportModal() {
                document.getElementById('importModal').classList.remove('show');
                document.getElementById('importPreview').innerHTML = '';
                document.getElementById('importFile').value = '';
            },
            
            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const preview = document.getElementById('importPreview');
                preview.innerHTML = '<div class="import-loading">⏳ Analyse du fichier en cours...</div>';
                
                try {
                    let rawData;
                    const extension = file.name.split('.').pop().toLowerCase();
                    
                    if (extension === 'csv') {
                        rawData = await this.parseCSV(file);
                    } else if (extension === 'xlsx' || extension === 'xls') {
                        rawData = await this.parseXLSX(file);
                    } else {
                        throw new Error('Format non supporté. Utilisez CSV ou XLSX.');
                    }
                    
                    // Appeler l'IA pour parser intelligemment
                    const parsedClients = await this.parseWithAI(rawData);
                    this.showImportPreview(parsedClients);
                    
                } catch (e) {
                    preview.innerHTML = '<div class="import-error">❌ ' + e.message + '</div>';
                }
            },
            
            parseCSV(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const text = e.target.result;
                        const lines = text.split('\n').map(l => l.split(/[;,\t]/).map(c => c.trim().replace(/^"|"$/g, '')));
                        resolve(lines);
                    };
                    reader.onerror = () => reject(new Error('Erreur de lecture du fichier'));
                    reader.readAsText(file, 'UTF-8');
                });
            },
            
            async parseXLSX(file) {
                // Charger SheetJS si pas déjà fait
                if (!window.XLSX) {
                    await this.loadScript('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');
                }
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const workbook = XLSX.read(e.target.result, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const data = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                            resolve(data);
                        } catch (err) {
                            reject(new Error('Erreur de parsing Excel'));
                        }
                    };
                    reader.onerror = () => reject(new Error('Erreur de lecture du fichier'));
                    reader.readAsArrayBuffer(file);
                });
            },
            
            loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            },
            
            async parseWithAI(rawData) {
                const prompt = `Analyse ces données de clients et extrais les informations structurées.

DONNÉES BRUTES (tableau avec headers en première ligne) :
${JSON.stringify(rawData.slice(0, 20))}

Pour chaque ligne (sauf les headers), extrais :
- name : nom du client/entreprise (OBLIGATOIRE)
- domaine : secteur d'activité
- messageUnique : positionnement / proposition de valeur
- piliers : thématiques de contenu (array de strings)
- tags : hashtags et mots-clés
- audience : description de la cible
- publicCible : types de public (array parmi: entrepreneurs, freelances, salaries, etudiants, createurs, rh, b2b, b2c, dirigeants)
- trancheAge : tranches d'âge ciblées (array parmi: 18-25, 25-35, 35-45, 45-55, 55+, tous)
- style : style de communication (parmi: inspirant, educatif, authentique, humour, provocateur, minimaliste, storytelling, emotionnel)
- objectif : objectif principal (parmi: notoriete, communaute, ventes, autorite, reseau, expression, recrutement, leads)
- plateformes : réseaux sociaux (array parmi: linkedin, instagram, tiktok, youtube, x, facebook, threads, pinterest, newsletter)
- formats : formats préférés (array parmi: post, carousel, reel, story, thread, live, article, visuel)
- notes : autres infos, contraintes, ton à éviter

Réponds UNIQUEMENT avec un JSON valide, format :
[
  {"name": "...", "domaine": "...", "messageUnique": "...", "piliers": [...], "tags": "...", "audience": "...", "publicCible": [...], "trancheAge": [...], "style": "...", "objectif": "...", "plateformes": [...], "formats": [...], "notes": "..."},
  ...
]

Si une info n'est pas présente, mets une chaîne vide ou un array vide.`;

                const response = await callAI(prompt);
                
                // Extraire le JSON de la réponse
                const jsonMatch = response.match(/\[[\s\S]*\]/);
                if (!jsonMatch) throw new Error('Impossible de parser les données');
                
                return JSON.parse(jsonMatch[0]);
            },
            
            showImportPreview(clients) {
                const preview = document.getElementById('importPreview');
                
                if (!clients || clients.length === 0) {
                    preview.innerHTML = '<div class="import-error">❌ Aucun client détecté dans le fichier</div>';
                    return;
                }
                
                // Stocker temporairement pour import
                window.pendingImportClients = clients;
                
                let html = `
                    <div class="import-success">✅ ${clients.length} client(s) détecté(s)</div>
                    <div class="import-clients-list">
                `;
                
                clients.forEach((client, i) => {
                    html += `
                        <div class="import-client-card">
                            <div class="import-client-header">
                                <strong>${client.name || 'Sans nom'}</strong>
                                <span class="import-client-domain">${client.domaine || ''}</span>
                            </div>
                            <div class="import-client-details">
                                ${client.piliers?.length ? '<span>📌 ' + client.piliers.join(', ') + '</span>' : ''}
                                ${client.audience ? '<span>👥 ' + client.audience + '</span>' : ''}
                                ${client.plateformes?.length ? '<span>📱 ' + client.plateformes.join(', ') + '</span>' : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                    </div>
                    <button class="btn btn-import-confirm" onclick="AgencySystem.confirmImport()">
                        ✅ Importer ${clients.length} client(s)
                    </button>
                `;
                
                preview.innerHTML = html;
            },
            
            confirmImport() {
                const clients = window.pendingImportClients;
                if (!clients) return;
                
                const data = this.get();
                let imported = 0;
                
                clients.forEach(client => {
                    if (client.name) {
                        const clientId = this.generateId();
                        data.clientProfiles[clientId] = {
                            ...client,
                            createdAt: new Date().toISOString()
                        };
                        imported++;
                    }
                });
                
                this.save(data);
                this.closeImportModal();
                this.updateClientSelector();
                this.updateUI(); // Rafraîchir l'UI
                
                // Rafraîchir le dashboard s'il est ouvert
                if (document.getElementById('agencyDashboardModal').classList.contains('show')) {
                    this.showDashboard();
                }
                
                showToast('✅ ' + imported + ' client(s) importé(s) !');
                
                delete window.pendingImportClients;
            },
            
            // ==================== TRACKING & STATS ====================
            
            trackContent(platform, format, structure, preview) {
                const data = this.get();
                const clientId = data.currentClientId || null;
                const clientName = clientId && data.clientProfiles && data.clientProfiles[clientId] 
                    ? data.clientProfiles[clientId].name 
                    : 'Non assigné';
                    
                data.contents.unshift({
                    id: Date.now(),
                    date: new Date().toISOString(),
                    month: new Date().toISOString().slice(0, 7),
                    clientId: clientId,
                    clientName: clientName,
                    platform: platform || 'unknown',
                    format: format || 'unknown',
                    structure: structure || 'unknown',
                    preview: (preview || '').substring(0, 200)
                });
                if (data.contents.length > 500) data.contents.pop();
                this.save(data);
            },
            
            getStats() {
                const data = this.get();
                const contents = data.contents || [];
                const clientProfiles = data.clientProfiles || {};
                
                const byMonth = {};
                const now = new Date();
                for (let i = 5; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const key = d.toISOString().slice(0, 7);
                    byMonth[key] = 0;
                }
                contents.forEach(c => {
                    if (byMonth.hasOwnProperty(c.month)) byMonth[c.month]++;
                });
                
                const byClient = {};
                contents.forEach(c => {
                    const name = c.clientName || 'Non assigné';
                    byClient[name] = (byClient[name] || 0) + 1;
                });
                
                const byPlatform = {};
                contents.forEach(c => { byPlatform[c.platform] = (byPlatform[c.platform] || 0) + 1; });
                
                const byFormat = {};
                contents.forEach(c => { byFormat[c.format] = (byFormat[c.format] || 0) + 1; });
                
                const byStructure = {};
                contents.forEach(c => { byStructure[c.structure] = (byStructure[c.structure] || 0) + 1; });
                
                return { 
                    total: contents.length, 
                    byMonth, 
                    byClient, 
                    byPlatform, 
                    byFormat, 
                    byStructure, 
                    clientCount: Object.keys(clientProfiles).length 
                };
            },
            
            exportCSV() {
                const data = this.get();
                const headers = ['Date', 'Client', 'Plateforme', 'Format', 'Structure', 'Aperçu'];
                const rows = data.contents.map(c => [
                    new Date(c.date).toLocaleDateString('fr-FR'),
                    c.clientName || 'Non assigné',
                    c.platform,
                    c.format,
                    c.structure,
                    '"' + (c.preview || '').replace(/"/g, '""') + '"'
                ]);
                
                const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tithot-agence-export-' + new Date().toISOString().slice(0,10) + '.csv';
                a.click();
                URL.revokeObjectURL(url);
                showToast('📊 Export CSV téléchargé !');
            },
            
            // ==================== UI ====================
            
            updateUI() {
                const isAgency = this.isAgencyMode();
                const clientSection = document.getElementById('clientSection');
                const agencyBtn = document.getElementById('agencyDashboardBtn');
                const agencyToggleBtn = document.getElementById('agencyToggleBtn');
                const agencyStatusText = document.getElementById('agencyStatusText');
                
                // Section client et bouton dashboard
                if (clientSection) clientSection.style.display = isAgency ? 'block' : 'none';
                if (agencyBtn) agencyBtn.style.display = isAgency ? 'inline-flex' : 'none';
                
                // Toggle dans la configuration
                if (agencyToggleBtn) {
                    if (isAgency) {
                        agencyToggleBtn.innerHTML = '<button class="btn-agency-active-small" onclick="AgencySystem.deactivate()">✅ Activé</button>';
                    } else {
                        agencyToggleBtn.innerHTML = '<button class="btn-agency-unlock-small" onclick="AgencySystem.showUnlockModal()">🔐 Débloquer</button>';
                    }
                }
                
                if (agencyStatusText) {
                    agencyStatusText.textContent = isAgency ? 'Mode activé ! Sélectionnez un client ci-dessous.' : 'Multi-clients, dashboard & exports';
                }
                
                if (isAgency) this.updateClientSelector();
            },
            
            updateClientSelector() {
                const data = this.get();
                const selector = document.getElementById('clientSelector');
                if (!selector) return;
                
                const clients = Object.entries(data.clientProfiles || {});
                
                selector.innerHTML = `
                    <option value="">-- Sélectionner un client --</option>
                    ${clients.map(([id, c]) => `<option value="${id}" ${id === data.currentClientId ? 'selected' : ''}>${c.name}</option>`).join('')}
                `;
            },
            
            showDashboard() {
                try {
                    const data = this.get();
                    const stats = this.getStats();
                    
                    const maxMonth = Math.max(...Object.values(stats.byMonth), 1);
                    const monthBars = Object.entries(stats.byMonth).map(([month, count]) => {
                        const label = new Date(month + '-01').toLocaleDateString('fr-FR', { month: 'short' });
                        const height = (count / maxMonth) * 100;
                        return `<div class="chart-bar-container">
                            <div class="chart-bar" style="height: ${height}%"><span>${count}</span></div>
                            <div class="chart-label">${label}</div>
                        </div>`;
                    }).join('');
                    
                    const topClients = Object.entries(stats.byClient)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5)
                        .map(([name, count]) => `<div class="stat-item"><span>${name}</span><strong>${count}</strong></div>`)
                        .join('') || '<p style="color:#999;">Aucun contenu</p>';
                    
                    const topStructures = Object.entries(stats.byStructure)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5)
                        .map(([name, count]) => `<div class="stat-item"><span>${(typeof STRUCTURES !== 'undefined' && STRUCTURES[name]?.name) || name}</span><strong>${count}</strong></div>`)
                        .join('') || '<p style="color:#999;">Aucun contenu</p>';
                    
                    const platformStats = Object.entries(stats.byPlatform)
                        .map(([k, v]) => `<div class="stat-item"><span>${(typeof PLATFORMS !== 'undefined' && PLATFORMS[k]?.name) || k}</span><strong>${v}</strong></div>`)
                        .join('') || '<p style="color:#999;">Aucun contenu</p>';
                    
                    const formatStats = Object.entries(stats.byFormat)
                        .map(([k, v]) => `<div class="stat-item"><span>${(typeof FORMATS !== 'undefined' && FORMATS[k]?.name) || k}</span><strong>${v}</strong></div>`)
                        .join('') || '<p style="color:#999;">Aucun contenu</p>';
                    
                    // Liste des clients avec détails enrichis
                    const getStyleLabel = (val) => ONBOARDING_OPTIONS.styles.find(s => s.value === val)?.label || val;
                    const getObjectifLabel = (val) => ONBOARDING_OPTIONS.objectifs.find(o => o.value === val)?.label || val;
                    
                    const clientsList = Object.entries(data.clientProfiles).map(([id, c]) => {
                        const platformTags = (c.plateformes || []).slice(0, 3).map(p => `<span class="client-tag platform">📱 ${p}</span>`).join('');
                        const pilierTags = (c.piliers || []).slice(0, 2).map(p => `<span class="client-tag pilier">📌 ${p}</span>`).join('');
                        const styleBadge = c.style ? `<span class="client-tag style">🎨 ${getStyleLabel(c.style)}</span>` : '';
                        const objectifBadge = c.objectif ? `<span class="client-tag objectif">🎯 ${getObjectifLabel(c.objectif)}</span>` : '';
                        
                        return `
                        <div class="client-card" onclick="AgencySystem.showClientModal('${id}')">
                            <div class="client-card-header">
                                <div class="client-card-info">
                                    <strong>${c.name}</strong>
                                    <span class="client-domain">${c.domaine || 'Secteur non défini'}</span>
                                    ${c.messageUnique ? `<span class="client-message">"${c.messageUnique.substring(0, 80)}${c.messageUnique.length > 80 ? '...' : ''}"</span>` : ''}
                                </div>
                                <div class="client-card-actions" onclick="event.stopPropagation()">
                                    <button onclick="AgencySystem.showClientModal('${id}')" title="Modifier">✏️</button>
                                    <button onclick="AgencySystem.deleteClient('${id}')" title="Supprimer">🗑️</button>
                                </div>
                            </div>
                            <div class="client-card-details">
                                ${platformTags}${pilierTags}${styleBadge}${objectifBadge}
                            </div>
                        </div>
                    `;
                    }).join('') || '<p style="color:#999; text-align: center; padding: 30px;">Aucun client. Importez un CSV ou créez votre premier client !</p>';
                    
                    document.getElementById('agencyDashboardContent').innerHTML = `
                        <div class="agency-header">
                            <div class="agency-total">
                                <span class="agency-total-number">${stats.total}</span>
                                <span class="agency-total-label">contenus produits</span>
                            </div>
                            <div class="agency-total" style="background: linear-gradient(135deg, #11998e, #38ef7d);">
                                <span class="agency-total-number">${stats.clientCount}</span>
                                <span class="agency-total-label">clients</span>
                            </div>
                            <button class="btn btn-export" onclick="AgencySystem.exportCSV()">📊 Export CSV</button>
                        </div>
                        
                        <h3 style="margin: 25px 0 15px; color: #333;">📈 Production mensuelle</h3>
                        <div class="chart-container">${monthBars}</div>
                        
                        <h3 style="margin: 25px 0 15px; color: #333;">👥 Top Clients</h3>
                        <div class="stats-grid">${topClients}</div>
                        
                        <h3 style="margin: 25px 0 15px; color: #333;">📖 Structures favorites</h3>
                        <div class="stats-grid">${topStructures}</div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                            <div>
                                <h3 style="margin: 0 0 10px; color: #333;">📱 Plateformes</h3>
                                <div class="stats-grid">${platformStats}</div>
                            </div>
                            <div>
                                <h3 style="margin: 0 0 10px; color: #333;">🎬 Formats</h3>
                                <div class="stats-grid">${formatStats}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 25px; padding-top: 20px; border-top: 2px dashed #e0e0e0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0; color: #333;">👥 Mes clients (${stats.clientCount})</h3>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-profile" onclick="AgencySystem.showImportModal()">📥 Importer CSV/Excel</button>
                                    <button class="btn btn-profile" onclick="AgencySystem.showClientModal()">➕ Nouveau client</button>
                                </div>
                            </div>
                            <div class="clients-grid">${clientsList}</div>
                        </div>
                        
                        <div style="margin-top: 25px; padding-top: 20px; border-top: 2px dashed #ff6b6b; text-align: center;">
                            <button onclick="AgencySystem.deleteAllData()" style="background: none; border: 2px solid #ff6b6b; color: #ff6b6b; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-family: inherit;">
                                🗑️ Supprimer toutes mes données (RGPD)
                            </button>
                        </div>
                    `;
                    document.getElementById('agencyDashboardModal').classList.add('show');
                } catch (e) {
                    console.error('Dashboard error:', e);
                    showToast('❌ Erreur: ' + e.message);
                }
            }
        };

        // ==================== SYSTÈME DE MÉMOIRE ====================
        const ContentMemory = {
            KEY: 'tithot_content_memory',
            
            get() {
                try {
                    const stored = JSON.parse(localStorage.getItem(this.KEY));
                    if (!stored) return { contents: [], pillarUsage: {}, lastPillar: null };
                    return {
                        contents: stored.contents || [],
                        pillarUsage: stored.pillarUsage || {},
                        lastPillar: stored.lastPillar || null
                    };
                } catch (e) {
                    return { contents: [], pillarUsage: {}, lastPillar: null };
                }
            },
            
            save(memory) {
                localStorage.setItem(this.KEY, JSON.stringify(memory));
            },
            
            // Ajouter un contenu généré
            addContent(content, pillar, platform, format) {
                const memory = this.get();
                memory.contents.unshift({
                    id: Date.now(),
                    date: new Date().toISOString(),
                    preview: content.substring(0, 100),
                    pillar: pillar,
                    platform: platform,
                    format: format
                });
                // Garder les 50 derniers
                if (memory.contents.length > 50) memory.contents.pop();
                
                // Tracker l'usage des piliers
                if (pillar) {
                    memory.pillarUsage[pillar] = (memory.pillarUsage[pillar] || 0) + 1;
                    memory.lastPillar = pillar;
                }
                
                this.save(memory);
            },
            
            // Obtenir le pilier le moins utilisé
            getLeastUsedPillar(piliers) {
                if (!piliers || piliers.length === 0) return null;
                const memory = this.get();
                let minUsage = Infinity;
                let leastUsed = piliers[0];
                
                piliers.forEach(p => {
                    const usage = memory.pillarUsage[p] || 0;
                    if (usage < minUsage) {
                        minUsage = usage;
                        leastUsed = p;
                    }
                });
                
                return leastUsed;
            },
            
            // Obtenir le prochain pilier (alternance)
            getNextPillar(piliers) {
                if (!piliers || piliers.length === 0) return null;
                const memory = this.get();
                const lastIndex = piliers.indexOf(memory.lastPillar);
                const nextIndex = (lastIndex + 1) % piliers.length;
                return piliers[nextIndex];
            },
            
            // Résumé pour l'IA
            getSummaryForAI() {
                const memory = this.get();
                if (memory.contents.length === 0) return null;
                
                const recent = memory.contents.slice(0, 10);
                const topics = recent.map(c => c.preview).join(' | ');
                const pillarStats = Object.entries(memory.pillarUsage)
                    .sort((a, b) => b[1] - a[1])
                    .map(([p, count]) => `${p} (${count}x)`)
                    .join(', ');
                
                return {
                    totalContents: memory.contents.length,
                    recentTopics: topics,
                    pillarStats: pillarStats,
                    lastPillar: memory.lastPillar
                };
            }
        };

        // ==================== ÉTAT DE L'APPLICATION ====================
        let currentState = { structure: 'aida', format: 'post', platform: 'linkedin', idea: '', generatedContent: '', ideasContent: '', currentPillar: null, pubPlatform: 'meta', pubObjective: 'conversion' };

        const STRUCTURES = {
            'aida': { name: 'AIDA', prompt: 'Structure AIDA (Attention, Intérêt, Désir, Action)' },
            'golden-circle': { name: 'Golden Circle', prompt: 'Golden Circle de Simon Sinek (POURQUOI → COMMENT → QUOI)' },
            'hero-journey': { name: 'Voyage du Héros', prompt: 'Voyage du Héros (Situation, Défi, Transformation, Enseignement)' },
            'avant-apres': { name: 'Avant / Après', prompt: 'Structure Avant/Après (Problème AVANT, transformation, résultat APRÈS)' },
            'hook-story-cta': { name: 'Hook + Story + CTA', prompt: 'Hook + Story + Value + CTA' },
            'storybrand': { name: 'StoryBrand', prompt: 'Framework StoryBrand (lecteur = héros, toi = guide)' },
            'pattern-interrupt': { name: 'Pattern Interrupt', prompt: 'Pattern Interrupt (début inattendu qui brise les attentes)' },
            '3-actes': { name: '3 Actes', prompt: 'Structure en 3 actes (Exposition, Conflit, Résolution)' }
        };
        
        const FORMATS = {
            'post': { name: 'Post', length: '150-300 mots', specifics: 'texte fluide avec sauts de ligne' },
            'carousel': { name: 'Carousel', length: '8-10 slides', specifics: 'Slide 1 = hook, 1 idée par slide' },
            'reel': { name: 'Reel', length: 'script 30-60 sec', specifics: 'Script parlé, hook en 3 sec' },
            'story': { name: 'Story', length: '3-5 stories', specifics: '1 idée par story' },
            'thread': { name: 'Thread', length: '5-10 tweets', specifics: '280 car max par tweet' },
            'article': { name: 'Article', length: '500-800 mots', specifics: 'Introduction, sous-titres, conclusion' }
        };
        
        const PLATFORMS = {
            'linkedin': { name: 'LinkedIn', tone: 'professionnel mais humain' },
            'instagram': { name: 'Instagram', tone: 'visuel, émotionnel' },
            'tiktok': { name: 'TikTok', tone: 'dynamique, direct' },
            'twitter': { name: 'Twitter/X', tone: 'concis, percutant' },
            'facebook': { name: 'Facebook', tone: 'conversationnel' }
        };

        // Recommandations de format par plateforme (tendances 2026)
        const FORMAT_RECOMMENDATIONS = {
            'linkedin': {
                format: 'carousel',
                emoji: '🎠',
                title: 'Carousel',
                message: 'Les carousels explosent sur LinkedIn ! Taux d\'engagement 3x supérieur aux posts classiques.',
                tip: 'Astuce : 5-10 slides avec 1 idée forte par slide.'
            },
            'instagram': {
                format: 'reel',
                emoji: '🎬',
                title: 'Reel',
                message: 'Les Reels dominent Instagram en 2026. L\'algo les pousse massivement.',
                tip: 'Astuce : Hook dans les 3 premières secondes !'
            },
            'tiktok': {
                format: 'reel',
                emoji: '🎬',
                title: 'Vidéo courte',
                message: 'Le format natif TikTok. Privilégie l\'authenticité au polish.',
                tip: 'Astuce : Parle à la caméra comme à un ami.'
            },
            'twitter': {
                format: 'thread',
                emoji: '🧵',
                title: 'Thread',
                message: 'Les threads performent très bien sur X. Parfait pour le storytelling.',
                tip: 'Astuce : 1er tweet = hook puissant. Numérote tes tweets.'
            },
            'facebook': {
                format: 'post',
                emoji: '📝',
                title: 'Post',
                message: 'Les posts avec histoire personnelle génèrent le plus d\'engagement.',
                tip: 'Astuce : Pose une question à la fin pour les commentaires.'
            }
        };

        // Tendances Format 2026 (données enrichies)
        const FORMAT_TRENDS_2026 = {
            linkedin: {
                icon: '💼',
                name: 'LinkedIn',
                tips: [
                    { emoji: '📏', title: 'Longueur idéale : 1 200–2 500 caractères', text: 'Texte lisible avec phrases simples et sauts de ligne toutes les 1–3 lignes. Les posts trop courts manquent de substance, trop longs perdent l\'attention.', tag: 'Structure' },
                    { emoji: '🪝', title: 'Hook fort dès la première ligne', text: 'Contradiction, promesse audacieuse, question intrigante ou mini-histoire. C\'est ce qui fait arrêter le scroll.', tag: 'Accroche' },
                    { emoji: '🎯', title: '1 idée = 1 post', text: 'Structure claire : hook → développement → conclusion/CTA. Ne diluez pas votre message avec plusieurs sujets.', tag: 'Focus' },
                    { emoji: '📄', title: 'Privilégier les formats natifs', text: 'Texte pur, carrousels PDF, images et vidéos courtes performent mieux. Évitez les liens externes en plein post.', tag: 'Format' },
                    { emoji: '💬', title: 'Terminer par une question', text: 'Invitez à l\'interaction pour générer des commentaires. L\'algorithme favorise les posts qui créent des conversations.', tag: 'Engagement' }
                ]
            },
            tiktok: {
                icon: '🎵',
                name: 'TikTok',
                tips: [
                    { emoji: '⚡', title: 'Hook dans les 1–3 premières secondes', text: 'Visuel fort ou texte à l\'écran qui intrigue immédiatement. Pas de logo, pas d\'intro, direct dans le vif !', tag: 'Accroche' },
                    { emoji: '⏱️', title: 'Durée idéale : 20–35 secondes', text: 'Dynamique, sans temps mort. Les vidéos trop longues perdent l\'attention, trop courtes manquent de valeur.', tag: 'Durée' },
                    { emoji: '📱', title: 'Format vertical 9:16 plein écran', text: 'Montage rythmé avec coupes rapides. Pas de longues intros, pas de "bonjour à tous".', tag: 'Format' },
                    { emoji: '🎵', title: 'Sons et musiques tendances', text: 'Utilisez les sons qui buzzent + texte à l\'écran pour clarifier le message (beaucoup regardent sans son).', tag: 'Audio' },
                    { emoji: '👆', title: 'CTA simple à la fin', text: 'S\'abonner, commenter, voir la suite de la série... Un seul appel à l\'action clair.', tag: 'CTA' }
                ]
            },
            instagram: {
                icon: '📸',
                name: 'Instagram',
                tips: [
                    { emoji: '🎬', title: 'Priorité aux Reels : 15–30 secondes', text: 'Le format vidéo court vertical est poussé par l\'algorithme. Les Reels ont 2x plus de portée que les posts classiques.', tag: 'Format' },
                    { emoji: '🏆', title: 'Montrer le résultat dès le début', text: 'Commencez par le "après" ou le résultat final, puis déroulez le "comment". Ça accroche et retient.', tag: 'Structure' },
                    { emoji: '📝', title: 'Texte à l\'écran dès la 1ère seconde', text: 'Question, promesse ou phrase choc directement visible. 85% des vidéos sont regardées sans son.', tag: 'Accroche' },
                    { emoji: '🚀', title: 'Rythme rapide, transitions visuelles', text: 'Un seul message par Reel, pas de blabla. Les premiers 3 secondes décident si on reste.', tag: 'Montage' },
                    { emoji: '💾', title: 'CTA dans la légende', text: 'Sauvegarder, partager, taguer quelqu\'un + quelques hashtags pertinents (5-10 max, ciblés).', tag: 'Engagement' }
                ]
            },
            facebook: {
                icon: '👥',
                name: 'Facebook',
                tips: [
                    { emoji: '📏', title: 'Posts courts à moyens', text: 'Accroche claire dans la première phrase. Facebook tronque après 3 lignes, soyez percutant d\'entrée.', tag: 'Structure' },
                    { emoji: '🖼️', title: 'Visuel soigné obligatoire', text: 'Image ou courte vidéo plutôt que texte seul. Les posts avec visuels ont 2,3x plus d\'engagement.', tag: 'Format' },
                    { emoji: '💬', title: 'Ton conversationnel', text: '1 message clé par post, vocabulaire simple. Écrivez comme vous parlez à un ami.', tag: 'Ton' },
                    { emoji: '🔗', title: 'Liens acceptés mais contextualisés', text: 'Mieux intégrés avec un texte qui donne déjà de la valeur avant le clic.', tag: 'Liens' },
                    { emoji: '🗳️', title: 'Questions et sondages', text: 'Mini-histoires locales/personnelles fonctionnent très bien. L\'authenticité prime sur le polish.', tag: 'Engagement' }
                ]
            }
        };

        function updateFormatRecommendation(platform) {
            const rec = FORMAT_RECOMMENDATIONS[platform];
            const recDiv = document.getElementById('formatRecommendation');
            
            if (!rec || !recDiv) return;
            
            recDiv.innerHTML = `
                <span class="trend-badge">🔥 Tendances 2026</span>
                <strong>${rec.emoji} ${rec.title}</strong> — ${rec.message}
                <button class="see-more" onclick="event.stopPropagation(); openFormatTrends('${platform}')">Voir les tips →</button>
            `;
            recDiv.classList.add('show');
            recDiv.onclick = () => openFormatTrends(platform);
        }

        function openFormatTrends(platform = 'linkedin') {
            document.getElementById('formatTrendsModal').classList.add('show');
            showFormatTrend(platform);
        }

        function closeFormatTrends() {
            document.getElementById('formatTrendsModal').classList.remove('show');
        }

        function showFormatTrend(platform) {
            // Update tabs
            document.querySelectorAll('.trends-format-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.trends-format-tab.${platform}`).classList.add('active');
            
            // Get trends data
            const trend = FORMAT_TRENDS_2026[platform];
            if (!trend) return;
            
            // Build content
            let html = `<h3 style="margin: 0 0 20px; color: #333;">${trend.icon} Ce qui marche sur ${trend.name} en 2026</h3>`;
            
            trend.tips.forEach(tip => {
                html += `
                    <div class="trend-tip-card">
                        <h4>${tip.emoji} ${tip.title}</h4>
                        <p>${tip.text}</p>
                        <span class="tip-tag">${tip.tag}</span>
                    </div>
                `;
            });
            
            html += `
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px dashed #e0e0e0; text-align: center;">
                    <button onclick="selectPlatform('${platform}'); closeFormatTrends();" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 30px; border-radius: 10px; font-weight: 600; cursor: pointer; font-family: inherit; font-size: 1em;">
                        ✨ Créer pour ${trend.name}
                    </button>
                </div>
            `;
            
            document.getElementById('formatTrendsContent').innerHTML = html;
        }

        function selectPlatform(platform) {
            document.querySelectorAll('.platform-chip').forEach(c => c.classList.remove('active'));
            const chip = document.querySelector(`.platform-chip[data-platform="${platform}"]`);
            if (chip && !chip.classList.contains('disabled')) {
                chip.classList.add('active');
                currentState.platform = platform;
                updateFormatRecommendation(platform);
            }
        }

        // ==================== CASCADE SYSTEM (PLANNING) ====================
        const CascadeSystem = {
            STORAGE_KEY: 'sos_cascade_planning',
            currentWeekStart: null,
            draggedItem: null,

            init() {
                this.currentWeekStart = this.getWeekStart(new Date());
            },

            getWeekStart(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                d.setDate(diff);
                d.setHours(0, 0, 0, 0);
                return d;
            },

            get() {
                return JSON.parse(localStorage.getItem(this.STORAGE_KEY)) || { slots: [] };
            },

            save(data) {
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
            },

            // Navigation semaine
            previousWeek() {
                this.currentWeekStart.setDate(this.currentWeekStart.getDate() - 7);
                this.renderCalendar();
            },

            nextWeek() {
                this.currentWeekStart.setDate(this.currentWeekStart.getDate() + 7);
                this.renderCalendar();
            },

            goToToday() {
                this.currentWeekStart = this.getWeekStart(new Date());
                this.renderCalendar();
            },

            // Ouvrir la modal
            open() {
                this.init();
                document.getElementById('cascadeModal').classList.add('show');
                this.renderCalendar();
                this.renderFavorites();
            },

            // Rendu du calendrier
            renderCalendar() {
                const weekEl = document.getElementById('cascadeWeek');
                const labelEl = document.getElementById('cascadeWeekLabel');
                const data = this.get();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
                const monthNames = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'];

                // Label de la semaine
                const weekEnd = new Date(this.currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                labelEl.textContent = `${this.currentWeekStart.getDate()} ${monthNames[this.currentWeekStart.getMonth()]} - ${weekEnd.getDate()} ${monthNames[weekEnd.getMonth()]} ${weekEnd.getFullYear()}`;

                let html = '';
                for (let i = 0; i < 7; i++) {
                    const date = new Date(this.currentWeekStart);
                    date.setDate(date.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    const isToday = date.getTime() === today.getTime();
                    const isPast = date.getTime() < today.getTime();
                    const isWeekend = i >= 5;

                    // Slots pour ce jour
                    const daySlots = data.slots.filter(s => s.date === dateStr).sort((a, b) => a.time.localeCompare(b.time));

                    html += `
                        <div class="cascade-day ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''} ${isPast ? 'past' : ''}" 
                             data-date="${dateStr}"
                             ${!isPast ? `ondragover="CascadeSystem.handleDragOver(event)"
                             ondragleave="CascadeSystem.handleDragLeave(event)"
                             ondrop="CascadeSystem.handleDrop(event, '${dateStr}')"` : ''}>
                            <div class="cascade-day-header">
                                <div class="cascade-day-name">${days[i]}</div>
                                <div class="cascade-day-number">${date.getDate()}</div>
                            </div>
                            <div class="cascade-day-slots">
                                ${daySlots.map((slot, idx) => this.renderSlot(slot, dateStr, idx, isPast)).join('')}
                                ${!isPast ? `<button class="cascade-add-btn" onclick="CascadeSystem.openSlotModal('${dateStr}')">+ Ajouter</button>` : ''}
                            </div>
                        </div>
                    `;
                }

                weekEl.innerHTML = html;
                this.updateStats();
            },

            renderSlot(slot, date, index, isPast = false) {
                const platformEmojis = { linkedin: '💼', instagram: '📸', twitter: '𝕏', facebook: '👥', tiktok: '🎵' };
                const preview = slot.content.substring(0, 40) + (slot.content.length > 40 ? '...' : '');
                
                return `
                    <div class="cascade-slot ${slot.platform} ${isPast ? 'past-slot' : ''}" ${!isPast ? `onclick="CascadeSystem.editSlot('${date}', ${index})"` : ''}>
                        <span class="cascade-slot-platform">${platformEmojis[slot.platform] || '📱'}</span>
                        <div class="cascade-slot-time">${slot.time}</div>
                        <div class="cascade-slot-preview">${preview}</div>
                        ${isPast ? '<span class="cascade-slot-done">✓</span>' : ''}
                    </div>
                `;
            },

            // Rendu des favoris
            renderFavorites() {
                const container = document.getElementById('cascadeFavorites');
                const favorites = getFavorites();

                if (favorites.length === 0) {
                    container.innerHTML = '<div class="cascade-empty">Aucun favori.<br>Sauvegarde des contenus avec ❤️</div>';
                    return;
                }

                container.innerHTML = favorites.map((fav, idx) => {
                    const preview = fav.content.substring(0, 60) + (fav.content.length > 60 ? '...' : '');
                    const platformEmojis = { linkedin: '💼', instagram: '📸', twitter: '𝕏', facebook: '👥', tiktok: '🎵' };
                    
                    return `
                        <div class="cascade-fav-item" 
                             draggable="true"
                             ondragstart="CascadeSystem.handleDragStart(event, ${idx})"
                             ondragend="CascadeSystem.handleDragEnd(event)">
                            <div class="cascade-fav-platform">${platformEmojis[fav.platform] || '📱'} ${fav.platform?.toUpperCase() || 'CONTENU'}</div>
                            <div class="cascade-fav-preview">${preview}</div>
                        </div>
                    `;
                }).join('');
            },

            // Drag & Drop
            handleDragStart(e, favIndex) {
                this.draggedItem = favIndex;
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            },

            handleDragEnd(e) {
                e.target.classList.remove('dragging');
                document.querySelectorAll('.cascade-day').forEach(d => d.classList.remove('drag-over'));
            },

            handleDragOver(e) {
                e.preventDefault();
                e.currentTarget.classList.add('drag-over');
            },

            handleDragLeave(e) {
                e.currentTarget.classList.remove('drag-over');
            },

            handleDrop(e, dateStr) {
                e.preventDefault();
                e.currentTarget.classList.remove('drag-over');
                
                if (this.draggedItem !== null) {
                    const favorites = getFavorites();
                    const fav = favorites[this.draggedItem];
                    
                    if (fav) {
                        // Ouvrir modal avec le contenu pré-rempli
                        this.openSlotModal(dateStr, fav);
                    }
                    
                    this.draggedItem = null;
                }
            },

            // Modal Slot
            openSlotModal(dateStr, prefillContent = null) {
                document.getElementById('slotDate').value = dateStr;
                document.getElementById('slotEditIndex').value = '';
                document.getElementById('cascadeSlotTitle').textContent = '📝 Planifier un contenu';
                document.getElementById('deleteSlotBtn').style.display = 'none';
                
                // Reset
                document.getElementById('slotTime').value = '09:00';
                document.getElementById('slotPlatform').value = 'linkedin';
                document.getElementById('slotContent').value = '';
                document.getElementById('slotCustomContent').value = '';

                // Remplir le select des favoris
                const favorites = getFavorites();
                const select = document.getElementById('slotContent');
                select.innerHTML = '<option value="">-- Choisir un favori --</option>' + 
                    favorites.map((f, i) => {
                        const preview = f.content.substring(0, 50) + '...';
                        return `<option value="${i}">${f.platform?.toUpperCase() || 'Contenu'}: ${preview}</option>`;
                    }).join('');

                // Pré-remplir si drag & drop
                if (prefillContent) {
                    document.getElementById('slotPlatform').value = prefillContent.platform || 'linkedin';
                    document.getElementById('slotCustomContent').value = prefillContent.content;
                }

                document.getElementById('cascadeSlotModal').classList.add('show');
            },

            editSlot(dateStr, index) {
                const data = this.get();
                const slot = data.slots.find(s => s.date === dateStr);
                const daySlots = data.slots.filter(s => s.date === dateStr).sort((a, b) => a.time.localeCompare(b.time));
                const slotData = daySlots[index];

                if (!slotData) return;

                document.getElementById('slotDate').value = dateStr;
                document.getElementById('slotEditIndex').value = data.slots.indexOf(slotData);
                document.getElementById('cascadeSlotTitle').textContent = '✏️ Modifier le contenu';
                document.getElementById('deleteSlotBtn').style.display = 'block';

                document.getElementById('slotTime').value = slotData.time;
                document.getElementById('slotPlatform').value = slotData.platform;
                document.getElementById('slotContent').value = '';
                document.getElementById('slotCustomContent').value = slotData.content;

                // Remplir le select des favoris
                const favorites = getFavorites();
                const select = document.getElementById('slotContent');
                select.innerHTML = '<option value="">-- Choisir un favori --</option>' + 
                    favorites.map((f, i) => `<option value="${i}">${f.platform?.toUpperCase() || 'Contenu'}: ${f.content.substring(0, 50)}...</option>`).join('');

                document.getElementById('cascadeSlotModal').classList.add('show');
            },

            saveSlot() {
                const dateStr = document.getElementById('slotDate').value;
                const editIndex = document.getElementById('slotEditIndex').value;
                const time = document.getElementById('slotTime').value;
                const platform = document.getElementById('slotPlatform').value;
                const favIndex = document.getElementById('slotContent').value;
                let content = document.getElementById('slotCustomContent').value.trim();

                // Si un favori est sélectionné et pas de contenu custom
                if (favIndex !== '' && !content) {
                    const favorites = getFavorites();
                    content = favorites[parseInt(favIndex)]?.content || '';
                }

                if (!content) {
                    showToast('❌ Ajoute du contenu !');
                    return;
                }

                const data = this.get();
                const slot = { date: dateStr, time, platform, content, createdAt: new Date().toISOString() };

                if (editIndex !== '') {
                    // Modification
                    data.slots[parseInt(editIndex)] = slot;
                } else {
                    // Création
                    data.slots.push(slot);
                }

                this.save(data);
                closeCascadeSlot();
                this.renderCalendar();
                showToast('✅ Contenu planifié !');
                SoundSystem.playSuccess();
            },

            deleteSlot() {
                const editIndex = document.getElementById('slotEditIndex').value;
                if (editIndex === '') return;

                if (!confirm('Supprimer ce contenu planifié ?')) return;

                const data = this.get();
                data.slots.splice(parseInt(editIndex), 1);
                this.save(data);
                
                closeCascadeSlot();
                this.renderCalendar();
                showToast('🗑️ Supprimé');
            },

            updateStats() {
                const data = this.get();
                const weekStart = this.currentWeekStart;
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);

                const weekSlots = data.slots.filter(s => {
                    const d = new Date(s.date);
                    return d >= weekStart && d <= weekEnd;
                });

                // Tu pourrais afficher ces stats quelque part
                console.log(`📅 ${weekSlots.length} contenus planifiés cette semaine`);
            },

            // Export CSV
            exportCSV(format) {
                const data = this.get();
                
                if (data.slots.length === 0) {
                    showToast('❌ Aucun contenu à exporter');
                    return;
                }

                // Trier par date et heure
                const sorted = [...data.slots].sort((a, b) => {
                    if (a.date !== b.date) return a.date.localeCompare(b.date);
                    return a.time.localeCompare(b.time);
                });

                let csv = '';
                let filename = '';

                switch (format) {
                    case 'metricool':
                        // Format Metricool officiel
                        const headers = ['Text','Date','Time','Draft','Facebook','Twitter/X','LinkedIn','GBP','Instagram','Pinterest','TikTok','Youtube','Threads','Bluesky','Picture Url 1','Picture Url 2','Picture Url 3','Picture Url 4','Picture Url 5','Picture Url 6','Picture Url 7','Picture Url 8','Picture Url 9','Picture Url 10','Alt text picture 1','Alt text picture 2','Alt text picture 3','Alt text picture 4','Alt text picture 5','Alt text picture 6','Alt text picture 7','Alt text picture 8','Alt text picture 9','Alt text picture 10','Document title','Shortener','Video Thumbnail Url','Video Cover Frame','Twitter/X Can reply','Twitter/X Type','Twitter/X Poll Duration minutes','Twitter/X Poll Option 1','Twitter/X Poll Option 2','Twitter/X Poll Option 3','Twitter/X Poll Option 4','Pinterest Board','Pinterest Pin Title','Pinterest Pin Link','Pinterest Pin New Format','Instagram Post Type','Instagram Show Reel On Feed','Youtube Video Title','Youtube Video Type','Youtube Video Privacy','Youtube video for kids','Youtube Video Category','Youtube Video Tags','Youtube playlist','GBP Post Type','Facebook Post Type','Facebook Title','First Comment Text','TikTok Title','TikTok disable comments','TikTok disable duet','TikTok disable stitch','TikTok Post Privacy','TikTok Branded Content','TikTok Your Brand','TikTok Auto Add Music','TikTok Photo Cover Index','TikTok musicId','TikTok title','TikTok author','TikTok startMillis','TikTok durationMillis','TikTok startVideoMillis','LinkedIn Type','LinkedIn Poll Question','LinkedIn Poll Option 1','LinkedIn Poll Option 2','LinkedIn Poll Option 3','LinkedIn Poll Option 4','LinkedIn Poll Duration','LinkedIn Show link preview','LinkedIn Images as Carousel','Threads Reply Control','Brand name'];
                        
                        csv = headers.join(',') + '\n';
                        
                        sorted.forEach(slot => {
                            // Tronquer à 2200 caractères max (limite Metricool)
                            let content = slot.content.replace(/"/g, '""').replace(/\n/g, ' ');
                            if (content.length > 2200) {
                                content = content.substring(0, 2197) + '...';
                            }
                            
                            // Format date : YYYY/MM/DD (pas YYYY-MM-DD)
                            const dateFormatted = slot.date.replace(/-/g, '/');
                            const time = slot.time + ':00';
                            
                            // Créer un tableau avec toutes les valeurs
                            const row = new Array(headers.length).fill('');
                            
                            // Remplir les colonnes essentielles
                            row[0] = `"${content}"`; // Text
                            row[1] = dateFormatted; // Date
                            row[2] = time; // Time
                            row[3] = 'false'; // Draft
                            
                            // Plateformes (colonnes 4-13)
                            row[4] = slot.platform === 'facebook' ? 'true' : 'false'; // Facebook
                            row[5] = slot.platform === 'twitter' ? 'true' : 'false'; // Twitter/X
                            row[6] = slot.platform === 'linkedin' ? 'true' : 'false'; // LinkedIn
                            row[7] = 'false'; // GBP
                            row[8] = slot.platform === 'instagram' ? 'true' : 'false'; // Instagram
                            row[9] = 'false'; // Pinterest
                            row[10] = slot.platform === 'tiktok' ? 'true' : 'false'; // TikTok
                            row[11] = 'false'; // Youtube
                            row[12] = 'false'; // Threads
                            row[13] = 'false'; // Bluesky
                            
                            // Shortener
                            row[35] = 'true';
                            
                            // Twitter type
                            row[39] = 'POST';
                            
                            // Instagram Post Type
                            row[49] = 'POST';
                            row[50] = 'false';
                            
                            // LinkedIn Type
                            row[78] = 'POST';
                            row[85] = 'true'; // Show link preview
                            row[86] = 'false'; // Images as Carousel
                            
                            csv += row.join(',') + '\n';
                        });
                        filename = 'cascade-metricool.csv';
                        break;

                    case 'swello':
                        // Format Swello : content,date,time,network
                        csv = 'content;scheduled_date;scheduled_time;network\n';
                        sorted.forEach(slot => {
                            const content = slot.content.replace(/"/g, '""').replace(/\n/g, ' ');
                            const network = this.mapPlatformToSwello(slot.platform);
                            csv += `"${content}";${slot.date};${slot.time};${network}\n`;
                        });
                        filename = 'cascade-swello.csv';
                        break;

                    default:
                        // Format générique
                        csv = 'Date,Heure,Plateforme,Contenu\n';
                        sorted.forEach(slot => {
                            const content = slot.content.replace(/"/g, '""').replace(/\n/g, ' ');
                            csv += `${slot.date},${slot.time},${slot.platform},"${content}"\n`;
                        });
                        filename = 'cascade-planning.csv';
                }

                // Télécharger
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);

                if (format === 'metricool') {
                    // Message spécifique Metricool
                    showToast(`✅ ${sorted.length} contenus exportés !`);
                    setTimeout(() => {
                        alert('📸 RAPPEL IMPORTANT !\n\nDans Metricool, tu devras ajouter manuellement une image ou vidéo à chaque publication.\n\nLes contenus de plus de 2200 caractères ont été tronqués.');
                    }, 500);
                } else {
                    showToast(`✅ ${sorted.length} contenus exportés !`);
                }
                SoundSystem.playSuccess();
            },

            mapPlatformToMetricool(platform) {
                const map = { linkedin: 'LinkedIn', instagram: 'Instagram', twitter: 'Twitter', facebook: 'Facebook', tiktok: 'TikTok' };
                return map[platform] || platform;
            },

            mapPlatformToSwello(platform) {
                const map = { linkedin: 'linkedin', instagram: 'instagram', twitter: 'twitter', facebook: 'facebook', tiktok: 'tiktok' };
                return map[platform] || platform;
            }
        };

        function showCascade() {
            CascadeSystem.open();
        }

        function closeCascade() {
            document.getElementById('cascadeModal').classList.remove('show');
        }

        function closeCascadeSlot() {
            document.getElementById('cascadeSlotModal').classList.remove('show');
        }

        // ==================== MES POSTS POPUP ====================
        let mesPostsWindow = null;
        
        function openMesPostsPopup() {
            // Vérifier si la fenêtre est déjà ouverte
            if (mesPostsWindow && !mesPostsWindow.closed) {
                mesPostsWindow.focus();
                return;
            }
            
            // Ouvrir une nouvelle fenêtre popup
            const width = 420;
            const height = 700;
            const left = window.screen.width - width - 50;
            const top = 50;
            
            mesPostsWindow = window.open(
                'mes-posts-popup.html',
                'MesPostsSOS',
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
            );
            
            if (mesPostsWindow) {
                mesPostsWindow.focus();
            } else {
                // Si popup bloquée, ouvrir dans un nouvel onglet
                window.open('mes-posts-popup.html', '_blank');
            }
        }

        // Fonction pour sauvegarder un post directement depuis l'app principale
        function saveToMesPosts(caption, hashtags, visualTexts, platform) {
            const STORAGE_KEY = 'sos_mes_posts';
            const posts = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            
            posts.unshift({
                platform: platform || currentState.platform || 'instagram',
                caption: caption || '',
                hashtags: hashtags || '',
                visualTexts: visualTexts || '',
                done: false,
                createdAt: new Date().toISOString()
            });
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(posts));
            showToast('📌 Sauvegardé dans Mes Posts !');
            
            // Si la fenêtre popup est ouverte, elle se mettra à jour automatiquement
        }

        // Sauvegarde rapide du contenu actuel
        function quickSaveToMesPosts() {
            if (!currentState.generatedContent) {
                showToast('❌ Génère d\'abord du contenu !');
                return;
            }
            
            // Essayer d'extraire caption et hashtags du contenu généré
            let content = currentState.generatedContent;
            let caption = '';
            let hashtags = '';
            let visualTexts = '';
            
            // Chercher les hashtags
            const hashtagMatch = content.match(/(#\w+[\s]*)+/g);
            if (hashtagMatch) {
                hashtags = hashtagMatch.join(' ').trim();
                // Retirer les hashtags du contenu pour avoir la caption propre
                content = content.replace(/(#\w+[\s]*)+/g, '').trim();
            }
            
            // Chercher les textes de slides/visuels (patterns courants)
            const slidePatterns = [
                /(?:Slide|Diapo|Visuel|Écran)\s*\d+\s*[:：]\s*[^\n]+/gi,
                /(?:Titre|Hook|Accroche)\s*[:：]\s*[^\n]+/gi
            ];
            
            let foundSlides = [];
            slidePatterns.forEach(pattern => {
                const matches = content.match(pattern);
                if (matches) {
                    foundSlides = foundSlides.concat(matches);
                }
            });
            
            if (foundSlides.length > 0) {
                visualTexts = foundSlides.join('\n');
            }
            
            // Le reste est la caption
            caption = content;
            
            // Si c'est trop long, on prend juste les premiers paragraphes
            if (caption.length > 2200) {
                // Couper au dernier espace avant 2200 caractères
                caption = caption.substring(0, 2197);
                const lastSpace = caption.lastIndexOf(' ');
                if (lastSpace > 1800) {
                    caption = caption.substring(0, lastSpace) + '...';
                }
            }
            
            saveToMesPosts(caption, hashtags, visualTexts, currentState.platform);
            SoundSystem.playSuccess();
        }

        // ==================== SYSTÈME DE SON ====================
        const SoundSystem = {
            audioContext: null,
            
            init() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
            },
            
            playClick() {
                this.init();
                const ctx = this.audioContext;
                
                // Créer un son de clic synthétique
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.frequency.setValueAtTime(800, ctx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(400, ctx.currentTime + 0.05);
                
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.1);
            },
            
            playSuccess() {
                this.init();
                const ctx = this.audioContext;
                
                // Son de succès (deux notes montantes)
                const osc1 = ctx.createOscillator();
                const osc2 = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc1.connect(gain);
                osc2.connect(gain);
                gain.connect(ctx.destination);
                
                osc1.frequency.setValueAtTime(523, ctx.currentTime); // Do
                osc2.frequency.setValueAtTime(659, ctx.currentTime + 0.1); // Mi
                
                gain.gain.setValueAtTime(0.2, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                
                osc1.start(ctx.currentTime);
                osc1.stop(ctx.currentTime + 0.15);
                osc2.start(ctx.currentTime + 0.1);
                osc2.stop(ctx.currentTime + 0.3);
            }
        };

        // Fonction pour afficher l'effet "Envoyé !" sur un bouton
        function showSentEffect(btn, originalText) {
            SoundSystem.playSuccess();
            btn.classList.add('sent');
            setTimeout(() => {
                btn.classList.remove('sent');
            }, 1500);
        }

        // ==================== INITIALISATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            initSelectors();
            updateProfileButton();
            updatePillarSuggestion();
            updateMemoryIndicator();
            AgencySystem.updateUI();
            FrameworkSystem.updateQuickSelector();
            
            // Mettre à jour le compteur d'idées sauvegardées
            setTimeout(() => {
                if (typeof updateSavedCount === 'function') updateSavedCount();
            }, 100);
            
            const profile = UserProfile.get();
            if (profile?.plateformes?.length > 0) {
                selectPlatform(profile.plateformes[0]);
            } else {
                // Recommandation par défaut pour LinkedIn
                updateFormatRecommendation('linkedin');
            }
            if (!localStorage.getItem('tithot_tour_done')) document.getElementById('demoBadge').style.display = 'flex';
            
            // Afficher modal inscription si pas encore inscrit (après 3 secondes)
            setTimeout(() => {
                if (!Analytics.isRegistered() && !localStorage.getItem('sos_skip_register')) {
                    document.getElementById('registerModal').classList.add('show');
                }
            }, 3000);
            
            // Écouter les changements de profil (pour sync avec onboarding)
            window.addEventListener('storage', function(e) {
                if (e.key === 'tithot_user_profile') {
                    refreshConfigFromProfile();
                }
            });
            
            // Observer les changements de modal onboarding (fallback)
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.target.id === 'onboardingModal' && !mutation.target.classList.contains('show')) {
                        // L'onboarding vient de se fermer
                        setTimeout(refreshConfigFromProfile, 100);
                    }
                });
            });
            const onboardingModal = document.getElementById('onboardingModal');
            if (onboardingModal) {
                observer.observe(onboardingModal, { attributes: true, attributeFilter: ['class'] });
            }
        });

        // ==================== INSCRIPTION & CODES PROMO ====================
        async function completeRegistration() {
            const email = document.getElementById('registerEmail').value.trim();
            const name = document.getElementById('registerName').value.trim();
            
            if (!email || !email.includes('@')) {
                showToast('📧 Entre un email valide !');
                return;
            }
            
            const userId = await Analytics.registerUser(email, name || null);
            
            if (userId) {
                document.getElementById('registerModal').classList.remove('show');
                showToast('🎉 Bienvenue ' + (name || 'dans la communauté') + ' !');
                Analytics.trackEvent('registration', { source: 'modal' });
            } else {
                showToast('❌ Erreur, réessaie !');
            }
        }

        function skipRegistration() {
            localStorage.setItem('sos_skip_register', 'true');
            document.getElementById('registerModal').classList.remove('show');
        }

        function showPromoModal() {
            if (!Analytics.isRegistered()) {
                showToast('📧 Inscris-toi d\'abord pour utiliser un code !');
                document.getElementById('registerModal').classList.add('show');
                return;
            }
            document.getElementById('promoCodeModal').classList.add('show');
            document.getElementById('promoCodeInput').value = '';
            document.getElementById('promoCodeResult').innerHTML = '';
        }

        function closePromoModal() {
            document.getElementById('promoCodeModal').classList.remove('show');
        }

        async function validatePromoCode() {
            const code = document.getElementById('promoCodeInput').value.trim();
            if (!code) {
                showToast('Entre un code !');
                return;
            }
            
            const result = await Analytics.usePromoCode(code);
            const resultDiv = document.getElementById('promoCodeResult');
            
            if (result.success) {
                resultDiv.innerHTML = '<span style="color: #10b981; font-weight: 700;">✅ ' + result.message + ' - Plan: ' + result.plan_type + '</span>';
                showToast('🎉 Code activé ! Profite de ton accès ' + result.plan_type);
                setTimeout(closePromoModal, 2000);
            } else {
                resultDiv.innerHTML = '<span style="color: #ff6b6b;">❌ ' + result.message + '</span>';
            }
        }

        function initSelectors() {
            document.querySelectorAll('.structure-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.structure-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    currentState.structure = card.dataset.structure;
                });
            });
            document.querySelectorAll('.format-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.format-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentState.format = chip.dataset.format;
                    
                    // Afficher/masquer les options PUB
                    const pubOptions = document.getElementById('pubOptionsSection');
                    if (chip.dataset.format === 'pub') {
                        pubOptions.style.display = 'block';
                    } else {
                        pubOptions.style.display = 'none';
                    }
                });
            });
            
            // Gestion des plateformes PUB
            document.querySelectorAll('.pub-platform-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.pub-platform-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentState.pubPlatform = chip.dataset.pubplatform;
                });
            });
            
            // Gestion des objectifs PUB
            document.querySelectorAll('.pub-objective-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.pub-objective-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentState.pubObjective = chip.dataset.objective;
                });
            });
            document.querySelectorAll('.platform-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    // Ignorer les chips disabled (ex: Scrollab)
                    if (chip.classList.contains('disabled')) return;
                    
                    document.querySelectorAll('.platform-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentState.platform = chip.dataset.platform;
                    updateFormatRecommendation(chip.dataset.platform);
                });
            });
        }

        function selectPlatform(platform) {
            const map = { 'LinkedIn': 'linkedin', 'Instagram': 'instagram', 'TikTok': 'tiktok', 'X': 'twitter', 'Facebook': 'facebook' };
            const p = map[platform] || platform.toLowerCase();
            const chip = document.querySelector(`.platform-chip[data-platform="${p}"]`);
            if (chip) { 
                document.querySelectorAll('.platform-chip').forEach(c => c.classList.remove('active')); 
                chip.classList.add('active'); 
                currentState.platform = p;
                updateFormatRecommendation(p);
            }
        }

        function updatePillarSuggestion() {
            const profile = UserProfile.get();
            if (profile?.piliers?.length > 0) {
                const suggested = ContentMemory.getNextPillar(profile.piliers);
                if (suggested) {
                    document.getElementById('suggestedPillar').textContent = suggested;
                    document.getElementById('pillarSuggestion').style.display = 'inline-flex';
                    currentState.currentPillar = suggested;
                }
            }
        }

        function updateMemoryIndicator() {
            const memory = ContentMemory.getSummaryForAI();
            if (memory && memory.totalContents > 0) {
                document.getElementById('memoryText').innerHTML = `<strong>${memory.totalContents}</strong> contenus créés • Piliers utilisés : ${memory.pillarStats || 'aucun'}`;
                document.getElementById('memoryIndicator').style.display = 'flex';
            }
        }

        // Fonction globale appelée après modification du profil (depuis onboarding.js)
        function refreshConfigFromProfile() {
            updatePillarSuggestion();
            updateMemoryIndicator();
            updateProfileButton();
            console.log('🔄 Configuration rafraîchie depuis le profil');
        }
        
        // Exposer globalement pour l'onboarding externe
        window.refreshConfigFromProfile = refreshConfigFromProfile;

        // ==================== TRENDS - GÉNÉRATION DE PROMPTS ====================
        function showTrends() {
            document.getElementById('trendsModal').classList.add('show');
            updateSavedCount();
            
            // Afficher les dernières idées générées (si elles existent) ou l'écran d'accueil
            if (currentTrends.length > 0) {
                // Réafficher les dernières idées générées
                displayTrends(currentTrends);
            } else {
                // Écran d'accueil : inviter à générer
                displayTrendsWelcome();
            }
        }

        function displayTrendsWelcome() {
            document.getElementById('trendsContent').innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 4em; margin-bottom: 20px;">💡</div>
                    <h3 style="color: #333; margin-bottom: 10px;">Prêt·e à trouver l'inspiration ?</h3>
                    <p style="color: #666; margin-bottom: 25px;">Tithot va analyser ton profil et te proposer des idées personnalisées.</p>
                    <button onclick="generateNewTrends()" style="
                        padding: 15px 35px;
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        border: none;
                        border-radius: 30px;
                        font-size: 1.1em;
                        font-weight: 700;
                        cursor: pointer;
                        font-family: inherit;
                        box-shadow: 0 5px 20px rgba(102,126,234,0.4);
                        transition: all 0.3s;
                    " onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                        🔥 Générer des idées
                    </button>
                    <p style="color: #999; font-size: 0.85em; margin-top: 20px;">
                        Ou consulte tes <strong>⭐ Sauvegardées</strong> et <strong>📚 Historique</strong>
                    </p>
                </div>
            `;
        }

        async function generateNewTrends() {
            // Son de clic
            SoundSystem.playClick();
            
            // S'assurer qu'on est sur l'onglet "Nouvelles idées"
            switchTrendsTab('new');
            
            document.getElementById('trendsContent').innerHTML = `
                <div id="trendsTithot" style="text-align: center; padding: 30px;">
                    <dotlottie-wc src="https://lottie.host/eeab1c36-2031-4942-bf72-95b983b64077/hNKxxXfdmq.lottie" style="width: 200px; height: 200px; margin: 0 auto; display: block;" autoplay loop></dotlottie-wc>
                    <p style="color: #667eea; font-weight: 600; margin-top: 15px;">Tithot analyse les tendances...</p>
                </div>
            `;
            
            // Remonter en haut de la modal pour voir Tithot réfléchir
            const tithot = document.getElementById('trendsTithot');
            if (tithot) {
                tithot.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            const profile = UserProfile.get();
            const memory = ContentMemory.getSummaryForAI();
            
            let context = '';
            if (profile) {
                context += `Profil : ${profile.nom || 'Utilisateur'}
Domaine : ${profile.domaine || 'Non précisé'}
Piliers de contenu : ${profile.piliers?.join(', ') || 'Non précisés'}
Style : ${profile.style || 'Non précisé'}
Plateforme principale : ${currentState.platform}`;
            }
            
            if (memory) {
                context += `\n\nHistorique : ${memory.totalContents} contenus créés
Sujets récents : ${memory.recentTopics}
Dernier pilier utilisé : ${memory.lastPillar || 'aucun'}`;
            }

            const prompt = `Tu es Tithot, experte en tendances réseaux sociaux et personal branding.

${context}

MISSION : Génère 5 IDÉES DE CONTENU TENDANCE + 2 ANGLES PUBLICITAIRES personnalisés pour cet utilisateur.

Pour chaque idée de contenu, donne :
1. Un TITRE accrocheur (emoji + titre court)
2. Une DESCRIPTION en 1 phrase (pourquoi c'est tendance)
3. Le PROMPT exact à utiliser (la phrase que l'utilisateur peut copier-coller)

IMPORTANT :
- Propose des angles NOUVEAUX par rapport à l'historique
- Alterne les piliers de contenu
- Base-toi sur les vraies tendances 2025-2026 (IA, authenticité, micro-contenus, storytelling vulnérable, etc.)

Format ta réponse EXACTEMENT ainsi (pour faciliter le parsing) :

IDÉE 1
TITRE: [emoji] [titre]
DESC: [description courte]
PROMPT: [le prompt exact à copier]

IDÉE 2
...

(5 idées de contenu organique)

Puis ajoute :

PUB 1
TITRE: 💰 [titre de l'angle pub]
DESC: [pourquoi cet angle convertit bien]
PROMPT: [le prompt exact pour créer cette pub]
OBJECTIF: [conversion/trafic/leads/notoriete]

PUB 2
TITRE: 💰 [titre de l'angle pub]
DESC: [pourquoi cet angle convertit bien]
PROMPT: [le prompt exact pour créer cette pub]
OBJECTIF: [conversion/trafic/leads/notoriete]`;

            try {
                // Utiliser Perplexity pour les tendances (recherche web en temps réel)
                const response = await callPerplexity(prompt);
                const parsedTrends = parseTrendsResponse(response);
                saveTrendsToHistory(parsedTrends);
                displayTrends(parsedTrends);
                updateSavedCount();
            } catch (error) {
                document.getElementById('trendsContent').innerHTML = `<p style="color: #ff6b6b;">❌ Erreur : ${error.message}</p>`;
            }
        }

        // ==================== TRENDS HISTORY SYSTEM ====================
        const TrendsHistory = {
            STORAGE_KEY: 'sos_trends_history',
            SAVED_KEY: 'sos_saved_ideas',
            MAX_SAVED: 50,
            RETENTION_DAYS: 14,

            getHistory() {
                const data = localStorage.getItem(this.STORAGE_KEY);
                if (!data) return [];
                const history = JSON.parse(data);
                // Filtrer les entrées expirées
                const cutoff = Date.now() - (this.RETENTION_DAYS * 24 * 60 * 60 * 1000);
                return history.filter(h => new Date(h.generatedAt).getTime() > cutoff);
            },

            saveToHistory(trends) {
                const history = this.getHistory();
                const entry = {
                    id: `trends-${Date.now()}`,
                    generatedAt: new Date().toISOString(),
                    trends: trends
                };
                history.unshift(entry);
                // Garder max 20 sessions
                const trimmed = history.slice(0, 20);
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(trimmed));
            },

            getSavedIdeas() {
                const data = localStorage.getItem(this.SAVED_KEY);
                return data ? JSON.parse(data) : [];
            },

            saveIdea(idea) {
                const saved = this.getSavedIdeas();
                if (saved.length >= this.MAX_SAVED) {
                    showToast('⚠️ Maximum 50 idées sauvegardées !');
                    return false;
                }
                if (saved.find(s => s.id === idea.id)) {
                    showToast('⭐ Déjà sauvegardée !');
                    return false;
                }
                saved.unshift({
                    ...idea,
                    savedAt: new Date().toISOString()
                });
                localStorage.setItem(this.SAVED_KEY, JSON.stringify(saved));
                return true;
            },

            removeIdea(ideaId) {
                const saved = this.getSavedIdeas();
                const filtered = saved.filter(s => s.id !== ideaId);
                localStorage.setItem(this.SAVED_KEY, JSON.stringify(filtered));
            },

            removeHistorySession(sessionId) {
                const history = this.getHistory();
                const filtered = history.filter(h => h.id !== sessionId);
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(filtered));
            }
        };

        function parseTrendsResponse(response) {
            const trends = [];
            const baseId = Date.now();
            
            // Parser les idées de contenu
            const ideaBlocks = response.split(/IDÉE \d+/).filter(s => s.trim());
            ideaBlocks.forEach((idea, index) => {
                const titleMatch = idea.match(/TITRE:\s*(.+)/);
                const descMatch = idea.match(/DESC:\s*(.+)/);
                const promptMatch = idea.match(/PROMPT:\s*(.+)/);
                
                if (titleMatch && promptMatch) {
                    trends.push({
                        id: `idea-${baseId}-${index}-${Math.random().toString(36).substr(2, 5)}`,
                        type: 'idea',
                        title: titleMatch[1].trim(),
                        desc: descMatch ? descMatch[1].trim() : '',
                        prompt: promptMatch[1].trim()
                    });
                }
            });
            
            // Parser les pubs
            const pubBlocks = response.split(/PUB \d+/).filter(s => s.trim() && s.includes('OBJECTIF'));
            pubBlocks.forEach((pub, index) => {
                const titleMatch = pub.match(/TITRE:\s*(.+)/);
                const descMatch = pub.match(/DESC:\s*(.+)/);
                const promptMatch = pub.match(/PROMPT:\s*(.+)/);
                const objectiveMatch = pub.match(/OBJECTIF:\s*(.+)/);
                
                if (titleMatch && promptMatch) {
                    trends.push({
                        id: `pub-${baseId}-${index}-${Math.random().toString(36).substr(2, 5)}`,
                        type: 'pub',
                        title: titleMatch[1].trim(),
                        desc: descMatch ? descMatch[1].trim() : '',
                        prompt: promptMatch[1].trim(),
                        objective: objectiveMatch ? objectiveMatch[1].trim() : 'conversion'
                    });
                }
            });
            
            return trends;
        }

        function saveTrendsToHistory(trends) {
            if (trends && trends.length > 0) {
                TrendsHistory.saveToHistory(trends);
            }
        }

        // Variable globale pour stocker les trends courantes
        let currentTrends = [];

        function displayTrends(trends) {
            // Stocker les trends pour le bouton "Garder"
            currentTrends = trends;
            
            let html = '<p style="margin-bottom: 20px; color: #666;">Basées sur ton profil. Clique sur une idée ou sauvegarde-la pour plus tard !</p>';
            
            // Séparer idées et pubs
            const savedIds = TrendsHistory.getSavedIdeas().map(s => s.id);
            
            // Afficher toutes les trends avec leur index global
            const ideas = [];
            const pubs = [];
            
            trends.forEach((trend, index) => {
                if (trend.type === 'pub') {
                    pubs.push({ trend, index });
                } else {
                    ideas.push({ trend, index });
                }
            });
            
            if (ideas.length > 0) {
                html += '<h3 style="color: #667eea; margin-bottom: 15px;">🔥 Idées tendance</h3>';
                ideas.forEach(({ trend, index }) => {
                    const isSaved = savedIds.includes(trend.id);
                    html += renderTrendCard(trend, isSaved, index);
                });
            }
            
            if (pubs.length > 0) {
                html += '<h3 style="color: #f5576c; margin: 30px 0 15px;">💰 Angles publicitaires suggérés</h3>';
                pubs.forEach(({ trend, index }) => {
                    const isSaved = savedIds.includes(trend.id);
                    html += renderPubCard(trend, isSaved, index);
                });
            }
            
            if (trends.length === 0) {
                html = '<p style="text-align: center; color: #999; padding: 40px;">Aucune tendance générée. Clique sur "🔥 Nouvelles idées" pour en générer !</p>';
            }
            
            // Bouton pour régénérer
            html += `
                <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px dashed #e0e0e0;">
                    <button onclick="generateNewTrends()" style="
                        padding: 12px 25px;
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        border: none;
                        border-radius: 25px;
                        font-size: 0.95em;
                        font-weight: 600;
                        cursor: pointer;
                        font-family: inherit;
                        transition: all 0.3s;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        🔄 Générer de nouvelles idées
                    </button>
                </div>
            `;
            
            document.getElementById('trendsContent').innerHTML = html;
        }

        function renderTrendCard(idea, isSaved = false, index) {
            const escapedPrompt = idea.prompt.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            return `
                <div class="trend-card">
                    <div class="trend-title">${idea.title}</div>
                    <div class="trend-desc">${idea.desc}</div>
                    <div class="trend-actions">
                        <button class="trend-use-btn" onclick="event.stopPropagation(); useTrendPrompt('${escapedPrompt}')">
                            ✨ Utiliser cette idée
                        </button>
                        <button class="trend-save-btn ${isSaved ? 'saved' : ''}" 
                                onclick="event.stopPropagation(); saveIdeaByIndex(${index}, this)">
                            ${isSaved ? '⭐ Sauvegardée' : '⭐ Garder'}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderPubCard(pub, isSaved = false, index) {
            const escapedPrompt = pub.prompt.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            return `
                <div class="trend-card" style="border-left-color: #f5576c; background: linear-gradient(135deg, #fff5f7, #fef0f5);">
                    <div class="trend-title" style="color: #f5576c;">${pub.title}</div>
                    <div class="trend-desc">${pub.desc}</div>
                    <div class="trend-tags">
                        <span style="font-size: 0.75em; padding: 3px 10px; background: #f5576c; color: white; border-radius: 20px;">📢 PUB</span>
                        <span style="font-size: 0.75em; padding: 3px 10px; background: rgba(245,87,108,0.1); color: #f5576c; border-radius: 20px;">🎯 ${pub.objective}</span>
                    </div>
                    <div class="trend-actions">
                        <button class="trend-use-btn" style="background: linear-gradient(135deg, #f5576c, #f093fb);" 
                                onclick="event.stopPropagation(); usePubPrompt('${escapedPrompt}', '${pub.objective}')">
                            📢 Créer cette pub
                        </button>
                        <button class="trend-save-btn ${isSaved ? 'saved' : ''}" 
                                onclick="event.stopPropagation(); saveIdeaByIndex(${index}, this)">
                            ${isSaved ? '⭐ Sauvegardée' : '⭐ Garder'}
                        </button>
                    </div>
                </div>
            `;
        }

        function saveIdeaByIndex(index, btnElement) {
            const idea = currentTrends[index];
            if (!idea) {
                showToast('❌ Erreur : idée non trouvée. Régénère les idées.');
                return;
            }
            
            if (TrendsHistory.saveIdea(idea)) {
                showToast('⭐ Idée sauvegardée !');
                updateSavedCount();
                btnElement.classList.add('saved');
                btnElement.innerHTML = '⭐ Sauvegardée';
            }
        }

        // Ancienne fonction pour compatibilité (peut être supprimée plus tard)
        function saveIdeaById(ideaId, btnElement) {
            const idea = currentTrends.find(t => t.id === ideaId);
            if (!idea) {
                showToast('❌ Erreur : idée non trouvée. Régénère les idées.');
                return;
            }
            
            if (TrendsHistory.saveIdea(idea)) {
                showToast('⭐ Idée sauvegardée !');
                updateSavedCount();
                btnElement.classList.add('saved');
                btnElement.innerHTML = '⭐ Sauvegardée';
            }
        }

        function updateSavedCount() {
            const count = TrendsHistory.getSavedIdeas().length;
            const badge = document.getElementById('savedCount');
            if (badge) badge.textContent = count;
        }

        function switchTrendsTab(tab) {
            // Mettre à jour les onglets
            document.querySelectorAll('.trends-tab').forEach(t => t.classList.remove('active'));
            
            // Masquer tous les contenus
            document.getElementById('trendsContent').style.display = 'none';
            document.getElementById('savedIdeasContent').style.display = 'none';
            document.getElementById('historyContent').style.display = 'none';
            
            if (tab === 'new') {
                document.getElementById('tabNewIdeas').classList.add('active');
                document.getElementById('trendsContent').style.display = 'block';
                // Si pas d'idées, afficher l'écran d'accueil
                if (currentTrends.length === 0) {
                    displayTrendsWelcome();
                }
            } else if (tab === 'saved') {
                document.getElementById('tabSavedIdeas').classList.add('active');
                document.getElementById('savedIdeasContent').style.display = 'block';
                displaySavedIdeas();
            } else if (tab === 'history') {
                document.getElementById('tabHistory').classList.add('active');
                document.getElementById('historyContent').style.display = 'block';
                displayTrendsHistory();
            }
        }

        function displaySavedIdeas() {
            const saved = TrendsHistory.getSavedIdeas();
            let html = '';
            
            if (saved.length === 0) {
                html = '<p style="text-align: center; color: #999; padding: 40px;">Aucune idée sauvegardée. Clique sur "⭐ Garder" pour en ajouter !</p>';
            } else {
                html = `<p style="margin-bottom: 15px; color: #666;">${saved.length} idée${saved.length > 1 ? 's' : ''} sauvegardée${saved.length > 1 ? 's' : ''}</p>`;
                saved.forEach(idea => {
                    const escapedPrompt = idea.prompt.replace(/'/g, "\\'");
                    const dateStr = new Date(idea.savedAt).toLocaleDateString('fr-FR');
                    
                    if (idea.type === 'pub') {
                        html += `
                            <div class="trend-card saved-idea-card" style="border-left-color: #ffc107;">
                                <div class="trend-title" style="color: #f5576c;">${idea.title}</div>
                                <div class="trend-desc">${idea.desc}</div>
                                <div class="trend-tags">
                                    <span style="font-size: 0.75em; padding: 3px 10px; background: #f5576c; color: white; border-radius: 20px;">📢 PUB</span>
                                </div>
                                <div class="saved-idea-date">Sauvegardée le ${dateStr}</div>
                                <div class="trend-actions">
                                    <button class="trend-use-btn" style="background: linear-gradient(135deg, #f5576c, #f093fb);" 
                                            onclick="usePubPrompt('${escapedPrompt}', '${idea.objective || 'conversion'}')">
                                        📢 Utiliser
                                    </button>
                                    <button class="trend-delete-btn" onclick="removeSavedIdea('${idea.id}')">
                                        🗑️ Supprimer
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="trend-card saved-idea-card" style="border-left-color: #ffc107;">
                                <div class="trend-title">${idea.title}</div>
                                <div class="trend-desc">${idea.desc}</div>
                                <div class="saved-idea-date">Sauvegardée le ${dateStr}</div>
                                <div class="trend-actions">
                                    <button class="trend-use-btn" onclick="useTrendPrompt('${escapedPrompt}')">
                                        ✨ Utiliser
                                    </button>
                                    <button class="trend-delete-btn" onclick="removeSavedIdea('${idea.id}')">
                                        🗑️ Supprimer
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            document.getElementById('savedIdeasContent').innerHTML = html;
        }

        function displayTrendsHistory() {
            const history = TrendsHistory.getHistory();
            let html = '';
            
            if (history.length === 0) {
                html = '<p style="text-align: center; color: #999; padding: 40px;">Aucun historique. Les tendances générées apparaîtront ici pendant 14 jours.</p>';
            } else {
                history.forEach(session => {
                    const dateStr = new Date(session.generatedAt).toLocaleDateString('fr-FR', { 
                        weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' 
                    });
                    
                    html += `<div style="margin-bottom: 25px;">`;
                    html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="color: #667eea; font-size: 0.9em; margin: 0;">📅 ${dateStr}</h4>
                        <button class="trend-delete-btn" onclick="removeHistorySession('${session.id}')" title="Supprimer cette session">🗑️</button>
                    </div>`;
                    
                    session.trends.forEach(trend => {
                        const escapedPrompt = trend.prompt.replace(/'/g, "\\'");
                        if (trend.type === 'pub') {
                            html += `
                                <div class="trend-card" style="border-left-color: #f5576c; background: #fef7f8; padding: 12px;">
                                    <div class="trend-title" style="font-size: 0.95em; color: #f5576c;">${trend.title}</div>
                                    <div class="trend-actions" style="margin-top: 8px;">
                                        <button class="trend-use-btn" style="padding: 4px 12px; font-size: 0.75em; background: linear-gradient(135deg, #f5576c, #f093fb);" 
                                                onclick="usePubPrompt('${escapedPrompt}', '${trend.objective || 'conversion'}')">
                                            📢 Utiliser
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else {
                            html += `
                                <div class="trend-card" style="padding: 12px;">
                                    <div class="trend-title" style="font-size: 0.95em;">${trend.title}</div>
                                    <div class="trend-actions" style="margin-top: 8px;">
                                        <button class="trend-use-btn" style="padding: 4px 12px; font-size: 0.75em;" 
                                                onclick="useTrendPrompt('${escapedPrompt}')">
                                            ✨ Utiliser
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    html += `</div>`;
                });
            }
            
            document.getElementById('historyContent').innerHTML = html;
        }

        function removeSavedIdea(ideaId) {
            TrendsHistory.removeIdea(ideaId);
            showToast('🗑️ Idée supprimée');
            updateSavedCount();
            displaySavedIdeas();
        }

        function removeHistorySession(sessionId) {
            TrendsHistory.removeHistorySession(sessionId);
            showToast('🗑️ Session supprimée');
            displayTrendsHistory();
        }

        function useTrendPrompt(prompt) {
            document.getElementById('ideaInput').value = prompt;
            closeTrends();
            showToast('💡 Idée copiée ! Tu peux générer ton contenu');
            // Scroll vers le champ
            document.getElementById('ideaSection').scrollIntoView({ behavior: 'smooth' });
        }

        function usePubPrompt(prompt, objective) {
            // Sélectionner le format PUB
            document.querySelectorAll('.format-chip').forEach(c => c.classList.remove('active'));
            const pubChip = document.querySelector('.format-chip[data-format="pub"]');
            if (pubChip) {
                pubChip.classList.add('active');
                currentState.format = 'pub';
                document.getElementById('pubOptionsSection').style.display = 'block';
            }
            
            // Sélectionner l'objectif correspondant
            const objectiveMap = { 'conversion': 'conversion', 'trafic': 'trafic', 'leads': 'leads', 'notoriete': 'notoriete', 'engagement': 'engagement' };
            const mappedObjective = objectiveMap[objective.toLowerCase()] || 'conversion';
            document.querySelectorAll('.pub-objective-chip').forEach(c => c.classList.remove('active'));
            const objChip = document.querySelector(`.pub-objective-chip[data-objective="${mappedObjective}"]`);
            if (objChip) {
                objChip.classList.add('active');
                currentState.pubObjective = mappedObjective;
            }
            
            // Mettre le prompt dans le champ
            document.getElementById('ideaInput').value = prompt;
            closeTrends();
            showToast('📢 Angle pub sélectionné ! Génère ta pub');
            document.getElementById('ideaSection').scrollIntoView({ behavior: 'smooth' });
        }

        function closeTrends() {
            document.getElementById('trendsModal').classList.remove('show');
            // Reset sur l'onglet "Nouvelles idées"
            switchTrendsTab('new');
        }

        // ==================== GUIDE-MOI INTELLIGENT ====================
        async function guideMe() {
            const profile = UserProfile.get();
            const memory = ContentMemory.getSummaryForAI();
            const out = document.getElementById('outputContent');
            out.innerHTML = `<div class="output-text" id="streamOutput"></div>`;
            document.getElementById('actionButtons').style.display = 'none';
            
            // Déterminer le pilier à privilégier
            const nextPillar = profile?.piliers ? ContentMemory.getNextPillar(profile.piliers) : null;
            
            // Contexte utilisateur OU client agence
            let context = '';
            const clientProfile = AgencySystem.getClientProfileForAI();
            
            if (clientProfile) {
                // Mode Agence : utiliser le profil client
                context = `🏢 MODE AGENCE - Génération pour un client :

${clientProfile}`;
            } else if (profile?.nom) {
                context = `Tu parles à ${profile.nom}.
Domaine : ${profile.domaine || 'Non précisé'}
Piliers de contenu : ${profile.piliers?.join(', ') || 'Non précisés'}
Style : ${profile.style || 'Non précisé'}
Objectif : ${profile.objectif || 'Non précisé'}`;
            }
            
            let memoryContext = '';
            if (memory && memory.totalContents > 0) {
                memoryContext = `

📊 HISTORIQUE (pour proposer du NOUVEAU) :
- ${memory.totalContents} contenus déjà créés
- Sujets récents : ${memory.recentTopics}
- Pilier le plus utilisé : ${memory.pillarStats}
- Dernier pilier : ${memory.lastPillar}

⚡ IMPORTANT : Propose des idées sur des angles NOUVEAUX, pas déjà abordés !`;
            }

            const prompt = `${context}${memoryContext}

Tu es Tithot, coach créative en personal branding. L'utilisateur ne sait pas quoi poster.

${nextPillar ? `🎯 PILIER SUGGÉRÉ : "${nextPillar}" (à privilégier car moins utilisé récemment)` : ''}

Propose 5 IDÉES DE CONTENU personnalisées et NOUVELLES.

Pour chaque idée :
1. 🎯 Le sujet/angle (en gras) - INDIQUE LE PILIER concerné
2. 📖 La structure narrative recommandée
3. 🎬 Le format idéal
4. 💡 L'accroche possible

${memoryContext ? 'ÉVITE les sujets déjà traités récemment !' : ''}

Numérote : **IDÉE 1**, **IDÉE 2**, etc.`;

            try {
                await callAIStream(prompt, document.getElementById('streamOutput'));
                addIdeaButtons();
            } catch (e) {
                out.innerHTML = `<div class="output-placeholder"><p>❌ ${e.message}</p></div>`;
            }
        }

        function addIdeaButtons() {
            const out = document.getElementById('streamOutput');
            currentState.ideasContent = out.innerText;
            const div = document.createElement('div');
            div.style.cssText = 'margin-top: 25px; padding-top: 20px; border-top: 2px dashed #e0e0e0;';
            div.innerHTML = `
                <p style="font-weight: 600; color: #f5576c; margin-bottom: 15px;">🚀 Développer une idée en contenu complet :</p>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <button class="idea-btn" onclick="developIdea(1)">📝 Idée 1</button>
                    <button class="idea-btn" onclick="developIdea(2)">📝 Idée 2</button>
                    <button class="idea-btn" onclick="developIdea(3)">📝 Idée 3</button>
                    <button class="idea-btn" onclick="developIdea(4)">📝 Idée 4</button>
                    <button class="idea-btn" onclick="developIdea(5)">📝 Idée 5</button>
                </div>`;
            out.appendChild(div);
        }

        async function developIdea(n) {
            const profile = UserProfile.get();
            const out = document.getElementById('outputContent');
            out.innerHTML = `<div class="output-text" id="streamOutput"></div>`;
            

            const prompt = `Tu avais proposé ces idées :
${currentState.ideasContent}

Développe l'IDÉE ${n} en contenu COMPLET.

## 📝 Texte du post
[Texte complet avec la structure narrative appropriée]

## 💬 Légende
[Légende courte et accrocheuse]

## #️⃣ Hashtags
[10-15 hashtags pertinents]

${profile ? `Adapte au style ${profile.style}, plateforme ${currentState.platform}` : ''}`;

            try {
                await callAIStream(prompt, document.getElementById('streamOutput'));
                currentState.generatedContent = document.getElementById('streamOutput')?.innerText || '';
                
                // Sauvegarder dans la mémoire
                const profile = UserProfile.get();
                ContentMemory.addContent(currentState.generatedContent, currentState.currentPillar, currentState.platform, currentState.format);
                ProgressionSystem.trackContent(currentState.platform, currentState.format);
                if (AgencySystem.isAgencyMode()) {
                    AgencySystem.trackContent(currentState.platform, currentState.format, currentState.structure, currentState.generatedContent);
                }
                updateMemoryIndicator();
                
                document.getElementById('actionButtons').style.display = 'flex'; document.getElementById('visualSection').style.display = 'block';
            } catch (e) {
                out.innerHTML = `<div class="output-placeholder"><p>❌ ${e.message}</p></div>`;
            }
        }

        // ==================== GÉNÉRATION CONTENU ====================
        async function generateContent() {
            const idea = document.getElementById('ideaInput').value.trim();
            if (!idea) { showToast('💡 Décris ton idée !'); return; }

            // Son de clic
            SoundSystem.playClick();

            currentState.idea = idea;
            const btn = document.getElementById('generateBtn');
            btn.disabled = true; btn.innerHTML = '⏳ Génération...';
            
            const out = document.getElementById('outputContent');
            out.innerHTML = `<div class="output-text" id="streamOutput"></div>`;

            const profile = UserProfile.get();
            const struct = STRUCTURES[currentState.structure];
            const fmt = FORMATS[currentState.format] || { name: 'Publicité', length: 'court et percutant', specifics: 'accroche + corps + CTA' };
            const plat = PLATFORMS[currentState.platform];
            
            // Contexte utilisateur OU client agence
            let ctx = '';
            const clientProfile = AgencySystem.getClientProfileForAI();
            
            if (clientProfile) {
                // Mode Agence : utiliser le profil client
                ctx = `🏢 MODE AGENCE - Génération pour un client :

${clientProfile}`;
            } else if (profile?.nom) {
                ctx = `Profil : ${profile.nom}, domaine ${profile.domaine || 'non précisé'}, style ${profile.style || 'authentique'}.`;
            }

            let prompt;
            
            // Si c'est une PUB, utiliser un prompt spécial
            if (currentState.format === 'pub') {
                const pubPlatformNames = {
                    meta: 'Meta Ads (Facebook & Instagram)',
                    linkedin: 'LinkedIn Ads',
                    tiktok: 'TikTok Ads',
                    google: 'Google Ads'
                };
                const pubObjectiveNames = {
                    conversion: 'Conversion (vente, inscription)',
                    trafic: 'Trafic (clics vers site)',
                    notoriete: 'Notoriété (visibilité marque)',
                    engagement: 'Engagement (likes, commentaires, partages)',
                    leads: 'Génération de leads (formulaire)'
                };
                
                prompt = `${ctx}

📢 CRÉATION DE PUBLICITÉ

SUJET/OFFRE : "${currentState.idea}"

- Plateforme publicitaire : ${pubPlatformNames[currentState.pubPlatform] || 'Meta Ads'}
- Objectif : ${pubObjectiveNames[currentState.pubObjective] || 'Conversion'}
- Structure narrative : ${struct.name} (${struct.prompt})

Génère une publicité COMPLÈTE avec :

1. 🎯 **HOOK** (accroche - 1-2 phrases max, ultra percutante)
   Doit capter l'attention en 3 secondes

2. 💬 **CORPS** (développement - 3-5 lignes)
   Intérêt + Désir selon la structure ${struct.name}

3. 👉 **CTA** (appel à l'action - 1 phrase)
   Clair, urgent, aligné avec l'objectif ${pubObjectiveNames[currentState.pubObjective]}

---

🔄 **VARIANTE A/B #1** (angle douleur)
Hook alternatif + CTA

🔄 **VARIANTE A/B #2** (angle résultat)
Hook alternatif + CTA

🔄 **VARIANTE A/B #3** (angle curiosité)
Hook alternatif + CTA

---

🎨 **VISUEL SUGGÉRÉ**
Un prompt Midjourney adapté au format ${pubPlatformNames[currentState.pubPlatform]} :
- Format carré (1:1) pour Meta/LinkedIn
- Format vertical (9:16) pour TikTok/Stories
- Style professionnel et accrocheur`;
            } else {
                // Génération normale (non-pub)
                prompt = `${ctx}

SUJET : "${currentState.idea}"

- Structure : ${struct.name} (${struct.prompt})
- Format : ${fmt.name} (${fmt.length}, ${fmt.specifics})
- Plateforme : ${plat.name} (ton ${plat.tone})

RÈGLES DE RÉDACTION IMPORTANTES :

1. **HOOK** : Les 2 premières lignes doivent capter l'attention immédiatement (curiosité, émotion, paradoxe)

2. **CAS D'USAGE CONCRET** : Inclus au moins UN exemple concret et visuel que le lecteur peut s'imaginer vivre (ex: "le moment où tu vois...", "imagine quand tu...", "tu sais, ce feeling quand...")

3. **CTA + QUESTION D'ENGAGEMENT** : Termine TOUJOURS par :
   - Une question ouverte qui invite à partager son expérience OU
   - Un appel à l'action clair (commenter, partager, sauvegarder)
   - Exemples : "Et toi, tu as déjà vécu ça ?", "Dis-moi en commentaire...", "Tag quelqu'un qui a besoin de lire ça"

4. **RYTHME** : Varie la longueur des phrases. Phrases courtes pour l'impact. Plus longues pour le développement.

5. **HASHTAGS** : 5-10 hashtags pertinents à la fin, mélange de populaires et niches.

Crée le contenu COMPLET prêt à publier.`;
            }

            // Ajouter les instructions du framework si sélectionné
            const frameworkInstructions = FrameworkSystem.getPromptInstructions();
            if (frameworkInstructions) {
                prompt += frameworkInstructions;
                // Tracker l'usage du framework
                if (FrameworkSystem.selectedFramework) {
                    FrameworkSystem.incrementUsage(FrameworkSystem.selectedFramework);
                }
            }

            try {
                await callAIStream(prompt, document.getElementById('streamOutput'));
                currentState.generatedContent = document.getElementById('streamOutput')?.innerText || '';
                
                // Ajouter le badge de fidélité voix et feedback si profil voix actif
                const streamOutput = document.getElementById('streamOutput');
                if (streamOutput) {
                    const badge = getVoiceFidelityBadge();
                    const feedback = getVoiceFeedback();
                    if (badge) {
                        streamOutput.innerHTML = badge + streamOutput.innerHTML + feedback;
                    }
                }
                
                // Sauvegarder dans la mémoire
                ContentMemory.addContent(currentState.generatedContent, currentState.currentPillar, currentState.platform, currentState.format);
                ProgressionSystem.trackContent(currentState.platform, currentState.format);
                if (AgencySystem.isAgencyMode()) {
                    AgencySystem.trackContent(currentState.platform, currentState.format, currentState.structure, currentState.generatedContent);
                }
                updateMemoryIndicator();
                
                // 📊 Analytics Supabase
                const contentType = currentState.format === 'pub' ? 'pub' : 'organic';
                Analytics.trackContent(currentState.structure, currentState.platform, currentState.format, currentState.currentPillar, contentType);
                
                document.getElementById('actionButtons').style.display = 'flex'; document.getElementById('visualSection').style.display = 'block';
            } catch (e) {
                out.innerHTML = `<div class="output-placeholder"><p>❌ ${e.message}</p></div>`;
            }

            btn.disabled = false; btn.innerHTML = '🚀 Générer mon contenu';
        }

        function regenerateContent() { generateContent(); }
        function copyContent() { navigator.clipboard.writeText(currentState.generatedContent).then(() => showToast('✅ Copié !')); }
        
        // ==================== VOICE FIDELITY BADGE ====================
        function getVoiceFidelityBadge() {
            const profile = UserProfile.get();
            if (!profile?.voiceProfile) return '';
            
            const score = profile.voiceProfile.fidelityScore || 85;
            return `
                <div class="voice-fidelity-badge">
                    <span>🎤</span>
                    <span class="label">Fidélité voix :</span>
                    <span class="score">${score}%</span>
                </div>
            `;
        }
        
        function getVoiceFeedback() {
            const profile = UserProfile.get();
            if (!profile?.voiceProfile) return '';
            
            return `
                <div class="voice-feedback" id="voiceFeedback">
                    <div class="voice-feedback-question">🎯 Ce contenu te ressemble ?</div>
                    <div class="voice-feedback-buttons">
                        <button class="voice-feedback-btn yes" onclick="submitVoiceFeedback(true)">👍 Oui !</button>
                        <button class="voice-feedback-btn no" onclick="submitVoiceFeedback(false)">👎 Pas vraiment</button>
                    </div>
                    <div class="voice-feedback-thanks" id="feedbackThanks">✅ Merci ! Tithot s'améliore.</div>
                </div>
            `;
        }
        
        function submitVoiceFeedback(isPositive) {
            const feedbackDiv = document.getElementById('voiceFeedback');
            const thanksDiv = document.getElementById('feedbackThanks');
            const buttonsDiv = feedbackDiv.querySelector('.voice-feedback-buttons');
            const questionDiv = feedbackDiv.querySelector('.voice-feedback-question');
            
            // Sauvegarder le feedback
            const profile = UserProfile.get();
            if (profile?.voiceProfile) {
                if (!profile.voiceProfile.feedbackHistory) {
                    profile.voiceProfile.feedbackHistory = { positive: 0, negative: 0 };
                }
                
                if (isPositive) {
                    profile.voiceProfile.feedbackHistory.positive++;
                    // Augmenter le score de fidélité si beaucoup de feedback positif
                    const total = profile.voiceProfile.feedbackHistory.positive + profile.voiceProfile.feedbackHistory.negative;
                    const ratio = profile.voiceProfile.feedbackHistory.positive / total;
                    profile.voiceProfile.fidelityScore = Math.min(98, Math.round(70 + (ratio * 28)));
                } else {
                    profile.voiceProfile.feedbackHistory.negative++;
                    // Suggérer d'ajouter plus de textes
                    showToast('💡 Ajoute plus de textes dans "Ma Voix" pour améliorer la fidélité !');
                }
                
                UserProfile.save(profile);
            }
            
            // Animation
            buttonsDiv.style.display = 'none';
            questionDiv.style.display = 'none';
            thanksDiv.style.display = 'block';
        }

        // ==================== EXPORT & PUBLICATION ====================
        const PARTNER_LINKS = {
            metricool: 'https://metricool.com/?via=sosstorytelling',
            swello: 'https://swello.com/fr/?ref=sosstorytelling',
            agorapulse: 'https://www.agorapulse.com/?ref=sosstorytelling',
            buffer: 'https://buffer.com/?ref=sosstorytelling'
        };

        function showExportModal() {
            if (!currentState.generatedContent) {
                showToast('❌ Génère d\'abord du contenu !');
                return;
            }
            // Mettre à jour l'aperçu
            const preview = document.getElementById('exportPreview');
            const content = currentState.generatedContent;
            preview.textContent = content.length > 300 ? content.substring(0, 300) + '...' : content;
            
            document.getElementById('exportModal').classList.add('show');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('show');
        }

        function exportCopyContent() {
            navigator.clipboard.writeText(currentState.generatedContent).then(() => {
                showToast('✅ Contenu copié !');
            });
        }

        function exportDownloadCSV() {
            const profile = UserProfile.get();
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0].substring(0, 5);
            
            const platform = currentState.platform || 'linkedin';
            const format = currentState.format || 'post';
            const content = currentState.generatedContent.replace(/"/g, '""');
            
            const csv = `"Date","Heure","Plateforme","Format","Contenu"
"${dateStr}","${timeStr}","${platform}","${format}","${content}"`;
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `sos-storytelling-${dateStr}.csv`;
            link.click();
            
            showToast('📊 CSV téléchargé !');
        }

        function exportOpenLinkedIn() {
            navigator.clipboard.writeText(currentState.generatedContent).then(() => {
                showToast('✅ Copié ! LinkedIn s\'ouvre...');
                setTimeout(() => {
                    window.open('https://www.linkedin.com/feed/', '_blank');
                }, 500);
            });
        }

        function exportToPartner(partner) {
            // Télécharger le CSV
            exportDownloadCSV();
            
            // Messages personnalisés par partenaire
            const messages = {
                metricool: 'CSV téléchargé ! Importe-le dans Metricool via Zapier ou Make.',
                swello: 'CSV téléchargé ! Va dans Swello → Programmation → Import CSV.',
                agorapulse: 'CSV téléchargé ! Va dans Agorapulse → Publish → Bulk Import.',
                buffer: 'Contenu copié ! Colle-le dans Buffer Composer.'
            };
            
            setTimeout(() => {
                showToast('🚀 ' + (messages[partner] || 'Export terminé !'));
                // Ouvrir le site partenaire avec lien affilié
                if (PARTNER_LINKS[partner]) {
                    window.open(PARTNER_LINKS[partner], '_blank');
                }
            }, 800);
            
            closeExportModal();
        }

        // Fermer modal au clic extérieur
        document.getElementById('exportModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeExportModal();
        });

        // ==================== VARIANTES ====================
        async function generateVariantes() {
            if (!currentState.generatedContent) { showToast('❌ Génère d\'abord'); return; }
            
            // Ajouter à la suite dans le même panneau
            const outputContent = document.getElementById('outputContent');
            const streamOutput = document.getElementById('streamOutput');
            
            // Créer un nouveau div pour les variantes
            const variantesDiv = document.createElement('div');
            variantesDiv.id = 'variantesStreamOutput';
            variantesDiv.className = 'output-text';
            variantesDiv.style.cssText = 'margin-top: 30px; padding-top: 25px; border-top: 3px dashed #f093fb;';
            variantesDiv.innerHTML = '<h2 style="color: #f5576c;">🎭 3 Variantes de ton contenu</h2>';
            streamOutput.appendChild(variantesDiv);
            
            // Scroll vers le bas
            outputContent.scrollTop = outputContent.scrollHeight;
            
            const prompt = `TEXTE ORIGINAL :
"${currentState.generatedContent.substring(0, 800)}"

Propose 3 VARIANTES :

## 🎭 VARIANTE 1 : Ton INSPIRANT
[Plus d'émotion, d'inspiration]

## 🎯 VARIANTE 2 : Ton DIRECT/PUNCHY
[Plus percutant, sans détour]

## 😄 VARIANTE 3 : Ton STORYTELLING
[Comme une histoire personnelle]`;

            try { 
                await callAIStream(prompt, variantesDiv); 
                currentState.generatedContent += '\n\n' + variantesDiv.innerText;
            } catch (e) { 
                variantesDiv.innerHTML += `<p>❌ ${e.message}</p>`; 
            }
        }

        // ==================== MIDJOURNEY ====================
        async function generateMidjourney(btn) {
            if (!currentState.generatedContent) { showToast('❌ Génère d\'abord'); return; }
            
            // Effet visuel sur le bouton
            if (btn) showSentEffect(btn);
            
            const outputContent = document.getElementById('outputContent');
            const streamOutput = document.getElementById('streamOutput');
            
            const mjDiv = document.createElement('div');
            mjDiv.className = 'output-text';
            mjDiv.style.cssText = 'margin-top: 30px; padding-top: 25px; border-top: 3px dashed #5865F2;';
            mjDiv.innerHTML = '<h2 style="color: #5865F2;">🎨 Prompts Midjourney</h2>';
            streamOutput.appendChild(mjDiv);
            outputContent.scrollTop = outputContent.scrollHeight;
            
            const prompt = `Contenu : "${currentState.generatedContent.substring(0, 500)}..."

Génère 3 CONCEPTS VISUELS pour Midjourney, avec 2 VARIATIONS chacun.

Pour chaque concept :
1. Décris le style visuel
2. Donne le PROMPT PRINCIPAL en anglais (bloc de code)
3. Donne 2 VARIATIONS du même concept (ambiances différentes)

---

## 🖼️ CONCEPT 1 : [Style - ex: Photo corporate moderne]

**Prompt principal :**
\`\`\`
[prompt détaillé avec --ar 1:1 --v 6]
\`\`\`

**Variation A - Ambiance lumineuse/optimiste :**
\`\`\`
[même concept, tons clairs, lumière naturelle]
\`\`\`

**Variation B - Ambiance dramatique/contrastée :**
\`\`\`
[même concept, clair-obscur, tons profonds]
\`\`\`

---

## 🖼️ CONCEPT 2 : [Style - ex: Illustration flat design]

**Prompt principal :**
\`\`\`
[prompt]
\`\`\`

**Variation A - Couleurs chaudes :**
\`\`\`
[version orange, rouge, jaune]
\`\`\`

**Variation B - Couleurs froides :**
\`\`\`
[version bleu, violet, vert]
\`\`\`

---

## 🖼️ CONCEPT 3 : [Style - ex: 3D render minimaliste]

**Prompt principal :**
\`\`\`
[prompt]
\`\`\`

**Variation A - Vue rapprochée/détail :**
\`\`\`
[close-up, macro]
\`\`\`

**Variation B - Vue large/contexte :**
\`\`\`
[wide shot, environnement]
\`\`\`

Inclus toujours les paramètres Midjourney (--ar, --v 6, --style raw si pertinent).`;

            try {
                await callAIStream(prompt, mjDiv);
                addCopyButton(mjDiv, '📋 Copier les 9 prompts Midjourney');
            } catch (e) { mjDiv.innerHTML += '<p>❌ ' + e.message + '</p>'; }
        }

        // ==================== DALL-E ====================
        async function generateDalle(btn) {
            if (!currentState.generatedContent) { showToast('❌ Génère d\'abord'); return; }
            
            // Effet visuel sur le bouton
            if (btn) showSentEffect(btn);
            
            const outputContent = document.getElementById('outputContent');
            const streamOutput = document.getElementById('streamOutput');
            
            const dalleDiv = document.createElement('div');
            dalleDiv.className = 'output-text';
            dalleDiv.style.cssText = 'margin-top: 30px; padding-top: 25px; border-top: 3px dashed #10a37f;';
            dalleDiv.innerHTML = '<h2 style="color: #10a37f;">🤖 Prompts DALL-E (ChatGPT)</h2>';
            streamOutput.appendChild(dalleDiv);
            outputContent.scrollTop = outputContent.scrollHeight;
            
            const prompt = `Contenu : "${currentState.generatedContent.substring(0, 500)}..."

Génère 3 CONCEPTS VISUELS pour DALL-E (ChatGPT), avec 2 VARIATIONS chacun.

Les prompts DALL-E doivent être descriptifs et clairs (pas de paramètres techniques).

---

## 🤖 CONCEPT 1 : [Style - ex: Photo réaliste]

**Prompt principal :**
\`\`\`
[description détaillée de l'image souhaitée]
\`\`\`

**Variation A - Version épurée/minimaliste :**
\`\`\`
[même concept avec fond simple, moins d'éléments]
\`\`\`

**Variation B - Version riche/détaillée :**
\`\`\`
[même concept avec plus de détails, environnement complet]
\`\`\`

---

## 🤖 CONCEPT 2 : [Style - ex: Illustration digitale]

**Prompt principal :**
\`\`\`
[description]
\`\`\`

**Variation A - Style cartoon/friendly :**
\`\`\`
[version plus ludique et accessible]
\`\`\`

**Variation B - Style professionnel/corporate :**
\`\`\`
[version plus sérieuse et business]
\`\`\`

---

## 🤖 CONCEPT 3 : [Style - ex: Concept art]

**Prompt principal :**
\`\`\`
[description]
\`\`\`

**Variation A - Palette de jour :**
\`\`\`
[lumière naturelle, couleurs vives]
\`\`\`

**Variation B - Palette de nuit/soirée :**
\`\`\`
[éclairage artificiel, ambiance cosy ou mystérieuse]
\`\`\`

Précise toujours le style artistique souhaité dans chaque prompt.`;

            try {
                await callAIStream(prompt, dalleDiv);
                addCopyButton(dalleDiv, '📋 Copier les 9 prompts DALL-E');
            } catch (e) { dalleDiv.innerHTML += '<p>❌ ' + e.message + '</p>'; }
        }

        // ==================== CANVA ====================
        async function generateCanva(btn) {
            if (!currentState.generatedContent) { showToast('❌ Génère d\'abord'); return; }
            
            // Effet visuel sur le bouton
            if (btn) showSentEffect(btn);
            
            const outputContent = document.getElementById('outputContent');
            const streamOutput = document.getElementById('streamOutput');
            
            const canvaDiv = document.createElement('div');
            canvaDiv.className = 'output-text';
            canvaDiv.style.cssText = 'margin-top: 30px; padding-top: 25px; border-top: 3px dashed #00C4CC;';
            canvaDiv.innerHTML = '<h2 style="color: #7B2D8E;">🎬 Suggestions visuelles Canva</h2>';
            streamOutput.appendChild(canvaDiv);
            outputContent.scrollTop = outputContent.scrollHeight;
            
            const prompt = `Contenu : "${currentState.generatedContent.substring(0, 500)}..."

Génère 3 SUGGESTIONS DE VISUELS à créer sur Canva avec ses propres photos/vidéos.

Pour chaque suggestion :
1. **Type de visuel** (carousel, post simple, reel, story)
2. **Composition** : comment organiser les éléments
3. **B-roll / Photos perso** : quoi filmer ou photographier soi-même
4. **Éléments Canva** : templates, formes, icônes, typographies suggérées
5. **Texte à intégrer** : les phrases clés du contenu

## 📱 SUGGESTION 1 : [Type]
**Composition :**
[Description de la mise en page]

**À filmer/photographier :**
- [Idée de B-roll 1]
- [Idée de B-roll 2]

**Éléments Canva :**
- Template : [suggestion]
- Couleurs : [palette]
- Typo : [style]

**Texte à intégrer :**
"[phrase accrocheuse du contenu]"

---

## 📱 SUGGESTION 2 : [Type]
...

## 📱 SUGGESTION 3 : [Type]
...`;

            try {
                await callAIStream(prompt, canvaDiv);
                addCopyButton(canvaDiv, '📋 Copier les suggestions Canva');
            } catch (e) { canvaDiv.innerHTML += `<p>❌ ${e.message}</p>`; }
        }

        // ==================== ORSHOT (Génération d'images) ====================
        async function generateOrshot(type, btn) {
            if (!currentState.generatedContent) {
                showToast('❌ Génère d\'abord du contenu');
                return;
            }

            // Effet visuel sur le bouton
            if (btn) {
                btn.classList.add('sending');
                btn.innerHTML = '⏳ Génération...';
            }

            const resultDiv = document.getElementById('orshotResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 2em; animation: pulse 1s infinite;">🎨</div>
                    <p style="color: #666; margin-top: 10px;">Génération de l'image en cours...</p>
                </div>
            `;

            // Extraire le texte principal (citation, titre, etc.)
            const content = currentState.generatedContent.substring(0, 300);
            const userProfile = UserProfile.get();

            try {
                // Construire l'URL correctement
                const baseUrl = API_URL.replace(/\/$/, ''); // Enlever le slash final si présent

                // Mapper le type vers content_type et template_id valides
                const typeMapping = {
                    quote: { content_type: 'quote', template_id: 'quote_minimal' },
                    carousel: { content_type: 'carrousel_instagram', template_id: 'carrousel_ig_minimal' },
                    post: { content_type: 'post_instagram', template_id: 'post_ig_minimal' }
                };
                const mapping = typeMapping[type] || typeMapping.post;

                const response = await fetch(`${baseUrl}/api/visuals/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content_type: mapping.content_type,
                        template_id: mapping.template_id,
                        content_data: {
                            quote: content,
                            author: userProfile?.nom || 'Auteur',
                            title: 'Citation du jour',
                            subtitle: userProfile?.domaine || '',
                            text: content
                        },
                        output_format: 'png'
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                if (data.image_url) {
                    resultDiv.innerHTML = `
                        <div style="background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 10px; color: #333;">🖼️ Visuel généré</h4>
                            <img src="${data.image_url}" alt="Visuel généré" style="max-width: 100%; border-radius: 8px; margin-bottom: 10px;">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <a href="${data.image_url}" download="visuel-orshot.png" class="action-btn" style="text-decoration: none; background: #10b981; border: none; color: white; font-size: 0.85em;">
                                    💾 Télécharger
                                </a>
                                <button class="action-btn" onclick="navigator.clipboard.writeText('${data.image_url}').then(() => showToast('✅ Lien copié !'))" style="background: #667eea; border: none; color: white; font-size: 0.85em;">
                                    📋 Copier le lien
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error('Aucune image générée');
                }

            } catch (e) {
                console.error('Erreur Orshot:', e);
                resultDiv.innerHTML = `
                    <div style="background: #fee2e2; border-radius: 12px; padding: 15px; color: #dc2626;">
                        <strong>❌ Erreur</strong>
                        <p style="margin: 5px 0 0; font-size: 0.9em;">${e.message || 'La génération a échoué. Vérifie que l\'API Orshot est configurée.'}</p>
                    </div>
                `;
            } finally {
                if (btn) {
                    btn.classList.remove('sending');
                    const labels = { quote: '💬 Citation', carousel: '📸 Carrousel', post: '📱 Post visuel' };
                    btn.innerHTML = labels[type] || '🖼️ Générer';
                }
            }
        }

        // Utilitaire pour ajouter bouton copier
        function addCopyButton(element, text) {
            const btn = document.createElement('button');
            btn.className = 'copy-prompt-btn';
            btn.innerHTML = text;
            btn.style.marginTop = '15px';
            btn.onclick = () => navigator.clipboard.writeText(element.innerText).then(() => showToast('✅ Copié !'));
            element.appendChild(btn);
        }

        // ==================== HELP MODAL ====================
        function showHelpModal() { document.getElementById('helpModal').classList.add('show'); }
        function closeHelpModal() { document.getElementById('helpModal').classList.remove('show'); }
        
        async function analyzeText() {
            const text = document.getElementById('helpTextarea').value.trim();
            if (!text) { showToast('❌ Colle un texte'); return; }
            closeHelpModal();
            
            const out = document.getElementById('outputContent');
            out.innerHTML = `<div class="output-text" id="streamOutput"></div>`;
            
            const prompt = `TEXTE À ANALYSER :
"${text}"

## 🔍 Analyse rapide
- Points forts (2-3)
- Points faibles (2-3)

## 🪝 2 Hooks alternatifs
[Propositions plus percutantes]

## ✨ Version optimisée
[Réécriture améliorée]

## 💡 Conseils
[2-3 tips]`;

            try {
                await callAIStream(prompt, document.getElementById('streamOutput'));
                currentState.generatedContent = document.getElementById('streamOutput')?.innerText || '';
                document.getElementById('actionButtons').style.display = 'flex'; document.getElementById('visualSection').style.display = 'block';
            } catch (e) {
                out.innerHTML = `<div class="output-placeholder"><p>❌ ${e.message}</p></div>`;
            }
        }

        // ==================== FAVORIS ====================
        function getFavorites() { return JSON.parse(localStorage.getItem('tithot_favorites') || '[]'); }
        function saveFavorites(fav) { localStorage.setItem('tithot_favorites', JSON.stringify(fav)); }
        
        function saveToFavorites() {
            if (!currentState.generatedContent) { showToast('❌ Aucun contenu'); return; }
            const fav = getFavorites();
            fav.unshift({ id: Date.now(), date: new Date().toLocaleDateString('fr-FR'), content: currentState.generatedContent, platform: currentState.platform, format: currentState.format });
            if (fav.length > 20) fav.pop();
            saveFavorites(fav);
            showToast('❤️ Sauvegardé !');
        }
        
        function showFavorites() {
            const fav = getFavorites();
            const list = document.getElementById('favoritesList');
            if (fav.length === 0) {
                list.innerHTML = '<div class="empty-favorites">Aucun favori.<br>Génère du contenu et clique ❤️ !</div>';
            } else {
                list.innerHTML = fav.map((f, i) => `
                    <div class="favorite-item">
                        <div class="favorite-item-date">${f.date} • ${PLATFORMS[f.platform]?.name || f.platform}</div>
                        <div class="favorite-item-text">${f.content.substring(0, 300)}...</div>
                        <div class="favorite-item-actions">
                            <button class="favorite-item-btn use" onclick="useFavorite(${i})">📝 Utiliser</button>
                            <button class="favorite-item-btn" style="background:#667eea;color:white;" onclick="copyFavorite(${i})">📋 Copier</button>
                            <button class="favorite-item-btn delete" onclick="deleteFavorite(${i})">🗑️</button>
                        </div>
                    </div>`).join('');
            }
            document.getElementById('favoritesModal').classList.add('show');
        }
        
        function closeFavorites() { document.getElementById('favoritesModal').classList.remove('show'); }
        function useFavorite(i) { const f = getFavorites()[i]; currentState.generatedContent = f.content; document.getElementById('outputContent').innerHTML = `<div class="output-text">${formatResponse(f.content)}</div>`; document.getElementById('actionButtons').style.display = 'flex'; document.getElementById('visualSection').style.display = 'block'; closeFavorites(); showToast('📝 Chargé !'); }
        function copyFavorite(i) { navigator.clipboard.writeText(getFavorites()[i].content).then(() => showToast('✅ Copié !')); }
        function deleteFavorite(i) { const f = getFavorites(); f.splice(i, 1); saveFavorites(f); showFavorites(); showToast('🗑️ Supprimé'); }

        // ==================== TOUR GUIDÉ ====================
        const tourSteps = [
            { el: '.btn-trends', title: '📈 TRENDS', text: 'Découvre les tendances du moment ! 5 idées de contenu qui buzzent, adaptées à ton profil. Clique sur une idée pour la développer.', side: 'left' },
            { el: '#structureSection', title: '📖 Structures narratives', text: '<strong>AIDA</strong> pour vendre, <strong>Voyage du Héros</strong> pour inspirer, <strong>Pattern Interrupt</strong> pour surprendre... Chaque structure a son super-pouvoir !', side: 'right' },
            { el: '#formatSection', title: '🎬 Formats & Plateformes', text: 'Post classique, Carousel, Reel, Story... L\'IA adapte la longueur et le ton selon la plateforme choisie.', side: 'left' },
            { el: '#ideaSection', title: '💡 Ton idée', text: 'Décris ton sujet en quelques mots, ou colle un texte existant à améliorer. Pas d\'inspiration ? Explore les <strong>TRENDS</strong> !', side: 'right' },
            { el: '#outputPanel', title: '📄 Zone de résultat', text: 'Ton contenu apparaît ici avec l\'effet machine à écrire. L\'IA se souvient de tes anciens contenus pour toujours proposer du <strong>nouveau</strong> !', side: 'left' },
            { el: '.btn-stats', title: '🏆 Stats & Mode Agence', text: 'Suis ta progression (XP, badges, niveaux) et accède au <strong>Mode Agence</strong> pour gérer plusieurs clients, importer des CSV et suivre tes productions ! 🏢', side: 'right' },
            { el: '.btn-planning', title: '🗓️ Planning IA', text: 'L\'IA analyse tes contenus sauvegardés et te suggère un <strong>planning optimal</strong> : meilleurs créneaux par plateforme, équilibre des piliers, prochaines priorités !', side: 'left' },
            { el: '.btn-voice', title: '🎤 Ma Voix', text: 'LA fonctionnalité unique ! Colle des textes <strong>vraiment écrits par toi</strong> (pas générés par IA) pour que l\'analyse capture ton <strong>ton authentique</strong>. Plus tes textes sont personnels, plus ta voix sera fidèle !', side: 'left' },
            { el: '.btn-favorites', title: '❤️ Favoris', text: 'Sauvegarde tes meilleurs contenus pour les retrouver facilement. Jusqu\'à 20 favoris stockés dans ton navigateur.', side: 'left' },
            { el: '#profileBtn', title: '✏️ Mon profil', text: 'Configure ton personal branding : domaine, piliers de contenu, style, audience... Plus ton profil est complet, plus les contenus sont personnalisés !', side: 'right' },
            { el: '#memoryIndicator', title: '🧠 Mémoire intelligente', text: 'Tithot se souvient de tes contenus ! Elle alterne automatiquement tes piliers et évite de répéter les mêmes sujets.', side: 'left', optional: true }
        ];
        let tourStep = 0;
        
        function startTour() { 
            tourStep = 0; 
            document.getElementById('tourOverlay').classList.add('show'); 
            showTourStep(); 
        }
        
        function showTourStep() {
            // Nettoyer les anciens éléments
            document.querySelectorAll('.tour-tooltip').forEach(t => t.remove());
            document.querySelectorAll('.tour-highlight').forEach(e => e.classList.remove('tour-highlight'));
            document.querySelectorAll('.tour-arrow').forEach(a => a.remove());
            
            // Fin du tour ?
            if (tourStep >= tourSteps.length) { endTour(); return; }
            
            const step = tourSteps[tourStep];
            const el = document.querySelector(step.el);
            
            // Skip si élément non trouvé ou optionnel et caché
            if (!el || (step.optional && el.style.display === 'none')) { 
                tourStep++; 
                showTourStep(); 
                return; 
            }
            
            // Highlight l'élément
            el.classList.add('tour-highlight');
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            setTimeout(() => {
                const rect = el.getBoundingClientRect();
                
                // Créer la tooltip
                const tip = document.createElement('div');
                tip.className = `tour-tooltip side-${step.side}`;
                
                // Positionner verticalement
                const topPos = Math.max(80, Math.min(window.innerHeight - 280, rect.top + rect.height/2 - 100));
                tip.style.top = topPos + 'px';
                
                tip.innerHTML = `
                    <div class="tour-tooltip-step">Étape ${tourStep + 1}/${tourSteps.length}</div>
                    <div class="tour-tooltip-title">${step.title}</div>
                    <div class="tour-tooltip-text">${step.text}</div>
                    <div class="tour-tooltip-progress">
                        ${tourSteps.map((_, i) => `<span class="tour-dot ${i <= tourStep ? 'active' : ''}"></span>`).join('')}
                    </div>
                    <div class="tour-tooltip-buttons">
                        <button class="tour-btn skip" onclick="endTour()">Passer</button>
                        <button class="tour-btn next" onclick="nextTourStep()">${tourStep === tourSteps.length - 1 ? '🎉 Terminer' : 'Suivant →'}</button>
                    </div>`;
                document.body.appendChild(tip);
                
                // Créer la flèche
                const arrow = document.createElement('div');
                arrow.className = `tour-arrow arrow-${step.side}`;
                
                // Positionner la flèche
                const arrowTop = rect.top + rect.height / 2 - 15;
                arrow.style.top = arrowTop + 'px';
                
                if (step.side === 'right') {
                    arrow.style.left = (rect.left - 25) + 'px';
                } else {
                    arrow.style.left = (rect.right + 10) + 'px';
                }
                
                document.body.appendChild(arrow);
                
            }, 400);
        }
        
        function nextTourStep() { 
            tourStep++; 
            showTourStep(); 
        }
        
        function endTour() { 
            document.getElementById('tourOverlay').classList.remove('show'); 
            document.querySelectorAll('.tour-tooltip').forEach(t => t.remove()); 
            document.querySelectorAll('.tour-highlight').forEach(e => e.classList.remove('tour-highlight')); 
            document.querySelectorAll('.tour-arrow').forEach(a => a.remove());
            localStorage.setItem('tithot_tour_done', 'true'); 
            document.getElementById('demoBadge').style.display = 'none'; 
            showToast('🎉 Tu es prêt·e à créer !'); 
        }
        
        function restartTour() {
            localStorage.removeItem('tithot_tour_done');
            document.getElementById('demoBadge').style.display = 'flex';
            startTour();
        }

        // ==================== API ====================
        const API_URL = 'https://sos-storytelling-api.sandra-devonssay.workers.dev/';
        
        async function callAI(prompt, usePerplexity = false) {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    messages: [{ role: 'user', content: prompt }],
                    userProfile: UserProfile.get(),
                    usePerplexity: usePerplexity
                })
            });
            if (!response.ok) throw new Error('Erreur connexion');
            const data = await response.json();
            if (data.content?.[0]?.text) return data.content[0].text;
            throw new Error('Format réponse invalide');
        }
        // Exposer callAI globalement pour les modules externes (newsletter, etc.)
        window.callAI = callAI;

        // Fonction dédiée pour Perplexity (TRENDS, Planning, recherche web)
        async function callPerplexity(prompt) {
            return callAI(prompt, true);
        }

        async function callAIStream(prompt, outputElement, usePerplexity = false) {
            // Afficher animation Lottie
            outputElement.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <dotlottie-wc src="https://lottie.host/31e18ce0-6f4b-474c-8b3e-046e415ea9bb/O5jEMojyhf.lottie" style="width: 200px; height: 200px; margin: 0 auto; display: block;" autoplay loop></dotlottie-wc>
                    <p style="color: #667eea; font-weight: 600; margin-top: 15px;">${usePerplexity ? 'Tithot analyse les tendances...' : 'Tithot réfléchit...'}</p>
                </div>
            `;
            
            try {
                const fullText = await callAI(prompt, usePerplexity);
                await typeText(fullText, outputElement);
                return fullText;
            } catch (error) {
                outputElement.innerHTML = '<p style="color: #ff6b6b;">❌ Erreur : ' + error.message + '</p>';
                throw error;
            }
        }
        
        async function typeText(text, element) {
            const words = text.split(' ');
            let displayed = '';
            for (let i = 0; i < words.length; i++) {
                displayed += (i > 0 ? ' ' : '') + words[i];
                element.innerHTML = formatResponse(displayed);
                const container = document.getElementById('outputContent');
                if (container) container.scrollTop = container.scrollHeight;
                if (i % 5 === 0) await new Promise(r => setTimeout(r, 10));
            }
        }

        function formatResponse(text) {
            return text.replace(/## (.*)/g, '<h2>$1</h2>').replace(/### (.*)/g, '<h3>$1</h3>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/```([\s\S]*?)```/g, '<pre>$1</pre>').replace(/`([^`]+)`/g, '<code>$1</code>').replace(/\n/g, '<br>');
        }
        
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
        function updateProfileButton() { const btn = document.getElementById('profileBtn'); const p = UserProfile.get(); if (p?.nom) btn.innerHTML = `✏️ ${p.nom}`; }
        function showStatsModal() { ProgressionSystem.showStats(); }
        
        // ==================== PLANNING IA ====================
        function showPlanningModal() {
            const modal = document.getElementById('planningModal');
            const content = document.getElementById('planningContent');
            
            // Récupérer les données
            const favorites = getFavorites();
            const profile = UserProfile.get();
            const memory = ContentMemory.getSummaryForAI();
            const agencyData = AgencySystem.get();
            
            // Compter les contenus par pilier et plateforme
            const pillarCounts = {};
            const platformCounts = {};
            
            favorites.forEach(fav => {
                const pillar = fav.pillar || 'Autre';
                const platform = fav.platform || 'unknown';
                pillarCounts[pillar] = (pillarCounts[pillar] || 0) + 1;
                platformCounts[platform] = (platformCounts[platform] || 0) + 1;
            });
            
            // Générer le HTML initial
            content.innerHTML = `
                <div class="planning-intro">
                    <h3>🧠 Assistant Planning Intelligent</h3>
                    <p>L'IA analyse tes contenus sauvegardés et te suggère le meilleur planning basé sur les tendances 2025 et tes piliers de contenu.</p>
                </div>
                
                <div class="planning-stats">
                    <div class="planning-stat">
                        <div class="planning-stat-value">${favorites.length}</div>
                        <div class="planning-stat-label">Contenus sauvegardés</div>
                    </div>
                    <div class="planning-stat">
                        <div class="planning-stat-value">${Object.keys(pillarCounts).length}</div>
                        <div class="planning-stat-label">Piliers actifs</div>
                    </div>
                    <div class="planning-stat">
                        <div class="planning-stat-value">${Object.keys(platformCounts).length}</div>
                        <div class="planning-stat-label">Plateformes</div>
                    </div>
                    <div class="planning-stat">
                        <div class="planning-stat-value">${profile?.piliers?.length || 0}</div>
                        <div class="planning-stat-label">Piliers définis</div>
                    </div>
                </div>
                
                ${favorites.length === 0 ? `
                    <div class="planning-alert warning">
                        <span style="font-size: 1.5em;">💡</span>
                        <div>
                            <strong>Aucun contenu sauvegardé</strong><br>
                            <span style="font-size: 0.9em;">Génère et sauvegarde quelques contenus en favoris pour que l'IA puisse créer ton planning optimal.</span>
                        </div>
                    </div>
                ` : `
                    <button class="planning-generate-btn" onclick="generateAIPlanning()" id="planningGenerateBtn">
                        <span>🚀</span>
                        <span>Générer mon planning optimal</span>
                    </button>
                `}
                
                <div id="planningResults"></div>
            `;
            
            modal.classList.add('show');
        }
        
        function closePlanningModal() {
            document.getElementById('planningModal').classList.remove('show');
        }
        
        async function generateAIPlanning() {
            const btn = document.getElementById('planningGenerateBtn');
            const resultsDiv = document.getElementById('planningResults');
            
            btn.disabled = true;
            btn.innerHTML = '<span>⏳</span><span>Analyse en cours...</span>';
            
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <dotlottie-wc src="https://lottie.host/eeab1c36-2031-4942-bf72-95b983b64077/hNKxxXfdmq.lottie" style="width: 150px; height: 150px; margin: 0 auto; display: block;" autoplay loop></dotlottie-wc>
                    <p style="color: #11998e; font-weight: 600; margin-top: 15px;">Tithot analyse tes contenus et les tendances...</p>
                </div>
            `;
            
            try {
                // Préparer les données pour l'IA
                const favorites = getFavorites();
                const profile = UserProfile.get();
                const today = new Date();
                const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                
                // Résumer les favoris
                const favoriteSummary = favorites.slice(0, 15).map((f, i) => 
                    `${i+1}. [${f.platform || '?'}] ${f.pillar || 'Sans pilier'} - "${(f.preview || f.content || '').substring(0, 80)}..."`
                ).join('\n');
                
                const prompt = `Tu es Tithot, experte en stratégie de contenu et planning éditorial.

PROFIL UTILISATEUR :
- Nom : ${profile?.nom || 'Utilisateur'}
- Domaine : ${profile?.domaine || 'Non précisé'}
- Piliers de contenu : ${profile?.piliers?.join(', ') || 'Non définis'}
- Style : ${profile?.style || 'Non précisé'}
- Plateformes : ${currentState.platform || 'LinkedIn'}

CONTENUS SAUVEGARDÉS (${favorites.length} total) :
${favoriteSummary || 'Aucun contenu'}

DATE : ${dayNames[today.getDay()]} ${today.getDate()}/${today.getMonth()+1}/${today.getFullYear()}

DONNÉES TENDANCES 2025 :
- LinkedIn : Mardi-Jeudi 7-9h, 12-13h, 17-18h (meilleur engagement B2B)
- Instagram : Lundi-Jeudi 10-15h et 19-21h
- TikTok : Jeudi-Samedi 19-23h
- Fréquence optimale : LinkedIn 1/jour, Instagram 3-5/semaine, TikTok régulier

Analyse ces contenus et génère un planning sur 2 semaines. Réponds EXACTEMENT dans ce format JSON :

{
  "equilibre": {
    "analyse": "Ton analyse de l'équilibre des piliers (2 phrases max)",
    "piliers": [{"nom": "pilier1", "pourcentage": 40}, {"nom": "pilier2", "pourcentage": 30}],
    "manque": "Ce qui manque ou est trop représenté"
  },
  "planning": [
    {"jour": "Lundi 2/12", "heure": "8h30", "plateforme": "linkedin", "type": "éducatif", "pilier": "expertise", "contenu": "Titre ou résumé du contenu suggéré", "raison": "Pourquoi ce créneau"},
    {"jour": "Mardi 3/12", "heure": "12h00", "plateforme": "instagram", "type": "inspirant", "pilier": "témoignage", "contenu": "...", "raison": "..."}
  ],
  "alertes": [
    {"type": "warning", "message": "Alerte ou recommandation importante"},
    {"type": "success", "message": "Point positif à souligner"}
  ],
  "prochainContenu": {
    "suggestion": "Le prochain contenu à créer en priorité",
    "raison": "Pourquoi celui-là maintenant"
  }
}

Propose 6 à 10 créneaux de publication sur les 2 prochaines semaines, en alternant les piliers et plateformes intelligemment.`;

                // Utiliser Perplexity pour le planning (accès aux tendances actuelles)
                const response = await callPerplexity(prompt);
                
                // Parser la réponse JSON
                const jsonMatch = response.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('Format de réponse invalide');
                
                const planningData = JSON.parse(jsonMatch[0]);
                
                // Afficher les résultats
                displayPlanningResults(planningData);
                
            } catch (error) {
                console.error('Erreur planning:', error);
                resultsDiv.innerHTML = `
                    <div class="planning-alert warning">
                        <span style="font-size: 1.5em;">⚠️</span>
                        <div>
                            <strong>Erreur lors de l'analyse</strong><br>
                            <span style="font-size: 0.9em;">${error.message}. Réessaie dans quelques instants.</span>
                        </div>
                    </div>
                `;
            }
            
            btn.disabled = false;
            btn.innerHTML = '<span>🔄</span><span>Régénérer le planning</span>';
        }
        
        function displayPlanningResults(data) {
            const resultsDiv = document.getElementById('planningResults');
            
            // Icônes par plateforme
            const platformIcons = {
                linkedin: '💼',
                instagram: '📸',
                tiktok: '🎵',
                facebook: '👥',
                x: '𝕏',
                youtube: '🎬'
            };
            
            let html = '<div class="planning-results">';
            
            // Section Alertes
            if (data.alertes && data.alertes.length > 0) {
                html += '<div class="planning-section"><h4>📢 Alertes & Recommandations</h4>';
                data.alertes.forEach(alert => {
                    html += `<div class="planning-alert ${alert.type}">
                        <span style="font-size: 1.3em;">${alert.type === 'warning' ? '⚠️' : alert.type === 'success' ? '✅' : 'ℹ️'}</span>
                        <div>${alert.message}</div>
                    </div>`;
                });
                html += '</div>';
            }
            
            // Section Équilibre des piliers
            if (data.equilibre) {
                html += `<div class="planning-section">
                    <h4>⚖️ Équilibre de tes piliers</h4>
                    <p style="color: #666; margin-bottom: 15px;">${data.equilibre.analyse}</p>`;
                
                if (data.equilibre.piliers && data.equilibre.piliers.length > 0) {
                    data.equilibre.piliers.forEach(p => {
                        html += `<div class="planning-pillar-bar">
                            <div class="planning-pillar-name">${p.nom}</div>
                            <div class="planning-pillar-track">
                                <div class="planning-pillar-fill" style="width: ${p.pourcentage}%"></div>
                            </div>
                            <div class="planning-pillar-count">${p.pourcentage}%</div>
                        </div>`;
                    });
                }
                
                if (data.equilibre.manque) {
                    html += `<div class="planning-alert info" style="margin-top: 15px;">
                        <span>💡</span>
                        <div>${data.equilibre.manque}</div>
                    </div>`;
                }
                html += '</div>';
            }
            
            // Section Planning
            if (data.planning && data.planning.length > 0) {
                html += `<div class="planning-section">
                    <h4>🗓️ Planning suggéré (2 semaines)</h4>`;
                
                data.planning.forEach(item => {
                    const icon = platformIcons[item.plateforme?.toLowerCase()] || '📱';
                    html += `<div class="planning-suggestion">
                        <div class="planning-suggestion-icon ${item.plateforme?.toLowerCase() || ''}">${icon}</div>
                        <div class="planning-suggestion-content">
                            <div class="planning-suggestion-title">${item.contenu}</div>
                            <div class="planning-suggestion-meta">
                                <strong>${item.jour}</strong> à <strong>${item.heure}</strong> • 
                                ${item.plateforme} • ${item.type} • Pilier: ${item.pilier}
                            </div>
                            ${item.raison ? `<div class="planning-suggestion-reason">💡 ${item.raison}</div>` : ''}
                        </div>
                    </div>`;
                });
                html += '</div>';
            }
            
            // Section Prochain contenu prioritaire
            if (data.prochainContenu) {
                html += `<div class="planning-section" style="background: linear-gradient(135deg, rgba(17,153,142,0.1), rgba(56,239,125,0.1)); border-color: #11998e;">
                    <h4>🎯 Prochain contenu prioritaire</h4>
                    <p style="font-size: 1.1em; color: #333; margin-bottom: 10px;"><strong>${data.prochainContenu.suggestion}</strong></p>
                    <p style="color: #666;">${data.prochainContenu.raison}</p>
                    <button onclick="closePlanningModal(); document.getElementById('userIdea').value='${(data.prochainContenu.suggestion || '').replace(/'/g, "\\'")}'; document.getElementById('userIdea').focus();" 
                            style="margin-top: 15px; padding: 12px 25px; background: linear-gradient(135deg, #11998e, #38ef7d); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">
                        ✨ Créer ce contenu maintenant
                    </button>
                </div>`;
            }
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }
        
        // ==================== MA VOIX ====================
        const VOICE_SAMPLES_KEY = 'tithot_voice_samples';
        
        function getVoiceSamples() {
            const saved = localStorage.getItem(VOICE_SAMPLES_KEY);
            return saved ? JSON.parse(saved) : [];
        }
        
        function saveVoiceSamples(samples) {
            localStorage.setItem(VOICE_SAMPLES_KEY, JSON.stringify(samples));
        }
        
        function showVoiceModal() {
            const modal = document.getElementById('voiceModal');
            const content = document.getElementById('voiceContent');
            const profile = UserProfile.get();
            const voiceProfile = profile?.voiceProfile;
            const samples = getVoiceSamples();
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <p style="color: #666; font-size: 1.05em; line-height: 1.6;">
                        L'IA analyse tes textes pour capturer ta <strong>voix unique</strong> : ton, expressions, style...<br>
                        Tous tes contenus seront ensuite générés dans <strong>TON</strong> style !
                    </p>
                    <div style="background: linear-gradient(135deg, #fff9e6, #fff3cd); border-radius: 12px; padding: 15px; margin-top: 15px; border-left: 4px solid #ffc107;">
                        <p style="color: #856404; font-size: 0.9em; margin: 0;">
                            💡 <strong>Conseil :</strong> Utilise des textes <strong>vraiment écrits par toi</strong>, pas générés par IA. 
                            C'est ce qui permettra de capturer ton ton authentique et de rendre tes futurs contenus uniques !
                        </p>
                    </div>
                </div>
                
                ${voiceProfile ? `
                    <div class="voice-analysis">
                        <div class="voice-analysis-title">
                            <span>✅ Profil de voix actif</span>
                            <span class="voice-badge active">🎯 Actif</span>
                        </div>
                        
                        <div class="voice-trait">
                            <div class="voice-trait-icon tone">🎭</div>
                            <div class="voice-trait-content">
                                <div class="voice-trait-label">Ton général</div>
                                <div class="voice-trait-value">${voiceProfile.ton || 'Non analysé'}</div>
                            </div>
                        </div>
                        
                        <div class="voice-trait">
                            <div class="voice-trait-icon length">📏</div>
                            <div class="voice-trait-content">
                                <div class="voice-trait-label">Longueur des phrases</div>
                                <div class="voice-trait-value">${voiceProfile.longueurPhrases || 'Non analysée'}</div>
                            </div>
                        </div>
                        
                        <div class="voice-trait">
                            <div class="voice-trait-icon vocab">📚</div>
                            <div class="voice-trait-content">
                                <div class="voice-trait-label">Vocabulaire & expressions</div>
                                <div class="voice-trait-value">${voiceProfile.expressions || 'Non analysées'}</div>
                            </div>
                        </div>
                        
                        <div class="voice-trait">
                            <div class="voice-trait-icon punctuation">✨</div>
                            <div class="voice-trait-content">
                                <div class="voice-trait-label">Ponctuation & émojis</div>
                                <div class="voice-trait-value">${voiceProfile.ponctuation || 'Non analysée'}</div>
                            </div>
                        </div>
                        
                        <div class="voice-trait">
                            <div class="voice-trait-icon structure">🏗️</div>
                            <div class="voice-trait-content">
                                <div class="voice-trait-label">Style narratif</div>
                                <div class="voice-trait-value">${voiceProfile.styleNarratif || 'Non analysé'}</div>
                            </div>
                        </div>
                        
                        <div class="voice-fidelity">
                            <div class="voice-fidelity-score">${voiceProfile.fidelityScore || '85'}%</div>
                            <div class="voice-fidelity-label">de fidélité estimée<br><small>Les contenus générés ressembleront à ton style</small></div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="voice-btn voice-btn-secondary" onclick="showVoiceEditor()" style="flex: 1;">✏️ Modifier mes textes</button>
                            <button class="voice-btn voice-btn-danger" onclick="deleteVoiceProfile()" style="padding: 10px 15px;">🗑️</button>
                        </div>
                    </div>
                ` : `
                    <div class="voice-section">
                        <h3 style="margin-bottom: 15px; color: #333;">📝 Ajoute des textes que tu as écrits</h3>
                        <p style="color: #888; font-size: 0.9em; margin-bottom: 15px;">
                            Colle 2-5 textes dont tu es fier(e) : posts LinkedIn, articles, emails... Plus tu en mets, plus l'analyse sera précise !
                        </p>
                        
                        <div id="voiceSamplesList" class="voice-samples">
                            ${samples.length > 0 ? samples.map((s, i) => `
                                <div class="voice-sample">
                                    <div class="voice-sample-text">${s.substring(0, 80)}...</div>
                                    <div class="voice-sample-actions">
                                        <button class="voice-sample-btn" onclick="removeVoiceSample(${i})" title="Supprimer">🗑️</button>
                                    </div>
                                </div>
                            `).join('') : '<p style="color: #999; text-align: center; padding: 20px;">Aucun texte ajouté</p>'}
                        </div>
                        
                        <textarea id="voiceNewSample" class="voice-textarea" placeholder="Colle ici un texte que tu as écrit et dont tu es satisfait(e)...

Exemples :
• Un post LinkedIn qui a bien marché
• Un email professionnel
• Un article de blog
• Une bio ou présentation

L'IA va analyser ton style d'écriture unique !"></textarea>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="voice-btn voice-btn-secondary" onclick="addVoiceSample()" style="flex: 1;">➕ Ajouter ce texte</button>
                        </div>
                        
                        ${samples.length >= 2 ? `
                            <button class="voice-btn voice-btn-primary" onclick="analyzeVoice()" style="width: 100%; margin-top: 20px; padding: 15px;">
                                🎤 Analyser ma voix (${samples.length} textes)
                            </button>
                        ` : `
                            <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                                <p style="color: #888; margin: 0;">Ajoute au moins <strong>2 textes</strong> pour lancer l'analyse</p>
                            </div>
                        `}
                    </div>
                `}
            `;
            
            modal.classList.add('show');
        }
        
        function closeVoiceModal() {
            document.getElementById('voiceModal').classList.remove('show');
        }
        
        function showVoiceEditor() {
            const profile = UserProfile.get();
            const samples = getVoiceSamples();
            const content = document.getElementById('voiceContent');
            
            content.innerHTML = `
                <div class="voice-section">
                    <h3 style="margin-bottom: 15px; color: #333;">📝 Mes textes de référence</h3>
                    
                    <div id="voiceSamplesList" class="voice-samples">
                        ${samples.length > 0 ? samples.map((s, i) => `
                            <div class="voice-sample">
                                <div class="voice-sample-text">${s.substring(0, 80)}...</div>
                                <div class="voice-sample-actions">
                                    <button class="voice-sample-btn" onclick="removeVoiceSample(${i})" title="Supprimer">🗑️</button>
                                </div>
                            </div>
                        `).join('') : '<p style="color: #999; text-align: center; padding: 20px;">Aucun texte</p>'}
                    </div>
                    
                    <textarea id="voiceNewSample" class="voice-textarea" placeholder="Colle un nouveau texte ici..."></textarea>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="voice-btn voice-btn-secondary" onclick="addVoiceSample()" style="flex: 1;">➕ Ajouter</button>
                        <button class="voice-btn voice-btn-primary" onclick="analyzeVoice()" style="flex: 1;">🔄 Ré-analyser</button>
                    </div>
                    
                    <button class="voice-btn voice-btn-secondary" onclick="showVoiceModal()" style="width: 100%; margin-top: 15px;">← Retour</button>
                </div>
            `;
        }
        
        function addVoiceSample() {
            const textarea = document.getElementById('voiceNewSample');
            const text = textarea.value.trim();
            
            if (text.length < 50) {
                showToast('❌ Le texte doit faire au moins 50 caractères');
                return;
            }
            
            if (text.length > 5000) {
                showToast('❌ Le texte est trop long (max 5000 caractères)');
                return;
            }
            
            const samples = getVoiceSamples();
            if (samples.length >= 10) {
                showToast('❌ Maximum 10 textes de référence');
                return;
            }
            
            samples.push(text);
            saveVoiceSamples(samples);
            textarea.value = '';
            showToast('✅ Texte ajouté !');
            showVoiceModal(); // Refresh
        }
        
        function removeVoiceSample(index) {
            const samples = getVoiceSamples();
            samples.splice(index, 1);
            saveVoiceSamples(samples);
            showToast('🗑️ Texte supprimé');
            showVoiceModal(); // Refresh
        }
        
        function deleteVoiceProfile() {
            if (!confirm('Supprimer ton profil de voix ? Tu pourras en créer un nouveau.')) return;
            
            const profile = UserProfile.get() || {};
            profile.voiceProfile = null;
            UserProfile.save(profile);
            saveVoiceSamples([]);
            showToast('🗑️ Profil de voix supprimé');
            showVoiceModal(); // Refresh
        }
        
        async function analyzeVoice() {
            const samples = getVoiceSamples();
            if (samples.length < 2) {
                showToast('❌ Ajoute au moins 2 textes');
                return;
            }
            
            const content = document.getElementById('voiceContent');
            content.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <dotlottie-wc src="https://lottie.host/eeab1c36-2031-4942-bf72-95b983b64077/hNKxxXfdmq.lottie" style="width: 150px; height: 150px; margin: 0 auto; display: block;" autoplay loop></dotlottie-wc>
                    <p style="color: #667eea; font-weight: 600; margin-top: 20px;">Tithot analyse ton style d'écriture...</p>
                    <p style="color: #888; font-size: 0.9em; margin-top: 10px;">Cela peut prendre quelques secondes</p>
                </div>
            `;
            
            const samplesText = samples.map((s, i) => `--- TEXTE ${i+1} ---\n${s}`).join('\n\n');
            
            const prompt = `Tu es un expert en analyse stylistique et linguistique.

Analyse ces ${samples.length} textes écrits par la même personne et extrais son "profil de voix" unique.

${samplesText}

Analyse précisément et réponds UNIQUEMENT avec ce JSON valide :

{
  "ton": "Description du ton général en 3-5 mots (ex: 'Chaleureux et direct', 'Professionnel mais accessible', 'Enthousiaste et motivant')",
  "longueurPhrases": "Court/Moyen/Long + description (ex: 'Courtes et percutantes', 'Moyennes avec rythme varié')",
  "expressions": "3-5 expressions ou tournures récurrentes identifiées (ex: 'Utilise beaucoup les questions rhétoriques, commence souvent par Et si...')",
  "ponctuation": "Usage des émojis, points d'exclamation, tirets, etc. (ex: 'Émojis modérés, beaucoup de points d'exclamation')",
  "styleNarratif": "Structure narrative préférée (ex: 'Storytelling personnel, part souvent d'une anecdote')",
  "vocabulaire": "Niveau et type de vocabulaire (ex: 'Accessible, évite le jargon, mots simples et directs')",
  "signature": "Ce qui rend cette voix unique en 1 phrase",
  "fidelityScore": 85,
  "conseils": "Comment reproduire cette voix dans les contenus générés (2-3 conseils clés)"
}`;

            try {
                const response = await callAI(prompt);
                const jsonMatch = response.match(/\{[\s\S]*\}/);
                
                if (!jsonMatch) throw new Error('Format invalide');
                
                const voiceProfile = JSON.parse(jsonMatch[0]);
                
                // Sauvegarder dans le profil utilisateur
                const profile = UserProfile.get() || {};
                profile.voiceProfile = voiceProfile;
                UserProfile.save(profile);
                
                showToast('✅ Profil de voix créé !');
                showVoiceModal(); // Refresh pour afficher le profil
                
            } catch (error) {
                console.error('Erreur analyse voix:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: #ff6b6b; font-size: 1.2em;">❌ Erreur lors de l'analyse</p>
                        <p style="color: #888; margin-top: 10px;">${error.message}</p>
                        <button class="voice-btn voice-btn-primary" onclick="showVoiceModal()" style="margin-top: 20px;">Réessayer</button>
                    </div>
                `;
            }
        }
    </script>

    <!-- ==================== CHATBOT FAQ ==================== -->
    <style>
        /* Chatbot Widget */
        .chatbot-widget {
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 9999;
            font-family: 'Poppins', sans-serif;
        }
        
        .chatbot-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            color: white;
            box-shadow: 0 5px 25px rgba(102,126,234,0.4);
            transition: all 0.3s;
        }
        
        .chatbot-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 35px rgba(102,126,234,0.5);
        }
        
        .chatbot-toggle.open {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }
        
        .chatbot-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 22px;
            height: 22px;
            background: #ff6b6b;
            border-radius: 50%;
            font-size: 0.7em;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
        
        .chatbot-window {
            position: absolute;
            bottom: 75px;
            right: 0;
            width: 380px;
            max-width: calc(100vw - 40px);
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.2);
            overflow: hidden;
            display: none;
            flex-direction: column;
            max-height: 500px;
        }
        
        .chatbot-window.show {
            display: flex;
            animation: chatSlideUp 0.3s ease;
        }
        
        @keyframes chatSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chatbot-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 18px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .chatbot-avatar {
            width: 45px;
            height: 45px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }
        
        .chatbot-info h3 {
            margin: 0;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .chatbot-info p {
            margin: 3px 0 0;
            font-size: 0.85em;
            opacity: 0.9;
        }
        
        .chatbot-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            max-height: 280px;
        }
        
        .chat-message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-message.bot .chat-bubble {
            background: white;
            border-radius: 18px 18px 18px 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .chat-message.user {
            align-items: flex-end;
        }
        
        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 18px 18px 4px 18px;
        }
        
        .chat-bubble {
            padding: 12px 16px;
            max-width: 85%;
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        .chat-bubble a {
            color: #667eea;
            text-decoration: underline;
        }
        
        .chat-message.user .chat-bubble a {
            color: white;
        }
        
        .chat-quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .chat-quick-btn {
            background: white;
            border: 2px solid #e0e5ff;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            color: #333;
        }
        
        .chat-quick-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .chatbot-input {
            padding: 15px;
            background: white;
            border-top: 1px solid #e8e8e8;
            display: flex;
            gap: 10px;
        }
        
        .chatbot-input input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e8e8e8;
            border-radius: 25px;
            font-family: inherit;
            font-size: 0.9em;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .chatbot-input input:focus {
            border-color: #667eea;
        }
        
        .chatbot-input button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .chatbot-input button:hover {
            transform: scale(1.05);
        }
        
        .chatbot-typing {
            display: flex;
            gap: 4px;
            padding: 10px 15px;
        }
        
        .chatbot-typing span {
            width: 8px;
            height: 8px;
            background: #ccc;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }
        
        .chatbot-typing span:nth-child(2) { animation-delay: 0.2s; }
        .chatbot-typing span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        
        /* Rate limit warning */
        .chat-limit-warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px 15px;
            font-size: 0.85em;
            text-align: center;
            border-top: 1px solid #ffc107;
        }
        
        @media (max-width: 480px) {
            .chatbot-window {
                width: calc(100vw - 20px);
                right: -15px;
                bottom: 70px;
            }
        }
    </style>

    <div class="chatbot-widget">
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <div class="chatbot-avatar">🤖</div>
                <div class="chatbot-info">
                    <h3>Assistant SOS</h3>
                    <p>Je réponds à vos questions !</p>
                </div>
            </div>
            <div class="chatbot-messages" id="chatbotMessages">
                <!-- Messages will be inserted here -->
            </div>
            <div class="chatbot-input">
                <input type="text" id="chatbotInput" placeholder="Posez votre question..." maxlength="200">
                <button onclick="Chatbot.sendMessage()">➤</button>
            </div>
        </div>
        <button class="chatbot-toggle" id="chatbotToggle" onclick="Chatbot.toggle()">
            <span id="chatbotIcon">💬</span>
        </button>
    </div>

    <script>
        // ==================== CHATBOT FAQ SYSTEM ====================
        const Chatbot = {
            isOpen: false,
            messageCount: 0,
            maxMessages: 15, // Anti-abus : limite par session
            sessionKey: 'chatbot_session',
            
            // Base de connaissances FAQ
            faq: [
                {
                    keywords: ['essai', 'gratuit', 'trial', '14 jours', 'tester', 'test'],
                    answer: "L'essai gratuit dure <strong>14 jours</strong>, sans carte bancaire ! Vous avez accès à toutes les fonctionnalités : génération illimitée, Ma Voix, Planning IA, exports... À la fin, vous choisissez de souscrire ou non. 🚀"
                },
                {
                    keywords: ['prix', 'tarif', 'coût', 'combien', 'abonnement', 'plan'],
                    answer: "Nos plans : <strong>Solo</strong> à 39€/mois, <strong>Agence Starter</strong> (10 clients) à 99€/mois, <strong>Agence Scale</strong> (30 clients) à 199€/mois, et <strong>Enterprise</strong> sur devis. Tous incluent l'essai gratuit de 14 jours ! 💰"
                },
                {
                    keywords: ['ma voix', 'voix', 'style', 'ton', 'personnaliser'],
                    answer: "\"Ma Voix\" analyse vos textes pour capturer votre style unique ! <strong>Conseil important :</strong> utilisez des textes vraiment écrits par vous (pas générés par IA) pour un résultat authentique. Plus vous ajoutez de textes, plus la fidélité augmente. 🎤"
                },
                {
                    keywords: ['planning', 'calendrier', 'planifier', 'programmer'],
                    answer: "Le <strong>Planning IA</strong> génère automatiquement un calendrier éditorial optimisé ! Il équilibre vos piliers de contenu, suggère les meilleurs créneaux, et vous pouvez exporter directement vers Metricool, Swello ou Buffer. 🗓️"
                },
                {
                    keywords: ['export', 'metricool', 'swello', 'buffer', 'csv'],
                    answer: "Vous pouvez exporter vos contenus en <strong>un clic</strong> vers Metricool, Swello, Buffer ou en CSV générique. Le format est automatiquement adapté à chaque outil. Pratique pour planifier ! 📤"
                },
                {
                    keywords: ['agence', 'client', 'multi', 'plusieurs'],
                    answer: "Le <strong>Mode Agence</strong> permet de gérer plusieurs clients avec des profils de voix distincts ! Import CSV, dashboard analytics, exports bulk... Disponible dès le plan Agence Starter (99€/mois, jusqu'à 10 clients). 🏢"
                },
                {
                    keywords: ['structure', 'aida', 'pas', 'storytelling', 'framework'],
                    answer: "Nous proposons <strong>20+ structures narratives</strong> : AIDA (vendre), PAS (problème/solution), Voyage du Héros (inspirer), Pattern Interrupt (surprendre), et bien plus ! Chaque structure est optimisée pour un objectif spécifique. 📖"
                },
                {
                    keywords: ['plateforme', 'linkedin', 'instagram', 'tiktok', 'facebook'],
                    answer: "SOS Storytelling supporte <strong>7 plateformes</strong> : LinkedIn, Instagram, TikTok, Facebook, Twitter/X, YouTube et newsletters. Chaque contenu est automatiquement optimisé (longueur, ton, hashtags). 📱"
                },
                {
                    keywords: ['données', 'sécurité', 'rgpd', 'confidential', 'supprimer'],
                    answer: "Vos données sont sécurisées sur des serveurs européens avec chiffrement SSL. Elles ne sont <strong>jamais utilisées</strong> pour entraîner des IA externes. Vous pouvez exporter ou supprimer vos données à tout moment (RGPD). 🔒"
                },
                {
                    keywords: ['annuler', 'résilier', 'arrêter', 'désabonner'],
                    answer: "Vous pouvez annuler votre abonnement <strong>à tout moment</strong>, sans conditions ! L'accès reste actif jusqu'à la fin de la période payée. Vos données restent exportables pendant 30 jours. ✅"
                },
                {
                    keywords: ['contact', 'aide', 'support', 'problème', 'bug'],
                    answer: "Pour nous contacter : <a href='mailto:contact@myinnerquest.fr'>contact@myinnerquest.fr</a>. Nous répondons généralement sous 24h ! Pour les clients Agence, vous avez un support prioritaire/dédié. 📧"
                },
                {
                    keywords: ['trends', 'tendance', 'idée', 'inspiration'],
                    answer: "La fonctionnalité <strong>TRENDS</strong> détecte les sujets tendances de votre secteur ! 5 idées de contenu qui buzzent, adaptées à votre profil. Cliquez sur une idée pour la développer instantanément. 🔥"
                },
                {
                    keywords: ['format', 'carousel', 'reel', 'story', 'video'],
                    answer: "Nous supportons tous les formats : <strong>Post classique</strong>, Carousel, Reel/Short, Story, Thread, Script vidéo, Newsletter... L'IA adapte automatiquement la longueur et le ton ! 🎬"
                },
                {
                    keywords: ['api', 'intégration', 'developer', 'technique'],
                    answer: "L'<strong>API REST</strong> est disponible sur le plan Enterprise. Elle permet d'intégrer SOS Storytelling dans vos outils existants : CRM, workflows Zapier/Make, apps tierces... Contactez-nous pour en savoir plus ! 🔧"
                },
                {
                    keywords: ['bonjour', 'salut', 'hello', 'coucou', 'hey'],
                    answer: "Bonjour ! 👋 Je suis l'assistant SOS Storytelling. Je peux répondre à vos questions sur les fonctionnalités, les tarifs, Ma Voix, le Planning IA... Que souhaitez-vous savoir ?"
                }
            ],
            
            // Questions suggérées
            quickReplies: [
                "Comment fonctionne l'essai gratuit ?",
                "Qu'est-ce que Ma Voix ?",
                "Quels sont les tarifs ?",
                "Comment exporter mes contenus ?"
            ],
            
            init() {
                // Charger la session
                const session = localStorage.getItem(this.sessionKey);
                if (session) {
                    const data = JSON.parse(session);
                    // Reset si plus de 1h
                    if (Date.now() - data.timestamp < 3600000) {
                        this.messageCount = data.count || 0;
                    }
                }
                
                // Afficher le message d'accueil
                this.showWelcome();
                
                // Écouter Enter dans l'input
                document.getElementById('chatbotInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            },
            
            toggle() {
                this.isOpen = !this.isOpen;
                const window = document.getElementById('chatbotWindow');
                const icon = document.getElementById('chatbotIcon');
                const toggle = document.getElementById('chatbotToggle');
                
                if (this.isOpen) {
                    window.classList.add('show');
                    icon.textContent = '✕';
                    toggle.classList.add('open');
                } else {
                    window.classList.remove('show');
                    icon.textContent = '💬';
                    toggle.classList.remove('open');
                }
            },
            
            showWelcome() {
                const messages = document.getElementById('chatbotMessages');
                messages.innerHTML = `
                    <div class="chat-message bot">
                        <div class="chat-bubble">
                            Bonjour ! 👋 Je suis l'assistant SOS Storytelling.<br><br>
                            Je peux répondre à vos questions sur les fonctionnalités, les tarifs, Ma Voix, le Planning IA...
                        </div>
                        <div class="chat-quick-replies">
                            ${this.quickReplies.map(q => `
                                <button class="chat-quick-btn" onclick="Chatbot.askQuestion('${q}')">${q}</button>
                            `).join('')}
                        </div>
                    </div>
                `;
            },
            
            askQuestion(question) {
                document.getElementById('chatbotInput').value = question;
                this.sendMessage();
            },
            
            sendMessage() {
                const input = document.getElementById('chatbotInput');
                const message = input.value.trim();
                
                if (!message) return;
                
                // Vérifier limite anti-abus
                if (this.messageCount >= this.maxMessages) {
                    this.showLimitWarning();
                    return;
                }
                
                // Afficher le message utilisateur
                this.addMessage(message, 'user');
                input.value = '';
                
                // Incrémenter et sauvegarder
                this.messageCount++;
                localStorage.setItem(this.sessionKey, JSON.stringify({
                    count: this.messageCount,
                    timestamp: Date.now()
                }));
                
                // Afficher "typing"
                this.showTyping();
                
                // Trouver la réponse
                setTimeout(() => {
                    this.hideTyping();
                    const answer = this.findAnswer(message);
                    this.addMessage(answer, 'bot');
                }, 800 + Math.random() * 500);
            },
            
            findAnswer(question) {
                const q = question.toLowerCase();
                
                // Chercher dans la FAQ
                for (const item of this.faq) {
                    for (const keyword of item.keywords) {
                        if (q.includes(keyword)) {
                            return item.answer;
                        }
                    }
                }
                
                // Réponse par défaut (fallback email)
                return "Je ne suis pas sûr de comprendre votre question. 🤔<br><br>Pour une réponse personnalisée, contactez-nous : <a href='mailto:contact@myinnerquest.fr'>contact@myinnerquest.fr</a><br><br>Ou essayez de reformuler avec des mots comme : tarif, essai gratuit, Ma Voix, planning, export, agence...";
            },
            
            addMessage(content, type) {
                const messages = document.getElementById('chatbotMessages');
                const div = document.createElement('div');
                div.className = `chat-message ${type}`;
                div.innerHTML = `<div class="chat-bubble">${content}</div>`;
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            },
            
            showTyping() {
                const messages = document.getElementById('chatbotMessages');
                const div = document.createElement('div');
                div.className = 'chat-message bot';
                div.id = 'chatTyping';
                div.innerHTML = `
                    <div class="chat-bubble">
                        <div class="chatbot-typing">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                `;
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            },
            
            hideTyping() {
                const typing = document.getElementById('chatTyping');
                if (typing) typing.remove();
            },
            
            showLimitWarning() {
                const messages = document.getElementById('chatbotMessages');
                
                // Vérifier si déjà affiché
                if (document.querySelector('.chat-limit-warning')) return;
                
                const warning = document.createElement('div');
                warning.className = 'chat-limit-warning';
                warning.innerHTML = `
                    ⚠️ Vous avez atteint la limite de messages pour cette session.<br>
                    <a href="mailto:contact@myinnerquest.fr">Contactez-nous</a> pour plus d'aide !
                `;
                messages.parentElement.insertBefore(warning, messages.nextSibling);
            }
        };
        
        // Initialiser le chatbot au chargement
        document.addEventListener('DOMContentLoaded', () => {
            Chatbot.init();
        });
    </script>

    <!-- Module Newsletter -->
    <script src="newsletter-module.js"></script>
    <script>
        // Newsletter Modal Functions
        let newsletterModuleInitialized = false;

        function showNewsletterModal() {
            document.getElementById('newsletterModal').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Initialiser le module Newsletter si pas encore fait
            if (!newsletterModuleInitialized && typeof initNewsletterModule === 'function') {
                initNewsletterModule();
                newsletterModuleInitialized = true;
            }
        }

        function closeNewsletterModal() {
            document.getElementById('newsletterModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Fermer le modal en cliquant sur l'overlay
        document.getElementById('newsletterModal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeNewsletterModal();
            }
        });
    </script>

    <!-- Module Visuels Orshot -->
    <script src="visual-module.js"></script>
    <script>
        // Visual Modal Functions
        let visualModuleInitialized = false;

        function showVisualModal(contentData) {
            document.getElementById('visualModal').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Initialiser le module Visual si pas encore fait
            if (!visualModuleInitialized && typeof window.visualModule !== 'undefined') {
                window.visualModule.init();
                visualModuleInitialized = true;
            }

            // Passer le contenu au module
            if (contentData && window.visualModule) {
                window.visualModule.setContent(contentData);
            }
        }

        function closeVisualModal() {
            document.getElementById('visualModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Fermer le modal en cliquant sur l'overlay
        document.getElementById('visualModal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeVisualModal();
            }
        });

        // Fonction pour ajouter le bouton "Créer le visuel" après la génération de contenu
        function addVisualButton(contentData, containerSelector) {
            const container = document.querySelector(containerSelector);
            if (!container) return;

            // Vérifier si le bouton existe déjà
            if (container.querySelector('.visual-create-btn')) return;

            const button = document.createElement('button');
            button.className = 'visual-create-btn';
            button.style.cssText = 'margin-top: 15px; padding: 12px 24px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;';
            button.innerHTML = '🎨 Créer le visuel';
            button.onclick = () => showVisualModal(contentData);

            container.appendChild(button);
        }
    </script>

</body>
</html>
