<!DOCTYPE html>
<!-- VERSION 2026-01-07-v1 - Ajout Mode Collaboration (Workspaces, Team, Notifications) -->
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>SOS Storytelling - Tithot</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.5/dist/dotlottie-wc.js" type="module"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="organization-loader.js"></script>
    <link rel="stylesheet" href="agent-styles.css?v=20241205d">
    <link rel="stylesheet" href="missions-styles.css?v=20241230">
    <!-- DÉSACTIVÉ - Modules email (conservés pour plus tard)
    <link rel="stylesheet" href="inbox-styles.css?v=20260102b">
    <link rel="stylesheet" href="sender-emails-styles.css?v=20260109">
    -->
    <link rel="stylesheet" href="collaboration-styles.css?v=20260107">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; min-height: 100vh; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #f093fb 100%); }

        .header { background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-logo { font-size: 2em; }
        .header-title { font-size: 1.5em; font-weight: 700; background: linear-gradient(135deg, #f093fb, #f5576c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header-buttons { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

        /* Header Dropdowns */
        .header-dropdown { position: relative; }
        .dropdown-toggle { position: relative; }
        .dropdown-arrow { font-size: 0.7em; margin-left: 5px; transition: transform 0.2s; }
        .dropdown-toggle.active .dropdown-arrow { transform: rotate(180deg); }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 1000;
            margin-top: 8px;
            padding: 8px 0;
            animation: dropdownFade 0.2s ease;
        }
        .dropdown-menu.show { display: block; }
        @keyframes dropdownFade { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95em;
        }
        .dropdown-item:hover { background: linear-gradient(135deg, #f8f9ff, #f0f4ff); color: #667eea; }

        /* Dropdown with sections */
        .dropdown-menu-sections { min-width: 260px; padding: 12px 0; }
        .dropdown-section { padding: 0 8px; }
        .dropdown-section-title {
            font-size: 0.75em;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 12px 6px;
            margin: 0;
        }
        .dropdown-divider { height: 1px; background: #eee; margin: 10px 0; }
        .dropdown-item-muted { color: #999; font-size: 0.9em; }
        .dropdown-item-muted:hover { color: #667eea; }

        /* Email Choice Cards */
        .email-choice-card:hover {
            border-color: #667eea !important;
            background: linear-gradient(135deg, #f8f9ff, #f0f4ff) !important;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        /* Quick Actions Page */
        .quick-actions-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 70vh;
            padding: 40px 20px;
        }
        .quick-actions-title {
            font-size: 2.5em;
            font-weight: 800;
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .quick-actions-subtitle {
            font-size: 1.2em;
            color: #666;
            text-align: center;
            margin-bottom: 50px;
        }
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            max-width: 700px;
            width: 100%;
        }
        @media (max-width: 600px) { .quick-actions-grid { grid-template-columns: 1fr; } }
        .quick-action-card {
            background: white;
            border-radius: 20px;
            padding: 35px 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 2px solid transparent;
        }
        .quick-action-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(102,126,234,0.2);
            border-color: #667eea;
        }
        .quick-action-icon { font-size: 3em; margin-bottom: 15px; }
        .quick-action-title { font-size: 1.3em; font-weight: 700; color: #333; margin-bottom: 8px; }
        .quick-action-time {
            display: inline-block;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .quick-action-card.primary { background: linear-gradient(135deg, #667eea, #764ba2); }
        .quick-action-card.primary .quick-action-title { color: white; }
        .quick-action-card.primary:hover { border-color: white; }

        /* ==================== 3 MODES DESIGN ==================== */
        .modes-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 500px;
            width: 100%;
        }

        /* Section titles pour séparer les modes */
        .section-title {
            font-size: 0.85rem;
            color: #888;
            font-weight: 500;
            margin-bottom: 0.75rem;
            margin-top: 1.5rem;
            padding-left: 0.5rem;
        }
        .section-title:first-of-type {
            margin-top: 0;
        }
        .section-subtitle {
            font-size: 0.75rem;
            color: #aaa;
            font-weight: 400;
            margin-left: 0.5rem;
        }

        .mode-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px 24px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            pointer-events: none;
        }

        /* Hover : carte s'agrandit légèrement */
        .mode-card:hover {
            transform: scale(1.02);
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
        }

        /* État "expanded" pour mobile */
        .mode-card.expanded {
            transform: scale(1.02);
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
        }

        .mode-creer {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mode-prospecter {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .mode-emails {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .mode-audit {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            color: white;
        }

        /* ==================== AUDIT MODAL STYLES ==================== */
        .audit-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            padding: 20px;
        }
        .audit-modal-overlay.active {
            opacity: 1;
        }
        .audit-modal {
            background: white;
            border-radius: 20px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }
        .audit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            flex-shrink: 0;
        }
        .audit-modal-header h2 {
            margin: 0;
            font-size: 1.3em;
            color: #333;
        }
        .audit-close-btn {
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: #999;
            transition: color 0.2s;
        }
        .audit-close-btn:hover {
            color: #333;
        }

        /* Header actions */
        .audit-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .audit-history-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        .audit-history-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* Historique des audits */
        .audit-history-empty {
            padding: 60px 20px;
            text-align: center;
            color: #666;
        }
        .audit-history-empty .empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        .audit-history-empty h3 {
            margin: 0 0 10px;
            color: #333;
        }
        .audit-history-empty p {
            margin: 0 0 25px;
            color: #888;
        }
        .audit-history-view {
            padding: 20px;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .history-header h3 {
            margin: 0;
            color: #333;
        }
        .audit-btn-secondary {
            background: #f1f3f5;
            color: #333;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .audit-btn-secondary:hover {
            background: #e9ecef;
        }
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .history-item:hover {
            background: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .history-item-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .history-type-badge {
            font-size: 0.8em;
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 6px;
            color: #495057;
            font-weight: 500;
        }
        .history-platform {
            font-size: 0.75em;
            color: #888;
        }
        .history-item-center {
            flex: 1;
            padding: 0 20px;
            text-align: center;
        }
        .history-score {
            font-size: 1.4em;
            font-weight: 700;
        }
        .history-summary {
            font-size: 0.8em;
            color: #666;
            margin-top: 3px;
        }
        .history-item-right {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 3px;
        }
        .history-date {
            font-size: 0.8em;
            color: #666;
        }
        .history-time {
            font-size: 0.7em;
            color: #999;
        }
        .history-delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            opacity: 0.4;
            transition: opacity 0.2s;
            padding: 4px;
        }
        .history-delete-btn:hover {
            opacity: 1;
        }

        /* Responsive - Historique des audits */
        @media (max-width: 600px) {
            .audit-header-actions {
                gap: 8px;
            }
            .audit-history-btn {
                padding: 6px 10px;
                font-size: 0.75em;
            }
            .history-item {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
                text-align: center;
            }
            .history-item-left {
                flex-direction: row;
                justify-content: center;
                gap: 10px;
            }
            .history-item-center {
                padding: 0;
            }
            .history-item-right {
                flex-direction: row;
                justify-content: center;
                align-items: center;
                gap: 15px;
            }
            .history-delete-btn {
                opacity: 0.6;
            }
        }

        @media (max-width: 400px) {
            .audit-modal-header h2 {
                font-size: 1.1em;
            }
            .audit-history-btn {
                padding: 5px 8px;
                font-size: 0.7em;
            }
        }

        .audit-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            position: sticky;
            top: 65px;
            z-index: 9;
            flex-shrink: 0;
        }
        .audit-tab {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            font-size: 0.95em;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .audit-tab:hover {
            background: #f0f0f0;
        }
        .audit-tab.active {
            color: #f59e0b;
            border-bottom-color: #f59e0b;
            background: white;
        }
        .audit-content {
            padding: 25px;
            flex: 1;
            overflow-y: auto;
        }
        .audit-section {
            margin-bottom: 25px;
        }
        .audit-section h3 {
            margin: 0 0 15px;
            font-size: 1.05em;
            color: #333;
        }
        .audit-platforms {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .audit-platform-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95em;
        }
        .audit-platform-btn:hover {
            border-color: #f59e0b;
        }
        .audit-platform-btn.active {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fff8eb, #fff5e0);
        }
        .audit-platform-btn .platform-emoji {
            font-size: 1.3em;
        }
        .audit-platform-btn .check {
            margin-left: auto;
            color: #f59e0b;
            font-weight: bold;
        }
        .audit-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 0.95em;
            transition: border-color 0.2s;
        }
        .audit-input:focus {
            outline: none;
            border-color: #f59e0b;
        }
        .audit-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 0.95em;
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        .audit-textarea:focus {
            outline: none;
            border-color: #f59e0b;
        }
        .audit-hint {
            font-size: 0.85em;
            color: #888;
            margin-top: 5px;
        }
        .audit-platform-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #f59e0b;
        }
        .audit-form-group {
            margin-bottom: 15px;
        }
        .audit-form-group:last-child {
            margin-bottom: 0;
        }
        .audit-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #444;
            font-size: 0.9em;
        }
        .audit-run-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #f59e0b, #f97316);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .audit-run-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245,158,11,0.3);
        }
        .audit-results {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .audit-score-global {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa, #f0f4f8);
            border-radius: 16px;
            margin-bottom: 25px;
        }
        .score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 4px solid var(--score-color, #3b82f6);
        }
        .score-circle .score-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--score-color, #333);
        }
        .score-circle .score-max {
            font-size: 0.9em;
            color: #888;
        }
        .audit-platform-result {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .platform-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-weight: 600;
        }
        .platform-score {
            font-size: 1.1em;
            font-weight: 700;
        }
        .audit-issues {
            margin-bottom: 15px;
        }
        .audit-issue {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        .audit-issue.high {
            border-left: 3px solid #ef4444;
        }
        .audit-issue.medium {
            border-left: 3px solid #f59e0b;
        }
        .audit-recommendations ul {
            margin: 10px 0 0;
            padding-left: 20px;
        }
        .audit-recommendations li {
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #555;
        }
        .audit-reset-btn {
            width: 100%;
            padding: 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 0.95em;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.2s;
        }
        .audit-reset-btn:hover {
            border-color: #f59e0b;
            background: #fff8eb;
        }
        .audit-info-box {
            background: linear-gradient(135deg, #fff8eb, #fff5e0);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #f59e0b;
        }
        .audit-info-box h4 {
            margin: 0 0 10px;
            color: #333;
        }
        .audit-info-box p {
            margin: 0 0 10px;
            color: #555;
            font-size: 0.95em;
        }
        .audit-info-box ul {
            margin: 0;
            padding-left: 20px;
        }
        .audit-info-box li {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #666;
        }
        .audit-posts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .audit-add-btn {
            padding: 8px 15px;
            background: linear-gradient(135deg, #f59e0b, #f97316);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
        }
        .audit-post-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .post-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .post-number {
            background: #f59e0b;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: 600;
        }
        .audit-select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9em;
            background: white;
        }
        .audit-remove-btn {
            margin-left: auto;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .audit-remove-btn:hover {
            opacity: 1;
        }
        .char-count {
            font-size: 0.8em;
            color: #888;
            text-align: right;
            display: block;
            margin-top: 5px;
        }
        .audit-scores-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        .score-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .score-item .score-emoji {
            font-size: 1.5em;
            display: block;
            margin-bottom: 5px;
        }
        .score-item .score-label {
            font-size: 0.85em;
            color: #666;
            display: block;
            margin-bottom: 5px;
        }
        .score-item .score-value {
            font-size: 1.2em;
            font-weight: 700;
        }
        .audit-recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .recommendation-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #f59e0b;
        }
        .recommendation-item.high {
            border-left-color: #ef4444;
        }
        .recommendation-item .rec-category {
            font-size: 0.8em;
            font-weight: 600;
            color: #f59e0b;
            text-transform: uppercase;
        }
        .recommendation-item.high .rec-category {
            color: #ef4444;
        }
        .recommendation-item p {
            margin: 5px 0 0;
            font-size: 0.95em;
            color: #444;
        }
        .post-detail {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .post-detail-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .post-detail-header .post-score {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
        }
        .post-detail-content p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #555;
        }
        /* Grille 7 critères */
        .audit-scores-7 {
            grid-template-columns: repeat(4, 1fr);
        }
        .audit-scores-7 .score-item {
            padding: 12px 8px;
        }
        .audit-scores-7 .score-item .score-label {
            font-size: 0.75em;
        }
        .audit-scores-7 .score-item .score-value {
            font-size: 1em;
        }
        /* Mini scores dans détail post */
        .post-detail-scores {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        .mini-score {
            font-size: 0.85em;
            font-weight: 600;
            padding: 3px 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        /* Upload image */
        .post-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        .image-upload-zone {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .image-upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            background: #f0f0f0;
            border: 2px dashed #ccc;
            border-radius: 8px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .image-upload-btn:hover {
            border-color: #f59e0b;
            background: #fff8eb;
        }
        .image-remove-btn {
            background: #fee2e2;
            color: #ef4444;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .image-remove-btn:hover {
            background: #fecaca;
        }
        .image-preview {
            margin-top: 10px;
            position: relative;
        }
        .image-preview img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }
        .image-analysis-note {
            margin-top: 8px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #f0f4ff, #e8ecff);
            border-radius: 8px;
            font-size: 0.85em;
            color: #667eea;
            text-align: center;
        }
        /* Screenshot upload zones */
        .screenshot-upload-zone {
            border: 3px dashed #d0d0d0;
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
            position: relative;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .screenshot-upload-zone:hover {
            border-color: #f59e0b;
            background: #fffbeb;
        }
        .screenshot-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            color: #888;
        }
        .screenshot-icon {
            font-size: 3em;
            opacity: 0.6;
        }
        .screenshot-hint {
            font-size: 0.85em;
            color: #aaa;
        }
        .screenshot-preview {
            max-width: 100%;
            max-height: 250px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .screenshot-remove {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .screenshot-remove:hover {
            transform: scale(1.1);
        }
        .screenshots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        .screenshot-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
        }
        .screenshot-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        .screenshot-item .screenshot-remove {
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            font-size: 0.9em;
        }
        .screenshot-upload-small {
            border: 2px dashed #d0d0d0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            cursor: pointer;
            color: #888;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .screenshot-upload-small:hover {
            border-color: #f59e0b;
            background: #fffbeb;
            color: #f59e0b;
        }
        .optional-tag {
            font-size: 0.75em;
            font-weight: 400;
            color: #999;
            margin-left: 8px;
        }
        /* Visual audit results */
        .audit-visual-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .audit-visual-section h4 {
            margin: 0 0 10px;
            font-size: 1em;
            color: #333;
        }
        .visual-score {
            margin-bottom: 10px;
        }
        .score-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }
        .visual-suggestions {
            margin: 10px 0 0;
            padding-left: 20px;
        }
        .visual-suggestions li {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #555;
        }
        .impression-section {
            background: linear-gradient(135deg, #f0f4ff, #e8ecff);
            border-left: 4px solid #667eea;
        }
        .impression-text {
            font-size: 1em;
            line-height: 1.6;
            color: #444;
            margin: 0;
        }

        /* Color palette display */
        .color-palette-display {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .detected-colors {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .color-chip {
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            font-size: 0.85em;
        }
        .palette-harmony {
            font-size: 0.9em;
            margin: 8px 0;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }
        .palette-harmony.good { background: #d4edda; color: #155724; }
        .palette-harmony.bad { background: #f8d7da; color: #721c24; }
        .palette-harmony.neutral { background: #fff3cd; color: #856404; }
        .palette-suggestion {
            font-size: 0.9em;
            color: #666;
            margin: 8px 0 0;
            font-style: italic;
        }

        /* Quick wins section */
        .quick-wins-section {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-left: 4px solid #28a745;
        }
        .quick-wins-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .quick-win-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        .qw-icon {
            color: #28a745;
            font-weight: bold;
            font-size: 1.1em;
        }
        .quick-win-item p {
            margin: 0;
            font-size: 0.95em;
            color: #333;
        }

        /* Video audit styles */
        .video-upload-zone {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(102, 126, 234, 0.05);
        }
        .video-upload-zone:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #5a67d8;
        }
        .video-upload-zone.has-video {
            border-style: solid;
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
        }
        .video-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .video-info {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }
        .viral-potential {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: 600;
            margin-top: 10px;
        }
        .viral-potential.high { background: #d4edda; color: #155724; }
        .viral-potential.medium { background: #fff3cd; color: #856404; }
        .viral-potential.low { background: #f8d7da; color: #721c24; }

        .rec-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: #f59e0b;
            color: white;
            border-radius: 50%;
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .audit-fallback {
            text-align: center;
            padding: 20px;
        }
        .audit-fallback h4 {
            color: #f59e0b;
            margin-bottom: 15px;
        }
        .audit-fallback ul {
            text-align: left;
            max-width: 400px;
            margin: 20px auto;
        }
        .audit-fallback li {
            margin-bottom: 10px;
            font-size: 0.95em;
            color: #555;
        }
        .audit-run-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        @media (max-width: 500px) {
            .audit-platforms {
                grid-template-columns: 1fr;
            }
            .audit-scores-grid {
                grid-template-columns: 1fr;
            }
            .audit-scores-7 {
                grid-template-columns: repeat(2, 1fr);
            }
            .post-item-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .screenshots-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .screenshot-upload-zone {
                padding: 20px;
                min-height: 120px;
            }
            /* Audit Modal - Mobile */
            .audit-modal {
                border-radius: 15px;
                max-height: 95vh;
            }
            .audit-modal-overlay {
                padding: 10px;
            }
            .audit-modal-header {
                padding: 15px;
            }
            .audit-modal-header h2 {
                font-size: 1em;
            }
            .audit-tabs {
                top: 50px;
            }
            .audit-tab {
                padding: 10px 8px;
                font-size: 0.8em;
            }
            .audit-content {
                padding: 15px;
            }
            .audit-score-global {
                padding: 20px 15px;
            }
            .score-circle {
                width: 80px;
                height: 80px;
            }
            .score-value {
                font-size: 1.8em;
            }
        }

        /* Emails Choice Modal */
        .emails-choice-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }
        .emails-choice-modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.3s ease;
        }
        .emails-choice-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        .emails-choice-option:hover {
            border-color: #11998e;
            background: linear-gradient(135deg, #f0fff4, #e6fffa);
            transform: translateY(-2px);
        }
        .emails-choice-icon {
            font-size: 1.8em;
        }
        .emails-choice-title {
            font-weight: 700;
            font-size: 1em;
            color: #333;
            margin-bottom: 3px;
        }
        .emails-choice-desc {
            font-size: 0.85em;
            color: #666;
        }
        .emails-choice-close {
            margin-top: 15px;
            padding: 10px 25px;
            background: #e0e0e0;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background 0.2s;
        }
        .emails-choice-close:hover {
            background: #d0d0d0;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Missions Modal Buttons */
        .btn-launch-mission {
            padding: 15px 30px;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white !important;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }
        .btn-launch-mission:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(240, 147, 251, 0.4);
        }

        /* Agent Embed in Missions Modal */
        .agent-embed {
            padding: 20px;
            text-align: center;
        }
        .agent-embed-desc {
            color: #666;
            margin-bottom: 20px;
        }
        .btn-agent-open {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-agent-open:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }
        .agent-quick-stats {
            margin-top: 25px;
        }
        .quick-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        .quick-stat {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        .quick-stat-icon {
            display: block;
            font-size: 1.5em;
            margin-bottom: 5px;
        }
        .quick-stat-value {
            display: block;
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
        }
        .quick-stat-label {
            display: block;
            font-size: 0.8em;
            color: #888;
            margin-top: 3px;
        }
        @media (max-width: 500px) {
            .quick-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .mode-autopilot {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
        }

        .mode-emoji {
            font-size: 2em;
            flex-shrink: 0;
        }

        .mode-main {
            flex: 1;
        }

        .mode-title {
            font-size: 1.3em;
            font-weight: 800;
            letter-spacing: 0.5px;
        }

        /* Détails cachés par défaut */
        .mode-details {
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* Détails visibles au hover */
        .mode-card:hover .mode-details,
        .mode-card.expanded .mode-details {
            opacity: 1;
            max-height: 60px;
            margin-top: 6px;
        }

        .mode-subtitle {
            font-size: 0.85em;
            opacity: 0.95;
        }

        .mode-description {
            font-size: 0.75em;
            opacity: 0.75;
            margin-top: 2px;
        }

        .mode-arrow {
            position: absolute;
            right: 20px;
            opacity: 0.6;
            transition: all 0.3s;
        }

        .mode-card:hover .mode-arrow,
        .mode-card.expanded .mode-arrow {
            opacity: 1;
            transform: translateX(4px);
        }

        /* Audit link */
        .audit-link-container {
            margin-top: 40px;
            text-align: center;
        }

        .audit-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #64748b;
            text-decoration: none;
            font-size: 0.95em;
            padding: 12px 20px;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .audit-link:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .audit-link span {
            color: #667eea;
            font-weight: 600;
        }

        /* Sous-menus */
        .mode-submenu {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 2000;
            padding: 20px;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .submenu-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }

        .submenu-header h2 {
            font-size: 1.5em;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }

        .submenu-back {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #f1f5f9;
            border: none;
            border-radius: 10px;
            color: #64748b;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submenu-back:hover {
            background: #e2e8f0;
            color: #334155;
        }

        .submenu-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .submenu-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px 24px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submenu-option:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f5ff 0%, #fff 100%);
            transform: translateX(8px);
        }

        .submenu-option-icon {
            font-size: 2em;
            flex-shrink: 0;
        }

        .submenu-option-content {
            flex: 1;
        }

        .submenu-option-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #1e293b;
        }

        .submenu-option-desc {
            font-size: 0.85em;
            color: #64748b;
            margin-top: 2px;
        }

        .submenu-option-time {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .submenu-option-arrow {
            font-size: 1.2em;
            color: #667eea;
            font-weight: 600;
        }

        @media (max-width: 600px) {
            .modes-grid {
                gap: 16px;
            }
            .mode-card {
                padding: 20px;
            }
            .mode-emoji {
                font-size: 2em;
            }
            .mode-title {
                font-size: 1.2em;
            }
            .mode-subtitle, .mode-description {
                font-size: 0.85em;
            }
            .submenu-option {
                padding: 16px 20px;
            }
        }

        /* ==================== FIN 3 MODES ==================== */

        /* Menu hamburger mobile */
        .mobile-menu-toggle { display: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 10px 15px; border-radius: 10px; font-size: 1.2em; cursor: pointer; }
        .mobile-menu-toggle:hover { transform: scale(1.05); }

        @media (max-width: 768px) {
            .header { position: relative; padding: 12px 15px; }
            .header-title { font-size: 1.2em; }
            .mobile-menu-toggle { display: flex; align-items: center; gap: 8px; font-size: 0.95em; font-weight: 600; }
            .header-buttons {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                padding: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.15);
                flex-direction: column;
                gap: 8px;
                z-index: 1000;
                border-top: 2px solid #f0f0f0;
            }
            .header-buttons.open { display: flex; }
            .header-buttons .btn { width: 100%; justify-content: center; padding: 12px 15px; font-size: 0.9em; }
            /* Boutons blancs en mobile - TOUS */
            .header-buttons .btn,
            .header-buttons .btn-primary,
            .header-buttons .btn-stats,
            .header-buttons .btn-prospects,
            .header-buttons .btn-secondary,
            .header-buttons .btn-autopilot,
            .header-buttons .dropdown-toggle { background: white !important; color: #333 !important; border: 1px solid #ddd !important; box-shadow: 0 2px 5px rgba(0,0,0,0.08); }
            /* Mobile dropdowns */
            .header-dropdown { width: 100%; }
            .header-dropdown .dropdown-toggle { width: 100%; justify-content: center; }
            .header-dropdown .dropdown-menu { position: static; width: 100%; margin-top: 5px; box-shadow: none; background: #f8f9ff; }
            .quick-actions-title { font-size: 1.8em; }
            .quick-actions-subtitle { font-size: 1em; margin-bottom: 30px; }
            .quick-action-card { padding: 25px 20px; }
            .quick-action-icon { font-size: 2.5em; }
        }

        .btn { padding: 10px 20px; border: none; border-radius: 10px; font-family: inherit; font-size: 0.95em; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
        .btn-home { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }
        .btn-profile { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        /* Agency Toggle Section */
        .agency-toggle-section { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #f8f9ff, #f0f4ff); border-radius: 12px; border: 2px solid #e8ecff; }
        .agency-toggle-info { display: flex; flex-direction: column; gap: 2px; }
        .agency-toggle-label { font-weight: 700; color: #1e3c72; font-size: 0.95em; }
        .agency-toggle-desc { font-size: 0.8em; color: #666; }
        .btn-agency-unlock-small { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 16px; border: none; border-radius: 8px; font-family: inherit; font-weight: 600; cursor: pointer; font-size: 0.85em; transition: all 0.3s; }
        .btn-agency-unlock-small:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(102,126,234,0.3); }
        .btn-agency-active-small { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; padding: 8px 16px; border: none; border-radius: 8px; font-family: inherit; font-weight: 600; cursor: pointer; font-size: 0.85em; }
        .btn-icon { background: #f0f4ff; border: 2px solid #e0e5ff; color: #667eea; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 1em; transition: all 0.2s; }
        .btn-icon:hover { background: #667eea; color: white; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-agency { background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; }

        /* Agency Dashboard */
        .client-section { margin-bottom: 15px; }
        .client-selector { width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; font-family: inherit; font-size: 0.95em; background: rgba(255,255,255,0.15); color: white; cursor: pointer; }
        .client-selector:focus { outline: none; border-color: rgba(255,255,255,0.6); }
        .client-selector option { background: #1e3c72; color: white; }
        .agency-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .agency-total { background: linear-gradient(135deg, #1e3c72, #2a5298); padding: 20px 30px; border-radius: 15px; color: white; }
        .agency-total-number { font-size: 2.5em; font-weight: 800; display: block; }
        .agency-total-label { font-size: 0.95em; opacity: 0.9; }
        .btn-export { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; padding: 12px 20px; border: none; border-radius: 10px; font-family: inherit; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .btn-export:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(17,153,142,0.3); }
        
        /* Chart bars */
        .chart-container { display: flex; align-items: flex-end; justify-content: space-between; height: 150px; background: #f8f9fa; border-radius: 12px; padding: 15px; gap: 10px; }
        .chart-bar-container { flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%; }
        .chart-bar { width: 100%; background: linear-gradient(180deg, #667eea, #764ba2); border-radius: 6px 6px 0 0; display: flex; align-items: flex-start; justify-content: center; padding-top: 5px; min-height: 20px; transition: height 0.5s; }
        .chart-bar span { color: white; font-size: 0.75em; font-weight: 700; }
        .chart-label { margin-top: 8px; font-size: 0.75em; color: #666; text-transform: uppercase; }
        
        /* Client tags */
        .client-tag { display: inline-flex; align-items: center; gap: 5px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 500; }
        
        /* Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        .toggle-switch input:checked + .toggle-slider { background: linear-gradient(135deg, #1e3c72, #2a5298); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(26px); }
        
        /* Agency Unlock Buttons */
        .btn-agency-unlock { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 20px; border: none; border-radius: 8px; font-family: inherit; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-agency-unlock:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(102,126,234,0.3); }
        .btn-agency-active { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; padding: 10px 20px; border: none; border-radius: 8px; font-family: inherit; font-weight: 600; cursor: pointer; }
        .btn-agency-active:hover { opacity: 0.9; }
        
        /* Agency Code Modal */
        .agency-code-input { width: 100%; padding: 15px; font-size: 1.3em; text-align: center; border: 3px solid #e0e0e0; border-radius: 12px; font-family: inherit; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; transition: all 0.3s; }
        .agency-code-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102,126,234,0.15); }
        .agency-code-input.shake { animation: shake 0.5s; border-color: #ff6b6b; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-10px); } 40%, 80% { transform: translateX(10px); } }
        .agency-code-error { color: #ff6b6b; font-size: 0.9em; margin-top: 10px; }
        .btn-validate-code { width: 100%; margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; border: none; border-radius: 10px; font-family: inherit; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .btn-validate-code:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(30,60,114,0.3); }

        /* Client Profile Form */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 0.9em; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: inherit; font-size: 0.95em; transition: all 0.3s; box-sizing: border-box; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102,126,234,0.15); }
        .field-hint { display: block; margin-top: 6px; font-size: 0.82em; color: #888; line-height: 1.4; }

        /* Import Dropzone */
        .import-dropzone { position: relative; border: 3px dashed #d0d0d0; border-radius: 15px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 20px; }
        .import-dropzone:hover { border-color: #667eea; background: #f8f9ff; }
        .import-dropzone input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .import-dropzone-content p { margin: 10px 0 5px; color: #555; font-weight: 500; }
        
        /* Import Preview */
        .import-loading { text-align: center; padding: 30px; color: #667eea; font-weight: 600; }
        .import-error { background: #fff0f0; color: #e74c3c; padding: 15px; border-radius: 10px; text-align: center; }
        .import-success { background: linear-gradient(135deg, #f0fff4, #e8f5e9); color: #27ae60; padding: 15px 20px; border-radius: 12px; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center; gap: 15px; border: 2px solid #c8e6c9; }
        .import-clients-list { max-height: 300px; overflow-y: auto; }
        .import-client-card { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .import-client-card-detailed { background: #f8f9fa; padding: 18px; border-radius: 12px; margin-bottom: 12px; border: 2px solid #e8e8e8; }
        .import-client-card-detailed:hover { border-color: #667eea; }
        .import-client-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .import-client-header strong { font-size: 1.1em; color: #333; }
        .import-client-name { display: flex; flex-direction: column; gap: 4px; }
        .import-client-domain { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 3px 10px; border-radius: 20px; font-size: 0.75em; display: inline-block; margin-top: 4px; }
        .import-client-index { background: #e8e8e8; color: #666; padding: 4px 10px; border-radius: 20px; font-size: 0.8em; font-weight: 600; }
        .import-client-message { color: #555; font-style: italic; font-size: 0.9em; margin-bottom: 12px; padding: 10px; background: white; border-radius: 8px; border-left: 3px solid #667eea; }
        .import-client-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px; }
        .import-field { display: flex; flex-direction: column; gap: 2px; }
        .import-label { font-size: 0.75em; color: #888; text-transform: uppercase; font-weight: 600; }
        .import-value { font-size: 0.85em; color: #333; }
        .import-client-badges { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .import-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: 600; }
        .import-badge.platform { background: #e3f2fd; color: #1976d2; }
        .import-badge.format { background: #fce4ec; color: #c2185b; }
        .import-badge.empty { background: #f5f5f5; color: #999; font-style: italic; }
        .import-client-notes { font-size: 0.85em; color: #666; padding: 8px 12px; background: #fff3e0; border-radius: 8px; }
        .import-client-details { display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.85em; color: #666; }
        .import-client-details span { background: #e8e8e8; padding: 3px 8px; border-radius: 5px; }
        .import-rgpd-section { margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9ff, #f0f4ff); border-radius: 12px; border: 2px solid #e8ecff; }
        .rgpd-notice { display: flex; gap: 15px; align-items: flex-start; margin-bottom: 15px; }
        .rgpd-icon { font-size: 2em; }
        .rgpd-text strong { color: #1e3c72; display: block; margin-bottom: 5px; }
        .rgpd-text p { margin: 0; font-size: 0.9em; color: #555; line-height: 1.5; }
        .rgpd-checkbox { display: flex; gap: 12px; align-items: flex-start; cursor: pointer; padding: 12px; background: white; border-radius: 10px; border: 2px solid #e0e0e0; transition: all 0.2s; }
        .rgpd-checkbox:hover { border-color: #667eea; }
        .rgpd-checkbox input { margin-top: 3px; transform: scale(1.2); accent-color: #667eea; }
        .rgpd-checkbox span { font-size: 0.9em; color: #333; line-height: 1.5; }
        .rgpd-already-consented { background: #e8f5e9; color: #2e7d32; padding: 12px; border-radius: 10px; font-weight: 600; text-align: center; }
        .btn-import-confirm { width: 100%; margin-top: 20px; margin-bottom: 10px; padding: 18px; background: linear-gradient(135deg, #11998e, #38ef7d); color: white; border: none; border-radius: 12px; font-family: inherit; font-size: 1.15em; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(17,153,142,0.3); }
        .btn-import-confirm:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(17,153,142,0.3); }
        .btn-import-confirm:disabled { opacity: 0.5; cursor: not-allowed; background: #ccc; }
        
        /* Cartes clients enrichies - Grille 2-3 colonnes */
        .clients-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; max-height: 600px; overflow-y: auto; padding-right: 5px; }
        @media (max-width: 1200px) { .clients-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 700px) { .clients-grid { grid-template-columns: 1fr; } }
        .client-card { background: white; padding: 18px; border-radius: 14px; border: 2px solid #e8e8e8; transition: all 0.2s; cursor: pointer; }
        .client-card:hover { border-color: #667eea; box-shadow: 0 4px 15px rgba(102,126,234,0.15); }
        .client-card-expanded { background: white; padding: 16px; border-radius: 14px; border: 2px solid #e8e8e8; transition: all 0.2s; cursor: pointer; display: flex; flex-direction: column; }
        .client-card-expanded:hover { border-color: #11998e; box-shadow: 0 8px 30px rgba(17,153,142,0.2); transform: translateY(-2px); }
        .client-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; gap: 8px; }
        .client-card-info { flex: 1; min-width: 0; }
        .client-card-title { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 4px; }
        .client-card-title strong { font-size: 1.1em; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
        .client-stats-badge { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 2px 8px; border-radius: 20px; font-size: 0.7em; font-weight: 600; white-space: nowrap; }
        .client-badge.voice { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; padding: 2px 8px; border-radius: 20px; font-size: 0.7em; font-weight: 600; }
        .client-card-info .client-domain { font-size: 0.85em; color: #667eea; font-weight: 500; display: block; }
        .client-message-box { background: linear-gradient(135deg, #f8f9ff, #f0f4ff); padding: 10px 12px; border-radius: 8px; margin-bottom: 12px; font-style: italic; color: #555; font-size: 0.85em; border-left: 3px solid #667eea; line-height: 1.4; }
        .client-info-grid { display: none; }
        .info-label { display: block; font-size: 0.7em; color: #888; text-transform: uppercase; font-weight: 600; margin-bottom: 2px; }
        .info-value { font-size: 0.85em; color: #333; }
        .client-card-actions { display: flex; gap: 6px; align-items: center; flex-shrink: 0; }
        .client-card-actions button { background: #f5f5f5; border: none; font-size: 0.9em; cursor: pointer; padding: 6px 8px; border-radius: 8px; transition: all 0.2s; }
        .client-card-actions button:hover { background: #e0e0e0; }
        .btn-select-client { background: linear-gradient(135deg, #11998e, #38ef7d) !important; color: white !important; font-size: 0.75em !important; font-weight: 600; padding: 6px 10px !important; }
        .btn-select-client:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(17,153,142,0.3); }
        .client-card-details { display: flex; flex-direction: column; gap: 6px; padding-top: 10px; border-top: 1px dashed #e0e0e0; margin-top: auto; }
        .tags-section { display: flex; flex-wrap: wrap; align-items: center; gap: 4px; }
        .tags-label { font-size: 0.75em; color: #888; font-weight: 600; min-width: 80px; }
        .no-data { font-size: 0.75em; color: #bbb; font-style: italic; }
        .client-tag { display: inline-flex; align-items: center; gap: 3px; padding: 3px 8px; border-radius: 20px; font-size: 0.7em; font-weight: 500; }
        .client-tag.platform { background: #e3f2fd; color: #1565c0; }
        .client-tag.style { background: #fff3e0; color: #e65100; }
        .client-tag.pilier { background: #fce4ec; color: #c2185b; }
        .client-tag.objectif { background: #e8f5e9; color: #2e7d32; }
        .client-tag.audience { background: #f3e5f5; color: #7b1fa2; }

        /* Cartes clients compactes en grille */
        .client-platforms-row { display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; }
        .platform-icon { font-size: 1.4em; opacity: 0.85; cursor: default; }
        .client-card-footer { display: flex; gap: 8px; margin-top: auto; padding-top: 12px; border-top: 1px solid #eee; }
        .btn-edit-client { flex: 1; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 8px 12px; border-radius: 8px; font-family: inherit; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-edit-client:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102,126,234,0.3); }
        .btn-delete-client { background: #fee; color: #e53935; border: 1px solid #ffcdd2; padding: 8px 10px; border-radius: 8px; font-size: 0.9em; cursor: pointer; transition: all 0.2s; }
        .btn-delete-client:hover { background: #ffcdd2; }

        /* Section RGPD Dashboard */
        .rgpd-dashboard-section { margin-top: 25px; padding: 25px; background: linear-gradient(135deg, #fff8f8, #fff0f0); border-radius: 16px; border: 2px solid #ffcdd2; }
        .rgpd-info-box { background: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; }
        .rgpd-info-box p { margin: 0 0 10px; font-size: 0.95em; color: #555; line-height: 1.6; }
        .rgpd-info-box p:last-child { margin-bottom: 0; }
        .rgpd-consent-info { color: #2e7d32 !important; background: #e8f5e9; padding: 10px 15px; border-radius: 8px; margin-top: 10px !important; }
        .rgpd-buttons { display: flex; flex-wrap: wrap; gap: 12px; }
        .btn-rgpd { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 15px 20px; border-radius: 12px; border: none; cursor: pointer; font-family: inherit; font-weight: 600; transition: all 0.2s; min-width: 160px; }
        .btn-rgpd small { font-size: 0.75em; font-weight: 400; opacity: 0.8; }
        .btn-rgpd.export { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-rgpd.export:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.3); }
        .btn-rgpd.delete { background: white; color: #e74c3c; border: 2px solid #e74c3c; }
        .btn-rgpd.delete:hover { background: #fff5f5; }
        .btn-rgpd.revoke { background: white; color: #ff6b6b; border: 2px solid #ff6b6b; }
        .btn-rgpd.revoke:hover { background: #fff5f5; }

        /* Dashboard Agence - Sections */
        .agency-import-section { background: linear-gradient(135deg, #f8f9ff, #e8f5e9); padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 2px solid #c8e6c9; }
        .agency-import-buttons { display: flex; flex-wrap: wrap; gap: 12px; }
        .btn-agency-action { display: flex; align-items: center; gap: 10px; padding: 14px 20px; border-radius: 12px; border: none; cursor: pointer; font-family: inherit; font-weight: 600; font-size: 0.95em; transition: all 0.2s; }
        .btn-agency-action .btn-icon { font-size: 1.2em; }
        .btn-agency-action.primary { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }
        .btn-agency-action.primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(17,153,142,0.3); }
        .btn-agency-action.secondary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-agency-action.secondary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.3); }
        .btn-agency-action.tertiary { background: white; color: #333; border: 2px solid #e0e0e0; }
        .btn-agency-action.tertiary:hover { border-color: #667eea; background: #f8f9ff; }
        .agency-clients-section { margin-bottom: 25px; }
        .agency-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        .btn-export-small { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-family: inherit; font-weight: 600; font-size: 0.85em; cursor: pointer; }
        .agency-stats-section { background: #f8f9fa; padding: 20px; border-radius: 16px; margin-bottom: 25px; }
        .agency-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }

        /* Dashboard Agence - Responsive Mobile */
        @media (max-width: 768px) {
            #agencyDashboardModal .modal {
                max-width: 100%;
                width: 100%;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
                padding: 15px;
                margin: 0;
            }
            #agencyDashboardModal .modal-header {
                position: sticky;
                top: 0;
                background: white;
                z-index: 10;
                padding-bottom: 15px;
                border-bottom: 1px solid #eee;
                margin: -15px -15px 15px;
                padding: 15px;
            }
            #agencyDashboardContent {
                overflow-y: auto;
                max-height: calc(100vh - 80px);
                padding-bottom: 30px;
            }
            .agency-import-section {
                padding: 15px;
            }
            .agency-import-buttons {
                flex-direction: column;
            }
            .btn-agency-action {
                width: 100%;
                justify-content: center;
                padding: 16px;
            }
            .agency-stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .client-card {
                padding: 15px;
            }
            .client-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .client-card-actions {
                width: 100%;
                justify-content: space-between;
            }
        }

        @media (max-width: 480px) {
            #agencyDashboardModal .modal {
                padding: 10px;
            }
            .agency-import-section h3 {
                font-size: 1em;
            }
            .agency-import-section p {
                font-size: 0.85em;
            }
            .btn-agency-action {
                padding: 14px 12px;
                font-size: 0.9em;
            }
            .btn-agency-action .btn-icon {
                font-size: 1.1em;
            }
        }

        /* Boutons header - tous blancs avec texte noir */
        .header-buttons .btn { background: white !important; color: #333 !important; border: 1px solid #ddd !important; }
        .header-buttons .btn:hover { background: #f8f8f8 !important; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .header-buttons .btn-primary,
        .header-buttons .btn-stats,
        .header-buttons .btn-prospects,
        .header-buttons .btn-secondary,
        .header-buttons .btn-autopilot { background: white !important; color: #333 !important; border: 1px solid #ddd !important; }
        .btn-autopilot .pulse-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.2); } }

        /* Settings Hint Popup */
        .settings-hint-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            display: none;
        }
        .settings-hint-overlay.show { display: block; }

        /* Audit Hint Popup */
        .audit-hint-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 998;
            display: none;
        }
        .audit-hint-overlay.show { display: block; }
        .audit-hint {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            padding: 20px 25px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(240, 147, 251, 0.4);
            z-index: 999;
            display: none;
            max-width: 360px;
            text-align: center;
            animation: auditHintFadeIn 0.5s ease;
        }
        .audit-hint.show { display: block; }
        .audit-hint-close {
            position: absolute;
            top: 8px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            opacity: 0.8;
        }
        .audit-hint-close:hover { opacity: 1; }
        .audit-hint-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .audit-hint-text {
            font-size: 0.9em;
            line-height: 1.5;
            opacity: 0.95;
            margin-bottom: 15px;
        }
        .audit-hint-btn {
            display: inline-block;
            padding: 10px 20px;
            background: white;
            color: #f5576c;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
        }
        .audit-hint-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .audit-hint-dismiss {
            display: block;
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 0.8em;
            cursor: pointer;
            margin-top: 5px;
        }
        .audit-hint-dismiss:hover { color: white; }
        @keyframes auditHintFadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        @media (max-width: 768px) {
            .audit-hint { bottom: 80px; max-width: calc(100% - 40px); left: 20px; right: 20px; transform: none; }
        }
        .settings-hint {
            position: fixed;
            top: 70px;
            right: 200px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
            z-index: 1000;
            display: none;
            max-width: 280px;
            animation: hintFadeIn 0.5s ease;
        }
        .settings-hint.show { display: block; }
        .settings-hint-content { display: flex; align-items: flex-start; gap: 12px; }
        .settings-hint-text { font-size: 0.95em; line-height: 1.5; }
        .settings-hint-text strong { display: block; margin-bottom: 5px; font-size: 1.05em; }
        .settings-hint-close {
            position: absolute;
            top: 8px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            opacity: 0.8;
        }
        .settings-hint-close:hover { opacity: 1; }
        .settings-hint-dismiss {
            display: block;
            width: 100%;
            margin-top: 12px;
            padding: 8px;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 6px;
            color: rgba(255,255,255,0.8);
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .settings-hint-dismiss:hover { background: rgba(255,255,255,0.25); color: white; }
        .settings-hint-arrow {
            position: absolute;
            top: -30px;
            right: 30px;
            font-size: 2em;
            animation: bounceArrow 1s ease-in-out infinite;
        }
        @keyframes bounceArrow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes hintFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media (max-width: 768px) {
            .settings-hint { right: 20px; top: 80px; max-width: calc(100% - 40px); }
            .settings-hint-arrow { right: 20px; }
        }

        /* Stats Modal */
        .stats-header { display: flex; gap: 20px; margin-bottom: 20px; }
        .stats-level { flex: 1; }
        .stats-level-number { font-size: 1.5em; font-weight: 700; color: #667eea; margin-bottom: 10px; }
        .stats-xp-bar { height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden; }
        .stats-xp-fill { height: 100%; background: linear-gradient(90deg, #667eea, #f093fb); transition: width 0.5s; }
        .stats-xp-text { font-size: 0.85em; color: #666; margin-top: 5px; }
        .stats-streak { text-align: center; padding: 15px 25px; background: linear-gradient(135deg, #ff6b6b, #ee5a24); border-radius: 15px; color: white; }
        .stats-streak-number { font-size: 2em; font-weight: 800; }
        .stats-streak-label { font-size: 0.85em; opacity: 0.9; }
        .stats-total { text-align: center; padding: 25px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 15px; color: white; margin-bottom: 20px; }
        .stats-total-number { font-size: 3em; font-weight: 800; display: block; }
        .stats-total-label { font-size: 1em; opacity: 0.9; }
        .stats-badges { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .stat-badge { display: flex; flex-direction: column; align-items: center; padding: 12px; border-radius: 12px; min-width: 90px; text-align: center; transition: all 0.2s; }
        .stat-badge.unlocked { background: linear-gradient(135deg, #ffd700, #ffb347); }
        .stat-badge.locked { background: #e0e0e0; opacity: 0.5; }
        .stat-badge-icon { font-size: 1.8em; margin-bottom: 5px; }
        .stat-badge-name { font-size: 0.7em; font-weight: 600; color: #333; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .stat-item { background: #f8f9fa; padding: 12px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; }
        .stat-item span { font-size: 0.85em; color: #666; }
        .stat-item strong { font-size: 1.3em; color: #333; }
        
        /* Badge Unlock Animation */
        .badge-unlock { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: linear-gradient(135deg, #ffd700, #ffb347); color: #333; padding: 15px 25px; border-radius: 15px; display: flex; align-items: center; gap: 15px; box-shadow: 0 10px 40px rgba(255,215,0,0.4); z-index: 2000; transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .badge-unlock.show { transform: translateX(-50%) translateY(0); }
        .badge-unlock-icon { font-size: 2.5em; }
        .badge-unlock-text { display: flex; flex-direction: column; }
        .badge-unlock-text strong { font-size: 0.9em; }
        .badge-unlock-text span { font-size: 1.1em; font-weight: 700; }

        /* Goals Dashboard */
        .goals-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .goals-header h3 { margin: 0; color: #333; }
        .goals-progress-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 20px;
            padding: 25px;
            color: white;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }
        .goals-progress-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
        }
        .goals-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        .goals-objective-text {
            font-size: 1.1em;
            font-weight: 600;
            max-width: 70%;
        }
        .goals-deadline {
            font-size: 0.85em;
            opacity: 0.9;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
        }
        .goals-progress-visual {
            position: relative;
            z-index: 1;
        }
        .goals-progress-bar {
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .goals-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #38ef7d, #11998e);
            border-radius: 10px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .goals-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: progressShine 2s infinite;
        }
        @keyframes progressShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .goals-progress-numbers {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
        }
        .goals-current { font-weight: 700; font-size: 1.5em; }
        .goals-target { opacity: 0.8; }
        .goals-no-objective {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }
        .goals-no-objective-icon { font-size: 3em; margin-bottom: 15px; }
        .goals-no-objective p { margin-bottom: 20px; }
        .goals-form {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .goals-form-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        @media (max-width: 600px) {
            .goals-form-row { grid-template-columns: 1fr; }
        }
        .goals-form-group label {
            display: block;
            font-size: 0.85em;
            font-weight: 600;
            color: #555;
            margin-bottom: 6px;
        }
        .goals-form-group input,
        .goals-form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95em;
            transition: all 0.2s;
        }
        .goals-form-group input:focus,
        .goals-form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }
        .goals-actions-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        @media (max-width: 700px) {
            .goals-actions-grid { grid-template-columns: repeat(2, 1fr); }
        }
        .goals-action-card {
            background: white;
            border-radius: 15px;
            padding: 20px 15px;
            text-align: center;
            box-shadow: 0 3px 15px rgba(0,0,0,0.05);
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .goals-action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .goals-action-icon { font-size: 2em; margin-bottom: 10px; }
        .goals-action-value { font-size: 1.8em; font-weight: 800; color: #333; }
        .goals-action-label { font-size: 0.8em; color: #888; margin-top: 5px; }
        .goals-action-card.highlight {
            background: linear-gradient(135deg, #fff5f5, #ffebee);
            border-color: #ff6b6b;
        }
        .goals-action-card.highlight .goals-action-value { color: #ff6b6b; }
        .goals-motivation {
            background: linear-gradient(135deg, #fff8e1, #fff3c4);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid #f5a623;
            margin-bottom: 25px;
        }
        .goals-motivation-icon { font-size: 2em; margin-bottom: 10px; }
        .goals-motivation-text { font-size: 1.1em; color: #555; font-style: italic; }
        .goals-history {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px dashed #e0e0e0;
        }
        .goals-history h4 { margin: 0 0 15px; color: #333; }
        .goals-history-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .goals-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        .goals-history-date { color: #888; font-size: 0.85em; }
        .goals-history-value { font-weight: 600; color: #667eea; }
        .goals-btn-update {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .goals-btn-update:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.3);
        }
        .goals-btn-set {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        .goals-btn-set:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .goals-btn-delete {
            background: none;
            border: 2px solid #ff6b6b;
            color: #ff6b6b;
            padding: 8px 15px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .goals-btn-delete:hover {
            background: #ff6b6b;
            color: white;
        }
        .goals-update-section {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
            border-radius: 12px;
        }
        .goals-update-section .goals-form-group { flex: 1; margin-bottom: 0; }
        .goals-platform-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .goals-platform-chip {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 6px;
            background: white;
        }
        .goals-platform-chip:hover { border-color: #667eea; }
        .goals-platform-chip.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
            color: white;
        }
        .goals-completed {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 25px;
        }
        .goals-completed-icon { font-size: 3em; margin-bottom: 10px; }
        .goals-completed h3 { color: #155724; margin-bottom: 10px; }
        .goals-completed p { color: #155724; opacity: 0.8; }

        .btn-trends { background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; box-shadow: 0 0 10px rgba(255,107,107,0.5); }
        .btn-trends:hover { box-shadow: 0 0 20px rgba(255,107,107,0.7); }

        /* Halo animation for TRENDS button */
        @keyframes halo-pulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255,107,107,0.5), 0 0 20px rgba(255,107,107,0.3), 0 0 30px rgba(255,107,107,0.1); }
            50% { box-shadow: 0 0 15px rgba(255,107,107,0.8), 0 0 30px rgba(255,107,107,0.5), 0 0 45px rgba(255,107,107,0.3); }
        }
        .btn-halo { animation: halo-pulse 2s ease-in-out infinite; }
        .btn-halo:hover { animation: none; box-shadow: 0 0 25px rgba(255,107,107,0.9), 0 0 40px rgba(255,107,107,0.6); }

        .btn-newsletter { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-favorites { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
        .btn-prospector { background: linear-gradient(135deg, #f15a24, #ff8a50); color: white; position: relative; overflow: hidden; }
        .btn-prospector::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        .main-container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
        .intro-section { text-align: center; margin-bottom: 40px; }
        .intro-title { font-size: 2.5em; font-weight: 800; color: #333; margin-bottom: 10px; }
        .intro-subtitle { font-size: 1.2em; color: #666; }

        /* Pillar badge */
        .pillar-suggestion { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 20px; border-radius: 30px; display: inline-flex; align-items: center; gap: 10px; margin-top: 15px; font-size: 0.9em; }
        .pillar-suggestion strong { font-weight: 700; }

        .content-layout { display: grid; grid-template-columns: 400px 1fr; gap: 30px; align-items: start; }
        .content-layout .config-panel { position: sticky; top: 20px; }
        @media (max-width: 900px) { .content-layout { grid-template-columns: 1fr; } .content-layout .config-panel { position: static; } }

        .panel { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .panel-title { font-size: 1.3em; font-weight: 700; color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .config-section { margin-bottom: 25px; }

        /* Toggle header pour sections collapsibles */
        .config-toggle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px 12px;
            background: linear-gradient(135deg, #f8f9ff, #f0f4ff);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .config-toggle-header:hover {
            background: linear-gradient(135deg, #f0f4ff, #e8ecff);
            border-color: #e0e5ff;
        }
        .config-toggle-header .config-label {
            margin-bottom: 0;
            color: #333;
            text-shadow: none;
        }
        .toggle-arrow {
            font-size: 0.8em;
            color: #667eea;
            transition: transform 0.3s ease;
        }
        .toggle-arrow.open {
            transform: rotate(180deg);
        }
        .structure-grid.collapsed {
            display: none !important;
        }
        .structure-selected-badge {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 10px;
        }
        .config-label { font-weight: 600; color: white; margin-bottom: 10px; display: block; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .structure-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .structure-card { padding: 12px; border: 2px solid #e0e0e0; border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center; background: white; color: #333; }
        .structure-card:hover { border-color: #f093fb; background: #fef6ff; }
        .structure-card.active { border-color: #f093fb; background: white; box-shadow: 0 0 0 3px rgba(240,147,251,0.3); }
        .structure-icon { font-size: 1.5em; margin-bottom: 5px; }
        .structure-name { font-weight: 600; font-size: 0.85em; color: #333; }

        .format-grid, .platform-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .format-chip, .platform-chip, .tone-chip { padding: 8px 16px; border: 2px solid #e0e0e0; border-radius: 20px; cursor: pointer; transition: all 0.2s; font-size: 0.9em; display: flex; align-items: center; gap: 6px; background: white; color: #333; }
        .format-chip:hover, .platform-chip:hover, .tone-chip:hover { border-color: #f093fb; }
        .format-chip.active { background: linear-gradient(135deg, #f093fb, #f5576c); border-color: transparent; color: white; }
        .platform-chip.active { background: linear-gradient(135deg, #667eea, #764ba2); border-color: transparent; color: white; }
        .tone-chip.active { background: linear-gradient(135deg, #9c27b0, #7b1fa2); border-color: transparent; color: white; }
        .tone-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .tone-hint { font-size: 0.8em; color: #888; margin-top: 10px; font-style: italic; }

        /* Mode Création Toggle */
        .creation-mode-toggle { display: flex; flex-direction: column; gap: 8px; }
        .mode-option { display: flex; align-items: center; gap: 10px; padding: 12px 15px; background: white; border: 2px solid #e0e0e0; border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .mode-option:hover { border-color: #f093fb; }
        .mode-option:has(input:checked) { border-color: #f093fb; background: linear-gradient(135deg, #fff5fc, #fff0f5); }
        .mode-option input[type="radio"] { accent-color: #f093fb; width: 18px; height: 18px; }
        .mode-label { font-weight: 600; color: #333; }
        .mode-desc { font-size: 0.85em; color: #888; margin-left: auto; }

        /* Sélecteur de jour */
        .strategy-day-selector { margin-top: 12px; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .strategy-day-dropdown { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: inherit; font-size: 0.95em; background: white; cursor: pointer; transition: all 0.2s; }
        .strategy-day-dropdown:focus { outline: none; border-color: #f093fb; }

        /* Questions d'extraction */
        .extraction-questions { margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #f8f9ff, #f0f4ff); border-radius: 12px; border-left: 4px solid #667eea; }
        .extraction-questions h4 { margin: 0 0 10px 0; color: #667eea; font-size: 0.95em; }
        .extraction-questions ul { margin: 0; padding-left: 20px; }
        .extraction-questions li { margin-bottom: 8px; color: #555; font-size: 0.9em; line-height: 1.4; }
        .extraction-questions .day-objective { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; padding: 8px 12px; border-radius: 8px; font-size: 0.85em; margin-bottom: 12px; display: inline-block; }

        .idea-input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-family: inherit; font-size: 1em; resize: vertical; min-height: 100px; transition: all 0.3s; }
        .idea-input:focus { outline: none; border-color: #f093fb; box-shadow: 0 0 0 4px rgba(240,147,251,0.15); }

        /* Anecdote Section */
        .anecdote-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed #e0e0e0;
        }
        .optional-badge {
            font-size: 0.75em;
            font-weight: 400;
            color: #888;
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }
        .anecdote-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s;
            background: #fffbf5;
        }
        .anecdote-input:focus {
            outline: none;
            border-color: #f5a623;
            box-shadow: 0 0 0 4px rgba(245, 166, 35, 0.15);
            background: white;
        }
        .anecdote-input::placeholder {
            color: #aaa;
            font-style: italic;
        }
        .anecdote-hint {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-top: 10px;
            padding: 10px 12px;
            background: linear-gradient(135deg, #fff8e8, #fff5e0);
            border-radius: 8px;
            border-left: 3px solid #f5a623;
        }
        .hint-icon {
            font-size: 1.1em;
        }
        .anecdote-hint span:last-child {
            font-size: 0.85em;
            color: #666;
            line-height: 1.4;
        }
        /* Animation quand anecdote remplie */
        .anecdote-input:not(:placeholder-shown) {
            border-color: #f5a623;
            background: linear-gradient(135deg, #fffdf8, #fff9f0);
        }
        .anecdote-section.has-content .anecdote-hint {
            background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
            border-left-color: #4caf50;
        }
        /* Ghostwriter Badge */
        .ghostwriter-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #f5a623, #f7931e);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 10px;
            animation: ghostwriter-pulse 2s infinite;
        }
        @keyframes ghostwriter-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* ==================== CREATION MODE CARDS ==================== */
        .creation-mode-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .creation-mode-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .creation-mode-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.15);
        }
        .creation-mode-card.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
            color: white;
        }
        .creation-mode-card.active[data-mode="strategie"] {
            background: linear-gradient(135deg, #11998e, #38ef7d);
        }
        .creation-mode-card.active[data-mode="trends"] {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }
        .mode-card-icon {
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        .mode-card-title {
            font-weight: 700;
            font-size: 0.95em;
            margin-bottom: 3px;
        }
        .mode-card-desc {
            font-size: 0.75em;
            opacity: 0.8;
        }
        .creation-mode-card:not(.active) .mode-card-desc {
            color: #666;
        }
        /* Template éditable dans le mode 20 jours */
        .editable-template {
            margin-top: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #f8fff8, #f0fff4);
            border: 2px solid #38ef7d;
            border-radius: 12px;
            font-family: inherit;
            font-size: 0.95em;
            line-height: 1.8;
            white-space: pre-wrap;
        }
        .editable-template-label {
            display: block;
            font-size: 0.9em;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }
        .editable-template-hint {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 10px 12px;
            background: #fff3cd;
            border-radius: 8px;
            font-size: 0.85em;
            color: #856404;
        }
        /* Placeholders éditables */
        .template-placeholder {
            display: inline;
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            color: #e65100;
            padding: 2px 8px;
            border-radius: 6px;
            border: 1px dashed #ff9800;
            cursor: text;
            min-width: 100px;
            transition: all 0.2s;
        }
        .template-placeholder:hover {
            background: linear-gradient(135deg, #ffe0b2, #ffcc80);
            border-color: #f57c00;
        }
        .template-placeholder:focus {
            outline: none;
            background: white;
            border: 2px solid #f57c00;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.2);
        }
        .template-placeholder.edited {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            color: #2e7d32;
            border-color: #4caf50;
            border-style: solid;
        }
        .template-placeholder::before {
            content: none;
        }
        .template-static {
            color: #555;
        }
        @media (max-width: 500px) {
            .creation-mode-cards {
                grid-template-columns: 1fr;
            }
        }

        .quick-actions { display: flex; gap: 10px; margin-bottom: 15px; }
        .quick-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-family: inherit; font-size: 0.9em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .quick-btn.guide { background: linear-gradient(135deg, #ffd700, #ffb347); color: #333; }
        .quick-btn.help { background: linear-gradient(135deg, #00b894, #00cec9); color: white; }
        .quick-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        .generate-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, #f093fb, #f5576c); border: none; border-radius: 15px; font-family: inherit; font-size: 1.2em; font-weight: 700; color: white; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .generate-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(240,147,251,0.4); }
        .generate-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .output-panel { min-height: 500px; display: flex; flex-direction: column; }
        .output-content { flex: 1; background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); border-radius: 15px; padding: 25px; margin-bottom: 20px; overflow-y: auto; max-height: 500px; }
        .output-placeholder { text-align: center; color: #999; padding: 50px 20px; }
        .output-placeholder-icon { font-size: 4em; margin-bottom: 15px; opacity: 0.5; }
        .output-text { line-height: 1.8; color: #333; }
        .output-text h2 { color: #f5576c; margin: 20px 0 10px 0; font-size: 1.3em; }
        .output-text h3 { color: #667eea; margin: 15px 0 8px 0; font-size: 1.1em; }
        .output-text strong { color: #333; }
        .output-text pre { background: #1a1a2e; color: #eee; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 0.9em; margin: 10px 0; white-space: pre-wrap; }

        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .action-btn { flex: 1; min-width: 100px; padding: 12px 15px; border: 2px solid #e0e0e0; background: white; border-radius: 10px; font-family: inherit; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .action-btn:hover { border-color: #f093fb; background: #fef6ff; }
        .action-btn.primary { background: linear-gradient(135deg, #f093fb, #f5576c); border: none; color: white; }
        .action-btn.save { background: linear-gradient(135deg, #ff6b6b, #ee5a24); border: none; color: white; }

        /* Section Visuels */
        .visual-section-title { display: flex; align-items: center; gap: 10px; font-size: 0.85em; font-weight: 700; color: #667eea; text-transform: uppercase; letter-spacing: 1px; padding: 10px 0; border-top: 2px dashed #e0e0e0; margin-top: 5px; }
        .visual-title-icon { font-size: 1.3em; }
        .visual-btn { position: relative; overflow: hidden; }
        .visual-btn.sending { opacity: 0.7; pointer-events: none; }
        .visual-btn.sent::after { content: '✓ Envoyé !'; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; font-weight: 700; animation: sentPulse 0.5s ease; }
        @keyframes sentPulse { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }

        /* ==================== SECTION TOGGLES ==================== */
        .section-toggle {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,249,250,0.95));
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        .section-toggle:hover { border-color: #f093fb; background: white; }
        .section-toggle.open { border-color: #f093fb; border-radius: 12px 12px 0 0; background: white; }
        .section-toggle-left { display: flex; align-items: center; gap: 10px; font-weight: 600; color: #333; }
        .section-toggle-icon { font-size: 1.2em; }
        .section-toggle-right { display: flex; align-items: center; gap: 12px; }
        .section-toggle-value { font-size: 0.9em; color: #667eea; font-weight: 500; background: rgba(102,126,234,0.1); padding: 5px 12px; border-radius: 15px; }
        .section-toggle-arrow { font-size: 0.8em; color: #888; transition: transform 0.3s ease; }
        .section-toggle.open .section-toggle-arrow { transform: rotate(180deg); }

        .section-toggle-content {
            background: white;
            border: 2px solid #f093fb;
            border-top: none;
            border-radius: 0 0 12px 12px;
            padding: 15px;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* ==================== VISUAL TOGGLES ==================== */
        .visual-toggle-section { margin-top: 10px; }

        .visual-buttons-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .visual-tool-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            color: white;
            font-family: inherit;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .visual-tool-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
        }

        .primary-action-btn { box-shadow: 0 4px 15px rgba(16,185,129,0.3); transition: all 0.3s ease; }
        .primary-action-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16,185,129,0.4); }

        /* ==================== HOOKS SECTION STYLES ==================== */

        /* Brief recap */
        .hooks-brief-recap {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        .brief-recap-label {
            font-size: 0.8em;
            font-weight: 600;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .brief-recap-content {
            font-size: 0.95em;
            color: #333;
            line-height: 1.5;
            font-style: italic;
        }

        /* Emotion section */
        .hooks-emotion-section {
            margin-bottom: 20px;
        }
        .hooks-label {
            display: block;
            font-size: 0.95em;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }
        /* Toggle header for emotion section */
        .emotion-toggle-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 12px 16px;
            background: linear-gradient(135deg, #fef6ff, #fff0f9);
            border: 1px solid #f0e0f5;
            border-radius: 12px;
            margin-bottom: 0;
            transition: all 0.2s ease;
        }
        .emotion-toggle-header:hover {
            background: linear-gradient(135deg, #fdf0ff, #ffe8f6);
            border-color: #f093fb;
        }
        .emotion-toggle-header .toggle-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .emotion-toggle-header .toggle-label {
            font-size: 0.95em;
            font-weight: 600;
            color: #333;
        }
        .emotion-toggle-header .selected-vibe {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: white;
            border: 1px solid #f093fb;
            border-radius: 20px;
            font-size: 0.85em;
            color: #9333ea;
        }
        .emotion-toggle-header .toggle-arrow {
            font-size: 1.2em;
            transition: transform 0.3s ease;
            color: #9333ea;
        }
        .hooks-emotion-section.expanded .toggle-arrow {
            transform: rotate(180deg);
        }
        .emotion-chips-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }
        .hooks-emotion-section.expanded .emotion-chips-container {
            max-height: 300px;
            padding-top: 15px;
            opacity: 1;
        }
        .emotion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .emotion-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        .emotion-chip:hover {
            border-color: #f093fb;
            background: #fef6ff;
            transform: translateY(-2px);
        }
        .emotion-chip.active {
            border-color: #f093fb;
            background: linear-gradient(135deg, #fef6ff, #fff0f9);
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.25);
        }
        .emotion-icon {
            font-size: 1.2em;
        }
        .emotion-name {
            font-size: 0.9em;
            font-weight: 500;
            color: #333;
        }

        /* Trigger selector (optional) */
        .hooks-trigger-section {
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9ff, #fff8f0);
            border-radius: 12px;
            border: 1px dashed #e0e0e0;
        }
        .hooks-trigger-section.collapsed .trigger-chips { display: none; }
        .trigger-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            font-size: 0.9em;
            color: #666;
        }
        .trigger-toggle-text { display: flex; align-items: center; gap: 8px; }
        .trigger-toggle-arrow { transition: transform 0.2s; }
        .hooks-trigger-section:not(.collapsed) .trigger-toggle-arrow { transform: rotate(180deg); }
        .trigger-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        .trigger-chip {
            padding: 8px 14px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85em;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .trigger-chip:hover { border-color: #667eea; background: #f8f9ff; }
        .trigger-chip.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .trigger-chip-icon { font-size: 1em; }

        /* ==================== WIDGET BONNES PRATIQUES ==================== */
        .tips-widget {
            background: linear-gradient(135deg, #fff8e6, #fff3d6);
            border: 1px solid #f0d080;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }
        .tips-widget-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .tips-widget-title {
            font-weight: 700;
            color: #8b6914;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .tips-widget-toggle {
            background: none;
            border: none;
            color: #8b6914;
            cursor: pointer;
            font-size: 0.8em;
            opacity: 0.7;
        }
        .tips-widget-toggle:hover { opacity: 1; }
        .tips-list { display: flex; flex-direction: column; gap: 10px; }
        .tip-item {
            display: flex;
            gap: 10px;
            padding: 10px 12px;
            background: white;
            border-radius: 8px;
            font-size: 0.85em;
            line-height: 1.4;
            border-left: 3px solid #f0c040;
        }
        .tip-icon { font-size: 1.1em; flex-shrink: 0; }
        .tip-text { color: #555; flex: 1; }
        .tip-badge {
            background: #4CAF50;
            color: white;
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 600;
            white-space: nowrap;
        }
        .tips-widget.collapsed .tips-list { display: none; }
        .tips-empty {
            text-align: center;
            color: #8b6914;
            font-size: 0.85em;
            padding: 10px;
            opacity: 0.7;
        }
        .tips-widget-error {
            background: linear-gradient(135deg, #fff0f0, #fee);
            border-color: #f0a0a0;
        }
        .tips-widget-error .tips-widget-title { color: #c44; }

        /* ==================== CONTEXTUAL REMINDER BAR ==================== */
        .contextual-reminder {
            position: fixed;
            bottom: 45px;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            padding: 10px 20px;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 -2px 15px rgba(102, 126, 234, 0.3);
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        .contextual-reminder.visible {
            transform: translateY(0);
        }
        .reminder-icon {
            font-size: 1.2em;
            animation: pulse-icon 2s infinite;
        }
        @keyframes pulse-icon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .reminder-text {
            color: white;
            font-size: 0.9em;
            font-weight: 500;
            text-align: center;
            line-height: 1.3;
        }
        .reminder-text strong {
            color: #ffd700;
            font-weight: 700;
        }
        .reminder-close {
            position: absolute;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            transition: background 0.2s;
        }
        .reminder-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .reminder-nav {
            display: flex;
            gap: 8px;
            position: absolute;
            left: 15px;
        }
        .reminder-nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.7em;
            transition: background 0.2s;
        }
        .reminder-nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        @media (max-width: 600px) {
            .contextual-reminder {
                padding: 8px 40px;
                bottom: 40px;
            }
            .reminder-text { font-size: 0.8em; }
            .reminder-nav { display: none; }
        }

        /* Generate hooks button */
        .hooks-generate-section {
            margin-bottom: 25px;
        }
        .generate-hooks-btn {
            width: 100%;
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            color: white;
            font-family: inherit;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .generate-hooks-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .generate-hooks-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .generate-hooks-btn.loading {
            pointer-events: none;
        }
        .generate-hooks-btn.loading span::after {
            content: '...';
            animation: dots 1.5s infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Hooks results */
        .hooks-results {
            margin-bottom: 20px;
        }
        .hooks-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .hooks-results-title {
            font-size: 1em;
            font-weight: 600;
            color: #333;
        }
        .hooks-regenerate-btn {
            padding: 8px 16px;
            background: transparent;
            border: 2px solid #667eea;
            border-radius: 8px;
            color: #667eea;
            font-family: inherit;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .hooks-regenerate-btn:hover {
            background: #667eea;
            color: white;
        }

        /* Hooks grid */
        .hooks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        .hook-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 14px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .hook-card:hover {
            border-color: #f093fb;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .hook-card.selected {
            border-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.25);
        }
        .hook-card.selected::after {
            content: '✓';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            background: #10b981;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
        }
        .hook-card-text {
            font-size: 0.95em;
            line-height: 1.6;
            color: #333;
        }
        .hook-card-emotion {
            margin-top: 10px;
            font-size: 0.8em;
            color: #888;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Continue section */
        .hooks-continue-section {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            padding-top: 15px;
            border-top: 2px dashed #e0e0e0;
        }
        .hooks-continue-btn {
            flex: 1;
            min-width: 200px;
            padding: 16px 25px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 12px;
            color: white;
            font-family: inherit;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .hooks-continue-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        .hooks-continue-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .hooks-back-btn {
            padding: 16px 20px;
            background: transparent;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            color: #666;
            font-family: inherit;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .hooks-back-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        /* Selected hook display in content section */
        .selected-hook-display {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .selected-hook-label {
            font-size: 0.8em;
            font-weight: 600;
            color: #059669;
            margin-bottom: 8px;
        }
        .selected-hook-text {
            font-size: 0.95em;
            color: #333;
            line-height: 1.5;
            font-weight: 500;
            margin-bottom: 12px;
        }
        .change-hook-btn {
            padding: 8px 16px;
            background: transparent;
            border: 2px solid #10b981;
            border-radius: 8px;
            color: #10b981;
            font-family: inherit;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .change-hook-btn:hover {
            background: #10b981;
            color: white;
        }

        /* ==================== HUMOR MODES PANEL ==================== */
        .humor-modes-panel {
            background: linear-gradient(135deg, #fef9c3, #fef08a);
            border: 2px solid #facc15;
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 20px;
            animation: slideDown 0.3s ease;
        }
        .humor-modes-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .humor-mode-btn {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 14px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            font-family: inherit;
        }
        .humor-mode-btn:hover {
            border-color: #facc15;
            background: #fffef0;
            transform: translateX(5px);
        }
        .humor-mode-btn.active {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2);
        }
        .humor-mode-icon {
            font-size: 1.5em;
            margin-bottom: 5px;
        }
        .humor-mode-title {
            font-size: 0.95em;
            font-weight: 700;
            color: #333;
        }
        .humor-mode-desc {
            font-size: 0.8em;
            color: #666;
            margin-top: 3px;
            line-height: 1.3;
        }

        /* ==================== ADJUST PANEL STYLES ==================== */
        .action-btn.adjust {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border: none;
            color: white;
        }
        .action-btn.adjust:hover {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
        }

        .action-btn.audit {
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            color: white;
        }
        .action-btn.audit:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .adjust-panel {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 16px;
            padding: 20px;
            margin-top: 15px;
            animation: slideDown 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .adjust-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }
        .adjust-panel-title {
            font-size: 1em;
            font-weight: 600;
            color: #333;
        }
        .adjust-close-btn {
            background: none;
            border: none;
            font-size: 1.2em;
            color: #999;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            transition: color 0.2s;
        }
        .adjust-close-btn:hover {
            color: #333;
        }

        .adjust-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .adjust-row {
            display: flex;
            gap: 10px;
        }
        .adjust-option-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 16px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-family: inherit;
            font-size: 0.9em;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .adjust-option-btn:hover {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, #f5f3ff, #ede9fe);
            transform: translateY(-2px);
        }
        .adjust-icon {
            font-size: 1.1em;
        }

        .adjust-custom {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 5px;
        }
        .adjust-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.9em;
            resize: none;
            min-height: 60px;
            transition: border-color 0.2s;
        }
        .adjust-input:focus {
            outline: none;
            border-color: #8b5cf6;
        }
        .adjust-input::placeholder {
            color: #999;
        }
        .adjust-submit-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border: none;
            border-radius: 10px;
            color: white;
            font-family: inherit;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .adjust-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        /* ==================== CASCADE STYLES ==================== */
        .btn-cascade { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; position: relative; }
        .btn-cascade::before { content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 10px; z-index: -1; opacity: 0.4; filter: blur(6px); }
        
        .btn-posts { background: linear-gradient(135deg, #10b981, #059669); color: white; position: relative; }
        .btn-posts::before { content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 10px; z-index: -1; opacity: 0.4; filter: blur(6px); animation: postsGlow 2s ease-in-out infinite; }
        @keyframes postsGlow { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.6; } }
        
        .cascade-container { display: flex; gap: 20px; padding: 20px; max-height: calc(90vh - 80px); overflow: hidden; }
        .cascade-calendar { flex: 1; overflow-y: auto; }
        .cascade-sidebar { width: 280px; background: #f8f9fa; border-radius: 16px; padding: 20px; display: flex; flex-direction: column; max-height: 100%; overflow: hidden; }
        
        .cascade-nav-btn { background: rgba(102,126,234,0.1); border: 2px solid #667eea; color: #667eea; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .cascade-nav-btn:hover { background: #667eea; color: white; }
        
        .cascade-week { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        
        .cascade-day { background: white; border: 2px solid #e8e8e8; border-radius: 12px; min-height: 180px; display: flex; flex-direction: column; transition: all 0.2s; }
        .cascade-day:hover { border-color: #667eea; box-shadow: 0 4px 15px rgba(102,126,234,0.15); }
        .cascade-day.today { border-color: #667eea; background: linear-gradient(180deg, rgba(102,126,234,0.05), white); }
        .cascade-day.weekend { background: #fafafa; }
        .cascade-day.past { opacity: 0.6; background: #f0f0f0; pointer-events: none; }
        .cascade-day.past .cascade-day-header { background: #e8e8e8; }
        .cascade-day.past .cascade-slot { pointer-events: auto; cursor: default; }
        .cascade-slot.past-slot { opacity: 0.7; filter: grayscale(30%); }
        .cascade-slot-done { position: absolute; bottom: 5px; right: 8px; font-size: 0.8em; background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 10px; }
        .cascade-day.drag-over { border-color: #10b981; border-style: dashed; background: rgba(16,185,129,0.05); }
        
        .cascade-day-header { padding: 10px; border-bottom: 1px solid #eee; text-align: center; background: linear-gradient(180deg, #f8f9fa, transparent); border-radius: 10px 10px 0 0; }
        .cascade-day-name { font-size: 0.75em; text-transform: uppercase; color: #888; letter-spacing: 1px; }
        .cascade-day-number { font-size: 1.4em; font-weight: 700; color: #333; }
        .cascade-day.today .cascade-day-number { color: white; background: #667eea; width: 35px; height: 35px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; }
        
        .cascade-day-slots { flex: 1; padding: 8px; display: flex; flex-direction: column; gap: 6px; overflow-y: auto; }
        
        .cascade-slot { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 10px; border-radius: 8px; font-size: 0.8em; cursor: pointer; transition: all 0.2s; position: relative; }
        .cascade-slot:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(102,126,234,0.3); }
        .cascade-slot.linkedin { background: linear-gradient(135deg, #0077b5, #005582); }
        .cascade-slot.instagram { background: linear-gradient(135deg, #E1306C, #C13584); }
        .cascade-slot.twitter { background: linear-gradient(135deg, #1DA1F2, #0d8bd9); }
        .cascade-slot.facebook { background: linear-gradient(135deg, #1877F2, #0d65d9); }
        .cascade-slot.tiktok { background: linear-gradient(135deg, #000000, #333333); }
        
        .cascade-slot-time { font-weight: 700; font-size: 0.9em; }
        .cascade-slot-preview { font-size: 0.85em; opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; margin-top: 3px; }
        .cascade-slot-platform { position: absolute; top: 5px; right: 8px; font-size: 0.9em; }
        
        .cascade-add-btn { width: 100%; padding: 8px; background: transparent; border: 2px dashed #ddd; border-radius: 8px; color: #999; cursor: pointer; transition: all 0.2s; font-size: 0.85em; margin-top: auto; }
        .cascade-add-btn:hover { border-color: #667eea; color: #667eea; background: rgba(102,126,234,0.05); }
        
        .cascade-sidebar-title { font-size: 1em; font-weight: 700; color: #333; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .cascade-sidebar-desc { font-size: 0.8em; color: #888; margin-bottom: 15px; }
        
        .cascade-favorites { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; max-height: 250px; padding-right: 5px; }
        
        .cascade-fav-item { background: white; border: 2px solid #e8e8e8; border-radius: 10px; padding: 10px; cursor: grab; transition: all 0.2s; font-size: 0.85em; }
        .cascade-fav-item:hover { border-color: #667eea; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
        .cascade-fav-item:active { cursor: grabbing; transform: scale(0.98); }
        .cascade-fav-item.dragging { opacity: 0.5; }
        .cascade-fav-platform { font-size: 0.75em; color: #667eea; font-weight: 600; margin-bottom: 3px; }
        .cascade-fav-preview { color: #555; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .cascade-export-section { margin-top: auto; padding-top: 15px; border-top: 1px solid #e0e0e0; }
        .cascade-export-buttons { display: flex; flex-direction: column; gap: 8px; }
        .cascade-export-btn { display: flex; align-items: center; gap: 10px; padding: 10px 15px; background: white; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-family: inherit; font-size: 0.9em; }
        .cascade-export-btn:hover { border-color: #667eea; background: rgba(102,126,234,0.05); }
        .cascade-export-btn span { font-size: 1.2em; }
        
        .cascade-empty { text-align: center; padding: 20px; color: #999; font-size: 0.9em; }
        
        .cascade-stats { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .cascade-stats-title { font-size: 0.8em; opacity: 0.9; margin-bottom: 5px; }
        .cascade-stats-value { font-size: 1.8em; font-weight: 800; }
        
        @media (max-width: 900px) {
            .cascade-container { flex-direction: column; }
            .cascade-sidebar { width: 100%; max-height: 200px; }
            .cascade-week { grid-template-columns: repeat(4, 1fr); }
        }

        .visual-section { margin-top: 25px; padding-top: 25px; border-top: 2px dashed #e0e0e0; }
        .visual-title { font-weight: 700; color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .copy-prompt-btn { padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 0.85em; cursor: pointer; font-family: inherit; }

        .toast { position: fixed; bottom: 55px; right: 30px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px 25px; border-radius: 10px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 999999; }
        .toast.show { transform: translateX(0); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes spin { to { transform: rotate(360deg); } }

        .idea-btn { padding: 10px 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-family: inherit; margin: 5px; }
        .idea-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }

        /* Trends suggestions */
        .trend-card { background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 12px; border-left: 4px solid #ff6b6b; cursor: pointer; transition: all 0.2s; }
        .trend-card:hover { background: #fff0f0; transform: translateX(5px); }
        .trend-title { font-weight: 600; color: #333; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .trend-desc { font-size: 0.9em; color: #666; margin-bottom: 10px; }
        .trend-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
        .trend-actions { display: flex; gap: 10px; margin-top: 12px; }
        .trend-use-btn { padding: 6px 14px; background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; border: none; border-radius: 20px; font-size: 0.8em; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .trend-use-btn:hover { transform: scale(1.05); }
        .trend-save-btn { padding: 6px 14px; background: white; border: 2px solid #ffc107; color: #856404; border-radius: 20px; font-size: 0.8em; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .trend-save-btn:hover { background: #ffc107; color: white; }
        .trend-save-btn.saved { background: #ffc107; color: white; }

        /* Trends Tabs */
        .trends-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e8e8e8; padding-bottom: 15px; }
        .trends-tab { padding: 10px 20px; background: transparent; border: none; border-radius: 10px; font-family: inherit; font-weight: 600; font-size: 0.95em; cursor: pointer; color: #666; transition: all 0.3s; }
        .trends-tab:hover { background: #f0f0f0; color: #333; }
        .trends-tab.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .trends-tab .badge { display: inline-block; background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 5px; }

        /* Saved ideas section */
        .saved-ideas-section { margin-top: 20px; padding-top: 20px; border-top: 2px dashed #e8e8e8; }
        .saved-ideas-title { font-weight: 600; color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .saved-idea-card { background: linear-gradient(135deg, #fff9e6, #fff3cd); border-left: 4px solid #ffc107; }
        .saved-idea-date { font-size: 0.75em; color: #856404; margin-top: 8px; }
        .trend-delete-btn { padding: 4px 10px; background: #ffebee; border: none; color: #c62828; border-radius: 15px; font-size: 0.75em; cursor: pointer; font-family: inherit; }
        .trend-delete-btn:hover { background: #c62828; color: white; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none !important; align-items: center; justify-content: center; z-index: 1000; padding: 20px; visibility: hidden !important; opacity: 0 !important; }
        .modal-overlay.show, .modal-overlay.active { display: flex !important; visibility: visible !important; opacity: 1 !important; }
        .modal { background: white; border-radius: 20px; padding: 30px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.5em; font-weight: 700; color: #333; }

        /* Modal - Responsive */
        @media (max-width: 600px) {
            .modal-overlay { padding: 10px; }
            .modal { padding: 20px; border-radius: 15px; max-height: 90vh; }
            .modal-title { font-size: 1.2em; }
            .modal-header { margin-bottom: 15px; }
        }
        .modal-title .info-tooltip {
            font-size: 0.6em;
            cursor: help;
            opacity: 0.7;
            margin-left: 8px;
            vertical-align: middle;
        }
        .modal-title .info-tooltip:hover { opacity: 1; }
        .modal-close { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #999; }
        .favorite-item { background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .favorite-item-date { font-size: 0.8em; color: #999; margin-bottom: 8px; }
        .favorite-item-text { font-size: 0.95em; line-height: 1.6; color: #333; max-height: 150px; overflow: hidden; }
        .favorite-item-actions { display: flex; gap: 10px; margin-top: 10px; }
        .favorite-item-btn { padding: 6px 12px; border: none; border-radius: 6px; font-size: 0.8em; cursor: pointer; font-family: inherit; }
        .favorite-item-btn.use { background: #667eea; color: white; }
        .favorite-item-btn.delete { background: #ff6b6b; color: white; }
        .empty-favorites { text-align: center; color: #999; padding: 40px 20px; }

        .help-textarea { width: 100%; min-height: 150px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-family: inherit; font-size: 1em; resize: vertical; margin-bottom: 15px; }
        .help-textarea:focus { outline: none; border-color: #00b894; }
        .help-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #00b894, #00cec9); color: white; border: none; border-radius: 10px; font-family: inherit; font-size: 1em; font-weight: 600; cursor: pointer; }

        /* Planning IA Styles */
        .planning-intro { background: linear-gradient(135deg, rgba(17,153,142,0.1), rgba(56,239,125,0.1)); border-radius: 15px; padding: 20px; margin-bottom: 25px; text-align: center; }
        .planning-intro h3 { color: #11998e; margin-bottom: 10px; }
        .planning-intro p { color: #666; font-size: 0.95em; }
        .planning-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .planning-stat { background: #f8f9fa; border-radius: 12px; padding: 15px; text-align: center; }
        .planning-stat-value { font-size: 1.8em; font-weight: 700; color: #11998e; }
        .planning-stat-label { font-size: 0.8em; color: #666; margin-top: 5px; }
        .planning-generate-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, #11998e, #38ef7d); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .planning-generate-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(17,153,142,0.3); }
        .planning-generate-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .planning-results { margin-top: 25px; }
        .planning-section { background: white; border: 1px solid #e0e0e0; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .planning-section h4 { color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .heatmap-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 15px; }
        .heatmap-day { text-align: center; padding: 8px 5px; border-radius: 8px; font-size: 0.75em; }
        .heatmap-day.header { background: #f0f0f0; font-weight: 600; color: #666; }
        .heatmap-day.empty { background: #f8f9fa; color: #ccc; }
        .heatmap-day.low { background: rgba(17,153,142,0.2); color: #11998e; }
        .heatmap-day.medium { background: rgba(17,153,142,0.5); color: white; }
        .heatmap-day.high { background: #11998e; color: white; font-weight: 600; }
        .planning-suggestion { display: flex; align-items: flex-start; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; margin-bottom: 12px; transition: all 0.3s; }
        .planning-suggestion:hover { background: #f0f0f0; transform: translateX(5px); }
        .planning-suggestion-icon { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.3em; flex-shrink: 0; }
        .planning-suggestion-icon.linkedin { background: #e8f4fc; }
        .planning-suggestion-icon.instagram { background: #fce4ec; }
        .planning-suggestion-icon.tiktok { background: #f0f0f0; }
        .planning-suggestion-icon.facebook { background: #e8f0fe; }
        .planning-suggestion-content { flex: 1; }
        .planning-suggestion-title { font-weight: 600; color: #333; margin-bottom: 5px; }
        .planning-suggestion-meta { font-size: 0.85em; color: #888; }
        .planning-suggestion-reason { font-size: 0.9em; color: #666; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #e0e0e0; }
        .planning-alert { display: flex; align-items: center; gap: 12px; padding: 15px; border-radius: 12px; margin-bottom: 12px; }
        .planning-alert.warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        .planning-alert.success { background: #d4edda; border-left: 4px solid #28a745; }
        .planning-alert.info { background: #e7f3ff; border-left: 4px solid #667eea; }
        .planning-pillar-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .planning-pillar-name { width: 120px; font-size: 0.9em; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .planning-pillar-track { flex: 1; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden; }
        .planning-pillar-fill { height: 100%; background: linear-gradient(90deg, #11998e, #38ef7d); border-radius: 6px; transition: width 0.5s; }
        .planning-pillar-count { width: 40px; text-align: right; font-size: 0.85em; color: #888; }

        /* Tour guidé */
        .tour-tooltip { position: fixed; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px 30px; border-radius: 20px; width: 340px; max-width: calc(100vw - 60px); z-index: 2000; box-shadow: 0 20px 50px rgba(102,126,234,0.5); animation: tooltipSlideIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .tour-tooltip.side-left { left: 30px; }
        .tour-tooltip.side-right { right: 30px; }
        .tour-tooltip.side-bottom { left: 50%; transform: translateX(-50%); }
        @keyframes tooltipSlideIn { from { opacity: 0; transform: translateY(20px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .tour-tooltip-step { font-size: 0.75em; opacity: 0.7; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .tour-tooltip-title { font-weight: 800; margin-bottom: 12px; font-size: 1.3em; }
        .tour-tooltip-text { font-size: 0.95em; line-height: 1.7; margin-bottom: 20px; }
        .tour-tooltip-text strong { color: #ffd700; }
        .tour-tooltip-progress { display: flex; gap: 6px; justify-content: center; margin-bottom: 20px; }
        .tour-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.3); transition: all 0.3s; }
        .tour-dot.active { background: #ffd700; transform: scale(1.2); }
        .tour-tooltip-buttons { display: flex; gap: 12px; justify-content: space-between; }
        .tour-btn { padding: 12px 24px; border: none; border-radius: 10px; font-size: 0.95em; cursor: pointer; font-family: inherit; font-weight: 700; transition: all 0.3s; }
        .tour-btn.skip { background: rgba(255,255,255,0.15); color: white; }
        .tour-btn.skip:hover { background: rgba(255,255,255,0.25); }
        .tour-btn.next { background: white; color: #667eea; }
        .tour-btn.next:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .tour-highlight { position: relative; z-index: 1001; background: white; border-radius: 12px; box-shadow: 0 0 0 4px rgba(240,147,251,0.6), 0 0 30px rgba(240,147,251,0.4); animation: highlightPulse 2s infinite; pointer-events: auto; cursor: pointer; }
        @keyframes highlightPulse { 0%, 100% { box-shadow: 0 0 0 4px rgba(240,147,251,0.6), 0 0 30px rgba(240,147,251,0.4); } 50% { box-shadow: 0 0 0 8px rgba(240,147,251,0.4), 0 0 50px rgba(240,147,251,0.3); } }
        .tour-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 999; display: none; pointer-events: none; }
        .tour-overlay.show { display: block; animation: fadeIn 0.3s; }
        .tour-tooltip, .tour-arrow { pointer-events: auto; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Mon Style Styles */
        .voice-section { background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(240,147,251,0.1)); border-radius: 15px; padding: 20px; margin-top: 20px; }
        .voice-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .voice-title { font-size: 1.1em; font-weight: 700; color: #333; display: flex; align-items: center; gap: 10px; }
        .voice-badge { display: inline-flex; align-items: center; gap: 5px; padding: 5px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; }
        .voice-badge.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .voice-badge.inactive { background: #f0f0f0; color: #888; }
        .voice-btn { padding: 10px 20px; border: none; border-radius: 10px; font-family: inherit; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .voice-btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .voice-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }
        .voice-btn-secondary { background: white; border: 2px solid #667eea; color: #667eea; }
        .voice-btn-secondary:hover { background: #667eea; color: white; }
        .voice-btn-danger { background: #ff6b6b; color: white; }
        .voice-textarea { width: 100%; min-height: 200px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-family: inherit; font-size: 0.95em; resize: vertical; transition: border-color 0.3s; }
        .voice-textarea:focus { outline: none; border-color: #667eea; }
        .voice-samples { display: flex; flex-direction: column; gap: 10px; margin: 15px 0; }
        .voice-sample { background: white; border: 1px solid #e0e0e0; border-radius: 10px; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        .voice-sample-text { flex: 1; font-size: 0.9em; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 400px; }
        .voice-sample-actions { display: flex; gap: 8px; }
        .voice-sample-btn { background: none; border: none; cursor: pointer; font-size: 1.1em; opacity: 0.6; transition: opacity 0.3s; }
        .voice-sample-btn:hover { opacity: 1; }
        .voice-analysis { background: white; border-radius: 12px; padding: 20px; margin-top: 15px; }
        .voice-analysis-title { font-weight: 700; color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .voice-trait { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .voice-trait:last-child { border-bottom: none; }
        .voice-trait-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2em; }
        .voice-trait-icon.tone { background: #e8f5e9; }
        .voice-trait-icon.length { background: #e3f2fd; }
        .voice-trait-icon.vocab { background: #fff3e0; }
        .voice-trait-icon.punctuation { background: #fce4ec; }
        .voice-trait-icon.structure { background: #f3e5f5; }
        .voice-trait-content { flex: 1; }
        .voice-trait-label { font-size: 0.85em; color: #888; margin-bottom: 3px; }
        .voice-trait-value { font-weight: 600; color: #333; }
        .voice-fidelity { display: flex; align-items: center; gap: 10px; padding: 15px; background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border-radius: 10px; margin-top: 15px; }
        .voice-fidelity-score { font-size: 1.8em; font-weight: 800; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .voice-fidelity-label { font-size: 0.9em; color: #666; }

        /* Toggle Tu/Vous dans Mon Style */
        .voice-setting-section { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 12px; }
        .voice-setting-label { font-weight: 600; color: #333; margin-bottom: 5px; }
        .voice-setting-hint { font-size: 0.85em; color: #888; margin: 0 0 12px 0; }
        .formal-style-toggle { display: flex; border-radius: 8px; overflow: hidden; border: 2px solid #e0e0e0; width: fit-content; }
        .formal-style-toggle .toggle-btn { padding: 10px 25px; border: none; background: white; cursor: pointer; font-weight: 600; font-size: 1em; transition: all 0.2s; }
        .formal-style-toggle .toggle-btn:first-child { border-right: 2px solid #e0e0e0; }
        .formal-style-toggle .toggle-btn.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .formal-style-toggle .toggle-btn:hover:not(.active) { background: #f0f4ff; }

        /* Badge fidélité voix sur contenu généré */
        .voice-fidelity-badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 15px; background: linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.15)); border: 1px solid rgba(102,126,234,0.3); border-radius: 20px; font-size: 0.85em; margin-bottom: 15px; }
        .voice-fidelity-badge .score { font-weight: 700; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .voice-fidelity-badge .label { color: #666; }
        .voice-feedback { display: flex; align-items: center; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; margin-top: 15px; }
        .voice-feedback-question { flex: 1; font-size: 0.95em; color: #555; }
        .voice-feedback-buttons { display: flex; gap: 8px; }
        .voice-feedback-btn { padding: 8px 16px; border: none; border-radius: 8px; font-size: 0.9em; cursor: pointer; transition: all 0.3s; }
        .voice-feedback-btn.yes { background: #d4edda; color: #155724; }
        .voice-feedback-btn.yes:hover { background: #28a745; color: white; }
        .voice-feedback-btn.no { background: #f8d7da; color: #721c24; }
        .voice-feedback-btn.no:hover { background: #dc3545; color: white; }
        .voice-feedback-thanks { color: #28a745; font-weight: 600; display: none; }

        /* Newsletter Module - MON STYLE Button */
        .ma-voix-section { margin-top: 20px; }
        .ma-voix-option { display: flex; flex-direction: column; gap: 12px; }
        .btn-ma-voix { display: flex; align-items: center; gap: 15px; padding: 15px 20px; background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(240,147,251,0.1)); border: 2px solid #667eea; border-radius: 12px; cursor: pointer; transition: all 0.3s; }
        .btn-ma-voix:hover:not(.disabled) { background: linear-gradient(135deg, #667eea, #764ba2); border-color: transparent; }
        .btn-ma-voix:hover:not(.disabled) .ma-voix-text strong { color: white; }
        .btn-ma-voix:hover:not(.disabled) .ma-voix-text small { color: rgba(255,255,255,0.8); }
        .btn-ma-voix:hover:not(.disabled) .ma-voix-icon { transform: scale(1.2); }
        .btn-ma-voix.disabled { opacity: 0.5; cursor: not-allowed; border-color: #ccc; }
        .ma-voix-icon { font-size: 2em; transition: transform 0.3s; }
        .ma-voix-text { display: flex; flex-direction: column; text-align: left; }
        .ma-voix-text strong { font-size: 1.1em; color: #333; transition: color 0.3s; }
        .ma-voix-text small { color: #666; font-size: 0.85em; transition: color 0.3s; }
        .ma-voix-hint { font-size: 0.85em; color: #888; padding: 10px; background: #f8f9fa; border-radius: 8px; }
        .ma-voix-active { display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.1)); border: 1px solid #10b981; border-radius: 8px; color: #059669; font-weight: 600; }
        .ma-voix-preview { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 1px solid #e0e0e0; }
        .ma-voix-preview h5 { font-size: 0.9em; color: #555; margin-bottom: 10px; }
        .ma-voix-preview-content { font-size: 0.9em; }
        .voice-preview-profile { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .voice-tag { display: inline-flex; align-items: center; gap: 5px; padding: 5px 10px; background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(240,147,251,0.1)); border-radius: 15px; font-size: 0.85em; color: #555; }
        .voice-preview-samples { margin-top: 10px; }
        .samples-count { font-size: 0.85em; color: #888; display: block; margin-bottom: 5px; }
        .sample-excerpt { font-style: italic; color: #666; font-size: 0.9em; padding: 10px; background: white; border-radius: 8px; border-left: 3px solid #667eea; }

        /* Newsletter Module - Tone Grid */
        .tone-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-top: 10px; }
        .tone-card { padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s; }
        .tone-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .tone-card.selected { border-color: #667eea; background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(240,147,251,0.1)); }
        .tone-icon { font-size: 1.5em; display: block; margin-bottom: 5px; }
        .tone-name { font-weight: 600; color: #333; display: block; margin-bottom: 3px; }
        .tone-desc { font-size: 0.75em; color: #888; display: block; }

        /* Newsletter Module - General Styles */
        .newsletter-container { padding: 20px; }
        .newsletter-header { margin-bottom: 20px; }
        .newsletter-main-title { font-size: 1.4em; font-weight: 700; color: #333; display: flex; align-items: center; gap: 10px; }
        .newsletter-icon { font-size: 1.2em; }
        .newsletter-progress { margin-bottom: 25px; }
        .progress-steps { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .progress-step { text-align: center; flex: 1; }
        .progress-step .step-icon { font-size: 1.3em; opacity: 0.4; transition: opacity 0.3s; }
        .progress-step .step-label { font-size: 0.75em; color: #888; margin-top: 3px; }
        .progress-step.active .step-icon { opacity: 1; }
        .progress-step.current .step-label { color: #667eea; font-weight: 600; }
        .progress-bar { height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s; }
        .step-content { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); }
        .step-title { font-size: 1.2em; font-weight: 700; color: #333; margin-bottom: 8px; }
        .step-description { color: #666; font-size: 0.95em; margin-bottom: 20px; }
        .section-label { font-size: 0.95em; font-weight: 600; color: #555; margin-bottom: 10px; }
        .newsletter-nav { display: flex; justify-content: space-between; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .btn-primary { padding: 12px 25px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { padding: 12px 25px; background: white; color: #667eea; border: 2px solid #667eea; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-secondary:hover { background: #667eea; color: white; }
        .btn-generate { padding: 15px 30px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1.1em; cursor: pointer; transition: all 0.3s; }
        .btn-generate:hover { transform: translateY(-2px); box-shadow: 0 5px 25px rgba(16,185,129,0.5); }
        .type-grid, .structure-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .type-card, .structure-card { padding: 20px; background: white; color: #333; border: 2px solid #e0e0e0; border-radius: 15px; cursor: pointer; transition: all 0.3s; }
        .type-card:hover, .structure-card:hover { border-color: #667eea; transform: translateY(-3px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); background: white; }
        .type-card.selected, .structure-card.selected { border-color: #667eea; background: white; box-shadow: 0 0 0 3px rgba(102,126,234,0.3); }
        .type-icon, .structure-icon { font-size: 2em; margin-bottom: 10px; }
        .type-name, .structure-name { font-weight: 700; color: #333; margin-bottom: 5px; }
        .type-description, .structure-description { font-size: 0.85em; color: #666; }
        .type-example { margin-top: 12px; padding: 12px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 10px; border-left: 3px solid #667eea; }
        .type-example .example-label { font-size: 0.75em; color: #667eea; font-weight: 600; margin-bottom: 6px; }
        .type-example .example-subject { font-size: 0.85em; color: #333; font-weight: 600; margin-bottom: 4px; }
        .type-example .example-preview { font-size: 0.8em; color: #666; font-style: italic; }
        .type-hint { margin-top: 10px; font-size: 0.75em; color: #888; padding-top: 8px; border-top: 1px dashed #e0e0e0; }
        .sequence-tooltip { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #667eea; color: white; border-radius: 50%; font-size: 0.7em; margin-left: 5px; cursor: help; vertical-align: middle; }
        .sequence-tooltip:hover { background: #5a6fd6; }
        .structure-steps { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e0e0e0; }
        .structure-step { font-size: 0.8em; color: #888; padding: 2px 0; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; color: #333; margin-bottom: 8px; }
        .form-group textarea, .form-group input, .form-group select { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: inherit; font-size: 0.95em; transition: border-color 0.3s; }
        .form-group textarea:focus, .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .result-section { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .section-title { font-weight: 600; color: #333; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .subject-options { display: flex; flex-direction: column; gap: 10px; }
        .subject-option { display: flex; align-items: center; gap: 12px; padding: 12px 15px; background: white; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; transition: all 0.3s; }
        .subject-option:hover, .subject-option.selected { border-color: #667eea; }
        .subject-num { width: 25px; height: 25px; background: #667eea; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: 600; }
        .subject-text { flex: 1; }
        .email-body-box { background: white; border-radius: 10px; padding: 20px; border: 1px solid #e0e0e0; }
        .email-content { line-height: 1.7; color: #333; white-space: pre-wrap; }
        .cta-button-preview { padding: 15px 30px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 1.1em; }
        .adjustment-options { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .adjust-btn { padding: 8px 15px; background: white; border: 1px solid #e0e0e0; border-radius: 20px; font-size: 0.85em; cursor: pointer; transition: all 0.3s; }
        .adjust-btn:hover { border-color: #667eea; background: rgba(102,126,234,0.1); }
        .generation-loader { text-align: center; padding: 50px; }
        .loader-animation { width: 80px; height: 80px; margin: 0 auto 20px; border: 4px solid #e0e0e0; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .newsletter-toast { position: fixed; bottom: 55px; left: 50%; transform: translateX(-50%); padding: 15px 25px; background: #333; color: white; border-radius: 10px; font-weight: 600; z-index: 10000; animation: toastIn 0.3s; }
        .newsletter-toast.success { background: #10b981; }
        .newsletter-toast.error { background: #ef4444; }
        .newsletter-toast.fade-out { animation: toastOut 0.3s forwards; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        @keyframes toastOut { to { opacity: 0; transform: translateX(-50%) translateY(20px); } }

        /* Newsletter Module - Responsive */
        @media (max-width: 600px) {
            .newsletter-container { padding: 15px; }
            .newsletter-main-title { font-size: 1.2em; }
            .step-content { padding: 18px; }
            .step-title { font-size: 1.1em; }
            .progress-steps { gap: 5px; }
            .progress-step .step-label { font-size: 0.65em; }
            .type-grid, .structure-grid { grid-template-columns: 1fr; }
            .type-card, .structure-card { padding: 15px; }
            .tone-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .tone-card { padding: 12px; }
            .newsletter-nav { flex-direction: column; gap: 10px; }
            .newsletter-nav .btn-primary,
            .newsletter-nav .btn-secondary { width: 100%; text-align: center; }
            .newsletter-toast { left: 15px; right: 15px; transform: none; }
        }

        .newsletter-loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .copy-btn { padding: 5px 10px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8em; }
        .copy-btn:hover { background: #2563eb; }

        /* Flèche du tour - side indique où est la TOOLTIP, la flèche pointe vers l'élément */
        .tour-arrow { position: fixed; z-index: 2001; width: 0; height: 0; }
        /* Tooltip à droite = flèche pointe vers la gauche (vers l'élément) */
        .tour-arrow.arrow-right { border-top: 15px solid transparent; border-bottom: 15px solid transparent; border-right: 20px solid #ffd700; animation: arrowBounceRight 1s infinite; }
        /* Tooltip à gauche = flèche pointe vers la droite (vers l'élément) */
        .tour-arrow.arrow-left { border-top: 15px solid transparent; border-bottom: 15px solid transparent; border-left: 20px solid #ffd700; animation: arrowBounceLeft 1s infinite; }
        /* Tooltip en bas = flèche pointe vers le haut (vers l'élément) */
        .tour-arrow.arrow-bottom { border-left: 15px solid transparent; border-right: 15px solid transparent; border-bottom: 20px solid #ffd700; animation: arrowBounceDown 1s infinite; }
        @keyframes arrowBounceLeft { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(-10px); } }
        @keyframes arrowBounceRight { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(10px); } }
        @keyframes arrowBounceDown { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }

        .demo-badge { position: fixed; bottom: 100px; left: 30px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 20px; border-radius: 30px; font-weight: 600; cursor: pointer; box-shadow: 0 5px 20px rgba(102,126,234,0.4); z-index: 100; display: none; align-items: center; gap: 8px; }
        .demo-badge:hover { transform: scale(1.05); box-shadow: 0 5px 30px rgba(102,126,234,0.6); }

        /* Welcome Popup - Démo guidée */
        .welcome-popup-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1001; padding: 20px; animation: fadeIn 0.3s ease; }
        .welcome-popup-overlay.show { display: flex; }
        .welcome-popup { background: white; border-radius: 20px; padding: 30px; max-width: 450px; width: 100%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: popIn 0.4s ease; position: relative; }
        .welcome-popup-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5em; color: #999; cursor: pointer; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .welcome-popup-close:hover { background: #f0f0f0; color: #333; }
        .welcome-popup-emoji { font-size: 3.5em; margin-bottom: 15px; }
        .welcome-popup-title { font-size: 1.6em; font-weight: 700; color: #333; margin-bottom: 10px; }
        .welcome-popup-text { color: #666; font-size: 1em; line-height: 1.6; margin-bottom: 20px; }
        .welcome-popup-features { display: flex; flex-direction: column; gap: 12px; margin-bottom: 25px; text-align: left; }
        .welcome-popup-feature { display: flex; align-items: center; gap: 12px; padding: 12px 15px; background: #f8f9ff; border-radius: 12px; }
        .welcome-popup-feature-icon { font-size: 1.5em; }
        .welcome-popup-feature-text { color: #444; font-size: 0.95em; }
        .welcome-popup-btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 16px 35px; border-radius: 12px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s; font-family: inherit; width: 100%; }
        .welcome-popup-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102,126,234,0.4); }
        .welcome-popup-skip { background: none; border: none; color: #999; font-size: 0.9em; cursor: pointer; margin-top: 15px; padding: 10px; font-family: inherit; }
        .welcome-popup-skip:hover { color: #666; text-decoration: underline; }
        .welcome-popup-checkbox { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .welcome-popup-checkbox input { width: 18px; height: 18px; cursor: pointer; accent-color: #667eea; }
        .welcome-popup-checkbox label { color: #888; font-size: 0.85em; cursor: pointer; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Memory indicator */
        .memory-indicator { background: rgba(102,126,234,0.1); border-radius: 10px; padding: 10px 15px; margin-bottom: 15px; font-size: 0.85em; color: #667eea; display: flex; align-items: center; gap: 8px; }
        .memory-indicator strong { font-weight: 600; }

        /* Profile reminder */
        .profile-reminder { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 1px solid #f59e0b; border-radius: 12px; padding: 12px 16px; margin-bottom: 15px; font-size: 0.85em; color: #92400e; display: flex; align-items: center; gap: 10px; animation: reminderPulse 2s ease-in-out infinite; cursor: pointer; transition: transform 0.2s; }
        .profile-reminder:hover { transform: scale(1.02); }
        .profile-reminder-icon { font-size: 1.3em; animation: bounce 1s ease-in-out infinite; }
        .profile-reminder-text { flex: 1; line-height: 1.4; }
        .profile-reminder-text strong { color: #78350f; }
        .profile-reminder-close { background: none; border: none; color: #b45309; font-size: 1.2em; cursor: pointer; padding: 0 5px; opacity: 0.7; }
        .profile-reminder-close:hover { opacity: 1; }
        @keyframes reminderPulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); } 50% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        /* Mini Stats Banner */
        .mini-stats-banner {
            background: linear-gradient(135deg, rgba(102,126,234,0.08), rgba(118,75,162,0.08));
            border: 1px solid rgba(102,126,234,0.15);
            border-radius: 12px;
            padding: 10px 16px;
            margin-bottom: 15px;
            font-size: 0.85em;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .mini-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .mini-stat strong {
            color: #667eea;
            font-weight: 700;
        }
        .mini-stat-divider {
            color: #ccc;
            margin: 0 4px;
        }
        .resume-last-btn {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 8px;
            font-family: inherit;
        }
        .resume-last-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(17,153,142,0.3);
        }
        @media (max-width: 600px) {
            .mini-stats-banner { flex-direction: column; gap: 6px; }
            .mini-stat-divider { display: none; }
            .resume-last-btn { margin-left: 0; margin-top: 8px; }
        }

        /* Export Button */
        .action-btn.export { background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white; }
        .action-btn.export:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }

        /* Format PUB special style */
        .format-chip.pub { background: #fff0f3; color: #f5576c; border-color: #f5576c; font-weight: 700; }
        .format-chip.pub:hover { transform: scale(1.05); background: #ffe0e6; box-shadow: 0 5px 15px rgba(245,87,108,0.2); }
        .format-chip.pub.active { background: linear-gradient(135deg, #f5576c, #f093fb); color: white; border-color: transparent; box-shadow: 0 5px 20px rgba(245,87,108,0.4); }

        /* PUB Options Section */
        .pub-options { background: linear-gradient(135deg, #fff5f7, #fef0f5); border-radius: 15px; padding: 20px; border: 2px solid #fcd5df; animation: slideDown 0.3s ease; }
        
        .pub-platform-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .pub-platform-chip { display: flex; flex-direction: column; align-items: center; padding: 15px 12px; background: white; border: 2px solid #e8e8e8; border-radius: 12px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .pub-platform-chip:hover { border-color: #f5576c; background: #fff8f9; transform: translateY(-2px); }
        .pub-platform-chip.active { border-color: #f5576c; background: linear-gradient(135deg, #fff0f3, #ffeef5); box-shadow: 0 5px 15px rgba(245,87,108,0.15); }
        .pub-platform-chip .pub-icon { font-size: 1.8em; margin-bottom: 8px; }
        .pub-platform-chip .pub-name { font-weight: 700; color: #333; font-size: 0.95em; }
        .pub-platform-chip .pub-desc { font-size: 0.75em; color: #888; margin-top: 3px; }

        .pub-objective-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .pub-objective-chip { padding: 10px 18px; background: white; border: 2px solid #e8e8e8; border-radius: 25px; cursor: pointer; transition: all 0.3s; font-weight: 500; font-size: 0.9em; }
        .pub-objective-chip:hover { border-color: #f5576c; background: #fff8f9; }
        .pub-objective-chip.active { border-color: #f5576c; background: linear-gradient(135deg, #f5576c, #f093fb); color: white; }

        .pub-info-banner { margin-top: 20px; padding: 12px 15px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 10px; border-left: 4px solid #4caf50; font-size: 0.88em; color: #2e7d32; display: flex; align-items: center; gap: 10px; }
        .pub-info-banner strong { color: #1b5e20; }

        @media (max-width: 600px) {
            .header { padding: 12px 15px; position: relative; }
            .intro-title { font-size: 1.8em; }
            .structure-grid { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
            .quick-actions { flex-direction: column; }
        }

        /* ===== ONBOARDING STYLES ===== */
        .onboarding-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex; align-items: center; justify-content: center;
            z-index: 10000; animation: fadeIn 0.3s ease; padding: 20px; overflow-y: auto;
        }
        .onboarding-overlay.closing { animation: fadeOut 0.3s ease forwards; }
        .onboarding-modal {
            background: white; border-radius: 20px; width: 100%; max-width: 700px;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .onboarding-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; text-align: center; position: relative; border-radius: 20px 20px 0 0;
        }
        .onboarding-header h2 { font-size: 1.8em; margin-bottom: 10px; }
        .onboarding-header p { opacity: 0.9; font-size: 1.1em; }
        .onboarding-close {
            position: absolute; top: 15px; right: 15px; background: rgba(255, 255, 255, 0.2);
            border: none; color: white; font-size: 1.5em; width: 40px; height: 40px;
            border-radius: 50%; cursor: pointer; transition: background 0.3s;
        }
        .onboarding-close:hover { background: rgba(255, 255, 255, 0.3); }
        .onboarding-form { padding: 30px; }
        .onboarding-section { margin-bottom: 30px; padding-bottom: 25px; border-bottom: 1px solid #eee; }
        .onboarding-section:last-of-type { border-bottom: none; margin-bottom: 20px; }
        .onboarding-section h3 { color: #667eea; font-size: 1.3em; margin-bottom: 15px; }
        .section-hint { color: #888; font-size: 0.95em; margin-bottom: 15px; }
        .onboarding-form .form-group { margin-bottom: 20px; }
        .onboarding-form .form-group label { display: block; font-weight: 600; color: #333; margin-bottom: 8px; }
        .onboarding-form .form-group input[type="text"],
        .onboarding-form .form-group textarea {
            width: 100%; padding: 14px 18px; border: 2px solid #e0e0e0; border-radius: 12px;
            font-size: 1em; font-family: inherit; transition: border-color 0.3s, box-shadow 0.3s; box-sizing: border-box;
        }
        .onboarding-form .form-group input[type="text"]:focus,
        .onboarding-form .form-group textarea:focus {
            outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        }
        .onboarding-form .form-group small { display: block; color: #888; font-size: 0.85em; margin-top: 6px; }
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .checkbox-grid-compact { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; }
        .checkbox-card { cursor: pointer; }
        .checkbox-card input { display: none; }
        .checkbox-content {
            display: flex; align-items: center; gap: 10px; padding: 12px 16px;
            background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; transition: all 0.2s;
        }
        .checkbox-grid-compact .checkbox-content { padding: 10px 12px; gap: 8px; }
        .checkbox-grid-compact .checkbox-icon { font-size: 1.1em; }
        .checkbox-grid-compact .checkbox-label { font-size: 0.9em; }
        .checkbox-card input:checked + .checkbox-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea; color: white;
        }
        .checkbox-icon { font-size: 1.3em; }
        .checkbox-label { font-weight: 500; }
        .checkbox-content:hover { border-color: #667eea; transform: translateY(-2px); }
        .radio-cards { display: flex; flex-direction: column; gap: 12px; }
        .radio-cards-2col { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .radio-cards-3col { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        @media (max-width: 700px) { .radio-cards-3col { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .radio-cards-2col { grid-template-columns: 1fr; } }
        .radio-card { cursor: pointer; }
        .radio-card input { display: none; }
        .radio-content {
            display: flex; align-items: center; gap: 12px; padding: 16px;
            background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; transition: all 0.2s;
        }
        .radio-card-compact .radio-content { padding: 10px 14px; gap: 8px; }
        .radio-card-compact .radio-label { font-size: 0.9em; }
        .radio-card input:checked + .radio-content {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-color: #667eea;
        }
        .radio-card input:checked + .radio-content .radio-icon { transform: scale(1.2); }
        .radio-content:hover { border-color: #667eea; transform: translateY(-2px); }
        .radio-icon { font-size: 1.8em; transition: transform 0.2s; }
        .radio-label { font-weight: 600; color: #333; display: block; }
        .radio-desc { font-size: 0.85em; color: #666; display: block; margin-top: 2px; }
        .onboarding-actions { display: flex; gap: 15px; justify-content: center; padding-top: 20px; }
        .onboarding-actions .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 16px 40px; font-size: 1.1em; font-weight: 600;
            border-radius: 12px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; font-family: inherit;
        }
        .onboarding-actions .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        .onboarding-notif {
            position: fixed; bottom: 30px; right: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 16px 24px; border-radius: 12px;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4); z-index: 10001;
            font-weight: 600; font-size: 1.05em; transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .onboarding-notif.active { transform: translateX(0); }
        .required { color: #e74c3c; font-weight: bold; }
        @media (max-width: 500px) {
            .onboarding-modal { border-radius: 15px; }
            .onboarding-header { padding: 25px 20px; border-radius: 15px 15px 0 0; }
            .onboarding-header h2 { font-size: 1.4em; }
            .onboarding-form { padding: 20px; }
            .checkbox-grid { grid-template-columns: repeat(2, 1fr); }
            .onboarding-actions { flex-direction: column; }
            .onboarding-actions .btn-primary { width: 100%; }
            .onboarding-notif { left: 15px; right: 15px; bottom: 15px; text-align: center; }
        }

        /* ==================== OBJECTIVE CARDS (Vendre vs Expertise) ==================== */
        .objective-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        @media (max-width: 600px) {
            .objective-cards { grid-template-columns: 1fr; }
        }
        .objective-card {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 16px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .objective-card:hover {
            border-color: #667eea;
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.15);
        }
        .objective-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff, #f0f4ff);
        }
        .objective-card.selected.vendre {
            border-color: #f5576c;
            background: linear-gradient(135deg, #fff5f7, #fff0f3);
        }
        .objective-card.selected.expertise {
            border-color: #11998e;
            background: linear-gradient(135deg, #f0fff4, #e6fffa);
        }
        .objective-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        .objective-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }
        .objective-desc {
            color: #666;
            font-size: 0.95em;
            margin-bottom: 15px;
        }
        .objective-examples {
            text-align: left;
            padding-left: 20px;
            margin: 0;
        }
        .objective-examples li {
            color: #888;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        /* Framework badge for Strategy Days */
        .framework-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        /* Structure block for Strategy Days */
        .structure-block {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #11998e;
        }
        .structure-block h5 {
            margin: 0 0 10px 0;
            color: #11998e;
        }
        .structure-block pre {
            margin: 0;
            white-space: pre-wrap;
            font-family: inherit;
            font-size: 0.85em;
            color: #555;
            line-height: 1.6;
        }

        /* ==================== MES AUDIENCES (PERSONAS) ==================== */
        .personas-section { margin-top: 20px; }
        .personas-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .personas-header h3 { margin: 0; color: #667eea; font-size: 1.3em; }
        .btn-add-persona {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; border: none; padding: 8px 16px;
            border-radius: 20px; cursor: pointer; font-size: 0.85em;
            font-weight: 600; display: flex; align-items: center; gap: 6px;
            transition: all 0.2s;
        }
        .btn-add-persona:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }

        .personas-list { display: flex; flex-direction: column; gap: 12px; max-height: 300px; overflow-y: auto; }
        .persona-card {
            background: white; border: 2px solid #e8e8e8; border-radius: 12px;
            padding: 15px; transition: all 0.2s; position: relative;
        }
        .persona-card:hover { border-color: #667eea; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1); }
        .persona-card.is-default { border-color: #667eea; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05)); }
        .persona-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .persona-card-title { display: flex; align-items: center; gap: 8px; }
        .persona-card-emoji { font-size: 1.5em; }
        .persona-card-name { font-weight: 700; color: #333; font-size: 1.05em; }
        .persona-default-badge { background: #667eea; color: white; font-size: 0.65em; padding: 3px 8px; border-radius: 10px; font-weight: 600; }
        .persona-card-desc { font-size: 0.85em; color: #666; line-height: 1.4; margin-bottom: 10px; }
        .persona-card-meta { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
        .persona-meta-tag { background: #f0f0f0; color: #555; padding: 3px 8px; border-radius: 12px; font-size: 0.75em; }
        .persona-card-actions { display: flex; gap: 8px; padding-top: 10px; border-top: 1px dashed #e0e0e0; }
        .persona-action-btn {
            background: #f5f5f5; border: none; padding: 6px 12px;
            border-radius: 6px; cursor: pointer; font-size: 0.8em;
            color: #555; transition: all 0.2s; display: flex; align-items: center; gap: 4px;
        }
        .persona-action-btn:hover { background: #e8e8e8; color: #333; }
        .persona-action-btn.delete:hover { background: #fee; color: #e74c3c; }

        .personas-empty {
            text-align: center; padding: 30px 20px;
            background: #f8f9ff; border-radius: 12px; border: 2px dashed #e0e0e0;
        }
        .personas-empty-icon { font-size: 3em; margin-bottom: 10px; opacity: 0.5; }
        .personas-empty-text { color: #888; font-size: 0.95em; margin-bottom: 15px; }

        /* Persona Editor Modal */
        .persona-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 10002;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.3s;
        }
        .persona-modal-overlay.active { opacity: 1; visibility: visible; }
        .persona-modal {
            background: white; border-radius: 20px; width: 90%; max-width: 600px;
            max-height: 85vh; overflow: hidden; transform: scale(0.9);
            transition: transform 0.3s;
        }
        .persona-modal-overlay.active .persona-modal { transform: scale(1); }
        .persona-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px 25px; position: relative;
        }
        .persona-modal-header h3 { margin: 0; font-size: 1.3em; }
        .persona-modal-close {
            position: absolute; top: 15px; right: 15px;
            background: rgba(255,255,255,0.2); border: none;
            color: white; width: 30px; height: 30px; border-radius: 50%;
            cursor: pointer; font-size: 1.2em; transition: all 0.2s;
        }
        .persona-modal-close:hover { background: rgba(255,255,255,0.3); }
        .persona-modal-body { padding: 25px; max-height: calc(85vh - 150px); overflow-y: auto; }
        .persona-form-group { margin-bottom: 20px; }
        .persona-form-group label { display: block; font-weight: 600; color: #333; margin-bottom: 8px; font-size: 0.95em; }
        .persona-form-group input[type="text"],
        .persona-form-group textarea,
        .persona-form-group select {
            width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0;
            border-radius: 10px; font-size: 0.95em; font-family: inherit;
            transition: border-color 0.2s;
        }
        .persona-form-group input:focus,
        .persona-form-group textarea:focus,
        .persona-form-group select:focus { border-color: #667eea; outline: none; }
        .persona-form-group textarea { min-height: 80px; resize: vertical; }
        .persona-form-group small { display: block; color: #888; font-size: 0.8em; margin-top: 5px; }
        .persona-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .emoji-picker-inline { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .emoji-option {
            width: 40px; height: 40px; border: 2px solid #e0e0e0;
            border-radius: 10px; cursor: pointer; font-size: 1.3em;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; background: white;
        }
        .emoji-option:hover { border-color: #667eea; transform: scale(1.1); }
        .emoji-option.selected { border-color: #667eea; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); }
        .persona-modal-footer {
            padding: 15px 25px; background: #f8f9ff;
            display: flex; justify-content: flex-end; gap: 10px;
        }
        .persona-modal-footer button {
            padding: 10px 20px; border: none; border-radius: 10px;
            cursor: pointer; font-weight: 600; font-family: inherit; transition: all 0.2s;
        }
        .btn-persona-cancel { background: #e0e0e0; color: #666; }
        .btn-persona-cancel:hover { background: #d0d0d0; }
        .btn-persona-save { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-persona-save:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }

        @media (max-width: 500px) {
            .persona-form-row { grid-template-columns: 1fr; }
            .persona-modal { width: 95%; max-height: 90vh; }
        }

        /* ==================== SELECTEUR AUDIENCE (WIZARD) ==================== */
        .audience-selector-wrapper { position: relative; }
        .audience-dropdown {
            width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0;
            border-radius: 10px; font-size: 0.95em; font-family: inherit;
            background: white; cursor: pointer; display: flex;
            justify-content: space-between; align-items: center; transition: all 0.2s;
        }
        .audience-dropdown:hover { border-color: #667eea; }
        .audience-dropdown.open { border-color: #667eea; border-radius: 10px 10px 0 0; }
        .audience-dropdown-label { display: flex; align-items: center; gap: 8px; }
        .audience-dropdown-emoji { font-size: 1.2em; }
        .audience-dropdown-name { font-weight: 600; color: #333; }
        .audience-dropdown-arrow { transition: transform 0.2s; color: #888; }
        .audience-dropdown.open .audience-dropdown-arrow { transform: rotate(180deg); }

        .audience-dropdown-menu {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 2px solid #667eea; border-top: none;
            border-radius: 0 0 10px 10px; z-index: 100; max-height: 300px;
            overflow-y: auto; display: none;
        }
        .audience-dropdown-menu.show { display: block; }
        .audience-option {
            padding: 12px 15px; cursor: pointer; display: flex;
            align-items: center; gap: 10px; transition: all 0.2s;
        }
        .audience-option:hover { background: linear-gradient(135deg, #f8f9ff, #f0f4ff); }
        .audience-option.selected { background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); }
        .audience-option-emoji { font-size: 1.2em; }
        .audience-option-info { flex: 1; }
        .audience-option-name { font-weight: 600; color: #333; display: flex; align-items: center; gap: 6px; }
        .audience-option-desc { font-size: 0.8em; color: #888; margin-top: 2px; }
        .audience-option-default { background: #667eea; color: white; font-size: 0.65em; padding: 2px 6px; border-radius: 8px; }
        .audience-option-generic { opacity: 0.7; }
        .audience-divider { border-top: 1px dashed #e0e0e0; margin: 5px 0; }
        .audience-option-create {
            color: #667eea; font-weight: 600; border-top: 1px solid #e0e0e0;
            margin-top: 5px; padding-top: 12px;
        }
        .audience-option-create:hover { background: linear-gradient(135deg, #f8f9ff, #f0f4ff); }

        .audience-preview {
            background: linear-gradient(135deg, #f8f9ff, #f0f4ff);
            border-radius: 10px; padding: 12px 15px; margin-top: 10px;
            font-size: 0.85em; display: none;
        }
        .audience-preview.show { display: block; }
        .audience-preview-title { font-weight: 600; color: #667eea; margin-bottom: 5px; }
        .audience-preview-desc { color: #555; line-height: 1.4; }
        .audience-preview-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .audience-preview-tag { background: white; color: #666; padding: 3px 8px; border-radius: 10px; font-size: 0.85em; }

        /* ==================== MES FRAMEWORKS ==================== */
        .btn-frameworks { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }

        /* Framework Library Modal */
        .framework-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 15px; }
        .framework-tab { padding: 10px 20px; border: none; background: #f0f0f0; border-radius: 8px; cursor: pointer; font-family: inherit; font-weight: 600; color: #666; transition: all 0.2s; }
        .framework-tab:hover { background: #e0e0e0; }
        .framework-tab.active { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }

        .frameworks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; max-height: 450px; overflow-y: auto; padding: 5px; }
        .framework-card { background: white; border: 2px solid #e8e8e8; border-radius: 15px; padding: 20px; cursor: pointer; transition: all 0.2s; position: relative; }
        .framework-card:hover { border-color: #11998e; transform: translateY(-3px); box-shadow: 0 8px 25px rgba(17,153,142,0.15); }
        .framework-card.selected { border-color: #11998e; background: linear-gradient(135deg, rgba(17,153,142,0.05), rgba(56,239,125,0.05)); }
        .framework-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .framework-card-icon { font-size: 2em; }
        .framework-card-type { font-size: 0.7em; padding: 4px 10px; border-radius: 20px; font-weight: 600; text-transform: uppercase; }
        .framework-card-title { font-size: 1.1em; font-weight: 700; color: #333; margin-bottom: 5px; }
        .framework-card-desc { font-size: 0.85em; color: #666; line-height: 1.4; margin-bottom: 12px; }
        .framework-card-steps { display: flex; flex-wrap: wrap; gap: 5px; }
        .framework-step-badge { background: #f0f0f0; color: #555; padding: 3px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 500; }
        .framework-card-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #e0e0e0; font-size: 0.8em; color: #888; }
        .framework-card-actions { display: flex; gap: 5px; }
        .framework-card-actions button { background: none; border: none; padding: 5px 8px; cursor: pointer; border-radius: 5px; transition: all 0.2s; font-size: 1em; }
        .framework-card-actions button:hover { background: #e0e0e0; }
        .framework-default-badge { position: absolute; top: 10px; right: 10px; background: #667eea; color: white; font-size: 0.65em; padding: 3px 8px; border-radius: 10px; font-weight: 600; }

        /* Framework Editor Modal */
        .framework-editor { padding: 10px 0; }
        .framework-editor-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .framework-editor-row.full { grid-template-columns: 1fr; }
        .framework-type-select { display: flex; flex-wrap: wrap; gap: 8px; }
        .framework-type-chip { padding: 8px 16px; border: 2px solid #e0e0e0; border-radius: 20px; cursor: pointer; font-size: 0.85em; transition: all 0.2s; background: white; }
        .framework-type-chip:hover { border-color: #11998e; }
        .framework-type-chip.active { background: linear-gradient(135deg, #11998e, #38ef7d); border-color: transparent; color: white; }

        /* Steps Editor */
        .steps-editor { margin-top: 20px; }
        .steps-list { margin-bottom: 15px; }
        .step-item { background: #f8f9fa; border: 2px solid #e8e8e8; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; gap: 15px; align-items: flex-start; cursor: grab; transition: all 0.2s; }
        .step-item:hover { border-color: #11998e; }
        .step-item.dragging { opacity: 0.5; border-style: dashed; }
        .step-item-drag { color: #999; font-size: 1.2em; cursor: grab; padding: 5px; }
        .step-item-number { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9em; flex-shrink: 0; }
        .step-item-content { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .step-item-name { border: none; background: white; padding: 10px; border-radius: 8px; font-family: inherit; font-weight: 600; font-size: 0.95em; width: 100%; }
        .step-item-name:focus { outline: 2px solid #11998e; }
        .step-item-desc { border: none; background: white; padding: 10px; border-radius: 8px; font-family: inherit; font-size: 0.85em; width: 100%; resize: none; min-height: 50px; }
        .step-item-desc:focus { outline: 2px solid #11998e; }
        .step-item-delete { background: none; border: none; color: #ff6b6b; cursor: pointer; padding: 8px; border-radius: 5px; font-size: 1.1em; transition: all 0.2s; }
        .step-item-delete:hover { background: #fff0f0; }
        .btn-add-step { width: 100%; padding: 15px; border: 2px dashed #d0d0d0; background: transparent; border-radius: 12px; cursor: pointer; font-family: inherit; font-weight: 600; color: #666; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-add-step:hover { border-color: #11998e; color: #11998e; background: rgba(17,153,142,0.05); }

        /* Framework color picker */
        .color-picker-row { display: flex; align-items: center; gap: 10px; }
        .color-picker-row input[type="color"] { width: 50px; height: 40px; border: none; border-radius: 8px; cursor: pointer; }
        .icon-picker { display: flex; flex-wrap: wrap; gap: 5px; }
        .icon-option { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; font-size: 1.3em; transition: all 0.2s; }
        .icon-option:hover { border-color: #11998e; }
        .icon-option.active { border-color: #11998e; background: rgba(17,153,142,0.1); }

        /* Framework Selection in Generation */
        .framework-selector { margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #11998e, #38ef7d); border: none; border-radius: 15px; }
        .framework-selector-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .framework-selector-label { font-weight: 600; color: white; display: flex; align-items: center; gap: 8px; }
        .btn-manage-frameworks { background: none; border: none; color: white; font-size: 0.85em; cursor: pointer; font-weight: 600; }
        .btn-manage-frameworks:hover { text-decoration: underline; }
        .framework-quick-select { display: flex; flex-wrap: wrap; gap: 8px; }
        .framework-quick-chip { padding: 8px 14px; border: 2px solid #e0e0e0; background: white; border-radius: 10px; cursor: pointer; font-size: 0.85em; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .framework-quick-chip:hover { border-color: #11998e; }
        .framework-quick-chip.active { background: linear-gradient(135deg, #11998e, #38ef7d); border-color: transparent; color: white; }
        .framework-quick-chip.none { background: #f5f5f5; border-style: dashed; }
        .framework-quick-chip.none.active { background: #e0e0e0; border-style: solid; color: #333; }

        /* Framework Output Display */
        .framework-output { border-left: 4px solid #11998e; margin: 15px 0; }
        .framework-output-step { padding: 15px 20px; border-bottom: 1px solid #e8e8e8; }
        .framework-output-step:last-child { border-bottom: none; }
        .framework-output-step-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .framework-output-step-number { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.8em; font-weight: 700; }
        .framework-output-step-name { font-weight: 700; color: #11998e; font-size: 1em; }
        .framework-output-step-content { color: #333; line-height: 1.6; padding-left: 5px; }

        /* Templates Section */
        .templates-section { margin-top: 20px; padding-top: 20px; border-top: 2px dashed #e0e0e0; }
        .templates-section h4 { margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 10px; }
        .template-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .template-card { background: linear-gradient(135deg, #f8f9fa, #fff); border: 2px solid #e8e8e8; border-radius: 12px; padding: 15px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .template-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .template-card-icon { font-size: 2em; margin-bottom: 8px; }
        .template-card-name { font-weight: 600; font-size: 0.9em; color: #333; }
        .template-card-steps { font-size: 0.75em; color: #888; margin-top: 5px; }

        /* Empty State */
        .frameworks-empty { text-align: center; padding: 50px 20px; color: #888; }
        .frameworks-empty-icon { font-size: 4em; margin-bottom: 15px; opacity: 0.5; }
        .frameworks-empty h3 { color: #555; margin-bottom: 10px; }
        .frameworks-empty p { font-size: 0.95em; margin-bottom: 20px; }

        /* Template Library Enhanced */
        .template-library-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .template-library-actions { display: flex; gap: 8px; }
        .btn-import-fw { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 15px; border: none; border-radius: 8px; font-family: inherit; font-weight: 600; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .btn-import-fw:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.3); }
        .category-filters { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .category-chip { padding: 8px 16px; border: 2px solid #e0e0e0; background: white; border-radius: 20px; cursor: pointer; font-size: 0.85em; font-weight: 500; transition: all 0.2s; }
        .category-chip:hover { border-color: #667eea; }
        .category-chip.active { background: linear-gradient(135deg, #667eea, #764ba2); border-color: transparent; color: white; }
        .template-count { font-size: 0.75em; opacity: 0.8; margin-left: 5px; }
        .template-library-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .template-lib-card { background: white; border: 2px solid #e8e8e8; border-radius: 15px; padding: 18px; cursor: pointer; transition: all 0.2s; position: relative; }
        .template-lib-card:hover { border-color: #667eea; transform: translateY(-3px); box-shadow: 0 8px 25px rgba(102,126,234,0.15); }
        .template-lib-card.popular::before { content: '⭐ Populaire'; position: absolute; top: -8px; right: 15px; background: linear-gradient(135deg, #ffd700, #ffb347); color: #333; font-size: 0.7em; padding: 3px 10px; border-radius: 10px; font-weight: 700; }
        .template-lib-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .template-lib-icon { font-size: 1.8em; }
        .template-lib-category { font-size: 0.7em; padding: 4px 10px; border-radius: 15px; font-weight: 600; background: #f0f0f0; color: #666; }
        .template-lib-title { font-size: 1.05em; font-weight: 700; color: #333; margin-bottom: 5px; }
        .template-lib-desc { font-size: 0.85em; color: #666; line-height: 1.4; margin-bottom: 12px; }
        .template-lib-steps { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 12px; }
        .template-lib-step { background: #f8f8f8; color: #555; padding: 3px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 500; }
        .template-lib-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px dashed #e0e0e0; }
        .template-lib-meta { font-size: 0.8em; color: #888; }
        .template-lib-actions { display: flex; gap: 5px; }
        .template-lib-actions button { background: none; border: none; padding: 5px 8px; cursor: pointer; border-radius: 5px; transition: all 0.2s; font-size: 1em; }
        .template-lib-actions button:hover { background: #e0e0e0; }
        .btn-preview-template { background: #f0f0f0 !important; }
        .btn-use-template { background: linear-gradient(135deg, #11998e, #38ef7d) !important; color: white !important; font-size: 0.8em !important; padding: 6px 12px !important; border-radius: 8px !important; font-weight: 600 !important; }

        /* Preview Modal */
        .preview-modal { max-width: 650px; max-height: 90vh; overflow-y: auto; }
        .preview-header { padding: 25px 30px; border-radius: 20px 20px 0 0; color: white; }
        .preview-header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .preview-icon { font-size: 2.5em; }
        .preview-type { font-size: 0.8em; padding: 5px 12px; border-radius: 15px; background: rgba(255,255,255,0.2); }
        .preview-title { font-size: 1.5em; font-weight: 700; margin-bottom: 5px; }
        .preview-desc { opacity: 0.9; font-size: 0.95em; }
        .preview-content { padding: 25px 30px; }
        .preview-section { margin-bottom: 25px; }
        .preview-section h4 { color: #333; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-size: 1em; }
        .preview-steps-list { display: flex; flex-direction: column; gap: 10px; }
        .preview-step { display: flex; gap: 12px; padding: 12px 15px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #667eea; }
        .preview-step-number { background: linear-gradient(135deg, #667eea, #764ba2); color: white; min-width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85em; }
        .preview-step-content { flex: 1; }
        .preview-step-name { font-weight: 700; color: #333; margin-bottom: 3px; }
        .preview-step-desc { font-size: 0.85em; color: #666; line-height: 1.4; }
        .preview-instructions { background: linear-gradient(135deg, #fff9e6, #fff3cd); padding: 15px; border-radius: 10px; border-left: 4px solid #ffc107; }
        .preview-instructions p { margin: 0; color: #856404; font-size: 0.9em; line-height: 1.5; }
        .preview-actions { display: flex; gap: 10px; padding-top: 20px; border-top: 2px solid #e0e0e0; }
        .preview-actions .btn { flex: 1; padding: 14px; font-size: 1em; justify-content: center; }

        /* Import Modal */
        .import-modal { max-width: 550px; }
        .import-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .import-tab { flex: 1; padding: 12px; border: 2px solid #e0e0e0; background: white; border-radius: 10px; cursor: pointer; font-family: inherit; font-weight: 600; text-align: center; transition: all 0.2s; }
        .import-tab:hover { border-color: #667eea; }
        .import-tab.active { background: linear-gradient(135deg, #667eea, #764ba2); border-color: transparent; color: white; }
        .import-dropzone-fw { border: 3px dashed #d0d0d0; border-radius: 15px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; }
        .import-dropzone-fw:hover { border-color: #667eea; background: #f8f9ff; }
        .import-dropzone-fw.dragover { border-color: #667eea; background: #f0f4ff; }
        .import-dropzone-fw input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .import-dropzone-icon { font-size: 3em; margin-bottom: 10px; }
        .import-dropzone-text { color: #555; font-weight: 500; margin-bottom: 5px; }
        .import-dropzone-hint { color: #888; font-size: 0.85em; }
        .import-textarea { width: 100%; min-height: 200px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-family: 'Courier New', monospace; font-size: 0.85em; resize: vertical; }
        .import-textarea:focus { outline: none; border-color: #667eea; }
        .import-example { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; }
        .import-example h5 { margin: 0 0 10px; color: #333; font-size: 0.9em; }
        .import-example pre { margin: 0; font-size: 0.75em; color: #666; overflow-x: auto; white-space: pre-wrap; }
        .import-result { margin-top: 15px; padding: 15px; border-radius: 10px; }
        .import-result.success { background: #d4edda; color: #155724; }
        .import-result.error { background: #f8d7da; color: #721c24; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="i18n.js"></script>
    <script>
        // ==================== AUTH GUARD ====================
        // Vérifie que l'utilisateur est connecté et a un abonnement valide
        (async function checkAuth() {
            const supabase = initSupabase();
            // Exposer globalement pour les modules
            window.supabaseApp = supabase;

            // Récupérer la session
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                // Pas connecté → rediriger vers login
                window.location.href = 'login.html';
                return;
            }

            // Vérifier le plan de l'utilisateur
            const userEmail = session.user.email;
            const { data: userData } = await supabase
                .from('users')
                .select('plan, subscription_status, trial_ends_at')
                .eq('email', userEmail.toLowerCase())
                .single();

            // Calculer les jours restants du trial
            let trialDaysLeft = 0;
            let isActive = false;

            if (userData) {
                if (userData.subscription_status === 'active') {
                    isActive = true;
                } else if (userData.subscription_status === 'on_trial' && userData.trial_ends_at) {
                    const trialEnd = new Date(userData.trial_ends_at);
                    const now = new Date();
                    trialDaysLeft = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));
                    isActive = trialDaysLeft > 0;
                }

                // BETA TEST MODE - Désactivé jusqu'au 17/12/2024
                // if (!isActive) {
                //     // Trial ou abonnement expiré → rediriger vers upgrade
                //     window.location.href = 'upgrade.html';
                //     return;
                // }
            }

            // Stocker les infos utilisateur pour l'app
            window.currentUser = {
                id: session.user.id,
                email: session.user.email,
                name: session.user.user_metadata?.full_name || session.user.email.split('@')[0],
                plan: userData?.plan || 'trial',
                subscriptionStatus: userData?.subscription_status || 'on_trial',
                trialDaysLeft: trialDaysLeft
            };

            console.log('✅ Utilisateur connecté:', window.currentUser.email, '| Trial:', trialDaysLeft, 'jours restants');
        })();
    </script>
    <!-- DÉSACTIVÉ - Module newsletter (conservé pour plus tard)
    <link rel="stylesheet" href="newsletter-styles.css">
    -->
</head>
<body>
    <!-- Logo Base64 stocké -->
    <style>.logo-img { width: 40px; height: 40px; border-radius: 8px; object-fit: contain; }</style>
    <header class="header">
        <a href="#" onclick="showHomePage(); return false;" class="header-left" style="text-decoration: none; color: inherit;">
                        <img src="logo-sos-storytelling.png" alt="SOS Storytelling" class="logo-img">
            <span class="header-title">SOS Storytelling</span>
        </a>
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
            <span id="menuIcon">☰</span> Menu
        </button>
        <div class="header-buttons" id="headerButtons">
            <!-- Dropdown Réseaux Sociaux -->
            <div class="header-dropdown">
                <button class="btn btn-primary dropdown-toggle" onclick="toggleDropdown('createDropdown')">
                    ✨ <span data-i18n="menu.create">Créer du contenu</span> <span class="dropdown-arrow">▼</span>
                </button>
                <div class="dropdown-menu" id="createDropdown">
                    <a class="dropdown-item" onclick="closeDropdowns(); showQuickPost()">📝 <span data-i18n="menu.write_post">Écrire un post</span></a>
                    <a class="dropdown-item" onclick="closeDropdowns(); showTrends()">🔥 TRENDS</a>
                </div>
            </div>

            <!-- DÉSACTIVÉ - Dropdown Newsletters (conservé pour plus tard)
            <div class="header-dropdown">
                <button class="btn btn-newsletter dropdown-toggle" onclick="toggleDropdown('newsletterDropdown')">
                    📬 <span data-i18n="menu.newsletters">Newsletters</span> <span class="dropdown-arrow">▼</span>
                </button>
                <div class="dropdown-menu" id="newsletterDropdown">
                    <a class="dropdown-item" onclick="closeDropdowns(); showNewsletterModal()">✉️ <span data-i18n="menu.create_newsletter">Créer une newsletter</span></a>
                    <a class="dropdown-item dropdown-item-muted" onclick="closeDropdowns(); alert('Connexion Brevo/Mailchimp bientôt disponible !')" title="Pour envoyer à vos abonnés existants">🔗 <span data-i18n="menu.connect_brevo">Connecter ma liste</span></a>
                    <a class="dropdown-item" onclick="closeDropdowns(); showNewsletterHistory()">📋 <span>Mes newsletters</span></a>
                </div>
            </div>
            -->

            <!-- DÉSACTIVÉ - Dropdown Prospection Email (conservé pour plus tard)
            <div class="header-dropdown">
                <button class="btn btn-outreach dropdown-toggle" onclick="toggleDropdown('prospectionDropdown')" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                    🎯 <span data-i18n="menu.prospection">Prospection Email</span> <span class="dropdown-arrow">▼</span>
                </button>
                <div class="dropdown-menu" id="prospectionDropdown">
                    <a class="dropdown-item" onclick="closeDropdowns(); showCampaignsModal()">📧 <span data-i18n="menu.create_campaign">Créer une campagne</span></a>
                    <a class="dropdown-item" onclick="closeDropdowns(); showProspectsModal()">👥 <span data-i18n="menu.my_prospects">Mes prospects</span></a>
                    <a class="dropdown-item menu-highlight" onclick="closeDropdowns(); showInboxModal()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border-radius: 8px; margin-top: 4px; position: relative;">
                        📬 Inbox Intelligente
                        <span class="menu-badge" id="menuInboxBadge" style="display: none;">0</span>
                    </a>
                    <a class="dropdown-item" onclick="closeDropdowns(); showBrevoConfigModal()">🔗 <span data-i18n="menu.config_brevo">Configurer Brevo</span></a>
                    <a class="dropdown-item" onclick="closeDropdowns(); showReportsModal()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 8px; margin-top: 4px;">📊 Rapports & Analytics</a>
                </div>
            </div>
            -->

            <!-- Dropdown Dashboard -->
            <div class="header-dropdown">
                <button class="btn btn-stats dropdown-toggle" onclick="toggleDropdown('dashboardDropdown')">
                    📊 <span data-i18n="menu.dashboard">Audits</span> <span class="dropdown-arrow">▼</span>
                </button>
                <div class="dropdown-menu" id="dashboardDropdown">
                    <a class="dropdown-item" onclick="closeDropdowns(); showPlanningModal()">🗓️ <span data-i18n="menu.planning">Planning IA</span></a>
                    <a class="dropdown-item" onclick="closeDropdowns(); openMesPostsPopup()">📌 <span data-i18n="menu.my_posts">Mes posts</span></a>
                    <a class="dropdown-item" onclick="closeDropdowns(); showFavorites()">❤️ <span data-i18n="menu.favorites">Favoris</span></a>
                    <a class="dropdown-item" id="agencyDashboardBtn" onclick="closeDropdowns(); AgencySystem.showDashboard()" style="display: none; background: linear-gradient(135deg, #11998e, #38ef7d); color: white; margin-top: 8px; border-radius: 8px;">🏢 <span data-i18n="menu.agency_dashboard">Dashboard Agence</span></a>
                </div>
            </div>

            <!-- Dropdown Paramètres -->
            <div class="header-dropdown">
                <button class="btn btn-secondary dropdown-toggle" onclick="toggleDropdown('settingsDropdown')">
                    ⚙️ <span data-i18n="menu.settings">Paramètres</span> <span class="dropdown-arrow">▼</span>
                </button>
                <div class="dropdown-menu" id="settingsDropdown">
                    <a class="dropdown-item" onclick="closeDropdowns(); Onboarding.forceShow()">👤 <span data-i18n="menu.my_profile">Mon profil</span></a>
                    <a class="dropdown-item" onclick="closeDropdowns(); showVoiceModal()">🎤 <span data-i18n="menu.my_voice">Mon Style</span></a>
                    <a class="dropdown-item" id="teamManagementBtn" onclick="closeDropdowns(); CollaborationModule.showTeamModal()" style="display: none; background: linear-gradient(135deg, #11998e, #38ef7d); color: white; margin-top: 8px; border-radius: 8px;">👥 <span data-i18n="menu.team">Mon équipe</span></a>
                    <a class="dropdown-item" onclick="closeDropdowns(); showPromoModal()">🎁 <span data-i18n="menu.promo_code">Code promo</span></a>
                    <a class="dropdown-item" href="account.html">💎 <span data-i18n="menu.subscription">Mon abonnement</span></a>
                    <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 8px 0;"></div>
                    <a class="dropdown-item" onclick="closeDropdowns(); handleLogout()" style="color: #ff6b6b;">🚪 <span data-i18n="menu.logout">Déconnexion</span></a>
                </div>
            </div>

            <!-- Workspace Switcher (Plans Agence uniquement) -->
            <div class="workspace-switcher" id="workspaceSwitcher">
                <div class="workspace-current" onclick="CollaborationModule.toggleWorkspaceDropdown()">
                    <span class="workspace-logo">🏢</span>
                    <span class="workspace-name">Chargement...</span>
                    <span class="workspace-arrow">▼</span>
                </div>
                <div class="workspace-dropdown">
                    <div class="workspace-dropdown-list"></div>
                </div>
            </div>

            <!-- Notifications (Plans Agence uniquement) -->
            <div style="position: relative;">
                <button class="notification-btn" id="notificationBtn" onclick="CollaborationModule.toggleNotificationDropdown()">
                    🔔
                    <span class="notification-badge" id="notificationBadge">0</span>
                </button>
                <div class="notification-dropdown" id="notificationDropdown">
                    <div class="notification-header">
                        <h3>🔔 Notifications</h3>
                        <button class="notification-mark-all" onclick="CollaborationModule.markAllNotificationsRead()">Tout lire</button>
                    </div>
                    <div class="notification-list" id="notificationList">
                        <div class="notification-empty">
                            <span class="notification-empty-icon">🔔</span>
                            <span>Aucune notification</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="languageToggleContainer"></div>
        </div>
    </header>

    <!-- Bannière Alerte Abus (affichée si problème détecté) -->
    <div id="abuseAlertBanner" class="abuse-alert-banner" style="display: none;">
        <div class="abuse-alert-content">
            <span class="abuse-alert-icon">⚠️</span>
            <span class="abuse-alert-message" id="abuseAlertMessage"></span>
            <button class="abuse-alert-action" id="abuseAlertAction" onclick="showAbuseDetails()">Voir détails</button>
            <button class="abuse-alert-close" onclick="dismissAbuseAlert()">&times;</button>
        </div>
    </div>

    <style>
        .abuse-alert-banner {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
            padding: 12px 20px;
            position: sticky;
            top: 70px;
            z-index: 99;
            animation: slideDown 0.3s ease;
        }
        .abuse-alert-banner.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        .abuse-alert-banner.critical {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .abuse-alert-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .abuse-alert-icon { font-size: 1.3em; }
        .abuse-alert-message { flex: 1; font-weight: 500; }
        .abuse-alert-action {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.5);
            color: white;
            padding: 6px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .abuse-alert-action:hover { background: rgba(255,255,255,0.3); }
        .abuse-alert-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            opacity: 0.7;
            padding: 0 5px;
        }
        .abuse-alert-close:hover { opacity: 1; }
    </style>

    <!-- Settings Hint Overlay (bloque les clics) -->
    <div class="settings-hint-overlay" id="settingsHintOverlay"></div>

    <!-- Settings Hint Popup -->
    <div class="settings-hint" id="settingsHint">
        <span class="settings-hint-arrow">⬆️</span>
        <button class="settings-hint-close" onclick="closeSettingsHint(false)">&times;</button>
        <div class="settings-hint-content">
            <span style="font-size: 1.5em;">🎨</span>
            <div class="settings-hint-text">
                Configure ton style dans <strong>"Mon Style"</strong> si ce n'est pas déjà fait.
            </div>
        </div>
        <button class="settings-hint-dismiss" onclick="closeSettingsHint(true)">Ne plus montrer</button>
    </div>

    <div class="main-container">
        <!-- Quick Actions Page -->
        <!-- Dashboard 3 MODES -->
        <div class="quick-actions-page" id="quickActionsPage">
            <h1 class="quick-actions-title" data-i18n="home.title">Que veux-tu faire ?</h1>
            <p class="quick-actions-subtitle" data-i18n="home.subtitle">Choisis ton mode</p>

            <!-- 4 Modes principaux -->
            <div class="modes-grid">

                <!-- MODE 1 : CRÉER DU CONTENU -->
                <div class="mode-card mode-creer" onclick="handleModeClick(this, 'creer')">
                    <div class="mode-emoji">✨</div>
                    <div class="mode-main">
                        <div class="mode-title">Créer du contenu</div>
                        <div class="mode-details">
                            <div class="mode-subtitle">Posts & carrousels pour tes réseaux sociaux</div>
                        </div>
                    </div>
                    <div class="mode-arrow">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </div>
                </div>

                <!-- DÉSACTIVÉ - MODE 2 : EMAILS & NEWSLETTERS (conservé pour plus tard)
                <div class="mode-card mode-emails" onclick="handleModeClick(this, 'emails')">
                    <div class="mode-emoji">📧</div>
                    <div class="mode-main">
                        <div class="mode-title">Emails & Newsletters</div>
                        <div class="mode-details">
                            <div class="mode-subtitle">Newsletters + campagnes de prospection mail</div>
                        </div>
                    </div>
                    <div class="mode-arrow">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </div>
                </div>
                -->

                <!-- MODE 2 : AUDIT RS -->
                <div class="mode-card mode-audit" onclick="AuditModule.openAuditModal()">
                    <div class="mode-emoji">📊</div>
                    <div class="mode-main">
                        <div class="mode-title">Audit RS</div>
                        <div class="mode-details">
                            <div class="mode-subtitle">Analyse tes profils et posts pour optimiser ta visibilité</div>
                        </div>
                    </div>
                    <div class="mode-arrow">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </div>
                </div>

            </div>
        </div>

        <!-- Ancienne intro (cachée par défaut) -->
        <div class="intro-section" id="introSection" style="display: none;">
            <h1 class="intro-title">✨ Crée du contenu impactant en quelques clics</h1>
            <p class="intro-subtitle">Choisis ta structure narrative, ton format, et laisse Tithot faire la magie !</p>
            <div id="pillarSuggestion" class="pillar-suggestion" style="display: none;">
                💡 Suggestion du jour : <strong id="suggestedPillar"></strong>
            </div>
        </div>

        <div class="content-layout" id="contentLayout" style="display: none;">
            <div class="panel config-panel" id="configPanel">
                <h2 class="panel-title">⚙️ <span data-i18n="config.title">Configuration</span></h2>

                <!-- Profile Reminder -->
                <div class="profile-reminder" id="profileReminder" style="display: none;">
                    <span class="profile-reminder-icon">💡</span>
                    <span class="profile-reminder-text">Pense à remplir <a href="#" onclick="event.preventDefault(); Onboarding.forceShow();" style="color: #92400e; text-decoration: underline; font-weight: 700;">Mon Profil</a> et <a href="#" onclick="event.preventDefault(); showVoiceModal();" style="color: #92400e; text-decoration: underline; font-weight: 700;">Mon Style</a> pour personnaliser tes contenus !</span>
                    <button class="profile-reminder-close" onclick="event.stopPropagation(); hideProfileReminder();" title="Fermer">✕</button>
                </div>

                <!-- Mini Stats de Progression -->
                <div class="mini-stats-banner" id="miniStatsBanner">
                    <span class="mini-stat" title="Contenus créés">📝 <strong id="statTotalContents">0</strong> contenus</span>
                    <span class="mini-stat-divider">•</span>
                    <span class="mini-stat" title="Structures testées">📖 <strong id="statStructuresUsed">0</strong> structures</span>
                    <span class="mini-stat-divider">•</span>
                    <span class="mini-stat" title="Dernière création" id="statLastAction">🕐 Première création ?</span>
                    <button class="resume-last-btn" id="resumeLastBtn" onclick="resumeLastContent()" style="display: none;" title="Reprendre ton dernier contenu">
                        🔄 Reprendre
                    </button>
                </div>

                <div id="memoryIndicator" class="memory-indicator" style="display: none;">
                    🧠 <span id="memoryText"></span>
                </div>

                <div class="config-section" id="structureSection">
                    <div class="config-toggle-header" onclick="toggleStructureSection()">
                        <div style="display: flex; align-items: center;">
                            <label class="config-label" style="cursor: pointer;">📖 <span data-i18n="config.structure">Structure narrative</span></label>
                            <span class="structure-selected-badge" id="selectedStructureBadge">🎯 AIDA</span>
                        </div>
                        <span class="toggle-arrow" id="structureToggleArrow">▼</span>
                    </div>
                    <div class="structure-grid collapsed" id="structureGrid">
                        <div class="structure-card active" data-structure="aida"><div class="structure-icon">🎯</div><div class="structure-name" data-i18n="structures.aida">AIDA</div></div>
                        <div class="structure-card" data-structure="golden-circle"><div class="structure-icon">🔵</div><div class="structure-name" data-i18n="structures.golden_circle">Golden Circle</div></div>
                        <div class="structure-card" data-structure="hero-journey"><div class="structure-icon">🦸</div><div class="structure-name" data-i18n="structures.hero_journey">Voyage du Héros</div></div>
                        <div class="structure-card" data-structure="avant-apres"><div class="structure-icon">🔄</div><div class="structure-name" data-i18n="structures.before_after">Avant / Après</div></div>
                        <div class="structure-card" data-structure="hook-story-cta"><div class="structure-icon">🪝</div><div class="structure-name" data-i18n="structures.hook_story_cta">Hook + Story + CTA</div></div>
                        <div class="structure-card" data-structure="storybrand"><div class="structure-icon">🎬</div><div class="structure-name" data-i18n="structures.storybrand">StoryBrand</div></div>
                        <div class="structure-card" data-structure="pattern-interrupt"><div class="structure-icon">⚡</div><div class="structure-name" data-i18n="structures.pattern_interrupt">Pattern Interrupt</div></div>
                        <div class="structure-card" data-structure="3-actes"><div class="structure-icon">🎭</div><div class="structure-name" data-i18n="structures.three_acts">3 Actes</div></div>
                    </div>
                </div>

                <!-- TOGGLE FORMAT -->
                <div class="config-section" id="formatSection">
                    <button class="section-toggle" id="formatToggle" onclick="toggleSection('format')">
                        <span class="section-toggle-left">
                            <span class="section-toggle-icon">🎬</span>
                            <span data-i18n="config.format">Format</span>
                        </span>
                        <span class="section-toggle-right">
                            <span class="section-toggle-value" id="formatValue">Format</span>
                            <span class="section-toggle-arrow" id="formatArrow">▼</span>
                        </span>
                    </button>
                    <div class="section-toggle-content" id="formatContent" style="display: none;">
                        <div class="format-grid" id="formatGrid">
                            <div class="format-chip active" data-format="post">📝 <span data-i18n="formats.post">Post</span></div>
                            <div class="format-chip" data-format="carousel">🎠 <span data-i18n="formats.carousel">Carousel</span></div>
                            <div class="format-chip" data-format="reel">🎬 <span data-i18n="formats.reel">Reel</span></div>
                            <div class="format-chip" data-format="story">⏱️ <span data-i18n="formats.story">Story</span></div>
                            <div class="format-chip" data-format="thread">🧵 <span data-i18n="formats.thread">Thread</span></div>
                            <div class="format-chip" data-format="article">📰 <span data-i18n="formats.article">Article</span></div>
                            <div class="format-chip pub" data-format="pub">📢 <span data-i18n="formats.pub">PUB</span></div>
                        </div>
                    </div>
                </div>

                <!-- TOGGLE PLATEFORME -->
                <div class="config-section" id="platformSection">
                    <button class="section-toggle" id="platformToggle" onclick="toggleSection('platform')">
                        <span class="section-toggle-left">
                            <span class="section-toggle-icon">📱</span>
                            <span data-i18n="config.platform">Plateforme</span>
                        </span>
                        <span class="section-toggle-right">
                            <span class="section-toggle-value" id="platformValue">Plateforme</span>
                            <span class="section-toggle-arrow" id="platformArrow">▼</span>
                        </span>
                    </button>
                    <div class="section-toggle-content" id="platformContent" style="display: none;">
                        <div class="platform-grid" id="platformGrid">
                            <div class="platform-chip active" data-platform="linkedin">💼 LinkedIn</div>
                            <div class="platform-chip" data-platform="instagram">📸 Instagram</div>
                            <div class="platform-chip disabled" data-platform="scrollab" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: white; opacity: 0.5; cursor: not-allowed;" title="Bientôt disponible !">📜 Scrollab</div>
                            <div class="platform-chip" data-platform="tiktok">🎵 TikTok</div>
                            <div class="platform-chip" data-platform="twitter">𝕏 Twitter</div>
                            <div class="platform-chip" data-platform="facebook">👥 Facebook</div>
                            <div class="platform-chip" data-platform="youtube">🎬 YouTube</div>
                            <div class="platform-chip" data-platform="substack">📨 Substack</div>
                        </div>
                    </div>
                </div>

                <!-- TOGGLE AUDIENCE -->
                <div class="config-section" id="audienceSection">
                    <button class="section-toggle" id="audienceToggle" onclick="toggleSection('audience')">
                        <span class="section-toggle-left">
                            <span class="section-toggle-icon">👥</span>
                            <span>Ton audience</span>
                        </span>
                        <span class="section-toggle-right">
                            <span class="section-toggle-value" id="audienceValue">Sélectionner...</span>
                            <span class="section-toggle-arrow" id="audienceArrow">▼</span>
                        </span>
                    </button>
                    <div class="section-toggle-content" id="audienceContent" style="display: none;">
                        <div class="audience-selector-wrapper">
                            <div class="audience-dropdown" id="audienceDropdown" onclick="toggleAudienceDropdown()">
                                <span class="audience-dropdown-label">
                                    <span class="audience-dropdown-emoji" id="audienceEmoji">🎯</span>
                                    <span class="audience-dropdown-name" id="audienceName">Choisir une audience</span>
                                </span>
                                <span class="audience-dropdown-arrow">▼</span>
                            </div>
                            <div class="audience-dropdown-menu" id="audienceDropdownMenu">
                                <!-- Rempli dynamiquement par renderAudienceDropdown() -->
                            </div>
                        </div>
                        <div class="audience-preview" id="audiencePreview">
                            <div class="audience-preview-title" id="audiencePreviewTitle"></div>
                            <div class="audience-preview-desc" id="audiencePreviewDesc"></div>
                            <div class="audience-preview-tags" id="audiencePreviewTags"></div>
                        </div>
                    </div>
                </div>

                <!-- TOGGLE TON / STYLE -->
                <div class="config-section" id="toneSection">
                    <button class="section-toggle" id="toneToggle" onclick="toggleSection('tone')">
                        <span class="section-toggle-left">
                            <span class="section-toggle-icon">🎭</span>
                            <span>Ton</span>
                        </span>
                        <span class="section-toggle-right">
                            <span class="section-toggle-value" id="toneValue">Defaut (profil)</span>
                            <span class="section-toggle-arrow" id="toneArrow">▼</span>
                        </span>
                    </button>
                    <div class="section-toggle-content" id="toneContent" style="display: none;">
                        <div class="tone-grid" id="toneGrid">
                            <div class="tone-chip active" data-tone="default">🎯 Defaut (profil)</div>
                            <div class="tone-chip" data-tone="inspirant">✨ Inspirant</div>
                            <div class="tone-chip" data-tone="educatif">📚 Educatif</div>
                            <div class="tone-chip" data-tone="authentique">💎 Authentique</div>
                            <div class="tone-chip" data-tone="humour">😄 Humour</div>
                            <div class="tone-chip" data-tone="provocateur">🔥 Provocateur</div>
                            <div class="tone-chip" data-tone="minimaliste">✂️ Minimaliste</div>
                            <div class="tone-chip" data-tone="storytelling">📖 Storytelling</div>
                            <div class="tone-chip" data-tone="emotionnel">💜 Emotionnel</div>
                        </div>
                        <p class="tone-hint">💡 "Defaut" utilise le style de ton profil. Choisis un autre pour ce contenu uniquement.</p>
                    </div>
                </div>

                <!-- Options PUB (affichées seulement quand format = pub) -->
                <div class="config-section pub-options" id="pubOptionsSection" style="display: none;">
                    <label class="config-label">🎯 <span data-i18n="config.ad_platform">Plateforme publicitaire</span></label>
                    <div class="pub-platform-grid" id="pubPlatformGrid">
                        <div class="pub-platform-chip active" data-pubplatform="meta">
                            <span class="pub-icon">📘</span>
                            <span class="pub-name">Meta Ads</span>
                            <span class="pub-desc">Facebook & Instagram</span>
                        </div>
                        <div class="pub-platform-chip" data-pubplatform="linkedin">
                            <span class="pub-icon">💼</span>
                            <span class="pub-name">LinkedIn Ads</span>
                            <span class="pub-desc">B2B & Pros</span>
                        </div>
                        <div class="pub-platform-chip" data-pubplatform="tiktok">
                            <span class="pub-icon">🎵</span>
                            <span class="pub-name">TikTok Ads</span>
                            <span class="pub-desc">Gen Z & Viral</span>
                        </div>
                        <div class="pub-platform-chip" data-pubplatform="google">
                            <span class="pub-icon">🔍</span>
                            <span class="pub-name">Google Ads</span>
                            <span class="pub-desc">Search & Display</span>
                        </div>
                    </div>

                    <label class="config-label" style="margin-top: 20px;">🎪 <span data-i18n="config.ad_objective">Objectif de la campagne</span></label>
                    <div class="pub-objective-grid" id="pubObjectiveGrid">
                        <div class="pub-objective-chip active" data-objective="conversion">🛒 <span data-i18n="ad_objectives.conversion">Conversion</span></div>
                        <div class="pub-objective-chip" data-objective="trafic">🔗 <span data-i18n="ad_objectives.traffic">Trafic</span></div>
                        <div class="pub-objective-chip" data-objective="notoriete">👁️ <span data-i18n="ad_objectives.awareness">Notoriété</span></div>
                        <div class="pub-objective-chip" data-objective="engagement">💬 <span data-i18n="ad_objectives.engagement">Engagement</span></div>
                        <div class="pub-objective-chip" data-objective="leads">📋 <span data-i18n="ad_objectives.leads">Leads</span></div>
                    </div>

                    <div class="pub-info-banner">
                        <span>💡</span>
                        <span data-i18n="config.ad_info">L'IA va générer ta pub avec <strong>3 variantes A/B</strong> + les <strong>prompts visuels</strong> adaptés à la plateforme !</span>
                    </div>
                </div>

                <!-- Section Mode Agence -->
                <div class="config-section" id="agencySection">
                    <div class="agency-toggle-section">
                        <div class="agency-toggle-info">
                            <span class="agency-toggle-label">🏢 <span data-i18n="config.agency_mode">Mode Agence</span></span>
                            <span class="agency-toggle-desc" id="agencyStatusText" data-i18n="config.agency_desc">Multi-clients, dashboard & exports</span>
                        </div>
                        <div id="agencyToggleBtn">
                            <button class="btn btn-agency-unlock-small" onclick="AgencySystem.showUnlockModal()">🔐 <span data-i18n="config.unlock">Débloquer</span></button>
                        </div>
                    </div>
                </div>

                <!-- Section Client (visible si mode agence activé) -->
                <div id="clientSection" class="config-section client-section" style="display: none;">
                    <label class="config-label">👤 <span data-i18n="config.active_client">Client actif</span></label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="clientSelector" class="client-selector" style="flex: 1;" onchange="AgencySystem.setCurrentClient(this.value)">
                            <option value="" data-i18n="config.no_client">-- Aucun client --</option>
                        </select>
                        <button type="button" onclick="AgencySystem.showClientModal()" class="btn-icon" title="Nouveau client">➕</button>
                        <button type="button" onclick="if(AgencySystem.getCurrentClientId()) AgencySystem.showClientModal(AgencySystem.getCurrentClientId())" class="btn-icon" title="Modifier">✏️</button>
                    </div>
                </div>

                <!-- Section Framework (visible uniquement en mode agence) -->
                <div class="config-section" id="frameworkSection" style="display: none;">
                    <div class="framework-selector">
                        <div class="framework-selector-header">
                            <span class="framework-selector-label">📐 <span data-i18n="config.framework">Framework</span></span>
                            <button class="btn-manage-frameworks" onclick="FrameworkSystem.showLibrary()" data-i18n="config.manage_frameworks">Gérer mes frameworks →</button>
                        </div>
                        <div class="framework-quick-select" id="frameworkQuickSelect">
                            <!-- Chargé dynamiquement -->
                        </div>
                    </div>
                </div>

                <!-- MODE CRÉATION - 3 MODES -->
                <div class="config-section" id="creationModeSection">
                    <label class="config-label">🚀 Mode création</label>
                    <div class="creation-mode-cards">
                        <div class="creation-mode-card active" data-mode="libre" onclick="selectCreationMode('libre')">
                            <div class="mode-card-icon">✍️</div>
                            <div class="mode-card-title">Libre</div>
                            <div class="mode-card-desc">Mon idée, mon style</div>
                        </div>
                        <div class="creation-mode-card" data-mode="strategie" onclick="selectCreationMode('strategie')">
                            <div class="mode-card-icon">🎯</div>
                            <div class="mode-card-title">20 Jours</div>
                            <div class="mode-card-desc">Stratégie + storytelling</div>
                        </div>
                        <div class="creation-mode-card" data-mode="trends" onclick="selectCreationMode('trends')">
                            <div class="mode-card-icon">🔥</div>
                            <div class="mode-card-title">Trends</div>
                            <div class="mode-card-desc">Sujets tendance</div>
                        </div>
                    </div>

                    <!-- Panel 20 Jours (caché par défaut) -->
                    <div id="strategyDaySelector" class="strategy-day-selector" style="display: none;">
                        <select id="strategyDay" class="strategy-day-dropdown" onchange="loadStrategyDay()">
                            <option value="1">Jour 1 — Dégommer une objection client</option>
                            <option value="2">Jour 2 — Opinion impopulaire</option>
                            <option value="3">Jour 3 — Ce que j'aurais aimé savoir</option>
                            <option value="4">Jour 4 — 5 conseils à mon moi du passé</option>
                            <option value="5">Jour 5 — 3 erreurs que fait ton client</option>
                            <option value="6">Jour 6 — Les obstacles de mon parcours</option>
                            <option value="7">Jour 7 — Le secret des meilleurs</option>
                            <option value="8">Jour 8 — Déconstruire une idée reçue</option>
                            <option value="9">Jour 9 — Fausses croyances des clients</option>
                            <option value="10">Jour 10 — Les pièges à éviter</option>
                            <option value="11">Jour 11 — Se positionner en autorité</option>
                            <option value="12">Jour 12 — 3 règles d'or de ton expertise</option>
                            <option value="13">Jour 13 — La rencontre qui a changé ma vie</option>
                            <option value="14">Jour 14 — Réponse à une question fréquente</option>
                            <option value="15">Jour 15 — Étude de cas client</option>
                            <option value="16">Jour 16 — Transformation avant/après</option>
                            <option value="17">Jour 17 — Les paradigmes ont changé</option>
                            <option value="18">Jour 18 — Portrait inspirant</option>
                            <option value="19">Jour 19 — Pratique répandue à bannir</option>
                            <option value="20">Jour 20 — Raconter un échec + leçon</option>
                        </select>

                        <!-- Questions d'extraction -->
                        <div id="extractionQuestions" class="extraction-questions"></div>

                        <!-- Input principal du mode 20 jours -->
                        <div class="anecdote-inline">
                            <label class="anecdote-inline-label">
                                ✍️ Ta réponse / ton histoire
                            </label>
                            <textarea
                                id="anecdoteInput"
                                class="anecdote-input"
                                placeholder="Réponds aux questions ci-dessus : raconte une situation vécue, un échange marquant, une leçon apprise..."
                                rows="4"
                            ></textarea>
                            <div class="anecdote-hint">
                                <span class="hint-icon">💡</span>
                                <span>L'IA transformera ton vécu en post structuré et engageant</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="config-section" id="ideaSection">
                    <label class="config-label">💡 <span data-i18n="config.idea">Ton idée / sujet</span></label>
                    <textarea class="idea-input" id="ideaInput" data-i18n-placeholder="config.idea_placeholder" placeholder="Décris ton idée ou colle ici un texte que tu veux améliorer..."></textarea>
                </div>

                <!-- Badge Mode Ghostwriter (visible quand anecdote remplie) -->
                <div id="ghostwriterBadge" class="ghostwriter-badge" style="display: none;">
                    <span>📖</span> Mode Storytelling actif
                </div>

                <p style="text-align: center; color: #333; font-size: 0.9em; margin-bottom: 8px; font-weight: 500;"><span data-i18n="config.then_press">Puis appuie sur</span> 👇</p>
                <button class="generate-btn" id="generateBtn" onclick="showHooksSection()">🪝 <span data-i18n="config.generate_btn">1. Générer des accroches</span></button>
            </div>

            <div class="panel output-panel" id="outputPanel">
                <!-- ==================== ÉTAPE HOOKS ==================== -->
                <div id="hooksSection" style="display: none;">
                    <h2 class="panel-title">🪝 <span>Étape 1 : Choisis ton accroche</span></h2>

                    <!-- Rappel du brief (lecture seule) -->
                    <div class="hooks-brief-recap" id="hooksBriefRecap">
                        <div class="brief-recap-label">Ton brief :</div>
                        <div class="brief-recap-content" id="briefRecapContent">
                            <!-- Rempli dynamiquement -->
                        </div>
                    </div>

                    <!-- Sélecteur de vibe émotionnelle (toggle) -->
                    <div class="hooks-emotion-section" id="emotionSection">
                        <div class="emotion-toggle-header" onclick="toggleEmotionSection()">
                            <div class="toggle-left">
                                <span class="toggle-label">🎭 Quelle vibe pour ton hook ?</span>
                                <span class="selected-vibe" id="selectedVibeDisplay">✨ Inspiration</span>
                            </div>
                            <span class="toggle-arrow">▼</span>
                        </div>
                        <div class="emotion-chips-container">
                            <div class="emotion-chips" id="emotionChips">
                                <button class="emotion-chip active" data-emotion="inspiration" onclick="selectEmotion('inspiration')">
                                    <span class="emotion-icon">✨</span>
                                    <span class="emotion-name">Inspiration</span>
                                </button>
                                <button class="emotion-chip" data-emotion="admiration" onclick="selectEmotion('admiration')">
                                    <span class="emotion-icon">🌟</span>
                                    <span class="emotion-name">Admiration</span>
                                </button>
                                <button class="emotion-chip" data-emotion="vulnerabilite" onclick="selectEmotion('vulnerabilite')">
                                    <span class="emotion-icon">💔</span>
                                    <span class="emotion-name">Vulnérabilité</span>
                                </button>
                                <button class="emotion-chip" data-emotion="coup-de-gueule" onclick="selectEmotion('coup-de-gueule')">
                                    <span class="emotion-icon">🔥</span>
                                    <span class="emotion-name">Coup de gueule</span>
                                </button>
                                <button class="emotion-chip" data-emotion="humour" onclick="selectEmotion('humour')">
                                    <span class="emotion-icon">😄</span>
                                    <span class="emotion-name">Humour</span>
                                </button>
                                <button class="emotion-chip" data-emotion="curiosite" onclick="selectEmotion('curiosite')">
                                    <span class="emotion-icon">🤔</span>
                                    <span class="emotion-name">Curiosité</span>
                                </button>
                                <button class="emotion-chip" data-emotion="expert" onclick="selectEmotion('expert')">
                                    <span class="emotion-icon">🎓</span>
                                    <span class="emotion-name">Expert</span>
                                </button>
                                <button class="emotion-chip" data-emotion="teasing" onclick="selectEmotion('teasing')">
                                    <span class="emotion-icon">😏</span>
                                    <span class="emotion-name">Teasing</span>
                                </button>
                                <button class="emotion-chip" data-emotion="motivation" onclick="selectEmotion('motivation')">
                                    <span class="emotion-icon">💪</span>
                                    <span class="emotion-name">Motivation</span>
                                </button>
                                <button class="emotion-chip" data-emotion="confession" onclick="selectEmotion('confession')">
                                    <span class="emotion-icon">🤫</span>
                                    <span class="emotion-name">Confession</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Sous-panel Modes Humour (visible uniquement si humour sélectionné) -->
                    <div class="humor-modes-panel" id="humorModesPanel" style="display: none;">
                        <label class="hooks-label">🎭 Quel style d'humour ?</label>
                        <div class="humor-modes-grid">
                            <button class="humor-mode-btn active" data-mode="copines" onclick="selectHumorMode('copines')">
                                <span class="humor-mode-icon">👯‍♀️</span>
                                <span class="humor-mode-title">Mode Copines</span>
                                <span class="humor-mode-desc">Comme si tu racontais à tes potes autour d'un verre</span>
                            </button>
                            <button class="humor-mode-btn" data-mode="cash" onclick="selectHumorMode('cash')">
                                <span class="humor-mode-icon">💣</span>
                                <span class="humor-mode-title">Mode Cash</span>
                                <span class="humor-mode-desc">Honnêteté brutale, on dit tout haut ce qu'on pense tout bas</span>
                            </button>
                            <button class="humor-mode-btn" data-mode="caricature" onclick="selectHumorMode('caricature')">
                                <span class="humor-mode-icon">🎪</span>
                                <span class="humor-mode-title">Mode Caricature</span>
                                <span class="humor-mode-desc">Observation du quotidien poussée jusqu'au dessin animé</span>
                            </button>
                        </div>
                    </div>

                    <!-- Bouton générer des hooks (masqué car auto-généré, utilisé comme loader) -->
                    <div class="hooks-generate-section" id="hooksGenerateSection">
                        <button class="generate-hooks-btn" id="generateHooksBtn" onclick="generateHooks()">
                            ✨ <span>Génération en cours...</span>
                        </button>
                    </div>

                    <!-- Zone d'affichage des hooks générés -->
                    <div class="hooks-results" id="hooksResults" style="display: none;">
                        <div class="hooks-results-header">
                            <span class="hooks-results-title">✅ Accroches générées ! Choisis celle qui te parle :</span>
                            <button class="hooks-regenerate-btn" onclick="generateHooks()">
                                🔄 Regénérer
                            </button>
                        </div>
                        <div class="hooks-grid" id="hooksGrid">
                            <!-- Hooks générés dynamiquement -->
                        </div>
                    </div>

                    <!-- Bouton continuer -->
                    <div class="hooks-continue-section" id="hooksContinueSection" style="display: none;">
                        <button class="hooks-continue-btn" id="hooksContinueBtn" onclick="continueWithHook()" disabled>
                            ✨ <span>2. Générer le post complet</span>
                        </button>
                        <button class="hooks-back-btn" onclick="backToBrief()">
                            ← Modifier le brief
                        </button>
                    </div>
                </div>

                <!-- ==================== ÉTAPE CONTENU ==================== -->
                <div id="contentSection">
                    <h2 class="panel-title">📄 <span data-i18n="config.your_content">Étape 2 : Ton post complet</span></h2>

                    <!-- Hook sélectionné (affiché si un hook a été choisi) -->
                    <div class="selected-hook-display" id="selectedHookDisplay" style="display: none;">
                        <div class="selected-hook-label">🪝 Hook sélectionné :</div>
                        <div class="selected-hook-text" id="selectedHookText"></div>
                        <button class="change-hook-btn" onclick="changeHook()">Changer de hook</button>
                    </div>

                    <div class="output-content" id="outputContent">
                        <div class="output-placeholder">
                            <div class="output-placeholder-icon">✨</div>
                            <p>Clique sur "1. Générer des accroches" pour démarrer !</p>
                        </div>
                    </div>
                </div>
                <div class="action-buttons" id="actionButtons" style="display: none;">
                    <button class="action-btn" onclick="copyContent()">📋 <span data-i18n="actions.copy">Copier</span></button>
                    <button class="action-btn" onclick="regenerateContent()">🔄 <span data-i18n="actions.regenerate">Régénérer</span></button>
                    <button class="action-btn adjust" onclick="toggleAdjustPanel()">✏️ <span>Ajuster</span></button>
                    <button class="action-btn audit" onclick="auditGeneratedContent()">🔍 <span>Auditer</span></button>
                </div>

                <!-- Panneau d'ajustement -->
                <div class="adjust-panel" id="adjustPanel" style="display: none;">
                    <div class="adjust-panel-header">
                        <span class="adjust-panel-title">✏️ Ajuster le contenu</span>
                        <button class="adjust-close-btn" onclick="toggleAdjustPanel()">✕</button>
                    </div>
                    <div class="adjust-options">
                        <div class="adjust-row">
                            <button class="adjust-option-btn" onclick="adjustContent('shorter')">
                                <span class="adjust-icon">📉</span>
                                <span>Plus court</span>
                            </button>
                            <button class="adjust-option-btn" onclick="adjustContent('longer')">
                                <span class="adjust-icon">📈</span>
                                <span>Plus long</span>
                            </button>
                        </div>
                        <div class="adjust-row">
                            <button class="adjust-option-btn" onclick="adjustContent('simplify')">
                                <span class="adjust-icon">✨</span>
                                <span>Simplifier</span>
                            </button>
                            <button class="adjust-option-btn" onclick="adjustContent('tone')">
                                <span class="adjust-icon">🎭</span>
                                <span>Changer le ton</span>
                            </button>
                        </div>
                        <div class="adjust-custom">
                            <textarea class="adjust-input" id="adjustInput" placeholder="Dis ce que tu veux changer..."></textarea>
                            <button class="adjust-submit-btn" onclick="adjustContent('custom')">
                                🚀 Appliquer
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Section Visuels -->
                <div id="visualSection" style="display: none; margin-top: 20px;">
                    <!-- ACTION PRINCIPALE : Sauvegarder -->
                    <div style="margin-bottom: 15px;">
                        <button class="action-btn primary-action-btn" onclick="quickSaveToMesPosts()" style="background: linear-gradient(135deg, #10b981, #059669); border: none; color: white; width: 100%; padding: 15px; font-size: 1.05em;">
                            📌 <span data-i18n="actions.save_to_posts">Sauvegarder dans Mes Posts</span>
                        </button>
                    </div>

                    <!-- Widget Bonnes Pratiques -->
                    <div class="tips-widget" id="tipsWidget" style="display: none;">
                        <div class="tips-widget-header">
                            <span class="tips-widget-title">
                                <span>💡</span>
                                <span>Bonnes pratiques du moment</span>
                            </span>
                            <button class="tips-widget-toggle" onclick="toggleTipsWidget()">Masquer</button>
                        </div>
                        <div class="tips-list" id="tipsList">
                            <!-- Chargé dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cascade (Planning) -->
    <div class="modal-overlay" id="cascadeModal">
        <div class="modal" style="max-width: 95vw; width: 1200px; max-height: 90vh;">
            <div class="modal-header" style="border-bottom: 2px solid #e8e8e8;">
                <h2 class="modal-title">📅 <span data-i18n="modals.cascade">Ma Cascade</span></h2>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button class="cascade-nav-btn" onclick="CascadeSystem.previousWeek()">◀</button>
                    <span id="cascadeWeekLabel" style="font-weight: 600; min-width: 200px; text-align: center;">Semaine du 25 Nov</span>
                    <button class="cascade-nav-btn" onclick="CascadeSystem.nextWeek()">▶</button>
                    <button class="cascade-nav-btn" onclick="CascadeSystem.goToToday()" style="margin-left: 10px;">Aujourd'hui</button>
                </div>
                <button class="modal-close" onclick="closeCascade()">&times;</button>
            </div>
            
            <div class="cascade-container">
                <!-- Zone principale : Calendrier -->
                <div class="cascade-calendar">
                    <div class="cascade-week" id="cascadeWeek">
                        <!-- Généré par JS -->
                    </div>
                </div>
                
                <!-- Sidebar : Favoris à planifier -->
                <div class="cascade-sidebar">
                    <h3 class="cascade-sidebar-title">📝 À planifier</h3>
                    <p class="cascade-sidebar-desc">Glisse tes favoris vers le calendrier</p>
                    <div class="cascade-favorites" id="cascadeFavorites">
                        <!-- Liste des favoris -->
                    </div>
                    
                    <div class="cascade-export-section">
                        <h3 class="cascade-sidebar-title" style="margin-top: 20px;">📤 Export Bulk</h3>
                        <div class="cascade-export-buttons">
                            <button class="cascade-export-btn" onclick="CascadeSystem.exportCSV('metricool')">
                                <span>📊</span> Metricool
                            </button>
                            <button class="cascade-export-btn" onclick="CascadeSystem.exportCSV('swello')">
                                <span>📊</span> Swello
                            </button>
                            <button class="cascade-export-btn" onclick="CascadeSystem.exportCSV('generic')">
                                <span>📋</span> CSV Générique
                            </button>
                        </div>
                        <p style="font-size: 0.75em; color: #888; margin-top: 10px; line-height: 1.4;">
                            📸 Tu devras ajouter tes images manuellement dans Metricool/Swello après l'import.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ajout/Edit Slot Cascade -->
    <div class="modal-overlay" id="cascadeSlotModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="cascadeSlotTitle">📝 <span data-i18n="modals.plan_content">Planifier un contenu</span></h2>
                <button class="modal-close" onclick="closeCascadeSlot()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <input type="hidden" id="slotDate">
                <input type="hidden" id="slotEditIndex">
                
                <div class="form-group">
                    <label>⏰ Heure de publication</label>
                    <select id="slotTime" class="profile-input">
                        <option value="08:00">08:00 - Tôt le matin</option>
                        <option value="09:00" selected>09:00 - Début journée</option>
                        <option value="10:00">10:00 - Mid-morning</option>
                        <option value="12:00">12:00 - Pause déj</option>
                        <option value="14:00">14:00 - Après-midi</option>
                        <option value="17:00">17:00 - Fin de journée</option>
                        <option value="18:00">18:00 - After work</option>
                        <option value="19:00">19:00 - Soirée</option>
                        <option value="20:00">20:00 - Prime time</option>
                        <option value="21:00">21:00 - Late evening</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>📱 Plateforme</label>
                    <select id="slotPlatform" class="profile-input">
                        <option value="linkedin">💼 LinkedIn</option>
                        <option value="instagram">📸 Instagram</option>
                        <option value="twitter">𝕏 Twitter/X</option>
                        <option value="facebook">👥 Facebook</option>
                        <option value="tiktok">🎵 TikTok</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>📄 Contenu</label>
                    <select id="slotContent" class="profile-input">
                        <option value="">-- Choisir un favori --</option>
                        <!-- Rempli par JS -->
                    </select>
                    <textarea id="slotCustomContent" class="profile-input" rows="4" placeholder="Ou colle/écris ton contenu ici..." style="margin-top: 10px;"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-validate-code" onclick="CascadeSystem.saveSlot()" style="flex: 1;">
                        ✅ Planifier
                    </button>
                    <button class="btn" onclick="CascadeSystem.deleteSlot()" id="deleteSlotBtn" style="background: #ffebee; color: #c62828; display: none;">
                        🗑️ Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Trends -->
    <div class="modal-overlay" id="trendsModal">
        <div class="modal" style="max-width: 700px; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h2 class="modal-title">📈 <span data-i18n="modals.trends">Idées tendance pour toi</span></h2>
                <button class="modal-close" onclick="closeTrends()">&times;</button>
            </div>

            <!-- Onglets -->
            <div class="trends-tabs" style="flex-shrink: 0;">
                <button class="trends-tab active" id="tabNewIdeas" onclick="switchTrendsTab('new')">
                    🔥 Nouvelles idées
                </button>
                <button class="trends-tab" id="tabSavedIdeas" onclick="switchTrendsTab('saved')">
                    ⭐ Sauvegardées <span class="badge" id="savedCount">0</span>
                </button>
                <button class="trends-tab" id="tabHistory" onclick="switchTrendsTab('history')">
                    📚 Historique <span class="badge">14j</span>
                </button>
            </div>

            <!-- Contenu des onglets - SCROLLABLE -->
            <div id="trendsContent" style="flex: 1; overflow-y: auto; padding: 0 10px 20px; min-height: 0;">
                <!-- Sera rempli par displayTrendsWelcome() ou displayTrends() -->
            </div>
            <div id="savedIdeasContent" style="display: none; flex: 1; overflow-y: auto; padding: 0 10px 20px; min-height: 0;"></div>
            <div id="historyContent" style="display: none; flex: 1; overflow-y: auto; padding: 0 10px 20px; min-height: 0;"></div>
        </div>
    </div>

    <!-- Modal Choix Email -->
    <div class="modal-overlay" id="emailChoiceModal">
        <div class="modal" style="max-width: 600px; width: 90vw;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 20px 20px 0 0;">
                <h2 class="modal-title" style="color: white;">📧 <span data-i18n="modals.email_choice">Quel type d'email veux-tu créer ?</span></h2>
                <button class="modal-close" onclick="closeEmailChoiceModal()" style="color: white;">&times;</button>
            </div>
            <div style="padding: 30px;">
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <!-- Option Newsletter -->
                    <div class="email-choice-card" onclick="closeEmailChoiceModal(); showNewsletterModal();" style="padding: 25px; border-radius: 16px; border: 2px solid #e0e0e0; cursor: pointer; transition: all 0.3s; background: white;">
                        <div style="display: flex; align-items: flex-start; gap: 15px;">
                            <span style="font-size: 2.5em;">📬</span>
                            <div>
                                <h3 style="margin: 0 0 8px 0; font-size: 1.2em; color: #333;">Newsletter pour mes abonnés</h3>
                                <p style="margin: 0; color: #666; font-size: 0.95em; line-height: 1.5;">
                                    Nurturing et fidélisation de ta communauté existante.<br>
                                    <span style="color: #888; font-size: 0.9em;">→ Pour envoyer via Brevo, Mailchimp, etc.</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Option Cold Outreach -->
                    <div class="email-choice-card" onclick="closeEmailChoiceModal(); openNewCampaignDirect();" style="padding: 25px; border-radius: 16px; border: 2px solid #e0e0e0; cursor: pointer; transition: all 0.3s; background: white;">
                        <div style="display: flex; align-items: flex-start; gap: 15px;">
                            <span style="font-size: 2.5em;">🎯</span>
                            <div>
                                <h3 style="margin: 0 0 8px 0; font-size: 1.2em; color: #333;">Prospection par email</h3>
                                <p style="margin: 0; color: #666; font-size: 0.95em; line-height: 1.5;">
                                    Cold outreach pour acquérir de nouveaux clients.<br>
                                    <span style="color: #888; font-size: 0.9em;">→ Import Pharow, Sales Navigator</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Newsletter -->
    <div class="modal-overlay" id="newsletterModal">
        <div class="modal" style="max-width: 95vw; width: 1100px; max-height: 90vh; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 20px 20px 0 0;">
                <h2 class="modal-title" style="color: white;">📧 <span data-i18n="modals.newsletters">Newsletters qui Convertissent</span></h2>
                <button class="modal-close" onclick="closeNewsletterModal()" style="color: white;">&times;</button>
            </div>
            <div id="newsletter-module" style="max-height: calc(90vh - 80px); overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Modal Configuration Brevo -->
    <div class="modal-overlay" id="brevoConfigModal">
        <div class="modal" style="max-width: 600px; width: 90vw;">
            <div class="modal-header" style="background: linear-gradient(135deg, #0066FF, #00B2FF); color: white; border-radius: 20px 20px 0 0;">
                <h2 class="modal-title" style="color: white;">📧 <span data-i18n="modals.brevo_connection">Connexion Brevo</span></h2>
                <button class="modal-close" onclick="closeBrevoConfigModal()" style="color: white;">&times;</button>
            </div>
            <div style="padding: 30px;">
                <!-- Intro -->
                <div style="text-align: center; margin-bottom: 25px;">
                    <img src="https://www.brevo.com/wp-content/uploads/2023/05/Brevo-logo.svg" alt="Brevo" style="height: 40px; margin-bottom: 15px;" onerror="this.style.display='none'">
                    <p style="color: #666; font-size: 0.95em;">
                        Brevo permet d'envoyer tes emails de prospection automatiquement.<br>
                        <strong>Gratuit jusqu'à 300 emails/jour.</strong>
                    </p>
                </div>

                <!-- Étape 1: Créer un compte -->
                <div class="brevo-step" style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="background: #0066FF; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">1</span>
                        <h4 style="margin: 0;">Créer un compte Brevo</h4>
                    </div>
                    <p style="color: #666; font-size: 0.9em; margin: 0 0 12px 40px;">
                        Si tu n'as pas encore de compte, crée-en un gratuitement.
                    </p>
                    <a href="https://onboarding.brevo.com/account/register" target="_blank" style="display: inline-block; margin-left: 40px; background: #0066FF; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600;">
                        Créer mon compte Brevo →
                    </a>
                </div>

                <!-- Étape 2: Obtenir la clé API -->
                <div class="brevo-step" style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="background: #0066FF; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">2</span>
                        <h4 style="margin: 0;">Récupérer ta clé API</h4>
                    </div>
                    <p style="color: #666; font-size: 0.9em; margin: 0 0 12px 40px;">
                        Dans Brevo : <strong>Paramètres → SMTP & API → Clés API → Générer une clé</strong>
                    </p>
                    <a href="https://app.brevo.com/settings/keys/api" target="_blank" style="display: inline-block; margin-left: 40px; background: white; color: #0066FF; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; border: 2px solid #0066FF;">
                        Accéder aux clés API →
                    </a>
                </div>

                <!-- Étape 3: Coller la clé -->
                <div class="brevo-step" style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="background: #0066FF; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">3</span>
                        <h4 style="margin: 0;">Coller ta clé API ici</h4>
                    </div>
                    <div style="margin-left: 40px;">
                        <input type="password" id="brevoApiKey" placeholder="xkeysib-xxxxxxxx..." style="width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px; font-family: monospace; font-size: 0.95em; margin-bottom: 10px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="display: flex; align-items: center; gap: 5px; color: #666; font-size: 0.9em; cursor: pointer;">
                                <input type="checkbox" onclick="toggleBrevoKeyVisibility(this)"> Afficher la clé
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Étape 4: Email expéditeur -->
                <div class="brevo-step" style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="background: #0066FF; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">4</span>
                        <h4 style="margin: 0;">Ton email d'expédition</h4>
                    </div>
                    <p style="color: #666; font-size: 0.9em; margin: 0 0 12px 40px;">
                        L'email depuis lequel tes prospects recevront tes messages.
                    </p>
                    <div style="margin-left: 40px; display: flex; gap: 10px;">
                        <input type="email" id="brevoSenderEmail" placeholder="toi@tondomaine.com" style="flex: 1; padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95em;">
                        <input type="text" id="brevoSenderName" placeholder="Ton prénom" style="width: 140px; padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95em;">
                    </div>
                </div>

                <!-- Statut de connexion -->
                <div id="brevoConnectionStatus" style="display: none; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;"></div>

                <!-- Boutons -->
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="testBrevoConnection()" style="background: white; color: #0066FF; border: 2px solid #0066FF; padding: 12px 25px; border-radius: 10px; font-weight: 600; cursor: pointer;">
                        🔍 Tester la connexion
                    </button>
                    <button onclick="saveBrevoConfig()" style="background: linear-gradient(135deg, #0066FF, #00B2FF); color: white; border: none; padding: 12px 25px; border-radius: 10px; font-weight: 600; cursor: pointer;">
                        💾 Sauvegarder
                    </button>
                </div>

                <!-- Note -->
                <p style="text-align: center; color: #999; font-size: 0.85em; margin-top: 20px;">
                    🔒 Ta clé API est stockée de façon sécurisée et n'est jamais partagée.
                </p>

                <!-- Guide Délivrabilité -->
                <div style="margin-top: 25px; border-top: 2px solid #eee; padding-top: 25px;">
                    <button onclick="toggleDeliverabilityGuide()" style="width: 100%; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border: none; padding: 14px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span>🛡️ Guide : Éviter les spams et protéger ta réputation</span>
                        <span id="deliverabilityArrow" style="transition: transform 0.3s;">▼</span>
                    </button>

                    <div id="deliverabilityGuide" style="display: none; margin-top: 20px;">
                        <!-- Étape DNS/SPF/DKIM -->
                        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                            <h4 style="color: #856404; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                ⚠️ IMPORTANT : Configure ton domaine dans Brevo
                            </h4>
                            <p style="color: #856404; font-size: 0.9em; margin: 0 0 15px 0;">
                                Pour que tes emails arrivent en boîte de réception (et pas en spam), tu dois authentifier ton domaine.
                            </p>
                            <ol style="color: #856404; font-size: 0.9em; margin: 0 0 15px 0; padding-left: 20px;">
                                <li style="margin-bottom: 8px;">Dans Brevo, va dans <strong>Paramètres → Expéditeurs et IP → Domaines</strong></li>
                                <li style="margin-bottom: 8px;">Clique sur <strong>"Ajouter un domaine"</strong> et entre ton domaine (ex: tonsite.com)</li>
                                <li style="margin-bottom: 8px;">Brevo te donnera des <strong>enregistrements DNS</strong> à ajouter chez ton hébergeur</li>
                                <li style="margin-bottom: 8px;">Ajoute ces enregistrements (SPF, DKIM, DMARC) dans ton hébergeur DNS</li>
                                <li>Reviens dans Brevo et clique sur <strong>"Vérifier"</strong></li>
                            </ol>
                            <a href="https://app.brevo.com/senders/domain/list" target="_blank" style="display: inline-block; background: #856404; color: white; padding: 10px 18px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 0.9em;">
                                Configurer mon domaine dans Brevo →
                            </a>
                        </div>

                        <!-- Bonnes pratiques contenu -->
                        <div style="background: #e8f5e9; border: 1px solid #4caf50; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                            <h4 style="color: #2e7d32; margin: 0 0 12px 0;">✅ Bonnes pratiques pour tes emails</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9em;">
                                <div>
                                    <p style="color: #2e7d32; margin: 0 0 8px 0;"><strong>À FAIRE :</strong></p>
                                    <ul style="color: #2e7d32; margin: 0; padding-left: 18px;">
                                        <li>Personnaliser (prénom, entreprise)</li>
                                        <li>Écrire un objet clair et honnête</li>
                                        <li>Garder un ratio texte > images</li>
                                        <li>Un seul call-to-action par email</li>
                                        <li>Activer le mode warm-up</li>
                                    </ul>
                                </div>
                                <div>
                                    <p style="color: #c62828; margin: 0 0 8px 0;"><strong>À ÉVITER :</strong></p>
                                    <ul style="color: #c62828; margin: 0; padding-left: 18px;">
                                        <li>Mots spam : "GRATUIT", "URGENT"</li>
                                        <li>TOUT EN MAJUSCULES</li>
                                        <li>Trop de liens (max 2-3)</li>
                                        <li>Pièces jointes volumineuses</li>
                                        <li>Envoyer 100 emails dès le 1er jour</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Warm-up -->
                        <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 12px; padding: 20px;">
                            <h4 style="color: #1565c0; margin: 0 0 12px 0;">🔥 Mode Warm-up (recommandé)</h4>
                            <p style="color: #1565c0; font-size: 0.9em; margin: 0 0 10px 0;">
                                Si tu utilises un nouveau domaine ou si tu n'as jamais envoyé d'emails en masse :
                            </p>
                            <ul style="color: #1565c0; font-size: 0.9em; margin: 0; padding-left: 18px;">
                                <li><strong>Semaine 1 :</strong> 10-20 emails/jour</li>
                                <li><strong>Semaine 2 :</strong> 30-40 emails/jour</li>
                                <li><strong>Semaine 3 :</strong> 50-70 emails/jour</li>
                                <li><strong>Semaine 4+ :</strong> Volume normal</li>
                            </ul>
                            <p style="color: #1565c0; font-size: 0.85em; margin: 12px 0 0 0; font-style: italic;">
                                💡 Active le "Mode warm-up" dans les paramètres de l'Autopilot pour une augmentation automatique !
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Charte Prospection Éthique -->
    <div class="modal-overlay" id="ethicsModal">
        <div class="modal" style="max-width: 700px; width: 95vw; max-height: 90vh; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 20px 20px 0 0;">
                <h2 class="modal-title" style="color: white;">📜 Charte de Prospection Éthique</h2>
            </div>
            <div style="max-height: calc(90vh - 180px); overflow-y: auto; padding: 25px;">
                <div style="background: linear-gradient(135deg, #fff5f5, #ffe5e5); border-left: 4px solid #f5576c; padding: 15px; border-radius: 0 10px 10px 0; margin-bottom: 20px;">
                    <strong>⚠️ Important :</strong> L'utilisation de cet outil engage votre responsabilité. Le non-respect de ces règles peut entraîner des sanctions légales et la suspension de votre compte.
                </div>

                <h3 style="color: #667eea; margin: 20px 0 10px;">🇪🇺 Conformité RGPD</h3>
                <ul style="line-height: 1.8; color: #555;">
                    <li><strong>Base légale :</strong> Vous devez avoir un <strong>intérêt légitime</strong> documenté (contexte B2B uniquement)</li>
                    <li><strong>Origine des données :</strong> Vous êtes responsable de la légalité de vos sources de prospects</li>
                    <li><strong>Droit d'opposition :</strong> Chaque email contient automatiquement un lien de désinscription</li>
                    <li><strong>Conservation :</strong> Supprimez les prospects inactifs après 3 ans maximum</li>
                </ul>

                <h3 style="color: #667eea; margin: 20px 0 10px;">🔗 Concernant LinkedIn</h3>
                <ul style="line-height: 1.8; color: #555;">
                    <li><strong>Scraping interdit :</strong> L'extraction automatisée de données LinkedIn viole leurs CGU</li>
                    <li><strong>Risques :</strong> Suspension de compte LinkedIn, poursuites légales possibles</li>
                    <li><strong>Alternative :</strong> Utilisez Sales Navigator avec export manuel ou des sources légitimes (salons, opt-in)</li>
                </ul>

                <h3 style="color: #667eea; margin: 20px 0 10px;">📧 Bonnes Pratiques Cold Email</h3>
                <ul style="line-height: 1.8; color: #555;">
                    <li><strong>Volume raisonnable :</strong> Max 50 emails/jour pour commencer, augmentez progressivement</li>
                    <li><strong>Personnalisation réelle :</strong> Pas de spam générique - mentionnez le contexte</li>
                    <li><strong>Séquences limitées :</strong> Maximum 3-4 relances espacées de 3-5 jours</li>
                    <li><strong>Signature claire :</strong> Identité, entreprise, moyen de contact</li>
                    <li><strong>Horaires respectueux :</strong> Envoi en heures ouvrées uniquement</li>
                </ul>

                <h3 style="color: #667eea; margin: 20px 0 10px;">🚫 Ce qui est interdit</h3>
                <ul style="line-height: 1.8; color: #c0392b;">
                    <li>Prospecter des particuliers (B2C) sans consentement explicite</li>
                    <li>Utiliser des listes achetées de source douteuse</li>
                    <li>Ignorer les demandes de désinscription</li>
                    <li>Envoyer plus de 200 emails/jour/adresse</li>
                    <li>Usurper une identité ou masquer l'expéditeur</li>
                </ul>

                <div style="background: #f8f9ff; border-radius: 12px; padding: 20px; margin-top: 25px;">
                    <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="ethicsAcceptCheckbox" style="width: 20px; height: 20px; margin-top: 3px; accent-color: #667eea;">
                        <span style="color: #333; line-height: 1.5;">
                            Je confirme avoir lu et compris cette charte. Je m'engage à utiliser les outils de prospection de manière éthique et conforme au RGPD. Je comprends que je suis seul(e) responsable de l'origine et de l'utilisation de mes données prospects.
                        </span>
                    </label>
                </div>
            </div>
            <div style="padding: 20px; border-top: 1px solid #eee; display: flex; gap: 15px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeEthicsModal(false)" style="padding: 12px 25px;">
                    Annuler
                </button>
                <button class="btn btn-primary" id="ethicsAcceptBtn" onclick="acceptEthicsCharter()" disabled style="padding: 12px 30px; background: linear-gradient(135deg, #667eea, #764ba2); opacity: 0.5;">
                    ✅ J'accepte et je continue
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Prospects -->
    <div class="modal-overlay" id="prospectsModal">
        <div class="modal" style="max-width: 95vw; width: 1100px; max-height: 90vh; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #11998e, #38ef7d); color: white; border-radius: 20px 20px 0 0;">
                <h2 class="modal-title" style="color: white;">👥 <span data-i18n="modals.prospects">Mes Prospects</span></h2>
                <button class="modal-close" onclick="closeProspectsModal()" style="color: white;">&times;</button>
            </div>
            <div id="prospectsContent" style="max-height: calc(90vh - 80px); overflow-y: auto; padding: 20px;"></div>
        </div>
    </div>

    <!-- Modal Campagnes -->
    <div class="modal-overlay" id="campaignsModal">
        <div class="modal" style="max-width: 95vw; width: 1100px; max-height: 90vh; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f5576c, #f093fb); color: white; border-radius: 20px 20px 0 0;">
                <h2 class="modal-title" style="color: white;">🎯 <span data-i18n="modals.campaigns">Prospection par email</span></h2>
                <button class="modal-close" onclick="closeCampaignsModal()" style="color: white;">&times;</button>
            </div>
            <div id="campaignsContent" style="max-height: calc(90vh - 80px); overflow-y: auto; padding: 20px;"></div>
        </div>
    </div>

    <!-- Modal Rapports -->
    <div class="modal-overlay" id="reportsModal">
        <div class="modal" style="max-width: 95vw; width: 1200px; max-height: 90vh; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 20px 20px 0 0;">
                <h2 class="modal-title" style="color: white;">📊 Rapports & Analytics</h2>
                <button class="modal-close" onclick="closeReportsModal()" style="color: white;">&times;</button>
            </div>
            <div id="reportsContent" style="max-height: calc(90vh - 80px); overflow-y: auto; padding: 20px;"></div>
        </div>
    </div>

    <!-- Modal Favoris -->
    <div class="modal-overlay" id="favoritesModal">
        <div class="modal" style="max-width: 800px; max-height: 90vh;">
            <div class="modal-header">
                <h2 class="modal-title">❤️ <span data-i18n="modals.favorites">Mes contenus favoris</span></h2>
                <button class="modal-close" onclick="closeFavorites()">&times;</button>
            </div>
            <div id="favoritesList" style="max-height: calc(90vh - 80px); overflow-y: auto; padding: 20px;"></div>
        </div>
    </div>

    <!-- Modal Help -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">🆘 <span data-i18n="modals.help">Help! Améliore mon texte</span></h2>
                <button class="modal-close" onclick="closeHelpModal()">&times;</button>
            </div>
            <p style="margin-bottom: 15px; color: #666;">Colle ton brouillon, Tithot te proposera des améliorations :</p>
            <textarea class="help-textarea" id="helpTextarea" placeholder="Colle ton texte ici..."></textarea>
            <button class="help-btn" onclick="analyzeText()">✨ Analyser et améliorer</button>
        </div>
    </div>

    <!-- Modal Stats -->
    <div class="modal-overlay" id="statsModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">🏆 <span data-i18n="modals.stats">Ma progression</span></h2>
                <button class="modal-close" onclick="document.getElementById('statsModal').classList.remove('show')">&times;</button>
            </div>
            <div id="statsContent"></div>
        </div>
    </div>

    <!-- Modal Goals Dashboard -->
    <div class="modal-overlay" id="goalsModal">
        <div class="modal" style="max-width: 750px; max-height: 90vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, #11998e, #38ef7d);">
                <h2 class="modal-title">🎯 Mes Objectifs</h2>
                <button class="modal-close" onclick="document.getElementById('goalsModal').classList.remove('show')">&times;</button>
            </div>
            <div id="goalsContent" style="padding: 25px; overflow-y: auto; max-height: calc(90vh - 80px);"></div>
        </div>
    </div>

    <!-- Modal Paywall Freemium -->
    <div class="modal-overlay" id="paywallModal" style="display: none;">
        <div class="modal" style="max-width: 500px; text-align: center;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f5576c, #f093fb); flex-direction: column; padding: 30px;">
                <h2 class="paywall-title" style="color: white; margin: 0; font-size: 1.4em;">🎉 Tu as utilisé tes posts gratuits !</h2>
                <p class="paywall-subtitle" style="color: rgba(255,255,255,0.9); margin: 10px 0 0 0; font-size: 0.95em;">Passe à la version complète pour continuer</p>
            </div>
            <div style="padding: 30px;">
                <div class="paywall-usage" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <!-- Rempli dynamiquement -->
                </div>

                <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(168,85,247,0.1)); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <p style="font-weight: 600; margin: 0 0 10px 0;">✨ Avec l'abonnement Solo :</p>
                    <ul style="text-align: left; margin: 0; padding-left: 20px; color: #666;">
                        <li>Posts illimités</li>
                        <li>Audits illimités</li>
                        <li>Planning IA</li>
                        <li>Ma Voix personnalisée</li>
                        <li>TRENDS en temps réel</li>
                    </ul>
                </div>

                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <a href="account.html"
                       class="btn-primary"
                       style="display: block; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 16px 30px; border-radius: 12px; text-decoration: none; font-weight: 600; font-size: 1.1em;">
                        🚀 Voir les offres
                    </a>
                    <button onclick="FreemiumSystem.closePaywall()"
                            style="background: none; border: none; color: #999; cursor: pointer; padding: 10px; font-size: 0.9em;">
                        Non merci, plus tard
                    </button>
                </div>

                <p style="margin-top: 20px; font-size: 0.8em; color: #999;">
                    🔒 Paiement sécurisé • Sans engagement • Annulation à tout moment
                </p>
            </div>
        </div>
    </div>

    <!-- Modal Code Promo -->
    <div class="modal-overlay" id="promoCodeModal">
        <div class="modal" style="max-width: 450px; text-align: center;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669); flex-direction: column; padding: 25px;">
                <h2 style="color: white; margin: 0; font-size: 1.3em;">🎁 Code d'activation</h2>
                <p style="color: rgba(255,255,255,0.9); margin: 8px 0 0 0; font-size: 0.9em;">Entre ton code bêta-testeur ou partenaire</p>
            </div>
            <div style="padding: 30px;">
                <div style="margin-bottom: 20px;">
                    <input type="text"
                           id="promoCodeInput"
                           placeholder="Ex: BETA2024"
                           style="width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 1.1em; text-align: center; text-transform: uppercase; font-weight: 600; letter-spacing: 2px;"
                           onkeypress="if(event.key === 'Enter') validatePromoCode()">
                </div>

                <div id="promoCodeResult" style="margin-bottom: 20px; min-height: 50px;"></div>

                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button onclick="validatePromoCode()"
                            class="btn-primary"
                            style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 14px 30px; border: none; border-radius: 12px; font-weight: 600; font-size: 1em; cursor: pointer;">
                        ✓ Valider le code
                    </button>
                    <button onclick="closePromoModal()"
                            style="background: none; border: none; color: #999; cursor: pointer; padding: 10px; font-size: 0.9em;">
                        Annuler
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Planning IA -->
    <div class="modal-overlay" id="planningModal">
        <div class="modal" style="max-width: 950px; max-height: 90vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, #11998e, #38ef7d);">
                <h2 class="modal-title">🗓️ <span data-i18n="modals.planning">Planning IA</span></h2>
                <button class="modal-close" onclick="closePlanningModal()">&times;</button>
            </div>
            <div id="planningContent" style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 80px);"></div>
        </div>
    </div>

    <!-- Modal Mon Style -->
    <div class="modal-overlay" id="voiceModal">
        <div class="modal" style="max-width: 750px; max-height: 90vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                <h2 class="modal-title">🎤 <span data-i18n="modals.voice">Mon Style</span>
                    <span class="info-tooltip" title="Ton style = ton identité éditoriale : ton ton, tes expressions, ta façon d'écrire. Pas ta voix audio !">ⓘ</span>
                </h2>
                <button class="modal-close" onclick="closeVoiceModal()">&times;</button>
            </div>
            <p style="padding: 15px 20px 0; margin: 0; color: rgba(255,255,255,0.9); background: linear-gradient(135deg, #667eea, #764ba2); font-size: 0.9em;">
                💡 Ton style d'écriture unique : ton ton, tes expressions favorites, ta signature. L'IA apprend à écrire comme toi.
            </p>
            <div id="voiceContent" style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 120px);"></div>
        </div>
    </div>

    <!-- Modal Dashboard Agence -->
    <div class="modal-overlay" id="agencyDashboardModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">🏢 <span data-i18n="modals.agency_dashboard">Dashboard Agence</span></h2>
                <button class="modal-close" onclick="document.getElementById('agencyDashboardModal').classList.remove('show')">&times;</button>
            </div>
            <div id="agencyDashboardContent"></div>
        </div>
    </div>

    <!-- Modal Code Agence -->
    <div class="modal-overlay" id="agencyCodeModal">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div class="modal-header">
                <h2 class="modal-title">🔐 <span data-i18n="modals.agency_unlock">Débloquer Mode Agence</span></h2>
                <button class="modal-close" onclick="AgencySystem.closeUnlockModal()">&times;</button>
            </div>
            <div style="padding: 20px 0;">
                <p style="color: #666; margin-bottom: 20px;">Entrez votre code d'activation agence :</p>
                <input type="text" id="agencyCodeInput" class="agency-code-input" placeholder="CODE D'ACTIVATION" maxlength="20" onkeyup="if(event.key==='Enter')AgencySystem.validateCode()">
                <p id="agencyCodeError" class="agency-code-error" style="display: none;">❌ Code invalide. Vérifiez votre email de confirmation.</p>
                <button class="btn btn-validate-code" onclick="AgencySystem.validateCode()">✅ Valider</button>
                <p style="margin-top: 20px; font-size: 0.85em; color: #999;">
                    Pas encore d'abonnement Agence ?<br>
                    <a href="mailto:contact@myinnerquest.fr?subject=SOS Storytelling Agence" style="color: #667eea;">Contactez-nous</a> pour souscrire (à partir de 99€/mois)
                </p>
            </div>
        </div>
    </div>

    <!-- Modal Profil Client (enrichi type onboarding) -->
    <div class="modal-overlay" id="clientProfileModal">
        <div class="modal" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #1e3c72, #2a5298);">
                <h2 class="modal-title" id="clientModalTitle">➕ Nouveau client</h2>
                <button class="modal-close" onclick="AgencySystem.closeClientModal()">&times;</button>
            </div>
            <form id="clientProfileForm" class="onboarding-form" onsubmit="event.preventDefault(); AgencySystem.saveClientProfile();">
                <input type="hidden" id="clientProfileId">
                
                <!-- Section Identité -->
                <div class="onboarding-section">
                    <h3>🏢 Identité client</h3>
                    <div class="form-group">
                        <label>Nom du client / entreprise <span class="required">*</span></label>
                        <input type="text" id="clientName" required placeholder="Ex: Café Joyeux, Marie Dupont Coaching...">
                    </div>
                    <div class="form-group">
                        <label>Domaine / Secteur</label>
                        <input type="text" id="clientDomaine" placeholder="Ex: Optique, Coaching, SaaS, Restauration...">
                    </div>
                    <div class="form-group">
                        <label>Message unique / Positionnement</label>
                        <textarea id="clientMessageUnique" placeholder="Ce qui rend ce client unique, sa proposition de valeur..." style="min-height: 60px;"></textarea>
                    </div>
                </div>
                
                <!-- Section Audience -->
                <div class="onboarding-section">
                    <h3>🎯 Audience cible</h3>
                    <div class="form-group">
                        <label>Public cible</label>
                        <div class="checkbox-grid checkbox-grid-compact" id="clientPublicCibleGrid"></div>
                    </div>
                    <div class="form-group">
                        <label>Tranches d'âge ciblées</label>
                        <div class="checkbox-grid checkbox-grid-compact" id="clientTrancheAgeGrid"></div>
                    </div>
                    <div class="form-group">
                        <label>Description audience (optionnel)</label>
                        <input type="text" id="clientAudience" placeholder="Ex: Femmes 25-45 ans, CSP+, urbaines, sensibles à l'écologie...">
                    </div>
                </div>
                
                <!-- Section Contenu -->
                <div class="onboarding-section">
                    <h3>📝 Stratégie de contenu</h3>
                    <div class="form-group">
                        <label>Piliers de contenu (2-4 thématiques)</label>
                        <input type="text" id="clientPiliers" placeholder="Ex: conseils mode, coulisses, témoignages clients">
                        <small>Séparés par des virgules</small>
                    </div>
                    <div class="form-group">
                        <label>Tags / mots-clés récurrents</label>
                        <input type="text" id="clientTags" placeholder="Ex: #optique #lunettes #style #madeinFrance">
                    </div>
                </div>
                
                <!-- Section Plateformes -->
                <div class="onboarding-section">
                    <h3>📱 Plateformes & Formats</h3>
                    <div class="form-group">
                        <label>Plateformes</label>
                        <div class="checkbox-grid" id="clientPlateformesGrid"></div>
                    </div>
                    <div class="form-group">
                        <label>Formats préférés</label>
                        <div class="checkbox-grid checkbox-grid-compact" id="clientFormatsGrid"></div>
                    </div>
                </div>
                
                <!-- Section Style -->
                <div class="onboarding-section">
                    <h3>🎨 Ton & Style</h3>
                    <div class="form-group">
                        <label>Style de communication</label>
                        <div class="radio-cards radio-cards-2col" id="clientStyleGrid"></div>
                    </div>
                    <div class="form-group">
                        <label>Objectif principal</label>
                        <div class="radio-cards radio-cards-2col" id="clientObjectifGrid"></div>
                    </div>
                </div>
                
                <!-- Section Notes -->
                <!-- Section Voix Client -->
                <div class="onboarding-section">
                    <h3>🎤 Voix du client</h3>
                    <p style="color: #888; font-size: 0.9em; margin-bottom: 15px;">Colle des exemples de textes écrits par ce client pour capturer son style unique.</p>
                    
                    <div id="clientVoiceSamples" class="voice-samples" style="margin-bottom: 15px;"></div>
                    
                    <div class="form-group">
                        <textarea id="clientVoiceNewSample" class="voice-textarea" placeholder="Colle ici un texte écrit par le client (post LinkedIn, email, bio...) dont il est satisfait..." style="min-height: 120px;"></textarea>
                    </div>
                    <button type="button" onclick="AgencySystem.addClientVoiceSample()" class="btn-secondary" style="width: 100%; margin-bottom: 10px;">
                        ➕ Ajouter ce texte
                    </button>
                    
                    <div id="clientVoiceStatus" style="display: none; padding: 12px; border-radius: 10px; margin-top: 10px;"></div>
                    
                    <button type="button" onclick="AgencySystem.analyzeClientVoice()" id="analyzeClientVoiceBtn" class="btn-primary" style="width: 100%; display: none;">
                        🎤 Analyser la voix du client
                    </button>
                </div>
                
                <div class="onboarding-section">
                    <h3>💬 Notes & Particularités</h3>
                    <div class="form-group">
                        <textarea id="clientNotes" placeholder="Contraintes, ton à éviter, anecdotes, historique de la marque, mots interdits..." style="min-height: 100px;"></textarea>
                    </div>
                </div>
                
                <div class="onboarding-actions">
                    <button type="submit" class="btn-primary">💾 Enregistrer le client</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Import CSV/Excel -->
    <div class="modal-overlay" id="importModal">
        <div class="modal" style="max-width: 700px; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h2 class="modal-title">📥 Importer des clients</h2>
                <button class="modal-close" onclick="AgencySystem.closeImportModal()">&times;</button>
            </div>
            <div style="padding: 20px 0 30px; overflow-y: auto; flex: 1;">
                <p style="color: #666; margin-bottom: 15px;">
                    Importez vos clients depuis un fichier <strong>CSV</strong> ou <strong>Excel (.xlsx)</strong>.
                </p>

                <!-- Bouton télécharger modèle -->
                <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; gap: 15px; flex-wrap: wrap;">
                    <div>
                        <strong style="color: #2e7d32;">📋 Besoin d'un modèle ?</strong>
                        <p style="font-size: 0.85em; color: #555; margin: 5px 0 0;">Téléchargez notre template pré-formaté pour un import parfait.</p>
                    </div>
                    <button onclick="AgencySystem.downloadTemplate()" style="background: #2e7d32; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap; font-family: inherit;">
                        ⬇️ Télécharger le modèle
                    </button>
                </div>

                <div class="import-dropzone">
                    <input type="file" id="importFile" accept=".csv,.xlsx,.xls" onchange="AgencySystem.handleFileUpload(event)">
                    <div class="import-dropzone-content">
                        <span style="font-size: 2em;">📄</span>
                        <p>Glissez un fichier ou cliquez pour sélectionner</p>
                        <span style="font-size: 0.85em; color: #999;">CSV, XLSX, XLS</span>
                    </div>
                </div>
                
                <div id="importPreview"></div>
            </div>
        </div>
    </div>

    <!-- Modal Bibliothèque Frameworks -->
    <div class="modal-overlay" id="frameworkLibraryModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">📐 Mes Frameworks</h2>
                <button class="modal-close" onclick="FrameworkSystem.closeLibrary()">&times;</button>
            </div>
            <div style="padding: 20px 0;">
                <div class="framework-tabs">
                    <button class="framework-tab active" onclick="FrameworkSystem.showTab('my')" data-tab="my">📁 Mes Frameworks</button>
                    <button class="framework-tab" onclick="FrameworkSystem.showTab('defaults')" data-tab="defaults">🌟 Par défaut</button>
                    <button class="framework-tab" onclick="FrameworkSystem.showTab('templates')" data-tab="templates">📋 Templates</button>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <input type="text" id="frameworkSearch" placeholder="🔍 Rechercher un framework..."
                           style="flex: 1; max-width: 300px; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit;"
                           oninput="FrameworkSystem.filterFrameworks(this.value)">
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-import-fw" onclick="FrameworkSystem.showImport()">
                            📥 Importer
                        </button>
                        <button class="btn btn-frameworks" onclick="FrameworkSystem.showEditor()" style="padding: 10px 20px;">
                            ➕ Créer un framework
                        </button>
                    </div>
                </div>

                <div id="frameworksContent" class="frameworks-grid">
                    <!-- Frameworks chargés dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Éditeur de Framework -->
    <div class="modal-overlay" id="frameworkEditorModal">
        <div class="modal" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" id="frameworkEditorTitle">➕ Créer un framework</h2>
                <button class="modal-close" onclick="FrameworkSystem.closeEditor()">&times;</button>
            </div>
            <div class="framework-editor">
                <form id="frameworkForm" onsubmit="event.preventDefault(); FrameworkSystem.saveFramework();">
                    <input type="hidden" id="frameworkId" value="">

                    <div class="framework-editor-row">
                        <div class="form-group">
                            <label>📝 Nom du framework <span class="required">*</span></label>
                            <input type="text" id="frameworkName" required placeholder="Ex: Script appel découverte">
                        </div>
                        <div class="form-group">
                            <label>🎨 Icône & Couleur</label>
                            <div class="color-picker-row">
                                <input type="color" id="frameworkColor" value="#11998e">
                                <div class="icon-picker" id="frameworkIconPicker">
                                    <span class="icon-option active" data-icon="📝">📝</span>
                                    <span class="icon-option" data-icon="📞">📞</span>
                                    <span class="icon-option" data-icon="💬">💬</span>
                                    <span class="icon-option" data-icon="📧">📧</span>
                                    <span class="icon-option" data-icon="📰">📰</span>
                                    <span class="icon-option" data-icon="🎯">🎯</span>
                                    <span class="icon-option" data-icon="🔥">🔥</span>
                                    <span class="icon-option" data-icon="💡">💡</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="framework-editor-row full">
                        <div class="form-group">
                            <label>📂 Type de contenu <span class="required">*</span></label>
                            <div class="framework-type-select" id="frameworkTypeSelect">
                                <span class="framework-type-chip active" data-type="script_call">📞 Script Call</span>
                                <span class="framework-type-chip" data-type="dm">💬 DM</span>
                                <span class="framework-type-chip" data-type="email">📧 Email</span>
                                <span class="framework-type-chip" data-type="post">📝 Post</span>
                                <span class="framework-type-chip" data-type="carousel">🎠 Carousel</span>
                                <span class="framework-type-chip" data-type="newsletter">📰 Newsletter</span>
                                <span class="framework-type-chip" data-type="other">📋 Autre</span>
                            </div>
                        </div>
                    </div>

                    <div class="framework-editor-row full">
                        <div class="form-group">
                            <label>📖 Description</label>
                            <textarea id="frameworkDescription" rows="2" placeholder="Ex: Pour qualifier un prospect en 15 min"></textarea>
                        </div>
                    </div>

                    <div class="steps-editor">
                        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-weight: 600; color: #333;">
                            🔢 Étapes du framework <span class="required">*</span>
                            <span style="font-size: 0.8em; font-weight: 400; color: #888;">(Glisser-déposer pour réorganiser)</span>
                        </label>
                        <div class="steps-list" id="stepsList">
                            <!-- Steps dynamically added -->
                        </div>
                        <button type="button" class="btn-add-step" onclick="FrameworkSystem.addStep()">
                            ➕ Ajouter une étape
                        </button>
                    </div>

                    <div class="framework-editor-row full" style="margin-top: 20px;">
                        <div class="form-group">
                            <label>📋 Consignes globales <span style="font-size: 0.8em; color: #888;">(optionnel)</span></label>
                            <textarea id="frameworkInstructions" rows="2" placeholder="Ex: Ton direct mais chaleureux, pas de jargon"></textarea>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                        <button type="button" class="btn" style="flex: 1; background: #e0e0e0; color: #333;" onclick="FrameworkSystem.closeEditor()">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-frameworks" style="flex: 2; padding: 15px;">
                            💾 Enregistrer le framework
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Prévisualisation Template -->
    <div class="modal-overlay" id="templatePreviewModal">
        <div class="modal preview-modal">
            <button class="modal-close" onclick="FrameworkSystem.closePreview()" style="position: absolute; right: 15px; top: 15px; z-index: 10; background: rgba(255,255,255,0.9); border-radius: 50%; width: 35px; height: 35px;">&times;</button>
            <div class="preview-header" id="previewHeader" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                <div class="preview-header-top">
                    <span class="preview-icon" id="previewIcon">📝</span>
                    <span class="preview-type" id="previewType">Post</span>
                </div>
                <div class="preview-title" id="previewTitle">Nom du template</div>
                <div class="preview-desc" id="previewDesc">Description du template</div>
            </div>
            <div class="preview-content">
                <div class="preview-section">
                    <h4>🔢 Structure en étapes</h4>
                    <div class="preview-steps-list" id="previewSteps">
                        <!-- Steps dynamically added -->
                    </div>
                </div>
                <div class="preview-section" id="previewInstructionsSection">
                    <h4>📋 Consignes globales</h4>
                    <div class="preview-instructions">
                        <p id="previewInstructions">Instructions...</p>
                    </div>
                </div>
                <div class="preview-actions">
                    <button class="btn" style="background: #e0e0e0; color: #333;" onclick="FrameworkSystem.closePreview()">
                        Fermer
                    </button>
                    <button class="btn btn-frameworks" id="previewUseBtn" onclick="FrameworkSystem.usePreviewedTemplate()">
                        ✅ Utiliser ce template
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Import Framework -->
    <div class="modal-overlay" id="frameworkImportModal">
        <div class="modal import-modal" style="max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h2 class="modal-title">📥 Importer un framework</h2>
                <button class="modal-close" onclick="FrameworkSystem.closeImport()">&times;</button>
            </div>
            <div style="padding: 20px 0 30px; overflow-y: auto; flex: 1;">
                <!-- Bouton télécharger template -->
                <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <strong style="color: #2e7d32;">📋 Besoin d'un modèle ?</strong>
                        <p style="margin: 5px 0 0; color: #388e3c; font-size: 0.9em;">Téléchargez notre template CSV prêt à remplir</p>
                    </div>
                    <a href="template-frameworks-sos-storytelling.csv" download class="btn" style="background: linear-gradient(135deg, #4caf50, #66bb6a); color: white; padding: 10px 18px; text-decoration: none;">
                        ⬇️ Télécharger le modèle CSV
                    </a>
                </div>

                <div class="import-tabs">
                    <button class="import-tab active" onclick="FrameworkSystem.switchImportTab('excel')" data-tab="excel">
                        📊 Excel/CSV
                    </button>
                    <button class="import-tab" onclick="FrameworkSystem.switchImportTab('json')" data-tab="json">
                        📄 JSON
                    </button>
                </div>

                <div id="importTabExcel">
                    <div class="import-dropzone-fw" id="importDropzoneExcel">
                        <input type="file" accept=".xlsx,.xls,.csv" onchange="FrameworkSystem.handleFileImport(event, 'excel')">
                        <div class="import-dropzone-icon">📊</div>
                        <div class="import-dropzone-text">Glissez un fichier Excel ou CSV ici</div>
                        <div class="import-dropzone-hint">Formats acceptés : .xlsx, .xls, .csv</div>
                    </div>
                    <div class="import-example" style="margin-top: 15px;">
                        <h5>📋 Format attendu (colonnes) :</h5>
                        <pre>step_name | step_description
Accroche  | Créer le lien avec le prospect
Problème  | Identifier le problème principal
Solution  | Présenter votre solution</pre>
                        <p style="margin-top: 10px; font-size: 0.85em; color: #666;">
                            💡 La première ligne doit contenir les en-têtes. Utilisez le template pour un import parfait !
                        </p>
                    </div>
                </div>

                <div id="importTabJson" style="display: none;">
                    <div class="import-dropzone-fw" id="importDropzoneJson">
                        <input type="file" accept=".json" onchange="FrameworkSystem.handleFileImport(event, 'json')">
                        <div class="import-dropzone-icon">📄</div>
                        <div class="import-dropzone-text">Glissez un fichier JSON ici</div>
                        <div class="import-dropzone-hint">ou cliquez pour sélectionner</div>
                    </div>
                    <p style="text-align: center; color: #888; margin: 15px 0;">ou collez directement le JSON :</p>
                    <textarea class="import-textarea" id="importJsonText" placeholder='{"name": "Mon framework", "type": "post", "steps": [...]}'></textarea>
                    <div class="import-example">
                        <h5>📋 Exemple de format JSON :</h5>
                        <pre>{
  "name": "Mon framework",
  "type": "post",
  "description": "Description...",
  "icon": "📝",
  "steps": [
    {"name": "Étape 1", "description": "..."},
    {"name": "Étape 2", "description": "..."}
  ],
  "global_instructions": "Consignes..."
}</pre>
                    </div>
                </div>

                <div id="importResult" class="import-result" style="display: none;"></div>

                <div style="display: flex; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee;">
                    <button class="btn" style="flex: 1; background: #e0e0e0; color: #333; padding: 14px;" onclick="FrameworkSystem.closeImport()">
                        ❌ Annuler
                    </button>
                    <button class="btn" style="flex: 2; padding: 16px; background: linear-gradient(135deg, #11998e, #38ef7d); color: white; font-size: 1.1em; font-weight: 700; border-radius: 12px; box-shadow: 0 4px 15px rgba(17,153,142,0.3);" onclick="FrameworkSystem.processImport()">
                        ✅ Valider l'import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Inbox Intelligente Modal -->
    <div class="modal-overlay" id="inboxModal">
        <div class="modal" style="max-width: 1200px; width: 95%; max-height: 95vh; overflow: hidden; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h2 class="modal-title" style="color: white;">📬 Inbox Intelligente</h2>
                <button class="modal-close" onclick="closeInboxModal()">&times;</button>
            </div>
            <div id="inboxContainer" style="flex: 1; overflow-y: auto; padding: 0;">
                <!-- Le contenu sera injecté par inbox-module.js -->
            </div>
        </div>
    </div>

    <!-- Welcome Popup - Démo guidée -->
    <div class="welcome-popup-overlay" id="welcomePopup">
        <div class="welcome-popup">
            <button class="welcome-popup-close" onclick="closeWelcomePopup()" title="Fermer">✕</button>
            <div class="welcome-popup-emoji">🚀</div>
            <div class="welcome-popup-title">Bienvenue sur SOS Storytelling !</div>
            <div class="welcome-popup-text">
                Découvre comment créer du contenu en 2 minutes
            </div>
            <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 12px 16px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #f59e0b;">
                <span style="font-size: 1.1em;">🎁</span> <strong style="color: #92400e;">Tes 4 posts + 3 audits offerts t'attendent !</strong>
            </div>
            <div class="welcome-popup-features">
                <div class="welcome-popup-feature">
                    <span class="welcome-popup-feature-icon">🎤</span>
                    <span class="welcome-popup-feature-text">Clone ta voix en collant 3 de tes anciens textes</span>
                </div>
                <div class="welcome-popup-feature">
                    <span class="welcome-popup-feature-icon">✍️</span>
                    <span class="welcome-popup-feature-text">Génère ton premier post LinkedIn avec ton style</span>
                </div>
                <div class="welcome-popup-feature">
                    <span class="welcome-popup-feature-icon">📧</span>
                    <span class="welcome-popup-feature-text">Crée ta première newsletter engageante</span>
                </div>
            </div>
            <button class="welcome-popup-btn" onclick="startGuidedDemo()">🚀 Lancer la démo guidée</button>
            <button class="welcome-popup-skip" onclick="closeWelcomePopup()">Explorer par moi-même</button>
            <div class="welcome-popup-checkbox" style="opacity: 0.5;">
                <input type="checkbox" id="welcomeDontShow">
                <label for="welcomeDontShow" style="font-size: 0.75em; color: #aaa;">Ne plus afficher</label>
            </div>
        </div>
    </div>

    <!-- Tour Overlay -->
    <div class="tour-overlay" id="tourOverlay"></div>
    <div class="demo-badge" id="demoBadge" onclick="startTour()">🎯 Démo guidée</div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
    <script>
        // ==================== USER PROFILE MANAGER ====================
        // Menu hamburger mobile
        function toggleMobileMenu() {
            const headerButtons = document.getElementById('headerButtons');
            const menuIcon = document.getElementById('menuIcon');
            headerButtons.classList.toggle('open');
            menuIcon.textContent = headerButtons.classList.contains('open') ? '✕' : '☰';
        }

        // ==================== HEADER DROPDOWNS ====================
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const allDropdowns = document.querySelectorAll('.dropdown-menu');
            const allToggles = document.querySelectorAll('.dropdown-toggle');

            // Fermer les autres dropdowns
            allDropdowns.forEach(d => {
                if (d.id !== dropdownId) d.classList.remove('show');
            });
            allToggles.forEach(t => {
                if (!t.closest('.header-dropdown').querySelector('#' + dropdownId)) {
                    t.classList.remove('active');
                }
            });

            // Toggle le dropdown actuel
            dropdown.classList.toggle('show');
            dropdown.previousElementSibling.classList.toggle('active');
        }

        function closeDropdowns() {
            document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('show'));
            document.querySelectorAll('.dropdown-toggle').forEach(t => t.classList.remove('active'));
        }

        // Fermer les dropdowns si on clique ailleurs
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.header-dropdown')) {
                closeDropdowns();
            }
        });

        // ==================== 4 MODES PRINCIPAUX ====================

        // Gestion du tap mobile (premier tap = expand, deuxième = navigate)
        function handleModeClick(card, mode) {
            const isMobile = window.innerWidth <= 768 || 'ontouchstart' in window;

            if (isMobile && !card.classList.contains('expanded')) {
                // Premier tap sur mobile : expand la carte
                document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('expanded'));
                card.classList.add('expanded');
                return;
            }

            // Desktop ou deuxième tap mobile : naviguer
            if (mode === 'creer') {
                // Mode CRÉER : aller directement à la création de posts
                showQuickPost();
            } else if (mode === 'emails') {
                // Mode EMAILS : afficher le choix newsletter/prospection mail
                showEmailsChoiceModal();
            }
        }

        // Modal de choix pour Emails & Newsletters
        function showEmailsChoiceModal() {
            const modalHTML = `
                <div class="emails-choice-overlay" onclick="closeEmailsChoiceModal(event)">
                    <div class="emails-choice-modal" onclick="event.stopPropagation()">
                        <h3 style="margin-bottom: 20px; font-size: 1.3em;">📧 Que veux-tu faire ?</h3>

                        <div class="emails-choice-option" onclick="closeEmailsChoiceModal(); showNewsletterModal();">
                            <div class="emails-choice-icon">✉️</div>
                            <div class="emails-choice-content">
                                <div class="emails-choice-title">Créer une newsletter</div>
                                <div class="emails-choice-desc">Pour tes abonnés existants</div>
                            </div>
                        </div>

                        <div class="emails-choice-option" onclick="closeEmailsChoiceModal(); showCampaignsModal();">
                            <div class="emails-choice-icon">🎯</div>
                            <div class="emails-choice-content">
                                <div class="emails-choice-title">Lancer une campagne de prospection</div>
                                <div class="emails-choice-desc">Prospection LinkedIn, import fichier, emails vérifiés</div>
                            </div>
                        </div>

                        <button class="emails-choice-close" onclick="closeEmailsChoiceModal()">Fermer</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeEmailsChoiceModal(event) {
            const overlay = document.querySelector('.emails-choice-overlay');
            if (overlay) overlay.remove();
        }

        // Fermer les cartes expanded si on clique ailleurs
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.mode-card')) {
                document.querySelectorAll('.mode-card.expanded').forEach(c => c.classList.remove('expanded'));
            }
        });

        function toggleModeSubmenu(mode) {
            // Cacher la grille des modes
            const modesGrid = document.querySelector('.modes-grid');
            if (modesGrid) modesGrid.style.display = 'none';

            // Afficher le sous-menu correspondant
            const submenu = document.getElementById('submenu-' + mode);
            if (submenu) {
                submenu.style.display = 'block';
            }
        }

        function closeSubmenu() {
            // Cacher tous les sous-menus
            document.querySelectorAll('.mode-submenu').forEach(menu => {
                menu.style.display = 'none';
            });

            // Réafficher la grille des modes
            const modesGrid = document.querySelector('.modes-grid');
            if (modesGrid) modesGrid.style.display = 'flex';
        }

        // ==================== QUICK ACTIONS ====================
        function showQuickPost() {
            // Afficher le panneau de configuration et cacher Quick Actions
            document.getElementById('quickActionsPage').style.display = 'none';
            document.getElementById('introSection').style.display = 'block';
            document.getElementById('contentLayout').style.display = 'grid';

            // Afficher le badge démo guidée (toujours visible sur le dashboard de création)
            document.getElementById('demoBadge').style.display = 'flex';

            // Vérifier si le profil/style est configuré et afficher le reminder si nécessaire
            checkAndShowProfileReminder();

            // Scroll vers le haut
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Vérifie si le profil et le style sont configurés
        function checkAndShowProfileReminder() {
            // Ne pas montrer si l'utilisateur l'a déjà fermé cette session
            if (sessionStorage.getItem('sos_profile_reminder_hidden')) return;

            // Vérifier si l'onboarding est complété
            const onboardingData = JSON.parse(localStorage.getItem('tithot_onboarding') || '{}');
            const voiceData = JSON.parse(localStorage.getItem('tithot_voice') || '{}');

            const hasProfile = onboardingData.name && onboardingData.domain;
            const hasVoice = voiceData.texts && voiceData.texts.length >= 2;

            // Si les deux sont configurés, ne pas montrer
            if (hasProfile && hasVoice) {
                document.getElementById('profileReminder').style.display = 'none';
                return;
            }

            // Afficher le reminder
            document.getElementById('profileReminder').style.display = 'flex';
        }

        // Masquer le reminder pour cette session
        function hideProfileReminder() {
            document.getElementById('profileReminder').style.display = 'none';
            sessionStorage.setItem('sos_profile_reminder_hidden', 'true');
        }

        function showStoriesModal() {
            // Placeholder pour les stories - on redirige vers la création de post avec format stories
            showQuickPost();
            // Sélectionner le format Stories si disponible
            setTimeout(() => {
                const storiesOption = document.querySelector('[data-format="stories"]');
                if (storiesOption) storiesOption.click();
            }, 100);
        }

        function showHomePage() {
            // Revenir à la page Quick Actions
            document.getElementById('quickActionsPage').style.display = 'flex';
            document.getElementById('introSection').style.display = 'none';
            document.getElementById('contentLayout').style.display = 'none';

            // Masquer le badge démo guidée (pas visible sur la page d'accueil)
            document.getElementById('demoBadge').style.display = 'none';

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function closeMobileMenu() {
            const headerButtons = document.getElementById('headerButtons');
            const menuIcon = document.getElementById('menuIcon');
            if (headerButtons) headerButtons.classList.remove('open');
            if (menuIcon) menuIcon.textContent = '☰';
        }

        // Fermer le menu si on clique ailleurs ou sur un item de dropdown
        document.addEventListener('click', function(e) {
            const headerButtons = document.getElementById('headerButtons');
            const menuToggle = document.querySelector('.mobile-menu-toggle');

            // Si on clique sur un item de dropdown, fermer le menu
            if (headerButtons && e.target.closest('.dropdown-item')) {
                closeMobileMenu();
                return;
            }

            // Si on clique sur un bouton NON-dropdown (ex: Autopilot), fermer le menu
            if (headerButtons && e.target.closest('.header-buttons .btn') && !e.target.closest('.dropdown-toggle')) {
                closeMobileMenu();
                return;
            }

            // Fermer si on clique ailleurs (hors menu et hors toggle)
            if (headerButtons && menuToggle && !headerButtons.contains(e.target) && !menuToggle.contains(e.target)) {
                closeMobileMenu();
            }
        });

        const USER_PROFILE_KEY = 'voyageCreatifUserProfile';
        const DEFAULT_PROFILE = {
            nom: '', domaine: '', messageUnique: '', publicCible: [], trancheAge: [],
            piliers: [], tags: '', plateformes: [], formats: [], niveau: '', style: '',
            objectif: '', problematique: '', precisions: '', dateCreation: null, dateModification: null,
            voiceProfile: null // Profil de voix analysé par l'IA
        };

        function getUserProfile() {
            const saved = localStorage.getItem(USER_PROFILE_KEY);
            if (saved) { try { return JSON.parse(saved); } catch (e) { return null; } }
            return null;
        }

        function saveUserProfile(profile) {
            const now = new Date().toISOString();
            if (!profile.dateCreation) profile.dateCreation = now;
            profile.dateModification = now;
            localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(profile));

            // Sync vers le cloud (async, non-bloquant)
            if (window.ProfileSync) {
                ProfileSync.saveToCloud(profile).catch(() => {});
            }
        }

        function hasValidProfile() {
            const profile = getUserProfile();
            return profile && profile.nom && profile.nom.trim() !== '';
        }

        window.UserProfile = {
            get: getUserProfile,
            save: saveUserProfile,
            hasValid: hasValidProfile,
            delete: () => localStorage.removeItem(USER_PROFILE_KEY),
            update: (updates) => { const current = getUserProfile() || { ...DEFAULT_PROFILE }; const updated = { ...current, ...updates }; saveUserProfile(updated); return updated; },
            getSummary: () => { const p = getUserProfile(); return p ? `${p.nom} • ${p.domaine} • ${p.plateformes.join(', ')}` : 'Aucun profil'; },
            DEFAULT: DEFAULT_PROFILE
        };

        // ==================== PROFILE SYNC (CLOUD) ====================
        const ProfileSync = {
            TABLE: 'user_profiles',

            // Sauvegarder le profil dans Supabase
            async saveToCloud(profile) {
                try {
                    const supabase = window.supabaseApp || initSupabase();
                    if (!supabase) return false;

                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) return false;

                    const { error } = await supabase
                        .from(this.TABLE)
                        .upsert({
                            user_id: user.id,
                            profile_data: profile,
                            updated_at: new Date().toISOString()
                        }, { onConflict: 'user_id' });

                    if (error) {
                        console.log('[ProfileSync] Erreur sauvegarde cloud:', error.message);
                        return false;
                    }

                    console.log('[ProfileSync] Profil sauvegardé dans le cloud');
                    return true;
                } catch (e) {
                    console.log('[ProfileSync] Erreur:', e.message);
                    return false;
                }
            },

            // Charger le profil depuis Supabase
            async loadFromCloud() {
                try {
                    const supabase = window.supabaseApp || initSupabase();
                    if (!supabase) return null;

                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) return null;

                    const { data, error } = await supabase
                        .from(this.TABLE)
                        .select('profile_data, updated_at')
                        .eq('user_id', user.id)
                        .single();

                    if (error || !data) {
                        console.log('[ProfileSync] Aucun profil cloud trouvé');
                        return null;
                    }

                    console.log('[ProfileSync] Profil chargé depuis le cloud');
                    return data.profile_data;
                } catch (e) {
                    console.log('[ProfileSync] Erreur chargement:', e.message);
                    return null;
                }
            },

            // Synchroniser : charge depuis le cloud si plus récent, sinon sauvegarde le local
            async sync() {
                try {
                    const localProfile = getUserProfile();
                    const cloudProfile = await this.loadFromCloud();

                    if (!localProfile && cloudProfile) {
                        // Pas de profil local mais un profil cloud existe → restaurer
                        saveUserProfile(cloudProfile);
                        console.log('[ProfileSync] Profil restauré depuis le cloud');
                        showToast('☁️ Profil restauré depuis le cloud');
                        updateProfileButton();
                        return cloudProfile;
                    }

                    if (localProfile && !cloudProfile) {
                        // Profil local mais pas cloud → sauvegarder dans le cloud
                        await this.saveToCloud(localProfile);
                        return localProfile;
                    }

                    if (localProfile && cloudProfile) {
                        // Les deux existent → prendre le plus récent
                        const localDate = new Date(localProfile.dateModification || 0);
                        const cloudDate = new Date(cloudProfile.dateModification || 0);

                        if (cloudDate > localDate) {
                            // Cloud plus récent → restaurer
                            saveUserProfile(cloudProfile);
                            console.log('[ProfileSync] Profil cloud plus récent, restauré');
                            updateProfileButton();
                            return cloudProfile;
                        } else if (localDate > cloudDate) {
                            // Local plus récent → sauvegarder dans le cloud
                            await this.saveToCloud(localProfile);
                            return localProfile;
                        }
                    }

                    return localProfile;
                } catch (e) {
                    console.log('[ProfileSync] Erreur sync:', e.message);
                    return getUserProfile();
                }
            }
        };

        // Exposer globalement
        window.ProfileSync = ProfileSync;

        // ==================== ONBOARDING SYSTEM ====================
        const ONBOARDING_OPTIONS = {
            plateformes: [
                { value: 'linkedin', label: 'LinkedIn', icon: '💼' },
                { value: 'instagram', label: 'Instagram', icon: '📸' },
                { value: 'tiktok', label: 'TikTok', icon: '🎵' },
                { value: 'youtube', label: 'YouTube', icon: '🎬' },
                { value: 'x', label: 'X (Twitter)', icon: '𝕏' },
                { value: 'facebook', label: 'Facebook', icon: '👥' },
                { value: 'threads', label: 'Threads', icon: '🧵' },
                { value: 'pinterest', label: 'Pinterest', icon: '📌' },
                { value: 'newsletter', label: 'Newsletter', icon: '📧' }
            ],
            formats: [
                { value: 'post', label: 'Post texte', icon: '📝' },
                { value: 'carousel', label: 'Carousel', icon: '🎠' },
                { value: 'reel', label: 'Reel / Vidéo', icon: '🎬' },
                { value: 'story', label: 'Story', icon: '⏱️' },
                { value: 'thread', label: 'Thread', icon: '🧵' },
                { value: 'live', label: 'Live', icon: '🔴' },
                { value: 'article', label: 'Article', icon: '📰' },
                { value: 'visuel', label: 'Visuel', icon: '🎨' }
            ],
            publicCible: [
                { value: 'entrepreneurs', label: 'Entrepreneurs', icon: '🚀' },
                { value: 'freelances', label: 'Freelances', icon: '💻' },
                { value: 'salaries', label: 'Salariés', icon: '👔' },
                { value: 'etudiants', label: 'Étudiants', icon: '🎓' },
                { value: 'createurs', label: 'Créateurs', icon: '🎨' },
                { value: 'rh', label: 'RH / Recruteurs', icon: '🤝' },
                { value: 'b2b', label: 'Pros / B2B', icon: '🏢' },
                { value: 'b2c', label: 'Grand public', icon: '🛒' },
                { value: 'dirigeants', label: 'Dirigeants', icon: '👑' }
            ],
            trancheAge: [
                { value: '18-25', label: '18-25 ans' },
                { value: '25-35', label: '25-35 ans' },
                { value: '35-45', label: '35-45 ans' },
                { value: '45-55', label: '45-55 ans' },
                { value: '55+', label: '55+ ans' },
                { value: 'tous', label: 'Tous âges' }
            ],
            niveaux: [
                { value: 'debutant', label: 'Jeune pousse', icon: '🌱' },
                { value: 'explorateur', label: 'Explorateur', icon: '🧭' },
                { value: 'createur', label: 'Créateur', icon: '✨' },
                { value: 'influenceur', label: 'Influenceur', icon: '🚀' },
                { value: 'stratege', label: 'Stratège', icon: '💎' },
                { value: 'legende', label: 'Légende', icon: '👑' }
            ],
            styles: [
                { value: 'inspirant', label: 'Inspirant', icon: '✨' },
                { value: 'educatif', label: 'Éducatif', icon: '📚' },
                { value: 'authentique', label: 'Authentique', icon: '💎' },
                { value: 'humour', label: 'Humour', icon: '😄' },
                { value: 'provocateur', label: 'Provocateur', icon: '🔥' },
                { value: 'minimaliste', label: 'Minimaliste', icon: '🎯' },
                { value: 'storytelling', label: 'Storytelling', icon: '📖' },
                { value: 'emotionnel', label: 'Émotionnel', icon: '❤️' }
            ],
            objectifs: [
                { value: 'notoriete', label: 'Notoriété', icon: '🌟' },
                { value: 'communaute', label: 'Communauté', icon: '👥' },
                { value: 'ventes', label: 'Ventes', icon: '💰' },
                { value: 'autorite', label: 'Autorité', icon: '👑' },
                { value: 'reseau', label: 'Réseau', icon: '🤝' },
                { value: 'expression', label: 'Expression', icon: '🎨' },
                { value: 'recrutement', label: 'Recrutement', icon: '🎯' },
                { value: 'validation', label: 'Validation', icon: '🧪' }
            ]
        };

        function showOnboarding(isEdit = false) {
            const existingProfile = UserProfile.get();
            const modalHTML = `
                <div id="onboardingOverlay" class="onboarding-overlay">
                    <div class="onboarding-modal">
                        <div class="onboarding-header">
                            <h2>${isEdit ? '✏️ Modifier mon profil' : '🚀 Bienvenue !'}</h2>
                            <p>${isEdit ? 'Tes contenus seront personnalisés selon ces informations' : 'Personnalise ton expérience en quelques clics'}</p>
                            <button class="onboarding-close" onclick="closeOnboarding()">×</button>
                        </div>
                        <form id="onboardingForm" class="onboarding-form">
                            <!-- Choix de l'objectif principal - PREMIER -->
                            <div class="onboarding-section objective-section">
                                <h3>🎯 Quel est ton objectif principal ?</h3>
                                <div class="objective-cards">
                                    <div class="objective-card ${existingProfile?.strategyObjective === 'vendre' || !existingProfile?.strategyObjective ? 'selected vendre' : ''}" data-objective="vendre" onclick="selectObjective('vendre')">
                                        <div class="objective-icon">💰</div>
                                        <div class="objective-title">Vendre mes services</div>
                                        <div class="objective-desc">Trouver des clients, convertir, générer des leads</div>
                                        <ul class="objective-examples">
                                            <li>Posts qui déclenchent des DM</li>
                                            <li>Lever les objections</li>
                                            <li>Témoignages & études de cas</li>
                                        </ul>
                                    </div>
                                    <div class="objective-card ${existingProfile?.strategyObjective === 'expertise' ? 'selected expertise' : ''}" data-objective="expertise" onclick="selectObjective('expertise')">
                                        <div class="objective-icon">🧠</div>
                                        <div class="objective-title">Montrer mon expertise</div>
                                        <div class="objective-desc">Devenir une référence, être cité par les IA</div>
                                        <ul class="objective-examples">
                                            <li>Thought leadership</li>
                                            <li>Frameworks & méthodologies</li>
                                            <li>Contenu cité par Perplexity/ChatGPT</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="onboarding-section">
                                <h3>👤 Ton identité</h3>
                                <div class="form-group">
                                    <label for="onb-nom">Comment t'appelles-tu ? <span class="required">*</span></label>
                                    <input type="text" id="onb-nom" placeholder="Ton prénom ou pseudo" value="${existingProfile?.nom || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label for="onb-domaine">Tes domaines d'expertises</label>
                                    <input type="text" id="onb-domaine" placeholder="Ex: coaching, design, marketing digital..." value="${existingProfile?.domaine || ''}">
                                    <small class="field-hint">💡 Entre plusieurs domaines d'expertise. L'IA se basera sur ce champ pour te proposer des sujets et idées de contenu pertinents.</small>
                                </div>
                                <div class="form-group">
                                    <label for="onb-messageUnique">Ce qui te rend unique</label>
                                    <textarea id="onb-messageUnique" placeholder="Ex: J'aide les introvertis à rayonner sur LinkedIn..." style="min-height: 60px;">${existingProfile?.messageUnique || ''}</textarea>
                                </div>
                            </div>
                            <div class="onboarding-section">
                                <h3>🎯 Ton audience</h3>
                                <div class="form-group">
                                    <label>Public cible</label>
                                    <div class="checkbox-grid checkbox-grid-compact">
                                        ${ONBOARDING_OPTIONS.publicCible.map(p => `
                                            <label class="checkbox-card">
                                                <input type="checkbox" name="publicCible" value="${p.value}" ${existingProfile?.publicCible?.includes(p.value) ? 'checked' : ''}>
                                                <span class="checkbox-content"><span class="checkbox-icon">${p.icon}</span><span class="checkbox-label">${p.label}</span></span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Tranches d'âge ciblées</label>
                                    <div class="checkbox-grid checkbox-grid-compact">
                                        ${ONBOARDING_OPTIONS.trancheAge.map(t => `
                                            <label class="checkbox-card">
                                                <input type="checkbox" name="trancheAge" value="${t.value}" ${existingProfile?.trancheAge?.includes(t.value) ? 'checked' : ''}>
                                                <span class="checkbox-content"><span class="checkbox-label">${t.label}</span></span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            <div class="onboarding-section">
                                <h3>📝 Ton contenu</h3>
                                <div class="form-group">
                                    <label for="onb-piliers">Tes piliers de contenu (2-4 thématiques)</label>
                                    <input type="text" id="onb-piliers" placeholder="Ex: mindset, productivité, entrepreneuriat" value="${existingProfile?.piliers?.join(', ') || ''}">
                                    <small>Séparés par des virgules</small>
                                </div>
                                <div class="form-group">
                                    <label for="onb-tags">Tags / mots-clés récurrents</label>
                                    <input type="text" id="onb-tags" placeholder="Ex: #leadership #growthmindset" value="${existingProfile?.tags || ''}">
                                </div>
                            </div>
                            <div class="onboarding-section">
                                <h3>🎨 Ton profil créateur</h3>
                                <div class="form-group">
                                    <label>Niveau</label>
                                    <div class="radio-cards radio-cards-3col">
                                        ${ONBOARDING_OPTIONS.niveaux.map(n => `
                                            <label class="radio-card radio-card-compact">
                                                <input type="radio" name="niveau" value="${n.value}" ${(existingProfile?.niveau || '') === n.value ? 'checked' : ''}>
                                                <span class="radio-content"><span class="radio-icon">${n.icon}</span><span class="radio-label">${n.label}</span></span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Style de communication</label>
                                    <div class="radio-cards radio-cards-2col">
                                        ${ONBOARDING_OPTIONS.styles.map(s => `
                                            <label class="radio-card radio-card-compact">
                                                <input type="radio" name="style" value="${s.value}" ${(existingProfile?.style || '') === s.value ? 'checked' : ''}>
                                                <span class="radio-content"><span class="radio-icon">${s.icon}</span><span class="radio-label">${s.label}</span></span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            <div class="onboarding-section">
                                <h3>🎯 Tes objectifs</h3>
                                <div class="form-group">
                                    <label>Objectif principal</label>
                                    <div class="radio-cards radio-cards-2col">
                                        ${ONBOARDING_OPTIONS.objectifs.map(o => `
                                            <label class="radio-card radio-card-compact">
                                                <input type="radio" name="objectif" value="${o.value}" ${(existingProfile?.objectif || '') === o.value ? 'checked' : ''}>
                                                <span class="radio-content"><span class="radio-icon">${o.icon}</span><span class="radio-label">${o.label}</span></span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="onb-problematique">Problématique actuelle</label>
                                    <textarea id="onb-problematique" placeholder="Ex: Je bloque sur la régularité..." style="min-height: 60px;">${existingProfile?.problematique || ''}</textarea>
                                </div>
                            </div>
                            <div class="onboarding-section personas-section">
                                <div class="personas-header">
                                    <h3>👥 Mes audiences</h3>
                                    <button type="button" class="btn-add-persona" onclick="openPersonaEditor()">
                                        <span>+</span> Nouvelle audience
                                    </button>
                                </div>
                                <div id="personasList" class="personas-list">
                                    <!-- Chargé dynamiquement -->
                                </div>
                                <small style="color: #888; display: block; margin-top: 10px;">
                                    💡 Crée des personas détaillés pour que l'IA génère des contenus vraiment personnalisés.
                                </small>
                            </div>
                            <div class="onboarding-section">
                                <h3>💬 Autre chose ?</h3>
                                <div class="form-group">
                                    <textarea id="onb-precisions" placeholder="Tout ce qui peut aider à personnaliser tes contenus..." style="min-height: 80px;">${existingProfile?.precisions || ''}</textarea>
                                </div>
                            </div>
                            <div class="onboarding-actions">
                                <button type="submit" class="btn-primary">${isEdit ? '💾 Sauvegarder' : '🚀 C\'est parti !'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.getElementById('onboardingForm').addEventListener('submit', handleOnboardingSubmit);

            // Initialiser userStrategyObjective avec la valeur du profil
            userStrategyObjective = existingProfile?.strategyObjective || 'vendre';

            setTimeout(() => {
                const overlay = document.getElementById('onboardingOverlay');
                if (overlay) overlay.classList.add('active');
                // Charger les personas
                renderPersonasList();
            }, 10);
        }

        // ==================== GESTION DES PERSONAS UI ====================
        const PERSONA_EMOJIS = ['🎯', '🎨', '📚', '🏢', '💼', '🚀', '💡', '👩‍💻', '🎪', '🌟', '💎', '🔥', '🌈', '🎭', '🧠', '❤️'];

        let editingPersonaId = null;

        // Rendre la liste des personas
        async function renderPersonasList() {
            const container = document.getElementById('personasList');
            if (!container) return;

            // Attendre que PersonasManager soit chargé
            if (!PersonasManager.isLoaded) {
                await PersonasManager.loadPersonas();
            }

            const personas = PersonasManager.personas;

            if (personas.length === 0) {
                container.innerHTML = `
                    <div class="personas-empty">
                        <div class="personas-empty-icon">👥</div>
                        <div class="personas-empty-text">Tu n'as pas encore créé d'audience personnalisée.</div>
                        <button type="button" class="btn-add-persona" onclick="openPersonaEditor()">
                            <span>+</span> Créer ma première audience
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = personas.map(p => `
                <div class="persona-card ${p.is_default ? 'is-default' : ''}" data-id="${p.id}">
                    <div class="persona-card-header">
                        <div class="persona-card-title">
                            <span class="persona-card-emoji">${p.emoji || '🎯'}</span>
                            <span class="persona-card-name">${p.name}</span>
                            ${p.is_default ? '<span class="persona-default-badge">Par défaut</span>' : ''}
                        </div>
                    </div>
                    <div class="persona-card-desc">${p.description || 'Pas de description'}</div>
                    <div class="persona-card-meta">
                        ${p.pain_points?.length > 0 ? `<span class="persona-meta-tag">😓 ${p.pain_points.length} douleurs</span>` : ''}
                        ${p.desires?.length > 0 ? `<span class="persona-meta-tag">✨ ${p.desires.length} désirs</span>` : ''}
                    </div>
                    <div class="persona-card-actions">
                        <button type="button" class="persona-action-btn" onclick="openPersonaEditor('${p.id}')">✏️ Modifier</button>
                        <button type="button" class="persona-action-btn" onclick="duplicatePersona('${p.id}')">📋 Dupliquer</button>
                        ${!p.is_default ? `<button type="button" class="persona-action-btn" onclick="setPersonaDefault('${p.id}')">⭐ Par défaut</button>` : ''}
                        <button type="button" class="persona-action-btn delete" onclick="deletePersona('${p.id}')">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        // Ouvrir l'éditeur de persona
        function openPersonaEditor(personaId = null) {
            editingPersonaId = personaId;
            const persona = personaId ? PersonasManager.personas.find(p => p.id === personaId) : null;

            const modalHTML = `
                <div id="personaModalOverlay" class="persona-modal-overlay">
                    <div class="persona-modal">
                        <div class="persona-modal-header">
                            <h3>${persona ? '✏️ Modifier l\'audience' : '➕ Nouvelle audience'}</h3>
                            <button class="persona-modal-close" onclick="closePersonaEditor()">×</button>
                        </div>
                        <div class="persona-modal-body">
                            <div class="persona-form-row">
                                <div class="persona-form-group">
                                    <label>Nom de l'audience *</label>
                                    <input type="text" id="persona-name" placeholder="Ex: Artistes indépendants" value="${persona?.name || ''}">
                                </div>
                                <div class="persona-form-group">
                                    <label>Emoji</label>
                                    <div class="emoji-picker-inline" id="emojiPicker">
                                        ${PERSONA_EMOJIS.map(e => `
                                            <div class="emoji-option ${(persona?.emoji || '🎯') === e ? 'selected' : ''}"
                                                 onclick="selectPersonaEmoji('${e}', event)">${e}</div>
                                        `).join('')}
                                    </div>
                                    <input type="hidden" id="persona-emoji" value="${persona?.emoji || '🎯'}">
                                </div>
                            </div>

                            <div class="persona-form-group">
                                <label>Description</label>
                                <textarea id="persona-description" placeholder="Ex: Artistes visuels (peintres, illustrateurs) qui veulent vivre de leur art">${persona?.description || ''}</textarea>
                            </div>

                            <div class="persona-form-row">
                                <div class="persona-form-group">
                                    <label>Tranche d'âge</label>
                                    <input type="text" id="persona-age" placeholder="Ex: 30-45 ans" value="${persona?.age_range || ''}">
                                </div>
                                <div class="persona-form-group">
                                    <label>Localisation</label>
                                    <input type="text" id="persona-location" placeholder="Ex: France, Europe" value="${persona?.location || ''}">
                                </div>
                            </div>

                            <div class="persona-form-group">
                                <label>Leurs douleurs / problèmes (un par ligne)</label>
                                <textarea id="persona-pains" placeholder="Ex:
Pas assez de visibilité
Difficulté à fixer leurs prix
Se sentent illégitimes à se vendre">${persona?.pain_points?.join('\n') || ''}</textarea>
                                <small>Ces problèmes seront adressés dans tes contenus</small>
                            </div>

                            <div class="persona-form-group">
                                <label>Ce qu'ils veulent / leurs désirs (un par ligne)</label>
                                <textarea id="persona-desires" placeholder="Ex:
Vivre de leur art
Être reconnus pour leur travail
Trouver des clients sans prospecter">${persona?.desires?.join('\n') || ''}</textarea>
                            </div>

                            <div class="persona-form-group">
                                <label>Mots-clés / vocabulaire à utiliser (séparés par des virgules)</label>
                                <input type="text" id="persona-vocabulary" placeholder="Ex: création, œuvre, processus créatif, galerie" value="${persona?.vocabulary?.join(', ') || ''}">
                            </div>

                            <div class="persona-form-group">
                                <label>Notes sur le ton à adopter</label>
                                <textarea id="persona-tone" placeholder="Ex: Inspirant mais pas pompeux. Éviter le jargon marketing. Parler de partager plutôt que vendre.">${persona?.tone_preferences || ''}</textarea>
                            </div>

                            <div class="persona-form-group" style="display: flex; align-items: center; padding-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin: 0;">
                                    <input type="checkbox" id="persona-default" ${persona?.is_default ? 'checked' : ''}>
                                    <span>Définir comme audience par défaut</span>
                                </label>
                            </div>
                        </div>
                        <div class="persona-modal-footer">
                            <button class="btn-persona-cancel" onclick="closePersonaEditor()">Annuler</button>
                            <button class="btn-persona-save" onclick="savePersona()">💾 Sauvegarder</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            setTimeout(() => {
                const overlay = document.getElementById('personaModalOverlay');
                if (overlay) overlay.classList.add('active');
            }, 10);
        }

        // Sélectionner un emoji
        function selectPersonaEmoji(emoji, e) {
            const input = document.getElementById('persona-emoji');
            if (input) input.value = emoji;
            document.querySelectorAll('.emoji-option').forEach(el => el.classList.remove('selected'));
            if (e && e.target) e.target.classList.add('selected');
        }

        // Fermer l'éditeur
        function closePersonaEditor() {
            const overlay = document.getElementById('personaModalOverlay');
            if (overlay) {
                overlay.classList.remove('active');
                setTimeout(() => overlay.remove(), 300);
            }
            editingPersonaId = null;
        }

        // Sauvegarder un persona
        async function savePersona() {
            const name = document.getElementById('persona-name').value.trim();
            if (!name) {
                showToast('❌ Le nom est obligatoire');
                return;
            }

            const personaData = {
                name,
                emoji: document.getElementById('persona-emoji').value,
                description: document.getElementById('persona-description').value.trim(),
                age_range: document.getElementById('persona-age').value.trim(),
                location: document.getElementById('persona-location').value.trim(),
                pain_points: document.getElementById('persona-pains').value.split('\n').map(l => l.trim()).filter(l => l),
                desires: document.getElementById('persona-desires').value.split('\n').map(l => l.trim()).filter(l => l),
                vocabulary: document.getElementById('persona-vocabulary').value.split(',').map(v => v.trim()).filter(v => v),
                tone_preferences: document.getElementById('persona-tone').value.trim(),
                is_default: document.getElementById('persona-default').checked
            };

            let result;
            if (editingPersonaId) {
                result = await PersonasManager.update(editingPersonaId, personaData);
            } else {
                result = await PersonasManager.create(personaData);
            }

            if (result) {
                closePersonaEditor();
                renderPersonasList();
            }
        }

        // Dupliquer un persona
        async function duplicatePersona(personaId) {
            await PersonasManager.duplicate(personaId);
            renderPersonasList();
        }

        // Définir comme défaut
        async function setPersonaDefault(personaId) {
            await PersonasManager.setAsDefault(personaId);
            await PersonasManager.loadPersonas(); // Recharger pour avoir le bon état
            renderPersonasList();
        }

        // Supprimer un persona
        async function deletePersona(personaId) {
            if (!confirm('Supprimer cette audience ?')) return;
            await PersonasManager.delete(personaId);
            renderPersonasList();
        }

        // ==================== SELECTEUR AUDIENCE (WIZARD) ====================
        const GENERIC_AUDIENCES = [
            { id: 'entrepreneurs', emoji: '🚀', name: 'Entrepreneurs', description: 'Créateurs d\'entreprise, startuppers' },
            { id: 'freelances', emoji: '💼', name: 'Freelances', description: 'Indépendants, consultants, prestataires' },
            { id: 'salaries', emoji: '👔', name: 'Salariés', description: 'Employés en poste, cadres' },
            { id: 'dirigeants', emoji: '👑', name: 'Dirigeants', description: 'CEO, DG, décideurs' },
            { id: 'createurs', emoji: '🎨', name: 'Créateurs', description: 'Artistes, créatifs, influenceurs' },
            { id: 'etudiants', emoji: '🎓', name: 'Étudiants', description: 'Étudiants, jeunes diplômés' }
        ];

        let selectedAudienceId = null;
        let selectedAudienceType = null; // 'persona' ou 'generic'

        // Ouvrir/fermer le dropdown
        function toggleAudienceDropdown() {
            const dropdown = document.getElementById('audienceDropdown');
            const menu = document.getElementById('audienceDropdownMenu');

            if (!dropdown || !menu) return;

            const isOpen = menu.classList.contains('show');

            if (isOpen) {
                menu.classList.remove('show');
                dropdown.classList.remove('open');
            } else {
                renderAudienceDropdown();
                menu.classList.add('show');
                dropdown.classList.add('open');
            }
        }

        // Fermer le dropdown quand on clique ailleurs
        document.addEventListener('click', (e) => {
            const wrapper = document.querySelector('.audience-selector-wrapper');
            if (wrapper && !wrapper.contains(e.target)) {
                const menu = document.getElementById('audienceDropdownMenu');
                const dropdown = document.getElementById('audienceDropdown');
                if (menu) menu.classList.remove('show');
                if (dropdown) dropdown.classList.remove('open');
            }
        });

        // Rendre le dropdown avec les options
        function renderAudienceDropdown() {
            const menu = document.getElementById('audienceDropdownMenu');
            if (!menu) return;

            const personas = PersonasManager.personas || [];
            let html = '';

            // Personas personnalisés
            if (personas.length > 0) {
                personas.forEach(p => {
                    const isSelected = selectedAudienceType === 'persona' && selectedAudienceId === p.id;
                    html += `
                        <div class="audience-option ${isSelected ? 'selected' : ''}"
                             onclick="selectAudience('persona', '${p.id}')">
                            <span class="audience-option-emoji">${p.emoji || '🎯'}</span>
                            <div class="audience-option-info">
                                <div class="audience-option-name">
                                    ${p.name}
                                    ${p.is_default ? '<span class="audience-option-default">Par défaut</span>' : ''}
                                </div>
                                <div class="audience-option-desc">${p.description || ''}</div>
                            </div>
                        </div>
                    `;
                });

                html += '<div class="audience-divider"></div>';
            }

            // Audiences génériques
            GENERIC_AUDIENCES.forEach(g => {
                const isSelected = selectedAudienceType === 'generic' && selectedAudienceId === g.id;
                html += `
                    <div class="audience-option audience-option-generic ${isSelected ? 'selected' : ''}"
                         onclick="selectAudience('generic', '${g.id}')">
                        <span class="audience-option-emoji">${g.emoji}</span>
                        <div class="audience-option-info">
                            <div class="audience-option-name">${g.name}</div>
                            <div class="audience-option-desc">${g.description}</div>
                        </div>
                    </div>
                `;
            });

            // Option créer
            html += `
                <div class="audience-option audience-option-create" onclick="createAudienceFromWizard()">
                    <span class="audience-option-emoji">➕</span>
                    <div class="audience-option-info">
                        <div class="audience-option-name">Créer une nouvelle audience...</div>
                    </div>
                </div>
            `;

            menu.innerHTML = html;
        }

        // Sélectionner une audience
        function selectAudience(type, id) {
            selectedAudienceType = type;
            selectedAudienceId = id;

            // Mettre à jour l'affichage du dropdown
            const emojiEl = document.getElementById('audienceEmoji');
            const nameEl = document.getElementById('audienceName');
            const valueEl = document.getElementById('audienceValue');

            let audience = null;

            if (type === 'persona') {
                audience = PersonasManager.personas.find(p => p.id === id);
                if (audience) {
                    PersonasManager.select(audience);
                }
            } else if (type === 'generic') {
                audience = GENERIC_AUDIENCES.find(g => g.id === id);
            }

            if (audience) {
                if (emojiEl) emojiEl.textContent = audience.emoji || '🎯';
                if (nameEl) nameEl.textContent = audience.name;
                if (valueEl) valueEl.textContent = audience.name;
            }

            // Fermer le dropdown
            const menu = document.getElementById('audienceDropdownMenu');
            const dropdown = document.getElementById('audienceDropdown');
            if (menu) menu.classList.remove('show');
            if (dropdown) dropdown.classList.remove('open');

            // Mettre à jour l'aperçu
            updateAudiencePreview();
        }

        // Mettre à jour l'aperçu de l'audience
        function updateAudiencePreview() {
            const preview = document.getElementById('audiencePreview');
            const titleEl = document.getElementById('audiencePreviewTitle');
            const descEl = document.getElementById('audiencePreviewDesc');
            const tagsEl = document.getElementById('audiencePreviewTags');

            if (!preview) return;

            let audience = null;

            if (selectedAudienceType === 'persona') {
                audience = PersonasManager.personas.find(p => p.id === selectedAudienceId);
            } else if (selectedAudienceType === 'generic') {
                audience = GENERIC_AUDIENCES.find(g => g.id === selectedAudienceId);
            }

            if (!audience) {
                preview.classList.remove('show');
                return;
            }

            preview.classList.add('show');

            if (titleEl) titleEl.textContent = `${audience.emoji || '🎯'} ${audience.name}`;
            if (descEl) descEl.textContent = audience.description || '';

            // Tags pour les personas personnalisés
            if (tagsEl) {
                if (selectedAudienceType === 'persona' && audience.pain_points?.length > 0) {
                    tagsEl.innerHTML = audience.pain_points.slice(0, 3).map(p =>
                        `<span class="audience-preview-tag">😓 ${p}</span>`
                    ).join('');
                } else {
                    tagsEl.innerHTML = '';
                }
            }
        }

        // Créer une audience depuis le wizard
        function createAudienceFromWizard() {
            // Fermer le dropdown
            const menu = document.getElementById('audienceDropdownMenu');
            const dropdown = document.getElementById('audienceDropdown');
            if (menu) menu.classList.remove('show');
            if (dropdown) dropdown.classList.remove('open');

            // Ouvrir l'éditeur de persona
            openPersonaEditor();
        }

        // Initialiser le sélecteur d'audience au chargement
        function initAudienceSelector() {
            // Sélectionner le persona par défaut si disponible
            const defaultPersona = PersonasManager.getDefault();
            if (defaultPersona) {
                selectAudience('persona', defaultPersona.id);
            } else {
                // Sinon, sélectionner "Entrepreneurs" par défaut
                selectAudience('generic', 'entrepreneurs');
            }
        }

        // Obtenir le contexte audience pour les prompts
        function getAudienceContextForPrompt() {
            if (selectedAudienceType === 'persona') {
                return PersonasManager.getPromptContext();
            } else if (selectedAudienceType === 'generic') {
                const audience = GENERIC_AUDIENCES.find(g => g.id === selectedAudienceId);
                if (audience) {
                    return `
AUDIENCE CIBLE : ${audience.name}
Description : ${audience.description}
`;
                }
            }
            return '';
        }

        // ==================== WIDGET BONNES PRATIQUES ====================
        const CATEGORY_ICONS = {
            'algorithme': '🤖',
            'format': '📐',
            'timing': '⏰',
            'engagement': '💬',
            'erreurs': '⚠️',
            'copywriting': '✍️',
            'strategie': '🎯'
        };

        // Charger les bonnes pratiques depuis Supabase
        async function loadBonnesPratiques(platform, contentType = 'post') {
            const supabase = window.supabaseApp;
            if (!supabase) {
                console.warn('Supabase non disponible pour les bonnes pratiques');
                return [];
            }

            // Mapping type de contenu → catégories pertinentes
            const categoryMapping = {
                'post': ['algorithme', 'timing', 'engagement', 'copywriting'],
                'carousel': ['format', 'copywriting', 'engagement'],
                'story': ['format', 'engagement'],
                'video': ['format', 'algorithme'],
                'default': ['algorithme', 'engagement', 'erreurs']
            };

            const categories = categoryMapping[contentType] || categoryMapping['default'];

            try {
                const { data, error } = await supabase
                    .from('bonnes_pratiques')
                    .select('*')
                    .contains('platforms', [platform])
                    .in('category', categories)
                    .eq('is_active', true)
                    .order('confidence', { ascending: true })
                    .limit(5);

                if (error) {
                    console.warn('Erreur chargement bonnes pratiques:', error);
                    return [];
                }

                return (data || []).map(rule => ({
                    id: rule.id,
                    tip: rule.rule,
                    category: rule.category,
                    confidence: rule.confidence,
                    icon: CATEGORY_ICONS[rule.category] || '💡'
                }));
            } catch (e) {
                console.warn('Erreur bonnes pratiques:', e);
                return [];
            }
        }

        // Afficher le widget des bonnes pratiques
        async function displayTipsWidget() {
            const widget = document.getElementById('tipsWidget');
            const tipsList = document.getElementById('tipsList');
            if (!widget || !tipsList) return;

            // Déterminer le type de contenu
            let contentType = 'post';
            if (currentState.format === 'carousel') contentType = 'carousel';
            else if (currentState.format === 'story') contentType = 'story';
            else if (currentState.format === 'video') contentType = 'video';

            const tips = await loadBonnesPratiques(currentState.platform, contentType);

            if (tips.length === 0) {
                // Pas de tips, masquer le widget
                widget.style.display = 'none';
                return;
            }

            // Afficher les tips
            tipsList.innerHTML = tips.map(tip => `
                <div class="tip-item">
                    <span class="tip-icon">${tip.icon}</span>
                    <span class="tip-text">${tip.tip}</span>
                    ${tip.confidence === 'consensus' ? '<span class="tip-badge">✓ Vérifié</span>' : ''}
                </div>
            `).join('');

            widget.style.display = 'block';
            widget.classList.remove('collapsed');
        }

        // Toggle le widget
        function toggleTipsWidget() {
            const widget = document.getElementById('tipsWidget');
            if (widget) {
                widget.classList.toggle('collapsed');
                const btn = widget.querySelector('.tips-widget-toggle');
                if (btn) {
                    btn.textContent = widget.classList.contains('collapsed') ? 'Afficher' : 'Masquer';
                }
            }
        }

        // ==================== CONTEXTUAL REMINDER SYSTEM ====================
        const ContextualReminder = {
            currentIndex: 0,
            reminders: [],
            isVisible: false,
            hideTimeout: null,

            // Tips par plateforme
            PLATFORM_TIPS: {
                linkedin: [
                    { icon: '📏', text: 'LinkedIn : Les posts de <strong>1300-1500 caractères</strong> performent le mieux' },
                    { icon: '⏰', text: 'LinkedIn : Poste entre <strong>8h-9h</strong> ou <strong>12h-13h</strong> pour max de visibilité' },
                    { icon: '🚫', text: 'LinkedIn : <strong>Évite les liens</strong> dans le post, mets-les en commentaire' },
                    { icon: '💬', text: 'LinkedIn : <strong>Réponds aux commentaires</strong> dans la 1ère heure pour booster ta portée' },
                    { icon: '✏️', text: 'LinkedIn : <strong>Ne modifie pas</strong> ton post dans les 2h après publication' },
                    { icon: '🎯', text: 'LinkedIn : Une <strong>accroche forte</strong> = 80% du succès de ton post' },
                    { icon: '📸', text: 'LinkedIn : Les <strong>carrousels 8-12 slides</strong> génèrent plus d\'engagement' }
                ],
                instagram: [
                    { icon: '📸', text: 'Instagram : Les <strong>Reels</strong> ont 2x plus de portée que les posts classiques' },
                    { icon: '#️⃣', text: 'Instagram : Utilise <strong>3-5 hashtags</strong> pertinents maximum' },
                    { icon: '📝', text: 'Instagram : La légende doit faire <strong>150-200 caractères</strong> pour les posts feed' },
                    { icon: '🎨', text: 'Instagram : <strong>Cohérence visuelle</strong> = reconnaissance de marque' },
                    { icon: '📍', text: 'Instagram : Ajoute toujours une <strong>localisation</strong> pour +30% de reach' },
                    { icon: '⏰', text: 'Instagram : Poste quand <strong>ton audience est active</strong> (check tes stats)' }
                ],
                tiktok: [
                    { icon: '⚡', text: 'TikTok : Les <strong>3 premières secondes</strong> sont cruciales pour retenir' },
                    { icon: '🎵', text: 'TikTok : Utilise des <strong>sons tendance</strong> pour booster la découverte' },
                    { icon: '📱', text: 'TikTok : Filme toujours en <strong>vertical 9:16</strong>' },
                    { icon: '💬', text: 'TikTok : Pose une <strong>question</strong> pour inciter aux commentaires' },
                    { icon: '#️⃣', text: 'TikTok : <strong>3-5 hashtags</strong> dont 1-2 tendance' },
                    { icon: '🔄', text: 'TikTok : La <strong>régularité</strong> compte plus que la perfection' }
                ],
                twitter: [
                    { icon: '🧵', text: 'X/Twitter : Les <strong>threads</strong> génèrent 10x plus d\'engagement' },
                    { icon: '📏', text: 'X/Twitter : <strong>280 caractères max</strong>, mais les tweets courts marchent mieux' },
                    { icon: '🔄', text: 'X/Twitter : <strong>Retweet + citation</strong> > simple retweet' },
                    { icon: '⏰', text: 'X/Twitter : Les tweets du <strong>matin (7h-9h)</strong> performent mieux' }
                ],
                facebook: [
                    { icon: '🎥', text: 'Facebook : Les <strong>vidéos natives</strong> ont 10x plus de portée que les liens YouTube' },
                    { icon: '👥', text: 'Facebook : Les <strong>groupes</strong> ont plus de reach que les pages' },
                    { icon: '📸', text: 'Facebook : Posts avec <strong>images</strong> = 2.3x plus d\'engagement' },
                    { icon: '⏰', text: 'Facebook : Meilleurs créneaux : <strong>13h-16h</strong> en semaine' }
                ],
                newsletter: [
                    { icon: '📧', text: 'Newsletter : <strong>Objet de 40-50 caractères</strong> pour éviter la troncature' },
                    { icon: '👤', text: 'Newsletter : La <strong>personnalisation</strong> augmente l\'ouverture de 26%' },
                    { icon: '⏰', text: 'Newsletter : Envoie le <strong>mardi ou jeudi matin</strong>' },
                    { icon: '📱', text: 'Newsletter : <strong>60% des emails</strong> sont lus sur mobile' }
                ]
            },

            // Tips généraux (quand pas de plateforme sélectionnée)
            GENERAL_TIPS: [
                { icon: '🎯', text: 'Sélectionne une <strong>plateforme</strong> pour des conseils personnalisés' },
                { icon: '👥', text: 'Définis ton <strong>audience cible</strong> dans "Ton audience"' },
                { icon: '✨', text: 'Une bonne <strong>accroche</strong> = 80% du succès de ton contenu' },
                { icon: '📊', text: 'La <strong>régularité</strong> bat la perfection, chaque fois' }
            ],

            // Initialiser avec la plateforme actuelle
            init() {
                this.updateForPlatform(currentState.platform);
                // Afficher après un court délai
                setTimeout(() => this.show(), 2000);
            },

            // Mettre à jour les tips selon la plateforme
            updateForPlatform(platform) {
                this.reminders = this.PLATFORM_TIPS[platform] || this.GENERAL_TIPS;
                this.currentIndex = 0;
                this.render();
            },

            // Afficher le reminder actuel
            render() {
                const reminder = this.reminders[this.currentIndex];
                if (!reminder) return;

                document.getElementById('reminderIcon').textContent = reminder.icon;
                document.getElementById('reminderText').innerHTML = reminder.text;
            },

            // Afficher la barre
            show() {
                const bar = document.getElementById('contextualReminder');
                if (bar && !this.isHiddenByUser()) {
                    bar.classList.add('visible');
                    this.isVisible = true;
                    this.startAutoRotate();
                }
            },

            // Cacher la barre
            hide() {
                const bar = document.getElementById('contextualReminder');
                if (bar) {
                    bar.classList.remove('visible');
                    this.isVisible = false;
                    this.stopAutoRotate();
                    // Mémoriser que l'utilisateur a fermé (pour cette session)
                    sessionStorage.setItem('reminder_hidden', 'true');
                }
            },

            // Vérifier si caché par l'utilisateur
            isHiddenByUser() {
                return sessionStorage.getItem('reminder_hidden') === 'true';
            },

            // Tip suivant
            next() {
                this.currentIndex = (this.currentIndex + 1) % this.reminders.length;
                this.render();
            },

            // Tip précédent
            prev() {
                this.currentIndex = (this.currentIndex - 1 + this.reminders.length) % this.reminders.length;
                this.render();
            },

            // Rotation automatique
            startAutoRotate() {
                this.stopAutoRotate();
                this.autoRotateInterval = setInterval(() => {
                    this.next();
                }, 8000); // Change toutes les 8 secondes
            },

            stopAutoRotate() {
                if (this.autoRotateInterval) {
                    clearInterval(this.autoRotateInterval);
                }
            }
        };

        // Fonctions globales pour les boutons
        function hideReminder() { ContextualReminder.hide(); }
        function nextReminder() { ContextualReminder.next(); }
        function prevReminder() { ContextualReminder.prev(); }

        // Callback après sauvegarde du profil
        let onboardingCallback = null;

        // Stocker l'objectif choisi (Vendre vs Expertise)
        let userStrategyObjective = 'vendre'; // défaut

        function selectObjective(objective) {
            userStrategyObjective = objective;

            // UI feedback
            document.querySelectorAll('.objective-card').forEach(card => {
                card.classList.remove('selected', 'vendre', 'expertise');
            });
            const selectedCard = document.querySelector(`.objective-card[data-objective="${objective}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected', objective);
            }
        }

        // Mettre à jour les options du sélecteur de jours selon l'objectif
        function updateStrategyDaysForObjective(objective) {
            const daySelect = document.getElementById('strategyDay');
            if (!daySelect) return;

            const days = objective === 'expertise' ? STRATEGY_DAYS_EXPERTISE : STRATEGY_DAYS_VENDRE;

            daySelect.innerHTML = Object.entries(days).map(([num, data]) =>
                `<option value="${num}">Jour ${num} — ${data.title}</option>`
            ).join('');
        }

        function handleOnboardingSubmit(e) {
            e.preventDefault();
            const nom = document.getElementById('onb-nom').value.trim();
            if (!nom) { alert('Merci de renseigner au moins ton prénom 😊'); return; }

            const profile = {
                nom,
                domaine: document.getElementById('onb-domaine').value.trim(),
                messageUnique: document.getElementById('onb-messageUnique').value.trim(),
                piliers: document.getElementById('onb-piliers').value.split(',').map(p => p.trim()).filter(p => p),
                tags: document.getElementById('onb-tags').value.trim(),
                problematique: document.getElementById('onb-problematique').value.trim(),
                precisions: document.getElementById('onb-precisions').value.trim(),
                publicCible: Array.from(document.querySelectorAll('input[name="publicCible"]:checked')).map(cb => cb.value),
                trancheAge: Array.from(document.querySelectorAll('input[name="trancheAge"]:checked')).map(cb => cb.value),
                niveau: document.querySelector('input[name="niveau"]:checked')?.value || '',
                style: document.querySelector('input[name="style"]:checked')?.value || '',
                objectif: document.querySelector('input[name="objectif"]:checked')?.value || '',
                strategyObjective: userStrategyObjective // Vendre ou Expertise
            };

            UserProfile.save(profile);
            closeOnboarding();
            showOnboardingNotification(`✨ Profil sauvegardé, ${nom} !`);

            // Adapter les 20 jours selon l'objectif choisi
            updateStrategyDaysForObjective(userStrategyObjective);

            // MISE À JOUR AUTOMATIQUE DE LA CONFIG
            if (typeof refreshConfigFromProfile === 'function') {
                refreshConfigFromProfile();
            }

            // Exécuter le callback si défini (retour au wizard)
            if (onboardingCallback) {
                const callback = onboardingCallback;
                onboardingCallback = null;
                setTimeout(() => callback(), 400);
            }
        }

        function closeOnboarding() {
            const overlay = document.getElementById('onboardingOverlay');
            if (overlay) {
                overlay.classList.remove('active');
                setTimeout(() => overlay.remove(), 300);
            }
        }

        function showOnboardingNotification(message) {
            const notif = document.createElement('div');
            notif.className = 'onboarding-notif';
            notif.innerHTML = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.classList.add('active'), 10);
            setTimeout(() => { notif.classList.remove('active'); setTimeout(() => notif.remove(), 300); }, 3000);
        }

        window.Onboarding = {
            show: showOnboarding,
            close: closeOnboarding,
            edit: () => showOnboarding(true),
            check: () => { if (!UserProfile.hasValid()) showOnboarding(false); else updateProfileButton(); },
            forceShow: () => showOnboarding(true),
            // Ouvrir le profil avec callback après sauvegarde
            openWithCallback: (callback) => {
                onboardingCallback = callback;
                showOnboarding(true);
            }
        };

        // ==================== SUPABASE ANALYTICS ====================
        // Utilise CONFIG depuis config.js

        const Analytics = {
            supabase: null,
            userId: null,
            userEmail: null,
            SESSION_KEY: 'sos_user_session',

            init() {
                try {
                    // Utiliser l'instance Supabase globale déjà créée
                    this.supabase = window.supabaseApp || null;
                    this.loadSession();
                    console.log('📊 Analytics initialisé');
                } catch (e) {
                    console.warn('Analytics non disponible:', e);
                }
            },

            loadSession() {
                const session = localStorage.getItem(this.SESSION_KEY);
                if (session) {
                    const data = JSON.parse(session);
                    this.userId = data.userId;
                    this.userEmail = data.email;
                }
            },

            saveSession(userId, email) {
                this.userId = userId;
                this.userEmail = email;
                localStorage.setItem(this.SESSION_KEY, JSON.stringify({ userId, email }));
            },

            isRegistered() {
                return !!this.userId;
            },

            // Inscription / Connexion utilisateur
            async registerUser(email, name = null) {
                if (!this.supabase) return null;
                
                try {
                    // Chercher si l'utilisateur existe
                    const { data: existing } = await this.supabase
                        .from('users')
                        .select('id')
                        .eq('email', email.toLowerCase())
                        .single();

                    if (existing) {
                        // Mise à jour last_login
                        await this.supabase
                            .from('users')
                            .update({ last_login: new Date().toISOString() })
                            .eq('id', existing.id);
                        
                        this.saveSession(existing.id, email);
                        return existing.id;
                    }

                    // Créer nouvel utilisateur
                    const { data: newUser, error } = await this.supabase
                        .from('users')
                        .insert({
                            email: email.toLowerCase(),
                            name: name,
                            plan: 'free'
                        })
                        .select('id')
                        .single();

                    if (error) throw error;
                    
                    this.saveSession(newUser.id, email);
                    console.log('✅ Utilisateur créé:', newUser.id);
                    return newUser.id;

                } catch (e) {
                    console.error('Erreur inscription:', e);
                    return null;
                }
            },

            // Tracker un contenu généré
            async trackContent(structure, platform, format, pillar = null, contentType = 'organic') {
                if (!this.supabase || !this.userId) return;

                try {
                    await this.supabase.from('contents').insert({
                        user_id: this.userId,
                        structure: structure,
                        platform: platform,
                        format: format,
                        pillar: pillar,
                        content_type: contentType
                    });

                    // Mettre à jour le compteur
                    await this.supabase.rpc('increment_user_contents', { user_id_param: this.userId });
                    
                    console.log('📊 Contenu tracké');
                } catch (e) {
                    console.warn('Erreur tracking:', e);
                }
            },

            // Tracker un événement
            async trackEvent(eventType, eventData = {}) {
                if (!this.supabase || !this.userId) return;

                try {
                    await this.supabase.from('events').insert({
                        user_id: this.userId,
                        event_type: eventType,
                        event_data: eventData
                    });
                } catch (e) {
                    console.warn('Erreur event:', e);
                }
            },

            // Utiliser un code promo
            async usePromoCode(code) {
                if (!this.supabase || !this.userId) {
                    return { success: false, message: 'Non connecté' };
                }

                try {
                    const { data, error } = await this.supabase
                        .rpc('use_promo_code', {
                            p_user_id: this.userId,
                            p_code: code.toUpperCase()
                        });

                    if (error) throw error;
                    
                    if (data && data[0]) {
                        return data[0];
                    }
                    return { success: false, message: 'Erreur inconnue' };

                } catch (e) {
                    console.error('Erreur code promo:', e);
                    return { success: false, message: e.message };
                }
            },

            // Vérifier le plan de l'utilisateur
            async getUserPlan() {
                if (!this.supabase || !this.userId) return 'free';

                try {
                    const { data } = await this.supabase
                        .from('users')
                        .select('plan')
                        .eq('id', this.userId)
                        .single();

                    return data?.plan || 'free';
                } catch (e) {
                    return 'free';
                }
            }
        };

        // Initialiser Analytics au chargement
        Analytics.init();

        // ==================== GESTIONNAIRE DE PERSONAS ====================
        const PersonasManager = {
            CACHE_KEY: 'sos_personas_cache',
            personas: [],
            selectedPersona: null,
            isLoaded: false,

            // Initialisation
            async init() {
                await this.loadPersonas();
                this.loadSelectedFromStorage();
                console.log('👥 PersonasManager initialisé');
            },

            // Récupérer le client Supabase
            getSupabase() {
                return window.supabaseApp;
            },

            // Récupérer l'utilisateur connecté
            async getCurrentUserId() {
                const supabase = this.getSupabase();
                if (!supabase) return null;
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    return user?.id || null;
                } catch (e) {
                    console.warn('Erreur auth:', e);
                    return null;
                }
            },

            // Charger tous les personas de l'utilisateur
            async loadPersonas() {
                const supabase = this.getSupabase();
                const userId = await this.getCurrentUserId();

                if (!supabase || !userId) {
                    // Charger depuis le cache local si pas connecté
                    const cached = localStorage.getItem(this.CACHE_KEY);
                    if (cached) {
                        this.personas = JSON.parse(cached);
                    }
                    this.isLoaded = true;
                    return this.personas;
                }

                try {
                    const { data, error } = await supabase
                        .from('audience_personas')
                        .select('*')
                        .eq('user_id', userId)
                        .order('is_default', { ascending: false })
                        .order('usage_count', { ascending: false });

                    if (error) throw error;

                    this.personas = data || [];
                    // Mettre en cache
                    localStorage.setItem(this.CACHE_KEY, JSON.stringify(this.personas));
                    this.isLoaded = true;
                    return this.personas;
                } catch (e) {
                    console.error('Erreur chargement personas:', e);
                    this.isLoaded = true;
                    return [];
                }
            },

            // Créer un nouveau persona
            async create(personaData) {
                const supabase = this.getSupabase();
                const userId = await this.getCurrentUserId();

                if (!supabase || !userId) {
                    showToast('❌ Connexion requise pour créer un persona');
                    return null;
                }

                try {
                    const { data, error } = await supabase
                        .from('audience_personas')
                        .insert({
                            user_id: userId,
                            ...personaData
                        })
                        .select()
                        .single();

                    if (error) throw error;

                    this.personas.unshift(data);
                    localStorage.setItem(this.CACHE_KEY, JSON.stringify(this.personas));
                    showToast('✅ Persona créé !');
                    return data;
                } catch (e) {
                    console.error('Erreur création persona:', e);
                    showToast('❌ Erreur lors de la création');
                    return null;
                }
            },

            // Mettre à jour un persona
            async update(personaId, updates) {
                const supabase = this.getSupabase();

                if (!supabase) {
                    showToast('❌ Connexion requise');
                    return null;
                }

                try {
                    const { data, error } = await supabase
                        .from('audience_personas')
                        .update(updates)
                        .eq('id', personaId)
                        .select()
                        .single();

                    if (error) throw error;

                    // Mettre à jour le cache local
                    const index = this.personas.findIndex(p => p.id === personaId);
                    if (index !== -1) {
                        this.personas[index] = data;
                        localStorage.setItem(this.CACHE_KEY, JSON.stringify(this.personas));
                    }

                    showToast('✅ Persona mis à jour !');
                    return data;
                } catch (e) {
                    console.error('Erreur mise à jour persona:', e);
                    showToast('❌ Erreur lors de la mise à jour');
                    return null;
                }
            },

            // Supprimer un persona
            async delete(personaId) {
                const supabase = this.getSupabase();

                if (!supabase) {
                    showToast('❌ Connexion requise');
                    return false;
                }

                try {
                    const { error } = await supabase
                        .from('audience_personas')
                        .delete()
                        .eq('id', personaId);

                    if (error) throw error;

                    this.personas = this.personas.filter(p => p.id !== personaId);
                    localStorage.setItem(this.CACHE_KEY, JSON.stringify(this.personas));

                    // Désélectionner si c'était le persona sélectionné
                    if (this.selectedPersona?.id === personaId) {
                        this.selectedPersona = null;
                        localStorage.removeItem('sos_selected_persona');
                    }

                    showToast('✅ Persona supprimé !');
                    return true;
                } catch (e) {
                    console.error('Erreur suppression persona:', e);
                    showToast('❌ Erreur lors de la suppression');
                    return false;
                }
            },

            // Dupliquer un persona
            async duplicate(personaId) {
                const persona = this.personas.find(p => p.id === personaId);
                if (!persona) return null;

                const duplicate = {
                    name: persona.name + ' (copie)',
                    emoji: persona.emoji,
                    description: persona.description,
                    age_range: persona.age_range,
                    location: persona.location,
                    pain_points: persona.pain_points,
                    desires: persona.desires,
                    vocabulary: persona.vocabulary,
                    tone_preferences: persona.tone_preferences,
                    primary_platform: persona.primary_platform,
                    content_preferences: persona.content_preferences,
                    is_default: false
                };

                return await this.create(duplicate);
            },

            // Définir comme persona par défaut
            async setAsDefault(personaId) {
                return await this.update(personaId, { is_default: true });
            },

            // Incrémenter le compteur d'utilisation
            async incrementUsage(personaId) {
                const supabase = this.getSupabase();
                if (!supabase) return;

                try {
                    await supabase.rpc('increment_persona_usage', { persona_id: personaId });
                } catch (e) {
                    console.warn('Erreur increment usage:', e);
                }
            },

            // Sélectionner un persona pour la session
            select(persona) {
                this.selectedPersona = persona;
                if (persona) {
                    localStorage.setItem('sos_selected_persona', JSON.stringify(persona));
                    this.incrementUsage(persona.id);
                } else {
                    localStorage.removeItem('sos_selected_persona');
                }
            },

            // Charger le persona sélectionné depuis le storage
            loadSelectedFromStorage() {
                const stored = localStorage.getItem('sos_selected_persona');
                if (stored) {
                    try {
                        this.selectedPersona = JSON.parse(stored);
                    } catch (e) {
                        this.selectedPersona = null;
                    }
                }
            },

            // Obtenir le persona par défaut
            getDefault() {
                return this.personas.find(p => p.is_default) || this.personas[0] || null;
            },

            // Obtenir le persona sélectionné ou le défaut
            getSelected() {
                return this.selectedPersona || this.getDefault();
            },

            // Générer le contexte pour le prompt IA
            getPromptContext() {
                const persona = this.getSelected();
                if (!persona) return '';

                let context = `
AUDIENCE CIBLE : ${persona.name}
Description : ${persona.description || 'Non spécifiée'}
`;

                if (persona.age_range || persona.location) {
                    context += `
CARACTERISTIQUES :
${persona.age_range ? `- Tranche d'âge : ${persona.age_range}` : ''}
${persona.location ? `- Localisation : ${persona.location}` : ''}
`;
                }

                if (persona.pain_points?.length > 0) {
                    context += `
LEURS PROBLEMES (à adresser dans le contenu) :
${persona.pain_points.map(p => `- ${p}`).join('\n')}
`;
                }

                if (persona.desires?.length > 0) {
                    context += `
CE QU'ILS VEULENT (promesse implicite) :
${persona.desires.map(d => `- ${d}`).join('\n')}
`;
                }

                if (persona.tone_preferences) {
                    context += `
TON A ADOPTER :
${persona.tone_preferences}
`;
                }

                if (persona.vocabulary?.length > 0) {
                    context += `
VOCABULAIRE A PRIVILEGIER :
${persona.vocabulary.join(', ')}
`;
                }

                return context;
            }
        };

        // Initialiser PersonasManager
        PersonasManager.init();

        // ==================== SYSTÈME DE PROGRESSION ====================
        const ProgressionSystem = {
            KEY: 'tithot_progression',
            
            getDefault() {
                return {
                    xp: 0,
                    level: 1,
                    totalContents: 0,
                    byPlatform: {},
                    byFormat: {},
                    badges: [],
                    streak: 0,
                    lastContentDate: null,
                    firstContentDate: null
                };
            },
            
            get() {
                return JSON.parse(localStorage.getItem(this.KEY)) || this.getDefault();
            },
            
            save(data) {
                localStorage.setItem(this.KEY, JSON.stringify(data));
            },
            
            // Ajouter XP et vérifier level up
            addXP(amount) {
                const data = this.get();
                data.xp += amount;
                const newLevel = Math.floor(data.xp / 100) + 1;
                const leveledUp = newLevel > data.level;
                data.level = newLevel;
                this.save(data);
                if (leveledUp) this.showLevelUp(newLevel);
                return leveledUp;
            },
            
            // Enregistrer un contenu créé
            trackContent(platform, format) {
                const data = this.get();
                const today = new Date().toDateString();
                
                // Premier contenu ?
                if (!data.firstContentDate) data.firstContentDate = new Date().toISOString();
                
                // Streak
                if (data.lastContentDate) {
                    const last = new Date(data.lastContentDate).toDateString();
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    if (last === yesterday) {
                        data.streak++;
                    } else if (last !== today) {
                        data.streak = 1;
                    }
                } else {
                    data.streak = 1;
                }
                data.lastContentDate = new Date().toISOString();
                
                // Compteurs
                data.totalContents++;
                data.byPlatform[platform] = (data.byPlatform[platform] || 0) + 1;
                data.byFormat[format] = (data.byFormat[format] || 0) + 1;
                
                this.save(data);
                this.addXP(10);
                this.checkBadges();
                this.updateMiniStats();
            },
            
            // Définition des badges
            BADGES: [
                { id: 'first', icon: '🌱', name: 'Premier Pas', desc: '1er contenu créé', check: d => d.totalContents >= 1 },
                { id: 'fire5', icon: '🔥', name: 'On Fire', desc: '5 contenus créés', check: d => d.totalContents >= 5 },
                { id: 'productive', icon: '⚡', name: 'Productif', desc: '20 contenus créés', check: d => d.totalContents >= 20 },
                { id: 'machine', icon: '🚀', name: 'Machine à contenu', desc: '50 contenus créés', check: d => d.totalContents >= 50 },
                { id: 'legend', icon: '👑', name: 'Légende', desc: '100 contenus créés', check: d => d.totalContents >= 100 },
                { id: 'carousel', icon: '🎠', name: 'Roi du Carousel', desc: '10 carousels', check: d => (d.byFormat['carousel'] || 0) >= 10 },
                { id: 'reel', icon: '🎬', name: 'Star du Reel', desc: '10 reels', check: d => (d.byFormat['reel'] || 0) >= 10 },
                { id: 'linkedin', icon: '💼', name: 'LinkedIn Master', desc: '20 posts LinkedIn', check: d => (d.byPlatform['linkedin'] || 0) >= 20 },
                { id: 'insta', icon: '📸', name: 'Insta Pro', desc: '20 posts Instagram', check: d => (d.byPlatform['instagram'] || 0) >= 20 },
                { id: 'streak7', icon: '🔥', name: 'Streak 7', desc: '7 jours consécutifs', check: d => d.streak >= 7 },
                { id: 'streak30', icon: '🌟', name: 'Streak 30', desc: '30 jours consécutifs', check: d => d.streak >= 30 }
            ],
            
            checkBadges() {
                const data = this.get();
                let newBadges = [];
                
                this.BADGES.forEach(badge => {
                    if (!data.badges.includes(badge.id) && badge.check(data)) {
                        data.badges.push(badge.id);
                        newBadges.push(badge);
                        data.xp += 25; // Bonus XP
                    }
                });
                
                this.save(data);
                newBadges.forEach(b => this.showBadgeUnlock(b));
            },
            
            showBadgeUnlock(badge) {
                const div = document.createElement('div');
                div.className = 'badge-unlock';
                div.innerHTML = `
                    <div class="badge-unlock-icon">${badge.icon}</div>
                    <div class="badge-unlock-text">
                        <strong>Badge débloqué !</strong>
                        <span>${badge.name}</span>
                    </div>
                `;
                document.body.appendChild(div);
                setTimeout(() => div.classList.add('show'), 100);
                setTimeout(() => { div.classList.remove('show'); setTimeout(() => div.remove(), 500); }, 3000);
            },
            
            showLevelUp(level) {
                showToast('🎉 ' + t('toasts.level_up').replace('{level}', level));
            },
            
            // Afficher le modal stats
            showStats() {
                const data = this.get();
                const xpForNext = (data.level * 100) - data.xp % 100;
                const xpProgress = (data.xp % 100);
                
                let badgesHTML = this.BADGES.map(b => {
                    const unlocked = data.badges.includes(b.id);
                    return `<div class="stat-badge ${unlocked ? 'unlocked' : 'locked'}" title="${b.desc}">
                        <span class="stat-badge-icon">${b.icon}</span>
                        <span class="stat-badge-name">${b.name}</span>
                    </div>`;
                }).join('');
                
                const platformStats = Object.entries(data.byPlatform).map(([k,v]) => `<div class="stat-item"><span>${PLATFORMS[k]?.name || k}</span><strong>${v}</strong></div>`).join('') || '<p style="color:#999;">Aucun contenu</p>';
                const formatStats = Object.entries(data.byFormat).map(([k,v]) => `<div class="stat-item"><span>${FORMATS[k]?.name || k}</span><strong>${v}</strong></div>`).join('') || '<p style="color:#999;">Aucun contenu</p>';
                
                // Mode Agence
                const agencyData = AgencySystem.get();
                const agencySection = agencyData.isAgency 
                    ? `<div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="AgencySystem.showDashboard()" style="background: linear-gradient(135deg, #11998e, #38ef7d); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-family: inherit; font-weight: 600;">
                            📊 Dashboard Agence
                        </button>
                        <button onclick="AgencySystem.deactivate()" style="background: none; border: 2px solid #ff6b6b; color: #ff6b6b; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-family: inherit; font-weight: 600;">
                            ❌ Désactiver
                        </button>
                    </div>`
                    : `<button onclick="AgencySystem.showUnlockModal()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-family: inherit; font-weight: 600;">
                        🔐 Débloquer le Mode Agence
                    </button>`;
                
                document.getElementById('statsContent').innerHTML = `
                    <div class="stats-header">
                        <div class="stats-level">
                            <div class="stats-level-number">Niveau ${data.level}</div>
                            <div class="stats-xp-bar">
                                <div class="stats-xp-fill" style="width: ${xpProgress}%"></div>
                            </div>
                            <div class="stats-xp-text">${data.xp} XP • ${xpForNext} XP pour niveau ${data.level + 1}</div>
                        </div>
                        <div class="stats-streak">
                            <div class="stats-streak-number">${data.streak}</div>
                            <div class="stats-streak-label">🔥 Streak jours</div>
                        </div>
                    </div>
                    
                    <div class="stats-total">
                        <span class="stats-total-number">${data.totalContents}</span>
                        <span class="stats-total-label">contenus créés</span>
                    </div>
                    
                    <h3 style="margin: 20px 0 10px; color: #333;">🏆 Badges</h3>
                    <div class="stats-badges">${badgesHTML}</div>
                    
                    <h3 style="margin: 20px 0 10px; color: #333;">📱 Par plateforme</h3>
                    <div class="stats-grid">${platformStats}</div>
                    
                    <h3 style="margin: 20px 0 10px; color: #333;">🎬 Par format</h3>
                    <div class="stats-grid">${formatStats}</div>
                    
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 2px dashed #e0e0e0;">
                        <h3 style="margin: 0 0 15px; color: #333; text-align: center;">🏢 Mode Agence</h3>
                        <p style="color: #666; font-size: 0.9em; text-align: center; margin-bottom: 15px;">
                            Gérez plusieurs clients, importez des CSV, suivez vos productions.
                        </p>
                        <div style="text-align: center;">
                            ${agencySection}
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 2px dashed #e0e0e0;">
                        <h3 style="margin: 0 0 15px; color: #333; text-align: center;">🎯 Mes Objectifs</h3>
                        <p style="color: #666; font-size: 0.9em; text-align: center; margin-bottom: 15px;">
                            Fixe-toi un objectif et suis ta progression en temps réel.
                        </p>
                        <div style="text-align: center;">
                            <button onclick="document.getElementById('statsModal').classList.remove('show'); GoalsSystem.showDashboard();" style="background: linear-gradient(135deg, #11998e, #38ef7d); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-family: inherit; font-weight: 600; transition: all 0.2s;">
                                🎯 Voir mes objectifs
                            </button>
                        </div>
                    </div>

                    <div style="margin-top: 20px; text-align: center; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="document.getElementById('statsModal').classList.remove('show'); restartTour();" style="background: none; border: 2px dashed #667eea; color: #667eea; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-family: inherit; font-weight: 600; transition: all 0.3s;">
                            🎯 Refaire le tour guidé
                        </button>
                        <button onclick="document.getElementById('statsModal').classList.remove('show'); resetGuidedHelp();" style="background: none; border: 2px dashed #11998e; color: #11998e; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-family: inherit; font-weight: 600; transition: all 0.3s;">
                            🎉 Revoir le popup d'accueil
                        </button>
                    </div>
                `;
                document.getElementById('statsModal').classList.add('show');
            },

            // Mettre à jour la mini-bannière de stats
            updateMiniStats() {
                const data = this.get();
                const totalContentsEl = document.getElementById('statTotalContents');
                const structuresUsedEl = document.getElementById('statStructuresUsed');
                const lastActionEl = document.getElementById('statLastAction');

                if (totalContentsEl) {
                    totalContentsEl.textContent = data.totalContents || 0;
                }

                if (structuresUsedEl) {
                    // Compter le nombre de structures différentes utilisées
                    const structuresCount = Object.keys(data.byFormat || {}).length;
                    structuresUsedEl.textContent = structuresCount;
                }

                if (lastActionEl) {
                    if (data.lastContentDate) {
                        const lastDate = new Date(data.lastContentDate);
                        const now = new Date();
                        const diffMs = now - lastDate;
                        const diffMins = Math.floor(diffMs / 60000);
                        const diffHours = Math.floor(diffMs / 3600000);
                        const diffDays = Math.floor(diffMs / 86400000);

                        let timeAgo;
                        if (diffMins < 1) {
                            timeAgo = "À l'instant";
                        } else if (diffMins < 60) {
                            timeAgo = `Il y a ${diffMins} min`;
                        } else if (diffHours < 24) {
                            timeAgo = `Il y a ${diffHours}h`;
                        } else if (diffDays === 1) {
                            timeAgo = "Hier";
                        } else if (diffDays < 7) {
                            timeAgo = `Il y a ${diffDays} jours`;
                        } else {
                            timeAgo = lastDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
                        }
                        lastActionEl.innerHTML = `🕐 ${timeAgo}`;
                    } else {
                        lastActionEl.innerHTML = '🕐 Première création ?';
                    }
                }
            }
        };

        // ==================== SYSTÈME DERNIER CONTENU ====================
        const LastContentManager = {
            KEY: 'tithot_last_content',

            save(content, platform, format, structure) {
                const data = {
                    content: content,
                    platform: platform,
                    format: format,
                    structure: structure,
                    date: new Date().toISOString()
                };
                localStorage.setItem(this.KEY, JSON.stringify(data));
                this.updateButton();
            },

            get() {
                try {
                    return JSON.parse(localStorage.getItem(this.KEY));
                } catch (e) {
                    return null;
                }
            },

            updateButton() {
                const btn = document.getElementById('resumeLastBtn');
                if (!btn) return;
                const data = this.get();
                if (data && data.content) {
                    btn.style.display = 'inline-flex';
                } else {
                    btn.style.display = 'none';
                }
            }
        };

        // Fonction globale pour reprendre le dernier contenu
        function resumeLastContent() {
            const data = LastContentManager.get();
            if (!data || !data.content) {
                showToast('❌ Aucun contenu à reprendre');
                return;
            }

            // Restaurer l'état
            if (data.platform && PLATFORMS[data.platform]) {
                selectPlatform(data.platform);
            }
            if (data.format && FORMATS[data.format]) {
                selectFormat(data.format);
            }
            if (data.structure) {
                selectStructure(data.structure);
            }

            // Afficher le contenu
            currentState.generatedContent = data.content;
            const outputContent = document.getElementById('outputContent');
            if (outputContent) {
                outputContent.innerHTML = `<div class="output-text">${formatResponse(data.content)}</div>`;
            }

            // Afficher les boutons d'action
            const actionButtons = document.getElementById('actionButtons');
            if (actionButtons) actionButtons.style.display = 'flex';
            const visualSection = document.getElementById('visualSection');
            if (visualSection) visualSection.style.display = 'block';

            showToast('✅ Contenu restauré !');
        }

        // ==================== SYSTÈME OBJECTIFS (GAMIFICATION) ====================
        const GoalsSystem = {
            KEY: 'tithot_goals',

            getDefault() {
                return {
                    currentGoal: null, // { platform, metric, target, startValue, deadline, createdAt }
                    history: [], // [{ date, value, metric }]
                    completedGoals: []
                };
            },

            get() {
                try {
                    const data = localStorage.getItem(this.KEY);
                    return data ? { ...this.getDefault(), ...JSON.parse(data) } : this.getDefault();
                } catch (e) {
                    return this.getDefault();
                }
            },

            save(data) {
                localStorage.setItem(this.KEY, JSON.stringify(data));
            },

            // Définir un nouvel objectif
            setGoal(platform, metric, target, deadline) {
                const data = this.get();
                const progression = ProgressionSystem.get();

                // Valeur de départ selon la métrique
                let startValue = 0;
                if (metric === 'followers') {
                    startValue = 0; // L'utilisateur devra entrer sa valeur actuelle
                } else if (metric === 'posts') {
                    startValue = progression.byPlatform[platform] || 0;
                } else if (metric === 'audits') {
                    startValue = parseInt(localStorage.getItem('tithot_audits_count') || '0');
                }

                data.currentGoal = {
                    platform,
                    metric,
                    target: parseInt(target),
                    startValue,
                    currentValue: startValue,
                    deadline,
                    createdAt: new Date().toISOString()
                };

                this.save(data);
                this.showDashboard();
            },

            // Mettre à jour la valeur actuelle (pour les followers, saisie manuelle)
            updateCurrentValue(value) {
                const data = this.get();
                if (!data.currentGoal) return;

                data.currentGoal.currentValue = parseInt(value);
                data.history.push({
                    date: new Date().toISOString(),
                    value: parseInt(value),
                    metric: data.currentGoal.metric
                });

                // Vérifier si objectif atteint
                if (data.currentGoal.currentValue >= data.currentGoal.target) {
                    data.completedGoals.push({
                        ...data.currentGoal,
                        completedAt: new Date().toISOString()
                    });
                    showToast('🎉 Félicitations ! Objectif atteint !');
                }

                this.save(data);
                this.showDashboard();
            },

            // Supprimer l'objectif en cours
            deleteGoal() {
                const data = this.get();
                data.currentGoal = null;
                this.save(data);
                this.showDashboard();
            },

            // Obtenir les statistiques d'actions
            getActionStats() {
                const progression = ProgressionSystem.get();
                const goalsData = this.get();
                const goal = goalsData.currentGoal;

                // Si pas d'objectif, retourner les stats globales
                if (!goal) {
                    return {
                        postsCreated: progression.totalContents,
                        auditsRun: parseInt(localStorage.getItem('tithot_audits_count') || '0'),
                        daysActive: progression.streak,
                        profileAudits: parseInt(localStorage.getItem('tithot_profile_audits') || '0')
                    };
                }

                // Stats depuis le début de l'objectif
                const startDate = new Date(goal.createdAt);

                return {
                    postsCreated: progression.totalContents - (goal.startPostsCount || 0),
                    auditsRun: parseInt(localStorage.getItem('tithot_audits_count') || '0') - (goal.startAuditsCount || 0),
                    daysActive: Math.ceil((Date.now() - startDate.getTime()) / (1000 * 60 * 60 * 24)),
                    profileAudits: parseInt(localStorage.getItem('tithot_profile_audits') || '0')
                };
            },

            // Obtenir un message de motivation
            getMotivation(progress) {
                const messages = [
                    { min: 0, max: 10, icon: '🚀', text: 'Tu viens de commencer, chaque petit pas compte !' },
                    { min: 10, max: 25, icon: '💪', text: 'Beau début ! Continue sur cette lancée.' },
                    { min: 25, max: 50, icon: '🔥', text: 'Tu es sur la bonne voie, ne lâche rien !' },
                    { min: 50, max: 75, icon: '⭐', text: 'Plus de la moitié ! Tu y es presque.' },
                    { min: 75, max: 90, icon: '🌟', text: 'La ligne d\'arrivée est en vue !' },
                    { min: 90, max: 100, icon: '🎯', text: 'Dernière ligne droite, tu vas y arriver !' },
                    { min: 100, max: Infinity, icon: '🏆', text: 'Objectif atteint ! Tu es incroyable !' }
                ];

                const msg = messages.find(m => progress >= m.min && progress < m.max);
                return msg || messages[0];
            },

            // Calculer les jours restants
            getDaysRemaining(deadline) {
                const now = new Date();
                const end = new Date(deadline);
                const diff = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
                return Math.max(0, diff);
            },

            // Afficher le dashboard
            showDashboard() {
                const data = this.get();
                const goal = data.currentGoal;
                const stats = this.getActionStats();

                const platformLabels = {
                    linkedin: { name: 'LinkedIn', icon: '💼' },
                    instagram: { name: 'Instagram', icon: '📸' },
                    tiktok: { name: 'TikTok', icon: '🎵' },
                    twitter: { name: 'X (Twitter)', icon: '🐦' },
                    youtube: { name: 'YouTube', icon: '📺' }
                };

                const metricLabels = {
                    followers: 'abonnés',
                    posts: 'posts créés',
                    audits: 'audits réalisés'
                };

                let html = '';

                if (!goal) {
                    // Pas d'objectif défini - Afficher le formulaire
                    html = `
                        <div class="goals-no-objective">
                            <div class="goals-no-objective-icon">🎯</div>
                            <h3>Définis ton premier objectif</h3>
                            <p>Fixe-toi un objectif pour rester motivé et suivre ta progression</p>
                        </div>

                        <div class="goals-form">
                            <h4 style="margin: 0 0 15px; color: #333;">Nouvel objectif</h4>

                            <div class="goals-form-group" style="margin-bottom: 15px;">
                                <label>Plateforme</label>
                                <div class="goals-platform-selector">
                                    <div class="goals-platform-chip active" data-platform="linkedin" onclick="GoalsSystem.selectPlatform('linkedin')">💼 LinkedIn</div>
                                    <div class="goals-platform-chip" data-platform="instagram" onclick="GoalsSystem.selectPlatform('instagram')">📸 Instagram</div>
                                    <div class="goals-platform-chip" data-platform="tiktok" onclick="GoalsSystem.selectPlatform('tiktok')">🎵 TikTok</div>
                                    <div class="goals-platform-chip" data-platform="twitter" onclick="GoalsSystem.selectPlatform('twitter')">🐦 X</div>
                                </div>
                            </div>

                            <div class="goals-form-row">
                                <div class="goals-form-group">
                                    <label>Je veux atteindre</label>
                                    <input type="number" id="goalTarget" placeholder="ex: 1000" min="1">
                                </div>
                                <div class="goals-form-group">
                                    <label>Métrique</label>
                                    <select id="goalMetric">
                                        <option value="followers">Abonnés</option>
                                        <option value="posts">Posts créés</option>
                                    </select>
                                </div>
                                <div class="goals-form-group">
                                    <label>D'ici le</label>
                                    <input type="date" id="goalDeadline" min="${new Date().toISOString().split('T')[0]}">
                                </div>
                            </div>

                            <button class="goals-btn-set" onclick="GoalsSystem.createGoal()">
                                🚀 Définir mon objectif
                            </button>
                        </div>

                        <!-- Actions stats même sans objectif -->
                        <h4 style="margin: 25px 0 15px; color: #333;">📊 Ton activité globale</h4>
                        <div class="goals-actions-grid">
                            <div class="goals-action-card">
                                <div class="goals-action-icon">✍️</div>
                                <div class="goals-action-value">${stats.postsCreated}</div>
                                <div class="goals-action-label">Posts créés</div>
                            </div>
                            <div class="goals-action-card">
                                <div class="goals-action-icon">🔍</div>
                                <div class="goals-action-value">${stats.auditsRun}</div>
                                <div class="goals-action-label">Audits lancés</div>
                            </div>
                            <div class="goals-action-card">
                                <div class="goals-action-icon">👤</div>
                                <div class="goals-action-value">${stats.profileAudits}</div>
                                <div class="goals-action-label">Profils audités</div>
                            </div>
                            <div class="goals-action-card">
                                <div class="goals-action-icon">📅</div>
                                <div class="goals-action-value">${stats.daysActive}</div>
                                <div class="goals-action-label">Jours actifs</div>
                            </div>
                        </div>
                    `;
                } else {
                    // Objectif en cours
                    const platform = platformLabels[goal.platform] || { name: goal.platform, icon: '📱' };
                    const metric = metricLabels[goal.metric] || goal.metric;
                    const progress = Math.min(100, Math.round(((goal.currentValue - goal.startValue) / (goal.target - goal.startValue)) * 100)) || 0;
                    const daysLeft = this.getDaysRemaining(goal.deadline);
                    const motivation = this.getMotivation(progress);
                    const isCompleted = goal.currentValue >= goal.target;

                    if (isCompleted) {
                        html += `
                            <div class="goals-completed">
                                <div class="goals-completed-icon">🏆</div>
                                <h3>Objectif atteint !</h3>
                                <p>Tu as atteint ${goal.target} ${metric} sur ${platform.name}. Bravo !</p>
                                <button class="goals-btn-set" style="margin-top: 15px; width: auto;" onclick="GoalsSystem.deleteGoal()">
                                    🎯 Définir un nouvel objectif
                                </button>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="goals-progress-card">
                                <div class="goals-progress-header">
                                    <div class="goals-objective-text">
                                        ${platform.icon} ${goal.target} ${metric} sur ${platform.name}
                                    </div>
                                    <div class="goals-deadline">
                                        ${daysLeft > 0 ? `⏳ ${daysLeft} jour${daysLeft > 1 ? 's' : ''} restant${daysLeft > 1 ? 's' : ''}` : '⚠️ Délai dépassé'}
                                    </div>
                                </div>
                                <div class="goals-progress-visual">
                                    <div class="goals-progress-bar">
                                        <div class="goals-progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                    <div class="goals-progress-numbers">
                                        <span class="goals-current">${goal.currentValue}</span>
                                        <span class="goals-target">Objectif: ${goal.target}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Motivation -->
                            <div class="goals-motivation">
                                <div class="goals-motivation-icon">${motivation.icon}</div>
                                <div class="goals-motivation-text">${motivation.text}</div>
                            </div>
                        `;
                    }

                    // Actions depuis le début de l'objectif
                    html += `
                        <h4 style="margin: 0 0 15px; color: #333;">📊 Tes actions depuis le début</h4>
                        <div class="goals-actions-grid">
                            <div class="goals-action-card">
                                <div class="goals-action-icon">✍️</div>
                                <div class="goals-action-value">${stats.postsCreated}</div>
                                <div class="goals-action-label">Posts créés</div>
                            </div>
                            <div class="goals-action-card">
                                <div class="goals-action-icon">🔍</div>
                                <div class="goals-action-value">${stats.auditsRun}</div>
                                <div class="goals-action-label">Audits lancés</div>
                            </div>
                            <div class="goals-action-card">
                                <div class="goals-action-icon">👤</div>
                                <div class="goals-action-value">${stats.profileAudits}</div>
                                <div class="goals-action-label">Profils audités</div>
                            </div>
                            <div class="goals-action-card ${daysLeft <= 3 && !isCompleted ? 'highlight' : ''}">
                                <div class="goals-action-icon">📅</div>
                                <div class="goals-action-value">${stats.daysActive}</div>
                                <div class="goals-action-label">Jours actifs</div>
                            </div>
                        </div>
                    `;

                    // Section mise à jour (pour les followers, saisie manuelle)
                    if (goal.metric === 'followers' && !isCompleted) {
                        html += `
                            <div class="goals-update-section">
                                <div class="goals-form-group">
                                    <label>📈 Mettre à jour mon nombre d'abonnés</label>
                                    <input type="number" id="goalCurrentValue" value="${goal.currentValue}" min="0">
                                </div>
                                <button class="goals-btn-update" onclick="GoalsSystem.updateCurrentValue(document.getElementById('goalCurrentValue').value)">
                                    ✅ Mettre à jour
                                </button>
                            </div>
                        `;
                    }

                    // Historique
                    if (data.history.length > 0) {
                        const recentHistory = data.history.slice(-5).reverse();
                        html += `
                            <div class="goals-history">
                                <h4>📜 Historique des mises à jour</h4>
                                <div class="goals-history-list">
                                    ${recentHistory.map(h => `
                                        <div class="goals-history-item">
                                            <span class="goals-history-date">${new Date(h.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</span>
                                            <span class="goals-history-value">${h.value} ${metricLabels[h.metric] || h.metric}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    // Bouton supprimer
                    if (!isCompleted) {
                        html += `
                            <div style="text-align: center; margin-top: 25px;">
                                <button class="goals-btn-delete" onclick="if(confirm('Supprimer cet objectif ?')) GoalsSystem.deleteGoal()">
                                    🗑️ Supprimer l'objectif
                                </button>
                            </div>
                        `;
                    }
                }

                document.getElementById('goalsContent').innerHTML = html;
                document.getElementById('goalsModal').classList.add('show');
            },

            // Sélectionner une plateforme
            selectPlatform(platform) {
                document.querySelectorAll('.goals-platform-chip').forEach(chip => {
                    chip.classList.toggle('active', chip.dataset.platform === platform);
                });
                this.selectedPlatform = platform;
            },

            // Créer l'objectif depuis le formulaire
            createGoal() {
                const platform = this.selectedPlatform || 'linkedin';
                const target = document.getElementById('goalTarget').value;
                const metric = document.getElementById('goalMetric').value;
                const deadline = document.getElementById('goalDeadline').value;

                if (!target || !deadline) {
                    showToast('❌ Remplis tous les champs');
                    return;
                }

                this.setGoal(platform, metric, parseInt(target), deadline);
                showToast('🎯 Objectif défini !');
            },

            selectedPlatform: 'linkedin'
        };

        // ==================== SYSTÈME FRAMEWORKS ====================
        const FrameworkSystem = {
            KEY: 'tithot_frameworks',
            currentTab: 'my',
            selectedFramework: null,
            editingSteps: [],

            // Méthodes de copywriting classiques (onglet "Par défaut")
            defaultFrameworks: [
                {
                    id: 'default_aida',
                    name: 'AIDA',
                    type: 'copywriting',
                    description: 'Attention, Intérêt, Désir, Action - Le grand classique du copywriting',
                    icon: '🎯',
                    color: '#f093fb',
                    is_default: true,
                    steps: [
                        { order: 1, name: 'Attention', description: "Capturer l'attention avec une accroche forte, une stat choc ou une question provocante" },
                        { order: 2, name: 'Intérêt', description: "Développer l'intérêt en présentant le problème ou l'opportunité" },
                        { order: 3, name: 'Désir', description: "Créer le désir en montrant la solution et ses bénéfices concrets" },
                        { order: 4, name: 'Action', description: "Appel à l'action clair et spécifique" }
                    ],
                    global_instructions: 'Ton direct et persuasif. Chaque étape doit naturellement mener à la suivante.',
                    usage_count: 0
                },
                {
                    id: 'default_pas',
                    name: 'PAS',
                    type: 'copywriting',
                    description: 'Problem, Agitate, Solve - Idéal pour créer de l\'urgence',
                    icon: '🔥',
                    color: '#ff6b6b',
                    is_default: true,
                    steps: [
                        { order: 1, name: 'Problem', description: "Identifier clairement le problème que ressent l'audience" },
                        { order: 2, name: 'Agitate', description: "Amplifier la douleur, montrer les conséquences de ne pas agir" },
                        { order: 3, name: 'Solve', description: "Présenter la solution comme le remède évident" }
                    ],
                    global_instructions: 'Empathique mais direct. Le lecteur doit se reconnaître dans le problème.',
                    usage_count: 0
                },
                {
                    id: 'default_soap',
                    name: 'SOAP',
                    type: 'copywriting',
                    description: 'Situation, Obstacle, Action, Résultat - Storytelling structuré',
                    icon: '📖',
                    color: '#9c27b0',
                    is_default: true,
                    steps: [
                        { order: 1, name: 'Situation', description: "Décrire le contexte initial, la situation de départ" },
                        { order: 2, name: 'Obstacle', description: "Le problème rencontré, le blocage, le défi" },
                        { order: 3, name: 'Action', description: "Ce qui a été fait pour surmonter l'obstacle" },
                        { order: 4, name: 'Résultat', description: "Le résultat obtenu, la transformation" }
                    ],
                    global_instructions: 'Raconter une vraie histoire. Être authentique et concret dans les détails.',
                    usage_count: 0
                },
                {
                    id: 'default_bab',
                    name: 'BAB',
                    type: 'copywriting',
                    description: 'Before, After, Bridge - Montrer la transformation',
                    icon: '🌉',
                    color: '#11998e',
                    is_default: true,
                    steps: [
                        { order: 1, name: 'Before', description: "Décrire la situation actuelle, les frustrations, les problèmes" },
                        { order: 2, name: 'After', description: "Peindre le tableau idéal, la vie après la solution" },
                        { order: 3, name: 'Bridge', description: "Expliquer comment passer de l'avant à l'après (votre solution)" }
                    ],
                    global_instructions: 'Créer un contraste fort entre Avant et Après. Le pont doit sembler naturel et accessible.',
                    usage_count: 0
                },
                {
                    id: 'default_4p',
                    name: '4P',
                    type: 'copywriting',
                    description: 'Promise, Picture, Proof, Push - Persuasion complète',
                    icon: '💪',
                    color: '#667eea',
                    is_default: true,
                    steps: [
                        { order: 1, name: 'Promise', description: "Faire une promesse forte et attrayante dès le début" },
                        { order: 2, name: 'Picture', description: "Peindre le tableau de ce que sera la vie après" },
                        { order: 3, name: 'Proof', description: "Apporter des preuves : témoignages, chiffres, études de cas" },
                        { order: 4, name: 'Push', description: "Pousser à l'action avec urgence ou rareté" }
                    ],
                    global_instructions: 'La promesse doit être crédible. Les preuves doivent être concrètes et vérifiables.',
                    usage_count: 0
                },
                {
                    id: 'default_storybrand',
                    name: 'StoryBrand',
                    type: 'copywriting',
                    description: 'La méthode de Donald Miller - Le client est le héros',
                    icon: '🦸',
                    color: '#f5576c',
                    is_default: true,
                    steps: [
                        { order: 1, name: 'Héros', description: "Identifier le héros (votre client) et ce qu'il veut" },
                        { order: 2, name: 'Problème', description: "Définir le problème externe, interne et philosophique" },
                        { order: 3, name: 'Guide', description: "Vous présentez comme le guide avec empathie et autorité" },
                        { order: 4, name: 'Plan', description: "Donner un plan simple en 3 étapes pour réussir" },
                        { order: 5, name: 'Action', description: "Appeler à l'action de façon claire et directe" },
                        { order: 6, name: 'Échec évité', description: "Montrer ce qui se passe s'il n'agit pas" },
                        { order: 7, name: 'Succès', description: "Décrire la transformation et le succès final" }
                    ],
                    global_instructions: 'Le client est TOUJOURS le héros, vous êtes le guide. Clarté avant tout.',
                    usage_count: 0
                },
                {
                    id: 'default_quest',
                    name: 'QUEST',
                    type: 'copywriting',
                    description: 'Qualify, Understand, Educate, Stimulate, Transition',
                    icon: '🧭',
                    color: '#ff9800',
                    is_default: true,
                    steps: [
                        { order: 1, name: 'Qualify', description: "Qualifier l'audience : est-ce pour toi ?" },
                        { order: 2, name: 'Understand', description: "Montrer que vous comprenez leurs problèmes" },
                        { order: 3, name: 'Educate', description: "Éduquer sur la solution et comment ça marche" },
                        { order: 4, name: 'Stimulate', description: "Stimuler l'envie d'agir, créer l'émotion" },
                        { order: 5, name: 'Transition', description: "Faciliter la transition vers l'action" }
                    ],
                    global_instructions: 'Idéal pour les audiences froides. Qualifier d\'abord pour gagner la confiance.',
                    usage_count: 0
                }
            ],

            // Bibliothèque complète de templates
            templateLibrary: [
                // === SCRIPTS CALL ===
                {
                    id: 'tpl_call_decouverte',
                    name: 'Script appel découverte',
                    type: 'script_call',
                    category: 'Scripts Call',
                    icon: '📞',
                    color: '#ef4444',
                    description: 'Structurer un appel de qualification en 15-20 min',
                    popular: true,
                    steps: [
                        { order: 1, name: 'Accroche', description: 'Créer le lien, référence commune, briser la glace (1-2 min)' },
                        { order: 2, name: 'Contexte', description: 'Comprendre sa situation actuelle, son rôle, son entreprise (3-4 min)' },
                        { order: 3, name: 'Douleur', description: 'Identifier le problème principal, les frustrations (3-4 min)' },
                        { order: 4, name: 'Impact', description: 'Quantifier les conséquences : temps perdu, argent, stress (2-3 min)' },
                        { order: 5, name: 'Solution', description: "Présenter comment tu peux aider, sans pitcher ton offre en détail (2-3 min)" },
                        { order: 6, name: 'Next step', description: "Proposer l'action suivante : démo, devis, second call (1-2 min)" }
                    ],
                    global_instructions: 'Ton conversationnel, pas de script robotique. Poser des questions ouvertes. Écouter plus que parler (ratio 70/30).'
                },
                {
                    id: 'tpl_call_demo',
                    name: 'Script démo produit',
                    type: 'script_call',
                    category: 'Scripts Call',
                    icon: '🖥️',
                    color: '#f97316',
                    description: 'Présenter ton produit/service de façon impactante',
                    steps: [
                        { order: 1, name: 'Récap besoins', description: "Résumer ce qu'on a compris de ses besoins lors du call découverte" },
                        { order: 2, name: 'Démo ciblée', description: 'Montrer uniquement les fonctionnalités qui répondent à SES problèmes' },
                        { order: 3, name: 'Cas client similaire', description: 'Partager un exemple concret de résultat obtenu' },
                        { order: 4, name: 'Objections', description: 'Anticiper et répondre aux freins potentiels' },
                        { order: 5, name: 'Proposition', description: "Présenter l'offre adaptée et le pricing" }
                    ],
                    global_instructions: 'Garder le prospect engagé. Poser des questions pendant la démo. Ne pas faire un monologue.'
                },
                {
                    id: 'tpl_call_closing',
                    name: 'Script closing',
                    type: 'script_call',
                    category: 'Scripts Call',
                    icon: '🤝',
                    color: '#22c55e',
                    description: 'Conclure la vente avec confiance',
                    steps: [
                        { order: 1, name: 'Récap valeur', description: "Résumer les bénéfices clés qu'il va obtenir" },
                        { order: 2, name: 'Validation', description: 'Confirmer que tout est clair, répondre aux dernières questions' },
                        { order: 3, name: 'Proposition ferme', description: "Annoncer clairement l'offre et le prix" },
                        { order: 4, name: 'Silence & écoute', description: 'Laisser le silence après la proposition, attendre sa réponse' }
                    ],
                    global_instructions: 'Confiance sans arrogance. Assumer le prix. Ne pas sur-justifier.'
                },
                {
                    id: 'tpl_call_relance',
                    name: 'Script relance prospect froid',
                    type: 'script_call',
                    category: 'Scripts Call',
                    icon: '🔄',
                    color: '#06b6d4',
                    description: 'Réactiver un prospect qui a ghosté',
                    steps: [
                        { order: 1, name: 'Rappel contexte', description: "Rappeler brièvement l'échange précédent sans reproches" },
                        { order: 2, name: 'Nouvelle valeur', description: 'Apporter un élément nouveau : cas client, actualité, insight' },
                        { order: 3, name: 'Question ouverte', description: 'Comprendre où il en est, ce qui a changé' },
                        { order: 4, name: 'Nouvelle proposition', description: 'Proposer une action simple et sans engagement' }
                    ],
                    global_instructions: 'Zéro culpabilisation. Curiosité sincère. Pas de "je voulais juste savoir si...".'
                },

                // === DM & MESSAGES ===
                {
                    id: 'tpl_dm_linkedin_first',
                    name: 'DM premier contact LinkedIn',
                    type: 'dm',
                    category: 'DM & Messages',
                    icon: '💬',
                    color: '#3b82f6',
                    description: 'Premier message après connexion LinkedIn',
                    popular: true,
                    steps: [
                        { order: 1, name: 'Personnalisation', description: 'Référence à un post, un projet, ou un point commun' },
                        { order: 2, name: 'Valeur immédiate', description: 'Partager une insight, une ressource, ou une observation utile' },
                        { order: 3, name: 'Question ouverte', description: 'Engager la conversation sans pitcher' },
                        { order: 4, name: 'Signature légère', description: 'Prénom uniquement, pas de pavé de signature' }
                    ],
                    global_instructions: 'Court (3-4 lignes max). Pas de pitch. Pas de lien. Humain et curieux.'
                },
                {
                    id: 'tpl_dm_post_connexion',
                    name: 'DM après connexion acceptée',
                    type: 'dm',
                    category: 'DM & Messages',
                    icon: '🤗',
                    color: '#8b5cf6',
                    description: 'Message de bienvenue sans être pushy',
                    steps: [
                        { order: 1, name: 'Remerciement', description: 'Remercier pour la connexion de façon naturelle' },
                        { order: 2, name: 'Contexte commun', description: "Mentionner ce qui vous a fait vous connecter (groupe, post, intérêt)" },
                        { order: 3, name: 'Question légère', description: 'Poser une question simple sur son activité ou un sujet commun' }
                    ],
                    global_instructions: 'Pas de pitch. Pas de lien vers ton calendly. Juste humain.'
                },
                {
                    id: 'tpl_dm_relance_soft',
                    name: 'Message de relance soft',
                    type: 'dm',
                    category: 'DM & Messages',
                    icon: '💭',
                    color: '#ec4899',
                    description: 'Relancer sans être lourd',
                    steps: [
                        { order: 1, name: 'Hook contextuel', description: "Rebondir sur une actualité, un post, ou un événement lié à lui" },
                        { order: 2, name: 'Rappel indirect', description: 'Faire un lien subtil avec votre échange précédent' },
                        { order: 3, name: 'Ouverture', description: 'Laisser la porte ouverte sans pression' }
                    ],
                    global_instructions: 'Ne pas mentionner explicitement la relance. Apporter de la valeur avant tout.'
                },
                {
                    id: 'tpl_dm_instagram',
                    name: 'DM Instagram influenceur/partenaire',
                    type: 'dm',
                    category: 'DM & Messages',
                    icon: '📸',
                    color: '#e11d48',
                    description: 'Contacter un influenceur ou partenaire potentiel',
                    steps: [
                        { order: 1, name: 'Compliment sincère', description: 'Mentionner un contenu spécifique que tu as aimé' },
                        { order: 2, name: 'Qui tu es', description: 'Te présenter en une phrase (pas un CV)' },
                        { order: 3, name: 'Proposition claire', description: 'Expliquer ce que tu proposes (collab, interview, etc.)' },
                        { order: 4, name: 'Bénéfice pour lui', description: "Montrer ce qu'il y gagne" }
                    ],
                    global_instructions: 'Court et direct. Pas de "je sais que tu es très occupé(e)...". Assumer ta demande.'
                },

                // === EMAILS ===
                {
                    id: 'tpl_email_cold',
                    name: 'Email de prospection cold',
                    type: 'email',
                    category: 'Emails',
                    icon: '📧',
                    color: '#f43f5e',
                    description: 'Premier email à un prospect froid',
                    popular: true,
                    steps: [
                        { order: 1, name: 'Objet accrocheur', description: 'Objet court, personnalisé, qui donne envie d\'ouvrir' },
                        { order: 2, name: 'Accroche personnalisée', description: 'Première phrase qui montre que tu as fait tes recherches' },
                        { order: 3, name: 'Problème/Opportunité', description: 'Identifier un pain point ou une opportunité spécifique' },
                        { order: 4, name: 'CTA simple', description: 'Une seule action demandée, facile à faire' }
                    ],
                    global_instructions: 'Max 100 mots. Pas de pièce jointe. Pas de "je me permets de...". Direct et respectueux.'
                },
                {
                    id: 'tpl_email_relance',
                    name: 'Email de relance',
                    type: 'email',
                    category: 'Emails',
                    icon: '🔁',
                    color: '#f97316',
                    description: 'Relancer un prospect sans être insistant',
                    steps: [
                        { order: 1, name: 'Rappel contexte', description: "Rappeler brièvement l'échange précédent" },
                        { order: 2, name: 'Nouvelle valeur', description: 'Apporter un élément nouveau : article, cas client, actualité' },
                        { order: 3, name: 'CTA reformulé', description: 'Proposer une action différente ou simplifiée' }
                    ],
                    global_instructions: 'Pas de culpabilisation. Ton léger. Apporter de la valeur même dans la relance.'
                },
                {
                    id: 'tpl_email_post_demo',
                    name: 'Email post-démo',
                    type: 'email',
                    category: 'Emails',
                    icon: '✅',
                    color: '#22c55e',
                    description: 'Email de suivi après une démo ou un call',
                    steps: [
                        { order: 1, name: 'Remerciement', description: 'Remercier pour le temps accordé' },
                        { order: 2, name: 'Récap personnalisé', description: 'Résumer les points clés discutés et ses besoins spécifiques' },
                        { order: 3, name: 'Ressources', description: 'Joindre les documents promis (présentation, cas client, etc.)' },
                        { order: 4, name: 'Prochaine étape', description: 'Rappeler le next step convenu et proposer une date' }
                    ],
                    global_instructions: 'Envoyer dans les 2h suivant le call. Personnaliser avec des éléments de la conversation.'
                },
                {
                    id: 'tpl_email_sequence',
                    name: 'Séquence nurturing 3 emails',
                    type: 'email',
                    category: 'Emails',
                    icon: '📬',
                    color: '#8b5cf6',
                    description: 'Séquence de 3 emails pour réchauffer un lead',
                    steps: [
                        { order: 1, name: 'Email 1 - Valeur pure', description: 'Donner sans rien demander : guide, checklist, conseil actionnable' },
                        { order: 2, name: 'Email 2 - Cas client', description: 'Montrer un résultat concret obtenu par un client similaire' },
                        { order: 3, name: 'Email 3 - Invitation', description: 'Proposer un échange : call, démo, audit gratuit' }
                    ],
                    global_instructions: 'Espacer de 3-4 jours entre chaque email. Personnaliser avec le prénom. Pas de pression.'
                },

                // === POSTS & CONTENUS ===
                {
                    id: 'tpl_post_storytelling',
                    name: 'Post LinkedIn storytelling',
                    type: 'post',
                    category: 'Posts & Contenus',
                    icon: '📝',
                    color: '#8b5cf6',
                    description: 'Post narratif avec une leçon business',
                    popular: true,
                    steps: [
                        { order: 1, name: 'Hook', description: 'Première ligne qui arrête le scroll. Chiffre, question, ou affirmation contre-intuitive.' },
                        { order: 2, name: 'Contexte', description: 'Planter le décor : qui, quand, où. En 2-3 lignes.' },
                        { order: 3, name: 'Conflit/Problème', description: "La tension, l'obstacle, ce qui n'allait pas." },
                        { order: 4, name: 'Résolution', description: 'Ce que tu as fait, appris, ou compris.' },
                        { order: 5, name: 'Leçon + CTA', description: 'La morale applicable par le lecteur + question ou invitation à commenter.' }
                    ],
                    global_instructions: 'Phrases courtes. Sauts de ligne. Pas de hashtags en plein milieu. Max 1300 caractères.'
                },
                {
                    id: 'tpl_post_educatif',
                    name: 'Post LinkedIn éducatif',
                    type: 'post',
                    category: 'Posts & Contenus',
                    icon: '🎓',
                    color: '#06b6d4',
                    description: 'Partager une expertise de façon claire',
                    steps: [
                        { order: 1, name: 'Hook problème', description: 'Commencer par le problème que ton audience rencontre' },
                        { order: 2, name: 'Framework/Méthode', description: 'Présenter ta méthode en 3-5 étapes claires' },
                        { order: 3, name: 'Exemple concret', description: 'Illustrer avec un cas réel ou un exemple parlant' },
                        { order: 4, name: 'CTA engagement', description: 'Inviter à sauvegarder, commenter, ou partager' }
                    ],
                    global_instructions: 'Utiliser des émojis comme puces. Numéroter les étapes. Facile à scanner.'
                },
                {
                    id: 'tpl_carousel',
                    name: 'Carrousel LinkedIn',
                    type: 'carousel',
                    category: 'Posts & Contenus',
                    icon: '🎠',
                    color: '#f97316',
                    description: 'Carrousel éducatif en 6-8 slides',
                    steps: [
                        { order: 1, name: 'Slide 1 - Cover', description: 'Titre accrocheur + promesse de valeur' },
                        { order: 2, name: 'Slide 2 - Problème', description: 'Identifier le problème ou la frustration' },
                        { order: 3, name: 'Slides 3-5 - Contenu', description: 'Les points clés, un par slide, avec visuel' },
                        { order: 4, name: 'Slide 6 - Récap', description: 'Résumer les points clés en une liste' },
                        { order: 5, name: 'Slide 7 - CTA', description: 'Appel à l\'action + rappel de qui tu es' },
                        { order: 6, name: 'Texte du post', description: 'Accroche + contexte + invitation à swiper' }
                    ],
                    global_instructions: 'Max 30 mots par slide. Visuel cohérent. Chaque slide doit donner envie de voir la suivante.'
                },
                {
                    id: 'tpl_thread_twitter',
                    name: 'Thread Twitter/X',
                    type: 'post',
                    category: 'Posts & Contenus',
                    icon: '🧵',
                    color: '#1d9bf0',
                    description: 'Thread viral en 5-7 tweets',
                    steps: [
                        { order: 1, name: 'Tweet 1 - Hook', description: 'Promesse forte + "Thread 🧵"' },
                        { order: 2, name: 'Tweet 2 - Contexte', description: 'Pourquoi ce sujet est important' },
                        { order: 3, name: 'Tweets 3-5 - Contenu', description: 'Les points clés, un par tweet, numérotés' },
                        { order: 4, name: 'Tweet 6 - Récap', description: 'Résumer en une liste' },
                        { order: 5, name: 'Tweet 7 - CTA', description: 'Demander RT + follow si utile' }
                    ],
                    global_instructions: 'Chaque tweet doit avoir de la valeur seul. Utiliser des émojis comme puces.'
                },

                // === AUTRES ===
                {
                    id: 'tpl_pitch_elevator',
                    name: 'Pitch elevator 30 sec',
                    type: 'other',
                    category: 'Autres',
                    icon: '🎯',
                    color: '#ec4899',
                    description: 'Se présenter efficacement en 30 secondes',
                    steps: [
                        { order: 1, name: 'Accroche', description: 'Une phrase qui capte l\'attention (stat, question, constat)' },
                        { order: 2, name: 'Problème', description: 'Le problème que tu résous pour ta cible' },
                        { order: 3, name: 'Solution', description: 'Ce que tu fais en une phrase simple' },
                        { order: 4, name: 'Preuve', description: 'Un résultat concret ou client notable' }
                    ],
                    global_instructions: 'Max 50 mots. Pas de jargon. Doit être compris par un enfant de 10 ans.'
                },
                {
                    id: 'tpl_video_courte',
                    name: 'Script vidéo courte (Reel/TikTok)',
                    type: 'other',
                    category: 'Autres',
                    icon: '🎬',
                    color: '#ef4444',
                    description: 'Script pour vidéo de 30-60 secondes',
                    steps: [
                        { order: 1, name: 'Hook (0-3s)', description: 'Phrase choc ou question qui stoppe le scroll' },
                        { order: 2, name: 'Setup (3-10s)', description: 'Poser le contexte ou le problème' },
                        { order: 3, name: 'Contenu (10-45s)', description: 'Les 2-3 points clés avec exemples' },
                        { order: 4, name: 'CTA (45-60s)', description: 'Appel à l\'action : follow, like, commentaire' }
                    ],
                    global_instructions: 'Parler vite mais clairement. Couper les silences. Sous-titres obligatoires.'
                },
                {
                    id: 'tpl_newsletter',
                    name: 'Structure newsletter',
                    type: 'newsletter',
                    category: 'Autres',
                    icon: '📰',
                    color: '#9c27b0',
                    description: 'Newsletter hebdomadaire engageante',
                    steps: [
                        { order: 1, name: 'Objet + Preview', description: 'Objet accrocheur + texte de preview qui donne envie d\'ouvrir' },
                        { order: 2, name: 'Intro personnelle', description: 'Anecdote, actualité perso, ou clin d\'oeil à la communauté' },
                        { order: 3, name: 'Contenu principal', description: 'Le sujet de la semaine : conseil, méthode, analyse' },
                        { order: 4, name: 'Ressource bonus', description: 'Un outil, un lien, un template offert' },
                        { order: 5, name: 'CTA + PS', description: 'Action à faire + PS avec info bonus ou rappel' }
                    ],
                    global_instructions: 'Écrire comme à un ami. Utiliser "tu". Pas de formalités excessives.'
                }
            ],

            // Catégories pour les filtres
            categories: ['Scripts Call', 'DM & Messages', 'Emails', 'Posts & Contenus', 'Autres'],

            typeLabels: {
                'script_call': '📞 Script Call',
                'dm': '💬 DM',
                'email': '📧 Email',
                'post': '📝 Post',
                'carousel': '🎠 Carousel',
                'newsletter': '📰 Newsletter',
                'copywriting': '✍️ Copywriting',
                'other': '📋 Autre'
            },

            typeColors: {
                'script_call': '#11998e',
                'dm': '#667eea',
                'email': '#f5576c',
                'post': '#f093fb',
                'carousel': '#ff9800',
                'newsletter': '#9c27b0',
                'copywriting': '#e91e63',
                'other': '#607d8b'
            },

            // Récupérer les frameworks de l'utilisateur
            getUserFrameworks() {
                try {
                    return JSON.parse(localStorage.getItem(this.KEY)) || [];
                } catch (e) {
                    return [];
                }
            },

            // Sauvegarder les frameworks
            saveUserFrameworks(frameworks) {
                localStorage.setItem(this.KEY, JSON.stringify(frameworks));
            },

            // Récupérer tous les frameworks (user + defaults)
            getAllFrameworks() {
                const userFrameworks = this.getUserFrameworks();
                return [...userFrameworks, ...this.defaultFrameworks];
            },

            // Récupérer un framework par ID
            getById(id) {
                return this.getAllFrameworks().find(f => f.id === id);
            },

            // ==================== UI LIBRARY ====================

            showLibrary() {
                this.currentTab = 'my';
                this.renderLibrary();
                document.getElementById('frameworkLibraryModal').classList.add('show');
            },

            closeLibrary() {
                document.getElementById('frameworkLibraryModal').classList.remove('show');
            },

            showTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('.framework-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`.framework-tab[data-tab="${tab}"]`).classList.add('active');
                this.renderLibrary();
            },

            renderLibrary() {
                const container = document.getElementById('frameworksContent');
                let frameworks = [];

                if (this.currentTab === 'my') {
                    frameworks = this.getUserFrameworks();
                    if (frameworks.length === 0) {
                        container.innerHTML = `
                            <div class="frameworks-empty" style="grid-column: 1/-1;">
                                <div class="frameworks-empty-icon">📐</div>
                                <h3>Aucun framework personnalisé</h3>
                                <p>Créez votre premier framework ou utilisez un template !</p>
                                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                                    <button class="btn btn-frameworks" onclick="FrameworkSystem.showEditor()" style="padding: 12px 25px;">
                                        ➕ Créer un framework
                                    </button>
                                    <button class="btn" onclick="FrameworkSystem.showTab('defaults')" style="padding: 12px 25px; background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                                        🌟 Voir les méthodes
                                    </button>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    container.innerHTML = frameworks.map(f => this.renderFrameworkCard(f, false)).join('');
                } else if (this.currentTab === 'defaults') {
                    // Affichage spécial pour les méthodes de copywriting
                    this.renderDefaultMethods(container);
                    return;
                } else if (this.currentTab === 'templates') {
                    this.renderTemplates(container);
                    return;
                }
            },

            renderDefaultMethods(container) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1;">
                        <div style="background: linear-gradient(135deg, #f8f9ff, #f0f4ff); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #e8ecff;">
                            <h3 style="margin: 0 0 8px; color: #333; display: flex; align-items: center; gap: 10px;">
                                ✍️ Méthodes de copywriting classiques
                            </h3>
                            <p style="margin: 0; color: #666; font-size: 0.95em;">
                                Ces frameworks éprouvés structurent vos contenus pour maximiser l'impact. Cliquez sur "Utiliser" pour les ajouter à vos frameworks personnalisés.
                            </p>
                        </div>
                        <div class="frameworks-grid">
                            ${this.defaultFrameworks.map(f => this.renderDefaultMethodCard(f)).join('')}
                        </div>
                    </div>
                `;
            },

            renderDefaultMethodCard(framework) {
                const stepsCount = framework.steps ? framework.steps.length : 0;
                const stepsPreview = framework.steps.map(s => s.name).join(' → ');

                return `
                    <div class="framework-card default-method-card" data-id="${framework.id}" style="border-color: ${framework.color}30;">
                        <div class="framework-card-header">
                            <span class="framework-card-icon">${framework.icon || '📝'}</span>
                            <span class="framework-card-type" style="background: ${framework.color}20; color: ${framework.color};">Copywriting</span>
                        </div>
                        <div class="framework-card-title" style="color: ${framework.color};">${framework.name}</div>
                        <div class="framework-card-desc">${framework.description || 'Pas de description'}</div>
                        <div style="background: #f8f9fa; padding: 10px 12px; border-radius: 8px; margin: 12px 0; font-size: 0.85em; color: #555;">
                            <strong>Structure :</strong> ${stepsPreview}
                        </div>
                        <div class="framework-card-meta" style="border-top: none; padding-top: 0;">
                            <span>${stepsCount} étapes</span>
                            <div class="framework-card-actions">
                                <button onclick="event.stopPropagation(); FrameworkSystem.showPreviewDefault('${framework.id}')" title="Prévisualiser" style="background: #f0f0f0; padding: 6px 10px; border-radius: 6px;">👁️</button>
                                <button onclick="event.stopPropagation(); FrameworkSystem.useDefaultMethod('${framework.id}')" class="btn-use-template" style="padding: 6px 12px !important;">
                                    ✅ Utiliser
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            showPreviewDefault(id) {
                const framework = this.defaultFrameworks.find(f => f.id === id);
                if (!framework) return;

                this.previewingTemplate = framework;

                document.getElementById('previewHeader').style.background = `linear-gradient(135deg, ${framework.color || '#667eea'}, ${this.adjustColor(framework.color || '#667eea', -20)})`;
                document.getElementById('previewIcon').textContent = framework.icon;
                document.getElementById('previewType').textContent = 'Méthode de copywriting';
                document.getElementById('previewTitle').textContent = framework.name;
                document.getElementById('previewDesc').textContent = framework.description;

                document.getElementById('previewSteps').innerHTML = framework.steps.map((step, i) => `
                    <div class="preview-step">
                        <div class="preview-step-number">${i + 1}</div>
                        <div class="preview-step-content">
                            <div class="preview-step-name">${step.name}</div>
                            <div class="preview-step-desc">${step.description}</div>
                        </div>
                    </div>
                `).join('');

                if (framework.global_instructions) {
                    document.getElementById('previewInstructionsSection').style.display = 'block';
                    document.getElementById('previewInstructions').textContent = framework.global_instructions;
                } else {
                    document.getElementById('previewInstructionsSection').style.display = 'none';
                }

                document.getElementById('previewUseBtn').onclick = () => {
                    this.useDefaultMethod(framework.id);
                    this.closePreview();
                };

                document.getElementById('templatePreviewModal').classList.add('show');
            },

            useDefaultMethod(id) {
                const method = this.defaultFrameworks.find(f => f.id === id);
                if (!method) return;

                const newFramework = {
                    id: 'fw_' + Date.now(),
                    name: method.name,
                    type: method.type,
                    description: method.description,
                    icon: method.icon,
                    color: method.color,
                    steps: method.steps.map(s => ({ ...s })),
                    global_instructions: method.global_instructions,
                    is_default: false,
                    usage_count: 0,
                    created_at: new Date().toISOString()
                };

                const frameworks = this.getUserFrameworks();
                frameworks.unshift(newFramework);
                this.saveUserFrameworks(frameworks);
                this.showTab('my');
                showToast('✅ ' + t('toasts.method_added'));
            },

            renderFrameworkCard(framework, showDefaultBadge = true) {
                const typeLabel = this.typeLabels[framework.type] || framework.type;
                const typeColor = this.typeColors[framework.type] || '#667eea';
                const stepsCount = framework.steps ? framework.steps.length : 0;
                const isDefault = framework.is_default;

                return `
                    <div class="framework-card" data-id="${framework.id}" onclick="FrameworkSystem.selectFramework('${framework.id}')">
                        ${isDefault && showDefaultBadge ? '<span class="framework-default-badge">Par défaut</span>' : ''}
                        <div class="framework-card-header">
                            <span class="framework-card-icon">${framework.icon || '📝'}</span>
                            <span class="framework-card-type" style="background: ${typeColor}20; color: ${typeColor};">${typeLabel}</span>
                        </div>
                        <div class="framework-card-title">${framework.name}</div>
                        <div class="framework-card-desc">${framework.description || 'Pas de description'}</div>
                        <div class="framework-card-steps">
                            ${framework.steps.slice(0, 4).map(s => `<span class="framework-step-badge">${s.name}</span>`).join('')}
                            ${stepsCount > 4 ? `<span class="framework-step-badge">+${stepsCount - 4}</span>` : ''}
                        </div>
                        <div class="framework-card-meta">
                            <span>${stepsCount} étapes</span>
                            <div class="framework-card-actions">
                                ${!isDefault ? `
                                    <button onclick="event.stopPropagation(); FrameworkSystem.editFramework('${framework.id}')" title="Modifier">✏️</button>
                                    <button onclick="event.stopPropagation(); FrameworkSystem.deleteFramework('${framework.id}')" title="Supprimer">🗑️</button>
                                ` : `
                                    <button onclick="event.stopPropagation(); FrameworkSystem.duplicateFramework('${framework.id}')" title="Dupliquer">📋</button>
                                `}
                                <button onclick="event.stopPropagation(); FrameworkSystem.useFramework('${framework.id}')" title="Utiliser">✅</button>
                            </div>
                        </div>
                    </div>
                `;
            },

            currentCategory: 'all',
            previewingTemplate: null,
            importTab: 'json',

            renderTemplates(container) {
                const filteredTemplates = this.currentCategory === 'all'
                    ? this.templateLibrary
                    : this.templateLibrary.filter(t => t.category === this.currentCategory);

                const categoryCounts = {};
                this.templateLibrary.forEach(t => {
                    categoryCounts[t.category] = (categoryCounts[t.category] || 0) + 1;
                });

                container.innerHTML = `
                    <div style="grid-column: 1/-1;">
                        <div style="background: linear-gradient(135deg, #fff8e1, #ffecb3); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #ffe082;">
                            <h3 style="margin: 0 0 8px; color: #333; display: flex; align-items: center; gap: 10px;">
                                📋 Templates par type de contenu
                            </h3>
                            <p style="margin: 0; color: #666; font-size: 0.95em;">
                                Des modèles prêts à l'emploi pour chaque type de communication : scripts call, DM, emails, posts... Cliquez sur "Utiliser" pour les personnaliser.
                            </p>
                        </div>

                        <div class="category-filters">
                            <span class="category-chip ${this.currentCategory === 'all' ? 'active' : ''}"
                                  onclick="FrameworkSystem.filterByCategory('all')">
                                Tous<span class="template-count">(${this.templateLibrary.length})</span>
                            </span>
                            ${this.categories.map(cat => `
                                <span class="category-chip ${this.currentCategory === cat ? 'active' : ''}"
                                      onclick="FrameworkSystem.filterByCategory('${cat}')">
                                    ${cat}<span class="template-count">(${categoryCounts[cat] || 0})</span>
                                </span>
                            `).join('')}
                        </div>

                        <div class="template-library-grid">
                            ${filteredTemplates.map(t => `
                                <div class="template-lib-card ${t.popular ? 'popular' : ''}" data-id="${t.id}">
                                    <div class="template-lib-header">
                                        <span class="template-lib-icon">${t.icon}</span>
                                        <span class="template-lib-category">${t.category}</span>
                                    </div>
                                    <div class="template-lib-title">${t.name}</div>
                                    <div class="template-lib-desc">${t.description}</div>
                                    <div class="template-lib-steps">
                                        ${t.steps.slice(0, 4).map(s => `<span class="template-lib-step">${s.name}</span>`).join('')}
                                        ${t.steps.length > 4 ? `<span class="template-lib-step">+${t.steps.length - 4}</span>` : ''}
                                    </div>
                                    <div class="template-lib-footer">
                                        <span class="template-lib-meta">${t.steps.length} étapes</span>
                                        <div class="template-lib-actions">
                                            <button class="btn-preview-template" onclick="event.stopPropagation(); FrameworkSystem.showPreview('${t.id}')" title="Prévisualiser">👁️</button>
                                            <button class="btn-use-template" onclick="event.stopPropagation(); FrameworkSystem.useTemplateFromLibrary('${t.id}')">Utiliser</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            filterByCategory(category) {
                this.currentCategory = category;
                this.renderLibrary();
            },

            filterFrameworks(query) {
                const cards = document.querySelectorAll('.framework-card, .template-lib-card');
                const q = query.toLowerCase();
                cards.forEach(card => {
                    const title = card.querySelector('.framework-card-title, .template-lib-title')?.textContent.toLowerCase() || '';
                    const desc = card.querySelector('.framework-card-desc, .template-lib-desc')?.textContent.toLowerCase() || '';
                    card.style.display = (title.includes(q) || desc.includes(q)) ? '' : 'none';
                });
            },

            // ==================== PREVIEW ====================

            showPreview(templateId) {
                const template = this.templateLibrary.find(t => t.id === templateId);
                if (!template) return;

                this.previewingTemplate = template;

                // Update header
                document.getElementById('previewHeader').style.background = `linear-gradient(135deg, ${template.color || '#667eea'}, ${this.adjustColor(template.color || '#667eea', -20)})`;
                document.getElementById('previewIcon').textContent = template.icon;
                document.getElementById('previewType').textContent = this.typeLabels[template.type] || template.type;
                document.getElementById('previewTitle').textContent = template.name;
                document.getElementById('previewDesc').textContent = template.description;

                // Update steps
                document.getElementById('previewSteps').innerHTML = template.steps.map((step, i) => `
                    <div class="preview-step">
                        <div class="preview-step-number">${i + 1}</div>
                        <div class="preview-step-content">
                            <div class="preview-step-name">${step.name}</div>
                            <div class="preview-step-desc">${step.description}</div>
                        </div>
                    </div>
                `).join('');

                // Update instructions
                if (template.global_instructions) {
                    document.getElementById('previewInstructionsSection').style.display = 'block';
                    document.getElementById('previewInstructions').textContent = template.global_instructions;
                } else {
                    document.getElementById('previewInstructionsSection').style.display = 'none';
                }

                document.getElementById('templatePreviewModal').classList.add('show');
            },

            closePreview() {
                document.getElementById('templatePreviewModal').classList.remove('show');
                this.previewingTemplate = null;
            },

            usePreviewedTemplate() {
                if (this.previewingTemplate) {
                    this.useTemplateFromLibrary(this.previewingTemplate.id);
                    this.closePreview();
                }
            },

            useTemplateFromLibrary(templateId) {
                const template = this.templateLibrary.find(t => t.id === templateId);
                if (!template) return;

                const newFramework = {
                    id: 'fw_' + Date.now(),
                    name: template.name,
                    type: template.type,
                    description: template.description,
                    icon: template.icon,
                    color: template.color,
                    steps: [...template.steps],
                    global_instructions: template.global_instructions,
                    is_default: false,
                    usage_count: 0,
                    created_at: new Date().toISOString()
                };

                const frameworks = this.getUserFrameworks();
                frameworks.unshift(newFramework);
                this.saveUserFrameworks(frameworks);
                this.showTab('my');
                this.closePreview();
                showToast('✅ ' + t('toasts.template_added'));
            },

            adjustColor(color, amount) {
                const clamp = (val) => Math.min(255, Math.max(0, val));
                const hex = color.replace('#', '');
                const r = clamp(parseInt(hex.substr(0, 2), 16) + amount);
                const g = clamp(parseInt(hex.substr(2, 2), 16) + amount);
                const b = clamp(parseInt(hex.substr(4, 2), 16) + amount);
                return `rgb(${r}, ${g}, ${b})`;
            },

            // ==================== IMPORT ====================
            importedFileContent: null,

            showImport() {
                document.getElementById('importJsonText').value = '';
                document.getElementById('importResult').style.display = 'none';
                this.importedFileContent = null;
                this.switchImportTab('excel');
                document.getElementById('frameworkImportModal').classList.add('show');
            },

            closeImport() {
                document.getElementById('frameworkImportModal').classList.remove('show');
            },

            switchImportTab(tab) {
                this.importTab = tab;
                document.querySelectorAll('.import-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`.import-tab[data-tab="${tab}"]`)?.classList.add('active');
                document.getElementById('importTabExcel').style.display = tab === 'excel' ? 'block' : 'none';
                document.getElementById('importTabJson').style.display = tab === 'json' ? 'block' : 'none';
                document.getElementById('importResult').style.display = 'none';
            },

            handleFileImport(event, type) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();

                if (type === 'json') {
                    reader.onload = (e) => {
                        document.getElementById('importJsonText').value = e.target.result;
                    };
                    reader.readAsText(file);
                } else if (type === 'excel') {
                    // Pour Excel/CSV, on lit comme texte (CSV) ou on affiche un message
                    const fileName = file.name.toLowerCase();
                    if (fileName.endsWith('.csv')) {
                        reader.onload = (e) => {
                            this.importedFileContent = e.target.result;
                            const resultEl = document.getElementById('importResult');
                            resultEl.className = 'import-result success';
                            resultEl.innerHTML = `✅ Fichier "${file.name}" chargé. Cliquez sur Importer pour continuer.`;
                            resultEl.style.display = 'block';
                        };
                        reader.readAsText(file);
                    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        // Pour les fichiers Excel, on a besoin de SheetJS
                        // On va utiliser une approche simplifiée
                        const resultEl = document.getElementById('importResult');
                        resultEl.className = 'import-result error';
                        resultEl.innerHTML = `⚠️ Les fichiers Excel (.xlsx) nécessitent une conversion. Veuillez exporter votre fichier en CSV depuis Excel (Fichier → Enregistrer sous → CSV).`;
                        resultEl.style.display = 'block';
                    }
                }
            },

            processImport() {
                const resultEl = document.getElementById('importResult');
                resultEl.style.display = 'none';

                try {
                    let framework;
                    if (this.importTab === 'json') {
                        framework = this.parseJsonImport();
                    } else if (this.importTab === 'excel') {
                        framework = this.parseExcelCsvImport();
                    }

                    if (!framework) {
                        throw new Error('Aucune donnée à importer. Veuillez sélectionner un fichier.');
                    }

                    // Validate
                    if (!framework.name) framework.name = 'Framework importé';
                    if (!framework.type) framework.type = 'other';
                    if (!framework.steps || framework.steps.length === 0) {
                        throw new Error('Le framework doit contenir au moins une étape');
                    }

                    // Complete the framework
                    framework.id = 'fw_' + Date.now();
                    framework.is_default = false;
                    framework.usage_count = 0;
                    framework.created_at = new Date().toISOString();
                    framework.icon = framework.icon || '📝';
                    framework.color = framework.color || '#667eea';

                    // Save
                    const frameworks = this.getUserFrameworks();
                    frameworks.unshift(framework);
                    this.saveUserFrameworks(frameworks);

                    resultEl.className = 'import-result success';
                    resultEl.innerHTML = `✅ Framework "${framework.name}" importé avec succès ! (${framework.steps.length} étapes)`;
                    resultEl.style.display = 'block';

                    setTimeout(() => {
                        this.closeImport();
                        this.showTab('my');
                        this.renderLibrary();
                    }, 1500);

                } catch (error) {
                    resultEl.className = 'import-result error';
                    resultEl.innerHTML = `❌ Erreur : ${error.message}`;
                    resultEl.style.display = 'block';
                }
            },

            parseJsonImport() {
                const text = document.getElementById('importJsonText').value.trim();
                if (!text) return null;

                const data = JSON.parse(text);

                // Normalize steps
                if (data.steps) {
                    data.steps = data.steps.map((s, i) => ({
                        order: i + 1,
                        name: s.name || s.nom || `Étape ${i + 1}`,
                        description: s.description || s.desc || ''
                    }));
                }

                return data;
            },

            parseExcelCsvImport() {
                const text = this.importedFileContent;
                if (!text) return null;

                const lines = text.split('\n').filter(l => l.trim());
                if (lines.length < 2) throw new Error('Le fichier doit contenir au moins une ligne d\'en-tête et une étape');

                // Détecte le délimiteur (;, , ou tab)
                const firstLine = lines[0];
                let delimiter = ';';
                if (firstLine.includes('\t')) delimiter = '\t';
                else if (firstLine.includes(',') && !firstLine.includes(';')) delimiter = ',';

                const headers = firstLine.split(delimiter).map(h => h.trim().toLowerCase().replace(/"/g, ''));

                const nameCol = headers.findIndex(h => h.includes('name') || h.includes('nom') || h.includes('step') || h.includes('étape'));
                const descCol = headers.findIndex(h => h.includes('desc'));

                if (nameCol === -1) throw new Error('Colonne "step_name" ou "nom" non trouvée dans le fichier');

                const steps = [];
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(delimiter).map(c => c.trim().replace(/"/g, ''));
                    const name = cols[nameCol]?.trim();
                    if (name) {
                        steps.push({
                            order: steps.length + 1,
                            name: name,
                            description: descCol >= 0 ? (cols[descCol]?.trim() || '') : ''
                        });
                    }
                }

                return {
                    name: 'Framework importé',
                    type: 'other',
                    steps: steps
                };
            },

            selectFramework(id) {
                document.querySelectorAll('.framework-card').forEach(c => c.classList.remove('selected'));
                document.querySelector(`.framework-card[data-id="${id}"]`)?.classList.add('selected');
                this.selectedFramework = id;
            },

            useFramework(id) {
                this.selectedFramework = id;
                this.closeLibrary();
                this.updateQuickSelector();
                showToast('✅ ' + t('toasts.framework_selected'));
            },

            // ==================== EDITOR ====================

            showEditor(frameworkId = null) {
                const isEdit = !!frameworkId;
                document.getElementById('frameworkEditorTitle').textContent = isEdit ? '✏️ Modifier le framework' : '➕ Créer un framework';

                // Reset form
                document.getElementById('frameworkForm').reset();
                document.getElementById('frameworkId').value = '';
                this.editingSteps = [];

                // Reset type selection
                document.querySelectorAll('.framework-type-chip').forEach(c => c.classList.remove('active'));
                document.querySelector('.framework-type-chip[data-type="script_call"]').classList.add('active');

                // Reset icon selection
                document.querySelectorAll('.icon-option').forEach(i => i.classList.remove('active'));
                document.querySelector('.icon-option[data-icon="📝"]').classList.add('active');

                if (isEdit) {
                    const framework = this.getById(frameworkId);
                    if (framework) {
                        document.getElementById('frameworkId').value = framework.id;
                        document.getElementById('frameworkName').value = framework.name;
                        document.getElementById('frameworkDescription').value = framework.description || '';
                        document.getElementById('frameworkInstructions').value = framework.global_instructions || '';
                        document.getElementById('frameworkColor').value = framework.color || '#11998e';

                        // Set type
                        document.querySelectorAll('.framework-type-chip').forEach(c => c.classList.remove('active'));
                        document.querySelector(`.framework-type-chip[data-type="${framework.type}"]`)?.classList.add('active');

                        // Set icon
                        document.querySelectorAll('.icon-option').forEach(i => i.classList.remove('active'));
                        document.querySelector(`.icon-option[data-icon="${framework.icon}"]`)?.classList.add('active');

                        // Set steps
                        this.editingSteps = [...framework.steps];
                    }
                } else {
                    // Default 2 empty steps
                    this.editingSteps = [
                        { order: 1, name: '', description: '' },
                        { order: 2, name: '', description: '' }
                    ];
                }

                this.renderSteps();
                this.initEditorEvents();
                document.getElementById('frameworkEditorModal').classList.add('show');
            },

            closeEditor() {
                document.getElementById('frameworkEditorModal').classList.remove('show');
            },

            initEditorEvents() {
                // Type selection
                document.querySelectorAll('.framework-type-chip').forEach(chip => {
                    chip.onclick = () => {
                        document.querySelectorAll('.framework-type-chip').forEach(c => c.classList.remove('active'));
                        chip.classList.add('active');
                    };
                });

                // Icon selection
                document.querySelectorAll('.icon-option').forEach(icon => {
                    icon.onclick = () => {
                        document.querySelectorAll('.icon-option').forEach(i => i.classList.remove('active'));
                        icon.classList.add('active');
                    };
                });

                // Drag and drop for steps
                this.initDragDrop();
            },

            renderSteps() {
                const container = document.getElementById('stepsList');
                container.innerHTML = this.editingSteps.map((step, index) => `
                    <div class="step-item" draggable="true" data-index="${index}">
                        <span class="step-item-drag">⋮⋮</span>
                        <div class="step-item-number">${index + 1}</div>
                        <div class="step-item-content">
                            <input type="text" class="step-item-name" placeholder="Nom de l'étape (ex: Accroche)"
                                   value="${step.name || ''}" onchange="FrameworkSystem.updateStep(${index}, 'name', this.value)">
                            <textarea class="step-item-desc" placeholder="Description (ex: Créer le lien, référence commune)"
                                      onchange="FrameworkSystem.updateStep(${index}, 'description', this.value)">${step.description || ''}</textarea>
                        </div>
                        <button type="button" class="step-item-delete" onclick="FrameworkSystem.removeStep(${index})" ${this.editingSteps.length <= 1 ? 'disabled style="opacity:0.3"' : ''}>🗑️</button>
                    </div>
                `).join('');

                this.initDragDrop();
            },

            addStep() {
                this.editingSteps.push({
                    order: this.editingSteps.length + 1,
                    name: '',
                    description: ''
                });
                this.renderSteps();
            },

            removeStep(index) {
                if (this.editingSteps.length > 1) {
                    this.editingSteps.splice(index, 1);
                    this.editingSteps.forEach((s, i) => s.order = i + 1);
                    this.renderSteps();
                }
            },

            updateStep(index, field, value) {
                this.editingSteps[index][field] = value;
            },

            initDragDrop() {
                const container = document.getElementById('stepsList');
                const items = container.querySelectorAll('.step-item');
                let draggedItem = null;

                items.forEach(item => {
                    item.addEventListener('dragstart', () => {
                        draggedItem = item;
                        item.classList.add('dragging');
                    });

                    item.addEventListener('dragend', () => {
                        item.classList.remove('dragging');
                        draggedItem = null;
                        this.reorderSteps();
                    });

                    item.addEventListener('dragover', e => {
                        e.preventDefault();
                        if (draggedItem && draggedItem !== item) {
                            const rect = item.getBoundingClientRect();
                            const midY = rect.top + rect.height / 2;
                            if (e.clientY < midY) {
                                container.insertBefore(draggedItem, item);
                            } else {
                                container.insertBefore(draggedItem, item.nextSibling);
                            }
                        }
                    });
                });
            },

            reorderSteps() {
                const items = document.querySelectorAll('.step-item');
                const newOrder = [];
                items.forEach((item, index) => {
                    const oldIndex = parseInt(item.dataset.index);
                    newOrder.push({ ...this.editingSteps[oldIndex], order: index + 1 });
                });
                this.editingSteps = newOrder;
                this.renderSteps();
            },

            saveFramework() {
                const id = document.getElementById('frameworkId').value;
                const name = document.getElementById('frameworkName').value.trim();
                const description = document.getElementById('frameworkDescription').value.trim();
                const instructions = document.getElementById('frameworkInstructions').value.trim();
                const color = document.getElementById('frameworkColor').value;
                const type = document.querySelector('.framework-type-chip.active')?.dataset.type || 'post';
                const icon = document.querySelector('.icon-option.active')?.dataset.icon || '📝';

                // Validation
                if (!name) {
                    showToast('❌ ' + t('toasts.name_required'));
                    return;
                }

                const validSteps = this.editingSteps.filter(s => s.name.trim());
                if (validSteps.length === 0) {
                    showToast('❌ ' + t('toasts.step_required'));
                    return;
                }

                const framework = {
                    id: id || 'fw_' + Date.now(),
                    name,
                    type,
                    description,
                    icon,
                    color,
                    steps: validSteps.map((s, i) => ({ ...s, order: i + 1 })),
                    global_instructions: instructions,
                    is_default: false,
                    usage_count: 0,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                const frameworks = this.getUserFrameworks();
                const existingIndex = frameworks.findIndex(f => f.id === framework.id);

                if (existingIndex >= 0) {
                    framework.usage_count = frameworks[existingIndex].usage_count;
                    frameworks[existingIndex] = framework;
                } else {
                    frameworks.unshift(framework);
                }

                this.saveUserFrameworks(frameworks);
                this.closeEditor();
                this.renderLibrary();
                this.updateQuickSelector();
                showToast('✅ ' + t('toasts.framework_saved'));
            },

            editFramework(id) {
                this.showEditor(id);
            },

            deleteFramework(id) {
                if (!confirm('Supprimer ce framework ?')) return;
                const frameworks = this.getUserFrameworks().filter(f => f.id !== id);
                this.saveUserFrameworks(frameworks);
                this.renderLibrary();
                this.updateQuickSelector();
                showToast('🗑️ ' + t('toasts.framework_deleted'));
            },

            duplicateFramework(id) {
                const original = this.getById(id);
                if (!original) return;

                const copy = {
                    ...original,
                    id: 'fw_' + Date.now(),
                    name: original.name + ' (copie)',
                    is_default: false,
                    usage_count: 0,
                    created_at: new Date().toISOString()
                };

                const frameworks = this.getUserFrameworks();
                frameworks.unshift(copy);
                this.saveUserFrameworks(frameworks);
                this.renderLibrary();
                showToast('📋 ' + t('toasts.framework_duplicated'));
            },

            useTemplate(type) {
                const defaultFw = this.defaultFrameworks.find(f => f.type === type);
                if (defaultFw) {
                    this.duplicateFramework(defaultFw.id);
                    this.showTab('my');
                } else {
                    this.showEditor();
                    document.querySelectorAll('.framework-type-chip').forEach(c => c.classList.remove('active'));
                    document.querySelector(`.framework-type-chip[data-type="${type}"]`)?.classList.add('active');
                }
            },

            // ==================== QUICK SELECTOR (for generation) ====================

            updateQuickSelector() {
                const container = document.getElementById('frameworkQuickSelect');
                if (!container) return;

                const frameworks = this.getAllFrameworks().slice(0, 5);
                container.innerHTML = `
                    <div class="framework-quick-chip none ${!this.selectedFramework ? 'active' : ''}"
                         onclick="FrameworkSystem.quickSelect(null)">
                        🚫 ${t('frameworks.no_framework')}
                    </div>
                    ${frameworks.map(f => `
                        <div class="framework-quick-chip ${this.selectedFramework === f.id ? 'active' : ''}"
                             onclick="FrameworkSystem.quickSelect('${f.id}')"
                             style="border-color: ${f.color}20;">
                            ${f.icon} ${f.name}
                        </div>
                    `).join('')}
                `;
            },

            quickSelect(id) {
                this.selectedFramework = id;
                this.updateQuickSelector();
            },

            getSelectedFramework() {
                return this.selectedFramework ? this.getById(this.selectedFramework) : null;
            },

            // Génère le prompt pour l'IA basé sur le framework
            getPromptInstructions() {
                const framework = this.getSelectedFramework();
                if (!framework) return '';

                let prompt = `\n\n📐 FRAMEWORK À SUIVRE : "${framework.name}"\n`;
                prompt += `Génère le contenu en suivant EXACTEMENT cette structure :\n\n`;

                framework.steps.forEach((step, i) => {
                    prompt += `**Étape ${i + 1} - ${step.name}** : ${step.description}\n`;
                });

                if (framework.global_instructions) {
                    prompt += `\n📋 CONSIGNES : ${framework.global_instructions}\n`;
                }

                prompt += `\nChaque étape doit être clairement identifiable dans ta réponse avec le format :\n`;
                prompt += `📌 [NOM DE L'ÉTAPE]\n[Contenu de l'étape]\n`;

                return prompt;
            },

            // Incrémente le compteur d'usage
            incrementUsage(id) {
                const frameworks = this.getUserFrameworks();
                const fw = frameworks.find(f => f.id === id);
                if (fw) {
                    fw.usage_count = (fw.usage_count || 0) + 1;
                    this.saveUserFrameworks(frameworks);
                }
            }
        };

        // ==================== SYSTÈME AGENCE ====================
        const AgencySystem = {
            KEY: 'tithot_agency',
            // Hash du code (pour ne pas exposer le code en clair)
            // Pour changer le code: dans la console, faire: btoa('NOUVEAU_CODE')
            _codeHash: 'QUdFTkNZMjAyNQ==', // base64 de 'AGENCY2025'

            _validateCode(input) {
                // Comparer le hash du input avec le hash stocké
                return btoa(input) === this._codeHash;
            },
            
            getDefault() {
                return {
                    isAgency: false,
                    clientProfiles: {}, // {clientId: {name, domaine, piliers, audience, plateformes, style, notes}}
                    currentClientId: null,
                    contents: [], // {id, date, clientId, platform, format, structure, preview}
                    rgpdConsent: false,
                    rgpdConsentDate: null
                };
            },
            
            get() {
                const stored = JSON.parse(localStorage.getItem(this.KEY));
                if (!stored) return this.getDefault();
                // Merger avec les valeurs par défaut pour éviter les undefined
                const defaults = this.getDefault();
                return {
                    isAgency: stored.isAgency ?? defaults.isAgency,
                    clientProfiles: stored.clientProfiles || defaults.clientProfiles,
                    currentClientId: stored.currentClientId ?? defaults.currentClientId,
                    contents: stored.contents || defaults.contents,
                    rgpdConsent: stored.rgpdConsent ?? defaults.rgpdConsent,
                    rgpdConsentDate: stored.rgpdConsentDate ?? defaults.rgpdConsentDate
                };
            },
            
            save(data) {
                localStorage.setItem(this.KEY, JSON.stringify(data));
            },
            
            // Générer un ID unique
            generateId() {
                return 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            },
            
            // RGPD : Obtenir consentement
            showRGPDConsent(callback) {
                document.getElementById('rgpdModal').classList.add('show');
                window.rgpdCallback = callback;
            },
            
            acceptRGPD() {
                const data = this.get();
                data.rgpdConsent = true;
                data.rgpdConsentDate = new Date().toISOString();
                this.save(data);
                document.getElementById('rgpdModal').classList.remove('show');
                if (window.rgpdCallback) window.rgpdCallback();
            },
            
            declineRGPD() {
                document.getElementById('rgpdModal').classList.remove('show');
                showToast('❌ ' + t('toasts.import_cancelled'));
            },
            
            // Supprimer toutes les données (RGPD)
            deleteAllData() {
                if (confirm('⚠️ Supprimer TOUTES les données clients ? Cette action est irréversible.')) {
                    const data = this.get();
                    data.clientProfiles = {};
                    data.currentClientId = null;
                    data.contents = [];
                    this.save(data);
                    this.updateUI();
                    showToast('🗑️ ' + t('toasts.all_clients_deleted'));
                }
            },
            
            // Modal pour entrer le code
            showUnlockModal() {
                document.getElementById('agencyCodeModal').classList.add('show');
                document.getElementById('agencyCodeInput').value = '';
                document.getElementById('agencyCodeError').style.display = 'none';
                document.getElementById('agencyCodeInput').focus();
            },
            
            closeUnlockModal() {
                document.getElementById('agencyCodeModal').classList.remove('show');
            },
            
            validateCode() {
                const input = document.getElementById('agencyCodeInput').value.trim().toUpperCase();
                if (this._validateCode(input)) {
                    this.toggleAgencyMode(true);
                    this.closeUnlockModal();
                    document.getElementById('statsModal').classList.remove('show');
                    showToast('🏢 ' + t('toasts.agency_activated'));
                } else {
                    document.getElementById('agencyCodeError').style.display = 'block';
                    document.getElementById('agencyCodeInput').classList.add('shake');
                    setTimeout(() => document.getElementById('agencyCodeInput').classList.remove('shake'), 500);
                }
            },
            
            deactivate() {
                if (confirm('Désactiver le mode Agence ? Vos données clients seront conservées.')) {
                    this.toggleAgencyMode(false);
                    document.getElementById('statsModal').classList.remove('show');
                    showToast(t('toasts.agency_deactivated'));
                }
            },
            
            toggleAgencyMode(enabled) {
                const data = this.get();
                data.isAgency = enabled;
                this.save(data);
                this.updateUI();
            },
            
            isAgencyMode() {
                return this.get().isAgency;
            },
            
            // ==================== GESTION PROFILS CLIENTS ====================
            
            // Générer les grilles dynamiques pour le formulaire client
            buildClientFormGrids() {
                // Public cible
                document.getElementById('clientPublicCibleGrid').innerHTML = ONBOARDING_OPTIONS.publicCible.map(p => `
                    <label class="checkbox-card">
                        <input type="checkbox" name="clientPublicCible" value="${p.value}">
                        <span class="checkbox-content"><span class="checkbox-icon">${p.icon}</span><span class="checkbox-label">${p.label}</span></span>
                    </label>
                `).join('');
                
                // Tranche d'âge (checkboxes pour choix multiple)
                document.getElementById('clientTrancheAgeGrid').innerHTML = ONBOARDING_OPTIONS.trancheAge.map(t => `
                    <label class="checkbox-card">
                        <input type="checkbox" name="clientTrancheAge" value="${t.value}">
                        <span class="checkbox-content"><span class="checkbox-label">${t.label}</span></span>
                    </label>
                `).join('');
                
                // Plateformes
                document.getElementById('clientPlateformesGrid').innerHTML = ONBOARDING_OPTIONS.plateformes.map(p => `
                    <label class="checkbox-card">
                        <input type="checkbox" name="clientPlateformes" value="${p.value}">
                        <span class="checkbox-content"><span class="checkbox-icon">${p.icon}</span><span class="checkbox-label">${p.label}</span></span>
                    </label>
                `).join('');
                
                // Formats
                document.getElementById('clientFormatsGrid').innerHTML = ONBOARDING_OPTIONS.formats.map(f => `
                    <label class="checkbox-card">
                        <input type="checkbox" name="clientFormats" value="${f.value}">
                        <span class="checkbox-content"><span class="checkbox-icon">${f.icon}</span><span class="checkbox-label">${f.label}</span></span>
                    </label>
                `).join('');
                
                // Style
                document.getElementById('clientStyleGrid').innerHTML = ONBOARDING_OPTIONS.styles.map(s => `
                    <label class="radio-card radio-card-compact">
                        <input type="radio" name="clientStyle" value="${s.value}">
                        <span class="radio-content"><span class="radio-icon">${s.icon}</span><span class="radio-label">${s.label}</span></span>
                    </label>
                `).join('');
                
                // Objectif
                document.getElementById('clientObjectifGrid').innerHTML = ONBOARDING_OPTIONS.objectifs.map(o => `
                    <label class="radio-card radio-card-compact">
                        <input type="radio" name="clientObjectif" value="${o.value}">
                        <span class="radio-content"><span class="radio-icon">${o.icon}</span><span class="radio-label">${o.label}</span></span>
                    </label>
                `).join('');
            },
            
            // Ouvrir modal ajout/édition client
            showClientModal(clientId = null) {
                const modal = document.getElementById('clientProfileModal');
                
                // Construire les grilles si pas déjà fait
                if (!document.getElementById('clientPublicCibleGrid').innerHTML) {
                    this.buildClientFormGrids();
                }
                
                // Reset toutes les checkboxes et radios
                modal.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                modal.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
                
                if (clientId) {
                    // Mode édition
                    const data = this.get();
                    const client = data.clientProfiles[clientId];
                    if (!client) return;
                    
                    document.getElementById('clientModalTitle').textContent = '✏️ ' + client.name;
                    document.getElementById('clientProfileId').value = clientId;
                    document.getElementById('clientName').value = client.name || '';
                    document.getElementById('clientDomaine').value = client.domaine || '';
                    document.getElementById('clientMessageUnique').value = client.messageUnique || '';
                    document.getElementById('clientPiliers').value = (client.piliers || []).join(', ');
                    document.getElementById('clientTags').value = client.tags || '';
                    document.getElementById('clientAudience').value = client.audience || '';
                    document.getElementById('clientNotes').value = client.notes || '';
                    
                    // Cocher les checkboxes
                    (client.publicCible || []).forEach(v => {
                        const cb = modal.querySelector(`input[name="clientPublicCible"][value="${v}"]`);
                        if (cb) cb.checked = true;
                    });
                    (client.plateformes || []).forEach(v => {
                        const cb = modal.querySelector(`input[name="clientPlateformes"][value="${v}"]`);
                        if (cb) cb.checked = true;
                    });
                    (client.formats || []).forEach(v => {
                        const cb = modal.querySelector(`input[name="clientFormats"][value="${v}"]`);
                        if (cb) cb.checked = true;
                    });
                    // Tranches d'âge (maintenant checkboxes)
                    (client.trancheAge || []).forEach(v => {
                        const cb = modal.querySelector(`input[name="clientTrancheAge"][value="${v}"]`);
                        if (cb) cb.checked = true;
                    });
                    
                    // Cocher les radios
                    if (client.style) {
                        const r = modal.querySelector(`input[name="clientStyle"][value="${client.style}"]`);
                        if (r) r.checked = true;
                    }
                    if (client.objectif) {
                        const r = modal.querySelector(`input[name="clientObjectif"][value="${client.objectif}"]`);
                        if (r) r.checked = true;
                    }
                    
                    // Charger les samples de voix
                    this._tempClientVoiceSamples = client.voiceSamples ? [...client.voiceSamples] : [];
                } else {
                    // Mode création
                    document.getElementById('clientModalTitle').textContent = '➕ Nouveau client';
                    document.getElementById('clientProfileId').value = '';
                    document.getElementById('clientProfileForm').reset();
                    this._tempClientVoiceSamples = [];
                }
                
                // Mettre à jour l'UI de la voix
                this.updateClientVoiceUI();
                document.getElementById('clientVoiceNewSample').value = '';
                
                modal.classList.add('show');
            },
            
            closeClientModal() {
                document.getElementById('clientProfileModal').classList.remove('show');
            },
            
            // Sauvegarder profil client enrichi
            saveClientProfile() {
                const modal = document.getElementById('clientProfileModal');
                const clientId = document.getElementById('clientProfileId').value || this.generateId();
                
                // Récupérer l'ancien profil pour garder la voix si elle existe
                const data = this.get();
                const existingProfile = data.clientProfiles[clientId] || {};
                
                const profile = {
                    name: document.getElementById('clientName').value.trim(),
                    domaine: document.getElementById('clientDomaine').value.trim(),
                    messageUnique: document.getElementById('clientMessageUnique').value.trim(),
                    piliers: document.getElementById('clientPiliers').value.split(',').map(p => p.trim()).filter(p => p),
                    tags: document.getElementById('clientTags').value.trim(),
                    audience: document.getElementById('clientAudience').value.trim(),
                    notes: document.getElementById('clientNotes').value.trim(),
                    publicCible: Array.from(modal.querySelectorAll('input[name="clientPublicCible"]:checked')).map(cb => cb.value),
                    plateformes: Array.from(modal.querySelectorAll('input[name="clientPlateformes"]:checked')).map(cb => cb.value),
                    formats: Array.from(modal.querySelectorAll('input[name="clientFormats"]:checked')).map(cb => cb.value),
                    trancheAge: Array.from(modal.querySelectorAll('input[name="clientTrancheAge"]:checked')).map(cb => cb.value),
                    style: modal.querySelector('input[name="clientStyle"]:checked')?.value || '',
                    objectif: modal.querySelector('input[name="clientObjectif"]:checked')?.value || '',
                    voiceSamples: this._tempClientVoiceSamples || existingProfile.voiceSamples || [],
                    voiceProfile: existingProfile.voiceProfile || null,
                    createdAt: existingProfile.createdAt || new Date().toISOString()
                };
                
                if (!profile.name) {
                    showToast('❌ ' + t('toasts.client_name_required'));
                    return;
                }
                
                data.clientProfiles[clientId] = profile;
                this.save(data);
                this._tempClientVoiceSamples = null; // Reset temp
                
                this.closeClientModal();
                this.updateClientSelector();
                this.updateUI(); // Rafraîchir le dashboard
                showToast('✅ ' + t('toasts.client_saved').replace('!', ' "' + profile.name + '"!'));
            },
            
            // Gestion voix client
            _tempClientVoiceSamples: null,
            
            addClientVoiceSample() {
                const textarea = document.getElementById('clientVoiceNewSample');
                const text = textarea.value.trim();
                
                if (text.length < 50) {
                    showToast('❌ ' + t('toasts.text_too_short'));
                    return;
                }

                if (!this._tempClientVoiceSamples) {
                    const clientId = document.getElementById('clientProfileId').value;
                    const data = this.get();
                    this._tempClientVoiceSamples = clientId && data.clientProfiles[clientId]?.voiceSamples
                        ? [...data.clientProfiles[clientId].voiceSamples]
                        : [];
                }

                if (this._tempClientVoiceSamples.length >= 10) {
                    showToast('❌ ' + t('toasts.max_texts'));
                    return;
                }
                
                this._tempClientVoiceSamples.push(text);
                textarea.value = '';
                this.updateClientVoiceUI();
                showToast('✅ ' + t('toasts.text_added'));
            },
            
            removeClientVoiceSample(index) {
                if (this._tempClientVoiceSamples) {
                    this._tempClientVoiceSamples.splice(index, 1);
                    this.updateClientVoiceUI();
                    showToast('🗑️ ' + t('toasts.text_deleted'));
                }
            },
            
            updateClientVoiceUI() {
                const container = document.getElementById('clientVoiceSamples');
                const analyzeBtn = document.getElementById('analyzeClientVoiceBtn');
                const statusDiv = document.getElementById('clientVoiceStatus');
                const samples = this._tempClientVoiceSamples || [];
                
                if (samples.length > 0) {
                    container.innerHTML = samples.map((s, i) => `
                        <div class="voice-sample">
                            <div class="voice-sample-text">${s.substring(0, 60)}...</div>
                            <button type="button" class="voice-sample-btn" onclick="AgencySystem.removeClientVoiceSample(${i})">🗑️</button>
                        </div>
                    `).join('');
                    
                    if (samples.length >= 2) {
                        analyzeBtn.style.display = 'block';
                    }
                } else {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 15px;">Aucun texte ajouté</p>';
                    analyzeBtn.style.display = 'none';
                }
                
                // Afficher le profil de voix existant
                const clientId = document.getElementById('clientProfileId').value;
                if (clientId) {
                    const data = this.get();
                    const client = data.clientProfiles[clientId];
                    if (client?.voiceProfile) {
                        statusDiv.style.display = 'block';
                        statusDiv.style.background = 'linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1))';
                        statusDiv.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5em;">✅</span>
                                <div>
                                    <strong>Profil de voix actif</strong><br>
                                    <small style="color: #666;">Ton: ${client.voiceProfile.ton || 'N/A'} • Fidélité: ${client.voiceProfile.fidelityScore || 85}%</small>
                                </div>
                            </div>
                        `;
                    }
                }
            },
            
            async analyzeClientVoice() {
                const samples = this._tempClientVoiceSamples || [];
                if (samples.length < 2) {
                    showToast('❌ ' + t('toasts.min_2_texts'));
                    return;
                }
                
                const btn = document.getElementById('analyzeClientVoiceBtn');
                const statusDiv = document.getElementById('clientVoiceStatus');
                
                btn.disabled = true;
                btn.innerHTML = '⏳ Analyse en cours...';
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#f8f9fa';
                statusDiv.innerHTML = '<p style="text-align: center; color: #667eea;">🎤 Tithot analyse le style d\'écriture...</p>';
                
                const samplesText = samples.map((s, i) => `--- TEXTE ${i+1} ---\n${s}`).join('\n\n');
                
                const prompt = `Tu es un expert en analyse stylistique. Analyse ces textes et extrais le profil de voix.

${samplesText}

Réponds UNIQUEMENT avec ce JSON :
{
  "ton": "Description du ton en 3-5 mots",
  "longueurPhrases": "Court/Moyen/Long + description",
  "expressions": "Expressions récurrentes identifiées",
  "ponctuation": "Usage émojis, !, tirets...",
  "styleNarratif": "Structure narrative préférée",
  "vocabulaire": "Type de vocabulaire",
  "signature": "Ce qui rend cette voix unique",
  "fidelityScore": 85,
  "conseils": "Comment reproduire cette voix"
}`;

                try {
                    const response = await callAI(prompt);
                    const jsonMatch = response.match(/\{[\s\S]*\}/);
                    
                    if (!jsonMatch) throw new Error('Format invalide');
                    
                    const voiceProfile = JSON.parse(jsonMatch[0]);
                    
                    // Sauvegarder dans le client
                    const clientId = document.getElementById('clientProfileId').value;
                    if (clientId) {
                        const data = this.get();
                        if (data.clientProfiles[clientId]) {
                            data.clientProfiles[clientId].voiceProfile = voiceProfile;
                            data.clientProfiles[clientId].voiceSamples = samples;
                            this.save(data);
                        }
                    }
                    
                    statusDiv.style.background = 'linear-gradient(135deg, rgba(40,167,69,0.1), rgba(40,167,69,0.2))';
                    statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">✅</span>
                            <div>
                                <strong style="color: #28a745;">Profil de voix créé !</strong><br>
                                <small style="color: #666;">Ton: ${voiceProfile.ton} • Fidélité: ${voiceProfile.fidelityScore}%</small>
                            </div>
                        </div>
                    `;
                    showToast('✅ ' + t('toasts.voice_analyzed'));
                    
                } catch (error) {
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.innerHTML = `<p style="color: #721c24;">❌ Erreur: ${error.message}</p>`;
                }
                
                btn.disabled = false;
                btn.innerHTML = '🎤 Ré-analyser la voix';
            },
            
            // Supprimer un client
            deleteClient(clientId) {
                const data = this.get();
                const name = data.clientProfiles[clientId]?.name || 'ce client';
                
                if (confirm('Supprimer "' + name + '" et tous ses contenus associés ?')) {
                    delete data.clientProfiles[clientId];
                    data.contents = data.contents.filter(c => c.clientId !== clientId);
                    if (data.currentClientId === clientId) data.currentClientId = null;
                    this.save(data);
                    this.updateClientSelector();
                    showToast('🗑️ ' + t('toasts.client_deleted'));
                }
            },
            
            // Sélectionner un client
            setCurrentClient(clientId) {
                const data = this.get();
                data.currentClientId = clientId || null;
                this.save(data);
            },
            
            getCurrentClient() {
                const data = this.get();
                if (!data.currentClientId) return null;
                return data.clientProfiles[data.currentClientId] || null;
            },
            
            getCurrentClientId() {
                return this.get().currentClientId;
            },
            
            // Obtenir le profil client enrichi pour injection dans les prompts
            getClientProfileForAI() {
                const client = this.getCurrentClient();
                if (!client) return null;
                
                // Traduire les valeurs des options
                const getStyleLabel = (val) => ONBOARDING_OPTIONS.styles.find(s => s.value === val)?.label || val;
                const getObjectifLabel = (val) => ONBOARDING_OPTIONS.objectifs.find(o => o.value === val)?.label || val;
                const getPublicLabels = (arr) => arr.map(v => ONBOARDING_OPTIONS.publicCible.find(p => p.value === v)?.label || v).join(', ');
                
                let voiceSection = '';
                if (client.voiceProfile) {
                    const vp = client.voiceProfile;
                    voiceSection = `

=== PROFIL DE VOIX DU CLIENT (TRÈS IMPORTANT) ===
Ce client a un style d'écriture unique que tu DOIS reproduire :
- Ton : ${vp.ton || 'Non défini'}
- Longueur phrases : ${vp.longueurPhrases || 'Non définie'}
- Expressions : ${vp.expressions || 'Non définies'}
- Ponctuation : ${vp.ponctuation || 'Non définie'}
- Style narratif : ${vp.styleNarratif || 'Non défini'}
- Signature : ${vp.signature || 'Non définie'}
CONSEILS : ${vp.conseils || 'Style naturel'}

⚠️ ÉCRIS EXACTEMENT comme ce client écrirait !`;
                }
                
                return `
CLIENT : ${client.name}
DOMAINE : ${client.domaine || 'Non spécifié'}
POSITIONNEMENT : ${client.messageUnique || 'Non spécifié'}
PILIERS DE CONTENU : ${(client.piliers || []).join(', ') || 'Non spécifiés'}
TAGS : ${client.tags || 'Aucun'}
AUDIENCE CIBLE : ${client.audience || ''} ${client.publicCible?.length ? '(' + getPublicLabels(client.publicCible) + ')' : ''} ${client.trancheAge?.length ? '- Tranches ' + (Array.isArray(client.trancheAge) ? client.trancheAge.join(', ') : client.trancheAge) : ''}
STYLE/TON : ${client.style ? getStyleLabel(client.style) : 'Non spécifié'}
OBJECTIF : ${client.objectif ? getObjectifLabel(client.objectif) : 'Non spécifié'}
PLATEFORMES : ${(client.plateformes || []).join(', ') || 'Non spécifiées'}
FORMATS PRÉFÉRÉS : ${(client.formats || []).join(', ') || 'Tous'}
NOTES : ${client.notes || 'Aucune'}${voiceSection}
                `.trim();
            },
            
            // Télécharger le template CSV
            downloadTemplate() {
                const headers = [
                    'Nom',
                    'Domaine / Secteur',
                    'Message unique (positionnement)',
                    'Piliers de contenu',
                    'Tags / Hashtags',
                    'Audience (description)',
                    'Public cible (b2c, entrepreneurs, salaries, dirigeants, freelances, etudiants, createurs, rh, b2b)',
                    'Tranche d\'âge (18-25, 25-35, 35-45, 45-55, 55+, tous)',
                    'Style / Ton (inspirant, educatif, authentique, humour, provocateur, minimaliste, storytelling, emotionnel)',
                    'Objectif (notoriete, communaute, ventes, autorite, reseau, expression, recrutement, leads)',
                    'Plateformes (linkedin, instagram, tiktok, youtube, x, facebook, threads, pinterest, newsletter)',
                    'Formats préférés (post, carousel, reel, story, thread, live, article, visuel)',
                    'Notes'
                ];
                const example1 = [
                    'Café Joyeux',
                    'Restauration inclusive',
                    'Nous formons et employons des personnes en situation de handicap',
                    'inclusion, coulisses, témoignages clients',
                    '#cafejoyeux #inclusion #emploi #handicap',
                    'Grand public sensible à l\'inclusion et à l\'économie sociale',
                    'b2c, entrepreneurs',
                    '25-35, 35-45',
                    'authentique',
                    'notoriete',
                    'instagram, linkedin, facebook',
                    'post, reel, carousel',
                    'Ton chaleureux et positif. Éviter le misérabilisme. Vouvoiement.'
                ];
                const example2 = [
                    'Marie Dupont Coaching',
                    'Coaching professionnel',
                    'J\'aide les managers à retrouver du sens et de l\'impact',
                    'leadership, bien-être au travail, témoignages, outils pratiques',
                    '#coaching #leadership #management #sens',
                    'Cadres et dirigeants en quête de sens dans leur carrière',
                    'dirigeants, salaries, rh',
                    '35-45, 45-55',
                    'inspirant',
                    'autorite',
                    'linkedin',
                    'post, carousel, article',
                    'Vouvoiement, ton professionnel mais chaleureux. Éviter le jargon trop corporate.'
                ];
                const example3 = [
                    'TechStartup.io',
                    'SaaS B2B',
                    'Automatisez vos processus RH en 5 minutes',
                    'produit, use cases, tech tips, culture d\'entreprise',
                    '#saas #hr #automation #startup',
                    'DRH et founders de PME en hypercroissance',
                    'b2b, dirigeants, rh',
                    '25-35, 35-45',
                    'educatif',
                    'leads',
                    'linkedin, youtube',
                    'post, carousel, thread',
                    'Tutoiement. Ton décontracté mais expert. Beaucoup de chiffres et stats.'
                ];

                const csvContent = [
                    headers.join(';'),
                    example1.join(';'),
                    example2.join(';'),
                    example3.join(';'),
                    '', // Ligne vide pour que l'utilisateur ajoute ses clients
                    ''
                ].join('\n');

                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'modele_clients_sos_storytelling.csv';
                link.click();
                URL.revokeObjectURL(link.href);
                showToast('📥 ' + t('toasts.csv_template_downloaded'));
            },
            
            // ==================== IMPORT CSV/XLSX ====================
            
            showImportModal() {
                document.getElementById('importModal').classList.add('show');
            },
            
            closeImportModal() {
                document.getElementById('importModal').classList.remove('show');
                document.getElementById('importPreview').innerHTML = '';
                document.getElementById('importFile').value = '';
            },
            
            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const preview = document.getElementById('importPreview');
                preview.innerHTML = '<div class="import-loading">⏳ Analyse du fichier en cours...</div>';
                
                try {
                    let rawData;
                    const extension = file.name.split('.').pop().toLowerCase();
                    
                    if (extension === 'csv') {
                        rawData = await this.parseCSV(file);
                    } else if (extension === 'xlsx' || extension === 'xls') {
                        rawData = await this.parseXLSX(file);
                    } else {
                        throw new Error('Format non supporté. Utilisez CSV ou XLSX.');
                    }

                    // Essayer d'abord le parsing manuel (plus rapide et fiable)
                    let parsedClients = this.parseManual(rawData);

                    // Si pas assez de données, essayer avec l'IA
                    if (parsedClients.length === 0 || !parsedClients[0].name) {
                        try {
                            parsedClients = await this.parseWithAI(rawData);
                        } catch (aiError) {
                            console.warn('Parsing IA échoué, utilisation du parsing manuel:', aiError);
                            parsedClients = this.parseManual(rawData);
                        }
                    }

                    this.showImportPreview(parsedClients);

                } catch (e) {
                    console.error('Import error:', e);
                    preview.innerHTML = '<div class="import-error">❌ ' + e.message + '</div>';
                }
            },
            
            parseCSV(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const text = e.target.result;
                        const lines = text.split('\n').map(l => l.split(/[;,\t]/).map(c => c.trim().replace(/^"|"$/g, '')));
                        resolve(lines);
                    };
                    reader.onerror = () => reject(new Error('Erreur de lecture du fichier'));
                    reader.readAsText(file, 'UTF-8');
                });
            },
            
            async parseXLSX(file) {
                // Charger SheetJS si pas déjà fait
                if (!window.XLSX) {
                    await this.loadScript('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');
                }
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const workbook = XLSX.read(e.target.result, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const data = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                            resolve(data);
                        } catch (err) {
                            reject(new Error('Erreur de parsing Excel'));
                        }
                    };
                    reader.onerror = () => reject(new Error('Erreur de lecture du fichier'));
                    reader.readAsArrayBuffer(file);
                });
            },
            
            loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            },

            // Parsing manuel des données CSV (fallback rapide)
            parseManual(rawData) {
                if (!rawData || rawData.length < 2) return [];

                const headers = rawData[0].map(h => h?.toString().toLowerCase().trim() || '');
                const clients = [];

                // Mapping des colonnes possibles
                const colMap = {
                    name: headers.findIndex(h => h.includes('nom') || h.includes('name') || h.includes('client') || h.includes('entreprise')),
                    domaine: headers.findIndex(h => h.includes('domaine') || h.includes('secteur') || h.includes('domain') || h.includes('activit')),
                    messageUnique: headers.findIndex(h => h.includes('message') || h.includes('positionnement') || h.includes('proposition')),
                    piliers: headers.findIndex(h => h.includes('pilier') || h.includes('thématique') || h.includes('theme')),
                    tags: headers.findIndex(h => h.includes('tag') || h.includes('hashtag') || h.includes('mot')),
                    audience: headers.findIndex(h => h.includes('audience') || h.includes('cible') || h.includes('target')),
                    publicCible: headers.findIndex(h => h.includes('public') && h.includes('cible')),
                    trancheAge: headers.findIndex(h => h.includes('age') || h.includes('âge') || h.includes('tranche')),
                    style: headers.findIndex(h => h.includes('style') || h.includes('ton')),
                    objectif: headers.findIndex(h => h.includes('objectif') || h.includes('goal') || h.includes('but')),
                    plateformes: headers.findIndex(h => h.includes('plateforme') || h.includes('réseau') || h.includes('platform') || h.includes('social')),
                    formats: headers.findIndex(h => h.includes('format')),
                    notes: headers.findIndex(h => h.includes('note') || h.includes('commentaire') || h.includes('info'))
                };

                // Parser chaque ligne
                for (let i = 1; i < rawData.length; i++) {
                    const row = rawData[i];
                    if (!row || row.length === 0 || !row.some(cell => cell?.toString().trim())) continue;

                    const getValue = (idx) => idx >= 0 && row[idx] ? row[idx].toString().trim() : '';
                    const getArray = (idx) => {
                        const val = getValue(idx);
                        if (!val) return [];
                        return val.split(/[,;|]/).map(v => v.trim().toLowerCase()).filter(v => v);
                    };

                    const client = {
                        name: getValue(colMap.name) || getValue(0), // Fallback première colonne
                        domaine: getValue(colMap.domaine),
                        messageUnique: getValue(colMap.messageUnique),
                        piliers: getArray(colMap.piliers),
                        tags: getValue(colMap.tags),
                        audience: getValue(colMap.audience),
                        publicCible: getArray(colMap.publicCible),
                        trancheAge: getArray(colMap.trancheAge),
                        style: getValue(colMap.style).toLowerCase(),
                        objectif: getValue(colMap.objectif).toLowerCase(),
                        plateformes: getArray(colMap.plateformes),
                        formats: getArray(colMap.formats),
                        notes: getValue(colMap.notes)
                    };

                    if (client.name) {
                        clients.push(client);
                    }
                }

                return clients;
            },

            async parseWithAI(rawData) {
                const prompt = `Analyse ces données de clients et extrais les informations structurées.

DONNÉES BRUTES (tableau avec headers en première ligne) :
${JSON.stringify(rawData.slice(0, 20))}

Pour chaque ligne (sauf les headers), extrais :
- name : nom du client/entreprise (OBLIGATOIRE)
- domaine : secteur d'activité
- messageUnique : positionnement / proposition de valeur
- piliers : thématiques de contenu (array de strings)
- tags : hashtags et mots-clés
- audience : description de la cible
- publicCible : types de public (array parmi: entrepreneurs, freelances, salaries, etudiants, createurs, rh, b2b, b2c, dirigeants)
- trancheAge : tranches d'âge ciblées (array parmi: 18-25, 25-35, 35-45, 45-55, 55+, tous)
- style : style de communication (parmi: inspirant, educatif, authentique, humour, provocateur, minimaliste, storytelling, emotionnel)
- objectif : objectif principal (parmi: notoriete, communaute, ventes, autorite, reseau, expression, recrutement, leads)
- plateformes : réseaux sociaux (array parmi: linkedin, instagram, tiktok, youtube, x, facebook, threads, pinterest, newsletter)
- formats : formats préférés (array parmi: post, carousel, reel, story, thread, live, article, visuel)
- notes : autres infos, contraintes, ton à éviter

Réponds UNIQUEMENT avec un JSON valide, format :
[
  {"name": "...", "domaine": "...", "messageUnique": "...", "piliers": [...], "tags": "...", "audience": "...", "publicCible": [...], "trancheAge": [...], "style": "...", "objectif": "...", "plateformes": [...], "formats": [...], "notes": "..."},
  ...
]

Si une info n'est pas présente, mets une chaîne vide ou un array vide.`;

                const response = await callAI(prompt);
                
                // Extraire le JSON de la réponse
                const jsonMatch = response.match(/\[[\s\S]*\]/);
                if (!jsonMatch) throw new Error('Impossible de parser les données');
                
                return JSON.parse(jsonMatch[0]);
            },
            
            showImportPreview(clients) {
                const preview = document.getElementById('importPreview');
                const data = this.get();

                if (!clients || clients.length === 0) {
                    preview.innerHTML = '<div class="import-error">❌ Aucun client détecté dans le fichier</div>';
                    return;
                }

                // Stocker temporairement pour import
                window.pendingImportClients = clients;

                // Helper pour traduire les valeurs
                const getStyleLabel = (val) => ONBOARDING_OPTIONS.styles.find(s => s.value === val)?.label || val;
                const getObjectifLabel = (val) => ONBOARDING_OPTIONS.objectifs.find(o => o.value === val)?.label || val;

                let html = `
                    <div class="import-success">
                        <span style="font-size: 1.5em;">✅</span>
                        <div>
                            <strong>${clients.length} client(s) détecté(s)</strong>
                            <small style="display: block; color: #666;">Vérifiez les informations avant d'importer</small>
                        </div>
                    </div>
                    <div class="import-clients-list" style="max-height: 400px; overflow-y: auto;">
                `;

                clients.forEach((client, i) => {
                    const platformBadges = (client.plateformes || []).map(p => `<span class="import-badge platform">${p}</span>`).join('');
                    const formatBadges = (client.formats || []).map(f => `<span class="import-badge format">${f}</span>`).join('');
                    const pilierList = (client.piliers || []).join(', ');

                    html += `
                        <div class="import-client-card-detailed">
                            <div class="import-client-header">
                                <div class="import-client-name">
                                    <strong>${client.name || 'Sans nom'}</strong>
                                    ${client.domaine ? `<span class="import-client-domain">${client.domaine}</span>` : ''}
                                </div>
                                <span class="import-client-index">#${i + 1}</span>
                            </div>
                            ${client.messageUnique ? `<div class="import-client-message">"${client.messageUnique}"</div>` : ''}
                            <div class="import-client-grid">
                                ${pilierList ? `<div class="import-field"><span class="import-label">📌 Piliers</span><span class="import-value">${pilierList}</span></div>` : ''}
                                ${client.audience ? `<div class="import-field"><span class="import-label">👥 Audience</span><span class="import-value">${client.audience}</span></div>` : ''}
                                ${client.publicCible?.length ? `<div class="import-field"><span class="import-label">🎯 Public</span><span class="import-value">${client.publicCible.join(', ')}</span></div>` : ''}
                                ${client.trancheAge?.length ? `<div class="import-field"><span class="import-label">📅 Âge</span><span class="import-value">${client.trancheAge.join(', ')}</span></div>` : ''}
                                ${client.style ? `<div class="import-field"><span class="import-label">🎨 Style</span><span class="import-value">${getStyleLabel(client.style)}</span></div>` : ''}
                                ${client.objectif ? `<div class="import-field"><span class="import-label">🎯 Objectif</span><span class="import-value">${getObjectifLabel(client.objectif)}</span></div>` : ''}
                            </div>
                            <div class="import-client-badges">
                                ${platformBadges || '<span class="import-badge empty">Aucune plateforme</span>'}
                                ${formatBadges}
                            </div>
                            ${client.notes ? `<div class="import-client-notes">📝 ${client.notes}</div>` : ''}
                        </div>
                    `;
                });

                html += `</div>`;

                // Consentement RGPD obligatoire avant import
                const hasConsent = data.rgpdConsent;
                html += `
                    <div class="import-rgpd-section">
                        <div class="rgpd-notice">
                            <span class="rgpd-icon">🔒</span>
                            <div class="rgpd-text">
                                <strong>Protection des données (RGPD)</strong>
                                <p>Les données sont traitées <strong>100% localement</strong> dans votre navigateur. Aucune donnée n'est envoyée sur nos serveurs.</p>
                            </div>
                        </div>
                        ${!hasConsent ? `
                            <label class="rgpd-checkbox">
                                <input type="checkbox" id="importRgpdConsent" onchange="AgencySystem.toggleImportButton()">
                                <span>J'accepte le traitement local de ces données et je confirme avoir le droit de les utiliser.</span>
                            </label>
                        ` : `
                            <div class="rgpd-already-consented">
                                ✅ Consentement donné le ${new Date(data.rgpdConsentDate).toLocaleDateString('fr-FR')}
                            </div>
                        `}
                    </div>
                    <button class="btn btn-import-confirm" id="importConfirmBtn" onclick="AgencySystem.confirmImport()" ${!hasConsent ? 'disabled' : ''}>
                        ✅ Importer ${clients.length} client(s)
                    </button>
                `;

                preview.innerHTML = html;
            },

            toggleImportButton() {
                const checkbox = document.getElementById('importRgpdConsent');
                const btn = document.getElementById('importConfirmBtn');
                if (btn) btn.disabled = !checkbox?.checked;
            },
            
            confirmImport() {
                const clients = window.pendingImportClients;
                if (!clients) return;

                const data = this.get();

                // Enregistrer le consentement RGPD si c'est la première fois
                if (!data.rgpdConsent) {
                    const checkbox = document.getElementById('importRgpdConsent');
                    if (!checkbox?.checked) {
                        showToast('❌ ' + t('toasts.rgpd_required'));
                        return;
                    }
                    data.rgpdConsent = true;
                    data.rgpdConsentDate = new Date().toISOString();
                }

                let imported = 0;

                clients.forEach(client => {
                    if (client.name) {
                        const clientId = this.generateId();
                        data.clientProfiles[clientId] = {
                            ...client,
                            createdAt: new Date().toISOString(),
                            importedAt: new Date().toISOString()
                        };
                        imported++;
                    }
                });

                this.save(data);
                this.closeImportModal();
                this.updateClientSelector();
                this.updateUI();

                // Rafraîchir le dashboard s'il est ouvert
                if (document.getElementById('agencyDashboardModal').classList.contains('show')) {
                    this.showDashboard();
                }

                showToast('✅ ' + t('toasts.clients_imported').replace('{count}', imported));

                delete window.pendingImportClients;
            },
            
            // ==================== TRACKING & STATS ====================
            
            trackContent(platform, format, structure, preview) {
                const data = this.get();
                const clientId = data.currentClientId || null;
                const clientName = clientId && data.clientProfiles && data.clientProfiles[clientId] 
                    ? data.clientProfiles[clientId].name 
                    : 'Non assigné';
                    
                data.contents.unshift({
                    id: Date.now(),
                    date: new Date().toISOString(),
                    month: new Date().toISOString().slice(0, 7),
                    clientId: clientId,
                    clientName: clientName,
                    platform: platform || 'unknown',
                    format: format || 'unknown',
                    structure: structure || 'unknown',
                    preview: (preview || '').substring(0, 200)
                });
                if (data.contents.length > 500) data.contents.pop();
                this.save(data);
            },
            
            getStats() {
                const data = this.get();
                const contents = data.contents || [];
                const clientProfiles = data.clientProfiles || {};
                
                const byMonth = {};
                const now = new Date();
                for (let i = 5; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const key = d.toISOString().slice(0, 7);
                    byMonth[key] = 0;
                }
                contents.forEach(c => {
                    if (byMonth.hasOwnProperty(c.month)) byMonth[c.month]++;
                });
                
                const byClient = {};
                contents.forEach(c => {
                    const name = c.clientName || 'Non assigné';
                    byClient[name] = (byClient[name] || 0) + 1;
                });
                
                const byPlatform = {};
                contents.forEach(c => { byPlatform[c.platform] = (byPlatform[c.platform] || 0) + 1; });
                
                const byFormat = {};
                contents.forEach(c => { byFormat[c.format] = (byFormat[c.format] || 0) + 1; });
                
                const byStructure = {};
                contents.forEach(c => { byStructure[c.structure] = (byStructure[c.structure] || 0) + 1; });
                
                return { 
                    total: contents.length, 
                    byMonth, 
                    byClient, 
                    byPlatform, 
                    byFormat, 
                    byStructure, 
                    clientCount: Object.keys(clientProfiles).length 
                };
            },
            
            exportCSV() {
                const data = this.get();
                const headers = ['Date', 'Client', 'Plateforme', 'Format', 'Structure', 'Aperçu'];
                const rows = data.contents.map(c => [
                    new Date(c.date).toLocaleDateString('fr-FR'),
                    c.clientName || 'Non assigné',
                    c.platform,
                    c.format,
                    c.structure,
                    '"' + (c.preview || '').replace(/"/g, '""') + '"'
                ]);
                
                const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tithot-agence-export-' + new Date().toISOString().slice(0,10) + '.csv';
                a.click();
                URL.revokeObjectURL(url);
                showToast('📊 ' + t('toasts.csv_exported'));
            },
            
            // ==================== UI ====================
            
            updateUI() {
                const isAgency = this.isAgencyMode();
                const clientSection = document.getElementById('clientSection');
                const agencyBtn = document.getElementById('agencyDashboardBtn');
                const agencyToggleBtn = document.getElementById('agencyToggleBtn');
                const agencyStatusText = document.getElementById('agencyStatusText');
                
                // Section client et bouton dashboard
                if (clientSection) clientSection.style.display = isAgency ? 'block' : 'none';
                if (agencyBtn) agencyBtn.style.display = isAgency ? 'inline-flex' : 'none';

                // Section Frameworks (visible uniquement en mode agence)
                const frameworkSection = document.getElementById('frameworkSection');
                if (frameworkSection) frameworkSection.style.display = isAgency ? 'block' : 'none';
                
                // Toggle dans la configuration
                if (agencyToggleBtn) {
                    if (isAgency) {
                        agencyToggleBtn.innerHTML = '<button class="btn-agency-active-small" onclick="AgencySystem.deactivate()">✅ Activé</button>';
                    } else {
                        agencyToggleBtn.innerHTML = '<button class="btn-agency-unlock-small" onclick="AgencySystem.showUnlockModal()">🔐 Débloquer</button>';
                    }
                }
                
                if (agencyStatusText) {
                    agencyStatusText.textContent = isAgency ? 'Mode activé ! Sélectionnez un client ci-dessous.' : 'Multi-clients, dashboard & exports';
                    agencyStatusText.style.color = isAgency ? 'white' : '#666';
                }

                // Changer le style de la section agence quand le mode est actif
                const agencyToggleSection = document.querySelector('.agency-toggle-section');
                const agencyToggleLabel = document.querySelector('.agency-toggle-label');
                if (agencyToggleSection) {
                    if (isAgency) {
                        agencyToggleSection.style.background = 'linear-gradient(135deg, #11998e, #38ef7d)';
                        agencyToggleSection.style.borderColor = 'transparent';
                    } else {
                        agencyToggleSection.style.background = 'linear-gradient(135deg, #f8f9ff, #f0f4ff)';
                        agencyToggleSection.style.borderColor = '#e8ecff';
                    }
                }
                if (agencyToggleLabel) {
                    agencyToggleLabel.style.color = isAgency ? 'white' : '#1e3c72';
                }
                
                if (isAgency) this.updateClientSelector();
            },
            
            updateClientSelector() {
                const data = this.get();
                const selector = document.getElementById('clientSelector');
                if (!selector) return;
                
                const clients = Object.entries(data.clientProfiles || {});
                
                selector.innerHTML = `
                    <option value="">-- Sélectionner un client --</option>
                    ${clients.map(([id, c]) => `<option value="${id}" ${id === data.currentClientId ? 'selected' : ''}>${c.name}</option>`).join('')}
                `;
            },
            
            showDashboard() {
                try {
                    const data = this.get();
                    const stats = this.getStats();
                    
                    const maxMonth = Math.max(...Object.values(stats.byMonth), 1);
                    const monthBars = Object.entries(stats.byMonth).map(([month, count]) => {
                        const label = new Date(month + '-01').toLocaleDateString('fr-FR', { month: 'short' });
                        const height = (count / maxMonth) * 100;
                        return `<div class="chart-bar-container">
                            <div class="chart-bar" style="height: ${height}%"><span>${count}</span></div>
                            <div class="chart-label">${label}</div>
                        </div>`;
                    }).join('');
                    
                    const topClients = Object.entries(stats.byClient)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5)
                        .map(([name, count]) => `<div class="stat-item"><span>${name}</span><strong>${count}</strong></div>`)
                        .join('') || '<p style="color:#999;">Aucun contenu</p>';
                    
                    const topStructures = Object.entries(stats.byStructure)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5)
                        .map(([name, count]) => `<div class="stat-item"><span>${(typeof STRUCTURES !== 'undefined' && STRUCTURES[name]?.name) || name}</span><strong>${count}</strong></div>`)
                        .join('') || '<p style="color:#999;">Aucun contenu</p>';
                    
                    const platformStats = Object.entries(stats.byPlatform)
                        .map(([k, v]) => `<div class="stat-item"><span>${(typeof PLATFORMS !== 'undefined' && PLATFORMS[k]?.name) || k}</span><strong>${v}</strong></div>`)
                        .join('') || '<p style="color:#999;">Aucun contenu</p>';
                    
                    const formatStats = Object.entries(stats.byFormat)
                        .map(([k, v]) => `<div class="stat-item"><span>${(typeof FORMATS !== 'undefined' && FORMATS[k]?.name) || k}</span><strong>${v}</strong></div>`)
                        .join('') || '<p style="color:#999;">Aucun contenu</p>';
                    
                    // Liste des clients avec détails enrichis
                    const getStyleLabel = (val) => ONBOARDING_OPTIONS.styles.find(s => s.value === val)?.label || val;
                    const getObjectifLabel = (val) => ONBOARDING_OPTIONS.objectifs.find(o => o.value === val)?.label || val;
                    const getPublicLabels = (arr) => (arr || []).map(v => ONBOARDING_OPTIONS.publicCible.find(p => p.value === v)?.label || v);

                    // Stats par client
                    const getClientStats = (clientId) => {
                        const contents = data.contents.filter(c => c.clientId === clientId);
                        const byPillar = {};
                        contents.forEach(c => {
                            // On estime le pilier depuis la structure ou le contenu
                            byPillar[c.structure] = (byPillar[c.structure] || 0) + 1;
                        });
                        return { count: contents.length, byPillar };
                    };

                    // Mapping des plateformes vers icônes
                    const platformIcons = {
                        linkedin: '💼', instagram: '📸', tiktok: '🎵', youtube: '▶️',
                        x: '𝕏', twitter: '𝕏', facebook: 'f', threads: '🔗', pinterest: '📌', newsletter: '📧'
                    };

                    const clientsList = Object.entries(data.clientProfiles).map(([id, c]) => {
                        const clientStats = getClientStats(id);
                        // Icônes plateformes
                        const platformIconsHtml = (c.plateformes || []).slice(0, 4).map(p =>
                            `<span class="platform-icon" title="${p}">${platformIcons[p.toLowerCase()] || '🌐'}</span>`
                        ).join('');
                        const hasVoice = c.voiceProfile ? '<span class="client-badge voice">🎤</span>' : '';

                        return `
                        <div class="client-card-expanded" onclick="AgencySystem.showClientModal('${id}')">
                            <div class="client-card-header">
                                <div class="client-card-info">
                                    <div class="client-card-title">
                                        <strong title="${c.name}">${c.name}</strong>
                                        ${hasVoice}
                                    </div>
                                    <span class="client-domain">${c.domaine || 'Secteur non défini'}</span>
                                </div>
                                <span class="client-stats-badge">${clientStats.count}</span>
                            </div>
                            <div class="client-platforms-row">
                                ${platformIconsHtml || '<span class="no-data">Aucune plateforme</span>'}
                            </div>
                            <div class="client-card-footer">
                                <button onclick="event.stopPropagation(); AgencySystem.showClientModal('${id}')" class="btn-edit-client">✏️ Éditer</button>
                                <button onclick="event.stopPropagation(); AgencySystem.setCurrentClient('${id}'); AgencySystem.closeAgencyDashboard(); showToast('✅ ' + t('toasts.client_selected').replace('{name}', '${c.name}'))" class="btn-select-client">✅</button>
                                <button onclick="event.stopPropagation(); AgencySystem.deleteClient('${id}')" class="btn-delete-client" title="Supprimer">🗑️</button>
                            </div>
                        </div>
                    `;
                    }).join('') || '<p style="color:#999; text-align: center; padding: 30px; grid-column: 1/-1;">Aucun client. Importez un CSV ou créez votre premier client !</p>';
                    
                    document.getElementById('agencyDashboardContent').innerHTML = `
                        <!-- Section Gestion Clients - EN PREMIER -->
                        <div class="agency-import-section">
                            <h3 style="margin: 0 0 15px; color: #333;">📋 Gestion clients</h3>
                            <div class="agency-import-buttons">
                                <button class="btn-agency-action primary" onclick="AgencySystem.showImportModal()">
                                    <span class="btn-icon">📥</span>
                                    <span class="btn-text">Importer CSV/Excel</span>
                                </button>
                                <button class="btn-agency-action secondary" onclick="AgencySystem.downloadTemplate()">
                                    <span class="btn-icon">📄</span>
                                    <span class="btn-text">Télécharger modèle</span>
                                </button>
                                <button class="btn-agency-action tertiary" onclick="AgencySystem.showClientModal()">
                                    <span class="btn-icon">➕</span>
                                    <span class="btn-text">Nouveau client</span>
                                </button>
                            </div>
                        </div>

                        <!-- Section Liste Clients - Grille -->
                        <div class="agency-clients-section">
                            <div class="agency-section-header">
                                <h3 style="margin: 0; color: #333;">👥 Mes clients (${stats.clientCount})</h3>
                                <button class="btn btn-export-small" onclick="AgencySystem.exportClientsData()">📊 Exporter</button>
                            </div>
                            <p style="color: #888; font-size: 0.85em; margin-bottom: 15px;">Cliquez sur "Éditer" pour modifier le profil complet du client</p>
                            <div class="clients-grid">${clientsList}</div>
                        </div>

                        <!-- Section Stats -->
                        <div class="agency-stats-section">
                            <div class="agency-header">
                                <div class="agency-total">
                                    <span class="agency-total-number">${stats.total}</span>
                                    <span class="agency-total-label">contenus produits</span>
                                </div>
                                <div class="agency-total" style="background: linear-gradient(135deg, #11998e, #38ef7d);">
                                    <span class="agency-total-number">${stats.clientCount}</span>
                                    <span class="agency-total-label">clients</span>
                                </div>
                                <button class="btn btn-export" onclick="AgencySystem.exportCSV()">📊 Export contenus</button>
                            </div>

                            <h3 style="margin: 25px 0 15px; color: #333;">📈 Production mensuelle</h3>
                            <div class="chart-container">${monthBars}</div>

                            <h3 style="margin: 25px 0 15px; color: #333;">👥 Top Clients</h3>
                            <div class="stats-grid">${topClients}</div>

                            <h3 style="margin: 25px 0 15px; color: #333;">📖 Structures favorites</h3>
                            <div class="stats-grid">${topStructures}</div>

                            <div class="agency-stats-grid">
                                <div>
                                    <h3 style="margin: 0 0 10px; color: #333;">📱 Plateformes</h3>
                                    <div class="stats-grid">${platformStats}</div>
                                </div>
                                <div>
                                    <h3 style="margin: 0 0 10px; color: #333;">🎬 Formats</h3>
                                    <div class="stats-grid">${formatStats}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="rgpd-dashboard-section">
                            <h3 style="margin: 0 0 15px; color: #333; display: flex; align-items: center; gap: 10px;">
                                🔒 Protection des données (RGPD)
                            </h3>
                            <div class="rgpd-info-box">
                                <p><strong>Traitement 100% local</strong> : Toutes vos données clients sont stockées uniquement dans votre navigateur. Aucune donnée n'est envoyée sur nos serveurs.</p>
                                ${data.rgpdConsent ? `<p class="rgpd-consent-info">✅ <strong>Consentement actif</strong> depuis le ${new Date(data.rgpdConsentDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}</p>` : ''}
                            </div>
                            <div class="rgpd-buttons">
                                <button onclick="AgencySystem.exportClientsData()" class="btn-rgpd export">
                                    📥 Exporter mes données
                                    <small>Droit à la portabilité</small>
                                </button>
                                <button onclick="AgencySystem.deleteAllData()" class="btn-rgpd delete">
                                    🗑️ Supprimer mes données
                                    <small>Droit à l'effacement</small>
                                </button>
                                ${data.rgpdConsent ? `
                                <button onclick="AgencySystem.revokeRGPDConsent()" class="btn-rgpd revoke">
                                    🚫 Révoquer mon consentement
                                    <small>Supprime toutes les données</small>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    document.getElementById('agencyDashboardModal').classList.add('show');
                } catch (e) {
                    console.error('Dashboard error:', e);
                    showToast('❌ ' + t('toasts.error') + ': ' + e.message);
                }
            },

            closeAgencyDashboard() {
                document.getElementById('agencyDashboardModal').classList.remove('show');
            },

            // Export des données clients (pour RGPD - droit à la portabilité)
            exportClientsData() {
                const data = this.get();
                const clients = Object.entries(data.clientProfiles);

                if (clients.length === 0) {
                    showToast('❌ ' + t('toasts.no_client_to_export'));
                    return;
                }

                const headers = [
                    'Nom', 'Domaine', 'Message unique', 'Piliers', 'Tags', 'Audience',
                    'Public cible', 'Tranche age', 'Style', 'Objectif', 'Plateformes',
                    'Formats', 'Notes', 'Date création', 'Profil voix'
                ];

                const rows = clients.map(([id, c]) => [
                    c.name || '',
                    c.domaine || '',
                    c.messageUnique || '',
                    (c.piliers || []).join(', '),
                    c.tags || '',
                    c.audience || '',
                    (c.publicCible || []).join(', '),
                    Array.isArray(c.trancheAge) ? c.trancheAge.join(', ') : (c.trancheAge || ''),
                    c.style || '',
                    c.objectif || '',
                    (c.plateformes || []).join(', '),
                    (c.formats || []).join(', '),
                    c.notes || '',
                    c.createdAt ? new Date(c.createdAt).toLocaleDateString('fr-FR') : '',
                    c.voiceProfile ? 'Oui' : 'Non'
                ].map(v => '"' + String(v).replace(/"/g, '""') + '"'));

                const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mes-clients-sos-storytelling-' + new Date().toISOString().slice(0, 10) + '.csv';
                a.click();
                URL.revokeObjectURL(url);
                showToast('📊 ' + t('toasts.rgpd_exported'));
            },

            // Révoquer le consentement RGPD
            revokeRGPDConsent() {
                if (confirm('⚠️ Révoquer votre consentement supprimera également toutes les données clients. Continuer ?')) {
                    const data = this.get();
                    data.rgpdConsent = false;
                    data.rgpdConsentDate = null;
                    data.clientProfiles = {};
                    data.contents = [];
                    data.currentClientId = null;
                    this.save(data);
                    this.updateUI();
                    this.closeAgencyDashboard();
                    showToast('🔒 ' + t('toasts.consent_revoked'));
                }
            }
        };

        // ==================== SYSTÈME DE MÉMOIRE ====================
        const ContentMemory = {
            KEY: 'tithot_content_memory',
            
            get() {
                try {
                    const stored = JSON.parse(localStorage.getItem(this.KEY));
                    if (!stored) return { contents: [], pillarUsage: {}, lastPillar: null };
                    return {
                        contents: stored.contents || [],
                        pillarUsage: stored.pillarUsage || {},
                        lastPillar: stored.lastPillar || null
                    };
                } catch (e) {
                    return { contents: [], pillarUsage: {}, lastPillar: null };
                }
            },
            
            save(memory) {
                localStorage.setItem(this.KEY, JSON.stringify(memory));
            },
            
            // Ajouter un contenu généré
            addContent(content, pillar, platform, format) {
                const memory = this.get();
                memory.contents.unshift({
                    id: Date.now(),
                    date: new Date().toISOString(),
                    preview: content.substring(0, 100),
                    pillar: pillar,
                    platform: platform,
                    format: format
                });
                // Garder les 50 derniers
                if (memory.contents.length > 50) memory.contents.pop();
                
                // Tracker l'usage des piliers
                if (pillar) {
                    memory.pillarUsage[pillar] = (memory.pillarUsage[pillar] || 0) + 1;
                    memory.lastPillar = pillar;
                }
                
                this.save(memory);
            },
            
            // Obtenir le pilier le moins utilisé
            getLeastUsedPillar(piliers) {
                if (!piliers || piliers.length === 0) return null;
                const memory = this.get();
                let minUsage = Infinity;
                let leastUsed = piliers[0];
                
                piliers.forEach(p => {
                    const usage = memory.pillarUsage[p] || 0;
                    if (usage < minUsage) {
                        minUsage = usage;
                        leastUsed = p;
                    }
                });
                
                return leastUsed;
            },
            
            // Obtenir le prochain pilier (alternance)
            getNextPillar(piliers) {
                if (!piliers || piliers.length === 0) return null;
                const memory = this.get();
                const lastIndex = piliers.indexOf(memory.lastPillar);
                const nextIndex = (lastIndex + 1) % piliers.length;
                return piliers[nextIndex];
            },
            
            // Résumé pour l'IA
            getSummaryForAI() {
                const memory = this.get();
                if (memory.contents.length === 0) return null;
                
                const recent = memory.contents.slice(0, 10);
                const topics = recent.map(c => c.preview).join(' | ');
                const pillarStats = Object.entries(memory.pillarUsage)
                    .sort((a, b) => b[1] - a[1])
                    .map(([p, count]) => `${p} (${count}x)`)
                    .join(', ');
                
                return {
                    totalContents: memory.contents.length,
                    recentTopics: topics,
                    pillarStats: pillarStats,
                    lastPillar: memory.lastPillar
                };
            }
        };

        // ==================== SÉCURITÉ XSS ====================
        // Fonction pour échapper les caractères HTML dangereux
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        // Exposer globalement
        window.escapeHtml = escapeHtml;

        // ==================== ÉTAT DE L'APPLICATION ====================
        let currentState = { structure: 'aida', format: 'post', platform: 'linkedin', tone: 'default', idea: '', generatedContent: '', ideasContent: '', currentPillar: null, pubPlatform: 'meta', pubObjective: 'conversion', strategyMode: false, strategyDay: null, strategyType: 'vendre' };

        // ==================== DONNÉES 20 JOURS STRATÉGIQUES ====================
        // Parcours "VENDRE MES SERVICES" - Templates conversion
        const STRATEGY_DAYS_VENDRE = {
            1: {
                title: "Dégommer une objection client",
                objective: "Lever les freins à l'achat",
                template: `L'objection que j'entends le plus souvent : {ex: "C'est trop cher" ou "J'ai pas le temps"}

Pourquoi cette objection est infondée : {explique pourquoi c'est une fausse croyance}

Un client qui avait cette objection : {prénom ou description du client}
Ce qui l'a fait changer d'avis : {le déclic, l'argument, le résultat qu'il a obtenu}

Mon offre : {ton service/produit concerné}`
            },
            2: {
                title: "Opinion impopulaire / Controverse",
                objective: "Te positionner, créer le débat",
                template: `La pratique courante qui m'énerve dans mon secteur : {ex: "les promesses de résultats en 30 jours"}

La "vérité" que tout le monde répète mais qui est fausse : {le mythe à déconstruire}

Ce que je fais différemment (et qui choque parfois) : {ta méthode, ton approche}

Mon offre : {ton service/produit}`
            },
            3: {
                title: "Ce que j'aurais aimé savoir avant",
                objective: "Créer de l'identification",
                template: `L'erreur que j'ai faite au début par ignorance : {décris la situation}

Le conseil qui m'aurait fait gagner du temps : {ce que tu aurais aimé qu'on te dise}

La croyance limitante que j'avais : {ce que tu pensais à tort}
Ce que j'ai découvert : {la réalité}

Mon offre : {ton service/produit}`
            },
            4: {
                title: "5 conseils à mon moi du passé",
                objective: "Inspirer, montrer ton parcours",
                template: `La période à laquelle je m'adresse : {ex: "moi il y a 5 ans, quand je débutais"}

Mes 5 conseils :
1. {premier conseil}
2. {deuxième conseil}
3. {troisième conseil}
4. {quatrième conseil}
5. {cinquième conseil}

Mon offre : {ton service/produit}`
            },
            5: {
                title: "3 erreurs que fait ton client",
                objective: "Éduquer, créer le \"c'est moi\"",
                template: `Les 3 erreurs que je vois tout le temps :

Erreur 1 : {l'erreur}
Pourquoi ils la font : {la raison}
La conséquence : {ce qui se passe}

Erreur 2 : {l'erreur}
Pourquoi ils la font : {la raison}
La conséquence : {ce qui se passe}

Erreur 3 : {l'erreur}
Pourquoi ils la font : {la raison}
La conséquence : {ce qui se passe}

Mon offre : {ton service/produit}`
            },
            6: {
                title: "Les obstacles de mon parcours",
                objective: "Humaniser, créer l'empathie",
                template: `Le moment difficile que j'ai traversé : {décris la situation, le contexte}

Comment je l'ai surmonté : {les actions, les décisions, l'aide reçue}

Ce que ça m'a appris : {la leçon, ce que tu en retires aujourd'hui}

Mon offre : {ton service/produit}`
            },
            7: {
                title: "Le secret des meilleurs",
                objective: "Te positionner en expert",
                template: `Ce qui distingue mes meilleurs clients / les top performers : {la différence clé}

Le point commun que j'observe chez ceux qui réussissent : {le pattern récurrent}

Ce que les autres ne font pas : {ce qui manque chez ceux qui stagnent}

Mon offre : {ton service/produit}`
            },
            8: {
                title: "Déconstruire une idée reçue",
                objective: "Challenger, montrer ta vision",
                template: `Le mythe dans mon secteur : {la "vérité" que tout le monde croit}

Pourquoi les gens y croient : {l'origine de cette croyance}

La réalité selon mon expérience : {ce que tu as constaté}

Mon offre : {ton service/produit}`
            },
            9: {
                title: "Fausses croyances des clients",
                objective: "Préparer la vente",
                template: `Ce que mes clients croient AVANT de travailler avec moi : {la croyance limitante}

Ce qui les empêche de passer à l'action : {le frein, la peur}

Comment je les fais changer d'avis : {ton argument, ta preuve}

Mon offre : {ton service/produit}`
            },
            10: {
                title: "Les pièges à éviter",
                objective: "Protéger, guider",
                template: `Les pièges dans lesquels tombent mes clients/les débutants :

Piège 1 : {le piège}
Comment le reconnaître : {les signaux}

Piège 2 : {le piège}
Comment le reconnaître : {les signaux}

Piège 3 : {le piège}
Comment le reconnaître : {les signaux}

Mon offre : {ton service/produit}`
            },
            11: {
                title: "Se positionner en autorité",
                objective: "Affirmer ton expertise",
                template: `Ma zone de génie (ce sur quoi on me consulte toujours) : {ta spécialité}

Mon parcours qui légitime cette expertise : {tes expériences, formations, résultats}

La vision que je défends : {ta conviction, ta philosophie}

Mon offre : {ton service/produit}`
            },
            12: {
                title: "3 règles d'or de ton expertise",
                objective: "Donner de la valeur",
                template: `Mes 3 principes fondamentaux :

Règle 1 : {le principe}
Comment je l'applique : {exemple concret}

Règle 2 : {le principe}
Comment je l'applique : {exemple concret}

Règle 3 : {le principe}
Comment je l'applique : {exemple concret}

Mon offre : {ton service/produit}`
            },
            13: {
                title: "La rencontre qui a changé ma vie",
                objective: "Storytelling, émotion",
                template: `La personne qui a eu un impact décisif sur mon parcours : {qui est-ce}

Comment cette rencontre s'est produite : {le contexte, les circonstances}

Ce que cette personne m'a apporté/appris : {la transformation, la leçon}

Mon offre : {ton service/produit}`
            },
            14: {
                title: "Réponse à une question fréquente",
                objective: "Montrer ton expertise",
                template: `La question qu'on me pose tout le temps : "{la question exacte}"

Pourquoi les gens se posent cette question : {le contexte, la douleur}

Ma réponse complète et honnête : {ta réponse détaillée}

Mon offre : {ton service/produit}`
            },
            15: {
                title: "Étude de cas client",
                objective: "Preuve sociale",
                template: `Mon client : {prénom ou description, ex: "Marie, coach sportive"}

Sa situation AVANT : {le problème, la douleur, les chiffres}

Ce qu'on a fait ensemble : {ton intervention, ta méthode}

Le résultat : {la transformation, les chiffres, le témoignage}

Mon offre : {ton service/produit}`
            },
            16: {
                title: "Transformation avant/après",
                objective: "Visualiser le résultat",
                template: `L'avant/après qui illustre le mieux mon impact :

AVANT : {la situation de départ, les chiffres, la douleur}

APRÈS : {les résultats concrets, les chiffres, le ressenti}

En combien de temps : {la durée de la transformation}

Mon offre : {ton service/produit}`
            },
            17: {
                title: "Les paradigmes ont changé",
                objective: "Créer l'urgence d'évoluer",
                template: `Ce qui a fondamentalement changé dans mon secteur : {le changement majeur}

Ce qui marchait avant et ne marche plus : {les anciennes méthodes obsolètes}

La nouvelle approche gagnante : {ce qu'il faut faire maintenant}

Mon offre : {ton service/produit}`
            },
            18: {
                title: "Portrait d'une personne inspirante",
                objective: "Montrer tes valeurs",
                template: `La personne qui m'inspire : {qui est-ce}

Pourquoi cette personne : {ce qui te touche chez elle}

Ce que j'ai appris d'elle : {la leçon, l'impact sur toi}

Mon offre : {ton service/produit}`
            },
            19: {
                title: "Pratique répandue à bannir",
                objective: "Se différencier",
                template: `La pratique courante que je trouve contre-productive : {la mauvaise pratique}

Pourquoi les gens continuent de la faire : {l'inertie, la facilité, l'ignorance}

L'alternative que je propose : {ta méthode, ton approche}

Mon offre : {ton service/produit}`
            },
            20: {
                title: "Raconter un échec + leçon",
                objective: "Connexion par la vulnérabilité",
                template: `L'échec qui m'a fait grandir : {le contexte}

Ce qui s'est passé concrètement : {les faits, la chute}

Ce que j'aurais fait différemment : {la leçon apprise}

Mon offre : {ton service/produit}`
            }
        };

        // Parcours "MONTRER MON EXPERTISE" - Thought Leadership pour être cité par les IA
        const STRATEGY_DAYS_EXPERTISE = {
            1: {
                title: "Golden Circle — Ton POURQUOI",
                framework: "Simon Sinek's Golden Circle",
                objective: "Inspirer en expliquant ta mission profonde",
                template: `Mon POURQUOI (ma mission profonde) : {ce qui me fait lever le matin, ma conviction}

Mon COMMENT (ma méthode unique) : {ce qui me différencie des autres}

Mon QUOI (mon offre concrète) : {ce que je propose}`
            },
            2: {
                title: "Pyramide de Minto — Argument structuré",
                framework: "Minto's Pyramid Principle",
                objective: "Convaincre avec une logique imparable",
                template: `Ma conclusion principale : {ton message clé, dis-le en premier}

Argument 1 : {premier argument qui soutient ta conclusion}
Argument 2 : {deuxième argument}
Argument 3 : {troisième argument}

Preuves/détails : {données, exemples concrets}`
            },
            3: {
                title: "Pixar Pitch — Histoire transformationnelle",
                framework: "The Pixar Pitch",
                objective: "Captiver émotionnellement avec le storytelling",
                template: `Il était une fois... {le contexte initial}

Tous les jours... {la routine, le statu quo}

Un jour... {l'élément déclencheur, le problème}

À cause de ça... {les conséquences}

Jusqu'à ce que finalement... {la transformation, la solution}`
            },
            4: {
                title: "StoryBrand — Ton client est le héros",
                framework: "StoryBrand (Donald Miller)",
                objective: "Clarifier ton message en faisant du client le héros",
                template: `Le HÉROS (ton client) : {qui est-il, que veut-il}

Son PROBLÈME : {externe, interne, philosophique}

Le GUIDE (toi) : {ton empathie + ton autorité}

Le PLAN en 3 étapes :
1. {première étape}
2. {deuxième étape}
3. {troisième étape}

L'APPEL À L'ACTION : {ce qu'il doit faire maintenant}

Le SUCCÈS s'il agit : {ce qu'il va obtenir}
L'ÉCHEC s'il n'agit pas : {ce qu'il va perdre}`
            },
            5: {
                title: "ABT — Message persuasif rapide",
                framework: "ABT (And, But, Therefore) — Randy Olson",
                objective: "Créer un message concis et percutant",
                template: `AND (contexte partagé) : {ce qu'on sait tous, la situation}

BUT (le problème) : {la tension, le retournement, ce qui coince}

THEREFORE (ta solution) : {l'action, la conclusion, ce qu'il faut faire}`
            },
            6: {
                title: "What / So What / Now What",
                framework: "Driscoll's Reflective Model",
                objective: "Transformer une expérience en leçon actionnable",
                template: `WHAT (les faits) : {que s'est-il passé, objectivement}

SO WHAT (l'analyse) : {pourquoi c'est important, les implications}

NOW WHAT (les actions) : {que faire maintenant, les prochaines étapes}`
            },
            7: {
                title: "Contenu expert ultra-poussé",
                framework: "Deep Expertise Content",
                objective: "Créer du contenu que les IA vont citer",
                template: `Le sujet que je maîtrise mieux que 95% des gens : {ton expertise pointue}

Les données/stats que je peux partager : {chiffres, études, résultats}

Mon framework ou méthodologie : {ta méthode structurée}

L'idée de visuel/infographie : {comment le représenter}`
            },
            8: {
                title: "Opinion tranchée sur un sujet chaud",
                framework: "Hot Take / Conviction Content",
                objective: "Prendre position pour polariser et attirer ta tribu",
                template: `L'actualité/tendance qui me fait réagir : {le sujet chaud}

Mon opinion NON consensuelle : {ce que je pense vraiment}

Pourquoi je pense ça (mon expérience) : {les faits qui fondent ton opinion}

Qui sera d'accord / en désaccord : {ta tribu vs les autres}`
            },
            9: {
                title: "Déconstruction d'un mythe",
                framework: "Myth Busting",
                objective: "Éduquer en cassant une idée reçue",
                template: `Le mythe qui persiste : "{ce que tout le monde croit}"

D'où vient ce mythe : {l'origine historique ou logique}

Les preuves qu'il est faux : {données, exemples, expériences}

La réalité que j'observe : {ce qui est vraiment vrai}`
            },
            10: {
                title: "Prédiction secteur / Tendances",
                framework: "Future Forecasting",
                objective: "Te positionner comme visionnaire de ton domaine",
                template: `Les tendances émergentes que j'observe : {signaux faibles}

Ce qui va changer dans 2-5 ans : {tes prédictions}

Ce qui va disparaître : {les pratiques obsolètes}
Ce qui va émerger : {les nouvelles pratiques}

Comment se préparer dès maintenant : {actions concrètes}`
            },
            11: {
                title: "Framework original que tu as créé",
                framework: "Proprietary Framework",
                objective: "Créer un concept associé à ton nom",
                template: `Ma méthode que j'utilise systématiquement : {décris-la}

Le nom accrocheur de mon framework : {acronyme ou nom mémorable}

Les étapes (3-5 max) :
1. {étape 1}
2. {étape 2}
3. {étape 3}

Exemple d'application concrète : {un cas réel}`
            },
            12: {
                title: "Analyse de cas public",
                framework: "Public Case Study",
                objective: "Montrer ton expertise via l'analyse d'un cas connu",
                template: `L'entreprise/personnalité que j'analyse : {qui et ce qu'ils ont fait}

Ce qu'ils ont bien fait : {les points positifs}
Ce qu'ils ont mal fait : {les erreurs}

Ce que j'aurais fait différemment : {ton expertise}

La leçon universelle à en tirer : {l'apprentissage pour tous}`
            },
            13: {
                title: "Les coulisses de ton processus",
                framework: "Behind The Scenes",
                objective: "Humaniser ton expertise en montrant comment tu travailles",
                template: `Le défi que je devais résoudre : {le contexte}

Mon processus étape par étape : {comment tu as réfléchi/agi}

Les outils que j'ai utilisés : {tes outils concrets}

Le résultat obtenu : {ce que ça a donné}

Ce que je ferais différemment : {ton apprentissage}`
            },
            14: {
                title: "Réponse approfondie à une question complexe",
                framework: "Deep Dive Q&A",
                objective: "Créer du contenu que les IA citeront comme réponse",
                template: `La question qu'on me pose souvent : "{la question exacte}"

Ma réponse courte (2 lignes) : {l'essentiel}

Ma réponse complète : {tous les détails, nuances, cas particuliers}

Ressources pour aller plus loin : {livres, outils, liens}`
            },
            15: {
                title: "Comparatif expert",
                framework: "Expert Comparison",
                objective: "Aider à choisir en montrant ta maîtrise du sujet",
                template: `Le dilemme : {Option A} vs {Option B} vs {Option C}

Mes critères de comparaison : {comment tu évalues}

Mon verdict selon les cas :
- Si {situation 1} → je recommande {option}
- Si {situation 2} → je recommande {option}

Mon choix personnel et pourquoi : {ce que tu utilises toi}`
            },
            16: {
                title: "Leçons d'un échec public",
                framework: "Public Failure Analysis",
                objective: "Gagner en crédibilité par la vulnérabilité intelligente",
                template: `L'échec que je partage : {ce qui s'est passé, factuel}

Ce qui a mal tourné : {l'analyse honnête}

Ce que j'ai appris :
1. {leçon 1}
2. {leçon 2}
3. {leçon 3}

Ce que je fais différemment aujourd'hui : {le changement}`
            },
            17: {
                title: "Interview/Citation d'un expert",
                framework: "Expert Curation",
                objective: "Te positionner en connecteur de ton écosystème",
                template: `La personne que j'admire : {nom et qui elle est}

La citation/idée qui m'a marqué : "{citation exacte}"

Pourquoi c'est important : {ton interprétation}

Comment je l'applique concrètement : {dans ton travail}`
            },
            18: {
                title: "Les erreurs que tu vois partout",
                framework: "Common Mistakes Exposé",
                objective: "Éduquer en pointant ce qui ne marche pas",
                template: `Après {X années/clients}, je vois toujours ces erreurs :

Erreur 1 : {l'erreur}
→ Pourquoi c'est un problème : {conséquences}
→ La solution : {la bonne approche}

Erreur 2 : {l'erreur}
→ Pourquoi c'est un problème : {conséquences}
→ La solution : {la bonne approche}

Erreur 3 : {l'erreur}
→ Pourquoi c'est un problème : {conséquences}
→ La solution : {la bonne approche}`
            },
            19: {
                title: "Ressources curatées",
                framework: "Resource Curation",
                objective: "Devenir LA référence qui centralise les meilleures ressources",
                template: `Thème : Les meilleures ressources pour {objectif}

Pour débuter : {ressources niveau débutant}

Pour approfondir : {ressources niveau intermédiaire}

Pour les experts : {ressources niveau avancé}

Mon TOP 3 personnel : {tes préférées et pourquoi}

Ce qui manque sur le marché : {le gap que tu observes}`
            },
            20: {
                title: "Manifeste / Ta vision du métier",
                framework: "Manifesto",
                objective: "Affirmer ta vision pour attirer ceux qui pensent comme toi",
                template: `JE CROIS QUE... {tes convictions profondes}

JE REFUSE DE... {ce contre quoi tu te bats}

JE M'ENGAGE À... {ce que tu fais différemment}

JE RÊVE D'UN MONDE OÙ... {ta vision du futur}

SI TU PENSES COMME MOI... {ton appel à rejoindre ta tribu}`
            }
        };

        // Alias pour compatibilité avec le code existant - utilise l'objectif du profil
        function getStrategyDays() {
            const profile = UserProfile.get();
            const objective = profile?.strategyObjective || 'vendre';
            return objective === 'expertise' ? STRATEGY_DAYS_EXPERTISE : STRATEGY_DAYS_VENDRE;
        }

        // ==================== GHOSTWRITER PROMPT (Mode Storytelling Anecdote) ====================
        const GHOSTWRITER_PROMPT = `
=== MODE STORYTELLING ANECDOTE ===

Tu es un copywriter spécialisé en rédaction de publications LinkedIn. Tu es un professionnel de l'écriture de posts. Tu connais parfaitement l'algorithme LinkedIn et les bonnes pratiques pour maximiser la visibilité et l'engagement des posts.

L'utilisateur t'a fourni une ANECDOTE VRAIE. Ta tâche : transformer cette anecdote en post LinkedIn percutant.

RÈGLES ABSOLUES :
- Respecte l'anecdote donnée. N'invente PAS une nouvelle histoire.
- Enrichis avec du contexte, du storytelling, des détails percutants.
- Si l'anecdote est courte, développe-la tout en restant fidèle aux faits.

---

STRUCTURE EN 5 PARTIES :

1️⃣ L'ACCROCHE (1-2 phrases)
Commence par une phrase choc, un fait marquant, une mise en scène forte, un angle inattendu ou une situation intrigante.

3 méthodes d'accroche :
- Méthode 1 : Situation conflictuelle ou atypique
  Ex : "Un candidat est arrivé 25 minutes en retard au premier entretien 😅 Là c'est au revoir direct!"
- Méthode 2 : Paradoxe ou phrase intrigante
  Ex : "J'ai emmené ma voiture chez Mercedes pour la révision et ils ont fait le +1% qui va me faire revenir chez eux."
- Méthode 3 : Constat direct (voire frontal)
  Ex : "Hier, un membre de ma famille m'a dit : 'Ton contenu est affligeant. J'ai honte que tu sois dans ma famille.'"

L'accroche doit évoquer une situation INCOMPLÈTE : le lecteur comprend ce qui se passe mais il lui manque la suite.

2️⃣ LE DÉVELOPPEMENT
Détaille l'histoire avec des événements concrets. Progresse par petits paragraphes courts.
Chaque paragraphe apporte : un contexte, un problème, une émotion, un rebondissement.

3️⃣ L'ÉVOLUTION / LA RÉSOLUTION
Raconte comment le problème, le conflit, la difficulté a été géré.
Développe le tournant, la décision ou la solution adoptée.

4️⃣ LA RÉFLEXION / LA MORALE
Le post doit comporter une leçon, un message universel, une morale ou un apprentissage.
Formule cette leçon de façon concise. Tu peux la placer en fin de post ou au milieu.
Fais en sorte que la morale s'intègre naturellement à l'histoire.

5️⃣ LA CONCLUSION / PHRASE-CLÉ MARQUANTE
Termine par 1-2 phrases mémorables, très fortes, percutantes ou inspirantes.
Cette phrase doit être concise, punchy et frapper l'esprit.
Ex : "Petite action +1% = Grande différence."
Ex : "Ne laisse pas les critiques te freiner. Prouve-leur qu'elles ont tort. Et gagne."

---

6 TECHNIQUES DE STORYTELLING À UTILISER :

1. CONFLIT/TENSION
Introduis un conflit, un problème, une injustice, un désaccord, un obstacle.
Mets en scène ce conflit, décris la tension ressentie.

2. RESSENTIS/DOUTES
Raconte comment tu t'es senti, quels doutes tu avais.
Parle de tes questionnements intérieurs, de tes réactions.
Ex : "Ça n'a pas été simple : j'ai beaucoup pleuré."

3. DIALOGUES/CITATIONS
Utilise des dialogues ou des citations directes pour donner vie à la scène.
Ex : "Le premier réflexe a été d'appeler mon mec et de lui dire 'Ils m'ont lavé la voiture !!!!'"
Sois concis : quelques répliques percutantes suffisent.

4. DÉTAILS PRÉCIS
Ne dis aucune généralité. Donne des détails précis : chiffres, noms, lieux, dates.
Ex : "Il était 2h du matin, et tout le monde avait bu du vin", "Salomé Saqué"

5. EFFET DE SURPRISE
Il doit y avoir un renversement de situation ou un élément inattendu.
Ex : On pense que le candidat va se faire recaler. Surprise : finalement, l'auteur conclut un deal avec lui.

6. LIEN PERSONNEL
Mentionne un lien personnel si possible : un ami, un mentor, un conjoint, un collaborateur.
Mets en lumière les émotions liées à cette proximité : déception, fierté, peur de perdre la relation.

---

MISE EN PAGE :
- Paragraphes très courts (1 à 3 phrases max)
- Sauts de ligne fréquents — format aéré
- Pas de titre ou sous-titre
- Pas de bullet points dans le corps du texte
- Écris d'une traite sans séparer les parties avec des séparateurs

STYLE D'ÉCRITURE :
- Langage direct et simple, comme si tu parlais à un ami
- Ton informel et amical
- Phrases courtes, style conversationnel
- Pas de mots compliqués ou de jargon
- Pas de répétitions
- Utilise "je", "tu", "nous"
- Conclusion courte et punchy (max 2 lignes)

LONGUEUR : Minimum 240 mots, mais peut être plus long si l'histoire le justifie.
`;

        // ==================== FONCTIONS ANECDOTE / TEMPLATE ====================
        // Récupérer l'anecdote ou le contenu du template éditable
        function getAnecdote() {
            // En mode 20 jours avec template éditable, utiliser le template
            if (currentState.strategyMode && document.getElementById('editableTemplate')) {
                return getEditableTemplateContent();
            }
            // Sinon, utiliser le textarea anecdote classique
            const input = document.getElementById('anecdoteInput');
            return input ? input.value.trim() : '';
        }

        // Vérifier si mode Ghostwriter actif (anecdote ou template rempli)
        function isGhostwriterMode() {
            const anecdote = getAnecdote();
            return anecdote && anecdote.length > 20;
        }

        // Initialiser les listeners anecdote
        function initAnecdoteListeners() {
            const anecdoteInput = document.getElementById('anecdoteInput');
            if (anecdoteInput) {
                anecdoteInput.addEventListener('input', function() {
                    const section = document.getElementById('anecdoteSection');
                    const badge = document.getElementById('ghostwriterBadge');

                    if (this.value.trim().length > 20) {
                        section?.classList.add('has-content');
                        if (badge) badge.style.display = 'inline-flex';
                    } else {
                        section?.classList.remove('has-content');
                        if (badge) badge.style.display = 'none';
                    }
                });
            }
        }

        const STRUCTURES = {
            'aida': { name: 'AIDA', prompt: 'Structure AIDA (Attention, Intérêt, Désir, Action)' },
            'golden-circle': { name: 'Golden Circle', prompt: 'Golden Circle de Simon Sinek (POURQUOI → COMMENT → QUOI)' },
            'hero-journey': { name: 'Voyage du Héros', prompt: 'Voyage du Héros (Situation, Défi, Transformation, Enseignement)' },
            'avant-apres': { name: 'Avant / Après', prompt: 'Structure Avant/Après (Problème AVANT, transformation, résultat APRÈS)' },
            'hook-story-cta': { name: 'Hook + Story + CTA', prompt: 'Hook + Story + Value + CTA' },
            'storybrand': { name: 'StoryBrand', prompt: 'Framework StoryBrand (lecteur = héros, toi = guide)' },
            'pattern-interrupt': { name: 'Pattern Interrupt', prompt: 'Pattern Interrupt (début inattendu qui brise les attentes)' },
            '3-actes': { name: '3 Actes', prompt: 'Structure en 3 actes (Exposition, Conflit, Résolution)' }
        };
        
        const FORMATS = {
            'post': {
                name: 'Post',
                length: '150-300 mots',
                specifics: 'texte fluide avec sauts de ligne',
                rules: 'Hook fort en 2 lignes max, paragraphes courts, CTA final avec question engageante'
            },
            'carousel': {
                name: 'Carousel',
                length: '8-10 slides',
                specifics: 'Slide 1 = hook, 1 idée par slide',
                rules: 'Slide 1 = accroche FORTE qui donne envie de swiper, 1 idée MAX par slide, slide finale = CTA + récap, texte court par slide (max 20 mots), numéroter les slides'
            },
            'reel': {
                name: 'Reel/TikTok',
                length: 'script 30-60 sec',
                specifics: 'Script parlé, hook en 3 sec',
                rules: 'Format SCRIPT PARLÉ (indiquer ce que la personne doit DIRE), hook dans les 3 premières secondes, phrases courtes et dynamiques, indiquer [TEXTE À L\'ÉCRAN] si pertinent'
            },
            'story': {
                name: 'Story',
                length: '3-5 stories',
                specifics: '1 idée par story',
                rules: 'Texte court et lisible (max 100 caractères par story), 1 idée par story, dernière story = CTA (swipe up, réponse, lien, sondage)'
            },
            'thread': {
                name: 'Thread',
                length: '5-10 tweets',
                specifics: '280 car max par tweet',
                rules: 'STRICT : 280 caractères MAXIMUM par tweet, numéroter 1/, 2/, etc., tweet 1 = hook accrocheur, dernier tweet = CTA et récap'
            },
            'article': {
                name: 'Article/Blog',
                length: '500-800 mots',
                specifics: 'Introduction, sous-titres, conclusion',
                rules: 'Introduction engageante avec promesse, H2/H3 pour structurer, listes à puces pour la lisibilité, conclusion avec CTA clair'
            }
        };
        
        const PLATFORMS = {
            'linkedin': {
                name: 'LinkedIn',
                tone: 'professionnel mais humain',
                rules: `RÈGLES LINKEDIN :
- Longueur idéale : 1300-1500 caractères (posts longs performent mieux)
- Hook : Les 2 premières lignes AVANT le "voir plus" sont cruciales
- Formatage : Sauts de ligne fréquents, paragraphes courts (1-3 phrases)
- Hashtags : 3-5 maximum, en fin de post, mix populaires/niche
- Liens : ÉVITER dans le post (algorithme pénalise), mettre en commentaire
- Emojis : Avec parcimonie (1-2 max), professionnels
- CTA : Question ouverte qui invite au commentaire
- INTERDIT : Éditer le post dans les 2h après publication`
            },
            'instagram': {
                name: 'Instagram',
                tone: 'visuel et émotionnel',
                rules: `RÈGLES INSTAGRAM :
- Légende : 150-300 caractères pour posts feed (court et percutant)
- Hashtags : 5-10 pertinents, mix populaires et niche, en fin de légende
- Emojis : Autorisés et encouragés, renforcent l'émotion
- Formatage : Sauts de ligne, aéré, facile à scanner
- CTA : Invite à sauvegarder, partager ou commenter
- Stories : 1 idée par story, texte court et lisible
- Reels : Hook dans les 3 premières secondes`
            },
            'tiktok': {
                name: 'TikTok',
                tone: 'dynamique, authentique et direct',
                rules: `RÈGLES TIKTOK :
- Hook : Les 3 PREMIÈRES SECONDES sont CRITIQUES (rétention)
- Format : Script parlé, pas de texte à lire
- Ton : Conversationnel, comme si tu parlais à un ami
- Durée script : 30-60 secondes optimal
- Hashtags : 3-5 dont 1-2 tendance (#fyp, #pourtoi)
- Sons : Mentionner si un son tendance serait pertinent
- CTA : "Suis-moi pour plus de...", "Commente si..."`
            },
            'twitter': {
                name: 'Twitter/X',
                tone: 'concis et percutant',
                rules: `RÈGLES TWITTER/X :
- Longueur : 280 caractères MAXIMUM par tweet (STRICT)
- Threads : Numéroter (1/, 2/, etc.), 5-10 tweets max
- Hook : Premier tweet = accroche forte
- Hashtags : 1-2 maximum, intégrés naturellement
- Emojis : Avec parcimonie
- CTA : RT, like, follow ou question
- Ton : Direct, opinions tranchées performent`
            },
            'facebook': {
                name: 'Facebook',
                tone: 'conversationnel et accessible',
                rules: `RÈGLES FACEBOOK :
- Longueur : 100-250 mots idéal
- Formatage : Paragraphes courts, aéré
- Emojis : Autorisés, ton friendly
- Questions : Encouragent l'engagement
- Liens : Autorisés mais reach réduit
- Groupes : Ton plus communautaire`
            },
            'youtube': {
                name: 'YouTube',
                tone: 'dynamique et engageant',
                icon: '🎬',
                rules: `RÈGLES YOUTUBE :
- Format : Script PARLÉ (pas à lire, à dire à voix haute)
- Hook : 5 premières secondes = captiver immédiatement
- Structure : Hook → Problème → Solution → Valeur → CTA
- Description : 150-200 mots SEO avec mots-clés
- Titre : 3 propositions accrocheuses (curiosité/bénéfice/tension)
- Timestamps : Suggérer des chapitres
- CTA : "Abonne-toi", "Active la cloche", "Dis-moi en commentaire"`
            },
            'substack': {
                name: 'Substack',
                tone: 'intime et conversationnel',
                icon: '📨',
                rules: `RÈGLES SUBSTACK/NEWSLETTER :
- Longueur : 800-1500 mots (format long accepté)
- Ton : Comme une lettre à un ami proche
- Accroche : Anecdote personnelle ou réflexion
- Structure : Sous-titres clairs pour faciliter la lecture
- Contenu : Alterner réflexion personnelle et valeur actionnable
- CTA : Invitation à répondre à l'email ou s'abonner
- PAS de hashtags, signature personnelle à la fin`
            }
        };

        // Fonction pour générer les règles de plateforme pour les prompts
        function getPlatformRulesForPrompt(platformKey, formatKey) {
            const platform = PLATFORMS[platformKey];
            const format = FORMATS[formatKey];

            if (!platform) return '';

            let rules = `
═══════════════════════════════════════════════════════════════
CONTRAINTES ${platform.name.toUpperCase()} - À RESPECTER IMPÉRATIVEMENT
═══════════════════════════════════════════════════════════════
${platform.rules || ''}
`;

            if (format && format.rules) {
                rules += `
═══════════════════════════════════════════════════════════════
CONTRAINTES FORMAT ${format.name.toUpperCase()}
═══════════════════════════════════════════════════════════════
${format.rules}
`;
            }

            return rules;
        }

        function selectPlatform(platform) {
            document.querySelectorAll('.platform-chip').forEach(c => c.classList.remove('active'));
            const chip = document.querySelector(`.platform-chip[data-platform="${platform}"]`);
            if (chip && !chip.classList.contains('disabled')) {
                chip.classList.add('active');
                currentState.platform = platform;
                // Mettre à jour le reminder contextuel
                if (typeof ContextualReminder !== 'undefined') {
                    ContextualReminder.updateForPlatform(platform);
                }
            }
        }

        // ==================== CASCADE SYSTEM (PLANNING) ====================
        const CascadeSystem = {
            STORAGE_KEY: 'sos_cascade_planning',
            currentWeekStart: null,
            draggedItem: null,

            init() {
                this.currentWeekStart = this.getWeekStart(new Date());
            },

            getWeekStart(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                d.setDate(diff);
                d.setHours(0, 0, 0, 0);
                return d;
            },

            get() {
                return JSON.parse(localStorage.getItem(this.STORAGE_KEY)) || { slots: [] };
            },

            save(data) {
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
            },

            // Navigation semaine
            previousWeek() {
                this.currentWeekStart.setDate(this.currentWeekStart.getDate() - 7);
                this.renderCalendar();
            },

            nextWeek() {
                this.currentWeekStart.setDate(this.currentWeekStart.getDate() + 7);
                this.renderCalendar();
            },

            goToToday() {
                this.currentWeekStart = this.getWeekStart(new Date());
                this.renderCalendar();
            },

            // Ouvrir la modal
            open() {
                this.init();
                document.getElementById('cascadeModal').classList.add('show');
                this.renderCalendar();
                this.renderFavorites();
            },

            // Rendu du calendrier
            renderCalendar() {
                const weekEl = document.getElementById('cascadeWeek');
                const labelEl = document.getElementById('cascadeWeekLabel');
                const data = this.get();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
                const monthNames = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'];

                // Label de la semaine
                const weekEnd = new Date(this.currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                labelEl.textContent = `${this.currentWeekStart.getDate()} ${monthNames[this.currentWeekStart.getMonth()]} - ${weekEnd.getDate()} ${monthNames[weekEnd.getMonth()]} ${weekEnd.getFullYear()}`;

                let html = '';
                for (let i = 0; i < 7; i++) {
                    const date = new Date(this.currentWeekStart);
                    date.setDate(date.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    const isToday = date.getTime() === today.getTime();
                    const isPast = date.getTime() < today.getTime();
                    const isWeekend = i >= 5;

                    // Slots pour ce jour
                    const daySlots = data.slots.filter(s => s.date === dateStr).sort((a, b) => a.time.localeCompare(b.time));

                    html += `
                        <div class="cascade-day ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''} ${isPast ? 'past' : ''}" 
                             data-date="${dateStr}"
                             ${!isPast ? `ondragover="CascadeSystem.handleDragOver(event)"
                             ondragleave="CascadeSystem.handleDragLeave(event)"
                             ondrop="CascadeSystem.handleDrop(event, '${dateStr}')"` : ''}>
                            <div class="cascade-day-header">
                                <div class="cascade-day-name">${days[i]}</div>
                                <div class="cascade-day-number">${date.getDate()}</div>
                            </div>
                            <div class="cascade-day-slots">
                                ${daySlots.map((slot, idx) => this.renderSlot(slot, dateStr, idx, isPast)).join('')}
                                ${!isPast ? `<button class="cascade-add-btn" onclick="CascadeSystem.openSlotModal('${dateStr}')">+ Ajouter</button>` : ''}
                            </div>
                        </div>
                    `;
                }

                weekEl.innerHTML = html;
                this.updateStats();
            },

            renderSlot(slot, date, index, isPast = false) {
                const platformEmojis = { linkedin: '💼', instagram: '📸', twitter: '𝕏', facebook: '👥', tiktok: '🎵' };
                const preview = slot.content.substring(0, 40) + (slot.content.length > 40 ? '...' : '');
                
                return `
                    <div class="cascade-slot ${slot.platform} ${isPast ? 'past-slot' : ''}" ${!isPast ? `onclick="CascadeSystem.editSlot('${date}', ${index})"` : ''}>
                        <span class="cascade-slot-platform">${platformEmojis[slot.platform] || '📱'}</span>
                        <div class="cascade-slot-time">${slot.time}</div>
                        <div class="cascade-slot-preview">${preview}</div>
                        ${isPast ? '<span class="cascade-slot-done">✓</span>' : ''}
                    </div>
                `;
            },

            // Rendu des favoris
            renderFavorites() {
                const container = document.getElementById('cascadeFavorites');
                const favorites = getFavorites();

                if (favorites.length === 0) {
                    container.innerHTML = '<div class="cascade-empty">Aucun favori.<br>Sauvegarde des contenus avec ❤️</div>';
                    return;
                }

                container.innerHTML = favorites.map((fav, idx) => {
                    const preview = fav.content.substring(0, 60) + (fav.content.length > 60 ? '...' : '');
                    const platformEmojis = { linkedin: '💼', instagram: '📸', twitter: '𝕏', facebook: '👥', tiktok: '🎵' };
                    
                    return `
                        <div class="cascade-fav-item" 
                             draggable="true"
                             ondragstart="CascadeSystem.handleDragStart(event, ${idx})"
                             ondragend="CascadeSystem.handleDragEnd(event)">
                            <div class="cascade-fav-platform">${platformEmojis[fav.platform] || '📱'} ${fav.platform?.toUpperCase() || 'CONTENU'}</div>
                            <div class="cascade-fav-preview">${preview}</div>
                        </div>
                    `;
                }).join('');
            },

            // Drag & Drop
            handleDragStart(e, favIndex) {
                this.draggedItem = favIndex;
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            },

            handleDragEnd(e) {
                e.target.classList.remove('dragging');
                document.querySelectorAll('.cascade-day').forEach(d => d.classList.remove('drag-over'));
            },

            handleDragOver(e) {
                e.preventDefault();
                e.currentTarget.classList.add('drag-over');
            },

            handleDragLeave(e) {
                e.currentTarget.classList.remove('drag-over');
            },

            handleDrop(e, dateStr) {
                e.preventDefault();
                e.currentTarget.classList.remove('drag-over');
                
                if (this.draggedItem !== null) {
                    const favorites = getFavorites();
                    const fav = favorites[this.draggedItem];
                    
                    if (fav) {
                        // Ouvrir modal avec le contenu pré-rempli
                        this.openSlotModal(dateStr, fav);
                    }
                    
                    this.draggedItem = null;
                }
            },

            // Modal Slot
            openSlotModal(dateStr, prefillContent = null) {
                document.getElementById('slotDate').value = dateStr;
                document.getElementById('slotEditIndex').value = '';
                document.getElementById('cascadeSlotTitle').textContent = '📝 Planifier un contenu';
                document.getElementById('deleteSlotBtn').style.display = 'none';
                
                // Reset
                document.getElementById('slotTime').value = '09:00';
                document.getElementById('slotPlatform').value = 'linkedin';
                document.getElementById('slotContent').value = '';
                document.getElementById('slotCustomContent').value = '';

                // Remplir le select des favoris
                const favorites = getFavorites();
                const select = document.getElementById('slotContent');
                select.innerHTML = '<option value="">-- Choisir un favori --</option>' + 
                    favorites.map((f, i) => {
                        const preview = f.content.substring(0, 50) + '...';
                        return `<option value="${i}">${f.platform?.toUpperCase() || 'Contenu'}: ${preview}</option>`;
                    }).join('');

                // Pré-remplir si drag & drop
                if (prefillContent) {
                    document.getElementById('slotPlatform').value = prefillContent.platform || 'linkedin';
                    document.getElementById('slotCustomContent').value = prefillContent.content;
                }

                document.getElementById('cascadeSlotModal').classList.add('show');
            },

            editSlot(dateStr, index) {
                const data = this.get();
                const slot = data.slots.find(s => s.date === dateStr);
                const daySlots = data.slots.filter(s => s.date === dateStr).sort((a, b) => a.time.localeCompare(b.time));
                const slotData = daySlots[index];

                if (!slotData) return;

                document.getElementById('slotDate').value = dateStr;
                document.getElementById('slotEditIndex').value = data.slots.indexOf(slotData);
                document.getElementById('cascadeSlotTitle').textContent = '✏️ Modifier le contenu';
                document.getElementById('deleteSlotBtn').style.display = 'block';

                document.getElementById('slotTime').value = slotData.time;
                document.getElementById('slotPlatform').value = slotData.platform;
                document.getElementById('slotContent').value = '';
                document.getElementById('slotCustomContent').value = slotData.content;

                // Remplir le select des favoris
                const favorites = getFavorites();
                const select = document.getElementById('slotContent');
                select.innerHTML = '<option value="">-- Choisir un favori --</option>' + 
                    favorites.map((f, i) => `<option value="${i}">${f.platform?.toUpperCase() || 'Contenu'}: ${f.content.substring(0, 50)}...</option>`).join('');

                document.getElementById('cascadeSlotModal').classList.add('show');
            },

            saveSlot() {
                const dateStr = document.getElementById('slotDate').value;
                const editIndex = document.getElementById('slotEditIndex').value;
                const time = document.getElementById('slotTime').value;
                const platform = document.getElementById('slotPlatform').value;
                const favIndex = document.getElementById('slotContent').value;
                let content = document.getElementById('slotCustomContent').value.trim();

                // Si un favori est sélectionné et pas de contenu custom
                if (favIndex !== '' && !content) {
                    const favorites = getFavorites();
                    content = favorites[parseInt(favIndex)]?.content || '';
                }

                if (!content) {
                    showToast('❌ ' + t('toasts.add_content'));
                    return;
                }

                const data = this.get();
                const slot = { date: dateStr, time, platform, content, createdAt: new Date().toISOString() };

                if (editIndex !== '') {
                    // Modification
                    data.slots[parseInt(editIndex)] = slot;
                } else {
                    // Création
                    data.slots.push(slot);
                }

                this.save(data);
                closeCascadeSlot();
                this.renderCalendar();
                showToast('✅ ' + t('toasts.content_planned'));
                SoundSystem.playSuccess();
            },

            deleteSlot() {
                const editIndex = document.getElementById('slotEditIndex').value;
                if (editIndex === '') return;

                if (!confirm('Supprimer ce contenu planifié ?')) return;

                const data = this.get();
                data.slots.splice(parseInt(editIndex), 1);
                this.save(data);
                
                closeCascadeSlot();
                this.renderCalendar();
                showToast('🗑️ ' + t('toasts.deleted'));
            },

            updateStats() {
                const data = this.get();
                const weekStart = this.currentWeekStart;
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);

                const weekSlots = data.slots.filter(s => {
                    const d = new Date(s.date);
                    return d >= weekStart && d <= weekEnd;
                });

                // Tu pourrais afficher ces stats quelque part
                console.log(`📅 ${weekSlots.length} contenus planifiés cette semaine`);
            },

            // Export CSV
            exportCSV(format) {
                const data = this.get();
                
                if (data.slots.length === 0) {
                    showToast('❌ ' + t('toasts.no_content_to_export'));
                    return;
                }

                // Trier par date et heure
                const sorted = [...data.slots].sort((a, b) => {
                    if (a.date !== b.date) return a.date.localeCompare(b.date);
                    return a.time.localeCompare(b.time);
                });

                let csv = '';
                let filename = '';

                switch (format) {
                    case 'metricool':
                        // Format Metricool officiel
                        const headers = ['Text','Date','Time','Draft','Facebook','Twitter/X','LinkedIn','GBP','Instagram','Pinterest','TikTok','Youtube','Threads','Bluesky','Picture Url 1','Picture Url 2','Picture Url 3','Picture Url 4','Picture Url 5','Picture Url 6','Picture Url 7','Picture Url 8','Picture Url 9','Picture Url 10','Alt text picture 1','Alt text picture 2','Alt text picture 3','Alt text picture 4','Alt text picture 5','Alt text picture 6','Alt text picture 7','Alt text picture 8','Alt text picture 9','Alt text picture 10','Document title','Shortener','Video Thumbnail Url','Video Cover Frame','Twitter/X Can reply','Twitter/X Type','Twitter/X Poll Duration minutes','Twitter/X Poll Option 1','Twitter/X Poll Option 2','Twitter/X Poll Option 3','Twitter/X Poll Option 4','Pinterest Board','Pinterest Pin Title','Pinterest Pin Link','Pinterest Pin New Format','Instagram Post Type','Instagram Show Reel On Feed','Youtube Video Title','Youtube Video Type','Youtube Video Privacy','Youtube video for kids','Youtube Video Category','Youtube Video Tags','Youtube playlist','GBP Post Type','Facebook Post Type','Facebook Title','First Comment Text','TikTok Title','TikTok disable comments','TikTok disable duet','TikTok disable stitch','TikTok Post Privacy','TikTok Branded Content','TikTok Your Brand','TikTok Auto Add Music','TikTok Photo Cover Index','TikTok musicId','TikTok title','TikTok author','TikTok startMillis','TikTok durationMillis','TikTok startVideoMillis','LinkedIn Type','LinkedIn Poll Question','LinkedIn Poll Option 1','LinkedIn Poll Option 2','LinkedIn Poll Option 3','LinkedIn Poll Option 4','LinkedIn Poll Duration','LinkedIn Show link preview','LinkedIn Images as Carousel','Threads Reply Control','Brand name'];
                        
                        csv = headers.join(',') + '\n';
                        
                        sorted.forEach(slot => {
                            // Tronquer à 2200 caractères max (limite Metricool)
                            let content = slot.content.replace(/"/g, '""').replace(/\n/g, ' ');
                            if (content.length > 2200) {
                                content = content.substring(0, 2197) + '...';
                            }
                            
                            // Format date : YYYY/MM/DD (pas YYYY-MM-DD)
                            const dateFormatted = slot.date.replace(/-/g, '/');
                            const time = slot.time + ':00';
                            
                            // Créer un tableau avec toutes les valeurs
                            const row = new Array(headers.length).fill('');
                            
                            // Remplir les colonnes essentielles
                            row[0] = `"${content}"`; // Text
                            row[1] = dateFormatted; // Date
                            row[2] = time; // Time
                            row[3] = 'false'; // Draft
                            
                            // Plateformes (colonnes 4-13)
                            row[4] = slot.platform === 'facebook' ? 'true' : 'false'; // Facebook
                            row[5] = slot.platform === 'twitter' ? 'true' : 'false'; // Twitter/X
                            row[6] = slot.platform === 'linkedin' ? 'true' : 'false'; // LinkedIn
                            row[7] = 'false'; // GBP
                            row[8] = slot.platform === 'instagram' ? 'true' : 'false'; // Instagram
                            row[9] = 'false'; // Pinterest
                            row[10] = slot.platform === 'tiktok' ? 'true' : 'false'; // TikTok
                            row[11] = 'false'; // Youtube
                            row[12] = 'false'; // Threads
                            row[13] = 'false'; // Bluesky
                            
                            // Shortener
                            row[35] = 'true';
                            
                            // Twitter type
                            row[39] = 'POST';
                            
                            // Instagram Post Type
                            row[49] = 'POST';
                            row[50] = 'false';
                            
                            // LinkedIn Type
                            row[78] = 'POST';
                            row[85] = 'true'; // Show link preview
                            row[86] = 'false'; // Images as Carousel
                            
                            csv += row.join(',') + '\n';
                        });
                        filename = 'cascade-metricool.csv';
                        break;

                    case 'swello':
                        // Format Swello : content,date,time,network
                        csv = 'content;scheduled_date;scheduled_time;network\n';
                        sorted.forEach(slot => {
                            const content = slot.content.replace(/"/g, '""').replace(/\n/g, ' ');
                            const network = this.mapPlatformToSwello(slot.platform);
                            csv += `"${content}";${slot.date};${slot.time};${network}\n`;
                        });
                        filename = 'cascade-swello.csv';
                        break;

                    default:
                        // Format générique
                        csv = 'Date,Heure,Plateforme,Contenu\n';
                        sorted.forEach(slot => {
                            const content = slot.content.replace(/"/g, '""').replace(/\n/g, ' ');
                            csv += `${slot.date},${slot.time},${slot.platform},"${content}"\n`;
                        });
                        filename = 'cascade-planning.csv';
                }

                // Télécharger
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);

                if (format === 'metricool') {
                    // Message spécifique Metricool
                    showToast('✅ ' + t('toasts.content_exported').replace('{count}', sorted.length));
                    setTimeout(() => {
                        alert('📸 RAPPEL IMPORTANT !\n\nDans Metricool, tu devras ajouter manuellement une image ou vidéo à chaque publication.\n\nLes contenus de plus de 2200 caractères ont été tronqués.');
                    }, 500);
                } else {
                    showToast('✅ ' + t('toasts.content_exported').replace('{count}', sorted.length));
                }
                SoundSystem.playSuccess();
            },

            mapPlatformToMetricool(platform) {
                const map = { linkedin: 'LinkedIn', instagram: 'Instagram', twitter: 'Twitter', facebook: 'Facebook', tiktok: 'TikTok' };
                return map[platform] || platform;
            },

            mapPlatformToSwello(platform) {
                const map = { linkedin: 'linkedin', instagram: 'instagram', twitter: 'twitter', facebook: 'facebook', tiktok: 'tiktok' };
                return map[platform] || platform;
            }
        };

        function showCascade() {
            CascadeSystem.open();
        }

        function closeCascade() {
            document.getElementById('cascadeModal').classList.remove('show');
        }

        function closeCascadeSlot() {
            document.getElementById('cascadeSlotModal').classList.remove('show');
        }

        // ==================== MES POSTS POPUP ====================
        let mesPostsWindow = null;
        
        function openMesPostsPopup() {
            // Vérifier si la fenêtre est déjà ouverte
            if (mesPostsWindow && !mesPostsWindow.closed) {
                mesPostsWindow.focus();
                return;
            }
            
            // Ouvrir une nouvelle fenêtre popup
            const width = 420;
            const height = 700;
            const left = window.screen.width - width - 50;
            const top = 50;
            
            mesPostsWindow = window.open(
                'mes-posts-popup.html',
                'MesPostsSOS',
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
            );
            
            if (mesPostsWindow) {
                mesPostsWindow.focus();
            } else {
                // Si popup bloquée, ouvrir dans un nouvel onglet
                window.open('mes-posts-popup.html', '_blank');
            }
        }

        // Fonction pour sauvegarder un post directement depuis l'app principale
        function saveToMesPosts(caption, hashtags, visualTexts, platform) {
            const STORAGE_KEY = 'sos_mes_posts';
            const posts = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            
            posts.unshift({
                platform: platform || currentState.platform || 'instagram',
                caption: caption || '',
                hashtags: hashtags || '',
                visualTexts: visualTexts || '',
                done: false,
                createdAt: new Date().toISOString()
            });
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(posts));
            showToast('📌 ' + t('toasts.saved_to_posts'));
            
            // Si la fenêtre popup est ouverte, elle se mettra à jour automatiquement
        }

        // Sauvegarde rapide du contenu actuel
        function quickSaveToMesPosts() {
            if (!currentState.generatedContent) {
                showToast('❌ ' + t('toasts.generate_first'));
                return;
            }
            
            // Essayer d'extraire caption et hashtags du contenu généré
            let content = currentState.generatedContent;
            let caption = '';
            let hashtags = '';
            let visualTexts = '';
            
            // Chercher les hashtags
            const hashtagMatch = content.match(/(#\w+[\s]*)+/g);
            if (hashtagMatch) {
                hashtags = hashtagMatch.join(' ').trim();
                // Retirer les hashtags du contenu pour avoir la caption propre
                content = content.replace(/(#\w+[\s]*)+/g, '').trim();
            }
            
            // Chercher les textes de slides/visuels (patterns courants)
            const slidePatterns = [
                /(?:Slide|Diapo|Visuel|Écran)\s*\d+\s*[:：]\s*[^\n]+/gi,
                /(?:Titre|Hook|Accroche)\s*[:：]\s*[^\n]+/gi
            ];
            
            let foundSlides = [];
            slidePatterns.forEach(pattern => {
                const matches = content.match(pattern);
                if (matches) {
                    foundSlides = foundSlides.concat(matches);
                }
            });
            
            if (foundSlides.length > 0) {
                visualTexts = foundSlides.join('\n');
            }
            
            // Le reste est la caption
            caption = content;
            
            // Si c'est trop long, on prend juste les premiers paragraphes
            if (caption.length > 2200) {
                // Couper au dernier espace avant 2200 caractères
                caption = caption.substring(0, 2197);
                const lastSpace = caption.lastIndexOf(' ');
                if (lastSpace > 1800) {
                    caption = caption.substring(0, lastSpace) + '...';
                }
            }
            
            saveToMesPosts(caption, hashtags, visualTexts, currentState.platform);
            SoundSystem.playSuccess();
        }

        // ==================== SYSTÈME DE SON ====================
        const SoundSystem = {
            audioContext: null,
            
            init() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
            },
            
            playClick() {
                this.init();
                const ctx = this.audioContext;
                
                // Créer un son de clic synthétique
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.frequency.setValueAtTime(800, ctx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(400, ctx.currentTime + 0.05);
                
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.1);
            },
            
            playSuccess() {
                this.init();
                const ctx = this.audioContext;
                
                // Son de succès (deux notes montantes)
                const osc1 = ctx.createOscillator();
                const osc2 = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc1.connect(gain);
                osc2.connect(gain);
                gain.connect(ctx.destination);
                
                osc1.frequency.setValueAtTime(523, ctx.currentTime); // Do
                osc2.frequency.setValueAtTime(659, ctx.currentTime + 0.1); // Mi
                
                gain.gain.setValueAtTime(0.2, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                
                osc1.start(ctx.currentTime);
                osc1.stop(ctx.currentTime + 0.15);
                osc2.start(ctx.currentTime + 0.1);
                osc2.stop(ctx.currentTime + 0.3);
            }
        };

        // ==================== SYSTÈME FREEMIUM (SUPABASE) ====================
        const FreemiumSystem = {
            LIMITS: {
                posts: 4,
                auditProfile: 1,
                auditPosts: 1,
                auditVideo: 1,
                newsletters: 2
            },

            // Cache local des compteurs (synchronisé avec Supabase)
            _cache: {
                posts: 0,
                auditProfile: 0,
                auditPosts: 0,
                auditVideo: 0,
                newsletters: 0,
                loaded: false,
                subscriptionStatus: 'free'
            },

            // Clés localStorage pour le cache
            CACHE_KEY: 'tithot_freemium_cache',
            CACHE_DURATION: 5 * 60 * 1000, // 5 minutes

            // Vérifier si l'utilisateur a un abonnement actif
            isSubscribed() {
                return this._cache.subscriptionStatus === 'active';
            },

            // Charger les compteurs depuis Supabase
            async loadFromSupabase() {
                try {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (!session) {
                        console.log('[FreemiumSystem] Pas de session, mode non-connecté');
                        this._cache.loaded = true;
                        return;
                    }

                    const userEmail = session.user.email.toLowerCase();
                    const { data, error } = await supabaseClient
                        .from('users')
                        .select('free_posts_used, free_audit_profile_used, free_audit_posts_used, free_audit_video_used, free_newsletters_used, subscription_status')
                        .eq('email', userEmail)
                        .single();

                    if (error) {
                        console.warn('[FreemiumSystem] Erreur chargement:', error.message);
                        return;
                    }

                    if (data) {
                        this._cache.posts = data.free_posts_used || 0;
                        this._cache.auditProfile = data.free_audit_profile_used || 0;
                        this._cache.auditPosts = data.free_audit_posts_used || 0;
                        this._cache.auditVideo = data.free_audit_video_used || 0;
                        this._cache.newsletters = data.free_newsletters_used || 0;
                        this._cache.subscriptionStatus = data.subscription_status || 'free';
                        this._cache.loaded = true;

                        // Sauvegarder en cache local
                        this._saveLocalCache();
                        console.log('[FreemiumSystem] Compteurs chargés depuis Supabase:', this._cache);
                    }
                } catch (e) {
                    console.error('[FreemiumSystem] Erreur:', e);
                    // Charger depuis le cache local en fallback
                    this._loadLocalCache();
                }
            },

            // Sauvegarder le cache localement
            _saveLocalCache() {
                localStorage.setItem(this.CACHE_KEY, JSON.stringify({
                    ...this._cache,
                    timestamp: Date.now()
                }));
            },

            // Charger depuis le cache local
            _loadLocalCache() {
                try {
                    const cached = localStorage.getItem(this.CACHE_KEY);
                    if (cached) {
                        const data = JSON.parse(cached);
                        // Vérifier si le cache n'est pas trop vieux (1 heure max)
                        if (data.timestamp && (Date.now() - data.timestamp) < 60 * 60 * 1000) {
                            this._cache = { ...this._cache, ...data };
                            this._cache.loaded = true;
                        }
                    }
                } catch (e) {
                    console.warn('[FreemiumSystem] Erreur lecture cache local');
                }
            },

            // Incrémenter un compteur dans Supabase
            async _incrementInSupabase(field) {
                try {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (!session) return;

                    const userEmail = session.user.email.toLowerCase();

                    // Utiliser une requête RPC ou update direct
                    const { error } = await supabaseClient.rpc('increment_freemium_counter', {
                        p_email: userEmail,
                        p_field: field
                    });

                    // Si la fonction RPC n'existe pas, faire un update classique
                    if (error && error.message.includes('function')) {
                        const { data: current } = await supabaseClient
                            .from('users')
                            .select(field)
                            .eq('email', userEmail)
                            .single();

                        if (current) {
                            await supabaseClient
                                .from('users')
                                .update({ [field]: (current[field] || 0) + 1 })
                                .eq('email', userEmail);
                        }
                    }
                } catch (e) {
                    console.error('[FreemiumSystem] Erreur incrémentation:', e);
                }
            },

            // Initialiser le système au chargement
            async init() {
                console.log('[FreemiumSystem] Initialisation...');
                // D'abord charger le cache local pour un affichage rapide
                this._loadLocalCache();
                // Puis synchroniser avec Supabase
                await this.loadFromSupabase();
                console.log('[FreemiumSystem] Statut:', this._cache.subscriptionStatus, '| Posts:', this._cache.posts + '/' + this.LIMITS.posts);
                return this._cache.subscriptionStatus;
            },

            // Obtenir les compteurs
            getPostsCount() { return this._cache.posts; },
            getAuditProfileCount() { return this._cache.auditProfile; },
            getAuditPostsCount() { return this._cache.auditPosts; },
            getAuditVideoCount() { return this._cache.auditVideo; },
            getNewslettersCount() { return this._cache.newsletters; },

            // Incrémenter les compteurs
            async incrementPosts() {
                this._cache.posts++;
                this._saveLocalCache();
                await this._incrementInSupabase('free_posts_used');
                return this._cache.posts;
            },
            async incrementAuditProfile() {
                this._cache.auditProfile++;
                this._saveLocalCache();
                await this._incrementInSupabase('free_audit_profile_used');
                return this._cache.auditProfile;
            },
            async incrementAuditPosts() {
                this._cache.auditPosts++;
                this._saveLocalCache();
                await this._incrementInSupabase('free_audit_posts_used');
                return this._cache.auditPosts;
            },
            async incrementAuditVideo() {
                this._cache.auditVideo++;
                this._saveLocalCache();
                await this._incrementInSupabase('free_audit_video_used');
                return this._cache.auditVideo;
            },
            async incrementNewsletters() {
                this._cache.newsletters++;
                this._saveLocalCache();
                await this._incrementInSupabase('free_newsletters_used');
                return this._cache.newsletters;
            },

            // Vérifier les limites
            canGeneratePost() {
                if (this.isSubscribed()) return true;
                return this._cache.posts < this.LIMITS.posts;
            },
            canDoAuditProfile() {
                if (this.isSubscribed()) return true;
                return this._cache.auditProfile < this.LIMITS.auditProfile;
            },
            canDoAuditPosts() {
                if (this.isSubscribed()) return true;
                return this._cache.auditPosts < this.LIMITS.auditPosts;
            },
            canDoAuditVideo() {
                if (this.isSubscribed()) return true;
                return this._cache.auditVideo < this.LIMITS.auditVideo;
            },
            canGenerateNewsletter() {
                if (this.isSubscribed()) return true;
                return this._cache.newsletters < this.LIMITS.newsletters;
            },

            // Obtenir les stats d'utilisation
            getUsageStats() {
                return {
                    posts: { used: this._cache.posts, limit: this.LIMITS.posts },
                    auditProfile: { used: this._cache.auditProfile, limit: this.LIMITS.auditProfile },
                    auditPosts: { used: this._cache.auditPosts, limit: this.LIMITS.auditPosts },
                    auditVideo: { used: this._cache.auditVideo, limit: this.LIMITS.auditVideo },
                    newsletters: { used: this._cache.newsletters, limit: this.LIMITS.newsletters },
                    isSubscribed: this.isSubscribed()
                };
            },

            // Afficher le paywall
            showPaywall(type = 'posts') {
                const stats = this.getUsageStats();
                const modal = document.getElementById('paywallModal');
                if (!modal) return;

                const titleEl = modal.querySelector('.paywall-title');
                const subtitleEl = modal.querySelector('.paywall-subtitle');
                const usageEl = modal.querySelector('.paywall-usage');

                const titles = {
                    posts: { title: '🎉 Tu as utilisé tes 4 posts gratuits !', subtitle: 'Passe à la version complète pour générer du contenu illimité' },
                    auditProfile: { title: '👤 Tu as utilisé ton audit profil gratuit !', subtitle: 'Passe à la version complète pour auditer tous tes profils' },
                    auditPosts: { title: '📝 Tu as utilisé ton audit posts gratuit !', subtitle: 'Passe à la version complète pour analyser tous tes posts' },
                    auditVideo: { title: '🎬 Tu as utilisé ton audit vidéo gratuit !', subtitle: 'Passe à la version complète pour auditer toutes tes vidéos' },
                    newsletters: { title: '📧 Tu as utilisé tes 2 newsletters gratuites !', subtitle: 'Passe à la version complète pour créer des newsletters illimitées' }
                };

                const t = titles[type] || titles.posts;
                titleEl.textContent = t.title;
                subtitleEl.textContent = t.subtitle;

                usageEl.innerHTML = `
                    <div class="usage-item">
                        <span>📝 Posts générés</span>
                        <span class="usage-count">${stats.posts.used}/${stats.posts.limit}</span>
                    </div>
                    <div class="usage-item">
                        <span>📧 Newsletters</span>
                        <span class="usage-count">${stats.newsletters.used}/${stats.newsletters.limit}</span>
                    </div>
                    <div class="usage-item">
                        <span>👤 Audit profil</span>
                        <span class="usage-count">${stats.auditProfile.used}/${stats.auditProfile.limit}</span>
                    </div>
                    <div class="usage-item">
                        <span>📋 Audit posts</span>
                        <span class="usage-count">${stats.auditPosts.used}/${stats.auditPosts.limit}</span>
                    </div>
                    <div class="usage-item">
                        <span>🎬 Audit vidéo</span>
                        <span class="usage-count">${stats.auditVideo.used}/${stats.auditVideo.limit}</span>
                    </div>
                `;

                modal.style.display = 'flex';
            },

            // Fermer le paywall
            closePaywall() {
                const modal = document.getElementById('paywallModal');
                if (modal) modal.style.display = 'none';
            }
        };

        // Exposer globalement pour l'audit module
        window.FreemiumSystem = FreemiumSystem;

        // Fonction pour afficher l'effet "Envoyé !" sur un bouton
        function showSentEffect(btn, originalText) {
            SoundSystem.playSuccess();
            btn.classList.add('sent');
            setTimeout(() => {
                btn.classList.remove('sent');
            }, 1500);
        }

        // ==================== POP-UP DE BIENVENUE ====================
        function showWelcomePopup() {
            // Ne pas afficher si l'utilisateur a coché "ne plus montrer"
            if (localStorage.getItem('sos_welcome_hidden') === 'true') return;

            const popup = document.getElementById('welcomePopup');
            if (popup) {
                popup.style.display = 'flex';
            }
        }

        function closeWelcomePopup() {
            const popup = document.getElementById('welcomePopup');
            if (popup) {
                popup.style.display = 'none';
            }
        }

        function saveWelcomePreference() {
            const checkbox = document.getElementById('welcomeDontShow');
            if (checkbox && checkbox.checked) {
                localStorage.setItem('sos_welcome_hidden', 'true');
            } else {
                localStorage.removeItem('sos_welcome_hidden');
            }
        }

        // ==================== INITIALISATION ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialiser le white label si disponible
            if (typeof window.OrganizationLoader !== 'undefined') {
                const org = await window.OrganizationLoader.init();
                if (org) {
                    console.log('[App] White label actif:', org.app_name);
                    // Mettre à jour le titre de la page
                    if (org.app_name) {
                        document.title = org.app_name;
                        const headerTitle = document.querySelector('.header-title');
                        if (headerTitle) headerTitle.textContent = org.app_name;
                    }
                    // Mettre à jour le logo
                    if (org.logo_url) {
                        const headerLogo = document.querySelector('.header-logo');
                        if (headerLogo) headerLogo.innerHTML = `<img src="${org.logo_url}" alt="${org.app_name}" style="height: 40px;">`;
                    }
                }
            }

            // Initialiser le système freemium (vérification abonnement)
            FreemiumSystem.init();

            // Vérifier si l'utilisateur est admin/coach pour afficher le bouton Dashboard
            try {
                const { data: { user } } = await window.supabase.auth.getUser();
                if (user) {
                    const { data: orgUser } = await window.supabase
                        .from('org_users')
                        .select('role')
                        .eq('user_id', user.id)
                        .single();

                    if (orgUser && (orgUser.role === 'admin' || orgUser.role === 'coach')) {
                        const dashboardBtn = document.getElementById('dashboardBtn');
                        if (dashboardBtn) dashboardBtn.style.display = 'inline-flex';
                    }
                }
            } catch (e) {
                console.log('[App] Pas de vérification de rôle:', e.message);
            }

            initSelectors();

            // Synchroniser le profil depuis le cloud (restaure si effacé localement)
            ProfileSync.sync().then(() => {
                updateProfileButton();
            }).catch(() => {
                updateProfileButton();
            });

            updatePillarSuggestion();
            updateMemoryIndicator();
            AgencySystem.updateUI();
            FrameworkSystem.updateQuickSelector();
            initAnecdoteListeners(); // Listeners pour le champ anecdote
            ProgressionSystem.updateMiniStats(); // Mise à jour des mini-stats
            LastContentManager.updateButton(); // Afficher le bouton Reprendre si contenu existant

            // Initialiser le sélecteur d'audience
            setTimeout(() => {
                if (typeof initAudienceSelector === 'function') {
                    initAudienceSelector();
                }
            }, 500);

            // Initialiser le reminder contextuel
            setTimeout(() => {
                if (typeof ContextualReminder !== 'undefined') {
                    ContextualReminder.init();
                }
            }, 2000);

            // Initialiser le toggle de langue FR/EN
            const langContainer = document.getElementById('languageToggleContainer');
            if (langContainer && window.I18N) {
                langContainer.appendChild(I18N.createLanguageToggle());
                // Appliquer les traductions selon la langue sauvegardée
                I18N.init().then(() => {
                    I18N.updateAllTranslations();
                });
            }

            // Popup de bienvenue pour guider vers la démo
            checkFirstVisit();

            // Mettre à jour le compteur d'idées sauvegardées
            setTimeout(() => {
                if (typeof updateSavedCount === 'function') updateSavedCount();
            }, 100);

            const profile = UserProfile.get();
            if (profile?.plateformes?.length > 0) {
                selectPlatform(profile.plateformes[0]);
            }
            // Badge démo guidée maintenant géré dans showQuickPost()
            
            // DESACTIVE: Auto-affichage modal inscription
            // setTimeout(() => {
            //     if (!Analytics.isRegistered() && !localStorage.getItem('sos_skip_register')) {
            //         document.getElementById('registerModal').classList.add('show');
            //     }
            // }, 3000);
            
            // Écouter les changements de profil (pour sync avec onboarding)
            window.addEventListener('storage', function(e) {
                if (e.key === 'tithot_user_profile') {
                    refreshConfigFromProfile();
                }
            });
            
            // Observer les changements de modal onboarding (fallback)
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.target.id === 'onboardingModal' && !mutation.target.classList.contains('show')) {
                        // L'onboarding vient de se fermer
                        setTimeout(refreshConfigFromProfile, 100);
                    }
                });
            });
            const onboardingModal = document.getElementById('onboardingModal');
            if (onboardingModal) {
                observer.observe(onboardingModal, { attributes: true, attributeFilter: ['class'] });
            }

            // Gestionnaire global : fermer les modaux en cliquant à l'extérieur
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('show');
                        this.classList.remove('active');
                    }
                });
            });
        });

        // ==================== INSCRIPTION & CODES PROMO ====================
        async function completeRegistration() {
            const email = document.getElementById('registerEmail').value.trim();
            const name = document.getElementById('registerName').value.trim();
            
            if (!email || !email.includes('@')) {
                showToast('📧 ' + t('toasts.valid_email_required'));
                return;
            }
            
            const userId = await Analytics.registerUser(email, name || null);
            
            if (userId) {
                document.getElementById('registerModal').classList.remove('show');
                showToast('🎉 ' + t('toasts.welcome_user').replace('{name}', name || ''));
                Analytics.trackEvent('registration', { source: 'modal' });
            } else {
                showToast('❌ ' + t('toasts.error_retry'));
            }
        }

        function skipRegistration() {
            localStorage.setItem('sos_skip_register', 'true');
            document.getElementById('registerModal').classList.remove('show');
        }

        function showPromoModal() {
            if (!Analytics.isRegistered()) {
                showToast('📧 ' + t('toasts.register_first'));
                document.getElementById('registerModal').classList.add('show');
                return;
            }
            document.getElementById('promoCodeModal').classList.add('show');
            document.getElementById('promoCodeInput').value = '';
            document.getElementById('promoCodeResult').innerHTML = '';
        }

        function closePromoModal() {
            document.getElementById('promoCodeModal').classList.remove('show');
        }

        async function validatePromoCode() {
            const code = document.getElementById('promoCodeInput').value.trim();
            if (!code) {
                showToast(t('toasts.enter_code'));
                return;
            }
            
            const result = await Analytics.usePromoCode(code);
            const resultDiv = document.getElementById('promoCodeResult');
            
            if (result.success) {
                resultDiv.innerHTML = '<span style="color: #10b981; font-weight: 700;">✅ ' + result.message + ' - Plan: ' + result.plan_type + '</span>';
                showToast('🎉 ' + t('toasts.code_activated').replace('{plan}', result.plan_type));
                setTimeout(closePromoModal, 2000);
            } else {
                resultDiv.innerHTML = '<span style="color: #ff6b6b;">❌ ' + result.message + '</span>';
            }
        }

        // Toggle pour la section des structures narratives
        function toggleStructureSection() {
            const grid = document.getElementById('structureGrid');
            const arrow = document.getElementById('structureToggleArrow');
            grid.classList.toggle('collapsed');
            arrow.classList.toggle('open');
        }

        // Mettre à jour le badge de structure sélectionnée
        function updateStructureBadge(card) {
            const icon = card.querySelector('.structure-icon').textContent;
            const name = card.querySelector('.structure-name').textContent;
            const badge = document.getElementById('selectedStructureBadge');
            badge.innerHTML = icon + ' ' + name;
        }

        function initSelectors() {
            document.querySelectorAll('.structure-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.structure-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    currentState.structure = card.dataset.structure;
                    // Mettre à jour le badge et fermer le toggle
                    updateStructureBadge(card);
                    toggleStructureSection();
                });
            });
            document.querySelectorAll('.format-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.format-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentState.format = chip.dataset.format;

                    // Afficher/masquer les options PUB
                    const pubOptions = document.getElementById('pubOptionsSection');
                    if (chip.dataset.format === 'pub') {
                        pubOptions.style.display = 'block';
                    } else {
                        pubOptions.style.display = 'none';
                    }

                    // Mettre à jour l'affichage du toggle
                    updateFormatValue();
                });
            });
            
            // Gestion des plateformes PUB
            document.querySelectorAll('.pub-platform-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.pub-platform-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentState.pubPlatform = chip.dataset.pubplatform;
                });
            });
            
            // Gestion des objectifs PUB
            document.querySelectorAll('.pub-objective-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.pub-objective-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentState.pubObjective = chip.dataset.objective;
                });
            });
            document.querySelectorAll('.platform-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    // Ignorer les chips disabled (ex: Scrollab)
                    if (chip.classList.contains('disabled')) return;

                    document.querySelectorAll('.platform-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentState.platform = chip.dataset.platform;

                    // Mettre à jour l'affichage du toggle
                    updatePlatformValue();
                });
            });

            // Gestion des tone chips
            document.querySelectorAll('.tone-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.tone-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentState.tone = chip.dataset.tone;
                    updateToneValue();
                });
            });
        }

        function selectPlatform(platform) {
            const map = { 'LinkedIn': 'linkedin', 'Instagram': 'instagram', 'TikTok': 'tiktok', 'X': 'twitter', 'Facebook': 'facebook' };
            const p = map[platform] || platform.toLowerCase();
            const chip = document.querySelector(`.platform-chip[data-platform="${p}"]`);
            if (chip) {
                document.querySelectorAll('.platform-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                currentState.platform = p;
            }
        }

        // ==================== TOGGLES ====================

        // Fonction générique pour gérer tous les toggles
        function toggleSection(sectionName) {
            const toggle = document.getElementById(sectionName + 'Toggle');
            const content = document.getElementById(sectionName + 'Content');
            const arrow = document.getElementById(sectionName + 'Arrow');

            if (!toggle || !content) return;

            const isOpen = content.style.display !== 'none';

            if (isOpen) {
                content.style.display = 'none';
                toggle.classList.remove('open');
            } else {
                content.style.display = 'block';
                toggle.classList.add('open');
            }
        }

        // Mise à jour de l'affichage du toggle Format
        function updateFormatValue() {
            const formatIcons = {
                'post': '📝 Post',
                'carousel': '🎠 Carousel',
                'reel': '🎬 Reel',
                'story': '⏱️ Story',
                'thread': '🧵 Thread',
                'article': '📰 Article',
                'pub': '📢 PUB'
            };
            const valueEl = document.getElementById('formatValue');
            if (valueEl) {
                valueEl.textContent = formatIcons[currentState.format] || currentState.format;
            }
        }

        // Mise à jour de l'affichage du toggle Plateforme
        function updatePlatformValue() {
            const platformIcons = {
                'linkedin': '💼 LinkedIn',
                'instagram': '📸 Instagram',
                'scrollab': '📜 Scrollab',
                'tiktok': '🎵 TikTok',
                'twitter': '𝕏 Twitter',
                'facebook': '👥 Facebook'
            };
            const valueEl = document.getElementById('platformValue');
            if (valueEl) {
                valueEl.textContent = platformIcons[currentState.platform] || currentState.platform;
            }
        }

        // Mise à jour de l'affichage du toggle Ton
        function updateToneValue() {
            const toneLabels = {
                'default': '🎯 Defaut (profil)',
                'inspirant': '✨ Inspirant',
                'educatif': '📚 Educatif',
                'authentique': '💎 Authentique',
                'humour': '😄 Humour',
                'provocateur': '🔥 Provocateur',
                'minimaliste': '✂️ Minimaliste',
                'storytelling': '📖 Storytelling',
                'emotionnel': '💜 Emotionnel'
            };
            const valueEl = document.getElementById('toneValue');
            if (valueEl) {
                valueEl.textContent = toneLabels[currentState.tone] || currentState.tone;
            }
        }

        // ==================== MODE CRÉATION (3 MODES) ====================
        let currentCreationMode = 'libre';

        function selectCreationMode(mode) {
            currentCreationMode = mode;

            // Mettre à jour l'UI des cartes
            document.querySelectorAll('.creation-mode-card').forEach(card => {
                card.classList.remove('active');
            });
            const selectedCard = document.querySelector(`.creation-mode-card[data-mode="${mode}"]`);
            if (selectedCard) {
                selectedCard.classList.add('active');
            }

            const daySelector = document.getElementById('strategyDaySelector');
            const ideaSection = document.getElementById('ideaSection');
            const ideaInput = document.getElementById('ideaInput');

            if (mode === 'strategie') {
                // Mode 20 Jours Stratégiques
                daySelector.style.display = 'block';
                currentState.strategyMode = true;

                // CACHER le champ "Idée/sujet" - les questions + anecdote suffisent
                if (ideaSection) {
                    ideaSection.style.display = 'none';
                }

                // Mettre à jour les options du sélecteur selon l'objectif du profil
                const profile = UserProfile.get();
                const objective = profile?.strategyObjective || 'vendre';
                currentState.strategyType = objective;
                updateStrategyDaysForObjective(objective);

                loadStrategyDay();
            } else if (mode === 'trends') {
                // Mode Trends - ouvrir le modal
                daySelector.style.display = 'none';
                currentState.strategyMode = false;
                currentState.strategyDay = null;
                document.getElementById('extractionQuestions').innerHTML = '';

                // AFFICHER le champ "Idée/sujet"
                if (ideaSection) {
                    ideaSection.style.display = 'block';
                }
                if (ideaInput) {
                    ideaInput.placeholder = "Décris ton idée ou colle ici un texte que tu veux améliorer...";
                }
                // Ouvrir le modal Trends
                showTrends();
            } else {
                // Mode Libre
                daySelector.style.display = 'none';
                currentState.strategyMode = false;
                currentState.strategyDay = null;
                document.getElementById('extractionQuestions').innerHTML = '';

                // AFFICHER le champ "Idée/sujet"
                if (ideaSection) {
                    ideaSection.style.display = 'block';
                }

                // Transférer le contenu du template éditable vers ideaInput si présent
                const templateContent = getEditableTemplateContent();
                if (templateContent && ideaInput) {
                    ideaInput.value = templateContent;
                }

                if (ideaInput) {
                    ideaInput.placeholder = "Décris ton idée ou colle ici un texte que tu veux améliorer...";
                }
            }
        }

        // Alias pour compatibilité
        function toggleCreationMode(mode) {
            selectCreationMode(mode);
        }

        // Charger le template du jour sélectionné
        function loadStrategyDay() {
            const day = document.getElementById('strategyDay').value;
            const profile = UserProfile.get();
            const objective = profile?.strategyObjective || 'vendre';
            const daysData = objective === 'expertise' ? STRATEGY_DAYS_EXPERTISE : STRATEGY_DAYS_VENDRE;
            const data = daysData[day];
            const container = document.getElementById('extractionQuestions');

            // Debug log
            console.log('📅 20 Jours - Mode:', objective, '| Jour:', day, '| Has template:', !!data?.template);

            if (!data) return;

            // Badge du framework (pour le mode Expertise)
            let frameworkBadge = '';
            if (data.framework) {
                frameworkBadge = `<div class="framework-badge">📚 ${data.framework}</div>`;
            }

            // Bloc structure (pour le mode Expertise)
            let structureBlock = '';
            if (data.structure) {
                structureBlock = `
                    <div class="structure-block">
                        <h5>✍️ Structure :</h5>
                        <pre>${data.structure.trim()}</pre>
                    </div>
                `;
            }

            // Si le jour a un template éditable, l'afficher
            if (data.template) {
                const templateHtml = renderEditableTemplate(data.template);
                container.innerHTML = `
                    ${frameworkBadge}
                    <div class="day-objective">🎯 ${data.objective}</div>
                    <label class="editable-template-label">✍️ Remplis directement les champs ci-dessous :</label>
                    <div class="editable-template" id="editableTemplate">${templateHtml}</div>
                    <div class="editable-template-hint">
                        <span>💡</span>
                        <span>Clique sur les zones oranges pour les modifier. L'IA utilisera tes réponses pour créer le post.</span>
                    </div>
                    ${structureBlock}
                `;
                // Cacher le textarea anecdote car on utilise le template
                const anecdoteSection = document.querySelector('.anecdote-inline');
                if (anecdoteSection) anecdoteSection.style.display = 'none';
            } else {
                // Fallback: afficher les questions (pour mode Expertise qui n'a pas encore de templates)
                container.innerHTML = `
                    ${frameworkBadge}
                    <div class="day-objective">🎯 ${data.objective}</div>
                    <h4>📝 Questions pour toi :</h4>
                    <ul>
                        ${data.questions.map(q => `<li>${q}</li>`).join('')}
                    </ul>
                    ${structureBlock}
                `;
                // Afficher le textarea anecdote pour le mode fallback
                const anecdoteSection = document.querySelector('.anecdote-inline');
                if (anecdoteSection) anecdoteSection.style.display = 'block';
            }

            // Stocker le jour actuel et le type pour le prompt
            currentState.strategyDay = parseInt(day);
            currentState.strategyType = objective;
        }

        // Convertir le template en HTML avec placeholders éditables
        function renderEditableTemplate(template) {
            // Remplacer les {placeholder} par des spans éditables
            return template.replace(/\{([^}]+)\}/g, (match, placeholder) => {
                return `<span class="template-placeholder" contenteditable="true" data-placeholder="${placeholder}">${placeholder}</span>`;
            });
        }

        // Récupérer le contenu du template éditable
        function getEditableTemplateContent() {
            const templateEl = document.getElementById('editableTemplate');
            if (!templateEl) return '';

            // Cloner pour ne pas modifier l'original
            const clone = templateEl.cloneNode(true);

            // Remplacer les placeholders par leur contenu
            clone.querySelectorAll('.template-placeholder').forEach(placeholder => {
                const text = placeholder.textContent.trim();
                const originalPlaceholder = placeholder.dataset.placeholder;
                // Si le contenu n'a pas été modifié, mettre une chaîne vide ou le placeholder entre parenthèses
                if (text === originalPlaceholder) {
                    placeholder.replaceWith(`(${originalPlaceholder})`);
                } else {
                    placeholder.replaceWith(text);
                }
            });

            return clone.textContent.trim();
        }

        // Marquer un placeholder comme édité
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('template-placeholder')) {
                const originalPlaceholder = e.target.dataset.placeholder;
                const currentText = e.target.textContent.trim();
                if (currentText !== originalPlaceholder && currentText !== '') {
                    e.target.classList.add('edited');
                } else {
                    e.target.classList.remove('edited');
                }
            }
        });

        // Focus sur un placeholder: sélectionner tout le texte si c'est le placeholder original
        document.addEventListener('focus', function(e) {
            if (e.target.classList.contains('template-placeholder')) {
                const originalPlaceholder = e.target.dataset.placeholder;
                const currentText = e.target.textContent.trim();
                if (currentText === originalPlaceholder) {
                    // Sélectionner tout le texte pour faciliter le remplacement
                    const range = document.createRange();
                    range.selectNodeContents(e.target);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
        }, true);

        // Initialiser les click handlers pour les tone chips
        function initToneChips() {
            document.querySelectorAll('.tone-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.tone-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentState.tone = chip.dataset.tone;
                    updateToneValue();
                });
            });
        }

        function updatePillarSuggestion() {
            const profile = UserProfile.get();
            if (profile?.piliers?.length > 0) {
                const suggested = ContentMemory.getNextPillar(profile.piliers);
                if (suggested) {
                    document.getElementById('suggestedPillar').textContent = suggested;
                    document.getElementById('pillarSuggestion').style.display = 'inline-flex';
                    currentState.currentPillar = suggested;
                }
            }
        }

        function updateMemoryIndicator() {
            const memory = ContentMemory.getSummaryForAI();
            if (memory && memory.totalContents > 0) {
                document.getElementById('memoryText').innerHTML = `<strong>${memory.totalContents}</strong> contenus créés • Piliers utilisés : ${memory.pillarStats || 'aucun'}`;
                document.getElementById('memoryIndicator').style.display = 'flex';
            }
        }

        // Fonction globale appelée après modification du profil (depuis onboarding.js)
        function refreshConfigFromProfile() {
            updatePillarSuggestion();
            updateMemoryIndicator();
            updateProfileButton();
            console.log('🔄 Configuration rafraîchie depuis le profil');
        }
        
        // Exposer globalement pour l'onboarding externe
        window.refreshConfigFromProfile = refreshConfigFromProfile;

        // ==================== HOOKS - GÉNÉRATION & SÉLECTION ====================

        // État des hooks
        let hooksState = {
            selectedEmotion: 'inspiration',
            selectedHumorMode: 'copines',
            selectedTrigger: 'auto', // auto, curiosite, paradoxe, chiffres, identification, confession, urgence, provocation
            generatedHooks: [],
            selectedHook: null,
            selectedHookIndex: -1
        };

        // Toggle la section des déclencheurs
        function toggleTriggerSection() {
            const section = document.getElementById('triggerSection');
            if (section) {
                section.classList.toggle('collapsed');
            }
        }

        // Sélectionner un déclencheur
        function selectTrigger(trigger) {
            hooksState.selectedTrigger = trigger;
            document.querySelectorAll('.trigger-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.trigger === trigger);
            });
        }

        // Mapping des émotions avec leurs icônes et descriptions
        const emotionMap = {
            'inspiration': { icon: '✨', label: 'Inspiration', desc: 'Motiver et inspirer' },
            'admiration': { icon: '🌟', label: 'Admiration', desc: 'Susciter le respect' },
            'vulnerabilite': { icon: '💔', label: 'Vulnérabilité', desc: 'Créer de l\'authenticité' },
            'coup-de-gueule': { icon: '🔥', label: 'Coup de gueule', desc: 'Provoquer une réaction' },
            'humour': { icon: '😄', label: 'Humour', desc: 'Divertir et engager' },
            'curiosite': { icon: '🤔', label: 'Curiosité', desc: 'Intriguer et captiver' },
            'expert': { icon: '🎓', label: 'Expert', desc: 'Montrer ton expertise' },
            'teasing': { icon: '😏', label: 'Teasing', desc: 'Créer du suspense' },
            'motivation': { icon: '💪', label: 'Motivation', desc: 'Booster ton audience' },
            'confession': { icon: '🤫', label: 'Confession', desc: 'Partager un secret' }
        };

        // Mapping des modes humour avec leurs prompts spécifiques (Guide Humour v2.0)
        const humorModes = {
            'copines': {
                icon: '👯‍♀️',
                label: 'Mode Copines',
                style: 'Folles Furieuses',
                prompt: `🍷 MODE COPINES - Style "Folles Furieuses"
Ton : comme entre potes autour d'un verre
Ressorts : exagération, accumulation, images concrètes

EXEMPLES DE RÉFÉRENCE :
- "Mon planning : lundi debug, mardi debug, mercredi pleurs, jeudi debug, vendredi je fais semblant que tout va bien en visio."
- "J'ai envoyé 47 DM cette semaine. 45 vus. 2 réponses. Une pour me vendre une formation, l'autre c'était ma mère."
- "Je parle de mon offre à tout le monde. Le boulanger me fuit. Ma voisine change de trottoir. Mon chat me juge."
- "J'ai relu mon offre 47 fois. Modifié 3 mots. Remis les anciens. Changé la typo. Re-relu. Toujours pas publiée. Tu vois le genre."`
            },
            'cash': {
                icon: '💣',
                label: 'Mode Cash',
                style: 'Blanche Gardin',
                prompt: `🔪 MODE CASH - Style "Blanche Gardin"
Ton : honnêteté brutale, auto-dérision qui pique
Ressorts : aveux de faiblesses, malaise transformé en rire

EXEMPLES DE RÉFÉRENCE :
- "J'ai passé 4h sur un post. 12 likes. Ma photo de burrito : 200 vues. Je suis le problème."
- "Je dis que je suis entrepreneure. En vrai je suis une meuf qui envoie des mails dans le vide en espérant que quelqu'un paie un jour."
- "J'ai fait un webinaire gratuit. 2 inscrits. 1 était moi pour tester. L'autre s'est barré au bout de 3 minutes."
- "Je dis que j'attends 'le bon moment'. Le bon moment c'est quand ? Quand je serai parfaite ? Donc jamais."`
            },
            'caricature': {
                icon: '🎪',
                label: 'Mode Caricature',
                style: 'Foresti',
                prompt: `🎭 MODE CARICATURE - Style "Foresti"
Ton : observation du quotidien poussée jusqu'à l'absurde
Ressorts : situations universelles amplifiées, très visuel

EXEMPLES DE RÉFÉRENCE :
- "Moi en call client : posture droite, sourire pro, 'absolument, c'est noté'. Moi 2 secondes après : affalée comme une crêpe, en train de googler ce que je viens de promettre."
- "Mon bureau à 9h : plantes vertes, café fumant, motivation. Mon bureau à 17h : champ de bataille, 12 onglets, pourquoi j'ai ouvert ce fichier."
- "Le haut dit CEO. Le bas dit pyjama depuis 3 jours."
- "À l'écran : CEO visionnaire. Hors champ : je cherche comment centrer un div."`
            }
        };

        // Toggle le sélecteur de vibe
        function toggleEmotionSection() {
            const section = document.getElementById('emotionSection');
            if (section) {
                section.classList.toggle('expanded');
            }
        }

        // Mapping des émotions pour l'affichage
        const emotionDisplayMap = {
            'inspiration': '✨ Inspiration',
            'admiration': '🌟 Admiration',
            'vulnerabilite': '💔 Vulnérabilité',
            'coup-de-gueule': '🔥 Coup de gueule',
            'humour': '😄 Humour',
            'curiosite': '🤔 Curiosité',
            'expert': '🎓 Expert',
            'teasing': '😏 Teasing',
            'motivation': '💪 Motivation',
            'confession': '🤫 Confession'
        };

        // Sélectionner une émotion
        function selectEmotion(emotion) {
            hooksState.selectedEmotion = emotion;

            // Mettre à jour l'UI
            document.querySelectorAll('.emotion-chip').forEach(chip => {
                chip.classList.remove('active');
                if (chip.dataset.emotion === emotion) {
                    chip.classList.add('active');
                }
            });

            // Mettre à jour le badge affiché dans le toggle
            const vibeDisplay = document.getElementById('selectedVibeDisplay');
            if (vibeDisplay && emotionDisplayMap[emotion]) {
                vibeDisplay.textContent = emotionDisplayMap[emotion];
            }

            // Fermer le toggle après sélection
            const section = document.getElementById('emotionSection');
            if (section) {
                section.classList.remove('expanded');
            }

            // Afficher/masquer le panneau des modes humour
            const humorPanel = document.getElementById('humorModesPanel');
            if (humorPanel) {
                humorPanel.style.display = (emotion === 'humour') ? 'block' : 'none';
            }

            console.log('🎭 Émotion sélectionnée:', emotion);
        }

        // Sélectionner un mode humour
        function selectHumorMode(mode) {
            hooksState.selectedHumorMode = mode;

            // Mettre à jour l'UI
            document.querySelectorAll('.humor-mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });

            // Son de clic
            if (typeof SoundSystem !== 'undefined') SoundSystem.playClick();

            console.log('🎭 Mode humour sélectionné:', mode);
        }

        // Générer des hooks via l'IA
        async function generateHooks() {
            let brief = document.getElementById('ideaInput').value.trim();
            const anecdote = getAnecdote();

            // Si pas de brief mais une anecdote, utiliser l'anecdote
            if (!brief && anecdote) {
                brief = anecdote;
                document.getElementById('ideaInput').value = anecdote;
            }

            if (!brief) {
                alert('Écris d\'abord ton idée/sujet ou une anecdote avant de générer des hooks !');
                return;
            }

            // Scroll vers le haut
            window.scrollTo({ top: 0, behavior: 'smooth' });
            const hooksSection = document.getElementById('hooksSection');
            if (hooksSection) {
                hooksSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            const btn = document.getElementById('generateHooksBtn');
            btn.classList.add('loading');
            btn.disabled = true;
            btn.querySelector('span').textContent = 'Génération en cours';

            // Jouer le son de réflexion
            if (typeof playThinkingSound === 'function') playThinkingSound();

            // Récupérer le profil utilisateur pour personnaliser
            const profile = UserProfile.get();
            const emotionInfo = emotionMap[hooksState.selectedEmotion];

            // Récupérer le contexte d'audience
            const audienceContext = typeof getAudienceContextForPrompt === 'function' ? getAudienceContextForPrompt() : '';

            // Construire le prompt selon l'émotion (spécial pour humour)
            let hooksPrompt = '';

            if (hooksState.selectedEmotion === 'humour') {
                // Prompt spécial pour l'humour avec les 3 modes (Guide Humour v2.0)
                const humorMode = humorModes[hooksState.selectedHumorMode];

                hooksPrompt = `Tu es un copywriter spécialisé dans l'humour authentique pour entrepreneures et créatrices. Tu écris comme une pote qui chambre gentiment, PAS comme un marketeur qui essaie d'être drôle.

PRINCIPE : L'humour sert le message. On rit ENSEMBLE de nos galères.

═══════════════════════════════════════════════════════════════
BRIEF DE L'UTILISATRICE
═══════════════════════════════════════════════════════════════
${brief}

═══════════════════════════════════════════════════════════════
CONTEXTE
═══════════════════════════════════════════════════════════════
- Plateforme: ${currentState.platform}
${audienceContext ? audienceContext : '- Cible : entrepreneures, solopreneurs, créatrices'}
- Sujets : IA, visibilité, création de contenu, galères de fondatrice, charge mentale, clients, bugs, réseaux sociaux, lancements ratés, syndrome de l'imposteur

═══════════════════════════════════════════════════════════════
STYLE D'HUMOUR CHOISI
═══════════════════════════════════════════════════════════════
${humorMode.prompt}

═══════════════════════════════════════════════════════════════
LES 6 RESSORTS HUMORISTIQUES (utilise-les)
═══════════════════════════════════════════════════════════════

1. CONTRASTE INATTENDU
"À l'écran, X. Hors champ, Y."

2. HYPERBOLE
"Parce que [problème], j'en suis à [exagération absurde]."

3. PERSONNIFICATION
"Mon [objet] = [rôle inattendu]."

4. RUPTURE DE POSTURE
"Je fais X. En vrai, Y."

5. AUTO-DÉRISION CIBLÉE
"Je fais X. Si tu fais pareil, on se comprend."

6. PARALLÈLE QUI DÉGONFLE (pour rassurer/relativiser)
"[Célébrité] quand [situation] : [enjeux énormes]. Toi quand [même situation] : [enjeux gérables]."
Ex: "Elon rate un lancement : perd 200M. Toi tu rates un lancement : tu manges un cookie et tu réessaies."

═══════════════════════════════════════════════════════════════
RÈGLES ABSOLUES
═══════════════════════════════════════════════════════════════

✅ TOUJOURS :
- Court et sec (pas d'explication de la blague)
- Images concrètes ("claquettes moumoute" > "mode détente")
- Vérité d'abord, formule après
- Chute qui claque

❌ JAMAIS :
- Emojis qui surjouent (max 1, si vraiment nécessaire)
- VOCABULAIRE INTERDIT : "niveau X", "mood", "en PLS", "vibe", "officiellement", "c'est validé", "littéralement", "game-changer", "boost", "ultra", "Point.", "Vécu.", "Clairement.", "plot twist", "spoiler alert"
- Expliquer la blague
- Humour qui rabaisse les autres
- Mélanger les styles dans un même contenu

═══════════════════════════════════════════════════════════════
MISSION
═══════════════════════════════════════════════════════════════
Génère exactement 5 hooks dans le style "${humorMode.label}". Reste dans ce ton, ne mélange pas les styles.

FORMAT DE RÉPONSE (JSON strict):
{
  "hooks": [
    {"text": "Premier hook", "type": "${hooksState.selectedHumorMode}"},
    {"text": "Deuxième hook", "type": "${hooksState.selectedHumorMode}"},
    {"text": "Troisième hook", "type": "${hooksState.selectedHumorMode}"},
    {"text": "Quatrième hook", "type": "${hooksState.selectedHumorMode}"},
    {"text": "Cinquième hook", "type": "${hooksState.selectedHumorMode}"}
  ]
}

Réponds UNIQUEMENT avec le JSON, sans texte avant ou après.`;

            } else {
                // Prompt standard amélioré avec les 7 déclencheurs
                hooksPrompt = `Tu es un expert en copywriting spécialisé dans les accroches (hooks) pour les réseaux sociaux.

## TA MISSION
Générer des accroches qui STOPPENT LE SCROLL en 1,5 seconde.

## CE QU'EST UNE ACCROCHE
- Une PHRASE COMPLÈTE qui provoque une réaction immédiate
- PAS un template vide avec des [X] à remplir
- PAS une structure ou un squelette
- PAS une introduction polie

## CONTEXTE
- Brief: ${brief}
- Plateforme: ${currentState.platform}
- Format: ${currentState.format}
- Émotion recherchée: ${emotionInfo.label} (${emotionInfo.desc})
${profile?.tonalite ? `- Tonalité: ${profile.tonalite}` : ''}
${audienceContext ? audienceContext : ''}

## LES 7 DÉCLENCHEURS (utilise AU MOINS 1 par hook)

1. CURIOSITÉ — Ouvre une boucle que le cerveau doit fermer
   Ex: "J'ai refusé 15 000€. Meilleure décision de ma vie."

2. PARADOXE — Affirme quelque chose de contre-intuitif
   Ex: "Plus je travaille, moins je gagne."

3. SPÉCIFICITÉ — Utilise des chiffres précis
   Ex: "Ce post m'a pris 7 minutes. 89 000 vues."

4. IDENTIFICATION — Décris une situation que le lecteur vit
   Ex: "Tu relis ton post pour la 15ème fois. Tu changes un mot. Puis tu remets l'ancien."

5. CONFESSION — Partage quelque chose de vulnérable
   Ex: "Mon lancement a fait 0 vente. Zéro."

6. URGENCE — Crée un sentiment de FOMO
   Ex: "Si tu fais encore ça en 2025, l'algorithme t'enterre."

7. PROVOCATION — Prends une position forte
   Ex: "Le personal branding, c'est le nouveau MLM."

## RÈGLES ABSOLUES

✅ TOUJOURS :
- Phrase complète et autonome
- Tension ou curiosité immédiate
- Spécificité (chiffres, situations, exemples)
- Compréhensible en 1,5 seconde
- Maximum 150 caractères (2 lignes mobile)

❌ JAMAIS :
- "Aujourd'hui, je voulais vous parler de..."
- Questions vagues ("Ça vous est déjà arrivé de...?")
- Jargon technique
- Templates avec [X] à remplir
- Listes sans tension ("5 conseils pour...")

## ADAPTATION PLATEFORME
${currentState.platform === 'linkedin' ? 'LINKEDIN : Confessions business, chiffres précis, ton pro mais pas corporate' : ''}
${currentState.platform === 'instagram' ? 'INSTAGRAM : Plus court, plus émotionnel, storytelling personnel' : ''}
${currentState.platform === 'tiktok' ? 'TIKTOK : 3 premiers mots critiques, "Arrête de...", "POV:", provoc assumée' : ''}
${currentState.platform === 'youtube' ? 'YOUTUBE : Hook 5 sec max qui intrigue, format script parlé, "Dans cette vidéo...", tension dès le début' : ''}
${currentState.platform === 'substack' ? 'SUBSTACK : Ton lettre intime, "Salut toi", comme à un ami, réflexion personnelle, accroche qui donne envie de lire la suite' : ''}

## MISSION
${hooksState.selectedTrigger === 'auto'
    ? `Génère exactement 4 accroches avec l'émotion "${emotionInfo.label}". Utilise des déclencheurs VARIÉS (curiosité, paradoxe, identification, confession...).`
    : `Génère exactement 4 accroches avec l'émotion "${emotionInfo.label}". Utilise UNIQUEMENT le déclencheur "${hooksState.selectedTrigger.toUpperCase()}" pour toutes les accroches.`}

FORMAT DE RÉPONSE (JSON strict):
{
  "hooks": [
    {"text": "Accroche complète ici", "type": "${hooksState.selectedTrigger === 'auto' ? 'curiosite' : hooksState.selectedTrigger}"},
    {"text": "Accroche complète ici", "type": "${hooksState.selectedTrigger === 'auto' ? 'paradoxe' : hooksState.selectedTrigger}"},
    {"text": "Accroche complète ici", "type": "${hooksState.selectedTrigger === 'auto' ? 'identification' : hooksState.selectedTrigger}"},
    {"text": "Accroche complète ici", "type": "${hooksState.selectedTrigger === 'auto' ? 'confession' : hooksState.selectedTrigger}"}
  ]
}

Réponds UNIQUEMENT avec le JSON, sans texte avant ou après.`;
            }

            try {
                // Utiliser callAI directement (pas callAIStream qui attend un élément DOM)
                const fullResponse = await callAI(hooksPrompt);

                // Parser la réponse JSON
                const jsonMatch = fullResponse.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const parsed = JSON.parse(jsonMatch[0]);
                    hooksState.generatedHooks = parsed.hooks || [];
                    displayHooks(hooksState.generatedHooks);
                } else {
                    throw new Error('Format de réponse invalide');
                }

            } catch (error) {
                console.error('Erreur génération hooks:', error);
                // Fallback avec des hooks par défaut pour démonstration
                hooksState.generatedHooks = [
                    { text: `${emotionInfo.icon} Hook basé sur "${brief.substring(0, 50)}..."`, type: 'auto' },
                    { text: `Et si je te disais que ${brief.substring(0, 30)}... ?`, type: 'question' },
                    { text: `La vérité sur ${brief.substring(0, 30)} que personne n'ose dire.`, type: 'affirmation' },
                    { text: `J'ai fait cette erreur pendant 2 ans. Voici ce que j'ai appris.`, type: 'histoire' }
                ];
                displayHooks(hooksState.generatedHooks);
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
                btn.querySelector('span').textContent = 'Générer des hooks';
                // Masquer le bouton générer après succès (on garde le bouton Regénérer)
                document.getElementById('hooksGenerateSection').style.display = 'none';
            }
        }

        // Afficher les hooks générés
        function displayHooks(hooks) {
            const grid = document.getElementById('hooksGrid');
            const resultsSection = document.getElementById('hooksResults');
            const continueSection = document.getElementById('hooksContinueSection');

            // Déterminer l'icône et le label à afficher
            let displayIcon, displayLabel;
            if (hooksState.selectedEmotion === 'humour') {
                const humorMode = humorModes[hooksState.selectedHumorMode];
                displayIcon = humorMode.icon;
                displayLabel = humorMode.label;
            } else {
                displayIcon = emotionMap[hooksState.selectedEmotion].icon;
                displayLabel = emotionMap[hooksState.selectedEmotion].label;
            }

            grid.innerHTML = hooks.map((hook, index) => `
                <div class="hook-card" data-index="${index}" onclick="selectHook(${index})">
                    <div class="hook-card-text">${hook.text}</div>
                    <div class="hook-card-emotion">
                        <span>${displayIcon}</span>
                        <span>${displayLabel}</span>
                    </div>
                </div>
            `).join('');

            resultsSection.style.display = 'block';
            continueSection.style.display = 'flex';

            // Reset la sélection
            hooksState.selectedHook = null;
            hooksState.selectedHookIndex = -1;
            document.getElementById('hooksContinueBtn').disabled = true;

            // Scroll automatique vers les hooks générés avec feedback visuel
            setTimeout(() => {
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        // Sélectionner un hook
        function selectHook(index) {
            // Mettre à jour l'état
            hooksState.selectedHookIndex = index;
            hooksState.selectedHook = hooksState.generatedHooks[index];

            // Mettre à jour l'UI
            document.querySelectorAll('.hook-card').forEach((card, i) => {
                card.classList.toggle('selected', i === index);
            });

            // Activer le bouton continuer
            document.getElementById('hooksContinueBtn').disabled = false;

            console.log('🪝 Hook sélectionné:', hooksState.selectedHook);
        }

        // Continuer avec le hook sélectionné
        function continueWithHook() {
            if (!hooksState.selectedHook) return;

            // Afficher le hook dans la section contenu
            document.getElementById('selectedHookText').textContent = hooksState.selectedHook.text;
            document.getElementById('selectedHookDisplay').style.display = 'block';

            // Passer à l'étape contenu
            document.getElementById('hooksSection').style.display = 'none';
            document.getElementById('contentSection').style.display = 'block';

            // Stocker le hook dans l'état global pour la génération
            currentState.selectedHook = hooksState.selectedHook.text;

            // Générer automatiquement le contenu avec le hook
            generateContentWithHook();
        }

        // Générer le contenu avec le hook sélectionné
        async function generateContentWithHook() {
            const brief = document.getElementById('ideaInput').value.trim();
            const hook = currentState.selectedHook;
            const outputContent = document.getElementById('outputContent');
            const profile = UserProfile.get();

            // Récupérer le contexte d'audience
            const audienceContext = typeof getAudienceContextForPrompt === 'function' ? getAudienceContextForPrompt() : '';

            // Scroll vers le haut
            window.scrollTo({ top: 0, behavior: 'smooth' });

            let contentPrompt = '';

            // ============ PROMPT SPÉCIAL HUMOUR ============
            if (hooksState.selectedEmotion === 'humour') {
                const humorMode = humorModes[hooksState.selectedHumorMode];

                if (currentState.format === 'carousel') {
                    // ========== PROMPT CARROUSEL HUMORISTIQUE COMPLET ==========
                    contentPrompt = `Tu es un copywriter spécialisé dans l'humour authentique pour entrepreneures. Tu crées du contenu qui fait rire ET qui éduque, sans jamais tomber dans le marketing creux ou le ton "coach inspirationnel".

═══ IDENTITÉ ═══
- Une pote qui chambre gentiment, pas une experte qui fait la leçon
- Lucide et honnête, jamais cynique ni méchante
- Complice avec l'audience, jamais condescendante
- On rit ensemble DE nos galères, pas des autres

PRINCIPE : L'humour sert le message. On fait rire pour faire passer une vérité.
${audienceContext ? `
═══ AUDIENCE ═══
${audienceContext}` : ''}

═══ BRIEF DE L'UTILISATRICE ═══
${brief}

═══ IDÉE CENTRALE À TRANSFORMER ═══
"${hook}"

═══ STYLE D'HUMOUR CHOISI ═══
${humorMode.prompt}

═══ STRUCTURE DU CARROUSEL ═══

📍 SLIDE 1 — HOOK
Une phrase courte qui pose le contraste ou la tension. Donne envie de swiper.
Exemple : "L'IA fait des miracles. Sauf quand t'as vraiment besoin d'elle."

📍 SLIDES 2 à 7 — CORPS
- Une situation par slide, pas plus
- La punchline tombe À LA FIN de la slide, jamais au milieu
- Alterner les angles (ce qui marche / ce qui foire, avant / après)
- Utiliser des comparaisons du quotidien

📍 SLIDE 8 — MORALE
Une phrase qui ancre le positionnement expert. Pas moralisatrice, juste lucide.
Format : "[Sujet] fait [force]. [Limite] sans [ce que toi tu apportes]."
Exemple : "L'IA fait le taf. À condition que quelqu'un lui dise lequel."

📍 SLIDE 9 — CTA
Question ouverte qui invite au commentaire. Ton complice, pas injonctif.
SEUL ENDROIT où 1 emoji est toléré.
Exemple : "Ton meilleur fail IA ? Balance en commentaire. 👇"

═══ RESSORTS D'HUMOUR (6 RESSORTS) ═══

1. CONTRASTE BRUTAL
"L'IA qui analyse mes concurrents : 3 pages de rapport. L'IA quand je demande si mon prix est bon : 'Ça dépend.'"

2. COMPARAISON DU QUOTIDIEN
"Comme ma pote quand je demande si ma robe me grossit."
"Plus froide qu'un ex qui me ghoste."

3. CHUTE SÈCHE
"47 graphiques. Personne les lira."
"'Contactez le support humain.' Sympa."

4. AUTO-DÉRISION PARTAGÉE
"Le haut dit CEO. Le bas dit pyjama depuis 3 jours."

5. CHIFFRES PRÉCIS (sonne vécu)
✅ "Depuis 3 jours" au lieu de "Ça fait longtemps"
✅ "Ça marche 6 fois sur 10" au lieu de "Ça marche parfois"

6. PARALLÈLE QUI DÉGONFLE (pour rassurer/relativiser)
Compare la situation à celle d'une célébrité pour dédramatiser.
"Elon rate un lancement : perd 200M, articles dans la presse mondiale.
Toi tu rates un lancement : tu manges un cookie et tu réessaies le mois prochain."

═══ RÈGLES D'ÉCRITURE ═══

1. COURT ET SEC - pas d'explication de la blague
❌ "Cache-cernes niveau béton : parce que 'j'ai dormi 2h' ça se voit trop 💪"
✅ "Pour camoufler les nuits blanches à debug."

2. ZÉRO EMOJI DANS LE CORPS (seulement CTA)
❌ "Mon café est mon CTO ☕✨💪"
✅ "Mon café est mon CTO."

3. IMAGES CONCRÈTES > CONCEPTS ABSTRAITS
❌ "Mode détente activé"
✅ "Claquettes moumoute"

4. LA PUNCHLINE TOMBE À LA FIN
❌ "Sympa, le support humain qu'on me propose."
✅ "'Contactez le support humain.' Sympa."

═══ INTERDICTIONS ABSOLUES ═══

🚫 EMOJIS INTERDITS (JAMAIS dans le corps) : 💪 ✨ 🚀 🌱 💎 🌟 😅 😱 😭 🤯 ⚡ 🎯 💫 🔥 😂 🤣 💀

🚫 VOCABULAIRE INTERDIT : "niveau [X]", "officiellement", "ultra", "game-changer", "boost", "mood", "vibe", "en PLS", "et c'est ok", "c'est validé", "spoiler alert", "plot twist", "Point.", "Vécu.", "Clairement.", "littéralement", "extraordinaire", "magie pure", "opportunité", "grandir", "trop bien", "incroyable"

🚫 FORMULATIONS INTERDITES :
- Méprisantes envers un métier : "Midjourney > graphiste" → "J'ai pas le budget graphiste de toute façon."
- Anxiogènes : "Code ou crève" → "Apprends à prompter, ça aide."
- Expliquer la blague après la punchline

🚫 TON "COACH INSPIRATIONNEL" INTERDIT :
❌ "Transforme chaque panne en opportunité d'apprendre !"
❌ "On l'embrasse avec courage !"
CE TON EST STRICTEMENT INTERDIT.

═══ FORMAT DE SORTIE ═══

📍 SLIDE 1
[Hook accrocheur - contraste/tension]

📍 SLIDE 2
[Situation 1 - punchline à la fin]

📍 SLIDE 3
[Situation 2]

📍 SLIDE 4
[Situation 3]

📍 SLIDE 5
[Situation 4]

📍 SLIDE 6
[Situation 5]

📍 SLIDE 7
[Situation 6]

📍 SLIDE 8
[Morale lucide]

📍 SLIDE 9
[CTA + 1 emoji max]

AVANT DE GÉNÉRER, VÉRIFIE :
☐ Aucun emoji dans le corps
☐ Aucun mot/expression interdit
☐ Punchlines à la fin des slides
☐ Images concrètes, pas abstraites
☐ Ton pote qui chambre, pas coach

Génère le carrousel complet maintenant.`;

                } else {
                    // ========== PROMPT POST HUMORISTIQUE ==========
                    contentPrompt = `Tu es un copywriter spécialisé dans l'humour authentique pour entrepreneures.

═══ IDENTITÉ ═══
- Pote qui chambre, pas coach qui motive
- Lucide, pas cynique
- Complice, pas condescendante
${audienceContext ? `
═══ AUDIENCE ═══
${audienceContext}` : ''}

═══ BRIEF ═══
${brief}

═══ IDÉE CENTRALE ═══
"${hook}"

═══ STYLE ═══
${humorMode.prompt}

═══ STRUCTURE DU POST ═══
1. HOOK : Phrase courte avec contraste ou tension (donne envie de lire la suite)
2. CORPS : 3-5 phrases qui développent, même ton, punchlines à la fin
3. CHUTE : Phrase sèche qui fait atterrir OU question complice

═══ LES 6 RESSORTS À UTILISER ═══
1. Contraste brutal : opposer deux réalités ("À l'écran X. Hors champ Y.")
2. Comparaison du quotidien : "Comme ma pote quand...", "Plus froid qu'un ex qui..."
3. Chute sèche : terminer sur un mot court
4. Auto-dérision partagée : "Si tu fais pareil, on se comprend."
5. Chiffres précis ("depuis 3 jours" pas "depuis longtemps")
6. Parallèle qui dégonfle : comparer à une célébrité pour relativiser
   Ex: "Elon rate un lancement : perd 200M. Toi tu rates : tu manges un cookie."

═══ RÈGLES ═══
- Court et sec, pas d'explication de la blague
- Max 1 emoji à la fin, seulement si nécessaire
- Images concrètes : "claquettes moumoute" pas "mode détente"
- Punchline à la fin, pas au milieu

═══ INTERDICTIONS ABSOLUES ═══
🚫 EMOJIS dans le corps : 💪 ✨ 🚀 😅 🔥 😂 🤣 💀 🌱 💎 🌟 😱 😭 🤯
🚫 VOCABULAIRE INTERDIT : "niveau X", "ultra", "game-changer", "boost", "mood", "vibe", "en PLS", "officiellement", "clairement", "c'est validé", "littéralement", "Point.", "Vécu.", "plot twist", "spoiler alert", "trop bien", "incroyable"
🚫 Ton coach : "Transforme ça en opportunité !", "Et c'est ok", "On l'embrasse avec courage !"
🚫 Morale ou leçon de vie à la fin
🚫 Expliquer la blague après la punchline

═══ EXEMPLES DE BONNES PUNCHLINES ═══
- "Le haut dit CEO. Le bas dit pyjama depuis 3 jours."
- "47 graphiques. Personne les lira."
- "'Contactez le support humain.' Sympa."
- "Elon rate : perd 200M. Toi tu rates : tu manges un cookie."

Génère le post complet maintenant, sans commentaires.`;
                }

            } else {
                // ============ PROMPT STANDARD ============
                let formatInstructions = '';
                if (currentState.format === 'carousel') {
                    formatInstructions = `
FORMAT CAROUSEL - RÈGLES STRICTES:
- Génère exactement 8 à 10 slides
- Chaque slide = UNE SEULE PHRASE PUNCHLINE (max 15 mots)
- Slide 1 = Le hook (ne le modifie pas)
- Slides 2-9 = Une idée forte par slide, style punchline percutante
- Dernière slide = Call-to-action engageant

FORMAT DE SORTIE:
📍 SLIDE 1
[Le hook]

📍 SLIDE 2
[Punchline]

📍 SLIDE 3
[Punchline]

... etc jusqu'à la slide 10`;
                } else {
                    formatInstructions = `
RÈGLES:
- Le hook doit être la première phrase du contenu (ne le modifie pas)
- Adapte la longueur au format ${currentState.format}
- Inclus un appel à l'action pertinent à la fin
- Utilise des emojis de manière appropriée pour ${currentState.platform}
- Le contenu doit être prêt à être posté`;
                }

                // Construire le contexte du profil utilisateur
                let profileContext = '';
                console.log('[Generate] Profile:', profile);
                console.log('[Generate] VoiceProfile:', profile?.voiceProfile);
                if (profile) {
                    const parts = [];
                    if (profile.nom) parts.push(`Auteur: ${profile.nom}`);
                    if (profile.domaine) parts.push(`Domaine: ${profile.domaine}`);
                    if (profile.messageUnique) parts.push(`Message unique: ${profile.messageUnique}`);
                    if (profile.style) parts.push(`Style d'écriture: ${profile.style}`);
                    if (profile.publicCible?.length) parts.push(`Public cible: ${profile.publicCible.join(', ')}`);
                    if (profile.piliers?.length) parts.push(`Piliers de contenu: ${profile.piliers.join(', ')}`);

                    // Intégrer le voiceProfile analysé par l'IA
                    if (profile.voiceProfile) {
                        const vp = profile.voiceProfile;
                        if (vp.ton) parts.push(`Ton: ${vp.ton}`);
                        if (vp.registre) parts.push(`Registre: ${vp.registre}`);
                        if (vp.rythme) parts.push(`Rythme: ${vp.rythme}`);
                        if (vp.signature) parts.push(`Signature stylistique: ${vp.signature}`);
                        // Gérer expressions comme string ou array
                        if (vp.expressions) {
                            const expr = Array.isArray(vp.expressions) ? vp.expressions.slice(0, 5).join(', ') : vp.expressions;
                            parts.push(`Expressions favorites: ${expr}`);
                        }
                        // Gérer tournures comme string ou array
                        if (vp.tournures) {
                            const turn = Array.isArray(vp.tournures) ? vp.tournures.slice(0, 3).join(', ') : vp.tournures;
                            parts.push(`Tournures typiques: ${turn}`);
                        }
                    }

                    if (parts.length > 0) {
                        profileContext = `
═══ PROFIL DE L'AUTEUR (IMPORTANT - ADOPTE CE STYLE) ═══
${parts.join('\n')}

INSTRUCTION CRITIQUE: Tu dois écrire EXACTEMENT comme cette personne. Imite son ton, ses expressions, sa façon de structurer ses phrases. Ne sois pas générique.
`;
                    }
                }

                // Récupérer les instructions du framework si sélectionné
                const frameworkInstructions = FrameworkSystem.getPromptInstructions();

                contentPrompt = `Tu es un ghostwriter expert qui écrit AU NOM de l'auteur, en adoptant parfaitement son style unique.
${profileContext}
═══ CONTEXTE ═══
- Plateforme: ${currentState.platform}
- Format: ${currentState.format}
- Hook choisi: "${hook}"
${audienceContext ? `
═══ AUDIENCE ═══
${audienceContext}` : ''}

═══════════════════════════════════════════════════════════════
⚠️ INSTRUCTION CRITIQUE : FUSION HISTOIRE + HOOK
═══════════════════════════════════════════════════════════════

HISTOIRE PERSONNELLE DE L'AUTEUR (à intégrer OBLIGATOIREMENT) :
${brief}

Le HOOK ci-dessus est l'ANGLE D'ATTAQUE, pas le sujet complet.
Tu DOIS fusionner l'histoire personnelle avec le hook :

1. UTILISE les détails CONCRETS de l'histoire :
   - Les chiffres mentionnés (ex: "2 clients", "6 mois", "15 clients")
   - Les situations vécues (ex: "fins de mois difficiles", "doutes")
   - Les émotions décrites (ex: "syndrome imposteur", "déclic")
   - Les transformations racontées

2. Le hook = l'accroche qui lance le récit
3. L'histoire = la MATIÈRE du post (les preuves, le vécu, les exemples)

❌ INTERDIT : Générer un post "parallèle" qui ignore l'histoire
❌ INTERDIT : Inventer des chiffres ou situations non mentionnées
✅ OBLIGATOIRE : Les éléments clés de l'histoire doivent apparaître dans le post

${frameworkInstructions ? `
═══════════════════════════════════════════════════════════════
📐 FRAMEWORK DE STRUCTURE (à suivre STRICTEMENT)
═══════════════════════════════════════════════════════════════
${frameworkInstructions}

IMPORTANT : Applique ce framework EN UTILISANT l'histoire personnelle comme matière première.
Chaque étape du framework doit puiser dans l'anecdote fournie.
` : ''}

${getPlatformRulesForPrompt(currentState.platform, currentState.format)}

═══ MISSION ═══
Crée un contenu complet et engageant pour ${currentState.platform} :
1. Commence par le hook fourni (première ligne)
2. Développe en utilisant les éléments de l'histoire personnelle
3. Applique le framework si sélectionné
${formatInstructions}

RAPPEL: Écris dans le style PERSONNEL de l'auteur, pas de manière générique. Utilise ses expressions, son ton, sa signature.
IMPORTANT: Respecte STRICTEMENT les contraintes de la plateforme et du format ci-dessus.

Génère uniquement le contenu final, sans commentaires.`;
            }

            try {
                // Utiliser callAIStream avec l'élément DOM (il affiche la lottie automatiquement)
                const generatedText = await callAIStream(contentPrompt, outputContent);

                // Sauvegarder le contenu généré dans l'état
                currentState.generatedContent = generatedText;

                // Afficher les boutons d'action
                document.getElementById('actionButtons').style.display = 'flex';
                document.getElementById('visualSection').style.display = 'block';

                // Afficher les bonnes pratiques du moment
                displayTipsWidget();

                // Sauvegarder dans la mémoire
                ContentMemory.addContent(generatedText, currentState.currentPillar, currentState.platform, currentState.format);

                // Tracker l'usage du framework si sélectionné
                if (FrameworkSystem.selectedFramework) {
                    FrameworkSystem.incrementUsage(FrameworkSystem.selectedFramework);
                }

            } catch (error) {
                console.error('Erreur génération contenu:', error);
                outputContent.innerHTML = `
                    <div class="output-placeholder" style="color: #e74c3c;">
                        <div class="output-placeholder-icon">❌</div>
                        <p>Erreur lors de la génération. Réessaie !</p>
                    </div>
                `;
            }
        }

        // Changer de hook (retour à la sélection)
        function changeHook() {
            document.getElementById('contentSection').style.display = 'none';
            document.getElementById('hooksSection').style.display = 'block';
            document.getElementById('selectedHookDisplay').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'none';
            document.getElementById('visualSection').style.display = 'none';
            document.getElementById('adjustPanel').style.display = 'none';
        }

        // ==================== PANNEAU D'AJUSTEMENT ====================

        // Toggle le panneau d'ajustement
        function toggleAdjustPanel() {
            const panel = document.getElementById('adjustPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                // Son de clic
                if (typeof SoundSystem !== 'undefined') SoundSystem.playClick();
            } else {
                panel.style.display = 'none';
            }
        }

        // Ajuster le contenu selon l'option choisie
        async function adjustContent(type) {
            const outputContent = document.getElementById('outputContent');
            const currentContent = currentState.generatedContent || outputContent.innerText;

            console.log('[Adjust] Type:', type);
            console.log('[Adjust] Current content length:', currentContent?.length);
            console.log('[Adjust] Current content:', currentContent?.substring(0, 200));

            if (!currentContent || currentContent.trim() === '') {
                showToast('❌ Aucun contenu à ajuster');
                return;
            }

            // Construire le prompt selon le type d'ajustement
            let adjustPrompt = '';
            const customInput = document.getElementById('adjustInput').value.trim();

            switch(type) {
                case 'shorter':
                    adjustPrompt = `Voici un contenu pour les réseaux sociaux. Réduis-le de MOITIÉ minimum. Garde UNIQUEMENT :
- Le hook (première phrase)
- 2-3 phrases clés maximum
- Le call-to-action

Supprime tout le reste. Sois brutal dans la coupe.

CONTENU ACTUEL:
${currentContent}

Génère UNIQUEMENT le contenu ultra-court, sans commentaires ni explications.`;
                    break;

                case 'longer':
                    adjustPrompt = `Voici un contenu pour les réseaux sociaux. Enrichis-le et développe-le davantage avec plus de détails, d'exemples ou d'arguments. Garde le hook d'origine.

CONTENU ACTUEL:
${currentContent}

Génère uniquement le contenu enrichi, sans commentaires.`;
                    break;

                case 'simplify':
                    adjustPrompt = `Voici un contenu pour les réseaux sociaux. Simplifie le langage pour le rendre plus accessible et facile à comprendre. Utilise des mots simples et des phrases courtes. Garde le hook d'origine.

CONTENU ACTUEL:
${currentContent}

Génère uniquement le contenu simplifié, sans commentaires.`;
                    break;

                case 'tone':
                    adjustPrompt = `Voici un contenu pour les réseaux sociaux. Change le ton pour le rendre plus conversationnel, chaleureux et engageant, comme si tu parlais à un ami. Garde le hook d'origine.

CONTENU ACTUEL:
${currentContent}

Génère uniquement le contenu avec le nouveau ton, sans commentaires.`;
                    break;

                case 'custom':
                    if (!customInput) {
                        showToast('💬 Dis-moi ce que tu veux changer !');
                        return;
                    }
                    adjustPrompt = `Voici un contenu pour les réseaux sociaux. Modifie-le selon cette demande : "${customInput}"

CONTENU ACTUEL:
${currentContent}

Génère uniquement le contenu modifié, sans commentaires.`;
                    break;
            }

            // Fermer le panneau
            document.getElementById('adjustPanel').style.display = 'none';
            document.getElementById('adjustInput').value = '';

            // Générer le nouveau contenu
            try {
                console.log('[Adjust] Calling AI with prompt length:', adjustPrompt.length);
                const adjustedText = await callAIStream(adjustPrompt, outputContent);
                console.log('[Adjust] AI response length:', adjustedText?.length);
                console.log('[Adjust] AI response:', adjustedText?.substring(0, 200));
                currentState.generatedContent = adjustedText;
                showToast('✅ Contenu ajusté !');
            } catch (error) {
                console.error('[Adjust] Error:', error);
                showToast('❌ Erreur lors de l\'ajustement: ' + error.message);
            }
        }

        // Retour au brief
        function backToBrief() {
            document.getElementById('hooksSection').style.display = 'none';
            document.getElementById('contentSection').style.display = 'block';
            // Reset
            document.getElementById('hooksResults').style.display = 'none';
            document.getElementById('hooksContinueSection').style.display = 'none';
            document.getElementById('hooksGenerateSection').style.display = 'block';
            hooksState.generatedHooks = [];
            hooksState.selectedHook = null;
        }

        // Afficher la section Hooks (appelé depuis le bouton Générer)
        function showHooksSection() {
            const brief = document.getElementById('ideaInput').value.trim();
            const anecdote = getAnecdote();

            // Si pas de brief mais une anecdote, utiliser l'anecdote comme brief
            let effectiveBrief = brief;
            if (!brief && anecdote) {
                effectiveBrief = anecdote;
                // Remplir automatiquement le champ idée avec l'anecdote
                document.getElementById('ideaInput').value = anecdote;
            } else if (brief && anecdote && !brief.includes(anecdote)) {
                // Si les deux sont remplis, combiner
                effectiveBrief = `${brief}\n\nAnecdote : ${anecdote}`;
            }

            // Son de clic
            if (typeof SoundSystem !== 'undefined') {
                SoundSystem.playClick();
            }

            // Effet visuel sur le bouton
            const btn = document.getElementById('generateBtn');
            btn.style.transform = 'scale(0.95)';
            setTimeout(() => { btn.style.transform = 'scale(1)'; }, 150);

            // Mettre à jour le rappel du brief
            document.getElementById('briefRecapContent').textContent = effectiveBrief || 'Aucun brief renseigné';

            // Afficher la section hooks, masquer contenu
            document.getElementById('hooksSection').style.display = 'block';
            document.getElementById('contentSection').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'none';
            document.getElementById('visualSection').style.display = 'none';

            // Scroll doux vers le panneau de droite (desktop et mobile)
            const outputPanel = document.getElementById('outputPanel');
            if (outputPanel) {
                setTimeout(() => {
                    outputPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }

            // Auto-générer les hooks immédiatement
            setTimeout(() => {
                generateHooks();
            }, 200);
        }

        // ==================== TRENDS - GÉNÉRATION DE PROMPTS ====================
        function showTrends() {
            document.getElementById('trendsModal').classList.add('show');
            updateSavedCount();
            
            // Afficher les dernières idées générées (si elles existent) ou l'écran d'accueil
            if (currentTrends.length > 0) {
                // Réafficher les dernières idées générées
                displayTrends(currentTrends);
            } else {
                // Écran d'accueil : inviter à générer
                displayTrendsWelcome();
            }
        }

        function displayTrendsWelcome() {
            document.getElementById('trendsContent').innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 4em; margin-bottom: 20px;">💡</div>
                    <h3 style="color: #333; margin-bottom: 10px;">Prêt·e à trouver l'inspiration ?</h3>
                    <p style="color: #666; margin-bottom: 25px;">Tithot va analyser ton profil et te proposer des idées personnalisées.</p>
                    <button onclick="generateNewTrends()" style="
                        padding: 15px 35px;
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        border: none;
                        border-radius: 30px;
                        font-size: 1.1em;
                        font-weight: 700;
                        cursor: pointer;
                        font-family: inherit;
                        box-shadow: 0 5px 20px rgba(102,126,234,0.4);
                        transition: all 0.3s;
                    " onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                        🔥 Générer des idées
                    </button>
                    <p style="color: #999; font-size: 0.85em; margin-top: 20px;">
                        Ou consulte tes <strong>⭐ Sauvegardées</strong> et <strong>📚 Historique</strong>
                    </p>
                </div>
            `;
        }

        async function generateNewTrends() {
            // Son de clic
            SoundSystem.playClick();
            
            // S'assurer qu'on est sur l'onglet "Nouvelles idées"
            switchTrendsTab('new');
            
            document.getElementById('trendsContent').innerHTML = `
                <div id="trendsTithot" style="text-align: center; padding: 30px;">
                    <dotlottie-wc src="https://lottie.host/eeab1c36-2031-4942-bf72-95b983b64077/hNKxxXfdmq.lottie" style="width: 200px; height: 200px; margin: 0 auto; display: block;" autoplay loop></dotlottie-wc>
                    <p style="color: #667eea; font-weight: 600; margin-top: 15px;">Tithot analyse les tendances...</p>
                </div>
            `;
            
            // Remonter en haut de la modal pour voir Tithot réfléchir
            const tithot = document.getElementById('trendsTithot');
            if (tithot) {
                tithot.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            const profile = UserProfile.get();
            const memory = ContentMemory.getSummaryForAI();
            
            let context = '';
            if (profile) {
                context += `Profil : ${profile.nom || 'Utilisateur'}
Domaine : ${profile.domaine || 'Non précisé'}
Piliers de contenu : ${profile.piliers?.join(', ') || 'Non précisés'}
Style : ${profile.style || 'Non précisé'}
Plateforme principale : ${currentState.platform}`;
            }
            
            if (memory) {
                context += `\n\nHistorique : ${memory.totalContents} contenus créés
Sujets récents : ${memory.recentTopics}
Dernier pilier utilisé : ${memory.lastPillar || 'aucun'}`;
            }

            const prompt = `Tu es Tithot, experte en tendances réseaux sociaux et personal branding.

${context}

MISSION : Génère 5 IDÉES DE CONTENU TENDANCE + 2 ANGLES PUBLICITAIRES personnalisés pour cet utilisateur.

Pour chaque idée de contenu, donne :
1. Un TITRE accrocheur (emoji + titre court)
2. Une DESCRIPTION en 1 phrase (pourquoi c'est tendance)
3. Le PROMPT exact à utiliser (la phrase que l'utilisateur peut copier-coller)

IMPORTANT :
- Propose des angles NOUVEAUX par rapport à l'historique
- Alterne les piliers de contenu
- Base-toi sur les vraies tendances 2025-2026 (IA, authenticité, micro-contenus, storytelling vulnérable, etc.)

Format ta réponse EXACTEMENT ainsi (pour faciliter le parsing) :

IDÉE 1
TITRE: [emoji] [titre]
DESC: [description courte]
PROMPT: [le prompt exact à copier]

IDÉE 2
...

(5 idées de contenu organique)

Puis ajoute :

PUB 1
TITRE: 💰 [titre de l'angle pub]
DESC: [pourquoi cet angle convertit bien]
PROMPT: [le prompt exact pour créer cette pub]
OBJECTIF: [conversion/trafic/leads/notoriete]

PUB 2
TITRE: 💰 [titre de l'angle pub]
DESC: [pourquoi cet angle convertit bien]
PROMPT: [le prompt exact pour créer cette pub]
OBJECTIF: [conversion/trafic/leads/notoriete]`;

            try {
                // Utiliser Perplexity pour les tendances (recherche web en temps réel)
                const response = await callPerplexity(prompt);
                const parsedTrends = parseTrendsResponse(response);
                saveTrendsToHistory(parsedTrends);
                displayTrends(parsedTrends);
                updateSavedCount();
            } catch (error) {
                document.getElementById('trendsContent').innerHTML = `<p style="color: #ff6b6b;">❌ Erreur : ${error.message}</p>`;
            }
        }

        // ==================== TRENDS HISTORY SYSTEM ====================
        const TrendsHistory = {
            STORAGE_KEY: 'sos_trends_history',
            SAVED_KEY: 'sos_saved_ideas',
            MAX_SAVED: 50,
            RETENTION_DAYS: 14,

            getHistory() {
                const data = localStorage.getItem(this.STORAGE_KEY);
                if (!data) return [];
                const history = JSON.parse(data);
                // Filtrer les entrées expirées
                const cutoff = Date.now() - (this.RETENTION_DAYS * 24 * 60 * 60 * 1000);
                return history.filter(h => new Date(h.generatedAt).getTime() > cutoff);
            },

            saveToHistory(trends) {
                const history = this.getHistory();
                const entry = {
                    id: `trends-${Date.now()}`,
                    generatedAt: new Date().toISOString(),
                    trends: trends
                };
                history.unshift(entry);
                // Garder max 20 sessions
                const trimmed = history.slice(0, 20);
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(trimmed));
            },

            getSavedIdeas() {
                const data = localStorage.getItem(this.SAVED_KEY);
                return data ? JSON.parse(data) : [];
            },

            saveIdea(idea) {
                const saved = this.getSavedIdeas();
                if (saved.length >= this.MAX_SAVED) {
                    showToast('⚠️ ' + t('toasts.max_ideas'));
                    return false;
                }
                if (saved.find(s => s.id === idea.id)) {
                    showToast('⭐ ' + t('toasts.already_saved'));
                    return false;
                }
                saved.unshift({
                    ...idea,
                    savedAt: new Date().toISOString()
                });
                localStorage.setItem(this.SAVED_KEY, JSON.stringify(saved));
                return true;
            },

            removeIdea(ideaId) {
                const saved = this.getSavedIdeas();
                const filtered = saved.filter(s => s.id !== ideaId);
                localStorage.setItem(this.SAVED_KEY, JSON.stringify(filtered));
            },

            removeHistorySession(sessionId) {
                const history = this.getHistory();
                const filtered = history.filter(h => h.id !== sessionId);
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(filtered));
            }
        };

        function parseTrendsResponse(response) {
            const trends = [];
            const baseId = Date.now();
            
            // Parser les idées de contenu
            const ideaBlocks = response.split(/IDÉE \d+/).filter(s => s.trim());
            ideaBlocks.forEach((idea, index) => {
                const titleMatch = idea.match(/TITRE:\s*(.+)/);
                const descMatch = idea.match(/DESC:\s*(.+)/);
                const promptMatch = idea.match(/PROMPT:\s*(.+)/);
                
                if (titleMatch && promptMatch) {
                    trends.push({
                        id: `idea-${baseId}-${index}-${Math.random().toString(36).substr(2, 5)}`,
                        type: 'idea',
                        title: titleMatch[1].trim(),
                        desc: descMatch ? descMatch[1].trim() : '',
                        prompt: promptMatch[1].trim()
                    });
                }
            });
            
            // Parser les pubs
            const pubBlocks = response.split(/PUB \d+/).filter(s => s.trim() && s.includes('OBJECTIF'));
            pubBlocks.forEach((pub, index) => {
                const titleMatch = pub.match(/TITRE:\s*(.+)/);
                const descMatch = pub.match(/DESC:\s*(.+)/);
                const promptMatch = pub.match(/PROMPT:\s*(.+)/);
                const objectiveMatch = pub.match(/OBJECTIF:\s*(.+)/);
                
                if (titleMatch && promptMatch) {
                    trends.push({
                        id: `pub-${baseId}-${index}-${Math.random().toString(36).substr(2, 5)}`,
                        type: 'pub',
                        title: titleMatch[1].trim(),
                        desc: descMatch ? descMatch[1].trim() : '',
                        prompt: promptMatch[1].trim(),
                        objective: objectiveMatch ? objectiveMatch[1].trim() : 'conversion'
                    });
                }
            });
            
            return trends;
        }

        function saveTrendsToHistory(trends) {
            if (trends && trends.length > 0) {
                TrendsHistory.saveToHistory(trends);
            }
        }

        // Variable globale pour stocker les trends courantes
        let currentTrends = [];

        function displayTrends(trends) {
            // Stocker les trends pour le bouton "Garder"
            currentTrends = trends;
            
            let html = '<p style="margin-bottom: 20px; color: #666;">Basées sur ton profil. Clique sur une idée ou sauvegarde-la pour plus tard !</p>';
            
            // Séparer idées et pubs
            const savedIds = TrendsHistory.getSavedIdeas().map(s => s.id);
            
            // Afficher toutes les trends avec leur index global
            const ideas = [];
            const pubs = [];
            
            trends.forEach((trend, index) => {
                if (trend.type === 'pub') {
                    pubs.push({ trend, index });
                } else {
                    ideas.push({ trend, index });
                }
            });
            
            if (ideas.length > 0) {
                html += '<h3 style="color: #667eea; margin-bottom: 15px;">🔥 Idées tendance</h3>';
                ideas.forEach(({ trend, index }) => {
                    const isSaved = savedIds.includes(trend.id);
                    html += renderTrendCard(trend, isSaved, index);
                });
            }
            
            if (pubs.length > 0) {
                html += '<h3 style="color: #f5576c; margin: 30px 0 15px;">💰 Angles publicitaires suggérés</h3>';
                pubs.forEach(({ trend, index }) => {
                    const isSaved = savedIds.includes(trend.id);
                    html += renderPubCard(trend, isSaved, index);
                });
            }
            
            if (trends.length === 0) {
                html = '<p style="text-align: center; color: #999; padding: 40px;">Aucune tendance générée. Clique sur "🔥 Nouvelles idées" pour en générer !</p>';
            }
            
            // Bouton pour régénérer
            html += `
                <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px dashed #e0e0e0;">
                    <button onclick="generateNewTrends()" style="
                        padding: 12px 25px;
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        border: none;
                        border-radius: 25px;
                        font-size: 0.95em;
                        font-weight: 600;
                        cursor: pointer;
                        font-family: inherit;
                        transition: all 0.3s;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        🔄 Générer de nouvelles idées
                    </button>
                </div>
            `;
            
            document.getElementById('trendsContent').innerHTML = html;
        }

        function renderTrendCard(idea, isSaved = false, index) {
            const escapedPrompt = idea.prompt.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            return `
                <div class="trend-card">
                    <div class="trend-title">${idea.title}</div>
                    <div class="trend-desc">${idea.desc}</div>
                    <div class="trend-actions">
                        <button class="trend-use-btn" onclick="event.stopPropagation(); useTrendPrompt('${escapedPrompt}')">
                            ✨ Utiliser cette idée
                        </button>
                        <button class="trend-save-btn ${isSaved ? 'saved' : ''}" 
                                onclick="event.stopPropagation(); saveIdeaByIndex(${index}, this)">
                            ${isSaved ? '⭐ Sauvegardée' : '⭐ Garder'}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderPubCard(pub, isSaved = false, index) {
            const escapedPrompt = pub.prompt.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            return `
                <div class="trend-card" style="border-left-color: #f5576c; background: linear-gradient(135deg, #fff5f7, #fef0f5);">
                    <div class="trend-title" style="color: #f5576c;">${pub.title}</div>
                    <div class="trend-desc">${pub.desc}</div>
                    <div class="trend-tags">
                        <span style="font-size: 0.75em; padding: 3px 10px; background: #f5576c; color: white; border-radius: 20px;">📢 PUB</span>
                        <span style="font-size: 0.75em; padding: 3px 10px; background: rgba(245,87,108,0.1); color: #f5576c; border-radius: 20px;">🎯 ${pub.objective}</span>
                    </div>
                    <div class="trend-actions">
                        <button class="trend-use-btn" style="background: linear-gradient(135deg, #f5576c, #f093fb);" 
                                onclick="event.stopPropagation(); usePubPrompt('${escapedPrompt}', '${pub.objective}')">
                            📢 Créer cette pub
                        </button>
                        <button class="trend-save-btn ${isSaved ? 'saved' : ''}" 
                                onclick="event.stopPropagation(); saveIdeaByIndex(${index}, this)">
                            ${isSaved ? '⭐ Sauvegardée' : '⭐ Garder'}
                        </button>
                    </div>
                </div>
            `;
        }

        function saveIdeaByIndex(index, btnElement) {
            const idea = currentTrends[index];
            if (!idea) {
                showToast('❌ ' + t('toasts.idea_not_found'));
                return;
            }
            
            if (TrendsHistory.saveIdea(idea)) {
                showToast('⭐ ' + t('toasts.idea_saved'));
                updateSavedCount();
                btnElement.classList.add('saved');
                btnElement.innerHTML = '⭐ Sauvegardée';
            }
        }

        // Ancienne fonction pour compatibilité (peut être supprimée plus tard)
        function saveIdeaById(ideaId, btnElement) {
            const idea = currentTrends.find(t => t.id === ideaId);
            if (!idea) {
                showToast('❌ ' + t('toasts.idea_not_found'));
                return;
            }
            
            if (TrendsHistory.saveIdea(idea)) {
                showToast('⭐ ' + t('toasts.idea_saved'));
                updateSavedCount();
                btnElement.classList.add('saved');
                btnElement.innerHTML = '⭐ Sauvegardée';
            }
        }

        function updateSavedCount() {
            const count = TrendsHistory.getSavedIdeas().length;
            const badge = document.getElementById('savedCount');
            if (badge) badge.textContent = count;
        }

        function switchTrendsTab(tab) {
            // Mettre à jour les onglets
            document.querySelectorAll('.trends-tab').forEach(t => t.classList.remove('active'));

            // Masquer tous les contenus
            document.getElementById('trendsContent').style.display = 'none';
            document.getElementById('savedIdeasContent').style.display = 'none';
            document.getElementById('historyContent').style.display = 'none';

            if (tab === 'new') {
                document.getElementById('tabNewIdeas').classList.add('active');
                document.getElementById('trendsContent').style.display = 'flex';
                document.getElementById('trendsContent').style.flexDirection = 'column';
                // Si pas d'idées, afficher l'écran d'accueil
                if (currentTrends.length === 0) {
                    displayTrendsWelcome();
                }
            } else if (tab === 'saved') {
                document.getElementById('tabSavedIdeas').classList.add('active');
                document.getElementById('savedIdeasContent').style.display = 'flex';
                document.getElementById('savedIdeasContent').style.flexDirection = 'column';
                displaySavedIdeas();
            } else if (tab === 'history') {
                document.getElementById('tabHistory').classList.add('active');
                document.getElementById('historyContent').style.display = 'flex';
                document.getElementById('historyContent').style.flexDirection = 'column';
                displayTrendsHistory();
            }
        }

        function displaySavedIdeas() {
            const saved = TrendsHistory.getSavedIdeas();
            let html = '';
            
            if (saved.length === 0) {
                html = '<p style="text-align: center; color: #999; padding: 40px;">Aucune idée sauvegardée. Clique sur "⭐ Garder" pour en ajouter !</p>';
            } else {
                html = `<p style="margin-bottom: 15px; color: #666;">${saved.length} idée${saved.length > 1 ? 's' : ''} sauvegardée${saved.length > 1 ? 's' : ''}</p>`;
                saved.forEach(idea => {
                    const escapedPrompt = idea.prompt.replace(/'/g, "\\'");
                    const dateStr = new Date(idea.savedAt).toLocaleDateString('fr-FR');
                    
                    if (idea.type === 'pub') {
                        html += `
                            <div class="trend-card saved-idea-card" style="border-left-color: #ffc107;">
                                <div class="trend-title" style="color: #f5576c;">${idea.title}</div>
                                <div class="trend-desc">${idea.desc}</div>
                                <div class="trend-tags">
                                    <span style="font-size: 0.75em; padding: 3px 10px; background: #f5576c; color: white; border-radius: 20px;">📢 PUB</span>
                                </div>
                                <div class="saved-idea-date">Sauvegardée le ${dateStr}</div>
                                <div class="trend-actions">
                                    <button class="trend-use-btn" style="background: linear-gradient(135deg, #f5576c, #f093fb);" 
                                            onclick="usePubPrompt('${escapedPrompt}', '${idea.objective || 'conversion'}')">
                                        📢 Utiliser
                                    </button>
                                    <button class="trend-delete-btn" onclick="removeSavedIdea('${idea.id}')">
                                        🗑️ Supprimer
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="trend-card saved-idea-card" style="border-left-color: #ffc107;">
                                <div class="trend-title">${idea.title}</div>
                                <div class="trend-desc">${idea.desc}</div>
                                <div class="saved-idea-date">Sauvegardée le ${dateStr}</div>
                                <div class="trend-actions">
                                    <button class="trend-use-btn" onclick="useTrendPrompt('${escapedPrompt}')">
                                        ✨ Utiliser
                                    </button>
                                    <button class="trend-delete-btn" onclick="removeSavedIdea('${idea.id}')">
                                        🗑️ Supprimer
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            document.getElementById('savedIdeasContent').innerHTML = html;
        }

        function displayTrendsHistory() {
            const history = TrendsHistory.getHistory();
            let html = '';
            
            if (history.length === 0) {
                html = '<p style="text-align: center; color: #999; padding: 40px;">Aucun historique. Les tendances générées apparaîtront ici pendant 14 jours.</p>';
            } else {
                history.forEach(session => {
                    const dateStr = new Date(session.generatedAt).toLocaleDateString('fr-FR', { 
                        weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' 
                    });
                    
                    html += `<div style="margin-bottom: 25px;">`;
                    html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="color: #667eea; font-size: 0.9em; margin: 0;">📅 ${dateStr}</h4>
                        <button class="trend-delete-btn" onclick="removeHistorySession('${session.id}')" title="Supprimer cette session">🗑️</button>
                    </div>`;
                    
                    session.trends.forEach(trend => {
                        const escapedPrompt = trend.prompt.replace(/'/g, "\\'");
                        if (trend.type === 'pub') {
                            html += `
                                <div class="trend-card" style="border-left-color: #f5576c; background: #fef7f8; padding: 12px;">
                                    <div class="trend-title" style="font-size: 0.95em; color: #f5576c;">${trend.title}</div>
                                    <div class="trend-actions" style="margin-top: 8px;">
                                        <button class="trend-use-btn" style="padding: 4px 12px; font-size: 0.75em; background: linear-gradient(135deg, #f5576c, #f093fb);" 
                                                onclick="usePubPrompt('${escapedPrompt}', '${trend.objective || 'conversion'}')">
                                            📢 Utiliser
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else {
                            html += `
                                <div class="trend-card" style="padding: 12px;">
                                    <div class="trend-title" style="font-size: 0.95em;">${trend.title}</div>
                                    <div class="trend-actions" style="margin-top: 8px;">
                                        <button class="trend-use-btn" style="padding: 4px 12px; font-size: 0.75em;" 
                                                onclick="useTrendPrompt('${escapedPrompt}')">
                                            ✨ Utiliser
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    html += `</div>`;
                });
            }
            
            document.getElementById('historyContent').innerHTML = html;
        }

        function removeSavedIdea(ideaId) {
            TrendsHistory.removeIdea(ideaId);
            showToast('🗑️ ' + t('toasts.idea_deleted'));
            updateSavedCount();
            displaySavedIdeas();
        }

        function removeHistorySession(sessionId) {
            TrendsHistory.removeHistorySession(sessionId);
            showToast('🗑️ ' + t('toasts.session_deleted'));
            displayTrendsHistory();
        }

        function useTrendPrompt(prompt) {
            document.getElementById('ideaInput').value = prompt;
            closeTrends();
            showToast('💡 ' + t('toasts.idea_copied'));
            // Scroll vers le champ
            document.getElementById('ideaSection').scrollIntoView({ behavior: 'smooth' });
        }

        function usePubPrompt(prompt, objective) {
            // Sélectionner le format PUB
            document.querySelectorAll('.format-chip').forEach(c => c.classList.remove('active'));
            const pubChip = document.querySelector('.format-chip[data-format="pub"]');
            if (pubChip) {
                pubChip.classList.add('active');
                currentState.format = 'pub';
                document.getElementById('pubOptionsSection').style.display = 'block';
            }
            
            // Sélectionner l'objectif correspondant
            const objectiveMap = { 'conversion': 'conversion', 'trafic': 'trafic', 'leads': 'leads', 'notoriete': 'notoriete', 'engagement': 'engagement' };
            const mappedObjective = objectiveMap[objective.toLowerCase()] || 'conversion';
            document.querySelectorAll('.pub-objective-chip').forEach(c => c.classList.remove('active'));
            const objChip = document.querySelector(`.pub-objective-chip[data-objective="${mappedObjective}"]`);
            if (objChip) {
                objChip.classList.add('active');
                currentState.pubObjective = mappedObjective;
            }
            
            // Mettre le prompt dans le champ
            document.getElementById('ideaInput').value = prompt;
            closeTrends();
            showToast('📢 ' + t('toasts.ad_angle_selected'));
            document.getElementById('ideaSection').scrollIntoView({ behavior: 'smooth' });
        }

        function closeTrends() {
            document.getElementById('trendsModal').classList.remove('show');
            // Reset sur l'onglet "Nouvelles idées"
            switchTrendsTab('new');
        }

        // ==================== GUIDE-MOI INTELLIGENT ====================
        async function guideMe() {
            const profile = UserProfile.get();
            const memory = ContentMemory.getSummaryForAI();
            const out = document.getElementById('outputContent');
            out.innerHTML = `<div class="output-text" id="streamOutput"></div>`;
            document.getElementById('actionButtons').style.display = 'none';
            
            // Déterminer le pilier à privilégier
            const nextPillar = profile?.piliers ? ContentMemory.getNextPillar(profile.piliers) : null;
            
            // Contexte utilisateur OU client agence
            let context = '';
            const clientProfile = AgencySystem.getClientProfileForAI();
            
            if (clientProfile) {
                // Mode Agence : utiliser le profil client
                context = `🏢 MODE AGENCE - Génération pour un client :

${clientProfile}`;
            } else if (profile?.nom) {
                context = `Tu parles à ${profile.nom}.
Domaine : ${profile.domaine || 'Non précisé'}
Piliers de contenu : ${profile.piliers?.join(', ') || 'Non précisés'}
Style : ${profile.style || 'Non précisé'}
Objectif : ${profile.objectif || 'Non précisé'}`;
            }
            
            let memoryContext = '';
            if (memory && memory.totalContents > 0) {
                memoryContext = `

📊 HISTORIQUE (pour proposer du NOUVEAU) :
- ${memory.totalContents} contenus déjà créés
- Sujets récents : ${memory.recentTopics}
- Pilier le plus utilisé : ${memory.pillarStats}
- Dernier pilier : ${memory.lastPillar}

⚡ IMPORTANT : Propose des idées sur des angles NOUVEAUX, pas déjà abordés !`;
            }

            const prompt = `${context}${memoryContext}

Tu es Tithot, coach créative en personal branding. L'utilisateur ne sait pas quoi poster.

${nextPillar ? `🎯 PILIER SUGGÉRÉ : "${nextPillar}" (à privilégier car moins utilisé récemment)` : ''}

Propose 5 IDÉES DE CONTENU personnalisées et NOUVELLES.

Pour chaque idée :
1. 🎯 Le sujet/angle (en gras) - INDIQUE LE PILIER concerné
2. 📖 La structure narrative recommandée
3. 🎬 Le format idéal
4. 💡 L'accroche possible

${memoryContext ? 'ÉVITE les sujets déjà traités récemment !' : ''}

Numérote : **IDÉE 1**, **IDÉE 2**, etc.`;

            try {
                await callAIStream(prompt, document.getElementById('streamOutput'));
                addIdeaButtons();
            } catch (e) {
                out.innerHTML = `<div class="output-placeholder"><p>❌ ${e.message}</p></div>`;
            }
        }

        function addIdeaButtons() {
            const out = document.getElementById('streamOutput');
            currentState.ideasContent = out.innerText;
            const div = document.createElement('div');
            div.style.cssText = 'margin-top: 25px; padding-top: 20px; border-top: 2px dashed #e0e0e0;';
            div.innerHTML = `
                <p style="font-weight: 600; color: #f5576c; margin-bottom: 15px;">🚀 Développer une idée en contenu complet :</p>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <button class="idea-btn" onclick="developIdea(1)">📝 Idée 1</button>
                    <button class="idea-btn" onclick="developIdea(2)">📝 Idée 2</button>
                    <button class="idea-btn" onclick="developIdea(3)">📝 Idée 3</button>
                    <button class="idea-btn" onclick="developIdea(4)">📝 Idée 4</button>
                    <button class="idea-btn" onclick="developIdea(5)">📝 Idée 5</button>
                </div>`;
            out.appendChild(div);
        }

        async function developIdea(n) {
            const profile = UserProfile.get();
            const out = document.getElementById('outputContent');
            out.innerHTML = `<div class="output-text" id="streamOutput"></div>`;
            

            const prompt = `Tu avais proposé ces idées :
${currentState.ideasContent}

Développe l'IDÉE ${n} en contenu COMPLET.

## 📝 Texte du post
[Texte complet avec la structure narrative appropriée]

## 💬 Légende
[Légende courte et accrocheuse]

## #️⃣ Hashtags
[10-15 hashtags pertinents]

${profile ? `Adapte au style ${profile.style}, plateforme ${currentState.platform}` : ''}`;

            try {
                await callAIStream(prompt, document.getElementById('streamOutput'));
                currentState.generatedContent = document.getElementById('streamOutput')?.innerText || '';

                // Sauvegarder dans la mémoire
                const profile = UserProfile.get();
                ContentMemory.addContent(currentState.generatedContent, currentState.currentPillar, currentState.platform, currentState.format);
                ProgressionSystem.trackContent(currentState.platform, currentState.format);
                LastContentManager.save(currentState.generatedContent, currentState.platform, currentState.format, currentState.structure);
                if (AgencySystem.isAgencyMode()) {
                    AgencySystem.trackContent(currentState.platform, currentState.format, currentState.structure, currentState.generatedContent);
                }
                updateMemoryIndicator();

                document.getElementById('actionButtons').style.display = 'flex'; document.getElementById('visualSection').style.display = 'block';
                displayTipsWidget(); // Afficher les bonnes pratiques
            } catch (e) {
                out.innerHTML = `<div class="output-placeholder"><p>❌ ${e.message}</p></div>`;
            }
        }

        // ==================== GÉNÉRATION CONTENU ====================
        async function generateContent() {
            const idea = document.getElementById('ideaInput').value.trim();
            if (!idea) { showToast('💡 ' + t('toasts.idea_required')); return; }

            // Vérifier la limite freemium
            if (!FreemiumSystem.canGeneratePost()) {
                FreemiumSystem.showPaywall('posts');
                return;
            }

            // Son de clic
            SoundSystem.playClick();

            currentState.idea = idea;
            const btn = document.getElementById('generateBtn');
            btn.disabled = true; btn.innerHTML = '⏳ Génération...';
            
            const out = document.getElementById('outputContent');
            out.innerHTML = `<div class="output-text" id="streamOutput"></div>`;

            const profile = UserProfile.get();
            const struct = STRUCTURES[currentState.structure];
            const fmt = FORMATS[currentState.format] || { name: 'Publicité', length: 'court et percutant', specifics: 'accroche + corps + CTA' };
            const plat = PLATFORMS[currentState.platform];
            
            // Contexte utilisateur OU client agence
            let ctx = '';
            const clientProfile = AgencySystem.getClientProfileForAI();

            // Variable pour stocker les instructions de voix (sera ajoutée à la FIN du prompt)
            let voiceFinalInstructions = '';

            if (clientProfile) {
                // Mode Agence : utiliser le profil client
                ctx = `🏢 MODE AGENCE - Génération pour un client :

${clientProfile}`;
            } else if (profile?.nom) {
                // Construire un contexte de base pour l'utilisateur principal
                // Traduire les valeurs
                const getStyleLabel = (val) => {
                    const styles = { inspirant: 'Inspirant', educatif: 'Éducatif', authentique: 'Authentique', humour: 'Humour', provocateur: 'Provocateur', minimaliste: 'Minimaliste', storytelling: 'Storytelling', emotionnel: 'Émotionnel' };
                    return styles[val] || val || 'Non défini';
                };
                const getObjectifLabel = (val) => {
                    const obj = { notoriete: 'Notoriété', communaute: 'Communauté', ventes: 'Ventes', autorite: 'Autorité', reseau: 'Réseautage', expression: 'Expression personnelle', recrutement: 'Recrutement', leads: 'Génération de leads' };
                    return obj[val] || val || 'Non défini';
                };

                // Déterminer le ton à utiliser (override ou profil)
                const effectiveTone = (currentState.tone && currentState.tone !== 'default')
                    ? currentState.tone
                    : profile.style;
                const toneSource = (currentState.tone && currentState.tone !== 'default')
                    ? ' (⚡ override pour ce contenu)'
                    : ' (profil par défaut)';

                ctx = `👤 PROFIL DE L'AUTEUR :
NOM : ${profile.nom}
DOMAINE/NICHE : ${profile.domaine || 'Non précisé'}
MESSAGE UNIQUE : ${profile.messageUnique || 'Non précisé'}
PILIERS DE CONTENU : ${(profile.piliers || []).join(', ') || 'Non précisés'}
STYLE DE COMMUNICATION : ${getStyleLabel(effectiveTone)}${toneSource}
OBJECTIF PRINCIPAL : ${getObjectifLabel(profile.objectif)}
PUBLIC CIBLE : ${profile.audience || 'Non précisé'}
PLATEFORMES : ${(profile.plateformes || []).join(', ') || 'Non précisées'}`;

                // PRÉPARER les instructions de voix pour les ajouter À LA FIN du prompt
                if (profile.voiceProfile) {
                    const vp = profile.voiceProfile;
                    const voiceSamples = getVoiceSamples ? getVoiceSamples() : [];

                    let samplesSection = '';
                    if (voiceSamples.length > 0) {
                        // Inclure plus d'échantillons (5) avec plus de caractères (800)
                        samplesSection = `

📝 TEXTES ORIGINAUX DE L'AUTEUR - IMITE CE STYLE EXACTEMENT :
${voiceSamples.slice(0, 5).map((s, i) => `
═══ EXEMPLE ${i+1} ═══
${s.substring(0, 800)}
`).join('\n')}`;
                    }

                    voiceFinalInstructions = `

╔══════════════════════════════════════════════════════════════════════╗
║  🎤🎤🎤 INSTRUCTION FINALE PRIORITAIRE : PROFIL DE VOIX 🎤🎤🎤      ║
╚══════════════════════════════════════════════════════════════════════╝

⚠️⚠️⚠️ STOP ! AVANT DE RÉPONDRE, RELIS CETTE SECTION ⚠️⚠️⚠️

Tu DOIS écrire EXACTEMENT comme cette personne écrit.
PAS de style IA générique. PAS de formules classiques.
IMITE son style UNIQUE.

🎭 ANALYSE DE SA VOIX UNIQUE :
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
• TON : ${vp.ton || 'Non défini'}
• PHRASES : ${vp.longueurPhrases || 'Variable'}
• EXPRESSIONS FAVORITES : ${vp.expressions || 'Aucune identifiée'}
• PONCTUATION/ÉMOJIS : ${vp.ponctuation || 'Standard'}
• STYLE NARRATIF : ${vp.styleNarratif || 'Non défini'}
• VOCABULAIRE : ${vp.vocabulaire || 'Non analysé'}
• SA SIGNATURE : ${vp.signature || 'Non défini'}

🎯 COMMENT REPRODUIRE SA VOIX :
${vp.conseils || 'Écrire de manière naturelle et authentique'}
${samplesSection}

❌ INTERDIT :
- Écrire de manière générique ou corporate
- Utiliser "En effet", "Ainsi", "Il est important de"
- Sonner comme un assistant IA
- Utiliser des formules bateau

✅ OBLIGATOIRE :
- Imiter son ton EXACT (${vp.ton || 'naturel'})
- Utiliser SES tournures de phrases
- Respecter SON rythme et SA ponctuation
- Capturer SON énergie et SA personnalité

🚨 RAPPEL : Le style de l'auteur est LA PRIORITÉ ABSOLUE.
Tout le contenu doit sonner comme si l'auteur l'avait écrit lui-même.`;
                }
            }

            // Instruction Tu/Vous basée sur les préférences utilisateur
            const formalStyle = profile?.formalStyle || 'tu';
            const styleInstruction = formalStyle === 'vous'
                ? `\n\n⚠️ VOUVOIEMENT OBLIGATOIRE : Utilise "vous" pour t'adresser au lecteur. Conjugue à la 2ème personne du pluriel. Reste chaleureux mais formel.`
                : `\n\n⚠️ TUTOIEMENT OBLIGATOIRE : Utilise "tu" pour t'adresser au lecteur. Conjugue à la 2ème personne du singulier. Ton décontracté et proche.`;

            let prompt;

            // Si c'est une PUB, utiliser un prompt spécial
            if (currentState.format === 'pub') {
                const pubPlatformNames = {
                    meta: 'Meta Ads (Facebook & Instagram)',
                    linkedin: 'LinkedIn Ads',
                    tiktok: 'TikTok Ads',
                    google: 'Google Ads'
                };
                const pubObjectiveNames = {
                    conversion: 'Conversion (vente, inscription)',
                    trafic: 'Trafic (clics vers site)',
                    notoriete: 'Notoriété (visibilité marque)',
                    engagement: 'Engagement (likes, commentaires, partages)',
                    leads: 'Génération de leads (formulaire)'
                };
                
                prompt = `${ctx}

📢 CRÉATION DE PUBLICITÉ

SUJET/OFFRE : "${currentState.idea}"

- Plateforme publicitaire : ${pubPlatformNames[currentState.pubPlatform] || 'Meta Ads'}
- Objectif : ${pubObjectiveNames[currentState.pubObjective] || 'Conversion'}
- Structure narrative : ${struct.name} (${struct.prompt})

Génère une publicité COMPLÈTE avec :

1. 🎯 **HOOK** (accroche - 1-2 phrases max, ultra percutante)
   Doit capter l'attention en 3 secondes

2. 💬 **CORPS** (développement - 3-5 lignes)
   Intérêt + Désir selon la structure ${struct.name}

3. 👉 **CTA** (appel à l'action - 1 phrase)
   Clair, urgent, aligné avec l'objectif ${pubObjectiveNames[currentState.pubObjective]}

---

🔄 **VARIANTE A/B #1** (angle douleur)
Hook alternatif + CTA

🔄 **VARIANTE A/B #2** (angle résultat)
Hook alternatif + CTA

🔄 **VARIANTE A/B #3** (angle curiosité)
Hook alternatif + CTA

---

🎨 **VISUEL SUGGÉRÉ**
Un prompt Midjourney adapté au format ${pubPlatformNames[currentState.pubPlatform]} :
- Format carré (1:1) pour Meta/LinkedIn
- Format vertical (9:16) pour TikTok/Stories
- Style professionnel et accrocheur${styleInstruction}`;
            } else {
                // Génération normale (non-pub)
                prompt = `${ctx}

SUJET : "${currentState.idea}"

- Structure : ${struct.name} (${struct.prompt})
- Format : ${fmt.name} (${fmt.length}, ${fmt.specifics})
- Plateforme : ${plat.name} (ton ${plat.tone})

${getPlatformRulesForPrompt(currentState.platform, currentState.format)}

RÈGLES DE RÉDACTION GÉNÉRALES :

1. **HOOK** : Les 2 premières lignes doivent capter l'attention immédiatement (curiosité, émotion, paradoxe)

2. **CAS D'USAGE CONCRET** : Inclus au moins UN exemple concret et visuel que le lecteur peut s'imaginer vivre (ex: "le moment où tu vois...", "imagine quand tu...", "tu sais, ce feeling quand...")

3. **CTA + QUESTION D'ENGAGEMENT** : Termine TOUJOURS par :
   - Une question ouverte qui invite à partager son expérience OU
   - Un appel à l'action clair (commenter, partager, sauvegarder)

4. **RYTHME** : Varie la longueur des phrases. Phrases courtes pour l'impact. Plus longues pour le développement.
${styleInstruction}

Crée le contenu COMPLET prêt à publier en respectant STRICTEMENT les contraintes de la plateforme ci-dessus.`;
            }

            // 📖 MODE GHOSTWRITER (Anecdote) - Si anecdote remplie, appliquer le prompt storytelling
            const anecdote = getAnecdote();
            if (anecdote && anecdote.length > 20) {
                prompt += `

═══════════════════════════════════════════════════════════════
📖 MODE STORYTELLING ANECDOTE (GHOSTWRITER)
═══════════════════════════════════════════════════════════════

${GHOSTWRITER_PROMPT}

ADAPTATION AU FORMAT/PLATEFORME :
- Format demandé : ${fmt.name}
- Plateforme : ${plat.name}
- Adapte la longueur et le ton selon ces paramètres.
- Pour un carousel : découpe l'histoire en slides (1 idée par slide)
- Pour un reel/TikTok : écris un script parlé, dynamique
- Pour une story : version ultra-courte avec hook fort

ANECDOTE FOURNIE PAR L'UTILISATEUR :
"""
${anecdote}
"""

INSTRUCTIONS :
1. Transforme cette anecdote en post ${fmt.name} pour ${plat.name}
2. Applique la structure en 5 parties (Accroche, Développement, Résolution, Morale, Conclusion)
3. Utilise les 6 techniques de storytelling (Conflit, Ressentis, Dialogues, Détails, Surprise, Lien personnel)
4. Respecte l'anecdote fournie - n'invente pas une nouvelle histoire
5. Enrichis avec du contexte et des détails percutants

`;
            }

            // 🎯 MODE 20 JOURS STRATÉGIQUES - Ajouter les instructions spécifiques
            const strategyDaysObj = currentState.strategyType === 'expertise' ? STRATEGY_DAYS_EXPERTISE : STRATEGY_DAYS_VENDRE;
            if (currentState.strategyMode && currentState.strategyDay && strategyDaysObj[currentState.strategyDay]) {
                const dayData = strategyDaysObj[currentState.strategyDay];

                // Mode Expertise (Thought Leadership)
                if (currentState.strategyType === 'expertise') {
                    prompt += `

═══════════════════════════════════════════════════════════════
🧠 MODE THOUGHT LEADERSHIP — JOUR ${currentState.strategyDay}/20
═══════════════════════════════════════════════════════════════

📚 FRAMEWORK : ${dayData.framework || 'Contenu expert'}
📌 THÉMATIQUE DU JOUR : ${dayData.title}
🎯 OBJECTIF : ${dayData.objective}

📝 QUESTIONS D'EXTRACTION (l'utilisateur a répondu dans son texte) :
${dayData.questions.map((q, i) => `${i+1}. ${q}`).join('\n')}

${dayData.structure ? `✍️ STRUCTURE À SUIVRE :
${dayData.structure}
` : ''}

CONSIGNES SPÉCIALES POUR LE THOUGHT LEADERSHIP :
- Le contenu doit être ASSEZ PROFOND pour être cité par les IA (Perplexity, ChatGPT)
- Utilise des données, exemples précis, noms de frameworks reconnus
- Le ton est expert mais accessible
- Évite le contenu générique qu'on trouve partout
- L'utilisateur doit être reconnu comme UNE RÉFÉRENCE sur ce sujet
- Adapte au format (${fmt.name}) et à la plateforme (${plat.name})
- Crée un contenu qui sera bookmarké et partagé

`;
                } else {
                    // Mode Vendre (conversion)
                    prompt += `

═══════════════════════════════════════════════════════════════
🎯 MODE 20 JOURS STRATÉGIQUES — JOUR ${currentState.strategyDay}/20
═══════════════════════════════════════════════════════════════

📌 THÉMATIQUE DU JOUR : ${dayData.title}
🎯 OBJECTIF : ${dayData.objective}

INSTRUCTIONS SPÉCIALES POUR CE TYPE DE CONTENU :
- L'utilisateur a rempli un template avec ses informations personnelles
- Utilise TOUTES les informations fournies comme matière première pour créer le post
- Adapte la structure au type de contenu "${dayData.title}"
- L'objectif "${dayData.objective}" doit transparaître dans le post
- Crée un contenu authentique basé sur l'expérience réelle partagée
- Si l'utilisateur a mentionné "Mon offre", intègre-la subtilement à la fin
- Garde le format (${fmt.name}) et la plateforme (${plat.name}) en tête

`;
                }
            }

            // Ajouter les instructions du framework si sélectionné
            const frameworkInstructions = FrameworkSystem.getPromptInstructions();
            if (frameworkInstructions) {
                prompt += frameworkInstructions;
                // Tracker l'usage du framework
                if (FrameworkSystem.selectedFramework) {
                    FrameworkSystem.incrementUsage(FrameworkSystem.selectedFramework);
                }
            }

            // 🎤 AJOUTER LES INSTRUCTIONS DE VOIX À LA FIN (priorité maximale)
            if (voiceFinalInstructions) {
                prompt += voiceFinalInstructions;
            }

            // 🌐 Ajouter l'instruction de langue AU DÉBUT
            const currentLang = I18N?.getLanguage() || 'fr';
            if (currentLang === 'en') {
                prompt = `🌐 IMPORTANT: Generate ALL content in ENGLISH. Write naturally in English, not translated French.\n\n` + prompt;
            } else {
                prompt = `🌐 IMPORTANT: Génère TOUT le contenu en FRANÇAIS.\n\n` + prompt;
            }

            try {
                await callAIStream(prompt, document.getElementById('streamOutput'));
                currentState.generatedContent = document.getElementById('streamOutput')?.innerText || '';
                
                // Ajouter le badge de fidélité voix et feedback si profil voix actif
                const streamOutput = document.getElementById('streamOutput');
                if (streamOutput) {
                    const badge = getVoiceFidelityBadge();
                    const feedback = getVoiceFeedback();
                    if (badge) {
                        streamOutput.innerHTML = badge + streamOutput.innerHTML + feedback;
                    }
                }
                
                // Sauvegarder dans la mémoire
                ContentMemory.addContent(currentState.generatedContent, currentState.currentPillar, currentState.platform, currentState.format);
                ProgressionSystem.trackContent(currentState.platform, currentState.format);
                LastContentManager.save(currentState.generatedContent, currentState.platform, currentState.format, currentState.structure);
                if (AgencySystem.isAgencyMode()) {
                    AgencySystem.trackContent(currentState.platform, currentState.format, currentState.structure, currentState.generatedContent);
                }
                updateMemoryIndicator();

                // 📊 Analytics Supabase
                const contentType = currentState.format === 'pub' ? 'pub' : 'organic';
                Analytics.trackContent(currentState.structure, currentState.platform, currentState.format, currentState.currentPillar, contentType);

                // 📊 Incrémenter le compteur freemium
                FreemiumSystem.incrementPosts();

                document.getElementById('actionButtons').style.display = 'flex'; document.getElementById('visualSection').style.display = 'block';
                displayTipsWidget(); // Afficher les bonnes pratiques
            } catch (e) {
                out.innerHTML = `<div class="output-placeholder"><p>❌ ${e.message}</p></div>`;
            }

            btn.disabled = false; btn.innerHTML = '🪝 1. Générer des accroches';
        }

        function regenerateContent() {
            // Si un hook est sélectionné, regénérer avec le brief actuel + hook
            if (currentState.selectedHook) {
                generateContentWithHook();
            } else {
                // Sinon, revenir à l'étape des hooks pour regénérer depuis le début
                showHooksSection();
            }
        }
        function copyContent() { navigator.clipboard.writeText(currentState.generatedContent).then(() => showToast('✅ ' + t('toasts.copied'))); }

        function auditGeneratedContent() {
            if (!currentState.generatedContent) {
                showToast('❌ Aucun contenu à auditer');
                return;
            }
            // Ouvrir le module d'audit avec le contenu pré-rempli
            if (typeof AuditModule !== 'undefined') {
                AuditModule.openAuditModal();
                // Passer à l'onglet Posts et pré-remplir
                setTimeout(() => {
                    AuditModule.switchTab('posts');
                    // Ajouter le contenu généré comme post à auditer
                    AuditModule.addPost();
                    const posts = document.querySelectorAll('.post-textarea');
                    if (posts.length > 0) {
                        const lastPost = posts[posts.length - 1];
                        lastPost.value = currentState.generatedContent;
                        lastPost.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }, 100);
                showToast('🔍 Analyse ton contenu avant de publier !');
            } else {
                showToast('❌ Module d\'audit non disponible');
            }
        }

        // ==================== VOICE FIDELITY BADGE ====================
        function getVoiceFidelityBadge() {
            const profile = UserProfile.get();
            if (!profile?.voiceProfile) return '';
            
            const score = profile.voiceProfile.fidelityScore || 85;
            return `
                <div class="voice-fidelity-badge">
                    <span>🎤</span>
                    <span class="label">Fidélité voix :</span>
                    <span class="score">${score}%</span>
                </div>
            `;
        }
        
        function getVoiceFeedback() {
            const profile = UserProfile.get();
            if (!profile?.voiceProfile) return '';
            
            return `
                <div class="voice-feedback" id="voiceFeedback">
                    <div class="voice-feedback-question">🎯 Ce contenu te ressemble ?</div>
                    <div class="voice-feedback-buttons">
                        <button class="voice-feedback-btn yes" onclick="submitVoiceFeedback(true)">👍 Oui !</button>
                        <button class="voice-feedback-btn no" onclick="submitVoiceFeedback(false)">👎 Pas vraiment</button>
                    </div>
                    <div class="voice-feedback-thanks" id="feedbackThanks">✅ Merci ! Tithot s'améliore.</div>
                </div>
            `;
        }
        
        function submitVoiceFeedback(isPositive) {
            const feedbackDiv = document.getElementById('voiceFeedback');
            const thanksDiv = document.getElementById('feedbackThanks');
            const buttonsDiv = feedbackDiv.querySelector('.voice-feedback-buttons');
            const questionDiv = feedbackDiv.querySelector('.voice-feedback-question');
            
            // Sauvegarder le feedback
            const profile = UserProfile.get();
            if (profile?.voiceProfile) {
                if (!profile.voiceProfile.feedbackHistory) {
                    profile.voiceProfile.feedbackHistory = { positive: 0, negative: 0 };
                }
                
                if (isPositive) {
                    profile.voiceProfile.feedbackHistory.positive++;
                    // Augmenter le score de fidélité si beaucoup de feedback positif
                    const total = profile.voiceProfile.feedbackHistory.positive + profile.voiceProfile.feedbackHistory.negative;
                    const ratio = profile.voiceProfile.feedbackHistory.positive / total;
                    profile.voiceProfile.fidelityScore = Math.min(98, Math.round(70 + (ratio * 28)));
                } else {
                    profile.voiceProfile.feedbackHistory.negative++;
                    // Suggérer d'ajouter plus de textes
                    showToast('💡 ' + t('toasts.add_more_texts_voice'));
                }
                
                UserProfile.save(profile);
            }
            
            // Animation
            buttonsDiv.style.display = 'none';
            questionDiv.style.display = 'none';
            thanksDiv.style.display = 'block';
        }

        // ==================== VARIANTES ====================
        async function generateVariantes() {
            if (!currentState.generatedContent) { showToast('❌ ' + t('toasts.generate_first_short')); return; }

            const outputContent = document.getElementById('outputContent');

            // Sauvegarder le contenu actuel
            const currentHTML = outputContent.innerHTML;

            // Créer un nouveau div pour les variantes
            const variantesDiv = document.createElement('div');
            variantesDiv.id = 'variantesStreamOutput';
            variantesDiv.className = 'output-text';
            variantesDiv.style.cssText = 'margin-top: 30px; padding-top: 25px; border-top: 3px dashed #f093fb;';

            // Ajouter le div des variantes au contenu existant
            outputContent.appendChild(variantesDiv);

            // Scroll vers le bas
            outputContent.scrollTop = outputContent.scrollHeight;

            const prompt = `TEXTE ORIGINAL :
"${currentState.generatedContent.substring(0, 800)}"

Propose 3 VARIANTES du texte ci-dessus :

## 🎭 VARIANTE 1 : Ton INSPIRANT
[Réécris avec plus d'émotion et d'inspiration]

## 🎯 VARIANTE 2 : Ton DIRECT/PUNCHY
[Réécris de manière plus percutante, sans détour]

## 😄 VARIANTE 3 : Ton STORYTELLING
[Réécris comme une histoire personnelle]

Génère les 3 variantes complètes.`;

            try {
                await callAIStream(prompt, variantesDiv);
                currentState.generatedContent += '\n\n' + variantesDiv.innerText;
                showToast('✅ 3 variantes générées !');
            } catch (e) {
                variantesDiv.innerHTML = `<p style="color: #e74c3c;">❌ ${e.message}</p>`;
            }
        }

        // ==================== MIDJOURNEY ====================
        async function generateMidjourney(btn) {
            if (!currentState.generatedContent) { showToast('❌ ' + t('toasts.generate_first_short')); return; }
            
            // Effet visuel sur le bouton
            if (btn) showSentEffect(btn);
            
            const outputContent = document.getElementById('outputContent');
            const streamOutput = document.getElementById('streamOutput');
            
            const mjDiv = document.createElement('div');
            mjDiv.className = 'output-text';
            mjDiv.style.cssText = 'margin-top: 30px; padding-top: 25px; border-top: 3px dashed #5865F2;';
            mjDiv.innerHTML = '<h2 style="color: #5865F2;">🎨 Prompts Midjourney</h2>';
            streamOutput.appendChild(mjDiv);
            outputContent.scrollTop = outputContent.scrollHeight;
            
            const prompt = `Contenu : "${currentState.generatedContent.substring(0, 500)}..."

Génère 3 CONCEPTS VISUELS pour Midjourney, avec 2 VARIATIONS chacun.

Pour chaque concept :
1. Décris le style visuel
2. Donne le PROMPT PRINCIPAL en anglais (bloc de code)
3. Donne 2 VARIATIONS du même concept (ambiances différentes)

---

## 🖼️ CONCEPT 1 : [Style - ex: Photo corporate moderne]

**Prompt principal :**
\`\`\`
[prompt détaillé avec --ar 1:1 --v 6]
\`\`\`

**Variation A - Ambiance lumineuse/optimiste :**
\`\`\`
[même concept, tons clairs, lumière naturelle]
\`\`\`

**Variation B - Ambiance dramatique/contrastée :**
\`\`\`
[même concept, clair-obscur, tons profonds]
\`\`\`

---

## 🖼️ CONCEPT 2 : [Style - ex: Illustration flat design]

**Prompt principal :**
\`\`\`
[prompt]
\`\`\`

**Variation A - Couleurs chaudes :**
\`\`\`
[version orange, rouge, jaune]
\`\`\`

**Variation B - Couleurs froides :**
\`\`\`
[version bleu, violet, vert]
\`\`\`

---

## 🖼️ CONCEPT 3 : [Style - ex: 3D render minimaliste]

**Prompt principal :**
\`\`\`
[prompt]
\`\`\`

**Variation A - Vue rapprochée/détail :**
\`\`\`
[close-up, macro]
\`\`\`

**Variation B - Vue large/contexte :**
\`\`\`
[wide shot, environnement]
\`\`\`

Inclus toujours les paramètres Midjourney (--ar, --v 6, --style raw si pertinent).`;

            try {
                await callAIStream(prompt, mjDiv);
                addCopyButton(mjDiv, '📋 Copier les 9 prompts Midjourney');
            } catch (e) { mjDiv.innerHTML += '<p>❌ ' + e.message + '</p>'; }
        }

        // ==================== DALL-E ====================
        async function generateDalle(btn) {
            if (!currentState.generatedContent) { showToast('❌ ' + t('toasts.generate_first_short')); return; }
            
            // Effet visuel sur le bouton
            if (btn) showSentEffect(btn);
            
            const outputContent = document.getElementById('outputContent');
            const streamOutput = document.getElementById('streamOutput');
            
            const dalleDiv = document.createElement('div');
            dalleDiv.className = 'output-text';
            dalleDiv.style.cssText = 'margin-top: 30px; padding-top: 25px; border-top: 3px dashed #10a37f;';
            dalleDiv.innerHTML = '<h2 style="color: #10a37f;">🤖 Prompts DALL-E (ChatGPT)</h2>';
            streamOutput.appendChild(dalleDiv);
            outputContent.scrollTop = outputContent.scrollHeight;
            
            const prompt = `Contenu : "${currentState.generatedContent.substring(0, 500)}..."

Génère 3 CONCEPTS VISUELS pour DALL-E (ChatGPT), avec 2 VARIATIONS chacun.

Les prompts DALL-E doivent être descriptifs et clairs (pas de paramètres techniques).

---

## 🤖 CONCEPT 1 : [Style - ex: Photo réaliste]

**Prompt principal :**
\`\`\`
[description détaillée de l'image souhaitée]
\`\`\`

**Variation A - Version épurée/minimaliste :**
\`\`\`
[même concept avec fond simple, moins d'éléments]
\`\`\`

**Variation B - Version riche/détaillée :**
\`\`\`
[même concept avec plus de détails, environnement complet]
\`\`\`

---

## 🤖 CONCEPT 2 : [Style - ex: Illustration digitale]

**Prompt principal :**
\`\`\`
[description]
\`\`\`

**Variation A - Style cartoon/friendly :**
\`\`\`
[version plus ludique et accessible]
\`\`\`

**Variation B - Style professionnel/corporate :**
\`\`\`
[version plus sérieuse et business]
\`\`\`

---

## 🤖 CONCEPT 3 : [Style - ex: Concept art]

**Prompt principal :**
\`\`\`
[description]
\`\`\`

**Variation A - Palette de jour :**
\`\`\`
[lumière naturelle, couleurs vives]
\`\`\`

**Variation B - Palette de nuit/soirée :**
\`\`\`
[éclairage artificiel, ambiance cosy ou mystérieuse]
\`\`\`

Précise toujours le style artistique souhaité dans chaque prompt.`;

            try {
                await callAIStream(prompt, dalleDiv);
                addCopyButton(dalleDiv, '📋 Copier les 9 prompts DALL-E');
            } catch (e) { dalleDiv.innerHTML += '<p>❌ ' + e.message + '</p>'; }
        }

        // ==================== CANVA ====================
        async function generateCanva(btn) {
            if (!currentState.generatedContent) { showToast('❌ ' + t('toasts.generate_first_short')); return; }
            
            // Effet visuel sur le bouton
            if (btn) showSentEffect(btn);
            
            const outputContent = document.getElementById('outputContent');
            const streamOutput = document.getElementById('streamOutput');
            
            const canvaDiv = document.createElement('div');
            canvaDiv.className = 'output-text';
            canvaDiv.style.cssText = 'margin-top: 30px; padding-top: 25px; border-top: 3px dashed #00C4CC;';
            canvaDiv.innerHTML = '<h2 style="color: #7B2D8E;">🎬 Suggestions visuelles Canva</h2>';
            streamOutput.appendChild(canvaDiv);
            outputContent.scrollTop = outputContent.scrollHeight;
            
            const prompt = `Contenu : "${currentState.generatedContent.substring(0, 500)}..."

Génère 3 SUGGESTIONS DE VISUELS à créer sur Canva avec ses propres photos/vidéos.

Pour chaque suggestion :
1. **Type de visuel** (carousel, post simple, reel, story)
2. **Composition** : comment organiser les éléments
3. **B-roll / Photos perso** : quoi filmer ou photographier soi-même
4. **Éléments Canva** : templates, formes, icônes, typographies suggérées
5. **Texte à intégrer** : les phrases clés du contenu

## 📱 SUGGESTION 1 : [Type]
**Composition :**
[Description de la mise en page]

**À filmer/photographier :**
- [Idée de B-roll 1]
- [Idée de B-roll 2]

**Éléments Canva :**
- Template : [suggestion]
- Couleurs : [palette]
- Typo : [style]

**Texte à intégrer :**
"[phrase accrocheuse du contenu]"

---

## 📱 SUGGESTION 2 : [Type]
...

## 📱 SUGGESTION 3 : [Type]
...`;

            try {
                await callAIStream(prompt, canvaDiv);
                addCopyButton(canvaDiv, '📋 Copier les suggestions Canva');
            } catch (e) { canvaDiv.innerHTML += `<p>❌ ${e.message}</p>`; }
        }


        // Utilitaire pour ajouter bouton copier
        function addCopyButton(element, text) {
            const btn = document.createElement('button');
            btn.className = 'copy-prompt-btn';
            btn.innerHTML = text;
            btn.style.marginTop = '15px';
            btn.onclick = () => navigator.clipboard.writeText(element.innerText).then(() => showToast('✅ ' + t('toasts.copied')));
            element.appendChild(btn);
        }

        // ==================== HELP MODAL ====================
        function showHelpModal() { document.getElementById('helpModal').classList.add('show'); }
        function closeHelpModal() { document.getElementById('helpModal').classList.remove('show'); }
        
        async function analyzeText() {
            const text = document.getElementById('helpTextarea').value.trim();
            if (!text) { showToast('❌ ' + t('toasts.paste_text')); return; }
            closeHelpModal();
            
            const out = document.getElementById('outputContent');
            out.innerHTML = `<div class="output-text" id="streamOutput"></div>`;
            
            const prompt = `TEXTE À ANALYSER :
"${text}"

## 🔍 Analyse rapide
- Points forts (2-3)
- Points faibles (2-3)

## 🪝 2 Hooks alternatifs
[Propositions plus percutantes]

## ✨ Version optimisée
[Réécriture améliorée]

## 💡 Conseils
[2-3 tips]`;

            try {
                await callAIStream(prompt, document.getElementById('streamOutput'));
                currentState.generatedContent = document.getElementById('streamOutput')?.innerText || '';
                LastContentManager.save(currentState.generatedContent, currentState.platform, currentState.format, currentState.structure);
                document.getElementById('actionButtons').style.display = 'flex'; document.getElementById('visualSection').style.display = 'block';
            } catch (e) {
                out.innerHTML = `<div class="output-placeholder"><p>❌ ${e.message}</p></div>`;
            }
        }

        // ==================== FAVORIS ====================
        function getFavorites() { return JSON.parse(localStorage.getItem('tithot_favorites') || '[]'); }
        function saveFavorites(fav) { localStorage.setItem('tithot_favorites', JSON.stringify(fav)); }
        
        function saveToFavorites() {
            if (!currentState.generatedContent) { showToast('❌ ' + t('toasts.no_content')); return; }
            const fav = getFavorites();
            fav.unshift({ id: Date.now(), date: new Date().toLocaleDateString('fr-FR'), content: currentState.generatedContent, platform: currentState.platform, format: currentState.format });
            if (fav.length > 20) fav.pop();
            saveFavorites(fav);
            showToast('❤️ ' + t('toasts.saved_to_favorites'));
        }
        
        function showFavorites() {
            const fav = getFavorites();
            const list = document.getElementById('favoritesList');
            if (fav.length === 0) {
                list.innerHTML = '<div class="empty-favorites">Aucun favori.<br>Génère du contenu et clique ❤️ !</div>';
            } else {
                list.innerHTML = fav.map((f, i) => `
                    <div class="favorite-item">
                        <div class="favorite-item-date">${f.date} • ${PLATFORMS[f.platform]?.name || f.platform}</div>
                        <div class="favorite-item-text">${f.content.substring(0, 300)}...</div>
                        <div class="favorite-item-actions">
                            <button class="favorite-item-btn use" onclick="useFavorite(${i})">📝 Utiliser</button>
                            <button class="favorite-item-btn" style="background:#667eea;color:white;" onclick="copyFavorite(${i})">📋 Copier</button>
                            <button class="favorite-item-btn delete" onclick="deleteFavorite(${i})">🗑️</button>
                        </div>
                    </div>`).join('');
            }
            document.getElementById('favoritesModal').classList.add('show');
        }
        
        function closeFavorites() { document.getElementById('favoritesModal').classList.remove('show'); }
        function useFavorite(i) { const f = getFavorites()[i]; currentState.generatedContent = f.content; document.getElementById('outputContent').innerHTML = `<div class="output-text">${formatResponse(f.content)}</div>`; document.getElementById('actionButtons').style.display = 'flex'; document.getElementById('visualSection').style.display = 'block'; closeFavorites(); showToast('📝 ' + t('toasts.loaded')); }
        function copyFavorite(i) { navigator.clipboard.writeText(getFavorites()[i].content).then(() => showToast('✅ ' + t('toasts.copied'))); }
        function deleteFavorite(i) { const f = getFavorites(); f.splice(i, 1); saveFavorites(f); showFavorites(); showToast('🗑️ ' + t('toasts.deleted')); }

        // ==================== TOUR GUIDÉ ====================
        // Fonction pour obtenir les étapes du tour (traduit dynamiquement)
        function getTourSteps() {
            return [
                // Header - tooltip en dessous
                { el: '#profileBtn', title: '🚀 ' + t('tour.step1_title'), text: t('tour.step1_text'), side: 'bottom' },
                // Header boutons - tooltip à gauche (boutons sont à droite)
                { el: '.btn-voice', title: '🎤 ' + t('tour.step2_title'), text: t('tour.step2_text'), side: 'right' },
                { el: '.btn-trends', title: '📈 ' + t('tour.step3_title'), text: t('tour.step3_text'), side: 'right' },
                // Panneau gauche - tooltip à droite
                { el: '#structureSection', title: '📖 ' + t('tour.step4_title'), text: t('tour.step4_text'), side: 'left' },
                { el: '#frameworkSection', title: '📐 ' + t('tour.step5_title'), text: t('tour.step5_text'), side: 'left' },
                { el: '#formatSection', title: '🎬 ' + t('tour.step6_title'), text: t('tour.step6_text'), side: 'left' },
                { el: '#ideaSection', title: '💡 ' + t('tour.step7_title'), text: t('tour.step7_text'), side: 'left' },
                // Panneau droit - tooltip à gauche
                { el: '#outputPanel', title: '📄 ' + t('tour.step8_title'), text: t('tour.step8_text'), side: 'right' },
                // Header menu - tooltip à droite
                { el: '#agencySection', title: '🏢 ' + t('tour.step9_title'), text: t('tour.step9_text'), side: 'left' },
                { el: '.btn-stats', title: '🏆 ' + t('tour.step10_title'), text: t('tour.step10_text'), side: 'right' },
                { el: '.btn-planning', title: '🗓️ ' + t('tour.step11_title'), text: t('tour.step11_text'), side: 'right' },
                { el: '.btn-favorites', title: '❤️ ' + t('tour.step12_title'), text: t('tour.step12_text'), side: 'right' },
                { el: '#memoryIndicator', title: '🧠 ' + t('tour.step13_title'), text: t('tour.step13_text'), side: 'right', optional: true }
            ];
        }
        let tourSteps = [];
        let tourStep = 0;
        let tourActive = false;

        // Observer pour fermer le tour quand un modal s'ouvre
        const modalObserver = new MutationObserver((mutations) => {
            if (!tourActive) return;
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    const target = mutation.target;
                    if (target.classList.contains('modal-overlay') && target.classList.contains('show')) {
                        // Un modal vient de s'ouvrir, mettre le tour en pause
                        pauseTour();
                    }
                }
            });
        });

        // Observer tous les modals
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modalObserver.observe(modal, { attributes: true });
            });
        });

        function startTour() {
            tourStep = 0;
            tourActive = true;
            tourSteps = getTourSteps(); // Initialiser avec les traductions actuelles
            document.getElementById('tourOverlay').classList.add('show');
            showTourStep();
        }

        function pauseTour() {
            // Cacher temporairement le tour sans le terminer
            document.getElementById('tourOverlay').classList.remove('show');
            document.querySelectorAll('.tour-tooltip').forEach(t => t.remove());
            document.querySelectorAll('.tour-highlight').forEach(e => e.classList.remove('tour-highlight'));
            document.querySelectorAll('.tour-arrow').forEach(a => a.remove());
            showToast('💡 ' + t('toasts.tour_paused'));
        }

        function resumeTour() {
            if (tourActive && tourStep < tourSteps.length) {
                document.getElementById('tourOverlay').classList.add('show');
                showTourStep();
            }
        }
        
        function showTourStep() {
            // Nettoyer les anciens éléments
            document.querySelectorAll('.tour-tooltip').forEach(t => t.remove());
            document.querySelectorAll('.tour-highlight').forEach(e => e.classList.remove('tour-highlight'));
            document.querySelectorAll('.tour-arrow').forEach(a => a.remove());

            // Fin du tour ?
            if (tourStep >= tourSteps.length) { endTour(); return; }

            const step = tourSteps[tourStep];
            const el = document.querySelector(step.el);

            // Skip si élément non trouvé ou optionnel et caché
            if (!el || (step.optional && el.style.display === 'none')) {
                tourStep++;
                showTourStep();
                return;
            }

            // Highlight l'élément
            el.classList.add('tour-highlight');
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });

            setTimeout(() => {
                const rect = el.getBoundingClientRect();
                const tooltipHeight = 280; // Hauteur estimée de la tooltip
                const tooltipWidth = 320;
                const padding = 20;
                const arrowSize = 30;

                // Créer la tooltip
                const tip = document.createElement('div');
                tip.className = `tour-tooltip side-${step.side}`;

                // Calcul intelligent du positionnement vertical
                let topPos;
                const elementCenterY = rect.top + rect.height / 2;
                const viewportHeight = window.innerHeight;

                // S'assurer que la tooltip + boutons sont visibles
                if (step.side === 'bottom') {
                    // Tooltip en dessous de l'élément
                    topPos = rect.bottom + padding;
                    if (topPos + tooltipHeight > viewportHeight - padding) {
                        topPos = viewportHeight - tooltipHeight - padding;
                    }
                } else {
                    // Tooltip à gauche ou à droite
                    // Centrer verticalement par rapport à l'élément mais garder dans l'écran
                    topPos = elementCenterY - tooltipHeight / 2;

                    // Ne pas dépasser en haut
                    if (topPos < padding + 60) {
                        topPos = padding + 60;
                    }
                    // Ne pas dépasser en bas (laisser de la place pour les boutons)
                    if (topPos + tooltipHeight > viewportHeight - padding) {
                        topPos = viewportHeight - tooltipHeight - padding;
                    }
                }

                tip.style.top = topPos + 'px';

                tip.innerHTML = `
                    <div class="tour-tooltip-step">${t('tour.step')} ${tourStep + 1}/${tourSteps.length}</div>
                    <div class="tour-tooltip-title">${step.title}</div>
                    <div class="tour-tooltip-text">${step.text}</div>
                    <div class="tour-tooltip-progress">
                        ${tourSteps.map((_, i) => `<span class="tour-dot ${i <= tourStep ? 'active' : ''}"></span>`).join('')}
                    </div>
                    <div class="tour-tooltip-buttons">
                        <button class="tour-btn skip" onclick="endTour()">${t('tour.skip')}</button>
                        <button class="tour-btn next" onclick="nextTourStep()">${tourStep === tourSteps.length - 1 ? '🎉 ' + t('tour.finish') : t('tour.next') + ' →'}</button>
                    </div>`;
                document.body.appendChild(tip);

                // Créer la flèche
                const arrow = document.createElement('div');
                arrow.className = `tour-arrow arrow-${step.side}`;

                // Positionner la flèche au centre de l'élément ciblé
                const arrowTop = Math.max(padding, Math.min(viewportHeight - arrowSize - padding, rect.top + rect.height / 2 - arrowSize / 2));
                arrow.style.top = arrowTop + 'px';

                if (step.side === 'right') {
                    // Flèche à gauche de l'élément, pointant vers la droite
                    arrow.style.left = (rect.left - arrowSize - 5) + 'px';
                } else if (step.side === 'left') {
                    // Flèche à droite de l'élément, pointant vers la gauche
                    arrow.style.left = (rect.right + 5) + 'px';
                } else if (step.side === 'bottom') {
                    // Flèche en haut de la tooltip, pointant vers le haut
                    arrow.style.left = (rect.left + rect.width / 2 - arrowSize / 2) + 'px';
                    arrow.style.top = (rect.bottom + 5) + 'px';
                }

                document.body.appendChild(arrow);

            }, 400);
        }
        
        function nextTourStep() { 
            tourStep++; 
            showTourStep(); 
        }
        
        function endTour() {
            tourActive = false;
            document.getElementById('tourOverlay').classList.remove('show');
            document.querySelectorAll('.tour-tooltip').forEach(t => t.remove());
            document.querySelectorAll('.tour-highlight').forEach(e => e.classList.remove('tour-highlight'));
            document.querySelectorAll('.tour-arrow').forEach(a => a.remove());
            localStorage.setItem('tithot_tour_done', 'true');
            // Ne pas cacher le badge - certains utilisateurs veulent revoir l'aide
            // document.getElementById('demoBadge').style.display = 'none';
            showToast('🎉 ' + t('toasts.onboarding_complete'));
        }
        
        function restartTour() {
            localStorage.removeItem('tithot_tour_done');
            localStorage.removeItem('sos_welcome_shown');
            // Aller sur le dashboard de création et afficher le badge
            showQuickPost();
            document.getElementById('demoBadge').style.display = 'flex';
            startTour();
        }

        // Réinitialiser complètement l'aide guidée (popup + tour)
        function resetGuidedHelp() {
            localStorage.removeItem('tithot_tour_done');
            localStorage.removeItem('sos_welcome_shown');
            localStorage.removeItem('sos_welcome_hidden');
            showWelcomePopup();
        }

        // ==================== WELCOME POPUP ====================
        // Affiche un popup de bienvenue après la première connexion
        function showWelcomePopup() {
            // Ne pas afficher si l'utilisateur a coché "ne plus montrer"
            if (localStorage.getItem('sos_welcome_hidden') === 'true') return;
            document.getElementById('welcomePopup').classList.add('show');
        }

        function closeWelcomePopup() {
            // Vérifier si "ne plus montrer" est coché
            const dontShowCheckbox = document.getElementById('welcomeDontShow');
            if (dontShowCheckbox && dontShowCheckbox.checked) {
                localStorage.setItem('sos_welcome_hidden', 'true');
            }
            document.getElementById('welcomePopup').classList.remove('show');
            localStorage.setItem('sos_welcome_shown', 'true');
        }

        function startGuidedDemo() {
            // Fermer le popup et lancer le tour
            const dontShowCheckbox = document.getElementById('welcomeDontShow');
            if (dontShowCheckbox && dontShowCheckbox.checked) {
                localStorage.setItem('sos_welcome_hidden', 'true');
            }
            document.getElementById('welcomePopup').classList.remove('show');
            localStorage.setItem('sos_welcome_shown', 'true');
            // Petit délai pour que le popup se ferme avant de lancer le tour
            setTimeout(() => {
                startTour();
            }, 300);
        }

        // Déconnexion
        async function handleLogout() {
            try {
                if (window.supabaseApp?.auth) {
                    await window.supabaseApp.auth.signOut();
                }
                // Nettoyer le localStorage
                localStorage.removeItem('sos_welcome_shown');
                localStorage.removeItem('sos_onboarding_complete');
                // Rediriger vers la page de login
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Erreur déconnexion:', error);
                // Rediriger quand même
                window.location.href = 'login.html';
            }
        }

        // Vérifier si c'est la première visite (après connexion)
        function checkFirstVisit() {
            // Afficher le popup uniquement si l'utilisateur n'a jamais vu le popup de bienvenue
            if (!localStorage.getItem('sos_welcome_shown')) {
                setTimeout(() => {
                    showWelcomePopup();
                }, 800); // Petit délai pour laisser la page se charger
            }
        }

        // ==================== API ====================
        const API_URL = 'https://sos-storytelling-api.sandra-devonssay.workers.dev/';

        async function callAI(prompt, usePerplexity = false) {
            // Utiliser fetchWithTimeout avec 90 secondes de timeout
            const fetchFn = window.fetchWithTimeout || fetch;
            const response = await fetchFn(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    messages: [{ role: 'user', content: prompt }],
                    userProfile: UserProfile.get(),
                    usePerplexity: usePerplexity
                })
            }, 90000);
            if (!response.ok) throw new Error('Erreur connexion');
            const data = await response.json();
            if (data.content?.[0]?.text) return data.content[0].text;
            throw new Error('Format réponse invalide');
        }
        // Exposer callAI globalement pour les modules externes (newsletter, etc.)
        window.callAI = callAI;

        // Fonction dédiée pour Perplexity (TRENDS, Planning, recherche web)
        async function callPerplexity(prompt) {
            return callAI(prompt, true);
        }

        // Son de réflexion Tithot - son magique doux
        function playThinkingSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const now = audioContext.currentTime;

                // Créer un son "magique" avec plusieurs notes
                const notes = [523, 659, 784]; // Do, Mi, Sol (accord majeur)

                notes.forEach((freq, i) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();

                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, now);

                    gain.gain.setValueAtTime(0, now + i * 0.08);
                    gain.gain.linearRampToValueAtTime(0.08, now + i * 0.08 + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.08 + 0.4);

                    osc.connect(gain);
                    gain.connect(audioContext.destination);

                    osc.start(now + i * 0.08);
                    osc.stop(now + i * 0.08 + 0.5);
                });
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        async function callAIStream(prompt, outputElement, usePerplexity = false) {
            // Jouer le son de réflexion
            playThinkingSound();

            // Afficher animation Lottie
            outputElement.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <dotlottie-wc src="https://lottie.host/31e18ce0-6f4b-474c-8b3e-046e415ea9bb/O5jEMojyhf.lottie" style="width: 200px; height: 200px; margin: 0 auto; display: block;" autoplay loop></dotlottie-wc>
                    <p style="color: #667eea; font-weight: 600; margin-top: 15px;">${usePerplexity ? 'Tithot analyse les tendances...' : 'Tithot réfléchit...'}</p>
                </div>
            `;
            
            try {
                const fullText = await callAI(prompt, usePerplexity);
                await typeText(fullText, outputElement);
                return fullText;
            } catch (error) {
                outputElement.innerHTML = '<p style="color: #ff6b6b;">❌ Erreur : ' + error.message + '</p>';
                throw error;
            }
        }
        
        async function typeText(text, element) {
            const words = text.split(' ');
            let displayed = '';
            for (let i = 0; i < words.length; i++) {
                displayed += (i > 0 ? ' ' : '') + words[i];
                element.innerHTML = formatResponse(displayed);
                const container = document.getElementById('outputContent');
                if (container) container.scrollTop = container.scrollHeight;
                if (i % 5 === 0) await new Promise(r => setTimeout(r, 10));
            }
        }

        function formatResponse(text) {
            return text.replace(/## (.*)/g, '<h2>$1</h2>').replace(/### (.*)/g, '<h3>$1</h3>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/```([\s\S]*?)```/g, '<pre>$1</pre>').replace(/`([^`]+)`/g, '<code>$1</code>').replace(/\n/g, '<br>');
        }
        
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
        function updateProfileButton() { const btn = document.getElementById('profileBtn'); if (!btn) return; const p = UserProfile.get(); if (p?.nom) btn.innerHTML = `✏️ ${p.nom}`; }
        function showStatsModal() { ProgressionSystem.showStats(); }
        function showGoalsModal() { GoalsSystem.showDashboard(); }

        // ==================== PLANNING IA ====================
        function showPlanningModal() {
            const modal = document.getElementById('planningModal');
            const content = document.getElementById('planningContent');
            
            // Récupérer les données
            const favorites = getFavorites();
            const profile = UserProfile.get();
            const memory = ContentMemory.getSummaryForAI();
            const agencyData = AgencySystem.get();
            
            // Compter les contenus par pilier et plateforme
            const pillarCounts = {};
            const platformCounts = {};
            
            favorites.forEach(fav => {
                const pillar = fav.pillar || 'Autre';
                const platform = fav.platform || 'unknown';
                pillarCounts[pillar] = (pillarCounts[pillar] || 0) + 1;
                platformCounts[platform] = (platformCounts[platform] || 0) + 1;
            });
            
            // Générer le HTML initial
            content.innerHTML = `
                <div class="planning-intro">
                    <h3>🧠 Assistant Planning Intelligent</h3>
                    <p>L'IA analyse tes contenus sauvegardés et te suggère le meilleur planning basé sur les tendances 2025 et tes piliers de contenu.</p>
                </div>
                
                <div class="planning-stats">
                    <div class="planning-stat">
                        <div class="planning-stat-value">${favorites.length}</div>
                        <div class="planning-stat-label">Contenus sauvegardés</div>
                    </div>
                    <div class="planning-stat">
                        <div class="planning-stat-value">${Object.keys(pillarCounts).length}</div>
                        <div class="planning-stat-label">Piliers actifs</div>
                    </div>
                    <div class="planning-stat">
                        <div class="planning-stat-value">${Object.keys(platformCounts).length}</div>
                        <div class="planning-stat-label">Plateformes</div>
                    </div>
                    <div class="planning-stat">
                        <div class="planning-stat-value">${profile?.piliers?.length || 0}</div>
                        <div class="planning-stat-label">Piliers définis</div>
                    </div>
                </div>
                
                ${favorites.length === 0 ? `
                    <div class="planning-alert warning">
                        <span style="font-size: 1.5em;">💡</span>
                        <div>
                            <strong>Aucun contenu sauvegardé</strong><br>
                            <span style="font-size: 0.9em;">Génère et sauvegarde quelques contenus en favoris pour que l'IA puisse créer ton planning optimal.</span>
                        </div>
                    </div>
                ` : `
                    <button class="planning-generate-btn" onclick="generateAIPlanning()" id="planningGenerateBtn">
                        <span>🚀</span>
                        <span>Générer mon planning optimal</span>
                    </button>
                `}
                
                <div id="planningResults"></div>
            `;
            
            modal.classList.add('show');
        }
        
        function closePlanningModal() {
            document.getElementById('planningModal').classList.remove('show');
        }
        
        async function generateAIPlanning() {
            const btn = document.getElementById('planningGenerateBtn');
            const resultsDiv = document.getElementById('planningResults');
            
            btn.disabled = true;
            btn.innerHTML = '<span>⏳</span><span>Analyse en cours...</span>';
            
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <dotlottie-wc src="https://lottie.host/eeab1c36-2031-4942-bf72-95b983b64077/hNKxxXfdmq.lottie" style="width: 150px; height: 150px; margin: 0 auto; display: block;" autoplay loop></dotlottie-wc>
                    <p style="color: #11998e; font-weight: 600; margin-top: 15px;">Tithot analyse tes contenus et les tendances...</p>
                </div>
            `;
            
            try {
                // Préparer les données pour l'IA
                const favorites = getFavorites();
                const profile = UserProfile.get();
                const today = new Date();
                const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                
                // Résumer les favoris
                const favoriteSummary = favorites.slice(0, 15).map((f, i) => 
                    `${i+1}. [${f.platform || '?'}] ${f.pillar || 'Sans pilier'} - "${(f.preview || f.content || '').substring(0, 80)}..."`
                ).join('\n');
                
                const prompt = `Tu es Tithot, experte en stratégie de contenu et planning éditorial.

PROFIL UTILISATEUR :
- Nom : ${profile?.nom || 'Utilisateur'}
- Domaine : ${profile?.domaine || 'Non précisé'}
- Piliers de contenu : ${profile?.piliers?.join(', ') || 'Non définis'}
- Style : ${profile?.style || 'Non précisé'}
- Plateformes : ${currentState.platform || 'LinkedIn'}

CONTENUS SAUVEGARDÉS (${favorites.length} total) :
${favoriteSummary || 'Aucun contenu'}

DATE : ${dayNames[today.getDay()]} ${today.getDate()}/${today.getMonth()+1}/${today.getFullYear()}

DONNÉES TENDANCES 2025 :
- LinkedIn : Mardi-Jeudi 7-9h, 12-13h, 17-18h (meilleur engagement B2B)
- Instagram : Lundi-Jeudi 10-15h et 19-21h
- TikTok : Jeudi-Samedi 19-23h
- Fréquence optimale : LinkedIn 1/jour, Instagram 3-5/semaine, TikTok régulier

Analyse ces contenus et génère un planning sur 2 semaines. Réponds EXACTEMENT dans ce format JSON :

{
  "equilibre": {
    "analyse": "Ton analyse de l'équilibre des piliers (2 phrases max)",
    "piliers": [{"nom": "pilier1", "pourcentage": 40}, {"nom": "pilier2", "pourcentage": 30}],
    "manque": "Ce qui manque ou est trop représenté"
  },
  "planning": [
    {"jour": "Lundi 2/12", "heure": "8h30", "plateforme": "linkedin", "type": "éducatif", "pilier": "expertise", "contenu": "Titre ou résumé du contenu suggéré", "raison": "Pourquoi ce créneau"},
    {"jour": "Mardi 3/12", "heure": "12h00", "plateforme": "instagram", "type": "inspirant", "pilier": "témoignage", "contenu": "...", "raison": "..."}
  ],
  "alertes": [
    {"type": "warning", "message": "Alerte ou recommandation importante"},
    {"type": "success", "message": "Point positif à souligner"}
  ],
  "prochainContenu": {
    "suggestion": "Le prochain contenu à créer en priorité",
    "raison": "Pourquoi celui-là maintenant"
  }
}

Propose 6 à 10 créneaux de publication sur les 2 prochaines semaines, en alternant les piliers et plateformes intelligemment.`;

                // Utiliser Perplexity pour le planning (accès aux tendances actuelles)
                const response = await callPerplexity(prompt);
                
                // Parser la réponse JSON
                const jsonMatch = response.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('Format de réponse invalide');
                
                const planningData = JSON.parse(jsonMatch[0]);
                
                // Afficher les résultats
                displayPlanningResults(planningData);
                
            } catch (error) {
                console.error('Erreur planning:', error);
                resultsDiv.innerHTML = `
                    <div class="planning-alert warning">
                        <span style="font-size: 1.5em;">⚠️</span>
                        <div>
                            <strong>Erreur lors de l'analyse</strong><br>
                            <span style="font-size: 0.9em;">${error.message}. Réessaie dans quelques instants.</span>
                        </div>
                    </div>
                `;
            }
            
            btn.disabled = false;
            btn.innerHTML = '<span>🔄</span><span>Régénérer le planning</span>';
        }
        
        function displayPlanningResults(data) {
            const resultsDiv = document.getElementById('planningResults');
            
            // Icônes par plateforme
            const platformIcons = {
                linkedin: '💼',
                instagram: '📸',
                tiktok: '🎵',
                facebook: '👥',
                x: '𝕏',
                youtube: '🎬'
            };
            
            let html = '<div class="planning-results">';
            
            // Section Alertes
            if (data.alertes && data.alertes.length > 0) {
                html += '<div class="planning-section"><h4>📢 Alertes & Recommandations</h4>';
                data.alertes.forEach(alert => {
                    html += `<div class="planning-alert ${alert.type}">
                        <span style="font-size: 1.3em;">${alert.type === 'warning' ? '⚠️' : alert.type === 'success' ? '✅' : 'ℹ️'}</span>
                        <div>${alert.message}</div>
                    </div>`;
                });
                html += '</div>';
            }
            
            // Section Équilibre des piliers
            if (data.equilibre) {
                html += `<div class="planning-section">
                    <h4>⚖️ Équilibre de tes piliers</h4>
                    <p style="color: #666; margin-bottom: 15px;">${data.equilibre.analyse}</p>`;
                
                if (data.equilibre.piliers && data.equilibre.piliers.length > 0) {
                    data.equilibre.piliers.forEach(p => {
                        html += `<div class="planning-pillar-bar">
                            <div class="planning-pillar-name">${p.nom}</div>
                            <div class="planning-pillar-track">
                                <div class="planning-pillar-fill" style="width: ${p.pourcentage}%"></div>
                            </div>
                            <div class="planning-pillar-count">${p.pourcentage}%</div>
                        </div>`;
                    });
                }
                
                if (data.equilibre.manque) {
                    html += `<div class="planning-alert info" style="margin-top: 15px;">
                        <span>💡</span>
                        <div>${data.equilibre.manque}</div>
                    </div>`;
                }
                html += '</div>';
            }
            
            // Section Planning
            if (data.planning && data.planning.length > 0) {
                html += `<div class="planning-section">
                    <h4>🗓️ Planning suggéré (2 semaines)</h4>`;
                
                data.planning.forEach(item => {
                    const icon = platformIcons[item.plateforme?.toLowerCase()] || '📱';
                    html += `<div class="planning-suggestion">
                        <div class="planning-suggestion-icon ${item.plateforme?.toLowerCase() || ''}">${icon}</div>
                        <div class="planning-suggestion-content">
                            <div class="planning-suggestion-title">${item.contenu}</div>
                            <div class="planning-suggestion-meta">
                                <strong>${item.jour}</strong> à <strong>${item.heure}</strong> • 
                                ${item.plateforme} • ${item.type} • Pilier: ${item.pilier}
                            </div>
                            ${item.raison ? `<div class="planning-suggestion-reason">💡 ${item.raison}</div>` : ''}
                        </div>
                    </div>`;
                });
                html += '</div>';
            }
            
            // Section Prochain contenu prioritaire
            if (data.prochainContenu) {
                html += `<div class="planning-section" style="background: linear-gradient(135deg, rgba(17,153,142,0.1), rgba(56,239,125,0.1)); border-color: #11998e;">
                    <h4>🎯 Prochain contenu prioritaire</h4>
                    <p style="font-size: 1.1em; color: #333; margin-bottom: 10px;"><strong>${data.prochainContenu.suggestion}</strong></p>
                    <p style="color: #666;">${data.prochainContenu.raison}</p>
                    <button onclick="closePlanningModal(); document.getElementById('userIdea').value='${(data.prochainContenu.suggestion || '').replace(/'/g, "\\'")}'; document.getElementById('userIdea').focus();" 
                            style="margin-top: 15px; padding: 12px 25px; background: linear-gradient(135deg, #11998e, #38ef7d); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">
                        ✨ Créer ce contenu maintenant
                    </button>
                </div>`;
            }
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }
        
        // ==================== MON STYLE ====================
        const VOICE_SAMPLES_KEY = 'tithot_voice_samples';
        
        function getVoiceSamples() {
            const saved = localStorage.getItem(VOICE_SAMPLES_KEY);
            return saved ? JSON.parse(saved) : [];
        }
        
        function saveVoiceSamples(samples) {
            localStorage.setItem(VOICE_SAMPLES_KEY, JSON.stringify(samples));
        }
        
        function showVoiceModal() {
            const modal = document.getElementById('voiceModal');
            const content = document.getElementById('voiceContent');
            const profile = UserProfile.get();
            const voiceProfile = profile?.voiceProfile;
            const samples = getVoiceSamples();
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <p style="color: #666; font-size: 1.05em; line-height: 1.6;">
                        L'IA analyse tes textes pour capturer ta <strong>voix unique</strong> : ton, expressions, style...<br>
                        Tous tes contenus seront ensuite générés dans <strong>TON</strong> style !
                    </p>
                    <div style="background: linear-gradient(135deg, #fff9e6, #fff3cd); border-radius: 12px; padding: 15px; margin-top: 15px; border-left: 4px solid #ffc107;">
                        <p style="color: #856404; font-size: 0.9em; margin: 0;">
                            💡 <strong>Conseil :</strong> Utilise des textes <strong>vraiment écrits par toi</strong>, pas générés par IA. 
                            C'est ce qui permettra de capturer ton ton authentique et de rendre tes futurs contenus uniques !
                        </p>
                    </div>
                </div>
                
                ${voiceProfile ? `
                    <div class="voice-analysis">
                        <div class="voice-analysis-title">
                            <span>✅ Profil de voix actif</span>
                            <span class="voice-badge active">🎯 Actif</span>
                        </div>
                        
                        <div class="voice-trait">
                            <div class="voice-trait-icon tone">🎭</div>
                            <div class="voice-trait-content">
                                <div class="voice-trait-label">Ton général</div>
                                <div class="voice-trait-value">${voiceProfile.ton || 'Non analysé'}</div>
                            </div>
                        </div>
                        
                        <div class="voice-trait">
                            <div class="voice-trait-icon length">📏</div>
                            <div class="voice-trait-content">
                                <div class="voice-trait-label">Longueur des phrases</div>
                                <div class="voice-trait-value">${voiceProfile.longueurPhrases || 'Non analysée'}</div>
                            </div>
                        </div>
                        
                        <div class="voice-trait">
                            <div class="voice-trait-icon vocab">📚</div>
                            <div class="voice-trait-content">
                                <div class="voice-trait-label">Vocabulaire & expressions</div>
                                <div class="voice-trait-value">${voiceProfile.expressions || 'Non analysées'}</div>
                            </div>
                        </div>
                        
                        <div class="voice-trait">
                            <div class="voice-trait-icon punctuation">✨</div>
                            <div class="voice-trait-content">
                                <div class="voice-trait-label">Ponctuation & émojis</div>
                                <div class="voice-trait-value">${voiceProfile.ponctuation || 'Non analysée'}</div>
                            </div>
                        </div>
                        
                        <div class="voice-trait">
                            <div class="voice-trait-icon structure">🏗️</div>
                            <div class="voice-trait-content">
                                <div class="voice-trait-label">Style narratif</div>
                                <div class="voice-trait-value">${voiceProfile.styleNarratif || 'Non analysé'}</div>
                            </div>
                        </div>
                        
                        <div class="voice-fidelity">
                            <div class="voice-fidelity-score">${voiceProfile.fidelityScore || '85'}%</div>
                            <div class="voice-fidelity-label">de fidélité estimée<br><small>Les contenus générés ressembleront à ton style</small></div>
                        </div>

                        <div class="voice-setting-section">
                            <div class="voice-setting-label">👋 Style d'adresse par défaut</div>
                            <p class="voice-setting-hint">L'IA utilisera ce style dans tous les contenus générés</p>
                            <div class="formal-style-toggle">
                                <button class="toggle-btn ${(profile.formalStyle || 'tu') === 'tu' ? 'active' : ''}" onclick="setFormalStyle('tu')">Tu</button>
                                <button class="toggle-btn ${profile.formalStyle === 'vous' ? 'active' : ''}" onclick="setFormalStyle('vous')">Vous</button>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="voice-btn voice-btn-secondary" onclick="showVoiceEditor()" style="flex: 1;">✏️ Modifier mes textes</button>
                            <button class="voice-btn voice-btn-danger" onclick="deleteVoiceProfile()" style="padding: 10px 15px;">🗑️</button>
                        </div>
                        ${voiceModalCallback ? `
                        <button class="voice-btn voice-btn-primary" onclick="closeVoiceAndReturn()" style="width: 100%; margin-top: 15px; padding: 15px;">
                            ✅ C'est bon, retour au wizard →
                        </button>
                        ` : ''}
                    </div>
                ` : `
                    <div class="voice-section">
                        <h3 style="margin-bottom: 15px; color: #333;">📝 Ajoute des textes que tu as écrits</h3>
                        <p style="color: #888; font-size: 0.9em; margin-bottom: 15px;">
                            Colle 2-5 textes dont tu es fier(e) : posts LinkedIn, articles, emails... Plus tu en mets, plus l'analyse sera précise !
                        </p>
                        
                        <div id="voiceSamplesList" class="voice-samples">
                            ${samples.length > 0 ? samples.map((s, i) => `
                                <div class="voice-sample">
                                    <div class="voice-sample-text">${s.substring(0, 80)}...</div>
                                    <div class="voice-sample-actions">
                                        <button class="voice-sample-btn" onclick="removeVoiceSample(${i})" title="Supprimer">🗑️</button>
                                    </div>
                                </div>
                            `).join('') : '<p style="color: #999; text-align: center; padding: 20px;">Aucun texte ajouté</p>'}
                        </div>
                        
                        <textarea id="voiceNewSample" class="voice-textarea" placeholder="Colle ici un texte que tu as écrit et dont tu es satisfait(e)...

Exemples :
• Un post LinkedIn qui a bien marché
• Un email professionnel
• Un article de blog
• Une bio ou présentation

L'IA va analyser ton style d'écriture unique !"></textarea>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="voice-btn voice-btn-secondary" onclick="addVoiceSample()" style="flex: 1;">➕ Ajouter ce texte</button>
                        </div>
                        
                        ${samples.length >= 2 ? `
                            <button class="voice-btn voice-btn-primary" onclick="analyzeVoice()" style="width: 100%; margin-top: 20px; padding: 15px;">
                                🎤 Analyser mon style (${samples.length} textes)
                            </button>
                        ` : `
                            <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                                <p style="color: #888; margin: 0;">Ajoute au moins <strong>2 textes</strong> pour lancer l'analyse</p>
                            </div>
                        `}
                    </div>
                `}
            `;
            
            modal.classList.add('show');
        }
        
        function closeVoiceModal() {
            document.getElementById('voiceModal').classList.remove('show');
        }

        // Fonction pour changer le style d'adresse (Tu/Vous)
        function setFormalStyle(style) {
            const profile = UserProfile.get() || {};
            profile.formalStyle = style;
            UserProfile.save(profile);

            // Mettre à jour visuellement les boutons
            document.querySelectorAll('.formal-style-toggle .toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            showToast('✅ ' + t('toasts.style_saved'));
        }

        // Callback après configuration de Mon Style
        let voiceModalCallback = null;

        // Ouvrir Mon Style avec callback (pour retour au wizard)
        function showVoiceModalWithCallback(callback) {
            voiceModalCallback = callback;
            showVoiceModal();
        }

        // Fermer et exécuter le callback si profil configuré
        function closeVoiceAndReturn() {
            const profile = UserProfile.get();
            if (profile?.voiceProfile) {
                closeVoiceModal();
                if (voiceModalCallback) {
                    const callback = voiceModalCallback;
                    voiceModalCallback = null;
                    setTimeout(() => callback(), 300);
                }
            } else {
                showToast('⚠️ ' + t('toasts.configure_voice'));
            }
        }

        function showVoiceEditor() {
            const profile = UserProfile.get();
            const samples = getVoiceSamples();
            const content = document.getElementById('voiceContent');
            
            content.innerHTML = `
                <div class="voice-section">
                    <h3 style="margin-bottom: 15px; color: #333;">📝 Mes textes de référence</h3>
                    
                    <div id="voiceSamplesList" class="voice-samples">
                        ${samples.length > 0 ? samples.map((s, i) => `
                            <div class="voice-sample">
                                <div class="voice-sample-text">${s.substring(0, 80)}...</div>
                                <div class="voice-sample-actions">
                                    <button class="voice-sample-btn" onclick="removeVoiceSample(${i})" title="Supprimer">🗑️</button>
                                </div>
                            </div>
                        `).join('') : '<p style="color: #999; text-align: center; padding: 20px;">Aucun texte</p>'}
                    </div>
                    
                    <textarea id="voiceNewSample" class="voice-textarea" placeholder="Colle un nouveau texte ici..."></textarea>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="voice-btn voice-btn-secondary" onclick="addVoiceSample()" style="flex: 1;">➕ Ajouter</button>
                        <button class="voice-btn voice-btn-primary" onclick="analyzeVoice()" style="flex: 1;">🔄 Ré-analyser</button>
                    </div>
                    
                    <button class="voice-btn voice-btn-secondary" onclick="showVoiceModal()" style="width: 100%; margin-top: 15px;">← Retour</button>
                </div>
            `;
        }
        
        function addVoiceSample() {
            const textarea = document.getElementById('voiceNewSample');
            const text = textarea.value.trim();
            
            if (text.length < 50) {
                showToast('❌ ' + t('toasts.text_too_short'));
                return;
            }

            if (text.length > 5000) {
                showToast('❌ ' + t('toasts.text_too_long'));
                return;
            }

            const samples = getVoiceSamples();
            if (samples.length >= 10) {
                showToast('❌ ' + t('toasts.max_texts'));
                return;
            }

            samples.push(text);
            saveVoiceSamples(samples);
            textarea.value = '';
            showToast('✅ ' + t('toasts.text_added'));
            showVoiceModal(); // Refresh
        }
        
        function removeVoiceSample(index) {
            const samples = getVoiceSamples();
            samples.splice(index, 1);
            saveVoiceSamples(samples);
            showToast('🗑️ ' + t('toasts.text_deleted'));
            showVoiceModal(); // Refresh
        }
        
        function deleteVoiceProfile() {
            if (!confirm('Supprimer ton profil de voix ? Tu pourras en créer un nouveau.')) return;
            
            const profile = UserProfile.get() || {};
            profile.voiceProfile = null;
            UserProfile.save(profile);
            saveVoiceSamples([]);
            showToast('🗑️ ' + t('toasts.voice_profile_deleted'));
            showVoiceModal(); // Refresh
        }
        
        async function analyzeVoice() {
            const samples = getVoiceSamples();
            if (samples.length < 2) {
                showToast('❌ ' + t('toasts.min_2_texts'));
                return;
            }

            const content = document.getElementById('voiceContent');
            content.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <dotlottie-wc src="https://lottie.host/eeab1c36-2031-4942-bf72-95b983b64077/hNKxxXfdmq.lottie" style="width: 150px; height: 150px; margin: 0 auto; display: block;" autoplay loop></dotlottie-wc>
                    <p style="color: #667eea; font-weight: 600; margin-top: 20px;">Tithot analyse ton style d'écriture...</p>
                    <p style="color: #888; font-size: 0.9em; margin-top: 10px;">Cela peut prendre quelques secondes</p>
                </div>
            `;
            
            const samplesText = samples.map((s, i) => `--- TEXTE ${i+1} ---\n${s}`).join('\n\n');
            
            const prompt = `Tu es un expert en analyse stylistique et linguistique.

Analyse ces ${samples.length} textes écrits par la même personne et extrais son "profil de voix" unique.

${samplesText}

Analyse précisément et réponds UNIQUEMENT avec ce JSON valide :

{
  "ton": "Description du ton général en 3-5 mots (ex: 'Chaleureux et direct', 'Professionnel mais accessible', 'Enthousiaste et motivant')",
  "longueurPhrases": "Court/Moyen/Long + description (ex: 'Courtes et percutantes', 'Moyennes avec rythme varié')",
  "expressions": "3-5 expressions ou tournures récurrentes identifiées (ex: 'Utilise beaucoup les questions rhétoriques, commence souvent par Et si...')",
  "ponctuation": "Usage des émojis, points d'exclamation, tirets, etc. (ex: 'Émojis modérés, beaucoup de points d'exclamation')",
  "styleNarratif": "Structure narrative préférée (ex: 'Storytelling personnel, part souvent d'une anecdote')",
  "vocabulaire": "Niveau et type de vocabulaire (ex: 'Accessible, évite le jargon, mots simples et directs')",
  "signature": "Ce qui rend cette voix unique en 1 phrase",
  "fidelityScore": 85,
  "conseils": "Comment reproduire cette voix dans les contenus générés (2-3 conseils clés)"
}`;

            try {
                const response = await callAI(prompt);
                const jsonMatch = response.match(/\{[\s\S]*\}/);
                
                if (!jsonMatch) throw new Error('Format invalide');
                
                const voiceProfile = JSON.parse(jsonMatch[0]);
                
                // Sauvegarder dans le profil utilisateur
                const profile = UserProfile.get() || {};
                profile.voiceProfile = voiceProfile;
                UserProfile.save(profile);
                
                showToast('✅ ' + t('toasts.voice_profile_created'));
                showVoiceModal(); // Refresh pour afficher le profil
                
            } catch (error) {
                console.error('Erreur analyse voix:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: #ff6b6b; font-size: 1.2em;">❌ Erreur lors de l'analyse</p>
                        <p style="color: #888; margin-top: 10px;">${error.message}</p>
                        <button class="voice-btn voice-btn-primary" onclick="showVoiceModal()" style="margin-top: 20px;">Réessayer</button>
                    </div>
                `;
            }
        }
    </script>

    <!-- ==================== CHATBOT FAQ ==================== -->
    <style>
        /* Chatbot Widget */
        .chatbot-widget {
            position: fixed;
            bottom: 100px; /* Ajusté pour le footer légal + reminder bar */
            right: 25px;
            z-index: 9999;
            font-family: 'Poppins', sans-serif;
        }
        
        .chatbot-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            color: white;
            box-shadow: 0 5px 25px rgba(102,126,234,0.4);
            transition: all 0.3s;
        }
        
        .chatbot-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 35px rgba(102,126,234,0.5);
        }
        
        .chatbot-toggle.open {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }
        
        .chatbot-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 22px;
            height: 22px;
            background: #ff6b6b;
            border-radius: 50%;
            font-size: 0.7em;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
        
        .chatbot-window {
            position: absolute;
            bottom: 75px;
            right: 0;
            width: 380px;
            max-width: calc(100vw - 40px);
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.2);
            overflow: hidden;
            display: none;
            flex-direction: column;
            max-height: 500px;
        }
        
        .chatbot-window.show {
            display: flex;
            animation: chatSlideUp 0.3s ease;
        }
        
        @keyframes chatSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chatbot-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 18px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .chatbot-avatar {
            width: 45px;
            height: 45px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }
        
        .chatbot-info h3 {
            margin: 0;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .chatbot-info p {
            margin: 3px 0 0;
            font-size: 0.85em;
            opacity: 0.9;
        }
        
        .chatbot-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            max-height: 280px;
        }
        
        .chat-message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-message.bot .chat-bubble {
            background: white;
            border-radius: 18px 18px 18px 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .chat-message.user {
            align-items: flex-end;
        }
        
        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 18px 18px 4px 18px;
        }
        
        .chat-bubble {
            padding: 12px 16px;
            max-width: 85%;
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        .chat-bubble a {
            color: #667eea;
            text-decoration: underline;
        }
        
        .chat-message.user .chat-bubble a {
            color: white;
        }
        
        .chat-quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .chat-quick-btn {
            background: white;
            border: 2px solid #e0e5ff;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            color: #333;
        }
        
        .chat-quick-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .chat-support-btn {
            display: inline-block;
            margin-top: 10px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chat-support-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .chatbot-input {
            padding: 15px;
            background: white;
            border-top: 1px solid #e8e8e8;
            display: flex;
            gap: 10px;
        }
        
        .chatbot-input input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e8e8e8;
            border-radius: 25px;
            font-family: inherit;
            font-size: 0.9em;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .chatbot-input input:focus {
            border-color: #667eea;
        }
        
        .chatbot-input button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .chatbot-input button:hover {
            transform: scale(1.05);
        }
        
        .chatbot-typing {
            display: flex;
            gap: 4px;
            padding: 10px 15px;
        }
        
        .chatbot-typing span {
            width: 8px;
            height: 8px;
            background: #ccc;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }
        
        .chatbot-typing span:nth-child(2) { animation-delay: 0.2s; }
        .chatbot-typing span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        
        /* Rate limit warning */
        .chat-limit-warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px 15px;
            font-size: 0.85em;
            text-align: center;
            border-top: 1px solid #ffc107;
        }
        
        @media (max-width: 480px) {
            .chatbot-window {
                width: calc(100vw - 20px);
                right: -15px;
                bottom: 70px;
            }
        }
    </style>

    <!-- Contextual Reminder Bar -->
    <div class="contextual-reminder" id="contextualReminder">
        <div class="reminder-nav">
            <button class="reminder-nav-btn" onclick="prevReminder()">◀</button>
            <button class="reminder-nav-btn" onclick="nextReminder()">▶</button>
        </div>
        <span class="reminder-icon" id="reminderIcon">💡</span>
        <span class="reminder-text" id="reminderText">Sélectionne une plateforme pour voir les bonnes pratiques</span>
        <button class="reminder-close" onclick="hideReminder()">✕</button>
    </div>

    <!-- Footer légal -->
    <footer class="legal-footer">
        <div class="legal-footer-content">
            <span>© 2025 My Inner Quest</span>
            <div class="legal-footer-links">
                <a href="cgv.html" target="_blank">CGV</a>
                <a href="mentions-legales.html" target="_blank">Mentions légales</a>
                <a href="mailto:contact@myinnerquest.fr">Contact</a>
            </div>
        </div>
    </footer>

    <style>
        .legal-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 10, 15, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 20px;
            z-index: 999;
        }
        .legal-footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.4);
        }
        .legal-footer-links {
            display: flex;
            gap: 20px;
        }
        .legal-footer-links a {
            color: rgba(255, 255, 255, 0.5);
            text-decoration: none;
            transition: color 0.2s;
        }
        .legal-footer-links a:hover {
            color: #667eea;
        }
        @media (max-width: 600px) {
            .legal-footer-content {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            .legal-footer-links {
                gap: 15px;
            }
        }
        /* Ajuster le padding bottom du body pour le footer */
        body {
            padding-bottom: 45px;
        }
    </style>

    <div class="chatbot-widget">
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <div class="chatbot-avatar">🤖</div>
                <div class="chatbot-info">
                    <h3 data-i18n="chatbot.title">Tithot</h3>
                    <p data-i18n="chatbot.subtitle">Assistant IA</p>
                </div>
            </div>
            <div class="chatbot-messages" id="chatbotMessages">
                <!-- Messages will be inserted here -->
            </div>
            <div class="chatbot-input">
                <input type="text" id="chatbotInput" data-i18n-placeholder="chatbot.placeholder" placeholder="Posez votre question..." maxlength="200">
                <button onclick="Chatbot.sendMessage()">➤</button>
            </div>
        </div>
        <button class="chatbot-toggle" id="chatbotToggle" onclick="Chatbot.toggle()">
            <span id="chatbotIcon">💬</span>
        </button>
    </div>

    <script>
        // ==================== CHATBOT FAQ SYSTEM ====================
        const Chatbot = {
            isOpen: false,
            messageCount: 0,
            maxMessages: 20, // Anti-abus : limite par session (augmenté pour IA)
            sessionKey: 'chatbot_session',
            conversationHistory: [], // Historique pour contexte IA
            apiUrl: (typeof CONFIG !== 'undefined' && CONFIG.API_URL)
                ? CONFIG.API_URL + '/api/chat'
                : 'https://sos-storytelling-api.sandra-devonssay.workers.dev/api/chat',
            useAI: true, // Active l'assistant IA (fallback sur FAQ si erreur)
            
            // Base de connaissances FAQ (bilingue)
            faq: [
                {
                    keywords: ['essai', 'gratuit', 'trial', 'tester', 'test', 'free', 'freemium'],
                    answer_fr: "SOS Storytelling est <strong>freemium</strong> : tu peux créer <strong>4 posts + 3 audits gratuits</strong>, sans carte bancaire ! Ensuite, tu choisis de passer à l'offre payante (47€/mois Early Adopter) pour un accès illimité. 🚀",
                    answer_en: "SOS Storytelling is <strong>freemium</strong>: you can create <strong>4 posts + 3 free audits</strong>, no credit card required! Then you choose to upgrade to paid (€47/month Early Adopter) for unlimited access. 🚀"
                },
                {
                    keywords: ['prix', 'tarif', 'coût', 'combien', 'abonnement', 'plan', 'price', 'cost', 'pricing', 'early adopter', '47', '67'],
                    answer_fr: "🚀 <strong>Offre Early Adopter</strong> (jusqu'au 20 février 2026) : <strong>47€/mois</strong> au lieu de 67€ (ou 470€/an). Plans Agence : Starter (10 clients) à 99€/mois, Scale (30 clients) à 199€/mois. 4 posts + 3 audits gratuits pour tester ! 💰",
                    answer_en: "🚀 <strong>Early Adopter Offer</strong> (until Feb 20, 2026): <strong>€47/month</strong> instead of €67 (or €470/year). Agency plans: Starter (10 clients) €99/month, Scale (30 clients) €199/month. 4 posts + 3 free audits to try! 💰"
                },
                {
                    keywords: ['mon style', 'ma voix', 'voix', 'style', 'ton', 'personnaliser', 'voice', 'my voice', 'customize'],
                    answer_fr: "\"<strong>Ma Voix</strong>\" analyse tes textes pour capturer ton style d'écriture unique ! <strong>Conseil :</strong> utilise des textes vraiment écrits par toi (pas générés par IA) pour un résultat authentique. Plus tu ajoutes de textes, plus la fidélité augmente. 🎤",
                    answer_en: "\"<strong>My Voice</strong>\" analyzes your texts to capture your unique writing style! <strong>Tip:</strong> use texts actually written by you (not AI-generated) for an authentic result. The more texts you add, the higher the fidelity. 🎤"
                },
                {
                    keywords: ['planning', 'calendrier', 'planifier', 'programmer', 'calendar', 'schedule'],
                    answer_fr: "Le <strong>Planning IA</strong> génère automatiquement un calendrier éditorial optimisé ! Il équilibre vos piliers de contenu, suggère les meilleurs créneaux, et vous pouvez exporter directement vers Metricool, Swello ou Buffer. 🗓️",
                    answer_en: "<strong>AI Planning</strong> automatically generates an optimized editorial calendar! It balances your content pillars, suggests the best time slots, and you can export directly to Metricool, Swello or Buffer. 🗓️"
                },
                {
                    keywords: ['export', 'metricool', 'swello', 'buffer', 'csv'],
                    answer_fr: "Vous pouvez exporter vos contenus en <strong>un clic</strong> vers Metricool, Swello, Buffer ou en CSV générique. Le format est automatiquement adapté à chaque outil. Pratique pour planifier ! 📤",
                    answer_en: "You can export your content in <strong>one click</strong> to Metricool, Swello, Buffer or generic CSV. The format is automatically adapted to each tool. Handy for scheduling! 📤"
                },
                {
                    keywords: ['agence', 'client', 'multi', 'plusieurs', 'agency', 'clients'],
                    answer_fr: "Le <strong>Mode Agence</strong> permet de gérer plusieurs clients avec des profils de voix distincts ! Import CSV, dashboard analytics, exports bulk... Disponible dès le plan Agence Starter (99€/mois, jusqu'à 10 clients). 🏢",
                    answer_en: "<strong>Agency Mode</strong> lets you manage multiple clients with distinct voice profiles! CSV import, analytics dashboard, bulk exports... Available from Agency Starter plan (€99/month, up to 10 clients). 🏢"
                },
                {
                    keywords: ['structure', 'aida', 'pas', 'storytelling', 'framework'],
                    answer_fr: "Nous proposons <strong>20+ structures narratives</strong> : AIDA (vendre), PAS (problème/solution), Voyage du Héros (inspirer), Pattern Interrupt (surprendre), et bien plus ! Chaque structure est optimisée pour un objectif spécifique. 📖",
                    answer_en: "We offer <strong>20+ narrative structures</strong>: AIDA (sell), PAS (problem/solution), Hero's Journey (inspire), Pattern Interrupt (surprise), and more! Each structure is optimized for a specific goal. 📖"
                },
                {
                    keywords: ['plateforme', 'linkedin', 'instagram', 'tiktok', 'facebook', 'platform'],
                    answer_fr: "SOS Storytelling supporte <strong>7 plateformes</strong> : LinkedIn, Instagram, TikTok, Facebook, Twitter/X, YouTube et newsletters. Chaque contenu est automatiquement optimisé (longueur, ton, hashtags). 📱",
                    answer_en: "SOS Storytelling supports <strong>7 platforms</strong>: LinkedIn, Instagram, TikTok, Facebook, Twitter/X, YouTube and newsletters. Each content is automatically optimized (length, tone, hashtags). 📱"
                },
                {
                    keywords: ['données', 'sécurité', 'rgpd', 'confidential', 'supprimer', 'data', 'security', 'gdpr', 'delete'],
                    answer_fr: "Vos données sont sécurisées sur des serveurs européens avec chiffrement SSL. Elles ne sont <strong>jamais utilisées</strong> pour entraîner des IA externes. Vous pouvez exporter ou supprimer vos données à tout moment (RGPD). 🔒",
                    answer_en: "Your data is secured on European servers with SSL encryption. It is <strong>never used</strong> to train external AI. You can export or delete your data at any time (GDPR). 🔒"
                },
                {
                    keywords: ['annuler', 'résilier', 'arrêter', 'désabonner', 'cancel', 'unsubscribe'],
                    answer_fr: "Vous pouvez annuler votre abonnement <strong>à tout moment</strong>, sans conditions ! L'accès reste actif jusqu'à la fin de la période payée. Vos données restent exportables pendant 30 jours. ✅",
                    answer_en: "You can cancel your subscription <strong>at any time</strong>, no conditions! Access remains active until the end of the paid period. Your data remains exportable for 30 days. ✅"
                },
                {
                    keywords: ['contact', 'aide', 'support', 'problème', 'bug', 'help', 'problem'],
                    answer_fr: "Pour nous contacter : <a href='mailto:contact@myinnerquest.fr'>contact@myinnerquest.fr</a>. Nous répondons généralement sous 24h ! Pour les clients Agence, vous avez un support prioritaire/dédié. 📧",
                    answer_en: "To contact us: <a href='mailto:contact@myinnerquest.fr'>contact@myinnerquest.fr</a>. We typically respond within 24h! For Agency clients, you get priority/dedicated support. 📧"
                },
                {
                    keywords: ['trends', 'tendance', 'idée', 'inspiration', 'trending', 'ideas'],
                    answer_fr: "La fonctionnalité <strong>TRENDS</strong> détecte les sujets tendances de votre secteur ! 5 idées de contenu qui buzzent, adaptées à votre profil. Cliquez sur une idée pour la développer instantanément. 🔥",
                    answer_en: "The <strong>TRENDS</strong> feature detects trending topics in your sector! 5 buzzing content ideas, adapted to your profile. Click on an idea to develop it instantly. 🔥"
                },
                {
                    keywords: ['format', 'carousel', 'reel', 'story', 'video'],
                    answer_fr: "Nous supportons tous les formats : <strong>Post classique</strong>, Carousel, Reel/Short, Story, Thread, Script vidéo, Newsletter... L'IA adapte automatiquement la longueur et le ton ! 🎬",
                    answer_en: "We support all formats: <strong>Classic Post</strong>, Carousel, Reel/Short, Story, Thread, Video Script, Newsletter... AI automatically adapts length and tone! 🎬"
                },
                {
                    keywords: ['api', 'intégration', 'developer', 'technique', 'integration'],
                    answer_fr: "L'<strong>API REST</strong> est disponible sur le plan Enterprise. Elle permet d'intégrer SOS Storytelling dans vos outils existants : CRM, workflows Zapier/Make, apps tierces... Contactez-nous pour en savoir plus ! 🔧",
                    answer_en: "The <strong>REST API</strong> is available on the Enterprise plan. It allows you to integrate SOS Storytelling into your existing tools: CRM, Zapier/Make workflows, third-party apps... Contact us to learn more! 🔧"
                },
                {
                    keywords: ['bonjour', 'salut', 'hello', 'coucou', 'hey', 'hi'],
                    answer_fr: "Bonjour ! 👋 Je suis l'assistant SOS Storytelling. Je peux répondre à vos questions sur les fonctionnalités, les tarifs, Mon Style, le Planning IA... Que souhaitez-vous savoir ?",
                    answer_en: "Hello! 👋 I'm the SOS Storytelling assistant. I can answer your questions about features, pricing, My Voice, AI Planning... What would you like to know?"
                },
                // === QUESTIONS TECHNIQUES & PARCOURS ===
                {
                    keywords: ['créer', 'générer', 'comment', 'faire', 'create', 'generate', 'how to', 'utiliser', 'use'],
                    answer_fr: "Pour créer du contenu : <strong>1)</strong> Cliquez sur l'onglet souhaité (Post, Carousel, Newsletter...) <strong>2)</strong> Remplissez le sujet ou le contexte <strong>3)</strong> Choisissez la plateforme et la structure <strong>4)</strong> Cliquez sur Générer ! L'IA fait le reste en ~10 secondes. ✍️",
                    answer_en: "To create content: <strong>1)</strong> Click on the desired tab (Post, Carousel, Newsletter...) <strong>2)</strong> Fill in the subject or context <strong>3)</strong> Choose the platform and structure <strong>4)</strong> Click Generate! AI does the rest in ~10 seconds. ✍️"
                },
                {
                    keywords: ['commencer', 'débuter', 'premier', 'start', 'begin', 'first', 'onboarding', 'démarrer'],
                    answer_fr: "Pour bien démarrer : <strong>1)</strong> Complète ton profil (domaine, audience, style) <strong>2)</strong> Ajoute 3-5 textes dans \"Ma Voix\" pour personnaliser l'IA <strong>3)</strong> Teste la génération de post ! Tu as 4 posts gratuits pour essayer. Conseil : commence par un post LinkedIn classique. 🚀",
                    answer_en: "To get started: <strong>1)</strong> Complete your profile (domain, audience, style) <strong>2)</strong> Add 3-5 texts in \"My Voice\" to personalize the AI <strong>3)</strong> Try generating a post! You have 4 free posts to try. Tip: start with a classic LinkedIn post. 🚀"
                },
                {
                    keywords: ['profil', 'compte', 'paramètre', 'réglage', 'profile', 'account', 'settings', 'configuration'],
                    answer_fr: "Accédez à votre profil via le bouton <strong>👤 Mon Profil</strong> en haut à droite. Vous pourrez modifier : votre domaine d'expertise, votre audience cible, vos piliers de contenu, et votre style de communication. Ces infos améliorent la pertinence des contenus ! ⚙️",
                    answer_en: "Access your profile via the <strong>👤 My Profile</strong> button in the top right. You can edit: your expertise domain, target audience, content pillars, and communication style. This info improves content relevance! ⚙️"
                },
                {
                    keywords: ['connexion', 'login', 'connecter', 'mot de passe', 'password', 'email', 'inscription', 'register', 'sign'],
                    answer_fr: "Pour vous connecter, utilisez l'email et le mot de passe créés lors de l'inscription. <strong>Mot de passe oublié ?</strong> Cliquez sur \"Mot de passe oublié\" sur la page de connexion. Un lien de réinitialisation vous sera envoyé. 🔑",
                    answer_en: "To log in, use the email and password created during registration. <strong>Forgot your password?</strong> Click \"Forgot password\" on the login page. A reset link will be sent to you. 🔑"
                },
                {
                    keywords: ['carrousel', 'slide', 'diapo', 'carousel', 'slides'],
                    answer_fr: "Pour créer un <strong>carrousel</strong> : allez dans l'onglet Carrousel, entrez votre sujet, et l'IA génère 5-10 slides optimisées ! Vous pouvez copier le texte de chaque slide ou exporter le tout. Parfait pour LinkedIn et Instagram. 🎠",
                    answer_en: "To create a <strong>carousel</strong>: go to the Carousel tab, enter your topic, and AI generates 5-10 optimized slides! You can copy each slide's text or export everything. Perfect for LinkedIn and Instagram. 🎠"
                },
                {
                    keywords: ['inbox', 'message', 'boîte', 'notification', 'reçu'],
                    answer_fr: "L'<strong>Inbox Intelligente</strong> centralise vos messages et notifications ! Vous y trouvez les réponses de l'IA, vos contenus sauvegardés, et les alertes importantes. Cliquez sur l'icône 📥 dans le header pour y accéder.",
                    answer_en: "The <strong>Smart Inbox</strong> centralizes your messages and notifications! You'll find AI responses, saved content, and important alerts. Click the 📥 icon in the header to access it."
                },
                {
                    keywords: ['mission', 'autopilot', 'automatique', 'auto', 'pilote'],
                    answer_fr: "Les <strong>Missions</strong> sont des campagnes automatisées ! Configurez un objectif (prospection, nurturing...), et l'IA génère et planifie les contenus automatiquement. Idéal pour rester actif sans effort quotidien. 🤖",
                    answer_en: "<strong>Missions</strong> are automated campaigns! Set a goal (prospecting, nurturing...), and AI generates and schedules content automatically. Ideal for staying active without daily effort. 🤖"
                },
                {
                    keywords: ['prospect', 'lead', 'crm', 'client potentiel'],
                    answer_fr: "Le module <strong>Prospects</strong> vous permet de gérer vos leads ! Importez-les en CSV, suivez leur engagement, et créez des contenus personnalisés pour chaque prospect. Disponible sur les plans Agence. 📊",
                    answer_en: "The <strong>Prospects</strong> module lets you manage your leads! Import them via CSV, track engagement, and create personalized content for each prospect. Available on Agency plans. 📊"
                },
                {
                    keywords: ['navigateur', 'browser', 'chrome', 'firefox', 'safari', 'mobile', 'téléphone', 'smartphone', 'app'],
                    answer_fr: "SOS Storytelling fonctionne sur tous les navigateurs modernes (Chrome, Firefox, Safari, Edge). L'application est <strong>responsive</strong> et s'adapte aux mobiles, mais nous recommandons un ordinateur pour une expérience optimale. 💻",
                    answer_en: "SOS Storytelling works on all modern browsers (Chrome, Firefox, Safari, Edge). The app is <strong>responsive</strong> and adapts to mobile, but we recommend a computer for the best experience. 💻"
                },
                {
                    keywords: ['erreur', 'bug', 'marche pas', 'fonctionne pas', 'error', 'not working', 'problème technique', 'bloqué'],
                    answer_fr: "Si vous rencontrez une erreur : <strong>1)</strong> Rafraîchissez la page <strong>2)</strong> Videz le cache du navigateur <strong>3)</strong> Essayez un autre navigateur. Si le problème persiste, contactez <a href='mailto:contact@myinnerquest.fr'>contact@myinnerquest.fr</a> avec une capture d'écran. 🔧",
                    answer_en: "If you encounter an error: <strong>1)</strong> Refresh the page <strong>2)</strong> Clear browser cache <strong>3)</strong> Try another browser. If the issue persists, contact <a href='mailto:contact@myinnerquest.fr'>contact@myinnerquest.fr</a> with a screenshot. 🔧"
                },
                {
                    keywords: ['lent', 'long', 'temps', 'slow', 'loading', 'chargement', 'attendre'],
                    answer_fr: "La génération prend généralement <strong>5-15 secondes</strong> selon la longueur du contenu. Si c'est plus long, vérifiez votre connexion internet. Les carrousels et newsletters peuvent prendre un peu plus de temps. ⏱️",
                    answer_en: "Generation usually takes <strong>5-15 seconds</strong> depending on content length. If it's longer, check your internet connection. Carousels and newsletters may take a bit more time. ⏱️"
                },
                {
                    keywords: ['améliorer', 'meilleur', 'qualité', 'improve', 'better', 'quality', 'optimiser'],
                    answer_fr: "Pour de meilleurs résultats : <strong>1)</strong> Soyez précis dans votre sujet <strong>2)</strong> Enrichissez Mon Style avec vos textes <strong>3)</strong> Choisissez la bonne structure narrative <strong>4)</strong> Ajustez manuellement si besoin. La qualité s'améliore avec l'usage ! ✨",
                    answer_en: "For better results: <strong>1)</strong> Be specific in your topic <strong>2)</strong> Enrich My Voice with your texts <strong>3)</strong> Choose the right narrative structure <strong>4)</strong> Manually adjust if needed. Quality improves with use! ✨"
                },
                {
                    keywords: ['langue', 'français', 'anglais', 'language', 'french', 'english', 'traduire', 'translate'],
                    answer_fr: "L'interface est disponible en <strong>français et anglais</strong>. Cliquez sur le bouton 🌐 pour changer de langue. Les contenus sont générés dans la langue de l'interface par défaut, mais vous pouvez demander une autre langue dans votre prompt. 🌍",
                    answer_en: "The interface is available in <strong>French and English</strong>. Click the 🌐 button to change language. Content is generated in the interface language by default, but you can request another language in your prompt. 🌍"
                },
                {
                    keywords: ['copier', 'copy', 'coller', 'paste', 'clipboard', 'sauvegarder', 'save'],
                    answer_fr: "Pour copier un contenu : cliquez sur le bouton <strong>📋 Copier</strong> sous chaque génération. Le texte est automatiquement copié dans votre presse-papier, prêt à être collé dans votre outil de publication ! 📋",
                    answer_en: "To copy content: click the <strong>📋 Copy</strong> button under each generation. The text is automatically copied to your clipboard, ready to paste into your publishing tool! 📋"
                },
                {
                    keywords: ['hashtag', 'emoji', '#', 'tag'],
                    answer_fr: "Les <strong>hashtags</strong> sont générés automatiquement et adaptés à chaque plateforme ! LinkedIn en reçoit 3-5, Instagram jusqu'à 30. Vous pouvez les modifier manuellement après génération. Les emojis sont aussi ajoutés selon le ton choisi. #️⃣",
                    answer_en: "<strong>Hashtags</strong> are generated automatically and adapted to each platform! LinkedIn gets 3-5, Instagram up to 30. You can edit them manually after generation. Emojis are also added based on the chosen tone. #️⃣"
                },
                {
                    keywords: ['historique', 'history', 'précédent', 'retrouver', 'ancien', 'previous', 'old'],
                    answer_fr: "Votre <strong>historique</strong> de contenus générés est accessible via le Dashboard. Vous pouvez retrouver, copier ou regénérer vos anciens contenus à tout moment. L'historique est conservé pendant toute la durée de votre abonnement. 📚",
                    answer_en: "Your generated content <strong>history</strong> is accessible via the Dashboard. You can find, copy or regenerate your old content at any time. History is kept for the duration of your subscription. 📚"
                },
                {
                    keywords: ['merci', 'thanks', 'thank you', 'super', 'génial', 'great', 'awesome', 'parfait', 'perfect'],
                    answer_fr: "Merci à vous ! 😊 N'hésitez pas si vous avez d'autres questions. Bonne création de contenu !",
                    answer_en: "Thank you! 😊 Don't hesitate if you have more questions. Happy content creation!"
                }
            ],

            // Questions suggérées (bilingues)
            quickReplies_fr: [
                "Comment créer mon premier post ?",
                "C'est quoi Ma Voix ?",
                "Quels sont les tarifs ?",
                "💬 Parler à Sandra"
            ],
            quickReplies_en: [
                "How do I create my first post?",
                "What is My Voice?",
                "What are the prices?",
                "💬 Chat with Sandra"
            ],

            getQuickReplies() {
                const lang = I18N?.getLanguage() || 'fr';
                return lang === 'en' ? this.quickReplies_en : this.quickReplies_fr;
            },
            
            init() {
                // Charger la session
                const session = localStorage.getItem(this.sessionKey);
                if (session) {
                    const data = JSON.parse(session);
                    // Reset si plus de 1h
                    if (Date.now() - data.timestamp < 3600000) {
                        this.messageCount = data.count || 0;
                    }
                }
                
                // Afficher le message d'accueil
                this.showWelcome();
                
                // Écouter Enter dans l'input
                document.getElementById('chatbotInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            },
            
            toggle() {
                this.isOpen = !this.isOpen;
                const window = document.getElementById('chatbotWindow');
                const icon = document.getElementById('chatbotIcon');
                const toggle = document.getElementById('chatbotToggle');
                
                if (this.isOpen) {
                    window.classList.add('show');
                    icon.textContent = '✕';
                    toggle.classList.add('open');
                } else {
                    window.classList.remove('show');
                    icon.textContent = '💬';
                    toggle.classList.remove('open');
                }
            },
            
            showWelcome() {
                const messages = document.getElementById('chatbotMessages');
                const lang = I18N?.getLanguage() || 'fr';
                const welcomeMsg = lang === 'en'
                    ? "Hello! 👋 I'm <strong>Tithot</strong>, your AI assistant.<br><br>Ask me anything about SOS Storytelling: how to use features, pricing, troubleshooting... I'm here to help!"
                    : "Salut ! 👋 Je suis <strong>Tithot</strong>, ton assistant IA.<br><br>Pose-moi n'importe quelle question sur SOS Storytelling : comment utiliser les fonctionnalités, les tarifs, résoudre un problème... Je suis là pour t'aider !";
                const quickReplies = this.getQuickReplies();
                messages.innerHTML = `
                    <div class="chat-message bot">
                        <div class="chat-bubble">
                            ${welcomeMsg}
                        </div>
                        <div class="chat-quick-replies">
                            ${quickReplies.map(q => `
                                <button class="chat-quick-btn" onclick="Chatbot.askQuestion('${q.replace(/'/g, "\\'")}')">${q}</button>
                            `).join('')}
                        </div>
                    </div>
                `;
            },
            
            askQuestion(question) {
                // Si c'est "Parler à Sandra", ouvrir directement Tawk
                if (question.includes('Parler à Sandra') || question.includes('Chat with Sandra')) {
                    this.openSupport();
                    return;
                }
                document.getElementById('chatbotInput').value = question;
                this.sendMessage();
            },
            
            async sendMessage() {
                const input = document.getElementById('chatbotInput');
                const message = input.value.trim();

                if (!message) return;

                // Vérifier limite anti-abus
                if (this.messageCount >= this.maxMessages) {
                    this.showLimitWarning();
                    return;
                }

                // Afficher le message utilisateur
                this.addMessage(message, 'user');
                this.conversationHistory.push({ role: 'user', content: message });
                input.value = '';

                // Incrémenter et sauvegarder
                this.messageCount++;
                localStorage.setItem(this.sessionKey, JSON.stringify({
                    count: this.messageCount,
                    timestamp: Date.now()
                }));

                // Afficher "typing"
                this.showTyping();

                // Appeler l'API IA ou fallback FAQ
                let answer;
                if (this.useAI) {
                    answer = await this.callAIAssistant(message);
                } else {
                    answer = this.findAnswerInFAQ(message);
                }

                this.hideTyping();
                this.addMessage(answer, 'bot');
                this.conversationHistory.push({ role: 'assistant', content: answer });
            },

            async callAIAssistant(message) {
                const lang = I18N?.getLanguage() || 'fr';

                try {
                    const response = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: message,
                            conversationHistory: this.conversationHistory.slice(-10),
                            language: lang
                        })
                    });

                    if (!response.ok) {
                        throw new Error('API error');
                    }

                    const data = await response.json();

                    if (data.success && data.message) {
                        return data.message;
                    } else if (data.fallback) {
                        return data.fallback;
                    } else {
                        throw new Error('Invalid response');
                    }
                } catch (error) {
                    console.warn('AI Assistant fallback to FAQ:', error);
                    // Fallback sur le FAQ local en cas d'erreur
                    return this.findAnswerInFAQ(message);
                }
            },

            findAnswerInFAQ(question) {
                const q = question.toLowerCase();
                const lang = I18N?.getLanguage() || 'fr';

                // Chercher dans la FAQ
                for (const item of this.faq) {
                    for (const keyword of item.keywords) {
                        if (q.includes(keyword)) {
                            return lang === 'en' ? item.answer_en : item.answer_fr;
                        }
                    }
                }

                // Réponse par défaut (fallback avec bouton support)
                return lang === 'en'
                    ? "I'm not sure I understand your question. 🤔<br><br>Try rephrasing with words like: pricing, free, My Voice, planning, export...<br><br><button class='chat-support-btn' onclick='Chatbot.openSupport()'>💬 Chat with Sandra</button>"
                    : "Je ne suis pas sûr de comprendre ta question. 🤔<br><br>Essaie de reformuler avec des mots comme : tarif, gratuit, Ma Voix, planning, export...<br><br><button class='chat-support-btn' onclick='Chatbot.openSupport()'>💬 Parler à Sandra</button>";
            },
            
            addMessage(content, type) {
                const messages = document.getElementById('chatbotMessages');
                const div = document.createElement('div');
                div.className = `chat-message ${type}`;
                div.innerHTML = `<div class="chat-bubble">${content}</div>`;
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            },
            
            showTyping() {
                const messages = document.getElementById('chatbotMessages');
                const div = document.createElement('div');
                div.className = 'chat-message bot';
                div.id = 'chatTyping';
                div.innerHTML = `
                    <div class="chat-bubble">
                        <div class="chatbot-typing">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                `;
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            },
            
            hideTyping() {
                const typing = document.getElementById('chatTyping');
                if (typing) typing.remove();
            },
            
            showLimitWarning() {
                const messages = document.getElementById('chatbotMessages');

                // Vérifier si déjà affiché
                if (document.querySelector('.chat-limit-warning')) return;

                const lang = I18N?.getLanguage() || 'fr';
                const warning = document.createElement('div');
                warning.className = 'chat-limit-warning';
                warning.innerHTML = lang === 'en'
                    ? `⚠️ You've reached the message limit.<br><button class='chat-support-btn' onclick='Chatbot.openSupport()'>💬 Chat with Sandra</button>`
                    : `⚠️ Tu as atteint la limite de messages.<br><button class='chat-support-btn' onclick='Chatbot.openSupport()'>💬 Parler à Sandra</button>`;
                messages.parentElement.insertBefore(warning, messages.nextSibling);
            },

            openSupport() {
                // Ouvrir Tawk.to
                if (typeof Tawk_API !== 'undefined' && Tawk_API.maximize) {
                    Tawk_API.maximize();
                    // Fermer Tithot
                    this.isOpen = false;
                    document.getElementById('chatbotWindow').classList.remove('show');
                    document.getElementById('chatbotIcon').textContent = '💬';
                    document.getElementById('chatbotToggle').classList.remove('open');
                } else {
                    // Fallback si Tawk pas chargé
                    window.open('mailto:contact@myinnerquest.fr', '_blank');
                }
            }
        };
        
        // Initialiser le chatbot au chargement
        document.addEventListener('DOMContentLoaded', () => {
            Chatbot.init();
        });
    </script>

    <!-- DÉSACTIVÉ - Module Newsletter (conservé pour plus tard)
    <script src="newsletter-module.js"></script>
    -->
    <script>
        // Email Choice Modal Functions
        function showEmailChoiceModal() {
            document.getElementById('emailChoiceModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeEmailChoiceModal() {
            document.getElementById('emailChoiceModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Fermer en cliquant sur l'overlay
        document.getElementById('emailChoiceModal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeEmailChoiceModal();
            }
        });

        // Newsletter Modal Functions
        let newsletterModuleInitialized = false;

        function showNewsletterModal() {
            const modal = document.getElementById('newsletterModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Scroll en haut de la modal
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) modalContent.scrollTop = 0;

            // Initialiser le module Newsletter si pas encore fait
            if (!newsletterModuleInitialized && typeof initNewsletterModule === 'function') {
                initNewsletterModule();
                newsletterModuleInitialized = true;
            }
        }

        function closeNewsletterModal() {
            document.getElementById('newsletterModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Afficher l'historique des newsletters
        function showNewsletterHistory() {
            const saved = JSON.parse(localStorage.getItem('sos_newsletters') || '[]');

            const modalHTML = `
                <div class="modal-overlay active" id="newsletterHistoryModal" onclick="if(event.target.classList.contains('modal-overlay')) this.remove()">
                    <div class="modal" style="max-width: 700px; width: 90vw; max-height: 85vh; overflow: hidden;" onclick="event.stopPropagation()">
                        <div class="modal-header" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                            <h2 style="color: white;">📋 Mes newsletters</h2>
                            <button class="modal-close" onclick="document.getElementById('newsletterHistoryModal').remove()" style="color: white;">&times;</button>
                        </div>
                        <div style="padding: 20px; max-height: calc(85vh - 80px); overflow-y: auto;">
                            ${saved.length === 0 ? `
                                <div style="text-align: center; padding: 40px; color: #666;">
                                    <div style="font-size: 3em; margin-bottom: 15px;">📭</div>
                                    <p>Aucune newsletter sauvegardée pour le moment.</p>
                                    <button onclick="document.getElementById('newsletterHistoryModal').remove(); showNewsletterModal();" class="btn" style="margin-top: 15px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 25px; border: none; border-radius: 10px; cursor: pointer;">
                                        ✨ Créer ma première newsletter
                                    </button>
                                </div>
                            ` : `
                                <div style="display: flex; flex-direction: column; gap: 15px;">
                                    ${saved.map((nl, i) => `
                                        <div class="newsletter-history-card" style="background: #f8f9fa; border-radius: 12px; padding: 15px; border: 1px solid #e0e0e0;">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                                <div>
                                                    <span style="font-weight: 700; color: #333;">${nl.emails?.[0]?.selectedSubject || nl.emails?.[0]?.subjectLines?.[0] || 'Newsletter sans titre'}</span>
                                                    ${nl.isSequence ? '<span style="background: #667eea; color: white; font-size: 0.7em; padding: 2px 8px; border-radius: 10px; margin-left: 8px;">Séquence ${nl.emails?.length || 0} emails</span>' : ''}
                                                </div>
                                                <span style="font-size: 0.8em; color: #888;">${new Date(nl.createdAt).toLocaleDateString('fr-FR')}</span>
                                            </div>
                                            <div style="font-size: 0.85em; color: #666; margin-bottom: 12px;">
                                                ${nl.emails?.[0]?.previewText?.substring(0, 100) || 'Pas de preview'}...
                                            </div>
                                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                                <span style="background: #e0e0e0; padding: 3px 10px; border-radius: 15px; font-size: 0.75em;">${nl.newsletterType || 'Type inconnu'}</span>
                                                <span style="background: #e0e0e0; padding: 3px 10px; border-radius: 15px; font-size: 0.75em;">${nl.structure || 'Structure inconnue'}</span>
                                                <span style="background: #e0e0e0; padding: 3px 10px; border-radius: 15px; font-size: 0.75em;">${nl.tone || 'Ton inconnu'}</span>
                                            </div>
                                            <div style="display: flex; gap: 10px; margin-top: 12px;">
                                                <button onclick="copyNewsletterFromHistory(${i})" style="flex: 1; padding: 8px; background: white; border: 1px solid #667eea; color: #667eea; border-radius: 8px; cursor: pointer; font-size: 0.85em;">📋 Copier</button>
                                                <button onclick="deleteNewsletterFromHistory(${i})" style="padding: 8px 15px; background: white; border: 1px solid #e74c3c; color: #e74c3c; border-radius: 8px; cursor: pointer; font-size: 0.85em;">🗑️</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function copyNewsletterFromHistory(index) {
            const saved = JSON.parse(localStorage.getItem('sos_newsletters') || '[]');
            const nl = saved[index];
            if (!nl) return;

            const email = nl.emails?.[0];
            if (!email) return;

            const text = \`Objet: \${email.selectedSubject || email.subjectLines?.[0] || ''}

Preview: \${email.previewText || ''}

\${email.body || ''}\`;

            navigator.clipboard.writeText(text).then(() => {
                showToast('✅ Newsletter copiée !');
            });
        }

        function deleteNewsletterFromHistory(index) {
            if (!confirm('Supprimer cette newsletter ?')) return;

            const saved = JSON.parse(localStorage.getItem('sos_newsletters') || '[]');
            saved.splice(index, 1);
            localStorage.setItem('sos_newsletters', JSON.stringify(saved));

            // Refresh la modal
            document.getElementById('newsletterHistoryModal')?.remove();
            showNewsletterHistory();
            showToast('✅ Newsletter supprimée');
        }

        // Fermer le modal en cliquant sur l'overlay
        document.getElementById('newsletterModal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeNewsletterModal();
            }
        });
    </script>

    <!-- Module Charte Éthique Prospection -->
    <script>
        // Gestion de la charte éthique prospection
        let ethicsPendingAction = null;

        function hasAcceptedEthicsCharter() {
            return localStorage.getItem('sos_ethics_accepted') === 'true';
        }

        function showEthicsModal(pendingAction) {
            ethicsPendingAction = pendingAction;
            document.getElementById('ethicsModal').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Reset checkbox
            const checkbox = document.getElementById('ethicsAcceptCheckbox');
            const btn = document.getElementById('ethicsAcceptBtn');
            if (checkbox) checkbox.checked = false;
            if (btn) {
                btn.disabled = true;
                btn.style.opacity = '0.5';
            }
        }

        function closeEthicsModal(accepted) {
            document.getElementById('ethicsModal').classList.remove('active');
            document.body.style.overflow = '';

            if (!accepted) {
                ethicsPendingAction = null;
            }
        }

        function acceptEthicsCharter() {
            // Sauvegarder l'acceptation
            localStorage.setItem('sos_ethics_accepted', 'true');
            localStorage.setItem('sos_ethics_accepted_at', new Date().toISOString());

            // Sauvegarder en BDD si connecté
            if (window.supabaseApp) {
                supabaseApp.auth.getUser().then(({ data: { user } }) => {
                    if (user) {
                        supabaseApp.from('users').update({
                            ethics_accepted: true,
                            ethics_accepted_at: new Date().toISOString()
                        }).eq('id', user.id);
                    }
                });
            }

            closeEthicsModal(true);

            // Exécuter l'action en attente
            if (ethicsPendingAction === 'prospects') {
                showProspectsModalDirect();
            } else if (ethicsPendingAction === 'campaigns') {
                showCampaignsModalDirect();
            } else if (ethicsPendingAction === 'import') {
                // L'import continuera via le module prospects
            }
            ethicsPendingAction = null;

            showNotification('✅ Charte acceptée. Merci de prospecter de manière éthique !', 'success');
        }

        // Activer/désactiver le bouton selon la checkbox
        document.addEventListener('DOMContentLoaded', () => {
            const checkbox = document.getElementById('ethicsAcceptCheckbox');
            const btn = document.getElementById('ethicsAcceptBtn');
            if (checkbox && btn) {
                checkbox.addEventListener('change', () => {
                    btn.disabled = !checkbox.checked;
                    btn.style.opacity = checkbox.checked ? '1' : '0.5';
                });
            }

            // Fermer modal au clic sur overlay
            document.getElementById('ethicsModal')?.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeEthicsModal(false);
                }
            });
        });
    </script>

    <!-- Module Alertes Abus -->
    <script>
        // Vérifier les alertes abus au chargement
        async function checkAbuseAlerts() {
            if (!window.supabaseApp) return;

            try {
                const { data: { user } } = await supabaseApp.auth.getUser();
                if (!user) return;

                // Récupérer les alertes non résolues
                const { data: alerts } = await supabaseApp
                    .from('abuse_alerts')
                    .select('*')
                    .eq('user_id', user.id)
                    .is('resolved_at', null)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (alerts && alerts.length > 0) {
                    showAbuseAlertBanner(alerts[0]);
                }
            } catch (e) {
                console.log('Erreur vérification alertes:', e);
            }
        }

        function showAbuseAlertBanner(alert) {
            const banner = document.getElementById('abuseAlertBanner');
            const message = document.getElementById('abuseAlertMessage');
            if (!banner || !message) return;

            message.textContent = alert.message;
            banner.className = 'abuse-alert-banner ' + (alert.severity || 'warning');
            banner.style.display = 'block';
            banner.dataset.alertId = alert.id;

            // Si suspendu, bloquer l'accès aux fonctionnalités
            if (alert.severity === 'suspended') {
                window.accountSuspended = true;
            }
        }

        function dismissAbuseAlert() {
            const banner = document.getElementById('abuseAlertBanner');
            if (banner) {
                banner.style.display = 'none';

                // Marquer comme acquitté si warning
                const alertId = banner.dataset.alertId;
                if (alertId && window.supabaseApp) {
                    supabaseApp.from('abuse_alerts')
                        .update({ acknowledged: true, acknowledged_at: new Date().toISOString() })
                        .eq('id', alertId);
                }
            }
        }

        function showAbuseDetails() {
            // Afficher un modal avec les détails et recommandations
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white;">
                        <h2>⚠️ Alerte Délivrabilité</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()" style="color: white;">&times;</button>
                    </div>
                    <div style="padding: 25px;">
                        <h3 style="color: #e74c3c; margin-bottom: 15px;">Pourquoi cette alerte ?</h3>
                        <p style="margin-bottom: 20px; color: #555; line-height: 1.6;">
                            Votre compte présente des indicateurs de délivrabilité préoccupants qui peuvent impacter votre réputation d'expéditeur.
                        </p>

                        <h3 style="color: #333; margin-bottom: 15px;">📋 Actions recommandées</h3>
                        <ul style="color: #555; line-height: 2; padding-left: 20px;">
                            <li>✅ Vérifiez la qualité de votre liste de prospects</li>
                            <li>✅ Supprimez les emails invalides ou inactifs</li>
                            <li>✅ Réduisez votre volume d'envoi quotidien</li>
                            <li>✅ Améliorez la personnalisation de vos emails</li>
                            <li>✅ Vérifiez votre configuration DNS (SPF/DKIM/DMARC)</li>
                        </ul>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 20px;">
                            <p style="color: #666; font-size: 0.9em; margin: 0;">
                                💡 <strong>Besoin d'aide ?</strong> Contactez le support à support@sosstorytelling.fr
                            </p>
                        </div>

                        <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()" style="width: 100%; margin-top: 20px; padding: 15px;">
                            J'ai compris
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Vérifier les alertes au chargement
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkAbuseAlerts, 2000);
        });
    </script>

    <!-- DÉSACTIVÉ - Module Prospects (conservé pour plus tard)
    <script src="prospects-module.js?v=20251225d"></script>
    -->
    <script>
        let prospectsModuleInitialized = false;

        // Version directe sans vérification éthique (appelée après acceptation)
        function showProspectsModalDirect() {
            document.getElementById('prospectsModal').classList.add('active');
            document.body.style.overflow = 'hidden';

            if (typeof ProspectsModule !== 'undefined') {
                if (!prospectsModuleInitialized) {
                    ProspectsModule.init().then(() => {
                        const container = document.getElementById('prospectsContent');
                        if (container) {
                            container.innerHTML = '';
                            container.appendChild(ProspectsModule.createProspectsPage());
                            ProspectsModule.renderProspectsList();
                        }
                    });
                    prospectsModuleInitialized = true;
                } else {
                    ProspectsModule.loadProspects().then(() => {
                        ProspectsModule.renderProspectsList();
                    });
                }
            }
        }

        // Version avec vérification éthique
        function showProspectsModal() {
            if (!hasAcceptedEthicsCharter()) {
                showEthicsModal('prospects');
                return;
            }
            showProspectsModalDirect();
        }

        function closeProspectsModal() {
            document.getElementById('prospectsModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        document.getElementById('prospectsModal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeProspectsModal();
            }
        });
    </script>

    <!-- Module Brevo Config -->
    <script>
        // Brevo Configuration
        function showBrevoConfigModal() {
            document.getElementById('brevoConfigModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            loadBrevoConfig();
        }

        function closeBrevoConfigModal() {
            document.getElementById('brevoConfigModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function toggleDeliverabilityGuide() {
            const guide = document.getElementById('deliverabilityGuide');
            const arrow = document.getElementById('deliverabilityArrow');
            if (guide.style.display === 'none') {
                guide.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                guide.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        document.getElementById('brevoConfigModal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeBrevoConfigModal();
            }
        });

        function toggleBrevoKeyVisibility(checkbox) {
            const input = document.getElementById('brevoApiKey');
            input.type = checkbox.checked ? 'text' : 'password';
        }

        async function loadBrevoConfig() {
            // Charger depuis Supabase si connecté
            if (window.supabase?.auth) {
                try {
                    const { data: { user } } = await window.supabase.auth.getUser();
                    if (user) {
                        const { data } = await window.supabase
                            .from('user_settings')
                            .select('brevo_api_key, sender_email, sender_name')
                            .eq('user_id', user.id)
                            .single();

                        if (data) {
                            if (data.brevo_api_key) {
                                document.getElementById('brevoApiKey').value = data.brevo_api_key;
                            }
                            if (data.sender_email) {
                                document.getElementById('brevoSenderEmail').value = data.sender_email;
                            }
                            if (data.sender_name) {
                                document.getElementById('brevoSenderName').value = data.sender_name;
                            }
                        }
                    }
                } catch (e) {
                    console.log('Pas de config Brevo sauvegardée');
                }
            }

            // Fallback localStorage
            const saved = localStorage.getItem('sos_brevo_config');
            if (saved) {
                const config = JSON.parse(saved);
                if (!document.getElementById('brevoApiKey').value && config.apiKey) {
                    document.getElementById('brevoApiKey').value = config.apiKey;
                }
                if (!document.getElementById('brevoSenderEmail').value && config.senderEmail) {
                    document.getElementById('brevoSenderEmail').value = config.senderEmail;
                }
                if (!document.getElementById('brevoSenderName').value && config.senderName) {
                    document.getElementById('brevoSenderName').value = config.senderName;
                }
            }
        }

        async function testBrevoConnection() {
            const apiKey = document.getElementById('brevoApiKey').value.trim();
            const statusDiv = document.getElementById('brevoConnectionStatus');

            if (!apiKey) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = '⚠️ Entre ta clé API Brevo pour tester la connexion.';
                return;
            }

            statusDiv.style.display = 'block';
            statusDiv.style.background = '#e8f4fd';
            statusDiv.style.color = '#0066FF';
            statusDiv.innerHTML = '🔄 Test de connexion en cours...';

            try {
                const response = await fetch('https://api.brevo.com/v3/account', {
                    method: 'GET',
                    headers: {
                        'accept': 'application/json',
                        'api-key': apiKey
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.innerHTML = `✅ Connexion réussie ! Compte: <strong>${data.email}</strong><br>Crédits emails: ${data.plan?.[0]?.credits || 'Illimité'}`;
                } else {
                    throw new Error('Clé API invalide');
                }
            } catch (error) {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = '❌ Échec de connexion. Vérifie ta clé API.';
            }
        }

        async function saveBrevoConfig() {
            const apiKey = document.getElementById('brevoApiKey').value.trim();
            const senderEmail = document.getElementById('brevoSenderEmail').value.trim();
            const senderName = document.getElementById('brevoSenderName').value.trim();
            const statusDiv = document.getElementById('brevoConnectionStatus');

            if (!apiKey) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = '⚠️ La clé API est obligatoire.';
                return;
            }

            if (!senderEmail) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = '⚠️ L\'email d\'expédition est obligatoire.';
                return;
            }

            // Sauvegarder dans Supabase si connecté
            if (window.supabase?.auth) {
                try {
                    const { data: { user } } = await window.supabase.auth.getUser();
                    if (user) {
                        await window.supabase
                            .from('user_settings')
                            .upsert({
                                user_id: user.id,
                                brevo_api_key: apiKey,
                                sender_email: senderEmail,
                                sender_name: senderName || senderEmail.split('@')[0],
                                updated_at: new Date().toISOString()
                            }, { onConflict: 'user_id' });
                    }
                } catch (e) {
                    console.error('Erreur sauvegarde Supabase:', e);
                }
            }

            // Sauvegarder aussi en localStorage (backup)
            localStorage.setItem('sos_brevo_config', JSON.stringify({
                apiKey,
                senderEmail,
                senderName: senderName || senderEmail.split('@')[0]
            }));

            statusDiv.style.display = 'block';
            statusDiv.style.background = '#d4edda';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = '✅ Configuration sauvegardée ! Tu peux maintenant utiliser l\'Autopilot.';

            // Fermer après 2s
            setTimeout(() => {
                closeBrevoConfigModal();
            }, 2000);
        }
    </script>

    <!-- DÉSACTIVÉ - Module Campagnes (conservé pour plus tard)
    <script src="campaigns-module.js?v=1733400080"></script>
    <script src="sender-emails-module.js?v=20260109"></script>
    -->
    <script src="reports-module.js?v=20260109"></script>
    <script>
        let campaignsModuleInitialized = false;

        // Version directe sans vérification éthique (appelée après acceptation)
        function showCampaignsModalDirect() {
            const modal = document.getElementById('campaignsModal');
            if (!modal) {
                console.error('Modal campaignsModal non trouvé');
                return;
            }
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            const container = document.getElementById('campaignsContent');

            if (typeof CampaignsModule === 'undefined') {
                console.error('CampaignsModule non chargé');
                if (container) {
                    container.innerHTML = '<div style="padding: 40px; text-align: center;"><p>Chargement du module...</p><p style="color: #999; font-size: 0.9em;">Si ce message persiste, rechargez la page.</p></div>';
                }
                return;
            }

            if (!campaignsModuleInitialized) {
                CampaignsModule.init().then(() => {
                    if (container) {
                        container.innerHTML = '';
                        container.appendChild(CampaignsModule.createCampaignsPage());
                        CampaignsModule.renderCampaignsList();
                    }
                }).catch(err => {
                    console.error('Erreur init CampaignsModule:', err);
                    if (container) {
                        container.innerHTML = '<div style="padding: 40px; text-align: center; color: red;">Erreur de chargement. Rechargez la page.</div>';
                    }
                });
                campaignsModuleInitialized = true;
            }
        }

        // Version avec vérification éthique
        function showCampaignsModal() {
            if (!hasAcceptedEthicsCharter()) {
                showEthicsModal('campaigns');
                return;
            }
            showCampaignsModalDirect();
        }

        function closeCampaignsModal() {
            document.getElementById('campaignsModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // ============ REPORTS MODAL ============
        let reportsModuleInitialized = false;

        function showReportsModal() {
            const modal = document.getElementById('reportsModal');
            if (!modal) return;

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            const container = document.getElementById('reportsContent');

            if (typeof ReportsModule === 'undefined') {
                if (container) {
                    container.innerHTML = '<div style="padding: 40px; text-align: center;"><p>Chargement...</p></div>';
                }
                return;
            }

            if (!reportsModuleInitialized) {
                ReportsModule.init().then(() => {
                    if (container) {
                        container.innerHTML = '';
                        container.appendChild(ReportsModule.createReportsPage());
                    }
                }).catch(err => {
                    console.error('Erreur init ReportsModule:', err);
                });
                reportsModuleInitialized = true;
            } else {
                ReportsModule.renderReportsContent();
            }
        }

        function closeReportsModal() {
            document.getElementById('reportsModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Ouvrir directement le wizard nouvelle campagne (depuis le choix email)
        function openNewCampaignDirect() {
            if (typeof CampaignsModule !== 'undefined') {
                CampaignsModule.init().then(() => {
                    CampaignsModule.openNewCampaignWizard();
                });
            } else {
                alert('Module de prospection non chargé. Rechargez la page.');
            }
        }

        document.getElementById('campaignsModal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeCampaignsModal();
            }
        });
    </script>

    <script>
        // Initialiser les modules au chargement
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialiser le module Prospecter
            if (typeof ProspecterModule !== 'undefined') {
                ProspecterModule.init();
            }

            // Afficher le hint paramètres
            showSettingsHintIfNeeded();

            // Verifier si des leads sont passes via URL (extension Sales Navigator)
            checkForLeadsImport();
        });

        // Fonction pour afficher le hint paramètres
        function showSettingsHintIfNeeded() {
            if (localStorage.getItem('settings_hint_dismissed')) return;

            const hint = document.getElementById('settingsHint');
            const overlay = document.getElementById('settingsHintOverlay');
            if (hint) {
                hint.classList.add('show');
                if (overlay) overlay.classList.add('show');
            }
        }

        // Fermer le hint paramètres
        function closeSettingsHint(permanent = false) {
            const hint = document.getElementById('settingsHint');
            const overlay = document.getElementById('settingsHintOverlay');
            if (hint) {
                hint.classList.remove('show');
                if (overlay) overlay.classList.remove('show');
                if (permanent) {
                    localStorage.setItem('settings_hint_dismissed', 'true');
                }
            }
        }

        // Verifier et importer les leads depuis l'URL (extension Sales Navigator)
        async function checkForLeadsImport() {
            const urlParams = new URLSearchParams(window.location.search);
            const leadsData = urlParams.get('import_leads');

            if (!leadsData) return;

            try {
                const leads = JSON.parse(decodeURIComponent(leadsData));

                if (!leads || leads.length === 0) return;

                // Nettoyer l'URL
                window.history.replaceState({}, document.title, window.location.pathname);

                // Afficher modal de confirmation
                showLeadsImportModal(leads);
            } catch (error) {
                console.error('Erreur import leads:', error);
                showToast('Erreur lors de l\'import des leads', 'error');
            }
        }

        // Modal pour confirmer l'import des leads
        function showLeadsImportModal(leads) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'leadsImportModal';
            modal.innerHTML = [
                '<div class="modal" style="max-width: 600px;">',
                '<div class="modal-header" style="background: linear-gradient(135deg, #0077B5, #00A0DC); color: white;">',
                '<h3 style="color: white;">Import Sales Navigator</h3>',
                '<button class="modal-close" onclick="document.getElementById(\'leadsImportModal\').remove()" style="color: white;">&times;</button>',
                '</div>',
                '<div class="modal-body" style="padding: 25px;">',
                '<div style="text-align: center; margin-bottom: 20px;">',
                '<div style="font-size: 3em;">🎉</div>',
                '<h4>' + leads.length + ' lead(s) prets a importer</h4>',
                '</div>',
                '<div style="max-height: 200px; overflow-y: auto; margin-bottom: 20px; background: #f8f9fa; border-radius: 10px; padding: 15px;">',
                leads.slice(0, 10).map(function(l) {
                    return '<div style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>' + l.first_name + ' ' + l.last_name + '</strong><br><span style="color: #666; font-size: 0.9em;">' + (l.job_title || '') + (l.company ? ' @ ' + l.company : '') + '</span></div>';
                }).join(''),
                leads.length > 10 ? '<div style="padding: 8px 0; color: #888;">+ ' + (leads.length - 10) + ' autre(s)...</div>' : '',
                '</div>',
                '<button class="btn btn-primary" style="width: 100%; padding: 15px;" onclick="importLeadsFromExtension()">',
                'Importer dans mes prospects',
                '</button>',
                '</div>',
                '</div>'
            ].join('');

            // Stocker les leads temporairement
            window._pendingLeadsImport = leads;

            document.body.appendChild(modal);
            modal.classList.add('active');
        }

        // Importer les leads dans Supabase
        async function importLeadsFromExtension() {
            const leads = window._pendingLeadsImport;
            if (!leads || leads.length === 0) return;

            const btn = document.querySelector('#leadsImportModal .btn-primary');
            btn.disabled = true;
            btn.textContent = 'Import en cours...';

            try {
                const user = await getCurrentUser();
                if (!user) {
                    showToast('Connectez-vous pour importer les leads', 'error');
                    return;
                }

                // Formater les leads pour Supabase
                const formattedLeads = leads.map(function(lead) {
                    var firstName = (lead.first_name || 'unknown').toLowerCase().replace(/[^a-z]/g, '');
                    var lastName = (lead.last_name || '').toLowerCase().replace(/[^a-z]/g, '');
                    var company = (lead.company || 'unknown').toLowerCase().replace(/[^a-z0-9]/g, '').slice(0, 20);
                    var uniqueId = '';
                    if (lead.linkedin_url) {
                        var match = lead.linkedin_url.match(/\/in\/([^\/]+)/);
                        if (match) uniqueId = match[1].slice(0, 10);
                    }
                    var email = firstName + '.' + lastName + (uniqueId ? '.' + uniqueId : '') + '@' + company + '.linkedin.placeholder';

                    return {
                        user_id: user.id,
                        email: email,
                        first_name: lead.first_name,
                        last_name: lead.last_name,
                        job_title: lead.job_title,
                        company: lead.company,
                        linkedin_url: lead.linkedin_url,
                        city: lead.location,
                        source: 'linkedin_extension',
                        status: 'new'
                    };
                });

                // Inserer dans Supabase
                var imported = 0;
                var duplicates = 0;

                console.log('[SOS Import] Inserting', formattedLeads.length, 'leads');
                console.log('[SOS Import] First lead:', formattedLeads[0]);

                for (var i = 0; i < formattedLeads.length; i++) {
                    var lead = formattedLeads[i];
                    var result = await window.supabaseApp.from('prospects').insert(lead);

                    console.log('[SOS Import] Lead', i, 'result:', result);

                    if (!result.error) {
                        imported++;
                    } else {
                        console.error('[SOS Import] Error inserting lead:', result.error);
                        if (result.error.code === '23505') {
                            duplicates++;
                        }
                    }
                }

                showToast(imported + ' lead(s) importes ! ' + (duplicates > 0 ? '(' + duplicates + ' doublons ignores)' : ''), 'success');

                // Fermer le modal et ouvrir les prospects
                document.getElementById('leadsImportModal').remove();
                window._pendingLeadsImport = null;

                // Rafraichir le module prospects si charge
                if (typeof ProspectsModule !== 'undefined') {
                    await ProspectsModule.loadProspects();
                }

                // Ouvrir la modal prospects
                showProspectsModal();

            } catch (error) {
                console.error('Erreur import:', error);
                showToast('Erreur: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'Reessayer';
            }
        }

        // Helper pour obtenir l'utilisateur courant
        async function getCurrentUser() {
            if (!window.supabaseApp) return null;
            var result = await window.supabaseApp.auth.getUser();
            return result.data ? result.data.user : null;
        }
    </script>

    <!-- Bandeau Cookies RGPD -->
    <div id="cookieBanner" class="cookie-banner">
        <div class="cookie-content">
            <div class="cookie-text">
                <span class="cookie-icon">🍪</span>
                <p>Ce site utilise uniquement des <strong>cookies essentiels</strong> pour votre authentification et vos préférences. Aucun cookie publicitaire ou de tracking.
                <a href="mentions-legales.html#cookies" target="_blank">En savoir plus</a></p>
            </div>
            <div class="cookie-actions">
                <button class="cookie-btn cookie-btn-accept" onclick="acceptCookies()">J'accepte</button>
            </div>
        </div>
    </div>

    <style>
        .cookie-banner {
            position: fixed;
            bottom: 45px; /* Au-dessus du footer légal */
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-top: 2px solid #667eea;
            padding: 15px 20px;
            z-index: 10000;
            display: none;
            animation: slideUpCookie 0.4s ease;
        }
        .cookie-banner.show {
            display: block;
        }
        @keyframes slideUpCookie {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .cookie-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }
        .cookie-text {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        .cookie-icon {
            font-size: 1.8em;
        }
        .cookie-text p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9em;
            margin: 0;
            line-height: 1.5;
        }
        .cookie-text a {
            color: #667eea;
            text-decoration: underline;
        }
        .cookie-text a:hover {
            color: #f5576c;
        }
        .cookie-actions {
            display: flex;
            gap: 10px;
        }
        .cookie-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 25px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .cookie-btn-accept {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
        }
        .cookie-btn-accept:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
        }
        @media (max-width: 600px) {
            .cookie-content {
                flex-direction: column;
                text-align: center;
            }
            .cookie-text {
                flex-direction: column;
            }
            .cookie-banner {
                bottom: 60px; /* Plus d'espace sur mobile */
            }
        }
    </style>

    <script>
        // Gestion du bandeau cookies
        function initCookieBanner() {
            const cookiesAccepted = localStorage.getItem('cookies_accepted');
            if (!cookiesAccepted) {
                document.getElementById('cookieBanner').classList.add('show');
            }
        }

        function acceptCookies() {
            localStorage.setItem('cookies_accepted', JSON.stringify({
                accepted: true,
                date: new Date().toISOString()
            }));
            document.getElementById('cookieBanner').classList.remove('show');
        }

        // Initialiser au chargement
        document.addEventListener('DOMContentLoaded', initCookieBanner);
    </script>

    <!-- DÉSACTIVÉ - Module Inbox Intelligente (conservé pour plus tard)
    <script src="inbox-module.js?v=20260102"></script>
    -->
    <script>
        let inboxInitialized = false;

        // Ouvrir le modal Inbox
        function showInboxModal() {
            document.getElementById('inboxModal').classList.add('active');

            // Initialiser le module si pas encore fait
            if (!inboxInitialized && typeof InboxModule !== 'undefined') {
                InboxModule.init();
                inboxInitialized = true;
            }
        }

        // Fermer le modal Inbox
        function closeInboxModal() {
            document.getElementById('inboxModal').classList.remove('active');
        }

        // Fermer en cliquant sur l'overlay
        document.getElementById('inboxModal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeInboxModal();
            }
        });

        // Vérifier les paramètres OAuth au chargement
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');

            if (code && state === 'gmail_oauth') {
                // Ouvrir automatiquement l'inbox pour traiter le callback
                showInboxModal();
            }
        });
    </script>

    <!-- Module Collaboration (Workspaces, Team, Comments, Notifications) -->
    <script src="collaboration-module.js?v=20260107"></script>

    <!-- Module Audit RS -->
    <script src="audit-module.js?v=20260126f"></script>
    <script>
        // Afficher/Cacher les éléments de collaboration selon le plan utilisateur
        function updateCollaborationUI() {
            const userPlan = localStorage.getItem('user_plan') || 'solo';
            const isAgencyPlan = ['agency_starter', 'agency_scale', 'enterprise'].includes(userPlan);

            // Workspace Switcher
            const workspaceSwitcher = document.getElementById('workspaceSwitcher');
            if (workspaceSwitcher) {
                workspaceSwitcher.style.display = isAgencyPlan ? 'block' : 'none';
            }

            // Notifications
            const notificationBtn = document.getElementById('notificationBtn');
            if (notificationBtn) {
                notificationBtn.style.display = isAgencyPlan ? 'flex' : 'none';
            }

            // Team Management button
            const teamBtn = document.getElementById('teamManagementBtn');
            if (teamBtn) {
                teamBtn.style.display = isAgencyPlan ? 'flex' : 'none';
            }
        }

        // Écouter les changements de plan
        window.addEventListener('userPlanUpdated', updateCollaborationUI);

        // Initialiser au chargement
        document.addEventListener('DOMContentLoaded', () => {
            // Attendre un peu que l'auth soit chargée
            setTimeout(updateCollaborationUI, 1000);
        });
    </script>

    <!--Start of Tawk.to Script-->
    <script type="text/javascript">
    var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
    (function(){
    var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
    s1.async=true;
    s1.src='https://embed.tawk.to/6966beea48d012197e10aab2/1jesljgqk';
    s1.charset='UTF-8';
    s1.setAttribute('crossorigin','*');
    s0.parentNode.insertBefore(s1,s0);
    })();
    </script>
    <!--End of Tawk.to Script-->

</body>
</html>
